<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>4dnat on 整点Bug</title><link>https://www.typesafe.cn/tags/4dnat/</link><description>Recent content in 4dnat on 整点Bug</description><generator>Hugo</generator><language>en-us</language><lastBuildDate>Thu, 19 Nov 2020 22:33:00 +0000</lastBuildDate><atom:link href="https://www.typesafe.cn/tags/4dnat/index.xml" rel="self" type="application/rss+xml"/><item><title>服务器不允许上网并且需要跳板机才能访问？学会使用这个工具，轻松让服务器使用yum。</title><link>https://www.typesafe.cn/posts/4dnat/</link><pubDate>Thu, 19 Nov 2020 22:33:00 +0000</pubDate><guid>https://www.typesafe.cn/posts/4dnat/</guid><description>&lt;h1 id="前言">前言&lt;/h1>
&lt;p>你是否遇到过这样的场景，服务器不能上网，但是又需要安装某个软件，面对如蛛网般杂乱的rpm包依赖关系，放弃或许是最好的选择，这样你就不必再为无法完成工作而痛苦又懊恼。&lt;/p>
&lt;p>但是今天，你有了一个更好的选择。&lt;/p>
&lt;h1 id="4dnat">&lt;a href="https://github.com/dushixiang/4dnat">4DNAT&lt;/a>&lt;/h1>
&lt;p>4DNAT取名源自4和DNAT。这个工具工作在OSI模型的第四层传输层，同时4和for谐音，意为专门为目标地址转换而服务的工具。4DNAT使用go语言开发，具有天然的跨平台性，并且完全使用go标准库开发，没有任何的第三方依赖，编译之后只有一个二进制可执行文件。它有4种工作模式：&lt;/p>
&lt;h3 id="转发模式">转发模式&lt;/h3>
&lt;p>接受两个参数，监听端口和目标地址，在监听端口接收到请求后会主动连接目标地址，示例：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>./4dnat -forward &lt;span style="color:#ae81ff">2222&lt;/span> 192.168.1.100:22
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="监听模式">监听模式&lt;/h3>
&lt;p>接受两个参数，监听端口1和监听端口2，并交换两个端口接收到的数据，示例：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>./4dnat -listen &lt;span style="color:#ae81ff">10000&lt;/span> &lt;span style="color:#ae81ff">10001&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="代理人模式">代理人模式&lt;/h3>
&lt;p>接受两个参数，目标地址1和目标地址2，启动后会主动连接这两个目标地址，并交换两个端口接收到的数据，示例：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>./4dnat -agent 127.0.0.1:10000 127.0.0.1:22
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="httphttps代理模式">http/https代理模式&lt;/h3>
&lt;p>接受两个参数或四个参数，代理类型、监听端口、证书路径和私钥路径，示例：&lt;/p>
&lt;h4 id="http代理">http代理&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>./4dnat -proxy http &lt;span style="color:#ae81ff">1080&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="https代理">https代理&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>./4dnat -proxy https &lt;span style="color:#ae81ff">1080&lt;/span> server.crt server.key
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="使用场景">使用场景&lt;/h1>
&lt;h3 id="场景一">场景一&lt;/h3>
&lt;p>期望可以在&lt;strong>用户电脑&lt;/strong>上直接访问目标服务器上的3306端口，跳板机器是一台Windows机器，没办法做ssh端口转发。
&lt;img src="https://oss.typesafe.cn/break-through-the-network.png" alt="请输入图片描述">&lt;/p>
&lt;blockquote>
&lt;p>单向虚线箭头表示可以单向访问，反之不行。&lt;/p>&lt;/blockquote>
&lt;p>使用4DNAT在&lt;strong>跳板机器&lt;/strong>上执行如下命令做端口转发&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 本地监听3307端口，接收到请求后主动连接10.1.0.40的3306端口&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>./4dnat -forward &lt;span style="color:#ae81ff">3307&lt;/span> 10.1.0.40:3306
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>在&lt;strong>用户电脑&lt;/strong>上访问&lt;strong>172.16.0.30:3307&lt;/strong>即等同于访问&lt;strong>10.1.0.40:3306&lt;/strong>，于是就可以在&lt;strong>用户电脑&lt;/strong>愉快的访问&lt;strong>目标机器&lt;/strong>上的服务啦。&lt;/p>
&lt;h3 id="场景二">场景二&lt;/h3>
&lt;p>期望目标&lt;strong>目标机器&lt;/strong>可以上网，如使用yum安装软件。
&lt;img src="https://oss.typesafe.cn/break-through-the-network2.png" alt="请输入图片描述">&lt;/p>
&lt;ol>
&lt;li>在&lt;strong>用户电脑&lt;/strong>上开启一个http代理&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>./4dnat -proxy http &lt;span style="color:#ae81ff">1080&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="2">
&lt;li>在&lt;strong>跳板机器&lt;/strong>上使用监听模式监听两个端口，用于交换数据&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>./4dnat -listen &lt;span style="color:#ae81ff">10000&lt;/span> &lt;span style="color:#ae81ff">10001&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="3">
&lt;li>在&lt;strong>目标机器&lt;/strong>上使用监听模式监听两个端口，用于交换数据&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>./4dnat -listen &lt;span style="color:#ae81ff">20000&lt;/span> &lt;span style="color:#ae81ff">20001&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="4">
&lt;li>在&lt;strong>用户电脑&lt;/strong>上使用代理人模式主动连接两个目标地址，用于交换数据&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>./4dnat -agent 127.0.0.1:1080 172.16.0.30:10000
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="5">
&lt;li>在&lt;strong>跳板机器&lt;/strong>上使用代理人模式主动连接两个目标地址，用于交换数据&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>./4dnat -agent 127.0.0.1:10001 10.1.0.40:20000
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="6">
&lt;li>在&lt;strong>目标机器&lt;/strong>上修改代理&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>cat &lt;span style="color:#e6db74">&amp;lt;&amp;lt;EOF &amp;gt;&amp;gt; /etc/profile
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">http_proxy=http://127.0.0.1:20001
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">https_proxy=http://127.0.0.1:20001
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">export http_proxy https_proxy
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>source /etc/profile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="7">
&lt;li>在&lt;strong>目标机器&lt;/strong>上测试访问互联网&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>curl https://typesafe.cn
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>最后奉上项目地址 &lt;a href="https://github.com/dushixiang/4dnat">https://github.com/dushixiang/4dnat&lt;/a>&lt;/p></description></item></channel></rss>