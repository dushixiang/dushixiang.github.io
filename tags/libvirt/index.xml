<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Libvirt on 整点Bug</title><link>https://www.typesafe.cn/tags/libvirt/</link><description>Recent content in Libvirt on 整点Bug</description><generator>Hugo</generator><language>en-us</language><lastBuildDate>Wed, 19 May 2021 20:18:20 +0800</lastBuildDate><atom:link href="https://www.typesafe.cn/tags/libvirt/index.xml" rel="self" type="application/rss+xml"/><item><title>使用libvirt-java采集KVM虚拟机状态信息</title><link>https://www.typesafe.cn/posts/collect-vm-stats-by-libvirt-java/</link><pubDate>Wed, 19 May 2021 20:18:20 +0800</pubDate><guid>https://www.typesafe.cn/posts/collect-vm-stats-by-libvirt-java/</guid><description>&lt;p>虚拟化开发相较于普通开发是一个冷门的方向，大多数是使用Python开发，其中使用Java来做虚拟化的少之又少，资料更是少的可怜，为了实现需求我也是踩了不少坑，今天就为大家分享一下如何使用 &lt;code>libvirt-java&lt;/code> 来采集KVM虚拟机的资源使用信息。&lt;/p>
&lt;h3 id="cpu使用率">CPU使用率&lt;/h3>
&lt;p>&lt;code>libvirt&lt;/code>并没有直接提供获取虚拟机CPU使用率的接口，需要我们自己来计算，网上分享的代码或者公式五花八门，大部分都是错误的，经过我的测试，找到了一个相对准确的计算公式。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-latex" data-lang="latex">&lt;span style="display:flex;">&lt;span>cpu&lt;span style="color:#8be9fd;font-style:italic">_&lt;/span>usage = (cpu&lt;span style="color:#8be9fd;font-style:italic">_&lt;/span>time&lt;span style="color:#8be9fd;font-style:italic">_&lt;/span>now - cpu&lt;span style="color:#8be9fd;font-style:italic">_&lt;/span>time&lt;span style="color:#8be9fd;font-style:italic">_&lt;/span>t&lt;span style="color:#8be9fd;font-style:italic">_&lt;/span>second&lt;span style="color:#8be9fd;font-style:italic">_&lt;/span>ago) * 100 / (t * vCpus * 10&lt;span style="color:#8be9fd;font-style:italic">^&lt;/span>9)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Java代码如下&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">// t秒前的CPU时间&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">long&lt;/span> c1 &lt;span style="color:#ff79c6">=&lt;/span> domain.&lt;span style="color:#50fa7b">getInfo&lt;/span>().&lt;span style="color:#50fa7b">cpuTime&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Thread.&lt;span style="color:#50fa7b">sleep&lt;/span>(1000);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">// 当前CPU时间&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">long&lt;/span> c2 &lt;span style="color:#ff79c6">=&lt;/span> domain.&lt;span style="color:#50fa7b">getInfo&lt;/span>().&lt;span style="color:#50fa7b">cpuTime&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">// 虚拟CPU数量&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8be9fd">int&lt;/span> vCpus &lt;span style="color:#ff79c6">=&lt;/span> domain.&lt;span style="color:#50fa7b">getMaxVcpus&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#6272a4">// t 为1秒&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Double cpuUsage &lt;span style="color:#ff79c6">=&lt;/span> 100 &lt;span style="color:#ff79c6">*&lt;/span> (c2 &lt;span style="color:#ff79c6">-&lt;/span> c1) &lt;span style="color:#ff79c6">/&lt;/span> (1 &lt;span style="color:#ff79c6">*&lt;/span> vCpus &lt;span style="color:#ff79c6">*&lt;/span> Math.&lt;span style="color:#50fa7b">pow&lt;/span>(10, 9));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>log.&lt;span style="color:#50fa7b">debug&lt;/span>(&lt;span style="color:#f1fa8c">&amp;#34;虚拟机[{}]CPU使用率为: {}&amp;#34;&lt;/span>, uuid, cpuUsage);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="内存使用率">内存使用率&lt;/h3>
&lt;p>不要使用&lt;code>domain.getInfo()&lt;/code>返回的 &lt;code>memory&lt;/code>字段，虽然它注释写的是&lt;code>the memory in KBytes used by the domain&lt;/code>，但它的意思真的不是虚拟机内部进程已使用的内存大小，而是从宿主机器的角度来看分配给这个虚拟机的内存它使用了多少，如果没有特殊配置，它会和&lt;code>maxMem&lt;/code>字段的值是相同的。&lt;/p>
&lt;p>正确做法是使用&lt;code>domain.memoryStats(10)&lt;/code>来获取，那为什么参数要输入一个&lt;code>10&lt;/code>呢？这是因为&lt;code>10&lt;/code>代表的是要返回的信息数量，经过我手动执行&lt;code>virsh dommemstat uuid&lt;/code> 测试发现有10个参数返回，所以需要填入&lt;code>10&lt;/code>。另外命令返回的&lt;code>unused&lt;/code> 字段值与数组中&lt;code>tag=8&lt;/code>的数据一致，最终我们获取到了未使用的内存大小，计算内存使用率更是轻轻松松。&lt;/p>
&lt;p>Java代码如下&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>MemoryStatistic&lt;span style="color:#ff79c6">[]&lt;/span> memoryStatistics &lt;span style="color:#ff79c6">=&lt;/span> domain.&lt;span style="color:#50fa7b">memoryStats&lt;/span>(10);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Optional&lt;span style="color:#ff79c6">&amp;lt;&lt;/span>MemoryStatistic&lt;span style="color:#ff79c6">&amp;gt;&lt;/span> first &lt;span style="color:#ff79c6">=&lt;/span> Arrays.&lt;span style="color:#50fa7b">stream&lt;/span>(memoryStatistics).&lt;span style="color:#50fa7b">filter&lt;/span>(x &lt;span style="color:#ff79c6">-&amp;gt;&lt;/span> x.&lt;span style="color:#50fa7b">getTag&lt;/span>() &lt;span style="color:#ff79c6">==&lt;/span> 8).&lt;span style="color:#50fa7b">findFirst&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ff79c6">if&lt;/span> (first.&lt;span style="color:#50fa7b">isPresent&lt;/span>()) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MemoryStatistic memoryStatistic &lt;span style="color:#ff79c6">=&lt;/span> first.&lt;span style="color:#50fa7b">get&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd">long&lt;/span> unusedMemory &lt;span style="color:#ff79c6">=&lt;/span> memoryStatistic.&lt;span style="color:#50fa7b">getValue&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd">long&lt;/span> maxMemory &lt;span style="color:#ff79c6">=&lt;/span> domain.&lt;span style="color:#50fa7b">getMaxMemory&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8be9fd">double&lt;/span> memoryUsage &lt;span style="color:#ff79c6">=&lt;/span> (maxMemory &lt;span style="color:#ff79c6">-&lt;/span> unusedMemory) &lt;span style="color:#ff79c6">*&lt;/span> 100.&lt;span style="color:#50fa7b">0&lt;/span> &lt;span style="color:#ff79c6">/&lt;/span> maxMemory;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> log.&lt;span style="color:#50fa7b">debug&lt;/span>(&lt;span style="color:#f1fa8c">&amp;#34;虚拟机[{}]内存使用率为: {}&amp;#34;&lt;/span>, uuid, memoryUsage);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="网卡数据包信息">网卡数据包信息&lt;/h3>
&lt;p>同样&lt;code>libvirt&lt;/code>并没有提供获取虚拟机网卡的接口，因此需要获取虚拟机的xml文件来查询。&lt;/p></description></item></channel></rss>