<!doctype html><html lang=zh dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>network | 没有理想的人不伤心</title>
<meta name=keywords content>
<meta name=description content="Theme PaperMod - https://github.com/adityatelange/hugo-PaperMod">
<meta name=author content="dushixiang">
<link rel=canonical href=https://typesafe.cn/tags/network/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.6f60056d44d3f7eb69a4bc6c332b59960f3a995802bded244750232f33713c49.css integrity="sha256-b2AFbUTT9+tppLxsMytZlg86mVgCve0kR1AjLzNxPEk=" rel="preload stylesheet" as=style>
<link rel=icon href=https://typesafe.cn/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://typesafe.cn/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://typesafe.cn/favicon-32x32.png>
<link rel=apple-touch-icon href=https://typesafe.cn/apple-touch-icon.png>
<link rel=mask-icon href=https://typesafe.cn/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.89.0">
<link rel=alternate type=application/rss+xml href=https://typesafe.cn/tags/network/index.xml>
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><meta property="og:title" content="network">
<meta property="og:description" content="Theme PaperMod - https://github.com/adityatelange/hugo-PaperMod">
<meta property="og:type" content="website">
<meta property="og:url" content="https://typesafe.cn/tags/network/"><meta property="og:image" content="https://typesafe.cn/papermod-cover.png">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://typesafe.cn/papermod-cover.png">
<meta name=twitter:title content="network">
<meta name=twitter:description content="Theme PaperMod - https://github.com/adityatelange/hugo-PaperMod">
</head>
<body class=list id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://typesafe.cn accesskey=h title="没有理想的人不伤心 (Alt + H)">没有理想的人不伤心</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://typesafe.cn/archives title=文章>
<span>文章</span>
</a>
</li>
<li>
<a href=https://typesafe.cn/categories/ title=分类>
<span>分类</span>
</a>
</li>
<li>
<a href=https://typesafe.cn/search/ title=搜索>
<span>搜索</span>
</a>
</li>
<li>
<a href=https://typesafe.cn/tags/ title=标签>
<span>标签</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<header class=page-header><div class=breadcrumbs><a href=https://typesafe.cn>主页</a>&nbsp;»&nbsp;<a href=https://typesafe.cn/tags/>Tags</a></div>
<h1>network</h1>
</header>
<article class="post-entry tag-entry">
<header class=entry-header>
<h2>容器网络——如何为docker添加网卡？
</h2>
</header>
<section class=entry-content>
<p>之前我们介绍Network Namespace（以下简称netns）和veth pair时说过docker是使用这些技术来实现的网络隔离，今天我们就来一探究竟，看下docker到底是如何做到的。
启动一个无网络的容器 首先我们使用 --net=none 参数启动一个无网络的容器，为了方便调试，这里我们使用了centos镜像。
docker run -itd --name centos-test --net=none centos 启动成功之后我们进入容器内部确认一下是否无网卡。
[root@localhost ~]# docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 28dc2e8853df centos "/bin/bash" 24 seconds ago Up 23 seconds centos-test [root@localhost ~]# docker exec -it 28dc2e8853df bash [root@28dc2e8853df /]# ip a 1: lo: &lt;LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever 可以看到确实只有一个本地环回网卡。...</p>
</section>
<footer class=entry-footer><span title="2021-05-23 13:37:00 +0800 +0800">May 23, 2021</span>&nbsp;·&nbsp;2 分钟&nbsp;·&nbsp;dushixiang</footer>
<a class=entry-link aria-label="post link to 容器网络——如何为docker添加网卡？" href=https://typesafe.cn/posts/how-to-add-port-for-docker/></a>
</article>
<article class="post-entry tag-entry">
<header class=entry-header>
<h2>Linux 环回网络接口
</h2>
</header>
<section class=entry-content>
<p>在开发或者调试时，我们经常需要和本地的服务器进行通信，例如启动nginx之后，在浏览器输入lcoalhost或者127.0.0.1就可以访问到本机上面的http服务。
Linux是如何访问本机IP的？ 大多数操作系统都在网络层实现了环回能力，通常是使用一个虚拟的环回网络接口来实现。这个虚拟的环回网络接口看着像是一个真实的网卡，实际上是操作系统用软件模拟的，它可以通过TCP/IP与同一台主机上的其他服务进行通信，以127开头的IPv4地址就是为它保留的，主流Linux操作系统为环回网卡分配的地址都是127.0.0.1，主机名是localhost。
环回网络接口之所以被称之为环回网络接口，是因为从本机发送到本机任意一个IP的数据报文都会在网络层交给环回网络接口，不再下发到数据链路层进行处理，环回网络接口直接发送回网络层，最终交由应用层软件程序进行处理。这种方式对于性能测试非常有用，因为省去了硬件的开销，可以直接测试协议栈软件所需要的时间。
那环回网络接口是如何判断目的IP是否为本机地址的呢？
答案就是网络层在进行路由转发的时候会先查本地的路由表，发现是本机IP后交给环回网络接口。查看本地路由表的命令如下：
ip route show table local 输出内容如下：
broadcast 10.141.128.0 dev eth0 proto kernel scope link src 10.141.155.131 local 10.141.155.131 dev eth0 proto kernel scope host src 10.141.155.131 broadcast 10.141.191.255 dev eth0 proto kernel scope link src 10.141.155.131 broadcast 127.0.0.0 dev lo proto kernel scope link src 127.0.0.1 local 127.0.0.0/8 dev lo proto kernel scope host src 127.0.0.1 local 127.0.0.1 dev lo proto kernel scope host src 127....</p>
</section>
<footer class=entry-footer><span title="2021-01-28 22:59:00 +0000 UTC">January 28, 2021</span>&nbsp;·&nbsp;1 分钟&nbsp;·&nbsp;dushixiang</footer>
<a class=entry-link aria-label="post link to Linux 环回网络接口" href=https://typesafe.cn/posts/linux-loopback/></a>
</article>
<article class="post-entry tag-entry">
<header class=entry-header>
<h2>Linux Bridge 详解
</h2>
</header>
<section class=entry-content>
<p>Linux Bridge 详解 Linux Bridge（网桥）是用纯软件实现的虚拟交换机，有着和物理交换机相同的功能，例如二层交换，MAC地址学习等。因此我们可以把tun/tap，veth pair等设备绑定到网桥上，就像是把设备连接到物理交换机上一样。此外它和veth pair、tun/tap一样，也是一种虚拟网络设备，具有虚拟设备的所有特性，例如配置IP，MAC地址等。
Linux Bridge通常是搭配KVM、docker等虚拟化技术一起使用的，用于构建虚拟网络，因为此教程不涉及虚拟化技术，我们就使用前面学习过的netns来模拟虚拟设备。
如何使用Linux Bridge？ 操作网桥有多种方式，在这里我们介绍一下通过bridge-utils来操作，由于它不是Linux系统自带的工具，因此需要我们手动来安装它。
# centos yum install -y bridge-utils # ubuntu apt-get install -y bridge-utils 使用brctl help查看使用帮助
never heard of command [help] Usage: brctl [commands] commands: addbr &lt;bridge> add bridge delbr &lt;bridge> delete bridge addif &lt;bridge> &lt;device> add interface to bridge delif &lt;bridge> &lt;device> delete interface from bridge hairpin &lt;bridge> &lt;port> {on|off} turn hairpin on/off setageing &lt;bridge> &lt;time> set ageing time setbridgeprio &lt;bridge> &lt;prio> set bridge priority setfd &lt;bridge> &lt;time> set bridge forward delay sethello &lt;bridge> &lt;time> set hello time setmaxage &lt;bridge> &lt;time> set max message age setpathcost &lt;bridge> &lt;port> &lt;cost> set path cost setportprio &lt;bridge> &lt;port> &lt;prio> set port priority show [ &lt;bridge> ] show a list of bridges showmacs &lt;bridge> show a list of mac addrs showstp &lt;bridge> show bridge stp info stp &lt;bridge> {on|off} turn stp on/off 常用命令如...</p>
</section>
<footer class=entry-footer><span title="2020-11-13 21:47:00 +0000 UTC">November 13, 2020</span>&nbsp;·&nbsp;4 分钟&nbsp;·&nbsp;dushixiang</footer>
<a class=entry-link aria-label="post link to Linux Bridge 详解" href=https://typesafe.cn/posts/linux-bridge/></a>
</article>
<article class="post-entry tag-entry">
<header class=entry-header>
<h2>Linux veth pair 详解
</h2>
</header>
<section class=entry-content>
<p>Linux veth pair 详解 veth pair是成对出现的一种虚拟网络设备接口，一端连着网络协议栈，一端彼此相连。如下图所示：
由于它的这个特性，常常被用于构建虚拟网络拓扑。例如连接两个不同的网络命名空间(netns)，连接docker容器，连接网桥(Bridge)等，其中一个很常见的案例就是OpenStack Neutron底层用它来构建非常复杂的网络拓扑。
如何使用？ 创建一对veth
ip link add &lt;veth name> type veth peer name &lt;peer name> 实验 我们改造上一节完成的netns实验，使用veth pair将两个的隔离netns连接起来。如下图所示：
我们首先创建一对veth设备，将veth设备分别移动到两个netns中并启动。
# 创建一对veth ip link add veth0 type veth peer name veth1 # 将veth移动到netns中 ip link set veth0 netns ns0 ip link set veth1 netns ns1 # 启动 ip netns exec ns0 ip link set veth0 up ip netns exec ns1 ip link set veth1 up 接下来我们测试一下。...</p>
</section>
<footer class=entry-footer><span title="2020-11-09 22:45:00 +0000 UTC">November 9, 2020</span>&nbsp;·&nbsp;3 分钟&nbsp;·&nbsp;dushixiang</footer>
<a class=entry-link aria-label="post link to Linux veth pair 详解" href=https://typesafe.cn/posts/linux-veth-pair/></a>
</article>
<article class="post-entry tag-entry">
<header class=entry-header>
<h2>Linux Network Namespace (netns) 详解
</h2>
</header>
<section class=entry-content>
<p>Network Namespace （以下简称netns）是Linux内核提供的一项实现网络隔离的功能，它能隔离多个不同的网络空间，并且各自拥有独立的网络协议栈，这其中便包括了网络接口（网卡），路由表，iptables规则等。例如大名鼎鼎的docker便是基于netns实现的网络隔离，今天我们就来手动实验一下netns的隔离特性。
使用方式 使用ip netns help查看使用帮助
Usage: ip netns list ip netns add NAME ip netns set NAME NETNSID ip [-all] netns delete [NAME] ip netns identify [PID] ip netns pids NAME ip [-all] netns exec [NAME] cmd ... ip netns monitor ip netns list-id 开始实验 我们将要构建如下图的网络
首先我们添加两个tap设备并配置上IP信息，然后添加两个netns，最后将tap设备移动到netns中
# 添加并启动虚拟网卡tap设备 ip tuntap add dev tap0 mode tap ip tuntap add dev tap1 mode tap ip link set tap0 up ip link set tap1 up # 配置IP ip addr add 10....</p>
</section>
<footer class=entry-footer><span title="2020-11-08 23:12:00 +0000 UTC">November 8, 2020</span>&nbsp;·&nbsp;3 分钟&nbsp;·&nbsp;dushixiang</footer>
<a class=entry-link aria-label="post link to Linux Network Namespace (netns) 详解" href=https://typesafe.cn/posts/linux-netns/></a>
</article>
<footer class=page-footer>
<nav class=pagination>
<a class=next href=https://typesafe.cn/tags/network/page/2/>下一页 »</a>
</nav>
</footer>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://typesafe.cn>没有理想的人不伤心</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>