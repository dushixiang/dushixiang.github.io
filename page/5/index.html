<!doctype html><html lang=zh dir=auto><head><meta name=generator content="Hugo 0.111.3"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>没有理想的人不伤心</title><meta name=description content="Theme PaperMod - https://github.com/adityatelange/hugo-PaperMod"><meta name=author content="dushixiang"><link rel=canonical href=https://typesafe.cn/><link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><link rel=icon href=https://typesafe.cn/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://typesafe.cn/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://typesafe.cn/favicon-32x32.png><link rel=apple-touch-icon href=https://typesafe.cn/apple-touch-icon.png><link rel=mask-icon href=https://typesafe.cn/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://typesafe.cn/index.xml><link rel=alternate type=application/json href=https://typesafe.cn/index.json><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="没有理想的人不伤心"><meta property="og:description" content="Theme PaperMod - https://github.com/adityatelange/hugo-PaperMod"><meta property="og:type" content="website"><meta property="og:url" content="https://typesafe.cn/"><meta property="og:image" content="https://typesafe.cn/papermod-cover.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://typesafe.cn/papermod-cover.png"><meta name=twitter:title content="没有理想的人不伤心"><meta name=twitter:description content="Theme PaperMod - https://github.com/adityatelange/hugo-PaperMod"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","name":"没有理想的人不伤心","url":"https://typesafe.cn","description":"Theme PaperMod - https://github.com/adityatelange/hugo-PaperMod","thumbnailUrl":"https://typesafe.cn/favicon.ico","sameAs":["https://github.com/dushixiang","index.xml"]}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://typesafe.cn accesskey=h title="没有理想的人不伤心 (Alt + H)">没有理想的人不伤心</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://typesafe.cn/archives title=文章><span>文章</span></a></li><li><a href=https://typesafe.cn/categories/ title=分类><span>分类</span></a></li><li><a href=https://typesafe.cn/search/ title=搜索><span>搜索</span></a></li><li><a href=https://typesafe.cn/tags/ title=标签><span>标签</span></a></li></ul></nav></header><main class=main><article class=post-entry><header class=entry-header><h2>压缩qcow2 镜像文件</h2></header><div class=entry-content><p>压缩qcow2 首先，需要对虚拟机剩余空间进行写零操作：
dd if=/dev/zero of=/zero.dat 删除 zero.dat：
rm /zero.dat 关闭虚拟机，执行qemu-img的convert命令进行转换：
qemu-img convert -c -O qcow2 /path/old.img.qcow2 /path/new.img.qcow2</p></div><footer class=entry-footer><span title='2020-12-31 00:00:00 +0000 UTC'>十二月 31, 2020</span>&nbsp;·&nbsp;1 分钟&nbsp;·&nbsp;dushixiang</footer><a class=entry-link aria-label="post link to 压缩qcow2 镜像文件" href=https://typesafe.cn/posts/qcow2-image-compression/></a></article><article class=post-entry><header class=entry-header><h2>Open vSwitch 入门实践（6）VXLAN实验</h2></header><div class=entry-content><p>什么是VXLAN？ VXLAN是一种隧道封装协议，在三层网络上封装二层网络数据报文。简单来说就是可以在已经规划好网络拓扑的设备上封装出一个新的二层网络，因此VXLAN这类网络又被称之为overylay网络，底下承载VXLAN网络的就被称之为underlay网络。
VXLAN解决了什么问题？ 最近几年，阿里云，腾讯云，京东云，华为云等等厂商每到节日都会打折出售大量云服务器，1核1G内存50G磁盘的服务器几十块就能买到一年的使用权，作为一个专业的羊毛党，哪个手里没有几台小破水管机器？但是这么多的云服务器是厂商如何做隔离的呢？了解过网络的同学或许会说VLAN。但是VLAN这种只能隔离4094个虚拟网络的技术别说满足不了羊毛党了，就连正常的用户估计都撑不住。那不隔离能行吗，厂商规划一个特别大的网段，让大家都在这里面耍，正常用户还好，万一这个时候进来一个大黑客，估计就会全部GG。
因此，隔离是必不可少的，其中关键的技术就是overlay网络。
那VXLAN具体解决了哪些问题呢？
突破了VLAN技术4094个隔离网络的限制，在一个管理域中创建多达1600万个VXLAN网络。 VXLAN提供了云服务厂商所需的规模的网络分段，以支持大量租户。 突破了物理网络边界的限制，传统虚拟二层网络（VLAN）是需要和物理网络做大量适配工作才能保证环境的迁移不会导致虚拟网络异常，overlay网络则不必关心底层物理网络是如何搭建的，只要能保证VXLAN端点相互之间可以联通即可。 VXLAN网络如何工作？ VXLAN隧道协议将二层以太网帧封装在三层UDP数据包中，使用户能够创建跨物理三层网络的虚拟化二层子网或网段。每个二层子网使用VXLAN网络标识符（VNI）作为唯一标识。报文格式如下图：
执行数据包封装和解封装的实体称为VXLAN隧道终结点（VTEP）。VTEP主要分为两类：硬件VTEP和软件VTEP。硬件VTEP我接触较少，这里就不再介绍了。
软件VTEP如下图所示：VTEP在数据包到达虚拟机之前进行了封装和解封装，使得虚拟机完全不需要知道VXLAN隧道以及它们之间的三层网络。
简单VXLAN实验 我们参照下图完成实验。
主机A # 创建隧道网桥 ovs-vsctl add-br br-tun # 创建隧道端口并指定远端IP和VXLAN ID ovs-vsctl add-port br-tun vx01 -- set Interface vx01 type=vxlan options:remote_ip=192.168.123.232 options:key=1111 # 创建内部端口 ovs-vsctl add-port br-tun vnet0 -- set Interface vnet0 type=internal # 创建netns用于模拟虚拟网络设备 ip netns add ns0 # 将内部端口移动到netns中 ip link set vnet0 netns ns0 # 启动网卡 ip netns exec ns0 ip link set lo up ip netns exec ns0 ip link set vnet0 up # 配置IP ip netns exec ns0 ip addr add 192....</p></div><footer class=entry-footer><span title='2020-12-30 19:14:00 +0000 UTC'>十二月 30, 2020</span>&nbsp;·&nbsp;2 分钟&nbsp;·&nbsp;dushixiang</footer><a class=entry-link aria-label="post link to Open vSwitch 入门实践（6）VXLAN实验" href=https://typesafe.cn/posts/ovs-learn-6/></a></article><article class=post-entry><header class=entry-header><h2>Open vSwitch 入门实践（5）OVS Flow Table 流表规则</h2></header><div class=entry-content><p>OpenvSwitch flow table 流表 OpenFlow（OF）被认为是第一个软件定义网络（SDN）标准之一。它最初在SDN环境中定义了通信协议，使SDN控制器能够与物理和虚拟的交换机和路由器等网络设备的转发平面直接进行交互，从而更好地适应不断变化的业务需求。
如果把OpenFlow控制器比作“大脑”，OVS流表就像是“大腿”一样接受来自“大脑”的指令，决定要向哪个方向前进。但OVS流表功能更加强大，在没有OpenFlow控制器时，也可以自主工作，它本身也供一些命令让我们可以直接管理流表。
操作命令 查看流表规则 # 查看br-tun上的全部流表规则 ovs-ofctl dump-flows br-tun 添加或修改流表规则 ovs-ofctl add−flow／add−flows／mod−flows “流表匹配条件,actions=[动作1][,动作2…]” 如果你有过编程的经验，流表规则其实就是一个个简单的if语句，伪代码如下。
if (流表匹配条件){ 动作1， 动作2... } if (流表匹配条件){ 动作1， 动作2... } 删除流表规则 # 删除br-tun上的全部流表规则 ovs-ofctl del-flows br-tun # 删除br-tun上匹配xx的全部流表规则 ovs-ofctl del-flows br-tun xx 流表匹配条件 OVS 流表匹配条件较多，下面我将其分成四部分来说明，分别是:
OVS匹配条件 OSI模型第二层【数据链路层】 OSI模型第三层【网络层】 OSI模型第四层【传输层】 OVS匹配条件 in_port=port 流量进入的端口编号或者名称，示例 in_port=br-int
table=number 规则保存的流表编号，范围是 0-254，默认值：0。
OSI模型第二层【数据链路层】 dl 即是 data link 的缩写。
dl_type=ethertype 匹配以太网协议类型以太类型，以10到65535之间的整数（包括0和65535）指定，以十进制或以0x前缀的十六进制数表示，示例如下。
dl_type=0x0800 匹配IPv4数据包，等同于dl_type=ip 。
dl_type=0x086dd 匹配IPv6数据包，等同于dl_type=ipv6 。
dl_type=0x0806 匹配ARP数据包，等同于dl_type=arp 。...</p></div><footer class=entry-footer><span title='2020-12-29 18:38:00 +0000 UTC'>十二月 29, 2020</span>&nbsp;·&nbsp;3 分钟&nbsp;·&nbsp;dushixiang</footer><a class=entry-link aria-label="post link to Open vSwitch 入门实践（5）OVS Flow Table 流表规则" href=https://typesafe.cn/posts/ovs-learn-5/></a></article><article class=post-entry><header class=entry-header><h2>Open vSwitch 入门实践（4）使用OVS配置端口镜像</h2></header><div class=entry-content><p>前言 当我们想要在不影响虚拟网络设备数据报文收发的情况下获取对应虚拟网络设备的流量时，端口镜像是一个很好的选择。端口镜像是指将经过指定端口（镜像端口）的报文复制一份到另一个指定端口（观察端口），通过观察端口接收到的数据报文，就可以有效识别虚拟网络的运行情况。
OVS提供了相关命令来配置或删除端口镜像，下面我们来实验一下。
如何使用 端口镜像类型 端口镜像分为镜像源和镜像目的两部分。
镜像源 select_all：布尔类型（true，false）。设置为 true 时，表示此网桥上的所有流量。 select_dst_port：字符串（端口名称）。表示此端口接收的所有流量。 select_src_port：字符串（端口名称）。表示此端口发送的所有流量。 select_vlan：整型（0-4095）。表示携带此VLAN标签的流量。 镜像目的 output_port：字符串（端口名称）。接收流量报文的观察端口。 output_vlan：整型（0-4095）。表示只修改VLAN标签，原VLAN标签会被剥离。 基础操作命令 新增端口镜像
ovs-vsctl -- set Bridge &lt;bridge_name> mirrors=@m \ -- --id=@&lt;port0> get Port &lt;port0> \ -- --id=@&lt;port1> get Port &lt;port1> \ -- --id=@m create Mirror name=&lt;mirror_name> select-dst-port=@&lt;port0> select-src-port=@&lt;port0> output-port=@&lt;port1> 这行命令会输出一个镜像ID
删除端口镜像
ovs-vsctl remove Bridge &lt;bridge-name> mirrors &lt;mirror-id> 在原端口镜像的基础上增加一个镜像源
# 获取端口的ID ovs-vsctl get port &lt;port_name> _uuid # 在原端口镜像的基础上增加镜像源 ovs-vsctl add Mirror &lt;mirror-name> select_src_port &lt;port-id> ovs-vsctl add Mirror &lt;mirror-name> select_dst_port &lt;port-id> 在原端口镜像的基础上删除一个镜像源...</p></div><footer class=entry-footer><span title='2020-12-28 19:23:00 +0000 UTC'>十二月 28, 2020</span>&nbsp;·&nbsp;3 分钟&nbsp;·&nbsp;dushixiang</footer><a class=entry-link aria-label="post link to Open vSwitch 入门实践（4）使用OVS配置端口镜像" href=https://typesafe.cn/posts/ovs-learn-4/></a></article><article class=post-entry><header class=entry-header><h2>Open vSwitch 入门实践（3）使用OVS构建分布式隔离网络</h2></header><div class=entry-content><p>使用OVS构建分布式隔离网络 前言 上一节我们使用OVS构建了单机隔离网络，但是随着网络规模的扩张，单节点已经不再能满足业务的需要，分布式网络成了必不可少的环节。分布式网络与单节点网络在细节实现上基本一致，只有物理环境网络连线上的一点区别。
实验1：分布式无隔离网络 网络拓扑如下图所示，我们每一台节点都有两张网卡，一张用于管理，一张用于业务。之所以使用两张网卡有两个原因：
管理网卡用于日常的维护登录，业务网卡用于传输虚拟节点的数据报文，避免相互之间影响。 我们要将业务网卡绑定到OVS网桥上，也就是Normal类型的Port。这种方式添加的Port不支持分配IP地址，如果之前网卡上配置的有IP，挂载到OVS上面之后将不可访问。 需要注意的是，如果是使用物理环境搭建网络拓扑，需要把业务网卡对应的交换机端口配置为trunk模式。如果是使用VmWare搭建网络拓扑，业务网卡需要配置网络类型为仅主机模式。
配置 配置环境 主机A ovs-vsctl add-br br-int # 请修改eth1为当前实验环境的业务网卡名称 ovs-vsctl add-port br-int eth1 # 添加两个内部端口 ovs-vsctl add-port br-int vnet0 -- set Interface vnet0 type=internal ovs-vsctl add-port br-int vnet1 -- set Interface vnet1 type=internal # 添加两个netns ip netns add ns0 ip netns add ns1 # 将内部端口分别移动到netns中 ip link set vnet0 netns ns0 ip link set vnet1 netns ns1 # 启动端口并配置IP ip netns exec ns0 ip link set lo up ip netns exec ns0 ip link set vnet0 up ip netns exec ns0 ip addr add 10....</p></div><footer class=entry-footer><span title='2020-12-27 11:38:00 +0000 UTC'>十二月 27, 2020</span>&nbsp;·&nbsp;2 分钟&nbsp;·&nbsp;dushixiang</footer><a class=entry-link aria-label="post link to Open vSwitch 入门实践（3）使用OVS构建分布式隔离网络" href=https://typesafe.cn/posts/ovs-learn-3/></a></article><footer class=page-footer><nav class=pagination><a class=prev href=https://typesafe.cn/page/4/>«&nbsp;上一页&nbsp;</a>
<a class=next href=https://typesafe.cn/page/6/>下一页&nbsp;&nbsp;»</a></nav></footer></main><footer class=footer><span>&copy; 2023 <a href=https://typesafe.cn>没有理想的人不伤心</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>