<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="OVS简介
Open vSwitch 是什么？
Open vSwitch(以下简称OVS)是一个用C语言开发的多层虚拟交换机，使用Apcahe 2开源许可证，现如今基本上已经成为了开源SDN（软件定义网络）基础设施层的事实标准。
OVS支持哪些功能？

支持NetFlow、sFlow(R)、IPFIX、SPAN、RSPAN和GRE隧道镜像等多种流量监控协议
支持LACP (IEEE 802.1AX-2008)
支持标准802.1Q VLAN协议，允许端口配置trunk模式
支持组播
支持BFD和802.1ag链路监控
支持STP（IEEE 802.1D-1998）和RSTP（IEEE 802.1D-2004）
支持细粒度的QoS（服务质量）配置
支持HFSC qdisc
支持接管每一个虚拟机的流量
支持基于源MAC的负载均衡、主备模式和L4哈希的端口绑带
支持OpenFlow协议（包含了很多对虚拟化的扩展）
支持IPv6
支持多种隧道协议（GRE、VXLAN、STT、Geneve和IPsec）
支持C和Python的远程配置协议
支持内核和用户空间的转发引擎选项
具有流缓存引擎的多表转发管道
转发层抽象以简化向新软件和硬件平台的移植

OVS的术语解释
Bridge
中文名称网桥，一个Bridge代表一个以太网交换机（Switch），一台主机中可以创建一个或多个Bridge，Bridge可以根据一定的规则，把某一个端口接收到的数据报文转发到另一个或多个端口上，也可以修改或者丢弃数据报文。
Port
中文名称端口，需要注意的是它和TCP里面的端口不是同样的概念，它更像是物理交换机上面的插口，可以接水晶头的那种。Port隶属于Bridge，必须先添加了Bridge才能在Bridge上添加Port。Port有以下几种类型：


Normal
用户可以把操作系统中已有的网卡添加到Open vSwicth上，Open vSwitct会自动生成一个同名的Port开处理这张网卡进和出的数据报文。

不过需要注意的是这种方式添加的Port不支持分配IP地址，如果之前网卡上配置的有IP，挂载到OVS上面之后将不可访问。此类型的Port常用于VLAN模式的多台物理主机相连的那个口，交换机一端属于Trunk模式。


Internal
当Port的类型是Internal时，OVS会自动创建一个虚拟网卡（Interface），此端口收到的数据报文都会转发给这块网卡，从这块网卡发出的数据报文也会通过Port交给OVS处理。当OVS创建一个新的网桥时，会自动创建一个与网桥同名的Internal Port，同时也会创建一个与网桥同名的Interface，因此可以通过ip命令在操作系统中查看到这张虚拟网卡，但是状态是down的。


Patch
Patch Port和veth pair功能相同，总是成双成对的出现，在其中一端收到的数据报文会被转发到另一个Patch Port上，就像是一根网线一样。Patch Port常用于连接两个Bridge，这样两个网桥就和一个网桥一样了。


Tunnel
OVS 支持 GRE、VXLAN、STT、Geneve和IPsec隧道协议，这些隧道协议就是overlay网络的基础协议，通过对物理网络做的一层封装和扩展，解决了二层网络数量不足的问题，最大限度的减少对底层物理网络拓扑的依赖性，同时也最大限度的增加了对网络的控制。


Interface
（iface/接口）接口是OVS与操作系统交换数据报文的组件，一个接口即是操作系统上的一块网卡，这个网卡可能是OVS生成的虚拟网卡，也有可能是挂载在OVS上的物理网卡，操作系统上的虚拟网卡（TUN/TAP）也可以被挂载在OVS上。
Controller
OpenFlow控制器，OVS可以接收一个或者多个OpenFlow控制器的管理，功能主要是下发流表，控制转发规则。
Flow
流表是OVS进行数据转发的核心功能，定义了端口之间转发数据报文的规则，一条流表规则主要分为匹配和动作两部分，匹配部分决定哪些数据报文需要被处理，动作决定了匹配到的数据报文该如何处理。
OVS常用操作
安装
yum install openvswitch
systemctl enable openvswitch
systemctl start openvswitch

如果当前软件源中没有openvswitch，可以通过阿里云官方镜像站下载和操作系统版本对应的rpm包到本地再安装。 示例命令： yum localinstall openvswitch-2.9.0-3.el7.x86_64.rpm"><title>Open vSwitch 入门实践（1）Open vSwitch 是什么</title><link rel="shortcut icon" type=image/x-icon href=/><link rel=stylesheet href=/css/main.51652302d3a998bf7887aed5c2cf89141bbebdf45a2c8f87b0717a3cf4f51c4e53c694c328fb1de78c3a625a1c01f80745bf1f2f42c040647a245cbbb6c2d1d7.css integrity="sha512-UWUjAtOpmL94h67Vws+JFBu+vfRaLI+HsHF6PPT1HE5TxpTDKPsd54w6YlocAfgHRb8fL0LAQGR6JFy7tsLR1w=="></head><body a=auto><main class=page-content aria-label=Content><div class=w><div class=post-meta><a href=/>..</a><p><time datetime="2020-11-25 17:49:00 +0000 UTC">2020-11-25</time></p></div><article><h1>Open vSwitch 入门实践（1）Open vSwitch 是什么</h1><h1 id=ovs简介>OVS简介</h1><h3 id=open-vswitch-是什么>Open vSwitch 是什么？</h3><p>Open vSwitch(以下简称OVS)是一个用C语言开发的多层虚拟交换机，使用Apcahe 2开源许可证，现如今基本上已经成为了开源SDN（软件定义网络）基础设施层的事实标准。</p><h3 id=ovs支持哪些功能>OVS支持哪些<a href=http://www.openvswitch.org//features/>功能</a>？</h3><ul><li>支持NetFlow、sFlow(R)、IPFIX、SPAN、RSPAN和GRE隧道镜像等多种流量监控协议</li><li>支持LACP (IEEE 802.1AX-2008)</li><li>支持标准802.1Q VLAN协议，允许端口配置trunk模式</li><li>支持组播</li><li>支持BFD和802.1ag链路监控</li><li>支持STP（IEEE 802.1D-1998）和RSTP（IEEE 802.1D-2004）</li><li>支持细粒度的QoS（服务质量）配置</li><li>支持HFSC qdisc</li><li>支持接管每一个虚拟机的流量</li><li>支持基于源MAC的负载均衡、主备模式和L4哈希的端口绑带</li><li>支持OpenFlow协议（包含了很多对虚拟化的扩展）</li><li>支持IPv6</li><li>支持多种隧道协议（GRE、VXLAN、STT、Geneve和IPsec）</li><li>支持C和Python的远程配置协议</li><li>支持内核和用户空间的转发引擎选项</li><li>具有流缓存引擎的多表转发管道</li><li>转发层抽象以简化向新软件和硬件平台的移植</li></ul><h1 id=ovs的术语解释>OVS的术语解释</h1><h3 id=bridge>Bridge</h3><p>中文名称<strong>网桥</strong>，一个Bridge代表一个以太网交换机（Switch），一台主机中可以创建一个或多个Bridge，Bridge可以根据一定的规则，把某一个端口接收到的数据报文转发到另一个或多个端口上，也可以修改或者丢弃数据报文。</p><h3 id=port>Port</h3><p>中文名称<strong>端口</strong>，需要注意的是它和TCP里面的端口不是同样的概念，它更像是物理交换机上面的插口，可以接水晶头的那种。Port隶属于Bridge，必须先添加了Bridge才能在Bridge上添加Port。Port有以下几种类型：</p><ul><li><p><strong>Normal</strong></p><p>用户可以把操作系统中已有的网卡添加到Open vSwicth上，Open vSwitct会自动生成一个同名的Port开处理这张网卡进和出的数据报文。</p><blockquote><p>不过需要注意的是这种方式添加的Port不支持分配IP地址，如果之前网卡上配置的有IP，挂载到OVS上面之后将不可访问。此类型的Port常用于VLAN模式的多台物理主机相连的那个口，交换机一端属于Trunk模式。</p></blockquote></li><li><p><strong>Internal</strong></p><p>当Port的类型是Internal时，OVS会自动创建一个虚拟网卡（Interface），此端口收到的数据报文都会转发给这块网卡，从这块网卡发出的数据报文也会通过Port交给OVS处理。当OVS创建一个新的网桥时，会自动创建一个与网桥同名的Internal Port，同时也会创建一个与网桥同名的Interface，因此可以通过ip命令在操作系统中查看到这张虚拟网卡，但是状态是down的。</p></li><li><p><strong>Patch</strong></p><p>Patch Port和veth pair功能相同，总是成双成对的出现，在其中一端收到的数据报文会被转发到另一个Patch Port上，就像是一根网线一样。Patch Port常用于连接两个Bridge，这样两个网桥就和一个网桥一样了。</p></li><li><p><strong>Tunnel</strong></p><p>OVS 支持 GRE、VXLAN、STT、Geneve和IPsec隧道协议，这些隧道协议就是overlay网络的基础协议，通过对物理网络做的一层封装和扩展，解决了二层网络数量不足的问题，最大限度的减少对底层物理网络拓扑的依赖性，同时也最大限度的增加了对网络的控制。</p></li></ul><h3 id=interface>Interface</h3><p>（iface/接口）接口是OVS与操作系统交换数据报文的组件，一个接口即是操作系统上的一块网卡，这个网卡可能是OVS生成的虚拟网卡，也有可能是挂载在OVS上的物理网卡，操作系统上的虚拟网卡（TUN/TAP）也可以被挂载在OVS上。</p><h3 id=controller>Controller</h3><p>OpenFlow控制器，OVS可以接收一个或者多个OpenFlow控制器的管理，功能主要是下发流表，控制转发规则。</p><h3 id=flow>Flow</h3><p>流表是OVS进行数据转发的核心功能，定义了端口之间转发数据报文的规则，一条流表规则主要分为匹配和动作两部分，匹配部分决定哪些数据报文需要被处理，动作决定了匹配到的数据报文该如何处理。</p><h1 id=ovs常用操作>OVS常用操作</h1><h3 id=安装>安装</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install openvswitch
</span></span><span style=display:flex><span>systemctl enable openvswitch
</span></span><span style=display:flex><span>systemctl start openvswitch
</span></span></code></pre></div><blockquote><p>如果当前软件源中没有openvswitch，可以通过<a href="https://developer.aliyun.com/packageSearch?word=openvswitch">阿里云官方镜像站</a>下载和操作系统版本对应的rpm包到本地再安装。 示例命令： <code>yum localinstall openvswitch-2.9.0-3.el7.x86_64.rpm</code></p></blockquote><h3 id=bridge-操作>Bridge 操作</h3><p>添加网桥</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ovs-vsctl add-br br-int
</span></span></code></pre></div><p>查询网桥列表</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ovs-vsctl list-br
</span></span></code></pre></div><p>删除网桥</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ovs-vsctl del-br br-int
</span></span></code></pre></div><h3 id=port-操作>Port 操作</h3><ul><li><strong>Normal Port</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 将物理网卡eth0添加到网桥br-int上</span>
</span></span><span style=display:flex><span>ovs-vsctl add-port br-int eth0
</span></span><span style=display:flex><span><span style=color:#75715e># 移除网桥br-int上的Port</span>
</span></span><span style=display:flex><span>ovs-vsctl del-port br-int eth0
</span></span></code></pre></div><ul><li><strong>Internal Port</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 添加Internal Port </span>
</span></span><span style=display:flex><span>ovs-vsctl add-port br-int vnet0 -- set Interface vnet0 type<span style=color:#f92672>=</span>internal
</span></span><span style=display:flex><span><span style=color:#75715e># 把网卡vnet0启动并配置IP</span>
</span></span><span style=display:flex><span>ip link set vnet0 up
</span></span><span style=display:flex><span>ip addr add 192.168.0.1/24 dev vnet0
</span></span><span style=display:flex><span><span style=color:#75715e># 设置VLAN tag</span>
</span></span><span style=display:flex><span>ovs-vsctl set Port vnet0 tag<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 移除vnet0上面的VLAN tag配置</span>
</span></span><span style=display:flex><span>ovs-vsctl remove Port vnet0 tag <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 设置vnet0允许通过的VLAN tag</span>
</span></span><span style=display:flex><span>ovs-vsctl set Port vnet0 trunks<span style=color:#f92672>=</span>100,200
</span></span><span style=display:flex><span><span style=color:#75715e># 移除vnet0允许通过的的VLAN tag配置</span>
</span></span><span style=display:flex><span>ovs-vsctl remove Port vnet0 trunks 100,200
</span></span></code></pre></div><ul><li><strong>Patch Port</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ovs-vsctl add-br br0
</span></span><span style=display:flex><span>ovs-vsctl add-br br1
</span></span><span style=display:flex><span>ovs-vsctl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-- add-port br0 patch0 -- set interface patch0 type<span style=color:#f92672>=</span>patch options:peer<span style=color:#f92672>=</span>patch1 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-- add-port br1 patch1 -- set interface patch1 type<span style=color:#f92672>=</span>patch options:peer<span style=color:#f92672>=</span>patch0
</span></span></code></pre></div><ul><li><strong>Tunnel Port</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#主机10.1.7.21上</span>
</span></span><span style=display:flex><span>ovs-vsctl add-br br-tun
</span></span><span style=display:flex><span>ovs-vsctl add-port br-tun vxlan-vx01 -- set Interface vxlan-vx01 type<span style=color:#f92672>=</span>vxlan options:remote_ip<span style=color:#f92672>=</span>10.1.7.22 options:key<span style=color:#f92672>=</span>flow
</span></span><span style=display:flex><span>ovs-vsctl add-port br-tun vxlan-vx02 -- set Interface vxlan-vx02 type<span style=color:#f92672>=</span>vxlan options:remote_ip<span style=color:#f92672>=</span>10.1.7.23 options:key<span style=color:#f92672>=</span>flow
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#主机10.1.7.22上</span>
</span></span><span style=display:flex><span>ovs-vsctl add-br br-tun
</span></span><span style=display:flex><span>ovs-vsctl add-port br-tun vxlan-vx01 -- set Interface vxlan-vx01 type<span style=color:#f92672>=</span>vxlan options:remote_ip<span style=color:#f92672>=</span>10.1.7.21 options:key<span style=color:#f92672>=</span>flow
</span></span><span style=display:flex><span>ovs-vsctl add-port br-tun vxlan-vx02 -- set Interface vxlan-vx02 type<span style=color:#f92672>=</span>vxlan options:remote_ip<span style=color:#f92672>=</span>10.1.7.23 options:key<span style=color:#f92672>=</span>flow
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#主机10.1.7.23上</span>
</span></span><span style=display:flex><span>ovs-vsctl add-br br-tun
</span></span><span style=display:flex><span>ovs-vsctl add-port br-tun vxlan-vx01 -- set Interface vxlan-vx01 type<span style=color:#f92672>=</span>vxlan options:remote_ip<span style=color:#f92672>=</span>10.1.7.21 options:key<span style=color:#f92672>=</span>flow
</span></span><span style=display:flex><span>ovs-vsctl add-port br-tun vxlan-vx02 -- set Interface vxlan-vx02 type<span style=color:#f92672>=</span>vxlan options:remote_ip<span style=color:#f92672>=</span>10.1.7.22 options:key<span style=color:#f92672>=</span>flow
</span></span></code></pre></div><ul><li>其他基本操作</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 设置VLAN mode</span>
</span></span><span style=display:flex><span>ovs-vsctl set port &lt;port name&gt; VLAN_mode<span style=color:#f92672>=</span>trunk|access|native-tagged|native-untagged
</span></span><span style=display:flex><span><span style=color:#75715e># 设置VLAN tag</span>
</span></span><span style=display:flex><span>ovs-vsctl set port &lt;port name&gt; tag<span style=color:#f92672>=</span>&lt;1-4095&gt;
</span></span><span style=display:flex><span><span style=color:#75715e># 设置VLAN trunk</span>
</span></span><span style=display:flex><span>ovs-vsctl set port &lt;port name&gt; trunk<span style=color:#f92672>=</span>100,200
</span></span><span style=display:flex><span><span style=color:#75715e># 移除Port的属性</span>
</span></span><span style=display:flex><span>ovs-vsctl remove port &lt;port name&gt; &lt;property name&gt; &lt;property value&gt;
</span></span><span style=display:flex><span><span style=color:#75715e># 查看Port的属性</span>
</span></span><span style=display:flex><span>ovs-vsctl list interface &lt;port name&gt;
</span></span></code></pre></div><p>接下来我们将使用OVS来实现单机和多台物理服务器下的虚拟VLAN网络。</p></article></div></main></body></html>