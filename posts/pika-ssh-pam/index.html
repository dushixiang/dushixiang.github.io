<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="引言
对于服务器管理员来说，监控 SSH 登录行为是安全运维的基础需求。传统方案通常依赖定期解析 /var/log/auth.log 或 /var/log/secure 等日志文件，但这种方式存在明显的局限性：需要不断轮询文件、日志格式因发行版而异、无法实时响应异常登录。
Pika Monitor 采用了一种更优雅的方案：基于 Linux PAM（Pluggable Authentication Modules）机制，实现了毫秒级的 SSH 登录实时监控。当有用户登录时，系统能立即感知并触发告警，无需任何轮询操作。
核心原理
PAM 是什么
PAM 是 Linux 系统的插件式认证框架，几乎所有需要身份验证的程序（包括 SSH）都会调用 PAM。PAM 将认证过程分为四个阶段：

auth：身份验证（检查密码、密钥等）
account：账户检查（账户是否过期、是否被锁定等）
password：密码管理
session：会话管理（登录成功后的环境配置）

PAM 提供了 pam_exec.so 模块，允许在认证流程的任何阶段执行外部程序。这是我们实现监控的关键切入点。
监控流程
整个监控流程可以用一条简洁的链路表示：
SSH 登录 → PAM 认证 → pam_exec.so → pika-ssh-login-hook → Unix Socket → pika-agent → 告警/记录
具体步骤如下：

用户通过 SSH 登录服务器
SSH 服务器调用 PAM 进行身份认证
认证成功后，PAM 进入 session 阶段（会话打开）
此时 pam_exec.so 模块被触发，执行 pika-ssh-login-hook 程序
pika-ssh-login-hook 从 PAM 提供的环境变量中读取登录信息（用户名、客户端 IP、端口、终端类型等）
将这些信息封装成 JSON 格式，通过 Unix Domain Socket 发送给 pika-agent
pika-agent 收到事件后，立即进行处理（记录日志、发送告警等）

整个过程在毫秒级别完成，对用户登录体验没有任何影响。"><title>Pika Monitor SSH 登录监控原理</title><link rel="shortcut icon" type=image/x-icon href=/><link rel=stylesheet href=/css/main.0568d3f70e9896300444ff10565468b82c2dace6b1b82bc72fba6ae51bfb0849887e0eb4ccb3cdb1c915fbe68c7000fbea631be9322fd5d0bcab56732ce7293f.css integrity="sha512-BWjT9w6YljAERP8QVlRouCwtrOaxuCvHL7pq5Rv7CEmIfg60zLPNsckV++aMcAD76mMb6TIv1dC8q1ZzLOcpPw=="></head><body a=auto><main class=page-content aria-label=Content><div class=w><div class=post-meta><a href=/>..</a><p><time datetime="2026-01-13 00:00:00 +0000 UTC">2026-01-13</time></p></div><article><h1>Pika Monitor SSH 登录监控原理</h1><h2 id=引言>引言</h2><p>对于服务器管理员来说，监控 SSH 登录行为是安全运维的基础需求。传统方案通常依赖定期解析 <code>/var/log/auth.log</code> 或 <code>/var/log/secure</code> 等日志文件，但这种方式存在明显的局限性：需要不断轮询文件、日志格式因发行版而异、无法实时响应异常登录。</p><p>Pika Monitor 采用了一种更优雅的方案：基于 Linux PAM（Pluggable Authentication Modules）机制，实现了毫秒级的 SSH 登录实时监控。当有用户登录时，系统能立即感知并触发告警，无需任何轮询操作。</p><h2 id=核心原理>核心原理</h2><h3 id=pam-是什么>PAM 是什么</h3><p>PAM 是 Linux 系统的插件式认证框架，几乎所有需要身份验证的程序（包括 SSH）都会调用 PAM。PAM 将认证过程分为四个阶段：</p><ul><li><strong>auth</strong>：身份验证（检查密码、密钥等）</li><li><strong>account</strong>：账户检查（账户是否过期、是否被锁定等）</li><li><strong>password</strong>：密码管理</li><li><strong>session</strong>：会话管理（登录成功后的环境配置）</li></ul><p>PAM 提供了 <code>pam_exec.so</code> 模块，允许在认证流程的任何阶段执行外部程序。这是我们实现监控的关键切入点。</p><h3 id=监控流程>监控流程</h3><p>整个监控流程可以用一条简洁的链路表示：</p><pre tabindex=0><code>SSH 登录 → PAM 认证 → pam_exec.so → pika-ssh-login-hook → Unix Socket → pika-agent → 告警/记录
</code></pre><p>具体步骤如下：</p><ol><li>用户通过 SSH 登录服务器</li><li>SSH 服务器调用 PAM 进行身份认证</li><li>认证成功后，PAM 进入 session 阶段（会话打开）</li><li>此时 <code>pam_exec.so</code> 模块被触发，执行 <code>pika-ssh-login-hook</code> 程序</li><li><code>pika-ssh-login-hook</code> 从 PAM 提供的环境变量中读取登录信息（用户名、客户端 IP、端口、终端类型等）</li><li>将这些信息封装成 JSON 格式，通过 Unix Domain Socket 发送给 <code>pika-agent</code></li><li><code>pika-agent</code> 收到事件后，立即进行处理（记录日志、发送告警等）</li></ol><p>整个过程在毫秒级别完成，对用户登录体验没有任何影响。</p><h3 id=设计关键点>设计关键点</h3><p><strong>为什么使用 optional 标志</strong></p><p>在 PAM 配置中，我们使用 <code>session optional pam_exec.so</code> 的方式注册 hook。<code>optional</code> 表示即使这个模块执行失败，也不会影响用户正常登录。这是一个重要的安全设计：监控功能不应该成为系统可用性的瓶颈。</p><p><strong>为什么选择 Unix Socket</strong></p><p>进程间通信有很多方式（文件、管道、共享内存等），我们选择 Unix Domain Socket 的原因是：</p><ul><li>高性能：本地通信，无需网络协议栈开销</li><li>无需轮询：事件驱动，实时推送</li><li>简单可靠：单向通信，无需复杂的同步机制</li><li>权限控制：可以通过文件权限限制访问</li></ul><p>我们使用 <code>unixgram</code> 类型（类似 UDP），因为 hook 进程生命周期很短，无需维护长连接。</p><h2 id=自动化安装>自动化安装</h2><p>Pika 提供了自动化的安装流程，用户只需执行一条命令即可完成配置。安装过程包括以下步骤：</p><h3 id=配置步骤>配置步骤</h3><ol><li><strong>检查并启用 SSH 的 PAM 支持</strong>：在 <code>/etc/ssh/sshd_config</code> 中确保 <code>UsePAM yes</code> 已启用</li><li><strong>修改 PAM 配置</strong>：在 <code>/etc/pam.d/sshd</code> 文件末尾添加 hook 配置行</li><li><strong>安装可执行文件</strong>：将 <code>pika-agent</code> 放到 <code>/usr/local/bin/</code> 目录（优先使用软链接）</li><li><strong>重启 sshd 服务</strong>：使配置生效（自动检测 systemd 或 SysV init）</li></ol><h3 id=设计亮点>设计亮点</h3><p><strong>幂等性</strong>：安装程序会先检查配置是否已存在，避免重复安装导致配置文件混乱。</p><p><strong>安全回滚</strong>：在修改任何配置文件前，都会先创建 <code>.bak</code> 备份。如果安装过程中出现错误，会自动恢复原始配置，确保系统不会因为安装失败而无法登录。</p><p><strong>兼容性</strong>：自动识别系统使用的服务管理工具（systemctl 或 service），并尝试多种可能的服务名称（sshd 或 ssh），适配不同的 Linux 发行版。</p><p><strong>权限控制</strong>：Socket 文件的权限设置为 0600，确保只有 root 用户可以访问，防止敏感登录信息泄露。</p><h2 id=技术细节>技术细节</h2><h3 id=环境变量提取>环境变量提取</h3><p>当 <code>pam_exec.so</code> 执行外部程序时，会将认证信息通过环境变量传递：</p><ul><li><code>PAM_USER</code>：登录的用户名</li><li><code>PAM_RHOST</code>：客户端的 IP 地址</li><li><code>PAM_TTY</code>：使用的终端类型（如 pts/0）</li><li><code>SSH_CONNECTION</code>：完整的连接四元组，格式为 &ldquo;客户端IP 客户端端口 服务器IP 服务器端口&rdquo;</li></ul><p><code>pika-ssh-login-hook</code> 从这些环境变量中提取信息，并处理各种边界情况（如变量为空时使用默认值）。</p><h3 id=进程间通信机制>进程间通信机制</h3><p>监控服务在启动时会创建 Unix Socket 并持续监听。当 hook 进程发送事件时：</p><ol><li>Hook 进程连接到 Socket（<code>/run/pika/ssh_login.sock</code>）</li><li>将事件序列化为 JSON 并发送</li><li>立即关闭连接并退出（整个过程 &lt; 10ms）</li></ol><p>监控服务收到数据后：</p><ol><li>从 Socket 读取数据（使用 4096 字节缓冲区）</li><li>反序列化 JSON</li><li>补全缺失字段（如时间戳、状态）</li><li>将事件发送到事件队列（缓冲 100 个事件）</li></ol><h3 id=错误处理策略>错误处理策略</h3><p><strong>发送端（Hook）</strong>：如果 Socket 连接失败或发送失败，静默失败，不影响用户登录流程。</p><p><strong>接收端（Monitor）</strong>：如果 JSON 解析失败，记录错误日志并跳过该事件。如果事件队列已满，丢弃新事件而非阻塞（避免影响后续登录）。</p><p>这种设计确保了监控功能的失败不会成为系统可用性的单点故障。</p><h2 id=总结>总结</h2><p>Pika Monitor 的 SSH 登录监控方案充分利用了 Linux PAM 机制，实现了以下优势：</p><ul><li><strong>实时性</strong>：毫秒级事件通知，无需轮询日志文件</li><li><strong>可靠性</strong>：基于系统原生的 PAM 框架，无需额外守护进程</li><li><strong>低开销</strong>：Hook 进程快速退出，对系统性能影响极小</li><li><strong>安全性</strong>：使用 optional 标志，配置失败不影响正常登录</li></ul><p>这套方案特别适合需要实时感知 SSH 登录的场景，如安全审计、异常登录告警、堡垒机监控等。通过在认证流程中插入轻量级的 hook，我们在不牺牲性能和可靠性的前提下，获得了对系统访问行为的完整掌控。</p><p>完整的代码实现可以参考：https://github.com/dushixiang/pika</p></article></div></main></body></html>