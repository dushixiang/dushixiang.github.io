<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="前言
当我们想要在不影响虚拟网络设备数据报文收发的情况下获取对应虚拟网络设备的流量时，端口镜像是一个很好的选择。端口镜像是指将经过指定端口（镜像端口）的报文复制一份到另一个指定端口（观察端口），通过观察端口接收到的数据报文，就可以有效识别虚拟网络的运行情况。
OVS提供了相关命令来配置或删除端口镜像，下面我们来实验一下。
如何使用
端口镜像类型
端口镜像分为镜像源和镜像目的两部分。
镜像源

select_all：布尔类型（true，false）。设置为 true 时，表示此网桥上的所有流量。
select_dst_port：字符串（端口名称）。表示此端口接收的所有流量。
select_src_port：字符串（端口名称）。表示此端口发送的所有流量。
select_vlan：整型（0-4095）。表示携带此VLAN标签的流量。

镜像目的

output_port：字符串（端口名称）。接收流量报文的观察端口。
output_vlan：整型（0-4095）。表示只修改VLAN标签，原VLAN标签会被剥离。

基础操作命令
新增端口镜像
ovs-vsctl -- set Bridge <bridge_name> mirrors=@m \
 -- --id=@<port0> get Port <port0> \
 -- --id=@<port1> get Port <port1> \
 -- --id=@m create Mirror name=<mirror_name> select-dst-port=@<port0> select-src-port=@<port0> output-port=@<port1>

这行命令会输出一个镜像ID
删除端口镜像
ovs-vsctl remove Bridge <bridge-name> mirrors <mirror-id>
在原端口镜像的基础上增加一个镜像源
# 获取端口的ID
ovs-vsctl get port <port_name> _uuid

# 在原端口镜像的基础上增加镜像源
ovs-vsctl add Mirror <mirror-name> select_src_port <port-id>
ovs-vsctl add Mirror <mirror-name> select_dst_port <port-id>
在原端口镜像的基础上删除一个镜像源"><title>Open vSwitch 入门实践（4）使用OVS配置端口镜像</title><link rel="shortcut icon" type=image/x-icon href=/><link rel=stylesheet href=/css/main.0568d3f70e9896300444ff10565468b82c2dace6b1b82bc72fba6ae51bfb0849887e0eb4ccb3cdb1c915fbe68c7000fbea631be9322fd5d0bcab56732ce7293f.css integrity="sha512-BWjT9w6YljAERP8QVlRouCwtrOaxuCvHL7pq5Rv7CEmIfg60zLPNsckV++aMcAD76mMb6TIv1dC8q1ZzLOcpPw=="></head><body a=auto><main class=page-content aria-label=Content><div class=w><div class=post-meta><a href=/>..</a><p><time datetime="2020-12-28 19:23:00 +0000 UTC">2020-12-28</time></p></div><article><h1>Open vSwitch 入门实践（4）使用OVS配置端口镜像</h1><h1 id=前言>前言</h1><p>当我们想要在不影响虚拟网络设备数据报文收发的情况下获取对应虚拟网络设备的流量时，端口镜像是一个很好的选择。端口镜像是指将经过指定端口（镜像端口）的报文复制一份到另一个指定端口（观察端口），通过观察端口接收到的数据报文，就可以有效识别虚拟网络的运行情况。</p><p>OVS提供了相关命令来配置或删除端口镜像，下面我们来实验一下。</p><h1 id=如何使用>如何使用</h1><h3 id=端口镜像类型>端口镜像类型</h3><p>端口镜像分为镜像源和镜像目的两部分。</p><h4 id=镜像源>镜像源</h4><ul><li>select_all：布尔类型（true，false）。设置为 true 时，表示此网桥上的所有流量。</li><li>select_dst_port：字符串（端口名称）。表示此端口接收的所有流量。</li><li>select_src_port：字符串（端口名称）。表示此端口发送的所有流量。</li><li>select_vlan：整型（0-4095）。表示携带此VLAN标签的流量。</li></ul><h4 id=镜像目的>镜像目的</h4><ul><li>output_port：字符串（端口名称）。接收流量报文的观察端口。</li><li>output_vlan：整型（0-4095）。表示只修改VLAN标签，原VLAN标签会被剥离。</li></ul><h3 id=基础操作命令>基础操作命令</h3><p>新增端口镜像</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ovs-vsctl -- <span style=color:#8be9fd;font-style:italic>set</span> Bridge &lt;bridge_name&gt; <span style=color:#8be9fd;font-style:italic>mirrors</span><span style=color:#ff79c6>=</span>@m <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span> -- --id<span style=color:#ff79c6>=</span>@&lt;port0&gt; get Port &lt;port0&gt; <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span> -- --id<span style=color:#ff79c6>=</span>@&lt;port1&gt; get Port &lt;port1&gt; <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span> -- --id<span style=color:#ff79c6>=</span>@m create Mirror <span style=color:#8be9fd;font-style:italic>name</span><span style=color:#ff79c6>=</span>&lt;mirror_name&gt; <span style=color:#ff79c6>select</span>-dst-port<span style=color:#ff79c6>=</span>@&lt;port0&gt; <span style=color:#ff79c6>select</span>-src-port<span style=color:#ff79c6>=</span>@&lt;port0&gt; output-port<span style=color:#ff79c6>=</span>@&lt;port1&gt;
</span></span></code></pre></div><blockquote><p>这行命令会输出一个镜像ID</p></blockquote><p>删除端口镜像</p><pre tabindex=0><code>ovs-vsctl remove Bridge &lt;bridge-name&gt; mirrors &lt;mirror-id&gt;
</code></pre><p>在原端口镜像的基础上增加一个镜像源</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#6272a4># 获取端口的ID</span>
</span></span><span style=display:flex><span>ovs-vsctl get port &lt;port_name&gt; _uuid
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 在原端口镜像的基础上增加镜像源</span>
</span></span><span style=display:flex><span>ovs-vsctl add Mirror &lt;mirror-name&gt; select_src_port &lt;port-id&gt;
</span></span><span style=display:flex><span>ovs-vsctl add Mirror &lt;mirror-name&gt; select_dst_port &lt;port-id&gt;
</span></span></code></pre></div><p>在原端口镜像的基础上删除一个镜像源</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#6272a4># 获取端口的ID</span>
</span></span><span style=display:flex><span>ovs-vsctl get port &lt;port_name&gt; _uuid
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ovs-vsctl remove Mirror &lt;mirror-name&gt; select_src_port &lt;port-id&gt;
</span></span><span style=display:flex><span>ovs-vsctl remove Mirror &lt;mirror-name&gt; select_dst_port &lt;port-id&gt;
</span></span></code></pre></div><p>清空端口镜像</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ovs-vsctl clear Mirror 
</span></span></code></pre></div><p>查看端口镜像</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ovs-vsctl list Mirror 
</span></span></code></pre></div><p>关闭端口的MAC地址学习</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ovs-ofctl mod-port &lt;bridge-name&gt; &lt;port-name&gt; NO-FLOOD
</span></span></code></pre></div><h1 id=实验>实验</h1><h3 id=实验拓扑>实验拓扑</h3><p>实验拓扑分为一个网桥，三个虚拟网络设备，</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#6272a4># 添加网桥</span>
</span></span><span style=display:flex><span>ovs-vsctl add-br br-int
</span></span><span style=display:flex><span><span style=color:#6272a4># 添加三个内部端口</span>
</span></span><span style=display:flex><span>ovs-vsctl add-port br-int vnet0 -- <span style=color:#8be9fd;font-style:italic>set</span> Interface vnet0 <span style=color:#8be9fd;font-style:italic>type</span><span style=color:#ff79c6>=</span>internal
</span></span><span style=display:flex><span>ovs-vsctl add-port br-int vnet1 -- <span style=color:#8be9fd;font-style:italic>set</span> Interface vnet1 <span style=color:#8be9fd;font-style:italic>type</span><span style=color:#ff79c6>=</span>internal
</span></span><span style=display:flex><span>ovs-vsctl add-port br-int vnet2 -- <span style=color:#8be9fd;font-style:italic>set</span> Interface vnet2 <span style=color:#8be9fd;font-style:italic>type</span><span style=color:#ff79c6>=</span>internal
</span></span><span style=display:flex><span><span style=color:#6272a4># 添加三个netns</span>
</span></span><span style=display:flex><span>ip netns add ns0
</span></span><span style=display:flex><span>ip netns add ns1
</span></span><span style=display:flex><span>ip netns add ns2
</span></span><span style=display:flex><span><span style=color:#6272a4># 将内部端口分别移动到netns中</span>
</span></span><span style=display:flex><span>ip link <span style=color:#8be9fd;font-style:italic>set</span> vnet0 netns ns0
</span></span><span style=display:flex><span>ip link <span style=color:#8be9fd;font-style:italic>set</span> vnet1 netns ns1
</span></span><span style=display:flex><span>ip link <span style=color:#8be9fd;font-style:italic>set</span> vnet2 netns ns2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 启动端口并配置IP</span>
</span></span><span style=display:flex><span>ip netns <span style=color:#8be9fd;font-style:italic>exec</span> ns0 ip link <span style=color:#8be9fd;font-style:italic>set</span> lo up
</span></span><span style=display:flex><span>ip netns <span style=color:#8be9fd;font-style:italic>exec</span> ns0 ip link <span style=color:#8be9fd;font-style:italic>set</span> vnet0 up
</span></span><span style=display:flex><span>ip netns <span style=color:#8be9fd;font-style:italic>exec</span> ns0 ip addr add 10.0.0.1/24 dev vnet0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ip netns <span style=color:#8be9fd;font-style:italic>exec</span> ns1 ip link <span style=color:#8be9fd;font-style:italic>set</span> lo up
</span></span><span style=display:flex><span>ip netns <span style=color:#8be9fd;font-style:italic>exec</span> ns1 ip link <span style=color:#8be9fd;font-style:italic>set</span> vnet1 up
</span></span><span style=display:flex><span>ip netns <span style=color:#8be9fd;font-style:italic>exec</span> ns1 ip addr add 10.0.0.2/24 dev vnet1
</span></span><span style=display:flex><span><span style=color:#6272a4># 注意这里只启动了网卡，但没有配置IP</span>
</span></span><span style=display:flex><span>ip netns <span style=color:#8be9fd;font-style:italic>exec</span> ns2 ip link <span style=color:#8be9fd;font-style:italic>set</span> lo up
</span></span><span style=display:flex><span>ip netns <span style=color:#8be9fd;font-style:italic>exec</span> ns2 ip link <span style=color:#8be9fd;font-style:italic>set</span> vnet2 up
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ovs-vsctl -- <span style=color:#8be9fd;font-style:italic>set</span> Bridge br-int <span style=color:#8be9fd;font-style:italic>mirrors</span><span style=color:#ff79c6>=</span>@m <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span> -- --id<span style=color:#ff79c6>=</span>@vnet1 get Port vnet1 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span> -- --id<span style=color:#ff79c6>=</span>@vnet2 get Port vnet2 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span> -- --id<span style=color:#ff79c6>=</span>@m create Mirror <span style=color:#8be9fd;font-style:italic>name</span><span style=color:#ff79c6>=</span>mirror_test <span style=color:#ff79c6>select</span>-dst-port<span style=color:#ff79c6>=</span>@vnet1 <span style=color:#ff79c6>select</span>-src-port<span style=color:#ff79c6>=</span>@vnet1 output-port<span style=color:#ff79c6>=</span>@vnet2
</span></span></code></pre></div><h3 id=测试>测试</h3><p>执行以下命令产生流量</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip netns <span style=color:#8be9fd;font-style:italic>exec</span> ns0 ping 10.0.0.2
</span></span></code></pre></div><p>重新打开一个终端执行以下命令抓包</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip netns <span style=color:#8be9fd;font-style:italic>exec</span> ns2 tcpdump -i vnet2
</span></span></code></pre></div><blockquote><p>需要安装tcpdump才能使用</p></blockquote><p>输出</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tcpdump: verbose output suppressed, use -v or -vv <span style=color:#ff79c6>for</span> full protocol decode
</span></span><span style=display:flex><span>listening on vnet2, link-type EN10MB <span style=color:#ff79c6>(</span>Ethernet<span style=color:#ff79c6>)</span>, capture size <span style=color:#bd93f9>262144</span> bytes
</span></span><span style=display:flex><span>22:26:31.140974 IP 10.0.0.1 &gt; 10.0.0.2: ICMP <span style=color:#8be9fd;font-style:italic>echo</span> request, id 4599, seq 23, length <span style=color:#bd93f9>64</span>
</span></span><span style=display:flex><span>22:26:31.140996 IP 10.0.0.2 &gt; 10.0.0.1: ICMP <span style=color:#8be9fd;font-style:italic>echo</span> reply, id 4599, seq 23, length <span style=color:#bd93f9>64</span>
</span></span><span style=display:flex><span>22:26:32.141066 IP 10.0.0.1 &gt; 10.0.0.2: ICMP <span style=color:#8be9fd;font-style:italic>echo</span> request, id 4599, seq 24, length <span style=color:#bd93f9>64</span>
</span></span><span style=display:flex><span>22:26:32.141085 IP 10.0.0.2 &gt; 10.0.0.1: ICMP <span style=color:#8be9fd;font-style:italic>echo</span> reply, id 4599, seq 24, length <span style=color:#bd93f9>64</span>
</span></span><span style=display:flex><span>22:26:33.141066 IP 10.0.0.1 &gt; 10.0.0.2: ICMP <span style=color:#8be9fd;font-style:italic>echo</span> request, id 4599, seq 25, length <span style=color:#bd93f9>64</span>
</span></span><span style=display:flex><span>22:26:33.141108 IP 10.0.0.2 &gt; 10.0.0.1: ICMP <span style=color:#8be9fd;font-style:italic>echo</span> reply, id 4599, seq 25, length <span style=color:#bd93f9>64</span>
</span></span><span style=display:flex><span>22:26:34.141044 IP 10.0.0.1 &gt; 10.0.0.2: ICMP <span style=color:#8be9fd;font-style:italic>echo</span> request, id 4599, seq 26, length <span style=color:#bd93f9>64</span>
</span></span><span style=display:flex><span>22:26:34.141062 IP 10.0.0.2 &gt; 10.0.0.1: ICMP <span style=color:#8be9fd;font-style:italic>echo</span> reply, id 4599, seq 26, length <span style=color:#bd93f9>64</span>
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span><span style=color:#bd93f9>8</span> packets captured
</span></span><span style=display:flex><span><span style=color:#bd93f9>8</span> packets received by filter
</span></span><span style=display:flex><span><span style=color:#bd93f9>0</span> packets dropped by kernel
</span></span></code></pre></div><h3 id=清理实验环境>清理实验环境</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip netns del ns0
</span></span><span style=display:flex><span>ip netns del ns1
</span></span><span style=display:flex><span>ip netns del ns2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ovs-vsctl del-br br-int
</span></span></code></pre></div></article></div></main></body></html>