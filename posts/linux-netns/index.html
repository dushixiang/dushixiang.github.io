<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Network Namespace （以下简称netns）是Linux内核提供的一项实现网络隔离的功能，它能隔离多个不同的网络空间，并且各自拥有独立的网络协议栈，这其中便包括了网络接口（网卡），路由表，iptables规则等。例如大名鼎鼎的docker便是基于netns实现的网络隔离，今天我们就来手动实验一下netns的隔离特性。
使用方式
使用ip netns help查看使用帮助
Usage: ip netns list
       ip netns add NAME
       ip netns set NAME NETNSID
       ip [-all] netns delete [NAME]
       ip netns identify [PID]
       ip netns pids NAME
       ip [-all] netns exec [NAME] cmd ...
       ip netns monitor
       ip netns list-id
开始实验
我们将要构建如下图的网络

首先我们添加两个tap设备并配置上IP信息，然后添加两个netns，最后将tap设备移动到netns中
# 添加并启动虚拟网卡tap设备
ip tuntap add dev tap0 mode tap 
ip tuntap add dev tap1 mode tap 
ip link set tap0 up
ip link set tap1 up
# 配置IP
ip addr add 10.0.0.1/24 dev tap0
ip addr add 10.0.0.2/24 dev tap1
# 添加netns
ip netns add ns0
ip netns add ns1
# 将虚拟网卡tap0，tap1分别移动到ns0和ns1中
ip link set tap0 netns ns0
ip link set tap1 netns ns1
在宿主机器上使用ping 10.0.0.1测试与tap0的网络连通性"><title>Linux Network Namespace (netns) 详解</title><link rel="shortcut icon" type=image/x-icon href=/><link rel=stylesheet href=/css/main.0568d3f70e9896300444ff10565468b82c2dace6b1b82bc72fba6ae51bfb0849887e0eb4ccb3cdb1c915fbe68c7000fbea631be9322fd5d0bcab56732ce7293f.css integrity="sha512-BWjT9w6YljAERP8QVlRouCwtrOaxuCvHL7pq5Rv7CEmIfg60zLPNsckV++aMcAD76mMb6TIv1dC8q1ZzLOcpPw=="></head><body a=auto><main class=page-content aria-label=Content><div class=w><div class=post-meta><a href=/>..</a><p><time datetime="2020-11-08 23:12:00 +0000 UTC">2020-11-08</time></p></div><article><h1>Linux Network Namespace (netns) 详解</h1><p>Network Namespace （以下简称netns）是Linux内核提供的一项实现网络隔离的功能，它能隔离多个不同的网络空间，并且各自拥有独立的网络协议栈，这其中便包括了网络接口（网卡），路由表，iptables规则等。例如大名鼎鼎的docker便是基于netns实现的网络隔离，今天我们就来手动实验一下netns的隔离特性。</p><h3 id=使用方式>使用方式</h3><p>使用<code>ip netns help</code>查看使用帮助</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Usage: ip netns list
</span></span><span style=display:flex><span>       ip netns add NAME
</span></span><span style=display:flex><span>       ip netns <span style=color:#8be9fd;font-style:italic>set</span> NAME NETNSID
</span></span><span style=display:flex><span>       ip <span style=color:#ff79c6>[</span>-all<span style=color:#ff79c6>]</span> netns delete <span style=color:#ff79c6>[</span>NAME<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>       ip netns identify <span style=color:#ff79c6>[</span>PID<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>       ip netns pids NAME
</span></span><span style=display:flex><span>       ip <span style=color:#ff79c6>[</span>-all<span style=color:#ff79c6>]</span> netns <span style=color:#8be9fd;font-style:italic>exec</span> <span style=color:#ff79c6>[</span>NAME<span style=color:#ff79c6>]</span> cmd ...
</span></span><span style=display:flex><span>       ip netns monitor
</span></span><span style=display:flex><span>       ip netns list-id
</span></span></code></pre></div><h3 id=开始实验>开始实验</h3><p>我们将要构建如下图的网络</p><p><img src="https://oss.typesafe.cn/netns.png?t=2" alt=https://oss.typesafe.cn/netns.png></p><p>首先我们添加两个tap设备并配置上IP信息，然后添加两个netns，最后将tap设备移动到netns中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#6272a4># 添加并启动虚拟网卡tap设备</span>
</span></span><span style=display:flex><span>ip tuntap add dev tap0 mode tap 
</span></span><span style=display:flex><span>ip tuntap add dev tap1 mode tap 
</span></span><span style=display:flex><span>ip link <span style=color:#8be9fd;font-style:italic>set</span> tap0 up
</span></span><span style=display:flex><span>ip link <span style=color:#8be9fd;font-style:italic>set</span> tap1 up
</span></span><span style=display:flex><span><span style=color:#6272a4># 配置IP</span>
</span></span><span style=display:flex><span>ip addr add 10.0.0.1/24 dev tap0
</span></span><span style=display:flex><span>ip addr add 10.0.0.2/24 dev tap1
</span></span><span style=display:flex><span><span style=color:#6272a4># 添加netns</span>
</span></span><span style=display:flex><span>ip netns add ns0
</span></span><span style=display:flex><span>ip netns add ns1
</span></span><span style=display:flex><span><span style=color:#6272a4># 将虚拟网卡tap0，tap1分别移动到ns0和ns1中</span>
</span></span><span style=display:flex><span>ip link <span style=color:#8be9fd;font-style:italic>set</span> tap0 netns ns0
</span></span><span style=display:flex><span>ip link <span style=color:#8be9fd;font-style:italic>set</span> tap1 netns ns1
</span></span></code></pre></div><p>在宿主机器上使用<code>ping 10.0.0.1</code>测试与tap0的网络连通性</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>PING 10.0.0.1 <span style=color:#ff79c6>(</span>10.0.0.1<span style=color:#ff79c6>)</span> 56<span style=color:#ff79c6>(</span>84<span style=color:#ff79c6>)</span> bytes of data.
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 10.0.0.1 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#bd93f9>2</span> packets transmitted, <span style=color:#bd93f9>0</span> received, 100% packet loss, <span style=color:#8be9fd;font-style:italic>time</span> 58ms
</span></span></code></pre></div><p>在宿主机器上使用<code>ping 10.0.0.2</code>测试与tap1的网络连通性</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ping 10.0.0.2
</span></span><span style=display:flex><span>PING 10.0.0.2 <span style=color:#ff79c6>(</span>10.0.0.2<span style=color:#ff79c6>)</span> 56<span style=color:#ff79c6>(</span>84<span style=color:#ff79c6>)</span> bytes of data.
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 10.0.0.2 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#bd93f9>2</span> packets transmitted, <span style=color:#bd93f9>0</span> received, 100% packet loss, <span style=color:#8be9fd;font-style:italic>time</span> 36ms
</span></span></code></pre></div><blockquote><p>由于长时间未收到ICMP的回复报文，我使用Ctrl+C退出了。</p></blockquote><p>使用<code>ip netns exec ns0 ping 10.0.0.2</code>在命名空间ns0中测试与tap1的网络连通性</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>connect: 网络不可达
</span></span></code></pre></div><p>使用<code>ip netns exec ns1 ping 10.0.0.1</code>在命名空间ns1中测试与tap0的网络连通性</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>connect: 网络不可达
</span></span></code></pre></div><blockquote><p>在netns中执行命令有两种方式，一种是先在宿主机器上执行<code>ip netns exec &lt;netns name> bash</code>进入netns，然后就可以像是在本机一样执行命令了。另一种是每次在宿主机器上使用完整的命令，为了明显区分，我们这里都使用完整的命令，例如<code>ip netns exec ns0 ping 10.0.0.2</code>的含义为在命名空间<strong>ns0</strong>中执行<code>ping 10.0.0.2</code>命令</p></blockquote><p>可以看到在宿主机器上访问netns是丢包，而在netns中互相访问是<strong>网络不可达</strong>了，这是为什么呢？让我们来检查一下netns吧。</p><p>使用<code>ip netns exec ns0 ip a</code>在ns0中查看网卡</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>1: lo: &lt;LOOPBACK&gt; mtu <span style=color:#bd93f9>65536</span> qdisc noop state DOWN group default qlen <span style=color:#bd93f9>1000</span>
</span></span><span style=display:flex><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style=display:flex><span>16: tap0: &lt;BROADCAST,MULTICAST&gt; mtu <span style=color:#bd93f9>1500</span> qdisc noop state DOWN group default qlen <span style=color:#bd93f9>1000</span>
</span></span><span style=display:flex><span>    link/ether 42:ad:98:a2:cc:81 brd ff:ff:ff:ff:ff:ff
</span></span></code></pre></div><p>使用<code>ip netns exec ns1 ip a</code>在ns1中查看网卡</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>1: lo: &lt;LOOPBACK&gt; mtu <span style=color:#bd93f9>65536</span> qdisc noop state DOWN group default qlen <span style=color:#bd93f9>1000</span>
</span></span><span style=display:flex><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style=display:flex><span>17: tap1: &lt;BROADCAST,MULTICAST&gt; mtu <span style=color:#bd93f9>1500</span> qdisc noop state DOWN group default qlen <span style=color:#bd93f9>1000</span>
</span></span><span style=display:flex><span>    link/ether 12:06:1d:06:41:57 brd ff:ff:ff:ff:ff:ff
</span></span></code></pre></div><p><strong>可以看到不仅本地环回lo和tap设备的状态都是DOWN，甚至就连tap设备的IP信息也没有了，这是因为在不同的网络命名空间中移动虚拟网络接口时会重置虚拟网络接口的状态。</strong></p><p>我们将ns0和ns1中的相关设备都重新启动并配置上IP</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip netns <span style=color:#8be9fd;font-style:italic>exec</span> ns0 ip link <span style=color:#8be9fd;font-style:italic>set</span> lo up
</span></span><span style=display:flex><span>ip netns <span style=color:#8be9fd;font-style:italic>exec</span> ns0 ip link <span style=color:#8be9fd;font-style:italic>set</span> tap0 up
</span></span><span style=display:flex><span>ip netns <span style=color:#8be9fd;font-style:italic>exec</span> ns0 ip addr add 10.0.0.1/24 dev tap0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ip netns <span style=color:#8be9fd;font-style:italic>exec</span> ns1 ip link <span style=color:#8be9fd;font-style:italic>set</span> lo up
</span></span><span style=display:flex><span>ip netns <span style=color:#8be9fd;font-style:italic>exec</span> ns1 ip link <span style=color:#8be9fd;font-style:italic>set</span> tap1 up
</span></span><span style=display:flex><span>ip netns <span style=color:#8be9fd;font-style:italic>exec</span> ns1 ip addr add 10.0.0.2/24 dev tap1
</span></span></code></pre></div><p>首先我们测试一下netns中本地网络是否正常</p><p>使用<code>ip netns exec ns0 ping 10.0.0.1</code>在命名空间ns0中测试本地网卡是否启动</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PING 10.0.0.1 <span style=color:#ff79c6>(</span>10.0.0.1<span style=color:#ff79c6>)</span> 56<span style=color:#ff79c6>(</span>84<span style=color:#ff79c6>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#bd93f9>64</span> bytes from 10.0.0.1: <span style=color:#8be9fd;font-style:italic>icmp_seq</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>1</span> <span style=color:#8be9fd;font-style:italic>ttl</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>64</span> <span style=color:#8be9fd;font-style:italic>time</span><span style=color:#ff79c6>=</span>0.036 ms
</span></span><span style=display:flex><span><span style=color:#bd93f9>64</span> bytes from 10.0.0.1: <span style=color:#8be9fd;font-style:italic>icmp_seq</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>2</span> <span style=color:#8be9fd;font-style:italic>ttl</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>64</span> <span style=color:#8be9fd;font-style:italic>time</span><span style=color:#ff79c6>=</span>0.033 ms
</span></span><span style=display:flex><span><span style=color:#bd93f9>64</span> bytes from 10.0.0.1: <span style=color:#8be9fd;font-style:italic>icmp_seq</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>3</span> <span style=color:#8be9fd;font-style:italic>ttl</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>64</span> <span style=color:#8be9fd;font-style:italic>time</span><span style=color:#ff79c6>=</span>0.084 ms
</span></span><span style=display:flex><span><span style=color:#bd93f9>64</span> bytes from 10.0.0.1: <span style=color:#8be9fd;font-style:italic>icmp_seq</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>4</span> <span style=color:#8be9fd;font-style:italic>ttl</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>64</span> <span style=color:#8be9fd;font-style:italic>time</span><span style=color:#ff79c6>=</span>0.044 ms
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 10.0.0.1 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#bd93f9>4</span> packets transmitted, <span style=color:#bd93f9>4</span> received, 0% packet loss, <span style=color:#8be9fd;font-style:italic>time</span> 65ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#ff79c6>=</span> 0.033/0.049/0.084/0.021 ms
</span></span></code></pre></div><p>使用<code>ip netns exec ns1 ping 10.0.0.2</code>在命名空间ns1中测试本地网卡是否启动</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PING 10.0.0.2 <span style=color:#ff79c6>(</span>10.0.0.2<span style=color:#ff79c6>)</span> 56<span style=color:#ff79c6>(</span>84<span style=color:#ff79c6>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#bd93f9>64</span> bytes from 10.0.0.2: <span style=color:#8be9fd;font-style:italic>icmp_seq</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>1</span> <span style=color:#8be9fd;font-style:italic>ttl</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>64</span> <span style=color:#8be9fd;font-style:italic>time</span><span style=color:#ff79c6>=</span>0.033 ms
</span></span><span style=display:flex><span><span style=color:#bd93f9>64</span> bytes from 10.0.0.2: <span style=color:#8be9fd;font-style:italic>icmp_seq</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>2</span> <span style=color:#8be9fd;font-style:italic>ttl</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>64</span> <span style=color:#8be9fd;font-style:italic>time</span><span style=color:#ff79c6>=</span>0.034 ms
</span></span><span style=display:flex><span><span style=color:#bd93f9>64</span> bytes from 10.0.0.2: <span style=color:#8be9fd;font-style:italic>icmp_seq</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>3</span> <span style=color:#8be9fd;font-style:italic>ttl</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>64</span> <span style=color:#8be9fd;font-style:italic>time</span><span style=color:#ff79c6>=</span>0.065 ms
</span></span><span style=display:flex><span><span style=color:#bd93f9>64</span> bytes from 10.0.0.2: <span style=color:#8be9fd;font-style:italic>icmp_seq</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>4</span> <span style=color:#8be9fd;font-style:italic>ttl</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>64</span> <span style=color:#8be9fd;font-style:italic>time</span><span style=color:#ff79c6>=</span>0.035 ms
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 10.0.0.1 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#bd93f9>4</span> packets transmitted, <span style=color:#bd93f9>4</span> received, 0% packet loss, <span style=color:#8be9fd;font-style:italic>time</span> 65ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#ff79c6>=</span> 0.033/0.049/0.084/0.021 ms
</span></span></code></pre></div><p>可以看出本地网络没有问题，然后我们再来测试一下两个netns之间的网络连通性</p><p>使用<code>ip netns exec ns0 ping 10.0.0.2</code>在命名空间ns0中测试与tap1的网络连通性</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PING 10.0.0.2 <span style=color:#ff79c6>(</span>10.0.0.2<span style=color:#ff79c6>)</span> 56<span style=color:#ff79c6>(</span>84<span style=color:#ff79c6>)</span> bytes of data.
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 10.0.0.2 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#bd93f9>3</span> packets transmitted, <span style=color:#bd93f9>0</span> received, 100% packet loss, <span style=color:#8be9fd;font-style:italic>time</span> 84ms
</span></span></code></pre></div><p>使用<code>ip netns exec ns1 ping 10.0.0.1</code>在命名空间ns1中测试与tap0的网络连通性</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PING 10.0.0.1 <span style=color:#ff79c6>(</span>10.0.0.1<span style=color:#ff79c6>)</span> 56<span style=color:#ff79c6>(</span>84<span style=color:#ff79c6>)</span> bytes of data.
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 10.0.0.1 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#bd93f9>2</span> packets transmitted, <span style=color:#bd93f9>0</span> received, 100% packet loss, <span style=color:#8be9fd;font-style:italic>time</span> 30ms
</span></span></code></pre></div><p>可以看出没有任何ICMP回复包，netns确实把在同一台主机上的两张虚拟网卡隔离起来了。在这里我们只是简单的使用<code>ping</code>命令来测试网络的连通性，实际上可以做到更多，例如修改某一个netns的路由表或者防火墙规则，完全不会影响到其他的netns，当然也不会影响到宿主机器，在这里由于篇幅原因就不再展开实验了，感兴趣的同学可以实验一下。下一节我们将学习另一个网络设备veth pair，使用它来把两个netns连接起来，让两个隔离的​netns之间可以互相通信。</p></article></div></main></body></html>