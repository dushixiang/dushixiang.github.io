<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="前言
在前面我们已经使用Linux Bridge完成了多台网络设备的通信，但是它对于网络隔离的支持不是很好，长期以来，在Linux平台上缺少一个功能完备的虚拟交换机，直到OVS的出现。
实验
接下来我们来尝试完成两个实验，单机无隔离网络、单机隔离网络。
实验一：单机无隔离网络
使用ovs构建无隔离网络非常简单，只需要添加一个网桥，然后在这个网桥上再增加几个内部端口，最后把端口移动到netns中即可。
# 添加网桥
ovs-vsctl add-br br-int
# 添加三个内部端口
ovs-vsctl add-port br-int vnet0 -- set Interface vnet0 type=internal
ovs-vsctl add-port br-int vnet1 -- set Interface vnet1 type=internal
ovs-vsctl add-port br-int vnet2 -- set Interface vnet2 type=internal
# 添加三个netns
ip netns add ns0
ip netns add ns1
ip netns add ns2
# 将内部端口分别移动到netns中
ip link set vnet0 netns ns0
ip link set vnet1 netns ns1
ip link set vnet2 netns ns2

# 启动端口并配置IP
ip netns exec ns0 ip link set lo up
ip netns exec ns0 ip link set vnet0 up
ip netns exec ns0 ip addr add 10.0.0.1/24 dev vnet0

ip netns exec ns1 ip link set lo up
ip netns exec ns1 ip link set vnet1 up
ip netns exec ns1 ip addr add 10.0.0.2/24 dev vnet1

ip netns exec ns2 ip link set lo up
ip netns exec ns2 ip link set vnet2 up
ip netns exec ns2 ip addr add 10.0.0.3/24 dev vnet2
测试"><title>Open vSwitch 入门实践（2）使用OVS构建隔离网络</title><link rel="shortcut icon" type=image/x-icon href=/><link rel=stylesheet href=/css/main.51652302d3a998bf7887aed5c2cf89141bbebdf45a2c8f87b0717a3cf4f51c4e53c694c328fb1de78c3a625a1c01f80745bf1f2f42c040647a245cbbb6c2d1d7.css integrity="sha512-UWUjAtOpmL94h67Vws+JFBu+vfRaLI+HsHF6PPT1HE5TxpTDKPsd54w6YlocAfgHRb8fL0LAQGR6JFy7tsLR1w=="></head><body a=auto><main class=page-content aria-label=Content><div class=w><div class=post-meta><a href=/>..</a><p><time datetime="2020-11-26 22:55:00 +0000 UTC">2020-11-26</time></p></div><article><h1>Open vSwitch 入门实践（2）使用OVS构建隔离网络</h1><h1 id=前言>前言</h1><p>在前面我们已经使用Linux Bridge完成了多台网络设备的通信，但是它对于网络隔离的支持不是很好，长期以来，在Linux平台上缺少一个功能完备的虚拟交换机，直到OVS的出现。</p><h1 id=实验>实验</h1><p>接下来我们来尝试完成两个实验，单机无隔离网络、单机隔离网络。</p><h2 id=实验一单机无隔离网络>实验一：单机无隔离网络</h2><p>使用ovs构建无隔离网络非常简单，只需要添加一个网桥，然后在这个网桥上再增加几个内部端口，最后把端口移动到netns中即可。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 添加网桥</span>
</span></span><span style=display:flex><span>ovs-vsctl add-br br-int
</span></span><span style=display:flex><span><span style=color:#75715e># 添加三个内部端口</span>
</span></span><span style=display:flex><span>ovs-vsctl add-port br-int vnet0 -- set Interface vnet0 type<span style=color:#f92672>=</span>internal
</span></span><span style=display:flex><span>ovs-vsctl add-port br-int vnet1 -- set Interface vnet1 type<span style=color:#f92672>=</span>internal
</span></span><span style=display:flex><span>ovs-vsctl add-port br-int vnet2 -- set Interface vnet2 type<span style=color:#f92672>=</span>internal
</span></span><span style=display:flex><span><span style=color:#75715e># 添加三个netns</span>
</span></span><span style=display:flex><span>ip netns add ns0
</span></span><span style=display:flex><span>ip netns add ns1
</span></span><span style=display:flex><span>ip netns add ns2
</span></span><span style=display:flex><span><span style=color:#75715e># 将内部端口分别移动到netns中</span>
</span></span><span style=display:flex><span>ip link set vnet0 netns ns0
</span></span><span style=display:flex><span>ip link set vnet1 netns ns1
</span></span><span style=display:flex><span>ip link set vnet2 netns ns2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 启动端口并配置IP</span>
</span></span><span style=display:flex><span>ip netns exec ns0 ip link set lo up
</span></span><span style=display:flex><span>ip netns exec ns0 ip link set vnet0 up
</span></span><span style=display:flex><span>ip netns exec ns0 ip addr add 10.0.0.1/24 dev vnet0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ip netns exec ns1 ip link set lo up
</span></span><span style=display:flex><span>ip netns exec ns1 ip link set vnet1 up
</span></span><span style=display:flex><span>ip netns exec ns1 ip addr add 10.0.0.2/24 dev vnet1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ip netns exec ns2 ip link set lo up
</span></span><span style=display:flex><span>ip netns exec ns2 ip link set vnet2 up
</span></span><span style=display:flex><span>ip netns exec ns2 ip addr add 10.0.0.3/24 dev vnet2
</span></span></code></pre></div><p>测试</p><p>测试<code>ns0</code>和<code>ns1</code>能否通信<code>ip netns exec ns0 ping 10.0.0.2</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>PING 10.0.0.2 <span style=color:#f92672>(</span>10.0.0.2<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.0.0.2: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>1.05 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.0.0.2: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.059 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.0.0.2: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.056 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.0.0.2: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.053 ms
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 10.0.0.2 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span> packets transmitted, <span style=color:#ae81ff>4</span> received, 0% packet loss, time 3000ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 0.053/0.304/1.051/0.431 ms
</span></span></code></pre></div><p>测试<code>ns0</code>和<code>ns2</code>能否通信<code>ip netns exec ns0 ping 10.0.0.3</code></p><pre tabindex=0><code>PING 10.0.0.3 (10.0.0.3) 56(84) bytes of data.
64 bytes from 10.0.0.3: icmp_seq=1 ttl=64 time=1.17 ms
64 bytes from 10.0.0.3: icmp_seq=2 ttl=64 time=0.067 ms
64 bytes from 10.0.0.3: icmp_seq=3 ttl=64 time=0.058 ms
64 bytes from 10.0.0.3: icmp_seq=4 ttl=64 time=0.064 ms
^C
--- 10.0.0.3 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3001ms
rtt min/avg/max/mdev = 0.058/0.341/1.177/0.482 ms
</code></pre><p>根据测试结果可以看到，三台设备都是可以互相访问的，这样我们就成功搭建了一个无隔离的二层互通网络。</p><h2 id=实验二-单机隔离网络>实验二： 单机隔离网络</h2><p>使用ovs构建隔离网络也很简单，只需要给相应的端口设置上VLAN标签，就能实现网络的隔离。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 设置vnet0的VLAN tag为100</span>
</span></span><span style=display:flex><span>ovs-vsctl set Port vnet0 tag<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 设置vnet1和vnet2的VLAN tag为200</span>
</span></span><span style=display:flex><span>ovs-vsctl set Port vnet1 tag<span style=color:#f92672>=</span><span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>ovs-vsctl set Port vnet2 tag<span style=color:#f92672>=</span><span style=color:#ae81ff>200</span>
</span></span></code></pre></div><p>使用<code>ovs-vsctl show</code>命令查看VLAN tag是否配置成功</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>90139c71-8d11-49b2-b44c-f34174259dc8
</span></span><span style=display:flex><span>    Bridge br-int
</span></span><span style=display:flex><span>        Port <span style=color:#e6db74>&#34;vnet0&#34;</span>
</span></span><span style=display:flex><span>            tag: <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>            Interface <span style=color:#e6db74>&#34;vnet0&#34;</span>
</span></span><span style=display:flex><span>                type: internal
</span></span><span style=display:flex><span>        Port br-int
</span></span><span style=display:flex><span>            Interface br-int
</span></span><span style=display:flex><span>                type: internal
</span></span><span style=display:flex><span>        Port <span style=color:#e6db74>&#34;vnet2&#34;</span>
</span></span><span style=display:flex><span>            tag: <span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>            Interface <span style=color:#e6db74>&#34;vnet2&#34;</span>
</span></span><span style=display:flex><span>                type: internal
</span></span><span style=display:flex><span>        Port <span style=color:#e6db74>&#34;vnet1&#34;</span>
</span></span><span style=display:flex><span>            tag: <span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>            Interface <span style=color:#e6db74>&#34;vnet1&#34;</span>
</span></span><span style=display:flex><span>                type: internal
</span></span><span style=display:flex><span>    ovs_version: <span style=color:#e6db74>&#34;2.9.0&#34;</span>
</span></span></code></pre></div><p>测试</p><p>测试<code>ns0</code>与<code>ns1</code>的能否通信 <code>ip netns exec ns0 ping 10.0.0.2</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>PING 10.0.0.2 <span style=color:#f92672>(</span>10.0.0.2<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 10.0.0.2 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span> packets transmitted, <span style=color:#ae81ff>0</span> received, 100% packet loss, time 1000ms
</span></span></code></pre></div><p>测试<code>ns0</code>与<code>ns2</code>的能否通信 <code>ip netns exec ns0 ping 10.0.0.3</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>PING 10.0.0.3 <span style=color:#f92672>(</span>10.0.0.3<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 10.0.0.3 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span> packets transmitted, <span style=color:#ae81ff>0</span> received, 100% packet loss, time 999ms
</span></span></code></pre></div><p>测试<code>ns1</code>与<code>ns2</code>的能否通信 <code>ip netns exec ns1 ping 10.0.0.3</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>PING 10.0.0.3 <span style=color:#f92672>(</span>10.0.0.3<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.0.0.3: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.930 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.0.0.3: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.057 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.0.0.3: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.056 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.0.0.3: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.057 ms
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 10.0.0.3 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span> packets transmitted, <span style=color:#ae81ff>4</span> received, 0% packet loss, time 3000ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 0.056/0.275/0.930/0.378 ms
</span></span></code></pre></div><p>测试<code>ns2</code>与<code>ns1</code>的能否通信 <code>ip netns exec ns2 ping 10.0.0.2</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>PING 10.0.0.2 <span style=color:#f92672>(</span>10.0.0.2<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.0.0.2: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.088 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.0.0.2: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.057 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.0.0.2: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.050 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.0.0.2: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.060 ms
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 10.0.0.2 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span> packets transmitted, <span style=color:#ae81ff>4</span> received, 0% packet loss, time 2999ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 0.050/0.063/0.088/0.017 ms
</span></span></code></pre></div><p>根据测试结果可以看出，<code>ns0</code>是无法访问到<code>ns1</code>和<code>ns2</code>的，<code>ns1</code>和<code>ns2</code>可以互相访问。这是因为端口<code>vnet0</code>的数据报文发出后被OVS修改了包头，增加了VLAN <code>100</code>标签，与<code>vnet1</code>、<code>vnet2</code>的VLAN <code>200</code>标签不匹配，OVS交换机便不再将<code>vnet0</code>的数据报文发送给其他两个端口，由此便实现了网络隔离。</p><p>清理实验环境</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ovs-vsctl del-br br-int
</span></span><span style=display:flex><span>ip netns del ns0
</span></span><span style=display:flex><span>ip netns del ns1
</span></span><span style=display:flex><span>ip netns del ns2
</span></span></code></pre></div></article></div></main></body></html>