<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="前言
你是否遇到过这样的场景，服务器不能上网，但是又需要安装某个软件，面对如蛛网般杂乱的rpm包依赖关系，放弃或许是最好的选择，这样你就不必再为无法完成工作而痛苦又懊恼。
但是今天，你有了一个更好的选择。
4DNAT
4DNAT取名源自4和DNAT。这个工具工作在OSI模型的第四层传输层，同时4和for谐音，意为专门为目标地址转换而服务的工具。4DNAT使用go语言开发，具有天然的跨平台性，并且完全使用go标准库开发，没有任何的第三方依赖，编译之后只有一个二进制可执行文件。它有4种工作模式：
转发模式
接受两个参数，监听端口和目标地址，在监听端口接收到请求后会主动连接目标地址，示例：
./4dnat -forward 2222 192.168.1.100:22
监听模式
接受两个参数，监听端口1和监听端口2，并交换两个端口接收到的数据，示例：
./4dnat -listen 10000 10001
代理人模式
接受两个参数，目标地址1和目标地址2，启动后会主动连接这两个目标地址，并交换两个端口接收到的数据，示例：
./4dnat -agent 127.0.0.1:10000 127.0.0.1:22
http/https代理模式
接受两个参数或四个参数，代理类型、监听端口、证书路径和私钥路径，示例：
http代理
./4dnat -proxy http 1080
https代理
./4dnat -proxy https 1080 server.crt server.key
使用场景
场景一
期望可以在用户电脑上直接访问目标服务器上的3306端口，跳板机器是一台Windows机器，没办法做ssh端口转发。


单向虚线箭头表示可以单向访问，反之不行。
使用4DNAT在跳板机器上执行如下命令做端口转发
# 本地监听3307端口，接收到请求后主动连接10.1.0.40的3306端口
./4dnat -forward 3307 10.1.0.40:3306
在用户电脑上访问172.16.0.30:3307即等同于访问10.1.0.40:3306，于是就可以在用户电脑愉快的访问目标机器上的服务啦。
场景二
期望目标目标机器可以上网，如使用yum安装软件。


在用户电脑上开启一个http代理

./4dnat -proxy http 1080

在跳板机器上使用监听模式监听两个端口，用于交换数据

./4dnat -listen 10000 10001

在目标机器上使用监听模式监听两个端口，用于交换数据

./4dnat -listen 20000 20001

在用户电脑上使用代理人模式主动连接两个目标地址，用于交换数据

./4dnat -agent 127.0.0.1:1080 172.16.0.30:10000

在跳板机器上使用代理人模式主动连接两个目标地址，用于交换数据

./4dnat -agent 127.0.0.1:10001 10.1.0.40:20000

在目标机器上修改代理

cat <<EOF >> /etc/profile
http_proxy=http://127.0.0.1:20001
https_proxy=http://127.0.0.1:20001
export http_proxy https_proxy
EOF

source /etc/profile

在目标机器上测试访问互联网

curl https://typesafe.cn
最后奉上项目地址 https://github.com/dushixiang/4dnat"><title>服务器不允许上网并且需要跳板机才能访问？学会使用这个工具，轻松让服务器使用yum。</title><link rel="shortcut icon" type=image/x-icon href=/><link rel=stylesheet href=/css/main.51652302d3a998bf7887aed5c2cf89141bbebdf45a2c8f87b0717a3cf4f51c4e53c694c328fb1de78c3a625a1c01f80745bf1f2f42c040647a245cbbb6c2d1d7.css integrity="sha512-UWUjAtOpmL94h67Vws+JFBu+vfRaLI+HsHF6PPT1HE5TxpTDKPsd54w6YlocAfgHRb8fL0LAQGR6JFy7tsLR1w=="></head><body a=auto><main class=page-content aria-label=Content><div class=w><div class=post-meta><a href=/>..</a><p><time datetime="2020-11-19 22:33:00 +0000 UTC">2020-11-19</time></p></div><article><h1>服务器不允许上网并且需要跳板机才能访问？学会使用这个工具，轻松让服务器使用yum。</h1><h1 id=前言>前言</h1><p>你是否遇到过这样的场景，服务器不能上网，但是又需要安装某个软件，面对如蛛网般杂乱的rpm包依赖关系，放弃或许是最好的选择，这样你就不必再为无法完成工作而痛苦又懊恼。</p><p>但是今天，你有了一个更好的选择。</p><h1 id=4dnat><a href=https://github.com/dushixiang/4dnat>4DNAT</a></h1><p>4DNAT取名源自4和DNAT。这个工具工作在OSI模型的第四层传输层，同时4和for谐音，意为专门为目标地址转换而服务的工具。4DNAT使用go语言开发，具有天然的跨平台性，并且完全使用go标准库开发，没有任何的第三方依赖，编译之后只有一个二进制可执行文件。它有4种工作模式：</p><h3 id=转发模式>转发模式</h3><p>接受两个参数，监听端口和目标地址，在监听端口接收到请求后会主动连接目标地址，示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./4dnat -forward <span style=color:#ae81ff>2222</span> 192.168.1.100:22
</span></span></code></pre></div><h3 id=监听模式>监听模式</h3><p>接受两个参数，监听端口1和监听端口2，并交换两个端口接收到的数据，示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./4dnat -listen <span style=color:#ae81ff>10000</span> <span style=color:#ae81ff>10001</span>
</span></span></code></pre></div><h3 id=代理人模式>代理人模式</h3><p>接受两个参数，目标地址1和目标地址2，启动后会主动连接这两个目标地址，并交换两个端口接收到的数据，示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./4dnat -agent 127.0.0.1:10000 127.0.0.1:22
</span></span></code></pre></div><h3 id=httphttps代理模式>http/https代理模式</h3><p>接受两个参数或四个参数，代理类型、监听端口、证书路径和私钥路径，示例：</p><h4 id=http代理>http代理</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./4dnat -proxy http <span style=color:#ae81ff>1080</span>
</span></span></code></pre></div><h4 id=https代理>https代理</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./4dnat -proxy https <span style=color:#ae81ff>1080</span> server.crt server.key
</span></span></code></pre></div><h1 id=使用场景>使用场景</h1><h3 id=场景一>场景一</h3><p>期望可以在<strong>用户电脑</strong>上直接访问目标服务器上的3306端口，跳板机器是一台Windows机器，没办法做ssh端口转发。
<img src=https://oss.typesafe.cn/break-through-the-network.png alt=请输入图片描述></p><blockquote><p>单向虚线箭头表示可以单向访问，反之不行。</p></blockquote><p>使用4DNAT在<strong>跳板机器</strong>上执行如下命令做端口转发</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 本地监听3307端口，接收到请求后主动连接10.1.0.40的3306端口</span>
</span></span><span style=display:flex><span>./4dnat -forward <span style=color:#ae81ff>3307</span> 10.1.0.40:3306
</span></span></code></pre></div><p>在<strong>用户电脑</strong>上访问<strong>172.16.0.30:3307</strong>即等同于访问<strong>10.1.0.40:3306</strong>，于是就可以在<strong>用户电脑</strong>愉快的访问<strong>目标机器</strong>上的服务啦。</p><h3 id=场景二>场景二</h3><p>期望目标<strong>目标机器</strong>可以上网，如使用yum安装软件。
<img src=https://oss.typesafe.cn/break-through-the-network2.png alt=请输入图片描述></p><ol><li>在<strong>用户电脑</strong>上开启一个http代理</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./4dnat -proxy http <span style=color:#ae81ff>1080</span>
</span></span></code></pre></div><ol start=2><li>在<strong>跳板机器</strong>上使用监听模式监听两个端口，用于交换数据</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./4dnat -listen <span style=color:#ae81ff>10000</span> <span style=color:#ae81ff>10001</span>
</span></span></code></pre></div><ol start=3><li>在<strong>目标机器</strong>上使用监听模式监听两个端口，用于交换数据</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./4dnat -listen <span style=color:#ae81ff>20000</span> <span style=color:#ae81ff>20001</span>
</span></span></code></pre></div><ol start=4><li>在<strong>用户电脑</strong>上使用代理人模式主动连接两个目标地址，用于交换数据</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./4dnat -agent 127.0.0.1:1080 172.16.0.30:10000
</span></span></code></pre></div><ol start=5><li>在<strong>跳板机器</strong>上使用代理人模式主动连接两个目标地址，用于交换数据</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./4dnat -agent 127.0.0.1:10001 10.1.0.40:20000
</span></span></code></pre></div><ol start=6><li>在<strong>目标机器</strong>上修改代理</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt;&gt; /etc/profile
</span></span></span><span style=display:flex><span><span style=color:#e6db74>http_proxy=http://127.0.0.1:20001
</span></span></span><span style=display:flex><span><span style=color:#e6db74>https_proxy=http://127.0.0.1:20001
</span></span></span><span style=display:flex><span><span style=color:#e6db74>export http_proxy https_proxy
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>source /etc/profile
</span></span></code></pre></div><ol start=7><li>在<strong>目标机器</strong>上测试访问互联网</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl https://typesafe.cn
</span></span></code></pre></div><p>最后奉上项目地址 <a href=https://github.com/dushixiang/4dnat>https://github.com/dushixiang/4dnat</a></p></article></div></main></body></html>