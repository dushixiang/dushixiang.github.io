<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='虚拟化开发相较于普通开发是一个冷门的方向，大多数是使用Python开发，其中使用Java来做虚拟化的少之又少，资料更是少的可怜，为了实现需求我也是踩了不少坑，今天就为大家分享一下如何使用 libvirt-java 来采集KVM虚拟机的资源使用信息。
CPU使用率
libvirt并没有直接提供获取虚拟机CPU使用率的接口，需要我们自己来计算，网上分享的代码或者公式五花八门，大部分都是错误的，经过我的测试，找到了一个相对准确的计算公式。
cpu_usage = (cpu_time_now - cpu_time_t_second_ago) * 100 / (t * vCpus * 10^9)
Java代码如下
// t秒前的CPU时间
long c1 = domain.getInfo().cpuTime;
Thread.sleep(1000);
// 当前CPU时间
long c2 = domain.getInfo().cpuTime;

// 虚拟CPU数量
int vCpus = domain.getMaxVcpus();
// t 为1秒
Double cpuUsage = 100 * (c2 - c1) / (1 * vCpus * Math.pow(10, 9));
log.debug("虚拟机[{}]CPU使用率为: {}", uuid, cpuUsage);
内存使用率
不要使用domain.getInfo()返回的 memory字段，虽然它注释写的是the memory in KBytes used by the domain，但它的意思真的不是虚拟机内部进程已使用的内存大小，而是从宿主机器的角度来看分配给这个虚拟机的内存它使用了多少，如果没有特殊配置，它会和maxMem字段的值是相同的。
正确做法是使用domain.memoryStats(10)来获取，那为什么参数要输入一个10呢？这是因为10代表的是要返回的信息数量，经过我手动执行virsh dommemstat uuid 测试发现有10个参数返回，所以需要填入10。另外命令返回的unused 字段值与数组中tag=8的数据一致，最终我们获取到了未使用的内存大小，计算内存使用率更是轻轻松松。
Java代码如下
MemoryStatistic[] memoryStatistics = domain.memoryStats(10);
Optional<MemoryStatistic> first = Arrays.stream(memoryStatistics).filter(x -> x.getTag() == 8).findFirst();
if (first.isPresent()) {
  MemoryStatistic memoryStatistic = first.get();
  long unusedMemory = memoryStatistic.getValue();
  long maxMemory = domain.getMaxMemory();
  double memoryUsage = (maxMemory - unusedMemory) * 100.0 / maxMemory;
  log.debug("虚拟机[{}]内存使用率为: {}", uuid, memoryUsage);
}
网卡数据包信息
同样libvirt并没有提供获取虚拟机网卡的接口，因此需要获取虚拟机的xml文件来查询。'><title>使用libvirt-java采集KVM虚拟机状态信息</title><link rel="shortcut icon" type=image/x-icon href=/><link rel=stylesheet href=/css/main.51652302d3a998bf7887aed5c2cf89141bbebdf45a2c8f87b0717a3cf4f51c4e53c694c328fb1de78c3a625a1c01f80745bf1f2f42c040647a245cbbb6c2d1d7.css integrity="sha512-UWUjAtOpmL94h67Vws+JFBu+vfRaLI+HsHF6PPT1HE5TxpTDKPsd54w6YlocAfgHRb8fL0LAQGR6JFy7tsLR1w=="></head><body a=auto><main class=page-content aria-label=Content><div class=w><div class=post-meta><a href=/>..</a><p><time datetime="2021-05-19 20:18:20 +0800 +0800">2021-05-19</time></p></div><article><h1>使用libvirt-java采集KVM虚拟机状态信息</h1><p>虚拟化开发相较于普通开发是一个冷门的方向，大多数是使用Python开发，其中使用Java来做虚拟化的少之又少，资料更是少的可怜，为了实现需求我也是踩了不少坑，今天就为大家分享一下如何使用 <code>libvirt-java</code> 来采集KVM虚拟机的资源使用信息。</p><h3 id=cpu使用率>CPU使用率</h3><p><code>libvirt</code>并没有直接提供获取虚拟机CPU使用率的接口，需要我们自己来计算，网上分享的代码或者公式五花八门，大部分都是错误的，经过我的测试，找到了一个相对准确的计算公式。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-latex data-lang=latex><span style=display:flex><span>cpu_usage = (cpu_time_now - cpu_time_t_second_ago) * 100 / (t * vCpus * 10^9)
</span></span></code></pre></div><p>Java代码如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// t秒前的CPU时间</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>long</span> c1 <span style=color:#f92672>=</span> domain.<span style=color:#a6e22e>getInfo</span>().<span style=color:#a6e22e>cpuTime</span>;
</span></span><span style=display:flex><span>Thread.<span style=color:#a6e22e>sleep</span>(1000);
</span></span><span style=display:flex><span><span style=color:#75715e>// 当前CPU时间</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>long</span> c2 <span style=color:#f92672>=</span> domain.<span style=color:#a6e22e>getInfo</span>().<span style=color:#a6e22e>cpuTime</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 虚拟CPU数量</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> vCpus <span style=color:#f92672>=</span> domain.<span style=color:#a6e22e>getMaxVcpus</span>();
</span></span><span style=display:flex><span><span style=color:#75715e>// t 为1秒</span>
</span></span><span style=display:flex><span>Double cpuUsage <span style=color:#f92672>=</span> 100 <span style=color:#f92672>*</span> (c2 <span style=color:#f92672>-</span> c1) <span style=color:#f92672>/</span> (1 <span style=color:#f92672>*</span> vCpus <span style=color:#f92672>*</span> Math.<span style=color:#a6e22e>pow</span>(10, 9));
</span></span><span style=display:flex><span>log.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;虚拟机[{}]CPU使用率为: {}&#34;</span>, uuid, cpuUsage);
</span></span></code></pre></div><h3 id=内存使用率>内存使用率</h3><p>不要使用<code>domain.getInfo()</code>返回的 <code>memory</code>字段，虽然它注释写的是<code>the memory in KBytes used by the domain</code>，但它的意思真的不是虚拟机内部进程已使用的内存大小，而是从宿主机器的角度来看分配给这个虚拟机的内存它使用了多少，如果没有特殊配置，它会和<code>maxMem</code>字段的值是相同的。</p><p>正确做法是使用<code>domain.memoryStats(10)</code>来获取，那为什么参数要输入一个<code>10</code>呢？这是因为<code>10</code>代表的是要返回的信息数量，经过我手动执行<code>virsh dommemstat uuid</code> 测试发现有10个参数返回，所以需要填入<code>10</code>。另外命令返回的<code>unused</code> 字段值与数组中<code>tag=8</code>的数据一致，最终我们获取到了未使用的内存大小，计算内存使用率更是轻轻松松。</p><p>Java代码如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>MemoryStatistic<span style=color:#f92672>[]</span> memoryStatistics <span style=color:#f92672>=</span> domain.<span style=color:#a6e22e>memoryStats</span>(10);
</span></span><span style=display:flex><span>Optional<span style=color:#f92672>&lt;</span>MemoryStatistic<span style=color:#f92672>&gt;</span> first <span style=color:#f92672>=</span> Arrays.<span style=color:#a6e22e>stream</span>(memoryStatistics).<span style=color:#a6e22e>filter</span>(x <span style=color:#f92672>-&gt;</span> x.<span style=color:#a6e22e>getTag</span>() <span style=color:#f92672>==</span> 8).<span style=color:#a6e22e>findFirst</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (first.<span style=color:#a6e22e>isPresent</span>()) {
</span></span><span style=display:flex><span>  MemoryStatistic memoryStatistic <span style=color:#f92672>=</span> first.<span style=color:#a6e22e>get</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>long</span> unusedMemory <span style=color:#f92672>=</span> memoryStatistic.<span style=color:#a6e22e>getValue</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>long</span> maxMemory <span style=color:#f92672>=</span> domain.<span style=color:#a6e22e>getMaxMemory</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>double</span> memoryUsage <span style=color:#f92672>=</span> (maxMemory <span style=color:#f92672>-</span> unusedMemory) <span style=color:#f92672>*</span> 100.<span style=color:#a6e22e>0</span> <span style=color:#f92672>/</span> maxMemory;
</span></span><span style=display:flex><span>  log.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;虚拟机[{}]内存使用率为: {}&#34;</span>, uuid, memoryUsage);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=网卡数据包信息>网卡数据包信息</h3><p>同样<code>libvirt</code>并没有提供获取虚拟机网卡的接口，因此需要获取虚拟机的xml文件来查询。</p><p>此处没有什么坑，解析<code>xml</code>是使用了<code>html</code>解析库<code>Jsoup</code>，<code>xml</code>算是<code>html</code>的亲戚吧，比<code>html</code>书写严格很多，解析数据更为方便。</p><p>获取到网卡名称之后再获取统计信息，可以获取的数据有：</p><table><thead><tr><th>字段</th><th>含义</th></tr></thead><tbody><tr><td>rx_bytes</td><td>接收数据包大小</td></tr><tr><td>rx_packets</td><td>接收数据包数量</td></tr><tr><td>rx_errs</td><td>接收错误数据包数量</td></tr><tr><td>rx_drop</td><td>接收丢弃数据包数量</td></tr><tr><td>tx_bytes</td><td>发送数据包大小</td></tr><tr><td>tx_packets</td><td>发送数据包数量</td></tr><tr><td>tx_errs</td><td>发送错误数据包数量</td></tr><tr><td>tx_drop</td><td>发送丢弃数据包数量</td></tr></tbody></table><p>Java代码如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>String xmlDesc <span style=color:#f92672>=</span> domain.<span style=color:#a6e22e>getXMLDesc</span>(0);
</span></span><span style=display:flex><span>Document document <span style=color:#f92672>=</span> Jsoup.<span style=color:#a6e22e>parse</span>(xmlDesc);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 网卡</span>
</span></span><span style=display:flex><span>Elements interfaces <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>getElementsByTag</span>(<span style=color:#e6db74>&#34;devices&#34;</span>).<span style=color:#a6e22e>get</span>(0).<span style=color:#a6e22e>getElementsByTag</span>(<span style=color:#e6db74>&#34;interface&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (Element inter : interfaces) {
</span></span><span style=display:flex><span>  String interName <span style=color:#f92672>=</span> inter.<span style=color:#a6e22e>getElementsByTag</span>(<span style=color:#e6db74>&#34;target&#34;</span>).<span style=color:#a6e22e>get</span>(0).<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#34;dev&#34;</span>);
</span></span><span style=display:flex><span>  DomainInterfaceStats domainInterfaceStats <span style=color:#f92672>=</span> domain.<span style=color:#a6e22e>interfaceStats</span>(interName);
</span></span><span style=display:flex><span>  log.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;dev {} stats {}&#34;</span>, interName, Json.<span style=color:#a6e22e>toJsonString</span>(domainInterfaceStats));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=磁盘io信息>磁盘IO信息</h3><p>和网卡同样，<code>libvirt</code>也没有提供获取虚拟机磁盘的接口，还是需要获取虚拟机的xml文件来查询，获取到磁盘名称之后再获取统计信息，可以获取的数据有：</p><table><thead><tr><th>字段</th><th>含义</th></tr></thead><tbody><tr><td>rd_req</td><td>读取请求总数</td></tr><tr><td>rd_bytes</td><td>读取的数据大小</td></tr><tr><td>wr_req</td><td>写入请求总数</td></tr><tr><td>wr_bytes</td><td>写入的数据大小</td></tr><tr><td>errs</td><td>失败次数</td></tr></tbody></table><p>Java代码如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>String xmlDesc <span style=color:#f92672>=</span> domain.<span style=color:#a6e22e>getXMLDesc</span>(0);
</span></span><span style=display:flex><span>Document document <span style=color:#f92672>=</span> Jsoup.<span style=color:#a6e22e>parse</span>(xmlDesc);
</span></span><span style=display:flex><span><span style=color:#75715e>// 磁盘</span>
</span></span><span style=display:flex><span>Elements disks <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>getElementsByTag</span>(<span style=color:#e6db74>&#34;devices&#34;</span>).<span style=color:#a6e22e>get</span>(0).<span style=color:#a6e22e>getElementsByTag</span>(<span style=color:#e6db74>&#34;disk&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (Element disk : disks) {
</span></span><span style=display:flex><span>  String dev <span style=color:#f92672>=</span> disk.<span style=color:#a6e22e>getElementsByTag</span>(<span style=color:#e6db74>&#34;target&#34;</span>).<span style=color:#a6e22e>get</span>(0).<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#34;dev&#34;</span>);
</span></span><span style=display:flex><span>  DomainBlockStats domainBlockStats <span style=color:#f92672>=</span> domain.<span style=color:#a6e22e>blockStats</span>(dev);
</span></span><span style=display:flex><span>  log.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;dev {} stats {}&#34;</span>, dev, Json.<span style=color:#a6e22e>toJsonString</span>(domainBlockStats));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>至此采集虚拟机状态信息算是告一段落，学的越多才发现不会的越多&mldr;</p></article></div></main></body></html>