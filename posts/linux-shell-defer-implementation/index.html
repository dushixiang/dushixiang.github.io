<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='基本信息
trap命令用于指定在接收到信号后将要采取的动作。trap命令有两种格式。


trap [COMMANDS] [SIGNALS] 此格式用来指定在接收到 SIGNALS 信号列表后将执行的命令。 示例：
trap "echo &#39;Ctrl+C is trapped.&#39;" SIGINT
输出将会在你按下 Ctrl+C 时显示，即在接收到 SIGINT 信号时。


trap - [SIGNALS] 此格式用来重置SIGNALS的默认处理程序。
trap - SIGINT
该命令将恢复 SIGINT 信号的默认处理程序。 一旦指定了信号的处理程序，那么在脚本执行过程中，都会保持指定的动作，直到脚本执行结束。如果你想在脚本执行完毕后，不再处理这个信号，你可以使用trap - SIGNALS来重置信号的默认处理程序。


你也可以使用 trap -l 列出所有的信号，或者 trap 命令 获取当前的 trap 设置。
以下是一些常见的信号

  
      
          信号值
          信号名
          描述
      
  
  
      
          1
          SIGHUP
          终止控制进程或者进程组
      
      
          2
          SIGINT
          通常由于终端的挂断或者死亡而导致进程也中断
      
      
          3
          SIGQUIT
          Quit信号，和SIGINT类似，但由Quit键发出，通常用ctrl+\，执行后会生成core文件
      
      
          9
          SIGKILL
          Kill信号，用于结束最不能终止的进程，信号不能被进程捕捉
      
      
          15
          SIGTERM
          请求中止进程，kill命令缺省产生这个信号
      
  

示例代码
#!/bin/bash

cleanup() {
    echo "Caught Interrupt, cleaning up..."
    # 在这里放置你的清理代码。例如，删除一些临时文件。
}

exit_handler() {
    echo "Caught Terminate, exit..."
    exit 1
}

trap &#39;cleanup&#39; SIGINT
trap &#39;exit_handler&#39; SIGTERM

while true; do
    sleep 1
    echo "Sleeping..."
done
如何测试这段代码？'><title>Linux Shell 实现类似 golang defer 的功能</title><link rel="shortcut icon" type=image/x-icon href=/><link rel=stylesheet href=/css/main.0568d3f70e9896300444ff10565468b82c2dace6b1b82bc72fba6ae51bfb0849887e0eb4ccb3cdb1c915fbe68c7000fbea631be9322fd5d0bcab56732ce7293f.css integrity="sha512-BWjT9w6YljAERP8QVlRouCwtrOaxuCvHL7pq5Rv7CEmIfg60zLPNsckV++aMcAD76mMb6TIv1dC8q1ZzLOcpPw=="></head><body a=auto><main class=page-content aria-label=Content><div class=w><div class=post-meta><a href=/>..</a><p><time datetime="2023-08-02 00:00:00 +0800 +0800">2023-08-02</time></p></div><article><h1>Linux Shell 实现类似 golang defer 的功能</h1><h3 id=基本信息>基本信息</h3><p>trap命令用于指定在接收到信号后将要采取的动作。trap命令有两种格式。</p><ol><li><p>trap [COMMANDS] [SIGNALS] 此格式用来指定在接收到 SIGNALS 信号列表后将执行的命令。 示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>trap</span> <span style=color:#f1fa8c>&#34;echo &#39;Ctrl+C is trapped.&#39;&#34;</span> SIGINT
</span></span></code></pre></div><p>输出将会在你按下 Ctrl+C 时显示，即在接收到 SIGINT 信号时。</p></li><li><p>trap - [SIGNALS] 此格式用来重置SIGNALS的默认处理程序。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>trap</span> - SIGINT
</span></span></code></pre></div><p>该命令将恢复 SIGINT 信号的默认处理程序。 一旦指定了信号的处理程序，那么在脚本执行过程中，都会保持指定的动作，直到脚本执行结束。如果你想在脚本执行完毕后，不再处理这个信号，你可以使用trap - SIGNALS来重置信号的默认处理程序。</p></li></ol><p>你也可以使用 trap -l 列出所有的信号，或者 trap 命令 获取当前的 trap 设置。</p><p>以下是一些常见的信号</p><table><thead><tr><th>信号值</th><th>信号名</th><th>描述</th></tr></thead><tbody><tr><td>1</td><td>SIGHUP</td><td>终止控制进程或者进程组</td></tr><tr><td>2</td><td>SIGINT</td><td>通常由于终端的挂断或者死亡而导致进程也中断</td></tr><tr><td>3</td><td>SIGQUIT</td><td>Quit信号，和SIGINT类似，但由Quit键发出，通常用ctrl+\，执行后会生成core文件</td></tr><tr><td>9</td><td>SIGKILL</td><td>Kill信号，用于结束最不能终止的进程，信号不能被进程捕捉</td></tr><tr><td>15</td><td>SIGTERM</td><td>请求中止进程，kill命令缺省产生这个信号</td></tr></tbody></table><h3 id=示例代码>示例代码</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ff79c6>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span>cleanup<span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;Caught Interrupt, cleaning up...&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># 在这里放置你的清理代码。例如，删除一些临时文件。</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exit_handler<span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;Caught Terminate, exit...&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>exit</span> <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>trap</span> <span style=color:#f1fa8c>&#39;cleanup&#39;</span> SIGINT
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>trap</span> <span style=color:#f1fa8c>&#39;exit_handler&#39;</span> SIGTERM
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>while</span> true; <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>    sleep <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;Sleeping...&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>done</span>
</span></span></code></pre></div><p>如何测试这段代码？</p><ol><li><p>当你按下 Ctrl+C（SIGINT）时，你会看到 &ldquo;Caught Interrupt, cleaning up&mldr;&rdquo; 这个信息然后脚本会继续运行。</p></li><li><p>当你发送 SIGTERM 消息到这个脚本时，（比如通过 kill 命令：kill -s SIGTERM [pid] ），你会看到 &ldquo;Caught Terminate, exit&mldr;&rdquo; 这个信息然后脚本会退出。</p></li></ol><h3 id=总结>总结</h3><p>根据这个特性，我们就可以实现一些类似 golang defer 的功能，例如删除一些临时文件，关闭某个连接等等。</p></article></div></main></body></html>