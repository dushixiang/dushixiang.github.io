<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='基本信息
trap命令用于指定在接收到信号后将要采取的动作。trap命令有两种格式。


trap [COMMANDS] [SIGNALS] 此格式用来指定在接收到 SIGNALS 信号列表后将执行的命令。 示例：
trap "echo &#39;Ctrl+C is trapped.&#39;" SIGINT
输出将会在你按下 Ctrl+C 时显示，即在接收到 SIGINT 信号时。


trap - [SIGNALS] 此格式用来重置SIGNALS的默认处理程序。
trap - SIGINT
该命令将恢复 SIGINT 信号的默认处理程序。 一旦指定了信号的处理程序，那么在脚本执行过程中，都会保持指定的动作，直到脚本执行结束。如果你想在脚本执行完毕后，不再处理这个信号，你可以使用trap - SIGNALS来重置信号的默认处理程序。


你也可以使用 trap -l 列出所有的信号，或者 trap 命令 获取当前的 trap 设置。
以下是一些常见的信号

  
      
          信号值
          信号名
          描述
      
  
  
      
          1
          SIGHUP
          终止控制进程或者进程组
      
      
          2
          SIGINT
          通常由于终端的挂断或者死亡而导致进程也中断
      
      
          3
          SIGQUIT
          Quit信号，和SIGINT类似，但由Quit键发出，通常用ctrl+\，执行后会生成core文件
      
      
          9
          SIGKILL
          Kill信号，用于结束最不能终止的进程，信号不能被进程捕捉
      
      
          15
          SIGTERM
          请求中止进程，kill命令缺省产生这个信号
      
  

示例代码
#!/bin/bash

cleanup() {
    echo "Caught Interrupt, cleaning up..."
    # 在这里放置你的清理代码。例如，删除一些临时文件。
}

exit_handler() {
    echo "Caught Terminate, exit..."
    exit 1
}

trap &#39;cleanup&#39; SIGINT
trap &#39;exit_handler&#39; SIGTERM

while true; do
    sleep 1
    echo "Sleeping..."
done
如何测试这段代码？'><title>Linux Shell 实现类似 golang defer 的功能</title><link rel="shortcut icon" type=image/x-icon href=/><link rel=stylesheet href=/css/main.51652302d3a998bf7887aed5c2cf89141bbebdf45a2c8f87b0717a3cf4f51c4e53c694c328fb1de78c3a625a1c01f80745bf1f2f42c040647a245cbbb6c2d1d7.css integrity="sha512-UWUjAtOpmL94h67Vws+JFBu+vfRaLI+HsHF6PPT1HE5TxpTDKPsd54w6YlocAfgHRb8fL0LAQGR6JFy7tsLR1w=="></head><body a=auto><main class=page-content aria-label=Content><div class=w><div class=post-meta><a href=/>..</a><p><time datetime="2023-08-02 00:00:00 +0800 +0800">2023-08-02</time></p></div><article><h1>Linux Shell 实现类似 golang defer 的功能</h1><h3 id=基本信息>基本信息</h3><p>trap命令用于指定在接收到信号后将要采取的动作。trap命令有两种格式。</p><ol><li><p>trap [COMMANDS] [SIGNALS] 此格式用来指定在接收到 SIGNALS 信号列表后将执行的命令。 示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>trap <span style=color:#e6db74>&#34;echo &#39;Ctrl+C is trapped.&#39;&#34;</span> SIGINT
</span></span></code></pre></div><p>输出将会在你按下 Ctrl+C 时显示，即在接收到 SIGINT 信号时。</p></li><li><p>trap - [SIGNALS] 此格式用来重置SIGNALS的默认处理程序。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>trap - SIGINT
</span></span></code></pre></div><p>该命令将恢复 SIGINT 信号的默认处理程序。 一旦指定了信号的处理程序，那么在脚本执行过程中，都会保持指定的动作，直到脚本执行结束。如果你想在脚本执行完毕后，不再处理这个信号，你可以使用trap - SIGNALS来重置信号的默认处理程序。</p></li></ol><p>你也可以使用 trap -l 列出所有的信号，或者 trap 命令 获取当前的 trap 设置。</p><p>以下是一些常见的信号</p><table><thead><tr><th>信号值</th><th>信号名</th><th>描述</th></tr></thead><tbody><tr><td>1</td><td>SIGHUP</td><td>终止控制进程或者进程组</td></tr><tr><td>2</td><td>SIGINT</td><td>通常由于终端的挂断或者死亡而导致进程也中断</td></tr><tr><td>3</td><td>SIGQUIT</td><td>Quit信号，和SIGINT类似，但由Quit键发出，通常用ctrl+\，执行后会生成core文件</td></tr><tr><td>9</td><td>SIGKILL</td><td>Kill信号，用于结束最不能终止的进程，信号不能被进程捕捉</td></tr><tr><td>15</td><td>SIGTERM</td><td>请求中止进程，kill命令缺省产生这个信号</td></tr></tbody></table><h3 id=示例代码>示例代码</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>cleanup<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;Caught Interrupt, cleaning up...&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 在这里放置你的清理代码。例如，删除一些临时文件。</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exit_handler<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;Caught Terminate, exit...&#34;</span>
</span></span><span style=display:flex><span>    exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>trap <span style=color:#e6db74>&#39;cleanup&#39;</span> SIGINT
</span></span><span style=display:flex><span>trap <span style=color:#e6db74>&#39;exit_handler&#39;</span> SIGTERM
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> true; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    sleep <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;Sleeping...&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div><p>如何测试这段代码？</p><ol><li><p>当你按下 Ctrl+C（SIGINT）时，你会看到 &ldquo;Caught Interrupt, cleaning up&mldr;&rdquo; 这个信息然后脚本会继续运行。</p></li><li><p>当你发送 SIGTERM 消息到这个脚本时，（比如通过 kill 命令：kill -s SIGTERM [pid] ），你会看到 &ldquo;Caught Terminate, exit&mldr;&rdquo; 这个信息然后脚本会退出。</p></li></ol><h3 id=总结>总结</h3><p>根据这个特性，我们就可以实现一些类似 golang defer 的功能，例如删除一些临时文件，关闭某个连接等等。</p></article></div></main></body></html>