<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="2022年11月24日 SpringBoot 正式发布了 3.0 版本，带来许多新的特性，但我最关心的还是Java打包成原生二进制，运行时不再依赖jre环境，运行Java程序将和Go程序一样方便。
升级至 SpringBoot 3.0.0
说是尝鲜，但是我不想再试着搞 hello world 那种啥都没有的东西了，找到我之前写的一个Java开源项目 kafka-map 拿他开刀。
kafka-map 本身是基于 SpringBoot 2.4.x 开发的，sqlite 存储数据，且很久没有大的更新了，想要直接升级到 SpringBoot 3.0.0 是不可能的，我按照官方文档 Spring Boot 3.0 迁移指南 首先升级到最新2.7.x版本，然后就发现 service 依赖循环了，这个时候有两种选择，一是在配置文件中允许依赖循环 spring.main.allow-circular-references: true，二是梳理业务逻辑解决依赖循环的问题。作为一个合格的开发，我选择了解决依赖循环的问题，过程不表。
SpringBoot 3.0.0 升级了很多组件，其中 Jpa 依赖的 Hibernate 升级到了 6.x，我启动时又遇到了 sqlite 方言插件不可用的问题，还好 Hibernate 6.x 已经支持了 sqlite方言，切换到官方插件就好了。配置文件如下：
spring:
  datasource:
    url: jdbc:sqlite:data/kafka-map.db
    driver-class-name: org.sqlite.JDBC
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.community.dialect.SQLiteDialect
原生二进制打包
打包原生二进制还是最折腾的，刚开始参考GraalVM Native Image Support 把打包 springboot:build-image 当成了打包原生二进制了，而且打包的过程中还遇到了 UnsupportedFeatureException: No instances of ch.qos.logback.classic.Logger 这个问题，找了一圈也没找到解决方案。"><title>SpringBoot 3.0.0尝鲜与Java打包原生二进制【一】</title><link rel="shortcut icon" type=image/x-icon href=/><link rel=stylesheet href=/css/main.0568d3f70e9896300444ff10565468b82c2dace6b1b82bc72fba6ae51bfb0849887e0eb4ccb3cdb1c915fbe68c7000fbea631be9322fd5d0bcab56732ce7293f.css integrity="sha512-BWjT9w6YljAERP8QVlRouCwtrOaxuCvHL7pq5Rv7CEmIfg60zLPNsckV++aMcAD76mMb6TIv1dC8q1ZzLOcpPw=="></head><body a=auto><main class=page-content aria-label=Content><div class=w><div class=post-meta><a href=/>..</a><p><time datetime="2022-11-26 23:44:00 +0800 +0800">2022-11-26</time></p></div><article><h1>SpringBoot 3.0.0尝鲜与Java打包原生二进制【一】</h1><p>2022年11月24日 SpringBoot 正式发布了 3.0 版本，带来许多新的特性，但我最关心的还是Java打包成原生二进制，运行时不再依赖jre环境，运行Java程序将和Go程序一样方便。</p><h2 id=升级至-springboot-300>升级至 SpringBoot 3.0.0</h2><p>说是尝鲜，但是我不想再试着搞 hello world 那种啥都没有的东西了，找到我之前写的一个Java开源项目 <a href=https://github.com/dushixiang/kafka-map>kafka-map</a> 拿他开刀。</p><p><a href=https://github.com/dushixiang/kafka-map>kafka-map</a> 本身是基于 SpringBoot 2.4.x 开发的，sqlite 存储数据，且很久没有大的更新了，想要直接升级到 SpringBoot 3.0.0 是不可能的，我按照官方文档 <a href=https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide>Spring Boot 3.0 迁移指南</a> 首先升级到最新2.7.x版本，然后就发现 service 依赖循环了，这个时候有两种选择，一是在配置文件中允许依赖循环 <code>spring.main.allow-circular-references: true</code>，二是梳理业务逻辑解决依赖循环的问题。作为一个合格的开发，我选择了解决依赖循环的问题，过程不表。</p><p>SpringBoot 3.0.0 升级了很多组件，其中 Jpa 依赖的 Hibernate 升级到了 6.x，我启动时又遇到了 sqlite 方言插件不可用的问题，还好 Hibernate 6.x 已经支持了 sqlite方言，切换到官方插件就好了。配置文件如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>datasource</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>url</span>: jdbc:sqlite:data/kafka-map.db
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>driver-class-name</span>: org.sqlite.JDBC
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>jpa</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>hibernate</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>ddl-auto</span>: update
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>show-sql</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>properties</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>hibernate</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>dialect</span>: org.hibernate.community.dialect.SQLiteDialect
</span></span></code></pre></div><h2 id=原生二进制打包>原生二进制打包</h2><p>打包原生二进制还是最折腾的，刚开始参考<a href=https://docs.spring.io/spring-boot/docs/3.0.0/reference/html/native-image.html#native-image.developing-your-first-application.buildpacks>GraalVM Native Image Support</a> 把打包 <code>springboot:build-image</code> 当成了打包原生二进制了，而且打包的过程中还遇到了 <code>UnsupportedFeatureException: No instances of ch.qos.logback.classic.Logger</code> 这个问题，找了一圈也没找到解决方案。</p><p><img src=https://oss.typesafe.cn/k5.png alt=image.png></p><p>无奈，还是从 hello world 开始学起吧，我重新创建了一个 SpringBoot3.0.0 项目，并添加了 GraalVM Native Support 和我用到的一些组件。</p><p><img src=https://oss.typesafe.cn/k6.png alt=image.png></p><p>然后我就发现了新的大陆，我之前的方向错了，果然是方向错了再努力也没用啊。</p><p><img src=https://oss.typesafe.cn/k4.png alt=image.png></p><p>我在这个hello world程序中试了一下果然能行，当然是需要手动安装 GraalVM 并且配置环境变量的，切换到 graalvm 环境的jdk 。请参考 <a href=https://www.graalvm.org/downloads/>https://www.graalvm.org/downloads/</a> 的教程。</p><p>对比 hello world 程序我发现在 maven 插件中多了一个插件，复制过去安装一下。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#ff79c6>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;groupId&gt;</span>org.graalvm.buildtools<span style=color:#ff79c6>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;artifactId&gt;</span>native-maven-plugin<span style=color:#ff79c6>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;/plugin&gt;</span>
</span></span></code></pre></div><p>运行打包命令。</p><blockquote><p>不要忘记激活 graavm 环境。</p></blockquote><pre tabindex=0><code>mvn clean native:compile -Pnative -Dmaven.test.skip=true
</code></pre><p>然后时长达十几分钟的等待。</p><p><img src=https://oss.typesafe.cn/k1.png alt=image.png></p><p>运行成功？不，我又失败了。当然，我失败的很快，87毫秒。</p><p><img src=https://oss.typesafe.cn/k2.png alt=image.png></p><p><img src=https://oss.typesafe.cn/k3.png alt=image.png></p><p>查看原因，原来是找不到我的 sqlite 方言类，此时我突然想到 <a href=https://docs.spring.io/spring-boot/docs/3.0.0/reference/html/native-image.html#native-image.developing-your-first-application.buildpacks>GraalVM Native Image Support</a> 其中一段话。</p><blockquote><p>Unlike traditional applications written for the JVM, GraalVM Native Image applications require ahead-of-time processing in order to create an executable. This ahead-of-time processing involves statically analyzing your application code from its main entry point.</p></blockquote><blockquote><p>翻译：与为JVM编写的传统应用程序不同，GraalVM Native Image应用程序需要提前处理才能创建可执行文件。这种超前处理涉及从应用程序的主要入口点静态分析应用程序代码。</p></blockquote><p>GraalVM 从程序入口分析应用程序代码，而我在代码任何一个地方都没有引用过 <code>org.hibernate.community.dialect.SQLiteDialect</code> 这个类，然后它就被 GraalVM 无情的抛弃了。</p><h2 id=总结>总结</h2><p>使用 GraalVM 打包Java程序为原生二进制确实为Java程序提供了极快的启动速度，无需jre运行环境，很方便，但之前开发的程序想要使用此特性恐怕还是有点困难，新开发的项目也需要摒弃掉之前的一些开发习惯才能使用，并且二进制文件太大、GraalVM 尚未支持交叉编译，对比Golang还有很大的差距。</p><p>因为我还尚未成功运行起原生二进制的 kafka-map，不清楚 GraalVM 对一些运行时的API 支持如何，后续我将会努力运行起来 原生二进制的 kafka-map，并且对功能进行详细的测试。</p><p>未完待续&mldr;</p></article></div></main></body></html>