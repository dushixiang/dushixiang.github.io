<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="近期公司业务需求，需要安装一套Openstack环境学习，看了一下现在已经出了wallaby版了，我果断选择了上一个版本victoria。因为没有足够多的物理服务器了，只好找了一台64核256G内存6T硬盘的机器来创建几台虚拟机来搭环境了。
实验环境
此次实验使用到了三台虚拟机，都是使用centos8系统，一台机器当作控制和网络节点，另外两台当作计算节点，使用OVS+VLAN的网络模式，eth0作为管理网络，eth1互相连接到OVS网桥上模拟trunk网卡，controller多增加一个eth2用于访问外部网络。

  
      
          节点
          作用
          eth0
          eth1
          eth2
      
  
  
      
          controller
          控制节点、网络节点
          172.16.10.100
          无IP
          桥接，无IP
      
      
          compute-101
          计算节点
          172.16.10.101
          无IP
          ❌
      
      
          compute-102
          计算节点
          172.16.10.102
          无IP
          ❌
      
  

安装虚拟机
安装依赖
安装KVM和Linux网桥
yum install -y qemu-kvm libvirt virt-install bridge-utils virt-manager dejavu-lgc-sans-fonts

dejavu-lgc-sans-fonts用于解决 virt-manaer 乱码
启动
systemctl enable libvirtd && systemctl start libvirtd
安装OVS
yum install openvswitch
启动OVS
systemctl enable openvswitch && systemctl start openvswitch
创建虚拟机
使用 virt-manager 创建三台虚拟机

配置网络
配置管理网卡
给虚拟机配置桥接网络，参考Linux虚拟化技术KVM，效果如图

配置trunk网卡
使用ovs创建一个虚拟网桥。
ovs-vsctl add-br br-vlan
此时网桥br-vlan上是没有任何虚拟网卡的，然后关闭虚拟机，在virt-manager上添加一个网络设备"><title>openstack victoria版安装</title><link rel="shortcut icon" type=image/x-icon href=/><link rel=stylesheet href=/css/main.0568d3f70e9896300444ff10565468b82c2dace6b1b82bc72fba6ae51bfb0849887e0eb4ccb3cdb1c915fbe68c7000fbea631be9322fd5d0bcab56732ce7293f.css integrity="sha512-BWjT9w6YljAERP8QVlRouCwtrOaxuCvHL7pq5Rv7CEmIfg60zLPNsckV++aMcAD76mMb6TIv1dC8q1ZzLOcpPw=="></head><body a=auto><main class=page-content aria-label=Content><div class=w><div class=post-meta><a href=/>..</a><p><time datetime="2021-06-12 00:00:00 +0800 +0800">2021-06-12</time></p></div><article><h1>openstack victoria版安装</h1><p>近期公司业务需求，需要安装一套Openstack环境学习，看了一下现在已经出了<code>wallaby</code>版了，我果断选择了上一个版本<code>victoria</code>。因为没有足够多的物理服务器了，只好找了一台64核256G内存6T硬盘的机器来创建几台虚拟机来搭环境了。</p><h1 id=实验环境>实验环境</h1><p>此次实验使用到了三台虚拟机，都是使用centos8系统，一台机器当作控制和网络节点，另外两台当作计算节点，使用OVS+VLAN的网络模式，eth0作为管理网络，eth1互相连接到OVS网桥上模拟trunk网卡，controller多增加一个eth2用于访问外部网络。</p><table><thead><tr><th>节点</th><th>作用</th><th>eth0</th><th>eth1</th><th>eth2</th></tr></thead><tbody><tr><td>controller</td><td>控制节点、网络节点</td><td>172.16.10.100</td><td>无IP</td><td>桥接，无IP</td></tr><tr><td>compute-101</td><td>计算节点</td><td>172.16.10.101</td><td>无IP</td><td>❌</td></tr><tr><td>compute-102</td><td>计算节点</td><td>172.16.10.102</td><td>无IP</td><td>❌</td></tr></tbody></table><h1 id=安装虚拟机>安装虚拟机</h1><h2 id=安装依赖>安装依赖</h2><p>安装KVM和Linux网桥</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install -y qemu-kvm libvirt virt-install bridge-utils virt-manager dejavu-lgc-sans-fonts
</span></span></code></pre></div><blockquote><p><code>dejavu-lgc-sans-fonts</code>用于解决 <code>virt-manaer</code> 乱码</p></blockquote><p>启动</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl <span style=color:#8be9fd;font-style:italic>enable</span> libvirtd <span style=color:#ff79c6>&amp;&amp;</span> systemctl start libvirtd
</span></span></code></pre></div><p>安装OVS</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install openvswitch
</span></span></code></pre></div><p>启动OVS</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl <span style=color:#8be9fd;font-style:italic>enable</span> openvswitch <span style=color:#ff79c6>&amp;&amp;</span> systemctl start openvswitch
</span></span></code></pre></div><h3 id=创建虚拟机>创建虚拟机</h3><p>使用 virt-manager 创建三台虚拟机</p><p><img src=https://oss.typesafe.cn/vm-nodes.png alt=image-20210604140054913></p><h3 id=配置网络>配置网络</h3><h4 id=配置管理网卡>配置管理网卡</h4><p>给虚拟机配置桥接网络，参考<a href=https://typesafe.cn/posts/linux-kvm/>Linux虚拟化技术KVM</a>，效果如图</p><p><img src=https://oss.typesafe.cn/vm-manage-port-config.png alt></p><h4 id=配置trunk网卡>配置trunk网卡</h4><p>使用ovs创建一个虚拟网桥。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ovs-vsctl add-br br-vlan
</span></span></code></pre></div><p>此时网桥<code>br-vlan</code>上是没有任何虚拟网卡的，然后关闭虚拟机，在<code>virt-manager</code>上添加一个网络设备</p><p><img src=https://oss.typesafe.cn/kvm-ovs-trunk-port-config.png alt></p><p>使用命令找到虚拟机并编辑虚拟机XML文件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>virsh list --all
</span></span><span style=display:flex><span>virsh edit controller
</span></span></code></pre></div><p>找到对应的 <code>interface</code> 元素，在 <code>source</code> 和 <code>model</code>中间添加一行。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&lt;virtualport <span style=color:#8be9fd;font-style:italic>type</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;openvswitch&#39;</span> /&gt;
</span></span></code></pre></div><p>然后保存退出，启动虚拟机，启动成功之后会 <code>virtualport</code> 中间生成一个新的元素。</p><p><img src=https://oss.typesafe.cn/kvm-ovs-trunk-port-xml.png alt></p><p>确认是否添加成功。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ovs-vsctl show
</span></span></code></pre></div><p>成功的话可以在网桥上看到自动生成的几个虚拟网卡。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Bridge br-vlan
</span></span><span style=display:flex><span>    Port br-vlan
</span></span><span style=display:flex><span>        Interface br-vlan
</span></span><span style=display:flex><span>            type: internal
</span></span><span style=display:flex><span>    Port <span style=color:#f1fa8c>&#34;vnet1&#34;</span>
</span></span><span style=display:flex><span>        Interface <span style=color:#f1fa8c>&#34;vnet1&#34;</span>
</span></span><span style=display:flex><span>    Port <span style=color:#f1fa8c>&#34;vnet2&#34;</span>
</span></span><span style=display:flex><span>        Interface <span style=color:#f1fa8c>&#34;vnet2&#34;</span>
</span></span><span style=display:flex><span>    Port <span style=color:#f1fa8c>&#34;vnet3&#34;</span>
</span></span><span style=display:flex><span>        Interface <span style=color:#f1fa8c>&#34;vnet3&#34;</span>
</span></span><span style=display:flex><span>ovs_version: <span style=color:#f1fa8c>&#34;2.9.0&#34;</span>
</span></span></code></pre></div><p>以上步骤重复几次以完成其他虚拟机的配置。</p><h1 id=安装openstack>安装Openstack</h1><h2 id=配置环境>配置环境</h2><p>全部节点都需要操作。</p><h4 id=切换网络服务为-network-scripts>切换网络服务为 <code>network-scripts</code></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#6272a4># 安装Network服务</span>
</span></span><span style=display:flex><span>yum install network-scripts -y
</span></span><span style=display:flex><span><span style=color:#6272a4># 停用NetworkManager并禁止开机启动</span>
</span></span><span style=display:flex><span>systemctl stop NetworkManager <span style=color:#ff79c6>&amp;&amp;</span> systemctl disable NetworkManager
</span></span><span style=display:flex><span><span style=color:#6272a4># 启用Network并设置开机启动</span>
</span></span><span style=display:flex><span>systemctl <span style=color:#8be9fd;font-style:italic>enable</span> network <span style=color:#ff79c6>&amp;&amp;</span> systemctl start network
</span></span></code></pre></div><h4 id=设置静态ip>设置静态IP</h4><p>编辑网卡配置文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vim /etc/sysconfig/network-scripts/ifcfg-eth0
</span></span></code></pre></div><p>修改并添加以下内容</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>BOOTPROTO</span><span style=color:#ff79c6>=</span>static
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>ONBOOT</span><span style=color:#ff79c6>=</span>yes
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>IPADDR</span><span style=color:#ff79c6>=</span>172.16.10.100
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>NETMASK</span><span style=color:#ff79c6>=</span>255.255.255.0
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>GATEWAY</span><span style=color:#ff79c6>=</span>172.16.0.1
</span></span></code></pre></div><p>重启网络</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart network
</span></span></code></pre></div><h4 id=修改主机名称>修改主机名称</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#6272a4># 修改控制节点</span>
</span></span><span style=display:flex><span>hostnamectl set-hostname controller
</span></span><span style=display:flex><span><span style=color:#6272a4># 修改计算节点compute-101</span>
</span></span><span style=display:flex><span>hostnamectl set-hostname compute-101
</span></span><span style=display:flex><span><span style=color:#6272a4># 修改计算节点compute-102</span>
</span></span><span style=display:flex><span>hostnamectl set-hostname compute-102
</span></span></code></pre></div><h3 id=修改hosts文件>修改hosts文件</h3><p>添加以下内容</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>172.16.10.100 controller
</span></span><span style=display:flex><span>172.16.10.101 compute-101
</span></span><span style=display:flex><span>172.16.10.102 compute-102
</span></span></code></pre></div><h3 id=关闭防火墙>关闭防火墙</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop firewalld <span style=color:#ff79c6>&amp;&amp;</span> systemctl disable firewalld
</span></span></code></pre></div><h2 id=安装基础服务>安装基础服务</h2><p>全部节点都需要操作。</p><h3 id=升级软件包>升级软件包</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum upgrade -y
</span></span></code></pre></div><h3 id=安装时间同步服务chronyd>安装时间同步服务<code>chronyd</code></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install chrony -y
</span></span></code></pre></div><p>计算节点修改配置文件 <code>/etc/chrony.conf</code> 中的 <code>pool 2.centos.pool.ntp.org iburst</code> 为 <code>server controller iburst</code> 直接与控制节点同步时间。</p><p>重启chrony服务并开机自启</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart chronyd <span style=color:#ff79c6>&amp;&amp;</span> systemctl <span style=color:#8be9fd;font-style:italic>enable</span> chronyd
</span></span></code></pre></div><h3 id=安装openstack存储库>安装openstack存储库</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum config-manager --enable powertools
</span></span><span style=display:flex><span>yum install centos-release-openstack-victoria -y
</span></span></code></pre></div><h3 id=安装openstack客户端和openstack-selinux>安装openstack客户端和openstack-selinux</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install python3-openstackclient openstack-selinux -y
</span></span></code></pre></div><h3 id=禁用selinux>禁用selinux</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat&gt;/etc/selinux/config<span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>SELINUX=permissive
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>SELINUXTYPE=targeted
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>setenforce 0
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div><h3 id=修改用户权限>修改用户权限</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;neutron ALL = (root) NOPASSWD: ALL&#34;</span> &gt; /etc/sudoers.d/neutron
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;nova ALL = (root) NOPASSWD: ALL&#34;</span> &gt; /etc/sudoers.d/nova
</span></span></code></pre></div><h1 id=控制节点>控制节点</h1><h2 id=安装数据库>安装数据库</h2><ol><li><p>安装Mariadb数据库，也可安装MySQL数据库。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install mariadb mariadb-server python3-PyMySQL -y
</span></span></code></pre></div></li><li><p>创建和编辑<code>vim /etc/my.cnf.d/openstack.cnf</code>文件，添加如下信息</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ff79c6>[</span>mysqld<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>bind-address <span style=color:#ff79c6>=</span> 0.0.0.0
</span></span><span style=display:flex><span>default-storage-engine <span style=color:#ff79c6>=</span> innodb
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>innodb_file_per_table</span> <span style=color:#ff79c6>=</span> on
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>max_connections</span> <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>4096</span>
</span></span><span style=display:flex><span>collation-server <span style=color:#ff79c6>=</span> utf8_general_ci
</span></span><span style=display:flex><span>character-set-server <span style=color:#ff79c6>=</span> utf8
</span></span></code></pre></div></li><li><p>启动数据库并设置为开机自启</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl start mariadb <span style=color:#ff79c6>&amp;&amp;</span> systemctl <span style=color:#8be9fd;font-style:italic>enable</span> mariadb
</span></span></code></pre></div></li><li><p>配置数据库</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mysql_secure_installation
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 输入当前用户root密码，若为空直接回车</span>
</span></span><span style=display:flex><span>Enter current password <span style=color:#ff79c6>for</span> root <span style=color:#ff79c6>(</span>enter <span style=color:#ff79c6>for</span> none<span style=color:#ff79c6>)</span>:
</span></span><span style=display:flex><span>OK, successfully used password, moving on...
</span></span><span style=display:flex><span><span style=color:#6272a4># 是否设置root密码</span>
</span></span><span style=display:flex><span>Set root password? <span style=color:#ff79c6>[</span>Y/n<span style=color:#ff79c6>]</span> y
</span></span><span style=display:flex><span><span style=color:#6272a4># 输入新密码</span>
</span></span><span style=display:flex><span>New password:
</span></span><span style=display:flex><span><span style=color:#6272a4># 再次输入新密码</span>
</span></span><span style=display:flex><span>Re-enter new password:
</span></span><span style=display:flex><span><span style=color:#6272a4># 是否删除匿名用户</span>
</span></span><span style=display:flex><span>Remove anonymous users? <span style=color:#ff79c6>[</span>Y/n<span style=color:#ff79c6>]</span> y
</span></span><span style=display:flex><span><span style=color:#6272a4># 是否禁用远程登录</span>
</span></span><span style=display:flex><span>Disallow root login remotely? <span style=color:#ff79c6>[</span>Y/n<span style=color:#ff79c6>]</span> n
</span></span><span style=display:flex><span><span style=color:#6272a4># 是否删除测试数据库</span>
</span></span><span style=display:flex><span>Remove <span style=color:#8be9fd;font-style:italic>test</span> database and access to it? <span style=color:#ff79c6>[</span>Y/n<span style=color:#ff79c6>]</span> y
</span></span><span style=display:flex><span><span style=color:#6272a4># 是否重新加载权限表</span>
</span></span><span style=display:flex><span>Reload privilege tables now? <span style=color:#ff79c6>[</span>Y/n<span style=color:#ff79c6>]</span> y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 以上步骤根据实际情况做配置即可，不一定要与此处保持一致</span>
</span></span></code></pre></div></li></ol><h2 id=安装消息队列>安装消息队列</h2><ol><li><p>安装软件包</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>yum install rabbitmq-server -y
</span></span></code></pre></div></li><li><p>启动消息队列服务并设置为开机自启</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl start rabbitmq-server <span style=color:#ff79c6>&amp;&amp;</span> systemctl <span style=color:#8be9fd;font-style:italic>enable</span> rabbitmq-server
</span></span></code></pre></div></li><li><p>添加openstack用户并设置密码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>rabbitmqctl add_user openstack RABBIT_PASS
</span></span></code></pre></div></li><li><p>给openstack用户可读可写可配置权限</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>rabbitmqctl set_permissions openstack <span style=color:#f1fa8c>&#34;.*&#34;</span> <span style=color:#f1fa8c>&#34;.*&#34;</span> <span style=color:#f1fa8c>&#34;.*&#34;</span>
</span></span></code></pre></div></li><li><p>为了方便监控，启用Web界面管理插件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>rabbitmq-plugins <span style=color:#8be9fd;font-style:italic>enable</span> rabbitmq_management
</span></span></code></pre></div></li><li><p>浏览器访问 IP:15672，使用 guest/guest 登录rabbitmq</p></li></ol><h2 id=安装memcached缓存>安装Memcached缓存</h2><ol><li><p>安装软件包</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>yum install memcached python3-memcached -y
</span></span></code></pre></div></li><li><p>编辑<code>vim /etc/sysconfig/memcached</code>文件，将OPTTONS行修改成如下信息</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>OPTIONS</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;-l 127.0.0.1,::1,controller&#34;</span>
</span></span></code></pre></div></li><li><p>启动Memcached服务并设置开机自启</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl start memcached <span style=color:#ff79c6>&amp;&amp;</span> systemctl <span style=color:#8be9fd;font-style:italic>enable</span> memcached
</span></span></code></pre></div></li></ol><h2 id=安装keystone服务>安装KeyStone服务</h2><h3 id=创建数据库>创建数据库</h3><ol><li><p>连接数据库</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>mysql <span style=color:#ff79c6>-</span>u root <span style=color:#ff79c6>-</span>p
</span></span></code></pre></div></li><li><p>创建keystone数据库</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>DATABASE</span> keystone;
</span></span></code></pre></div></li><li><p>授予keystone数据库权限，然后退出</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>ALL</span> <span style=color:#ff79c6>PRIVILEGES</span> <span style=color:#ff79c6>ON</span> keystone.<span style=color:#ff79c6>*</span> <span style=color:#ff79c6>TO</span> <span style=color:#f1fa8c>&#39;keystone&#39;</span><span style=color:#ff79c6>@</span><span style=color:#f1fa8c>&#39;localhost&#39;</span> <span style=color:#ff79c6>IDENTIFIED</span> <span style=color:#ff79c6>BY</span> <span style=color:#f1fa8c>&#39;KEYSTONE_DBPASS&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>ALL</span> <span style=color:#ff79c6>PRIVILEGES</span> <span style=color:#ff79c6>ON</span> keystone.<span style=color:#ff79c6>*</span> <span style=color:#ff79c6>TO</span> <span style=color:#f1fa8c>&#39;keystone&#39;</span><span style=color:#ff79c6>@</span><span style=color:#f1fa8c>&#39;%&#39;</span> <span style=color:#ff79c6>IDENTIFIED</span> <span style=color:#ff79c6>BY</span> <span style=color:#f1fa8c>&#39;KEYSTONE_DBPASS&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>exit</span>;
</span></span></code></pre></div></li></ol><h3 id=安装软件包>安装软件包</h3><ol><li><p>安装软件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install openstack-keystone httpd python3-mod_wsgi -y
</span></span></code></pre></div></li><li><p>修改配置文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /etc/keystone/keystone.conf <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[DEFAULT]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[database]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>connection = mysql+pymysql://keystone:KEYSTONE_DBPASS@controller/keystone
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[token]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>provider = fernet
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div></li><li><p>初始化数据库</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>su -s /bin/sh -c <span style=color:#f1fa8c>&#34;keystone-manage db_sync&#34;</span> keystone
</span></span></code></pre></div></li><li><p>初始化Fernet</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone
</span></span><span style=display:flex><span>keystone-manage credential_setup --keystone-user keystone --keystone-group keystone
</span></span></code></pre></div></li><li><p>引导身份认证服务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>keystone-manage bootstrap --bootstrap-password ADMIN_PASS <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>  --bootstrap-admin-url http://controller:5000/v3/ <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>  --bootstrap-internal-url http://controller:5000/v3/ <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>  --bootstrap-public-url http://controller:5000/v3/ <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>  --bootstrap-region-id RegionOne
</span></span></code></pre></div></li></ol><h2 id=配置apache-http服务>配置Apache HTTP服务</h2><ol><li><p>修改<code>vim /etc/httpd/conf/httpd.conf</code>文件，添加如下信息</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ServerName controller
</span></span></code></pre></div></li><li><p>创建软链接</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ln -s /usr/share/keystone/wsgi-keystone.conf /etc/httpd/conf.d/
</span></span></code></pre></div></li><li><p>启动httpd服务 并设置开机自启</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start httpd <span style=color:#ff79c6>&amp;&amp;</span> systemctl <span style=color:#8be9fd;font-style:italic>enable</span> httpd
</span></span></code></pre></div></li><li><p>创建环境变量脚本</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; admin-openrc <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>export OS_USERNAME=admin
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>export OS_PASSWORD=ADMIN_PASS
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>export OS_PROJECT_NAME=admin
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>export OS_USER_DOMAIN_NAME=Default
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>export OS_PROJECT_DOMAIN_NAME=Default
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>export OS_AUTH_URL=http://controller:5000/v3
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>export OS_IDENTITY_API_VERSION=3
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>export OS_IMAGE_API_VERSION=2
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div><p>执行命令 <code>source admin-openrc</code> 或者 <code>. admin-openrc</code> 使环境变量生效。</p></li></ol><h2 id=创建域项目用户和角色>创建域、项目、用户和角色</h2><ol><li><p>创建域，程序中已存在默认域，此命令只是一个创建域的例子，可以不执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openstack domain create --description <span style=color:#f1fa8c>&#34;An Example Domain&#34;</span> example
</span></span></code></pre></div></li><li><p>创建service项目，也叫做租户</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openstack project create --domain default --description <span style=color:#f1fa8c>&#34;Service Project&#34;</span> service
</span></span></code></pre></div></li><li><p>验证token令牌</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>openstack token issue
</span></span></code></pre></div></li></ol><h2 id=安装glance服务>安装Glance服务</h2><h3 id=创建数据库-1>创建数据库</h3><ol><li><p>连接数据库</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>mysql <span style=color:#ff79c6>-</span>u root <span style=color:#ff79c6>-</span>p
</span></span></code></pre></div></li><li><p>创建glance数据库</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>DATABASE</span> glance;
</span></span></code></pre></div></li><li><p>授予glance数据库权限，然后退出</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>ALL</span> <span style=color:#ff79c6>PRIVILEGES</span> <span style=color:#ff79c6>ON</span> glance.<span style=color:#ff79c6>*</span> <span style=color:#ff79c6>TO</span> <span style=color:#f1fa8c>&#39;glance&#39;</span><span style=color:#ff79c6>@</span><span style=color:#f1fa8c>&#39;localhost&#39;</span> <span style=color:#ff79c6>IDENTIFIED</span> <span style=color:#ff79c6>BY</span> <span style=color:#f1fa8c>&#39;GLANCE_DBPASS&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>ALL</span> <span style=color:#ff79c6>PRIVILEGES</span> <span style=color:#ff79c6>ON</span> glance.<span style=color:#ff79c6>*</span> <span style=color:#ff79c6>TO</span> <span style=color:#f1fa8c>&#39;glance&#39;</span><span style=color:#ff79c6>@</span><span style=color:#f1fa8c>&#39;%&#39;</span> <span style=color:#ff79c6>IDENTIFIED</span> <span style=color:#ff79c6>BY</span> <span style=color:#f1fa8c>&#39;GLANCE_DBPASS&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>exit</span>;
</span></span></code></pre></div></li></ol><h3 id=创建glance用户并关联角色>创建glance用户并关联角色</h3><ol><li><p>创建glance用户并设置密码为GLANCE_PASS，此处与上面创建用户的不同之处是未使用交互式的方式，直接将密码放入了命令中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openstack user create --domain default --password GLANCE_PASS glance
</span></span></code></pre></div></li><li><p>使用admin角色将Glance用户添加到服务项目中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#6272a4># 在service的项目上给glance用户关联admin角色</span>
</span></span><span style=display:flex><span>openstack role add --project service --user glance admin
</span></span></code></pre></div></li></ol><h3 id=创建glance服务并注册api>创建glance服务并注册API</h3><ol><li><p>创建glance服务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openstack service create --name glance --description <span style=color:#f1fa8c>&#34;OpenStack Image&#34;</span> image
</span></span></code></pre></div></li><li><p>注册API，也就是创建镜像服务的API终端endpoints</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openstack endpoint create --region RegionOne image public http://controller:9292
</span></span><span style=display:flex><span>openstack endpoint create --region RegionOne image internal http://controller:9292
</span></span><span style=display:flex><span>openstack endpoint create --region RegionOne image admin http://controller:9292
</span></span></code></pre></div></li></ol><h3 id=安装并配置glance>安装并配置glance</h3><ol><li><p>安装软件包</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>dnf install openstack-glance -y
</span></span></code></pre></div></li><li><p>修改配置文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat &gt; /etc/glance/glance-api.conf<span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[database]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>connection = mysql+pymysql://glance:GLANCE_DBPASS@controller/glance
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[keystone_authtoken]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>www_authenticate_uri  = http://controller:5000
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>auth_url = http://controller:5000
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>memcached_servers = controller:11211
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>auth_type = password
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>project_domain_name = Default
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>user_domain_name = Default
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>project_name = service
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>username = glance
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>password = GLANCE_PASS
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[paste_deploy]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>flavor = keystone
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[glance_store]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>stores = file,http
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>default_store = file
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>filesystem_store_datadir = /var/lib/glance/images/
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div></li><li><p>同步数据库</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>su -s /bin/sh -c <span style=color:#f1fa8c>&#34;glance-manage db_sync&#34;</span> glance
</span></span></code></pre></div></li><li><p>启动glance服务并设置开机自启</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl start openstack-glance-api <span style=color:#ff79c6>&amp;&amp;</span> systemctl <span style=color:#8be9fd;font-style:italic>enable</span> openstack-glance-api
</span></span></code></pre></div></li></ol><h2 id=安装placement服务>安装Placement服务</h2><h3 id=创建数据库-2>创建数据库</h3><ol><li><p>连接数据库</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>mysql <span style=color:#ff79c6>-</span>u root <span style=color:#ff79c6>-</span>p
</span></span></code></pre></div></li><li><p>创建Plancement数据库</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>DATABASE</span> placement;
</span></span></code></pre></div></li><li><p>授予Plancement数据库权限，然后退出</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>ALL</span> <span style=color:#ff79c6>PRIVILEGES</span> <span style=color:#ff79c6>ON</span> placement.<span style=color:#ff79c6>*</span> <span style=color:#ff79c6>TO</span> <span style=color:#f1fa8c>&#39;placement&#39;</span><span style=color:#ff79c6>@</span><span style=color:#f1fa8c>&#39;localhost&#39;</span> <span style=color:#ff79c6>IDENTIFIED</span> <span style=color:#ff79c6>BY</span> <span style=color:#f1fa8c>&#39;PLACEMENT_DBPASS&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>ALL</span> <span style=color:#ff79c6>PRIVILEGES</span> <span style=color:#ff79c6>ON</span> placement.<span style=color:#ff79c6>*</span> <span style=color:#ff79c6>TO</span> <span style=color:#f1fa8c>&#39;placement&#39;</span><span style=color:#ff79c6>@</span><span style=color:#f1fa8c>&#39;%&#39;</span> <span style=color:#ff79c6>IDENTIFIED</span> <span style=color:#ff79c6>BY</span> <span style=color:#f1fa8c>&#39;PLACEMENT_DBPASS&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>exit</span>;
</span></span></code></pre></div></li></ol><h3 id=配置用户和endpoint>配置用户和Endpoint</h3><ol><li><p>创建一个plancement用户并设置密码为PLACEMENT_PASS</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openstack user create --domain default --password PLACEMENT_PASS placement
</span></span></code></pre></div></li><li><p>使用admin角色将Placement用户添加到服务项目中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#6272a4># 在service的项目上给placement用户关联admin角色</span>
</span></span><span style=display:flex><span>openstack role add --project service --user placement admin
</span></span></code></pre></div></li></ol><h3 id=创建placement服务并注册api>创建Placement服务并注册API</h3><ol><li><p>创建Plancement服务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openstack service create --name placement --description <span style=color:#f1fa8c>&#34;Placement API&#34;</span> placement
</span></span></code></pre></div></li><li><p>创建Plancement服务API端口</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openstack endpoint create --region RegionOne placement public http://controller:8778
</span></span><span style=display:flex><span>openstack endpoint create --region RegionOne placement internal http://controller:8778
</span></span><span style=display:flex><span>openstack endpoint create --region RegionOne placement admin http://controller:8778
</span></span></code></pre></div></li></ol><h3 id=安装placement服务-1>安装Placement服务</h3><ol><li><p>安装Plancement软件包</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>yum install openstack-placement-api -y
</span></span></code></pre></div></li><li><p>修改配置文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /etc/placement/placement.conf <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[placement_database]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>connection = mysql+pymysql://placement:PLACEMENT_DBPASS@controller/placement
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[api]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>auth_strategy = keystone
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[keystone_authtoken]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>auth_url = http://controller:5000/v3
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>memcached_servers = controller:11211
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>auth_type = password
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>project_domain_name = Default
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>user_domain_name = Default
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>project_name = service
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>username = placement
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>password = PLACEMENT_PASS
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div></li><li><p>同步数据库</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>su -s /bin/sh -c <span style=color:#f1fa8c>&#34;placement-manage db sync&#34;</span> placement
</span></span></code></pre></div></li><li><p>重启httpd服务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl restart httpd
</span></span></code></pre></div></li><li><p>检查Placement服务状态</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>placement-status upgrade check
</span></span></code></pre></div></li></ol><h2 id=安装nova服务>安装Nova服务</h2><h3 id=创建数据库-3>创建数据库</h3><ol><li><p>连接数据库</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>mysql <span style=color:#ff79c6>-</span>u root <span style=color:#ff79c6>-</span>p
</span></span></code></pre></div></li><li><p>创建nova_api，nova和nova_cell0数据库</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>DATABASE</span> nova_api;
</span></span><span style=display:flex><span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>DATABASE</span> nova;
</span></span><span style=display:flex><span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>DATABASE</span> nova_cell0;
</span></span></code></pre></div></li><li><p>分别授予三个数据库权限，然后退出</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#6272a4># 授权nova_api数据库
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>ALL</span> <span style=color:#ff79c6>PRIVILEGES</span> <span style=color:#ff79c6>ON</span> nova_api.<span style=color:#ff79c6>*</span> <span style=color:#ff79c6>TO</span> <span style=color:#f1fa8c>&#39;nova&#39;</span><span style=color:#ff79c6>@</span><span style=color:#f1fa8c>&#39;localhost&#39;</span> <span style=color:#ff79c6>IDENTIFIED</span> <span style=color:#ff79c6>BY</span> <span style=color:#f1fa8c>&#39;NOVA_DBPASS&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>ALL</span> <span style=color:#ff79c6>PRIVILEGES</span> <span style=color:#ff79c6>ON</span> nova_api.<span style=color:#ff79c6>*</span> <span style=color:#ff79c6>TO</span> <span style=color:#f1fa8c>&#39;nova&#39;</span><span style=color:#ff79c6>@</span><span style=color:#f1fa8c>&#39;%&#39;</span> <span style=color:#ff79c6>IDENTIFIED</span> <span style=color:#ff79c6>BY</span> <span style=color:#f1fa8c>&#39;NOVA_DBPASS&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#6272a4># 授权nova数据库
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>ALL</span> <span style=color:#ff79c6>PRIVILEGES</span> <span style=color:#ff79c6>ON</span> nova.<span style=color:#ff79c6>*</span> <span style=color:#ff79c6>TO</span> <span style=color:#f1fa8c>&#39;nova&#39;</span><span style=color:#ff79c6>@</span><span style=color:#f1fa8c>&#39;localhost&#39;</span> <span style=color:#ff79c6>IDENTIFIED</span> <span style=color:#ff79c6>BY</span> <span style=color:#f1fa8c>&#39;NOVA_DBPASS&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>ALL</span> <span style=color:#ff79c6>PRIVILEGES</span> <span style=color:#ff79c6>ON</span> nova.<span style=color:#ff79c6>*</span> <span style=color:#ff79c6>TO</span> <span style=color:#f1fa8c>&#39;nova&#39;</span><span style=color:#ff79c6>@</span><span style=color:#f1fa8c>&#39;%&#39;</span> <span style=color:#ff79c6>IDENTIFIED</span> <span style=color:#ff79c6>BY</span> <span style=color:#f1fa8c>&#39;NOVA_DBPASS&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#6272a4># 授权nova_cell0数据库
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>ALL</span> <span style=color:#ff79c6>PRIVILEGES</span> <span style=color:#ff79c6>ON</span> nova_cell0.<span style=color:#ff79c6>*</span> <span style=color:#ff79c6>TO</span> <span style=color:#f1fa8c>&#39;nova&#39;</span><span style=color:#ff79c6>@</span><span style=color:#f1fa8c>&#39;localhost&#39;</span> <span style=color:#ff79c6>IDENTIFIED</span> <span style=color:#ff79c6>BY</span> <span style=color:#f1fa8c>&#39;NOVA_DBPASS&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>GRANT</span> <span style=color:#ff79c6>ALL</span> <span style=color:#ff79c6>PRIVILEGES</span> <span style=color:#ff79c6>ON</span> nova_cell0.<span style=color:#ff79c6>*</span> <span style=color:#ff79c6>TO</span> <span style=color:#f1fa8c>&#39;nova&#39;</span><span style=color:#ff79c6>@</span><span style=color:#f1fa8c>&#39;%&#39;</span> <span style=color:#ff79c6>IDENTIFIED</span> <span style=color:#ff79c6>BY</span> <span style=color:#f1fa8c>&#39;NOVA_DBPASS&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>exit</span>;
</span></span></code></pre></div></li></ol><h3 id=配置用户和endpoint-1>配置用户和Endpoint</h3><ol><li><p>创建nova用户并设置密码为NOVA_PASS</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openstack user create --domain default --password NOVA_PASS nova
</span></span></code></pre></div></li><li><p>使用admin角色将nova用户添加到服务项目中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#6272a4># 在service的项目上给nova用户关联admin角色</span>
</span></span><span style=display:flex><span>openstack role add --project service --user nova admin
</span></span></code></pre></div></li></ol><h3 id=创建nova服务并注册api>创建Nova服务并注册API</h3><ol><li><p>创建Nova服务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openstack service create --name nova --description <span style=color:#f1fa8c>&#34;OpenStack Compute&#34;</span> compute
</span></span></code></pre></div></li><li><p>创建Nova服务API端口</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openstack endpoint create --region RegionOne compute public http://controller:8774/v2.1
</span></span><span style=display:flex><span>openstack endpoint create --region RegionOne compute internal http://controller:8774/v2.1
</span></span><span style=display:flex><span>openstack endpoint create --region RegionOne compute admin http://controller:8774/v2.1
</span></span></code></pre></div></li></ol><h3 id=安装并配置nova>安装并配置Nova</h3><ol><li><p>安装nova相关软件包</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>yum install openstack-nova-api openstack-nova-conductor openstack-nova-novncproxy openstack-nova-scheduler -y
</span></span></code></pre></div></li><li><p>修改配置文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /etc/nova/nova.conf <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[DE</span>FAULT<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>enabled_apis</span> <span style=color:#ff79c6>=</span> osapi_compute,metadata
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>transport_url</span> <span style=color:#ff79c6>=</span> rabbit://openstack:RABBIT_PASS@controller:5672/
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>my_ip</span> <span style=color:#ff79c6>=</span> 172.16.10.100
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>api_database<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>connection</span> <span style=color:#ff79c6>=</span> mysql+pymysql://nova:NOVA_DBPASS@controller/nova_api
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>database<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>connection</span> <span style=color:#ff79c6>=</span> mysql+pymysql://nova:NOVA_DBPASS@controller/nova
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>api<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>auth_strategy</span> <span style=color:#ff79c6>=</span> keystone
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>keystone_authtoken<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>www_authenticate_uri</span> <span style=color:#ff79c6>=</span> http://controller:5000/
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>auth_url</span> <span style=color:#ff79c6>=</span> http://controller:5000/
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>memcached_servers</span> <span style=color:#ff79c6>=</span> controller:11211
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>auth_type</span> <span style=color:#ff79c6>=</span> password
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>project_domain_name</span> <span style=color:#ff79c6>=</span> Default
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>user_domain_name</span> <span style=color:#ff79c6>=</span> Default
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>project_name</span> <span style=color:#ff79c6>=</span> service
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>username</span> <span style=color:#ff79c6>=</span> nova
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>password</span> <span style=color:#ff79c6>=</span> NOVA_PASS
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>vnc<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>enabled</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>server_listen</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$my_ip</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>server_proxyclient_address</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>$my_ip</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>glance<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>api_servers</span> <span style=color:#ff79c6>=</span> http://controller:9292
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>oslo_concurrency<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>lock_path</span> <span style=color:#ff79c6>=</span> /var/lib/nova/tmp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>placement<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>region_name</span> <span style=color:#ff79c6>=</span> RegionOne
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>project_domain_name</span> <span style=color:#ff79c6>=</span> Default
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>project_name</span> <span style=color:#ff79c6>=</span> service
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>auth_type</span> <span style=color:#ff79c6>=</span> password
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>user_domain_name</span> <span style=color:#ff79c6>=</span> Default
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>auth_url</span> <span style=color:#ff79c6>=</span> http://controller:5000/v3
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>username</span> <span style=color:#ff79c6>=</span> placement
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>password</span> <span style=color:#ff79c6>=</span> PLACEMENT_PASS
</span></span></code></pre></div></li><li><p>同步数据库</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#6272a4># 同步nova_api数据库</span>
</span></span><span style=display:flex><span>su -s /bin/sh -c <span style=color:#f1fa8c>&#34;nova-manage api_db sync&#34;</span> nova
</span></span><span style=display:flex><span><span style=color:#6272a4># 同步nova_cell0数据库</span>
</span></span><span style=display:flex><span>su -s /bin/sh -c <span style=color:#f1fa8c>&#34;nova-manage cell_v2 map_cell0&#34;</span> nova
</span></span><span style=display:flex><span><span style=color:#6272a4># 创建cell1</span>
</span></span><span style=display:flex><span>su -s /bin/sh -c <span style=color:#f1fa8c>&#34;nova-manage cell_v2 create_cell --name=cell1 --verbose&#34;</span> nova
</span></span><span style=display:flex><span><span style=color:#6272a4># 同步nova数据库</span>
</span></span><span style=display:flex><span>su -s /bin/sh -c <span style=color:#f1fa8c>&#34;nova-manage db sync&#34;</span> nova
</span></span></code></pre></div><p>验证nova_cell0和cell1是否添加成功</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>su -s /bin/sh -c <span style=color:#f1fa8c>&#34;nova-manage cell_v2 list_cells&#34;</span> nova
</span></span></code></pre></div></li><li><p>启动服务并设为开机自启</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl <span style=color:#8be9fd;font-style:italic>enable</span> openstack-nova-api openstack-nova-scheduler openstack-nova-conductor openstack-nova-novncproxy
</span></span><span style=display:flex><span>systemctl start openstack-nova-api openstack-nova-scheduler openstack-nova-conductor openstack-nova-novncproxy
</span></span></code></pre></div></li><li><p>使用命令<code>nova service-list</code>验证服务是否启动成功</p></li></ol><h2 id=安装neutron服务>安装neutron服务</h2><h3 id=创建数据库-4>创建数据库</h3><ol><li><p>连接数据库</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>mysql <span style=color:#ff79c6>-</span>u root <span style=color:#ff79c6>-</span>p
</span></span></code></pre></div></li><li><p>创建neutron数据库</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>DATABASE</span> neutron;
</span></span></code></pre></div></li><li><p>授予数据库权限，然后退出</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>GRANT ALL PRIVILEGES ON neutron.* TO <span style=color:#f1fa8c>&#39;neutron&#39;</span>@<span style=color:#f1fa8c>&#39;localhost&#39;</span> IDENTIFIED BY <span style=color:#f1fa8c>&#39;NEUTRON_DBPASS&#39;</span>;
</span></span><span style=display:flex><span>GRANT ALL PRIVILEGES ON neutron.* TO <span style=color:#f1fa8c>&#39;neutron&#39;</span>@<span style=color:#f1fa8c>&#39;%&#39;</span> IDENTIFIED BY <span style=color:#f1fa8c>&#39;NEUTRON_DBPASS&#39;</span>;
</span></span><span style=display:flex><span>exit;
</span></span></code></pre></div></li></ol><h3 id=配置用户和endpoint-2>配置用户和Endpoint</h3><ol><li><p>创建neutron用户并设置密码为NEUTRON_PASS</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openstack user create --domain default --password NEUTRON_PASS neutron
</span></span></code></pre></div></li><li><p>使用admin角色将neutron用户添加到服务项目中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#6272a4># 在service的项目上给neutron用户关联admin角色</span>
</span></span><span style=display:flex><span>openstack role add --project service --user neutron admin
</span></span></code></pre></div></li></ol><h3 id=创建neutron服务并注册api>创建Neutron服务并注册API</h3><ol><li><p>创建Neutron服务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openstack service create --name neutron --description <span style=color:#f1fa8c>&#34;OpenStack Networking&#34;</span> network
</span></span></code></pre></div></li><li><p>创建Neutron服务API端口</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openstack endpoint create --region RegionOne network public http://controller:9696
</span></span><span style=display:flex><span>openstack endpoint create --region RegionOne network internal http://controller:9696
</span></span><span style=display:flex><span>openstack endpoint create --region RegionOne network admin http://controller:9696
</span></span></code></pre></div></li></ol><h3 id=安装并配置neutron服务>安装并配置neutron服务</h3><ol><li><p>安装neutron相关软件包</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install openstack-neutron openstack-neutron-ml2 openstack-neutron-openvswitch python-neutronclient openstack-neutron-fwaas -y
</span></span></code></pre></div></li><li><p>修改配置文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /etc/neutron/neutron.conf <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[database]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>connection = mysql+pymysql://neutron:NEUTRON_DBPASS@controller/neutron
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[DEFAULT]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>core_plugin = ml2
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>service_plugins =
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>transport_url = rabbit://openstack:RABBIT_PASS@controller
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>auth_strategy = keystone
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>notify_nova_on_port_status_changes = true
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>notify_nova_on_port_data_changes = true
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[keystone_authtoken]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>www_authenticate_uri = http://controller:5000
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>auth_url = http://controller:5000
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>memcached_servers = controller:11211
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>auth_type = password
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>project_domain_name = default
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>user_domain_name = default
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>project_name = service
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>username = neutron
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>password = NEUTRON_PASS
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[nova]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>auth_url = http://controller:5000
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>auth_type = password
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>project_domain_name = default
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>user_domain_name = default
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>region_name = RegionOne
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>project_name = service
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>username = nova
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>password = NOVA_PASS
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[oslo_concurrency]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>lock_path = /var/lib/neutron/tmp
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div></li><li><p>配置ML2组件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /etc/neutron/plugins/ml2/ml2_conf.ini <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[ml2]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>type_drivers = flat,vlan
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>tenant_network_types = vlan
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>mechanism_drivers = openvswitch
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>debug=True
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[ml2_type_flat]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[ml2_type_vlan]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>network_vlan_ranges =physnet1:1000:1999,physnet2
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[ml2_type_vxlan]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[securitygroup]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>enable_security_group = True
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>enable_ipset = True
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[ovs]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>tenant_network_type = vlan
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>bridge_mappings = physnet1:br-vlan,physnet2:br-ex
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div></li><li><p>配置L3代理商</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat&gt; /etc/neutron/l3_agent.ini<span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[DEFAULT]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>interface_driver = neutron.agent.linux.interface.OVSInterfaceDriver
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>router_delete_namespaces = True
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>external_network_bridge =
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>verbose = True
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[fwaas]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>driver=neutron_fwaas.services.firewall.drivers.linux.iptables_fwaas.IptablesFwaasDriver
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>enabled = True
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[agent]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>extensions = fwaas
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[ovs]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div></li><li><p>配置DHCP代理商</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat&gt;/etc/neutron/dhcp_agent.ini<span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[DEFAULT]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>debug=True
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>interface_driver = neutron.agent.linux.interface.OVSInterfaceDriver
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>enable_isolated_metadata = True
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>dnsmasq_config_file = /etc/neutron/dnsmasq-neutron.conf
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;dhcp-option-force=26,1454&#34;</span> &gt;/etc/neutron/dnsmasq-neutron.conf
</span></span></code></pre></div></li><li><p>配置metadata代理器</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat&gt; /etc/neutron/metadata_agent.ini <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[DEFAULT]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>nova_metadata_host = controller
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>metadata_proxy_shared_secret = METADATA_SECRET
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>memcache_servers = controller:11211
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div></li><li><p>配置OVS组件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /etc/neutron/plugins/ml2/openvswitch_agent.ini <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[DEFAULT]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[agent]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[ovs]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>bridge_mappings = physnet1:br-vlan,physnet2:br-ex
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[securitygroup]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>firewall_driver=neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>enable_security_group=true
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[xenapi]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div><p>配置OVS交换机</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl <span style=color:#8be9fd;font-style:italic>enable</span> openvswitch.service --now
</span></span><span style=display:flex><span>systemctl status openvswitch.service
</span></span><span style=display:flex><span><span style=color:#6272a4># 用于联通虚拟机的网桥</span>
</span></span><span style=display:flex><span>ovs-vsctl add-br br-vlan
</span></span><span style=display:flex><span>ovs-vsctl add-port br-vlan eth1
</span></span><span style=display:flex><span><span style=color:#6272a4># 用于联通外部网络的网桥</span>
</span></span><span style=display:flex><span>ovs-vsctl add-br br-ex
</span></span><span style=display:flex><span>ovs-vsctl add-port br-ex eth2
</span></span></code></pre></div></li><li><p>配置软链接</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini
</span></span></code></pre></div></li><li><p>启动相关服务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl <span style=color:#8be9fd;font-style:italic>enable</span> neutron-openvswitch-agent neutron-l3-agent neutron-dhcp-agent neutron-metadata-agent neutron-ovs-cleanup openvswitch
</span></span><span style=display:flex><span>systemctl start neutron-openvswitch-agent neutron-l3-agent neutron-dhcp-agent neutron-metadata-agent openvswitch
</span></span><span style=display:flex><span>systemctl status neutron-openvswitch-agent neutron-l3-agent neutron-dhcp-agent neutron-metadata-agent openvswitch
</span></span></code></pre></div></li><li><p>测试</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>. admin-openrc
</span></span><span style=display:flex><span>openstack network agent list
</span></span></code></pre></div></li><li><p>创建提供商网络（外部网络）</p><p><code>provider-physical-network</code>表示使用的物理网络，与网络节点<code>/etc/neutron/plugin.ini</code>中的配置一致。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>. admin-openrc
</span></span><span style=display:flex><span><span style=color:#6272a4># 添加默认的端口安全组规则</span>
</span></span><span style=display:flex><span>openstack security group rule create --proto icmp default
</span></span><span style=display:flex><span>openstack security group rule create --proto tcp --dst-port <span style=color:#bd93f9>22</span> default
</span></span><span style=display:flex><span>openstack security group rule create --proto tcp --dst-port <span style=color:#bd93f9>3389</span> default
</span></span><span style=display:flex><span>openstack security group rule create --proto tcp --dst-port <span style=color:#bd93f9>80</span> default
</span></span><span style=display:flex><span>openstack security group rule create --proto tcp --dst-port <span style=color:#bd93f9>443</span> default
</span></span><span style=display:flex><span>openstack security group rule create --proto tcp --dst-port <span style=color:#bd93f9>123</span> default
</span></span><span style=display:flex><span>openstack security group rule create --proto tcp --dst-port <span style=color:#bd93f9>53</span> default
</span></span><span style=display:flex><span>openstack security group rule create --proto udp --dst-port <span style=color:#bd93f9>123</span> default
</span></span><span style=display:flex><span>openstack security group rule create --proto udp --dst-port <span style=color:#bd93f9>53</span> default
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>openstack network create  --share --external <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>  --provider-physical-network physnet2 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>  --provider-network-type flat provider
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 子网需要与真实环境一致</span>
</span></span><span style=display:flex><span>openstack subnet create --network provider <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>  --allocation-pool <span style=color:#8be9fd;font-style:italic>start</span><span style=color:#ff79c6>=</span>192.168.68.10,end<span style=color:#ff79c6>=</span>192.168.68.250 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>  --dns-nameserver 1.2.4.8 --gateway 192.168.68.1 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>  --subnet-range 192.168.68.0/24 provider
</span></span></code></pre></div></li></ol><h1 id=计算节点>计算节点</h1><h3 id=安装nova组件>安装nova组件</h3><ol><li><p>安装软件包</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install openstack-nova-compute -y
</span></span></code></pre></div></li><li><p>修改配置文件</p><blockquote><p>需手动修改vnc下的novncproxy_base_url</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /etc/nova/nova.conf <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[DEFAULT]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>enabled_apis = osapi_compute,metadata
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>transport_url = rabbit://openstack:RABBIT_PASS@controller
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>my_ip = 172.16.10.101
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[api]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>auth_strategy = keystone
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[keystone_authtoken]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>www_authenticate_uri = http://controller:5000/
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>auth_url = http://controller:5000/
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>memcached_servers = controller:11211
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>auth_type = password
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>project_domain_name = Default
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>user_domain_name = Default
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>project_name = service
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>username = nova
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>password = NOVA_PASS
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[neutron]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>auth_url = http://controller:5000
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>auth_type = password
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>project_domain_name = default
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>user_domain_name = default
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>region_name = RegionOne
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>project_name = service
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>username = neutron
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>password = NEUTRON_PASS
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>service_metadata_proxy = true
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>metadata_proxy_shared_secret = METADATA_SECRET
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[vnc]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>enabled = true
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>server_listen = 0.0.0.0
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>server_proxyclient_address = $my_ip
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>novncproxy_base_url = http://172.16.10.100:6080/vnc_auto.html
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[glance]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>api_servers = http://controller:9292
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[oslo_concurrency]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>lock_path = /var/lib/nova/tmp
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[placement]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>region_name = RegionOne
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>project_domain_name = Default
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>project_name = service
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>auth_type = password
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>user_domain_name = Default
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>auth_url = http://controller:5000/v3
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>username = placement
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>password = PLACEMENT_PASS
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[libvirt]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>virt_type=qemu
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div></li><li><p>启动服务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl <span style=color:#8be9fd;font-style:italic>enable</span> libvirtd.service openstack-nova-compute.service --now
</span></span><span style=display:flex><span>systemctl status libvirtd.service openstack-nova-compute.service
</span></span></code></pre></div></li><li><p>控制端验证nova节点信息</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>. admin-openrc
</span></span><span style=display:flex><span>su -s /bin/sh -c <span style=color:#f1fa8c>&#34;nova-manage cell_v2 discover_hosts --verbose&#34;</span> nova
</span></span><span style=display:flex><span>openstack hypervisor list
</span></span><span style=display:flex><span>openstack compute service list
</span></span><span style=display:flex><span>openstack catalog list
</span></span><span style=display:flex><span>nova-status upgrade check
</span></span></code></pre></div></li></ol><h3 id=安装neutron组件>安装neutron组件</h3><ol><li><p>安装软件包</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install -y openstack-neutron openstack-neutron-ml2 openstack-neutron-openvswitch
</span></span></code></pre></div></li><li><p>修改配置文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /etc/neutron/neutron.conf <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[DEFAULT]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>transport_url = rabbit://openstack:RABBIT_PASS@controller
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>auth_strategy = keystone
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[keystone_authtoken]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>www_authenticate_uri = http://controller:5000
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>auth_url = http://controller:5000
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>memcached_servers = controller:11211
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>auth_type = password
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>project_domain_name = default
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>user_domain_name = default
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>project_name = service
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>username = neutron
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>password = NEUTRON_PASS
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[oslo_concurrency]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>lock_path = /var/lib/neutron/tmp
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div></li><li><p>配置OVS网桥</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl <span style=color:#8be9fd;font-style:italic>enable</span> openvswitch --now
</span></span><span style=display:flex><span>systemctl status openvswitch
</span></span><span style=display:flex><span>ovs-vsctl add-br br-vlan
</span></span><span style=display:flex><span>ovs-vsctl add-port br-vlan eth1
</span></span></code></pre></div></li><li><p>配置neutron ovs组件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat&gt;/etc/neutron/plugins/ml2/openvswitch_agent.ini<span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[DEFAULT]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[agent]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[ovs]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>bridge_mappings = physnet1:br-vlan
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[securitygroup]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>firewall_driver=neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>enable_security_group=True
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[xenapi]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div></li><li><p>启动服务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#6272a4># 重启nova-compute</span>
</span></span><span style=display:flex><span>systemctl restart openstack-nova-compute
</span></span><span style=display:flex><span>systemctl <span style=color:#8be9fd;font-style:italic>enable</span> neutron-openvswitch-agent --now
</span></span><span style=display:flex><span>systemctl status neutron-openvswitch-agent
</span></span></code></pre></div></li></ol><h2 id=访问dashboard>访问dashboard</h2><p>使用浏览器访问 http://172.16.10.100/dashboard，使用admin/ADMIN_PASS登录系统。</p></article></div></main></body></html>